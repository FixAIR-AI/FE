<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>FixAIR Admin</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --copilot: #FF6B35;
            --copilot-glow: rgba(255, 107, 53, 0.4);
            --copilot-bg: rgba(255, 107, 53, 0.08);
            --copilot-border: rgba(255, 107, 53, 0.2);
            --assistant: #22c55e;
            --assistant-glow: rgba(34, 197, 94, 0.4);
            --assistant-bg: rgba(34, 197, 94, 0.08);
            --assistant-border: rgba(34, 197, 94, 0.2);
            --review: #3B82F6;
            --review-bg: rgba(59, 130, 246, 0.08);
            --review-border: rgba(59, 130, 246, 0.2);
            --warning: #eab308;
            --warning-bg: rgba(234, 179, 8, 0.08);
            --warning-border: rgba(234, 179, 8, 0.2);
            --bg: #0D1117;
            --bg-secondary: #161b22;
            --card: rgba(255, 255, 255, 0.03);
            --border: rgba(255, 255, 255, 0.06);
            --text: rgba(255, 255, 255, 0.9);
            --text-dim: rgba(255, 255, 255, 0.35);
            --grid-color: rgba(255,255,255,0.015);
            --content-width: 520px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg);
            background-image: 
                linear-gradient(var(--grid-color) 1px, transparent 1px),
                linear-gradient(90deg, var(--grid-color) 1px, transparent 1px);
            background-size: 32px 32px;
            color: var(--text);
            min-height: 100vh;
            min-height: 100dvh;
            overflow-x: hidden;
        }

        /* ═══ SVG DEFS ═══ */
        .svg-defs { position: absolute; width: 0; height: 0; overflow: hidden; }

        /* ═══ AUTH SCREENS ═══ */
        .screen { position: fixed; top: 0; left: 0; right: 0; bottom: 0; display: none; flex-direction: column; background: var(--bg); background-image: linear-gradient(var(--grid-color) 1px, transparent 1px), linear-gradient(90deg, var(--grid-color) 1px, transparent 1px); background-size: 32px 32px; z-index: 1; }
        .screen.active { display: flex; }
        .main-app { height: 100%; }

        /* LOGIN SCREEN */
        .login-screen { justify-content: center; align-items: center; padding: 24px; }
        .login-container { width: 100%; max-width: 380px; display: flex; flex-direction: column; align-items: center; }
        .scan-line { position: fixed; top: 0; left: 0; width: 100%; height: 2px; background: linear-gradient(90deg, transparent, var(--copilot), transparent); box-shadow: 0 0 20px var(--copilot-glow); animation: scanDown 2s ease-out forwards; }
        @keyframes scanDown { to { top: 50%; opacity: 0; } }
        .login-title { font-size: 22px; font-weight: 300; margin-bottom: 4px; color: rgba(255,255,255,0.9); }
        .login-sub { font-size: 12px; color: var(--text-dim); margin-bottom: 32px; }
        .login-logo { width: 160px; height: auto; margin-bottom: 24px; color: var(--copilot); }
        .login-logo svg { width: 100%; height: auto; }
        .login-bar { display: flex; align-items: center; gap: 8px; padding: 5px 5px 5px 8px; background: var(--card); border: 1px solid var(--border); border-radius: 40px; width: 100%; opacity: 0; animation: fadeUp 0.5s ease 1.5s forwards; }
        @keyframes fadeUp { to { opacity: 1; } }
        @keyframes spin { to { transform: rotate(360deg); } }
        .login-mini { width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; position: relative; }
        .glass-sphere { width: 26px; height: 26px; border-radius: 50%; position: relative; overflow: hidden; animation: glowPulse 8s ease-in-out infinite; }
        @keyframes glowPulse {
            0%, 100% { box-shadow: 0 0 14px rgba(255,107,53,0.7), 0 0 28px rgba(255,107,53,0.3); }
            25% { box-shadow: 0 0 14px rgba(239,68,68,0.7), 0 0 28px rgba(239,68,68,0.3); }
            50% { box-shadow: 0 0 14px rgba(59,130,246,0.7), 0 0 28px rgba(59,130,246,0.3); }
            75% { box-shadow: 0 0 14px rgba(234,179,8,0.7), 0 0 28px rgba(234,179,8,0.3); }
        }
        .glass-sphere::before { content: ''; position: absolute; top: 2px; left: 4px; width: 5px; height: 4px; border-radius: 50%; background: radial-gradient(circle, rgba(255,255,255,0.5), transparent 70%); z-index: 10; }
        .sphere-fog-container { position: absolute; inset: 0; border-radius: 50%; overflow: hidden; background: rgba(20,24,32,0.3); }
        .sphere-fog { position: absolute; inset: -50%; border-radius: 50%; background: radial-gradient(circle at 30% 40%, currentColor, transparent 50%), radial-gradient(circle at 70% 60%, currentColor, transparent 40%); filter: blur(2px); animation: fogSwirl 6s ease-in-out infinite, fogColor 8s ease-in-out infinite; opacity: 0.9; }
        @keyframes fogSwirl { 0% { transform: rotate(0deg) translate(0, 0); } 25% { transform: rotate(90deg) translate(2px, -2px); } 50% { transform: rotate(180deg) translate(0, 0); } 75% { transform: rotate(270deg) translate(-2px, 2px); } 100% { transform: rotate(360deg) translate(0, 0); } }
        @keyframes fogColor { 0%, 100% { color: #FF6B35; } 25% { color: #ef4444; } 50% { color: #3B82F6; } 75% { color: #eab308; } }
        .sphere-fog-2 { position: absolute; inset: -30%; border-radius: 50%; background: radial-gradient(circle at 60% 30%, currentColor, transparent 45%); filter: blur(2px); animation: fogSwirl2 5s ease-in-out infinite reverse, fogColor2 8s ease-in-out infinite; opacity: 0.7; }
        @keyframes fogSwirl2 { 0% { transform: rotate(0deg) scale(0.9); } 50% { transform: rotate(180deg) scale(1.1); } 100% { transform: rotate(360deg) scale(0.9); } }
        @keyframes fogColor2 { 0%, 100% { color: #3B82F6; } 25% { color: #eab308; } 50% { color: #FF6B35; } 75% { color: #ef4444; } }
        .login-icon-slot { width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; position: relative; flex-shrink: 0; }
        .login-back { width: 32px; height: 32px; border-radius: 50%; background: rgba(255,255,255,0.05); border: none; color: var(--text-dim); cursor: pointer; display: none; align-items: center; justify-content: center; flex-shrink: 0; transition: all 0.2s; }
        .login-back:hover { background: rgba(255,255,255,0.1); color: var(--text); }
        .login-back svg { width: 16px; height: 16px; stroke: currentColor; fill: none; }
        .login-input-container { flex: 1; position: relative; height: 32px; overflow: hidden; }
        .login-input-slider { display: flex; transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1); height: 100%; }
        .login-input-slide { min-width: 100%; display: flex; align-items: center; }
        .login-input { flex: 1; padding: 8px; background: transparent; border: none; color: white; font-size: 13px; outline: none; caret-color: white; }
        .login-input::placeholder { color: rgba(255,255,255,0.25); }
        .login-input:-webkit-autofill,
        .login-input:-webkit-autofill:hover,
        .login-input:-webkit-autofill:focus,
        .login-input:-webkit-autofill:active {
            -webkit-box-shadow: 0 0 0 1000px transparent inset !important;
            -webkit-text-fill-color: white !important;
            background-color: transparent !important;
            background: transparent !important;
            transition: background-color 9999s ease-out 9999s !important;
            caret-color: white !important;
        }
        .icon { display: inline-flex; align-items: center; justify-content: center; }
        .login-btn { width: 32px; height: 32px; border-radius: 50%; background: linear-gradient(135deg, #FF6B35, #E55A2B); border: none; color: white; cursor: pointer; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
        .login-btn .icon { width: 12px; height: 12px; }
        .login-btn .icon svg { width: 100%; height: 100%; }
        .login-btn:disabled { opacity: 0.5; cursor: not-allowed; }

        /* LOGIN STATUS MESSAGES */
        .login-status {
            min-height: 24px;
            margin-top: 16px;
            text-align: center;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        .login-status:empty { display: none; }
        .login-status.success { color: #22c55e; }
        .login-status.error { color: #ef4444; }
        .login-status.info { color: rgba(255,255,255,0.7); }
        .login-status a {
            color: inherit;
            text-decoration: underline;
            cursor: pointer;
            margin-left: 8px;
        }
        .login-status a:hover { opacity: 0.8; }

        /* PENDING & CONFIRMATION SCREENS */
        .pending-screen { display: none; }
        .pending-screen.active { display: flex; }
        .pending-container { display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 24px; padding: 40px; text-align: center; }
        .pending-logo { margin-bottom: 8px; }
        .pending-logo svg { height: 40px; width: auto; }
        .pending-title { font-size: 24px; font-weight: 700; color: var(--text); }
        .pending-subtitle { font-size: 14px; color: var(--text-dim); max-width: 300px; line-height: 1.5; }
        .pending-email { font-size: 13px; color: var(--copilot); font-weight: 500; padding: 8px 16px; background: rgba(255,107,53,0.1); border-radius: 8px; }
        .pending-logout { margin-top: 16px; padding: 10px 24px; background: transparent; border: 1px solid var(--border); border-radius: 8px; color: var(--text-dim); font-size: 13px; cursor: pointer; transition: all 0.2s; }
        .pending-logout:hover { background: rgba(255,255,255,0.05); color: var(--text); }

        /* ═══ HOME LAYOUT ═══ */
        .home-wrapper { display: flex; min-height: 100vh; min-height: 100dvh; }
        .home-main { flex: 1; display: flex; flex-direction: column; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); min-width: 0; }
        .home-wrapper.drawer-open .home-main { flex: 0 0 50%; max-width: 50%; }
        .home-content { flex: 1; overflow-y: auto; padding: 16px; padding-bottom: calc(80px + env(safe-area-inset-bottom)); }
        .home-content-inner { max-width: var(--content-width); margin: 0 auto; }

        /* ═══ BOTTOM NAV ═══ */
        .home-nav { position: fixed; bottom: 0; left: 0; right: 0; display: flex; justify-content: center; padding: 8px 16px; padding-bottom: max(8px, env(safe-area-inset-bottom)); z-index: 100; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .home-wrapper.drawer-open .home-nav { right: 50%; }
        .nav-pill { display: flex; justify-content: space-around; align-items: center; background: rgba(30, 35, 44, 0.98); backdrop-filter: blur(20px); border: 1px solid var(--border); border-radius: 14px; padding: 6px 16px; width: 100%; max-width: 580px; }
        .nav-item { display: flex; flex-direction: column; align-items: center; gap: 2px; padding: 8px 16px; color: rgba(255, 255, 255, 0.3); cursor: pointer; transition: color 0.2s; border-radius: 12px; }
        .nav-item:hover { color: rgba(255, 255, 255, 0.5); }
        .nav-item.active { color: var(--copilot); }
        .nav-icon { width: 20px; height: 20px; }
        .nav-label { font-size: 10px; font-weight: 500; }

        /* ═══ DRAWERS ═══ */
        .home-drawer { position: fixed; top: 0; right: 0; width: 50%; height: 100%; background: var(--bg-secondary); border-left: 1px solid var(--border); display: flex; flex-direction: column; transform: translateX(100%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); z-index: 150; }
        .home-wrapper.drawer-open .home-drawer { transform: translateX(0); }

        @media (max-width: 900px) {
            .home-wrapper.drawer-open .home-main { flex: 0 0 100%; max-width: 100%; opacity: 0.3; pointer-events: none; }
            .home-wrapper.drawer-open .home-nav { right: 0; opacity: 0.3; pointer-events: none; }
            .home-drawer { width: 100%; }
        }

        /* ═══ FULL PAGES ═══ */
        .full-page { position: fixed; inset: 0; background: var(--bg); background-image: linear-gradient(var(--grid-color) 1px, transparent 1px), linear-gradient(90deg, var(--grid-color) 1px, transparent 1px); background-size: 32px 32px; z-index: 200; display: none; flex-direction: column; }
        .full-page.active { display: flex; }
        .page-layout { display: flex; flex: 1; overflow: hidden; }
        .page-main { flex: 1; display: flex; flex-direction: column; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); min-width: 0; }
        .full-page.drawer-open .page-main { flex: 0 0 50%; max-width: 50%; }
        .page-content { flex: 1; overflow-y: auto; padding: 16px; }
        .page-drawer { position: fixed; top: 0; right: 0; width: 50%; height: 100%; background: var(--bg-secondary); border-left: 1px solid var(--border); display: flex; flex-direction: column; transform: translateX(100%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); z-index: 250; }
        .full-page.drawer-open .page-drawer { transform: translateX(0); }
        .nested-drawer { position: fixed; top: 0; right: 0; width: 50%; height: 100%; background: var(--bg-secondary); border-left: 1px solid var(--border); display: flex; flex-direction: column; transform: translateX(100%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); z-index: 300; }
        .nested-drawer.active { transform: translateX(0); }

        @media (max-width: 900px) {
            .full-page.drawer-open .page-main { flex: 0 0 100%; max-width: 100%; opacity: 0.3; pointer-events: none; }
            .page-drawer, .nested-drawer { width: 100%; }
        }

        .page-header { display: flex; align-items: center; gap: 12px; padding: 12px 16px; padding-top: max(12px, env(safe-area-inset-top)); background: var(--bg-secondary); border-bottom: 1px solid var(--border); flex-shrink: 0; }
        .page-back { width: 32px; height: 32px; border-radius: 50%; background: var(--card); border: 1px solid var(--border); display: flex; align-items: center; justify-content: center; cursor: pointer; color: var(--text-dim); transition: all 0.2s; }
        .page-back:hover { background: rgba(255,255,255,0.05); color: var(--text); }
        .page-back svg { width: 16px; height: 16px; }
        .page-title-wrap { flex: 1; }
        .page-title { font-size: 14px; font-weight: 600; }
        .page-subtitle { font-size: 11px; color: var(--text-dim); }
        .page-actions { display: flex; gap: 8px; }
        .page-action-btn { width: 32px; height: 32px; border-radius: 50%; background: var(--copilot-bg); border: 1px solid var(--copilot-border); display: flex; align-items: center; justify-content: center; cursor: pointer; color: var(--copilot); transition: all 0.2s; }
        .page-action-btn:hover { background: rgba(255,107,53,0.15); transform: scale(1.05); }
        .page-action-btn svg { width: 16px; height: 16px; }
        .page-action-btn.secondary { background: var(--card); border-color: var(--border); color: var(--text-dim); }
        .page-action-btn.secondary:hover { background: rgba(255,255,255,0.05); color: var(--text); }

        /* ═══ DRAWER COMMON ═══ */
        .drawer-header { display: flex; align-items: center; gap: 10px; padding: 12px 16px; padding-top: max(12px, env(safe-area-inset-top)); border-bottom: 1px solid var(--border); flex-shrink: 0; }
        .drawer-close { width: 28px; height: 28px; border-radius: 50%; background: transparent; border: 1px solid var(--border); color: rgba(255,255,255,0.5); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
        .drawer-close:hover { background: rgba(255,255,255,0.05); color: var(--text); }
        .drawer-close svg { width: 12px; height: 12px; }
        .drawer-title-wrap { flex: 1; }
        .drawer-title { font-size: 14px; font-weight: 600; }
        .drawer-subtitle { font-size: 11px; color: var(--text-dim); }
        .drawer-badge { font-size: 10px; padding: 4px 10px; border-radius: 6px; font-weight: 500; }
        .drawer-badge.review { background: var(--review-bg); color: var(--review); }
        .drawer-badge.diagnostic { background: var(--copilot-bg); color: var(--copilot); }
        .drawer-badge.drafting { background: var(--assistant-bg); color: var(--assistant); }
        .drawer-badge.live { background: var(--assistant-bg); color: var(--assistant); }
        .drawer-badge.idle { background: var(--warning-bg); color: var(--warning); }
        .drawer-badge.offline { background: rgba(75,85,99,0.2); color: #9ca3af; }
        .drawer-badge.pending { background: rgba(147,51,234,0.15); color: #a78bfa; }
        .drawer-body { flex: 1; overflow-y: auto; padding: 16px; display: flex; flex-direction: column; }
        .drawer-body > .drawer-calendar { flex: 1; min-height: 0; }
        .drawer-footer { display: flex; gap: 8px; padding: 12px 16px; padding-bottom: max(12px, env(safe-area-inset-bottom)); border-top: 1px solid var(--border); flex-shrink: 0; }
        .drawer-btn { flex: 1; display: flex; align-items: center; justify-content: center; gap: 6px; padding: 12px; border-radius: 10px; font-size: 13px; font-weight: 600; cursor: pointer; border: none; transition: all 0.2s; }
        .drawer-btn.primary { background: linear-gradient(135deg, #22c55e, #16a34a); color: white; }
        .drawer-btn.primary:hover { box-shadow: 0 4px 14px var(--assistant-glow); }
        .drawer-btn.secondary { background: var(--card); border: 1px solid var(--border); color: rgba(255,255,255,0.6); }
        .drawer-btn.orange { background: linear-gradient(135deg, var(--copilot), #E55A2B); color: white; }
        .drawer-btn svg { width: 14px; height: 14px; }

        /* ═══ HEADER WITH LOGO - Aligned with nav ═══ */
        .header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; padding-top: env(safe-area-inset-top); }
        .header-left { display: flex; align-items: center; }
        .header-logo-svg { height: 20px; color: var(--copilot); cursor: pointer; }
        .header-logo-svg svg { height: 100%; width: auto; }
        .header-date { font-size: 12px; color: var(--text-dim); margin-left: 10px; }
        .header-avatar { width: 32px; height: 32px; border-radius: 50%; background: var(--card); border: 1px solid var(--border); display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: 500; color: var(--text-dim); cursor: pointer; }

        /* ═══ HERO ═══ */
        .hero { background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 20px; margin-bottom: 16px; }
        .hero-top { display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px; }
        .hero-label { display: flex; align-items: center; gap: 8px; }
        .live-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--assistant); box-shadow: 0 0 8px var(--assistant); animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .hero-label-text { font-size: 11px; color: var(--text-dim); text-transform: uppercase; letter-spacing: 0.5px; }
        .hero-value { font-size: 42px; font-weight: 700; letter-spacing: -2px; color: var(--assistant); }
        .hero-value span { font-size: 18px; color: var(--text-dim); font-weight: 400; }
        .hero-progress { margin-top: 16px; }
        .progress-header { display: flex; justify-content: space-between; margin-bottom: 8px; }
        .progress-label { font-size: 11px; color: var(--text-dim); }
        .progress-value { font-size: 11px; color: var(--assistant); font-weight: 500; }
        .progress-bar { height: 4px; background: rgba(255, 255, 255, 0.06); border-radius: 2px; overflow: hidden; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, var(--assistant), var(--copilot)); border-radius: 2px; }

        /* ═══ STATS ═══ */
        .stats { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 16px; }
        .stats.cols-4 { grid-template-columns: repeat(4, 1fr); }
        .stat { background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 12px 10px; text-align: center; cursor: pointer; transition: all 0.2s; }
        .stat:hover { background: rgba(255,255,255,0.04); border-color: rgba(255,255,255,0.1); }
        .stat-value { font-size: 20px; font-weight: 600; letter-spacing: -1px; margin-bottom: 2px; }
        .stat-value.orange { color: var(--copilot); }
        .stat-value.blue { color: var(--review); }
        .stat-value.green { color: var(--assistant); }
        .stat-value.yellow { color: var(--warning); }
        .stat-label { font-size: 9px; color: var(--text-dim); text-transform: uppercase; letter-spacing: 0.3px; }

        /* ═══ SECTION HEADERS ═══ */
        .sec-head { display: flex; align-items: center; gap: 8px; margin-bottom: 10px; }
        .sec-title { font-size: 10px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-dim); }
        .sec-line { flex: 1; height: 1px; background: var(--border); }
        .sec-action { font-size: 11px; color: var(--copilot); cursor: pointer; }

        /* ═══ CARDS ═══ */
        .card-list { display: flex; flex-direction: column; gap: 10px; margin-bottom: 20px; }
        .proj { display: flex; align-items: center; gap: 12px; padding: 14px; background: var(--card); border: 1px solid var(--border); border-radius: 12px; cursor: pointer; transition: all 0.2s; position: relative; }
        .proj:hover { background: rgba(255, 255, 255, 0.04); border-color: rgba(255, 255, 255, 0.15); }
        .proj-status-bar { position: absolute; left: 0; top: 12px; bottom: 12px; width: 3px; }
        .proj-status-bar.diagnostic { background: var(--copilot); }
        .proj-status-bar.drafting { background: var(--assistant); }
        .proj-status-bar.review { background: var(--review); }
        .proj-icon { width: 36px; height: 36px; border-radius: 10px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; margin-left: 4px; }
        .proj-icon.copilot { background: var(--copilot-bg); color: var(--copilot); }
        .proj-icon.assistant { background: var(--assistant-bg); color: var(--assistant); }
        .proj-icon.review { background: var(--review-bg); color: var(--review); }
        .proj-icon svg { width: 16px; height: 16px; }
        .proj-info { flex: 1; min-width: 0; }
        .proj-title { font-size: 13px; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-bottom: 4px; }
        .proj-meta { font-size: 11px; color: var(--text-dim); }
        .proj-right { text-align: right; flex-shrink: 0; }
        .proj-badge { font-size: 10px; padding: 4px 8px; border-radius: 6px; font-weight: 500; margin-bottom: 4px; display: inline-block; }
        .proj-badge.diagnostic { background: var(--copilot-bg); color: var(--copilot); }
        .proj-badge.drafting { background: var(--assistant-bg); color: var(--assistant); }
        .proj-badge.review { background: var(--review-bg); color: var(--review); }
        .proj-time { font-size: 11px; color: rgba(255, 255, 255, 0.25); }
        .proj-time.warning { color: var(--warning); }

        .tech { display: flex; align-items: center; gap: 12px; padding: 14px; background: var(--card); border: 1px solid var(--border); border-radius: 12px; cursor: pointer; transition: all 0.2s; }
        .tech:hover { background: rgba(255, 255, 255, 0.04); border-color: rgba(255, 255, 255, 0.15); }
        .tech.needs-attention { border-color: var(--warning-border); }
        .tech-avatar { width: 36px; height: 36px; border-radius: 50%; background: rgba(255, 255, 255, 0.06); display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 500; position: relative; flex-shrink: 0; }
        .tech-status { position: absolute; bottom: -1px; right: -1px; width: 10px; height: 10px; border-radius: 50%; border: 2px solid var(--bg); }
        .tech-status.live { background: var(--assistant); box-shadow: 0 0 6px var(--assistant); }
        .tech-status.idle { background: var(--warning); }
        .tech-status.offline { background: #4b5563; }
        .tech-status.pending { background: #a78bfa; }
        .tech-info { flex: 1; min-width: 0; }
        .tech-name { font-size: 13px; font-weight: 500; margin-bottom: 2px; }
        .tech-project { font-size: 11px; color: var(--text-dim); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .tech-right { display: flex; align-items: center; gap: 10px; flex-shrink: 0; }
        .tech-time { font-size: 11px; color: rgba(255, 255, 255, 0.25); }
        .tech-time.warning { color: var(--warning); }
        .tech-time.pending { color: #a78bfa; }

        /* ═══ INFO CARDS ═══ */
        .info-card { background: var(--card); border: 1px solid var(--border); border-radius: 10px; padding: 14px; margin-bottom: 12px; }
        .info-card-title { font-size: 9px; color: var(--text-dim); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 10px; }
        .info-row { display: flex; justify-content: space-between; align-items: center; padding: 6px 0; border-bottom: 1px solid var(--border); }
        .info-row:last-child { border-bottom: none; }
        .info-label { font-size: 11px; color: var(--text-dim); }
        .info-value { font-size: 11px; font-weight: 500; }
        .info-value.green { color: var(--assistant); }
        .info-value.orange { color: var(--copilot); }
        .info-value.yellow { color: var(--warning); }
        .info-value.purple { color: #a78bfa; }

        /* ═══ REPORT PREVIEW ═══ */
        .report-preview-card { background: var(--card); border: 1px solid var(--border); border-radius: 10px; overflow: hidden; margin-bottom: 12px; padding: 14px; }
        .report-preview-outer-title { font-size: 9px; color: var(--text-dim); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 12px; }
        .report-preview-inner { background: rgba(255,255,255,0.02); border: 1px solid var(--border); border-radius: 8px; padding: 14px; }
        .report-preview-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 14px; padding-bottom: 12px; border-bottom: 1px solid var(--border); }
        .report-preview-title { font-size: 13px; font-weight: 600; }
        .report-preview-badge { font-size: 9px; padding: 4px 10px; background: var(--assistant-bg); color: var(--assistant); border: 1px solid var(--assistant-border); border-radius: 4px; font-weight: 500; }
        .r-field { margin-bottom: 12px; }
        .r-field:last-child { margin-bottom: 0; }
        .r-label { font-size: 9px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.3px; color: var(--text-dim); margin-bottom: 4px; }
        .r-value { font-size: 12px; padding: 10px 12px; background: rgba(0,0,0,0.3); border: 1px solid var(--border); border-radius: 8px; min-height: 40px; line-height: 1.5; color: var(--text); }
        .report-sections { display: flex; flex-direction: column; gap: 8px; }
        .report-section { display: flex; align-items: center; gap: 10px; }
        .report-section-name { font-size: 11px; color: var(--text-dim); width: 90px; }
        .report-section-bar { flex: 1; height: 6px; background: rgba(255,255,255,0.06); border-radius: 3px; overflow: hidden; }
        .report-section-fill { height: 100%; background: var(--assistant); border-radius: 3px; }
        .report-section-percent { font-size: 11px; color: var(--text-dim); width: 35px; text-align: right; }

        /* ═══ CALENDAR ═══ */
        .calendar-card { background: var(--card); border: 1px solid var(--border); border-radius: 12px; overflow: hidden; margin-bottom: 16px; }
        .calendar-header { display: flex; align-items: center; justify-content: space-between; padding: 12px 14px; border-bottom: 1px solid var(--border); }
        .calendar-month { font-size: 14px; font-weight: 600; }
        .calendar-nav { display: flex; gap: 4px; }
        .calendar-nav-btn { width: 28px; height: 28px; border-radius: 50%; background: transparent; border: 1px solid var(--border); color: var(--text-dim); display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.2s; }
        .calendar-nav-btn:hover { background: rgba(255,255,255,0.05); color: var(--text); }
        .calendar-nav-btn svg { width: 14px; height: 14px; }
        .calendar-tabs { display: flex; gap: 4px; padding: 8px 14px; border-bottom: 1px solid var(--border); }
        .calendar-tab { padding: 6px 12px; font-size: 11px; font-weight: 500; color: var(--text-dim); background: transparent; border: none; border-radius: 6px; cursor: pointer; transition: all 0.2s; }
        .calendar-tab:hover { background: rgba(255,255,255,0.04); }
        .calendar-tab.active { background: var(--copilot-bg); color: var(--copilot); }

        /* Daily view - Full day 6am-10pm scrollable, fills drawer */
        .calendar-daily { padding: 12px; flex: 1; overflow-y: auto; display: flex; flex-direction: column; }
        .calendar-daily::-webkit-scrollbar { width: 0; }
        .calendar-daily:hover::-webkit-scrollbar { width: 4px; }
        .calendar-daily::-webkit-scrollbar-track { background: transparent; }
        .calendar-daily::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 2px; }
        .daily-slot { display: flex; align-items: stretch; gap: 12px; margin-bottom: 4px; flex-shrink: 0; }
        .daily-slot:last-child { margin-bottom: 0; }
        .daily-time { width: 40px; font-size: 10px; color: var(--text-dim); padding-top: 6px; text-align: right; flex-shrink: 0; }
        .daily-content { flex: 1; min-height: 50px; background: rgba(255,255,255,0.02); border: 1px solid var(--border); border-radius: 6px; padding: 6px 10px; cursor: pointer; transition: all 0.2s; }
        .daily-content:hover { background: rgba(255,255,255,0.04); }
        .daily-content.has-event { border-color: transparent; }
        .daily-content.diagnostic { background: var(--copilot-bg); border-color: var(--copilot-border); }
        .daily-content.drafting { background: var(--assistant-bg); border-color: var(--assistant-border); }
        .daily-content.review { background: var(--review-bg); border-color: var(--review-border); }
        .daily-event-title { font-size: 11px; font-weight: 500; margin-bottom: 2px; }
        .daily-event-meta { font-size: 9px; color: var(--text-dim); }
        
        /* Calendar card in drawer - daily fills remaining height */
        .drawer-body .calendar-card { display: flex; flex-direction: column; height: calc(100vh - 200px); }
        .drawer-body .calendar-card .calendar-daily { flex: 1; min-height: 0; }

        /* Weekly view - Mon-Sun equal columns, scroll to see weekend */
        .calendar-week-wrapper { overflow-x: auto; overflow-y: hidden; position: relative; }
        .calendar-week-wrapper::-webkit-scrollbar { height: 3px; }
        .calendar-week-wrapper::-webkit-scrollbar-track { background: transparent; }
        .calendar-week-wrapper::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.15); border-radius: 2px; }
        .calendar-week { display: grid; grid-template-columns: 30px repeat(7, 90px); gap: 2px; padding: 10px; width: max-content; }
        .week-header-cell { text-align: center; padding: 6px 2px; font-size: 9px; color: var(--text-dim); cursor: pointer; transition: all 0.2s; border-radius: 6px; }
        .week-header-cell:hover { background: rgba(255,255,255,0.05); }
        .week-header-cell .day-num { font-size: 14px; font-weight: 600; color: var(--text); margin-bottom: 2px; }
        .week-header-cell.today .day-num { color: var(--copilot); }
        .week-time-label { font-size: 9px; color: var(--text-dim); padding: 6px 2px; text-align: right; display: flex; align-items: flex-start; justify-content: flex-end; }
        .week-slot { background: rgba(255,255,255,0.02); border: 1px solid var(--border); border-radius: 4px; min-height: 80px; max-height: 80px; overflow-y: auto; padding: 3px; display: flex; flex-direction: column; gap: 2px; }
        .week-slot::-webkit-scrollbar { width: 0; }
        .week-slot:hover::-webkit-scrollbar { width: 2px; }
        .week-slot::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 1px; }
        .week-slot-event { border-radius: 3px; padding: 3px 5px; font-size: 8px; font-weight: 500; cursor: pointer; flex-shrink: 0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; transition: all 0.2s; }
        .week-slot-event:hover { transform: scale(1.02); }
        .week-slot-event.diagnostic { background: var(--copilot-bg); color: var(--copilot); border: 1px solid var(--copilot-border); }
        .week-slot-event.drafting { background: var(--assistant-bg); color: var(--assistant); border: 1px solid var(--assistant-border); }
        .week-slot-event.review { background: var(--review-bg); color: var(--review); border: 1px solid var(--review-border); }
        
        /* Home calendar week wrapper - shows ~25% of Saturday */
        #homeCalContent .calendar-week-wrapper { max-width: calc(30px + 5 * 92px + 25px); }
        
        /* Drawer calendar week wrapper - FULL WIDTH of drawer, FULL HEIGHT */
        .drawer-week-wrapper { 
            width: 100%; 
            overflow-x: auto; 
            overflow-y: hidden; 
            height: 100%; 
            display: flex; 
            flex-direction: column; 
        }
        .drawer-week-wrapper::-webkit-scrollbar { height: 0; }
        .drawer-week { 
            display: grid; 
            grid-template-columns: 35px repeat(7, 1fr); 
            grid-template-rows: auto 1fr 1fr; 
            gap: 2px; 
            padding: 10px; 
            height: 100%; 
            min-height: 0;
            /* Width = 7/5.25 of visible area to show 5.25 columns and scroll for rest */
            width: calc((100% - 55px) * 1.35 + 55px);
            min-width: 600px;
        }
        .drawer-week .week-header-cell { padding: 4px 2px; font-size: 9px; }
        .drawer-week .week-header-cell .day-num { font-size: 13px; margin-bottom: 1px; }
        .drawer-week .week-slot { min-height: 0; max-height: none; height: 100%; }

        /* Monthly view - same everywhere */
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; padding: 10px; }
        .calendar-day-header { text-align: center; font-size: 9px; color: var(--text-dim); padding: 4px 0; font-weight: 500; }
        .calendar-day { aspect-ratio: 1; display: flex; align-items: center; justify-content: center; font-size: 11px; border-radius: 6px; cursor: pointer; transition: all 0.2s; position: relative; min-height: 28px; }
        .calendar-day:hover { background: rgba(255,255,255,0.05); }
        .calendar-day.other-month { color: var(--text-dim); opacity: 0.5; }
        .calendar-day.today { background: var(--copilot-bg); color: var(--copilot); font-weight: 600; }
        .calendar-day.has-events::after { content: ''; position: absolute; bottom: 2px; left: 50%; transform: translateX(-50%); width: 4px; height: 4px; border-radius: 50%; background: var(--assistant); }

        /* ═══ CHAT - Exact from technician app ═══ */
        .chat-card { background: var(--card); border: 1px solid var(--border); border-radius: 10px; overflow: hidden; display: flex; flex-direction: column; min-height: 320px; }
        .chat-card-header { display: flex; align-items: center; gap: 10px; padding: 10px 14px; border-bottom: 1px solid var(--border); }
        .chat-card-avatar { width: 28px; height: 28px; border-radius: 50%; background: rgba(255,255,255,0.06); display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: 500; }
        .chat-card-info { flex: 1; }
        .chat-card-name { font-size: 12px; font-weight: 500; }
        .chat-card-status { font-size: 10px; color: var(--assistant); }
        .chat-card-messages { flex: 1; overflow-y: auto; padding: 12px; display: flex; flex-direction: column; gap: 8px; min-height: 150px; }

        .msg { display: flex; flex-direction: column; max-width: 85%; }
        .msg.user { align-self: flex-end; align-items: flex-end; }
        .msg.ai { align-self: flex-start; align-items: flex-start; }
        .msg-bubble { padding: 10px 14px; border-radius: 14px; font-size: 12px; line-height: 1.5; }
        .msg.user .msg-bubble { background: linear-gradient(135deg, var(--copilot), #E55A2B); color: white; border-bottom-right-radius: 4px; }
        .msg.ai .msg-bubble { background: rgba(255,255,255,0.06); border: 1px solid var(--border); border-bottom-left-radius: 4px; }
        .msg-time { font-size: 9px; color: var(--text-dim); margin-top: 3px; padding: 0 6px; }

        /* Photo in chat */
        .photo-container { position: relative; display: inline-block; max-width: 200px; }
        .msg-image { max-width: 100%; border-radius: 10px; cursor: pointer; transition: transform 0.2s; display: block; }
        .msg-image:hover { transform: scale(1.02); }
        .photo-delete { position: absolute; top: 6px; right: 6px; width: 24px; height: 24px; border-radius: 50%; background: rgba(0,0,0,0.6); border: none; color: white; cursor: pointer; display: flex; align-items: center; justify-content: center; opacity: 0; transition: opacity 0.2s; }
        .photo-container:hover .photo-delete { opacity: 1; }
        .photo-delete:hover { background: #ef4444; }
        .photo-delete svg { width: 12px; height: 12px; }
        .photo-actions-inline { display: flex; gap: 6px; margin-top: 8px; }
        .photo-action-btn { display: flex; align-items: center; gap: 4px; padding: 6px 10px; background: var(--card); border: 1px solid var(--border); border-radius: 6px; color: var(--text); font-size: 10px; font-weight: 500; cursor: pointer; transition: all 0.2s; }
        .photo-action-btn:hover { background: rgba(255,255,255,0.08); }
        .photo-action-btn.success { background: var(--assistant-bg); border-color: var(--assistant-border); color: var(--assistant); }
        .photo-action-btn svg { width: 12px; height: 12px; }

        /* Chat input - Exact from technician app */
        .chat-input-wrap { padding: 10px 12px; position: relative; }
        .attach-menu { position: absolute; bottom: 100%; left: 12px; margin-bottom: 4px; background: rgba(20,24,32,0.98); border: 1px solid var(--border); border-radius: 10px; padding: 4px; display: none; flex-direction: column; gap: 2px; min-width: 180px; z-index: 10; box-shadow: 0 4px 20px rgba(0,0,0,0.4); }
        .attach-menu.show { display: flex; }
        .attach-opt { display: flex; align-items: center; gap: 8px; padding: 10px 12px; border-radius: 6px; font-size: 12px; color: rgba(255,255,255,0.7); cursor: pointer; transition: background 0.2s; }
        .attach-opt:hover { background: rgba(255,255,255,0.05); }
        .attach-opt svg { width: 16px; height: 16px; color: var(--copilot); }

        .input-row { display: flex; align-items: flex-end; gap: 8px; padding: 6px; background: transparent; border: 1px solid var(--border); border-radius: 24px; transition: border-color 0.2s; position: relative; }
        .input-row:focus-within { border-color: var(--copilot-border); }
        .input-row.recording { border-color: var(--copilot); background: rgba(255,107,53,0.05); }

        .plus-btn { width: 36px; height: 36px; border-radius: 50%; background: rgba(255,255,255,0.06); border: 1px solid var(--border); color: var(--copilot); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; flex-shrink: 0; }
        .plus-btn:hover { background: rgba(255,255,255,0.1); }
        .plus-btn svg { width: 16px; height: 16px; }

        .input-area { flex: 1; position: relative; min-height: 36px; display: flex; align-items: flex-end; }
        .input-text { width: 100%; background: transparent; border: none; color: white; font-family: inherit; font-size: 13px; line-height: 1.5; outline: none; padding: 8px 10px; resize: none; overflow-y: hidden; min-height: 36px; max-height: 100px; }
        .input-text::placeholder { color: rgba(255,255,255,0.25); }
        .input-row.recording .input-text { opacity: 0; pointer-events: none; }

        .voice-waveform { position: absolute; left: 0; right: 0; top: 0; bottom: 0; display: flex; align-items: center; padding: 0 10px; opacity: 0; pointer-events: none; transition: opacity 0.3s ease; overflow: hidden; }
        .input-row.recording .voice-waveform { opacity: 1; }
        .wave-bars { flex: 1; display: flex; align-items: center; gap: 2px; height: 100%; overflow: hidden; justify-content: flex-end; }
        .wave-bar { width: 3px; min-width: 3px; height: 4px; border-radius: 2px; background: var(--copilot); flex-shrink: 0; }
        .voice-timer { font-size: 11px; font-weight: 600; font-variant-numeric: tabular-nums; color: var(--copilot); min-width: 40px; text-align: right; padding-left: 10px; flex-shrink: 0; }

        .action-btn { width: 36px; height: 36px; border-radius: 50%; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; flex-shrink: 0; background: linear-gradient(135deg, var(--copilot), #E55A2B); color: white; position: relative; }
        .action-btn:hover { transform: scale(1.05); }
        .action-btn:active { transform: scale(0.95); }
        .action-btn.recording { background: rgb(220, 38, 38) !important; animation: pulse-red 1s infinite; }
        @keyframes pulse-red { 0%, 100% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0.4); } 50% { box-shadow: 0 0 0 8px rgba(220, 38, 38, 0); } }
        .action-btn .icon-wrap { position: relative; width: 16px; height: 16px; }
        .action-btn .btn-icon { position: absolute; top: 0; left: 0; width: 16px; height: 16px; transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1); }
        .action-btn .btn-icon svg { width: 16px; height: 16px; }
        .action-btn .mic-icon { opacity: 1; transform: scale(1); }
        .action-btn .send-icon { opacity: 0; transform: scale(0.5) translateY(6px); }
        .action-btn .stop-icon { opacity: 0; transform: scale(0); }
        .action-btn.has-text .mic-icon { opacity: 0; transform: scale(0.5) translateY(-6px); }
        .action-btn.has-text .send-icon { opacity: 1; transform: scale(1) translateY(0); }
        .action-btn.recording .mic-icon { opacity: 0; transform: scale(0); }
        .action-btn.recording .stop-icon { opacity: 1; transform: scale(1); }

        /* Transcription sphere */
        .transcription-sphere { width: 36px; height: 36px; border-radius: 50%; position: relative; overflow: hidden; flex-shrink: 0; display: none; animation: sphereGlow 3s ease-in-out infinite; }
        .transcription-sphere.active { display: block; }
        @keyframes sphereGlow { 0%, 100% { box-shadow: 0 0 14px rgba(255,107,53,0.7), 0 0 28px rgba(255,107,53,0.3); } 25% { box-shadow: 0 0 14px rgba(239,68,68,0.7), 0 0 28px rgba(239,68,68,0.3); } 50% { box-shadow: 0 0 14px rgba(59,130,246,0.7), 0 0 28px rgba(59,130,246,0.3); } 75% { box-shadow: 0 0 14px rgba(234,179,8,0.7), 0 0 28px rgba(234,179,8,0.3); } }
        .sphere-fog-wrap { position: absolute; inset: 0; border-radius: 50%; overflow: hidden; background: rgba(20,24,32,0.3); }
        .sphere-fog-transcribe { position: absolute; inset: -50%; border-radius: 50%; background: radial-gradient(circle at 30% 40%, currentColor, transparent 50%), radial-gradient(circle at 70% 60%, currentColor, transparent 40%); filter: blur(3px); animation: fogSwirlT 4s ease-in-out infinite, fogColorT 3s ease-in-out infinite; opacity: 0.9; }
        .sphere-fog-transcribe-2 { position: absolute; inset: -30%; border-radius: 50%; background: radial-gradient(circle at 60% 30%, currentColor, transparent 45%); filter: blur(3px); animation: fogSwirlT2 3s ease-in-out infinite reverse, fogColorT2 3s ease-in-out infinite; opacity: 0.7; }
        .sphere-highlight { position: absolute; top: 4px; left: 8px; width: 8px; height: 6px; border-radius: 50%; background: radial-gradient(circle, rgba(255,255,255,0.5), transparent 70%); z-index: 10; }
        @keyframes fogSwirlT { 0% { transform: rotate(0deg) translate(0, 0); } 25% { transform: rotate(90deg) translate(2px, -2px); } 50% { transform: rotate(180deg) translate(0, 0); } 75% { transform: rotate(270deg) translate(-2px, 2px); } 100% { transform: rotate(360deg) translate(0, 0); } }
        @keyframes fogColorT { 0%, 100% { color: #FF6B35; } 25% { color: #ef4444; } 50% { color: #3B82F6; } 75% { color: #eab308; } }
        @keyframes fogSwirlT2 { 0% { transform: rotate(0deg) scale(0.9); } 50% { transform: rotate(180deg) scale(1.1); } 100% { transform: rotate(360deg) scale(0.9); } }
        @keyframes fogColorT2 { 0%, 100% { color: #3B82F6; } 25% { color: #eab308; } 50% { color: #FF6B35; } 75% { color: #ef4444; } }

        .hidden-input { display: none; }

        /* ═══ FORMS ═══ */
        .form-field { margin-bottom: 14px; }
        .form-label { font-size: 10px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.3px; color: var(--text-dim); margin-bottom: 6px; display: block; }
        .form-input, .form-select { width: 100%; padding: 10px 12px; background: var(--card); border: 1px solid var(--border); border-radius: 8px; color: var(--text); font-size: 13px; font-family: inherit; outline: none; transition: border-color 0.2s; }
        .form-input:focus, .form-select:focus { border-color: var(--copilot-border); }
        .form-input::placeholder { color: var(--text-dim); }
        .form-select { cursor: pointer; }
        .form-textarea { min-height: 80px; resize: vertical; }

        .tech-selector { display: flex; flex-direction: column; gap: 8px; }
        .tech-option { display: flex; align-items: center; gap: 10px; padding: 10px 12px; background: var(--card); border: 1px solid var(--border); border-radius: 8px; cursor: pointer; transition: all 0.2s; }
        .tech-option:hover { background: rgba(255,255,255,0.04); }
        .tech-option.selected { border-color: var(--copilot); background: var(--copilot-bg); }
        .tech-option-avatar { width: 32px; height: 32px; border-radius: 50%; background: rgba(255,255,255,0.06); display: flex; align-items: center; justify-content: center; font-size: 11px; }
        .tech-option-info { flex: 1; }
        .tech-option-name { font-size: 12px; font-weight: 500; }
        .tech-option-avail { font-size: 10px; color: var(--assistant); }

        .mini-project { display: flex; align-items: center; gap: 10px; padding: 10px 12px; background: var(--bg); border: 1px solid var(--border); border-radius: 8px; margin-bottom: 8px; cursor: pointer; transition: all 0.2s; }
        .mini-project:hover { background: rgba(255,255,255,0.03); border-color: var(--copilot-border); }
        .mini-project:last-child { margin-bottom: 0; }
        .mini-project-bar { width: 3px; height: 24px; border-radius: 2px; }
        .mini-project-bar.diagnostic { background: var(--copilot); }
        .mini-project-bar.drafting { background: var(--assistant); }
        .mini-project-bar.review { background: var(--review); }
        .mini-project-info { flex: 1; }
        .mini-project-title { font-size: 12px; font-weight: 500; margin-bottom: 2px; }
        .mini-project-meta { font-size: 10px; color: var(--text-dim); }
        .mini-project-badge { font-size: 9px; padding: 3px 6px; border-radius: 4px; font-weight: 500; }
        .mini-project-badge.diagnostic { background: var(--copilot-bg); color: var(--copilot); }
        .mini-project-badge.drafting { background: var(--assistant-bg); color: var(--assistant); }
        .mini-project-badge.review { background: var(--review-bg); color: var(--review); }

        /* ═══ TOAST ═══ */
        .toast { position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%) translateY(100px); background: rgba(30,35,44,0.98); border: 1px solid var(--border); padding: 12px 20px; border-radius: 10px; font-size: 13px; color: var(--text); z-index: 9999; opacity: 0; transition: all 0.3s; pointer-events: none; }
        .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

        /* ═══ IMAGE VIEWER ═══ */
        .image-viewer { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 9000; display: none; align-items: center; justify-content: center; padding: 20px; }
        .image-viewer.active { display: flex; }
        .image-viewer img { max-width: 100%; max-height: 100%; object-fit: contain; border-radius: 8px; }
        .image-viewer-close { position: absolute; top: 20px; right: 20px; width: 40px; height: 40px; border-radius: 50%; background: rgba(255,255,255,0.1); border: none; color: white; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .image-viewer-close svg { width: 20px; height: 20px; }

        /* ═══ SCROLLBAR ═══ */
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 2px; }

        /* ═══ AVAILABILITY ═══ */
        .avail-card { background: var(--card); border: 1px solid var(--border); border-radius: 10px; overflow: hidden; }
        .avail-tabs { display: flex; gap: 4px; padding: 8px 10px; border-bottom: 1px solid var(--border); }
        .avail-tab { padding: 5px 10px; font-size: 10px; font-weight: 500; color: var(--text-dim); background: transparent; border: none; border-radius: 5px; cursor: pointer; transition: all 0.2s; }
        .avail-tab:hover { background: rgba(255,255,255,0.04); }
        .avail-tab.active { background: var(--copilot-bg); color: var(--copilot); }
        .avail-content { padding: 10px; }
        .avail-daily { display: flex; flex-direction: column; gap: 4px; max-height: 180px; overflow-y: auto; }
        .avail-slot { display: flex; gap: 8px; }
        .avail-time { width: 35px; font-size: 9px; color: var(--text-dim); text-align: right; padding-top: 4px; flex-shrink: 0; }
        .avail-block { flex: 1; min-height: 28px; background: rgba(255,255,255,0.02); border: 1px solid var(--border); border-radius: 4px; padding: 4px 6px; font-size: 9px; }
        .avail-block.available { background: var(--assistant-bg); border-color: var(--assistant-border); color: var(--assistant); }
        .avail-block.busy { background: var(--copilot-bg); border-color: var(--copilot-border); color: var(--copilot); }
        .avail-week { display: grid; grid-template-columns: 25px repeat(7, 1fr); gap: 1px; }
        .avail-week-header { text-align: center; font-size: 8px; color: var(--text-dim); padding: 4px 0; }
        .avail-week-time { font-size: 8px; color: var(--text-dim); text-align: right; padding: 4px 2px; display: flex; align-items: center; justify-content: flex-end; }
        .avail-week-slot { min-height: 28px; background: rgba(255,255,255,0.02); border: 1px solid var(--border); border-radius: 2px; }
        .avail-week-slot.available { background: var(--assistant-bg); border-color: var(--assistant-border); }
        .avail-week-slot.busy { background: var(--copilot-bg); border-color: var(--copilot-border); }
        .avail-month { display: grid; grid-template-columns: repeat(7, 1fr); gap: 1px; }
        .avail-month-header { text-align: center; font-size: 7px; color: var(--text-dim); padding: 3px 0; }
        .avail-month-day { min-height: 20px; display: flex; align-items: center; justify-content: center; font-size: 9px; border-radius: 3px; cursor: default; }
        .avail-month-day.other { opacity: 0.3; }
        .avail-month-day.available { background: var(--assistant-bg); color: var(--assistant); }
        .avail-month-day.busy { background: var(--copilot-bg); color: var(--copilot); }

        /* ═══ TECH TAG (EXTERNE) ═══ */
        .tech-tag { font-size: 8px; padding: 2px 5px; border-radius: 4px; font-weight: 600; margin-left: 6px; }
        .tech-tag.externe { background: rgba(147, 51, 234, 0.15); color: #a78bfa; }
        .tech-tag.interne { background: var(--assistant-bg); color: var(--assistant); }

        /* ═══ LOGIN MODAL (Legacy - scoped) ═══ */
        .login-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.9); display: flex; align-items: center; justify-content: center; z-index: 1000; }
        .login-modal-content { background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 16px; padding: 32px; width: 90%; max-width: 360px; }
        .login-modal .login-logo { font-size: 24px; font-weight: 700; color: var(--copilot); text-align: center; margin-bottom: 32px; }
        .login-modal .login-input { width: 100%; padding: 14px 16px; border-radius: 10px; border: 1px solid var(--border); background: var(--card); color: var(--text); font-size: 14px; margin-bottom: 12px; }
        .login-modal .login-input:focus { outline: none; border-color: var(--copilot); }
        .login-modal .login-btn { width: 100%; padding: 14px; border-radius: 10px; border: none; background: linear-gradient(135deg, var(--copilot), #E55A2B); color: white; font-size: 14px; font-weight: 600; cursor: pointer; margin-top: 8px; }
        .login-modal .login-btn:hover { opacity: 0.9; }

        /* ═══ AVAILABILITY SHARE MODAL ═══ */
        .availability-share-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 500; }
        .share-modal-content { background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 16px; width: 90%; max-width: 420px; max-height: 80vh; overflow-y: auto; }
        .share-modal-header { display: flex; align-items: center; justify-content: space-between; padding: 16px 20px; border-bottom: 1px solid var(--border); }
        .share-modal-header h3 { font-size: 16px; font-weight: 600; margin: 0; }
        .share-modal-close { width: 28px; height: 28px; border-radius: 50%; background: var(--card); border: 1px solid var(--border); color: var(--text-dim); cursor: pointer; font-size: 18px; display: flex; align-items: center; justify-content: center; }
        .share-modal-body { padding: 20px; }
        .share-tech-info { display: flex; align-items: center; gap: 12px; margin-bottom: 20px; }
        .share-tech-avatar { width: 48px; height: 48px; border-radius: 50%; background: var(--card); border: 1px solid var(--border); display: flex; align-items: center; justify-content: center; font-weight: 600; }
        .share-tech-name { font-size: 14px; font-weight: 600; }
        .share-tech-email { font-size: 12px; color: var(--text-dim); }
        .share-slots-list { background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 16px; }
        .share-slots-title { font-size: 12px; font-weight: 600; margin-bottom: 12px; color: var(--text-dim); }
        .share-slot-item { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid var(--border); font-size: 13px; }
        .share-slot-item:last-child { border-bottom: none; }
        .share-modal-footer { display: flex; gap: 10px; padding: 16px 20px; border-top: 1px solid var(--border); }

        /* ═══ PENDING SHARES BADGE ═══ */
        .pending-shares-badge { position: absolute; top: -4px; right: -4px; width: 18px; height: 18px; border-radius: 50%; background: #a78bfa; color: white; font-size: 10px; font-weight: 700; display: flex; align-items: center; justify-content: center; }

        /* ═══ RESPONSIVE - LARGER SCREENS ═══ */
        @media (min-width: 420px) {
            .login-btn { width: 38px; height: 38px; }
            .login-btn .icon { width: 14px; height: 14px; }
        }
    </style>
</head>
<body>
    <!-- SVG DEFINITIONS - Exact from technician app -->
    <svg class="svg-defs" xmlns="http://www.w3.org/2000/svg">
        <defs>
            <symbol id="icon-fixair-logo" viewBox="0 0 235 48"><path d="M35.1986 6.4H17.4706C15.4226 6.4 13.5666 6.912 11.9026 7.936C10.2386 8.96 8.89463 10.3253 7.87063 12.032C6.88929 13.696 6.39863 15.552 6.39863 17.6V48H-0.00137472V16C-0.00137472 13.7387 0.467959 11.648 1.40663 9.728C2.34529 7.76533 3.62529 6.08 5.24663 4.672C6.91063 3.22133 8.78796 2.09067 10.8786 1.28C12.9693 0.426664 15.1666 -3.8147e-06 17.4706 -3.8147e-06H35.1986V6.4ZM48.8306 4.8C48.8306 6.12266 48.3613 7.25333 47.4226 8.192C46.484 9.13066 45.3533 9.6 44.0306 9.6C42.708 9.6 41.5773 9.13066 40.6386 8.192C39.7 7.25333 39.2306 6.12266 39.2306 4.8C39.2306 3.47733 39.7 2.34666 40.6386 1.408C41.5773 0.46933 42.708 -3.8147e-06 44.0306 -3.8147e-06C45.3533 -3.8147e-06 46.484 0.46933 47.4226 1.408C48.3613 2.34666 48.8306 3.47733 48.8306 4.8ZM47.2306 48H40.8306V22.4H9.59863V16H47.2306V48ZM97.7161 48H88.5641L74.8681 34.752L61.4281 48H52.2761L70.4521 30.464L52.2761 12.8H61.4281L97.7161 48ZM97.7161 12.8L82.4841 27.648L77.8761 23.552L88.5641 12.8H97.7161Z" fill="currentColor"/><path d="M154.461 48H148.061V35.2H112.285V28.8H148.061V9.6H125.085C122.183 9.6 119.517 10.3253 117.085 11.776C114.653 13.184 112.711 15.104 111.261 17.536C109.853 19.968 109.149 22.656 109.149 25.6V48H102.749V25.6C102.749 22.528 103.325 19.648 104.477 16.96C105.629 14.2293 107.229 11.84 109.277 9.792C111.325 7.70133 113.693 6.08 116.381 4.928C119.111 3.776 122.013 3.2 125.085 3.2H154.461V48ZM171.604 48H165.204V3.2H171.604V48ZM234.041 48H225.401L211.961 35.2H192.313V28.864H218.041C219.833 28.864 221.454 28.4373 222.905 27.584C224.356 26.688 225.508 25.5147 226.361 24.064C227.214 22.5707 227.641 20.9493 227.641 19.2C227.641 17.408 227.214 15.7867 226.361 14.336C225.508 12.8853 224.356 11.7333 222.905 10.88C221.454 10.0267 219.833 9.6 218.041 9.6H188.729V48H182.329V3.2H218.041C220.985 3.2 223.673 3.92533 226.105 5.376C228.537 6.784 230.457 8.704 231.865 11.136C233.316 13.568 234.041 16.256 234.041 19.2C234.041 21.8453 233.444 24.2987 232.249 26.56C231.097 28.8213 229.497 30.6987 227.449 32.192C225.444 33.6427 223.161 34.5813 220.601 35.008L234.041 48Z" fill="currentColor"/></symbol>
            <symbol id="icon-plus" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></symbol>
            <symbol id="icon-camera" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></symbol>
            <symbol id="icon-paperclip" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"/></symbol>
            <symbol id="icon-x" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></symbol>
            <symbol id="icon-check" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></symbol>
            <symbol id="icon-search" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></symbol>
            <symbol id="icon-clipboard" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><rect x="8" y="2" width="8" height="4" rx="1" ry="1"/></symbol>
            <symbol id="icon-arrow-left" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 12H5M12 19l-7-7 7-7"/></symbol>
            <symbol id="icon-arrow-right" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 12h14M12 5l7 7-7 7"/></symbol>
        </defs>
    </svg>

    <!-- LOADING SCREEN -->
    <div class="screen active" id="loadingScreen" style="justify-content: center; align-items: center;">
        <div style="text-align: center;">
            <div class="login-logo" style="margin: 0 auto 24px;">
                <svg viewBox="0 0 235 48"><use href="#icon-fixair-logo"/></svg>
            </div>
            <div class="glass-sphere" style="margin: 0 auto 16px;">
                <div class="sphere-fog-container">
                    <div class="sphere-fog"></div>
                    <div class="sphere-fog-2"></div>
                </div>
            </div>
            <div style="color: rgba(255,255,255,0.5); font-size: 14px;">Chargement...</div>
        </div>
    </div>

    <!-- PENDING APPROVAL SCREEN -->
    <div class="screen pending-screen" id="pendingScreen">
        <div class="scan-line"></div>
        <div class="pending-container">
            <div class="pending-logo">
                <svg viewBox="0 0 235 48" style="height: 40px; color: var(--copilot);"><use href="#icon-fixair-logo"/></svg>
            </div>
            <h1 class="pending-title">Demande en attente</h1>
            <p class="pending-subtitle">
                Votre email a été confirmé ! Un administrateur va valider votre accès dans les plus brefs délais.
            </p>
            <div class="pending-email" id="pendingEmail"></div>
            <button class="pending-logout" onclick="logoutFromPending()">
                Se déconnecter
            </button>
        </div>
    </div>

    <!-- ACCESS DENIED SCREEN (for technicians trying to access manager) -->
    <div class="screen pending-screen" id="accessDeniedScreen">
        <div class="scan-line"></div>
        <div class="pending-container">
            <div class="pending-logo">
                <svg viewBox="0 0 235 48" style="height: 40px; color: var(--copilot);"><use href="#icon-fixair-logo"/></svg>
            </div>
            <h1 class="pending-title">Accès réservé</h1>
            <p class="pending-subtitle">
                Cette application est réservée aux managers et administrateurs. En tant que technicien, vous serez redirigé vers l'application Technicien.
            </p>
            <div class="pending-email" id="accessDeniedEmail"></div>
            <button class="pending-logout" onclick="redirectToTechnicianApp()" style="margin-top: 8px; background: var(--copilot); color: white; border: none;">
                Aller à l'app Technicien
            </button>
            <button class="pending-logout" onclick="logoutFromPending()">
                Se déconnecter
            </button>
        </div>
    </div>

    <!-- PASSWORD RESET SCREEN -->
    <div class="screen pending-screen" id="passwordResetScreen">
        <div class="scan-line"></div>
        <div class="pending-container">
            <div class="pending-logo">
                <svg viewBox="0 0 235 48" style="height: 40px; color: var(--copilot);"><use href="#icon-fixair-logo"/></svg>
            </div>
            <h1 class="pending-title">Nouveau mot de passe</h1>
            <p class="pending-subtitle">
                Créez un nouveau mot de passe pour votre compte.
            </p>
            <div style="width: 100%; max-width: 300px; margin: 20px auto;">
                <input type="password" id="newPasswordInput" placeholder="Nouveau mot de passe (min 6 caractères)"
                    style="width: 100%; padding: 12px 16px; background: var(--card); border: 1px solid var(--border); border-radius: 8px; color: var(--text); font-size: 14px; margin-bottom: 12px;">
                <input type="password" id="confirmPasswordInput" placeholder="Confirmer le mot de passe"
                    style="width: 100%; padding: 12px 16px; background: var(--card); border: 1px solid var(--border); border-radius: 8px; color: var(--text); font-size: 14px; margin-bottom: 12px;">
                <div id="passwordResetStatus" style="margin-bottom: 12px; padding: 8px; border-radius: 6px; font-size: 13px; display: none;"></div>
                <button onclick="setNewPassword()"
                    style="width: 100%; padding: 12px 16px; background: var(--copilot); border: none; border-radius: 8px; color: #000; font-size: 14px; font-weight: 600; cursor: pointer;">
                    Mettre à jour le mot de passe
                </button>
            </div>
            <button class="pending-logout" onclick="cancelPasswordReset()" style="margin-top: 8px;">
                Annuler
            </button>
        </div>
    </div>

    <!-- MAIN APP WRAPPER (hidden until authenticated) -->
    <div class="screen main-app" id="mainApp">
    <!-- HOME -->
    <div class="home-wrapper" id="homeWrapper">
        <div class="home-main">
            <div class="home-content">
                <div class="home-content-inner">
                    <!-- Header with exact logo from technician app -->
                    <header class="header">
                        <div class="header-left">
                            <div class="header-logo-svg"><svg viewBox="0 0 235 48"><use href="#icon-fixair-logo"/></svg></div>
                            <span class="header-date">• Lundi 30 Déc</span>
                        </div>
                        <div class="header-avatar" id="headerAvatar" onclick="showProfileMenu()" title="Mon profil" style="cursor:pointer;">MA</div>
                    </header>

                    <div class="hero">
                        <div class="hero-top">
                            <div class="hero-label"><div class="live-dot"></div><span class="hero-label-text">Projets actifs</span></div>
                        </div>
                        <div class="hero-value">12 <span>projets</span></div>
                        <div class="hero-progress">
                            <div class="progress-header"><span class="progress-label">Progression globale</span><span class="progress-value">67%</span></div>
                            <div class="progress-bar"><div class="progress-fill" style="width: 67%"></div></div>
                        </div>
                    </div>

                    <div class="stats">
                        <div class="stat" onclick="openPage('team')"><div class="stat-value green">7</div><div class="stat-label">Techniciens</div></div>
                        <div class="stat" onclick="openPage('projects')"><div class="stat-value orange">8</div><div class="stat-label">Rapports</div></div>
                        <div class="stat"><div class="stat-value blue">2</div><div class="stat-label">À valider</div></div>
                    </div>

                    <div class="calendar-card" id="homeCalendar">
                        <div class="calendar-header">
                            <span class="calendar-month" id="homeCalTitle">Aujourd'hui</span>
                            <div class="calendar-nav">
                                <button class="calendar-nav-btn" onclick="navHomeCal(-1)"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 18l-6-6 6-6"/></svg></button>
                                <button class="calendar-nav-btn" onclick="navHomeCal(1)"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 18l6-6-6-6"/></svg></button>
                            </div>
                        </div>
                        <div class="calendar-tabs">
                            <button class="calendar-tab active" onclick="setHomeCalView('day', this)">Jour</button>
                            <button class="calendar-tab" onclick="setHomeCalView('week', this)">Semaine</button>
                            <button class="calendar-tab" onclick="setHomeCalView('month', this)">Mois</button>
                        </div>
                        <div id="homeCalContent"></div>
                    </div>

                    <div class="sec-head"><span class="sec-title">Priorité</span><div class="sec-line"></div><span class="sec-action" onclick="openPage('projects')">Voir tout</span></div>
                    <div class="card-list">
                        <div class="proj" onclick="openHomeDrawer('project', 1)"><div class="proj-status-bar review"></div><div class="proj-icon review"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg></div><div class="proj-info"><div class="proj-title">Rapport Carrier 30XA</div><div class="proj-meta">Pierre Bernard • BNP Paribas</div></div><div class="proj-right"><div class="proj-badge review">À valider</div><div class="proj-time warning">2h 05m</div></div></div>
                        <div class="proj" onclick="openHomeDrawer('project', 3)"><div class="proj-status-bar diagnostic"></div><div class="proj-icon copilot"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/></svg></div><div class="proj-info"><div class="proj-title">Diagnostic PAC Mitsubishi</div><div class="proj-meta">Jean Dupont • Hôtel Mercure</div></div><div class="proj-right"><div class="proj-badge diagnostic">Diagnostic</div><div class="proj-time">45m</div></div></div>
                    </div>

                    <div class="sec-head"><span class="sec-title">Équipe</span><div class="sec-line"></div><span class="sec-action" onclick="openPage('team')">7 / 9</span></div>
                    <div class="card-list">
                        <div class="tech" onclick="openHomeDrawer('tech', 't1')"><div class="tech-avatar">JD<div class="tech-status live"></div></div><div class="tech-info"><div class="tech-name">Jean Dupont</div><div class="tech-project">Mitsubishi • Diagnostic PAC</div></div><div class="tech-right"><span class="tech-time">2m</span></div></div>
                        <div class="tech needs-attention" onclick="openHomeDrawer('tech', 't5')"><div class="tech-avatar">PB<div class="tech-status idle"></div></div><div class="tech-info"><div class="tech-name">Pierre Bernard</div><div class="tech-project">Carrier • Rédaction</div></div><div class="tech-right"><span class="tech-time warning">18m idle</span></div></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="home-drawer" id="homeDrawer">
            <div class="drawer-header">
                <div class="drawer-close" onclick="closeHomeDrawer()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18M6 6l12 12"/></svg></div>
                <div class="drawer-title-wrap"><div class="drawer-title" id="homeDrawerTitle">-</div><div class="drawer-subtitle" id="homeDrawerSubtitle">-</div></div>
                <div class="drawer-badge" id="homeDrawerBadge">-</div>
            </div>
            <div class="drawer-body" id="homeDrawerBody"></div>
            <div class="drawer-footer" id="homeDrawerFooter"></div>
        </div>

        <div class="nested-drawer" id="homeNestedDrawer" style="z-index: 160;">
            <div class="drawer-header">
                <div class="drawer-close" onclick="closeHomeNestedDrawer()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18M6 6l12 12"/></svg></div>
                <div class="drawer-title-wrap"><div class="drawer-title" id="homeNestedTitle">-</div><div class="drawer-subtitle" id="homeNestedSubtitle">-</div></div>
                <div class="drawer-badge" id="homeNestedBadge">-</div>
            </div>
            <div class="drawer-body" id="homeNestedBody"></div>
            <div class="drawer-footer" id="homeNestedFooter"></div>
        </div>

        <nav class="home-nav" id="homeNav">
            <div class="nav-pill">
                <div class="nav-item active" onclick="goHome()"><svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/></svg><span class="nav-label">Dashboard</span></div>
                <div class="nav-item" onclick="openPage('projects')"><svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/></svg><span class="nav-label">Projets</span></div>
                <div class="nav-item" onclick="openPage('team')"><svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg><span class="nav-label">Équipe</span></div>
                <div class="nav-item" onclick="openPage('stats')"><svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg><span class="nav-label">Stats</span></div>
            </div>
        </nav>
    </div>

    <!-- PROJECTS PAGE -->
    <div class="full-page" id="pageProjects">
        <div class="page-layout">
            <div class="page-main">
                <div class="page-header">
                    <div class="page-back" onclick="closePage()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 12H5M12 19l-7-7 7-7"/></svg></div>
                    <div class="page-title-wrap"><div class="page-title">Projets</div><div class="page-subtitle">12 actifs aujourd'hui</div></div>
                    <div class="page-actions">
                        <button class="page-action-btn secondary" onclick="openPageDrawer('projects', 'calendar')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg></button>
                        <button class="page-action-btn" onclick="openPageDrawer('projects', 'create')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg></button>
                    </div>
                </div>
                <div class="page-content">
                    <div class="stats cols-4">
                        <div class="stat"><div class="stat-value orange">5</div><div class="stat-label">Diagnostic</div></div>
                        <div class="stat"><div class="stat-value green">5</div><div class="stat-label">Rédaction</div></div>
                        <div class="stat"><div class="stat-value blue">2</div><div class="stat-label">À valider</div></div>
                        <div class="stat"><div class="stat-value yellow">3</div><div class="stat-label">Planifiés</div></div>
                    </div>
                    <div class="sec-head"><span class="sec-title">À valider</span><div class="sec-line"></div></div>
                    <div class="card-list">
                        <div class="proj" onclick="selectProject(1)"><div class="proj-status-bar review"></div><div class="proj-icon review"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg></div><div class="proj-info"><div class="proj-title">Rapport Carrier 30XA</div><div class="proj-meta">Pierre Bernard • BNP Paribas</div></div><div class="proj-right"><div class="proj-badge review">À valider</div><div class="proj-time warning">2h 05m</div></div></div>
                        <div class="proj" onclick="selectProject(2)"><div class="proj-status-bar review"></div><div class="proj-icon review"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg></div><div class="proj-info"><div class="proj-title">Diagnostic LG Multi V</div><div class="proj-meta">Antoine Girard • IKEA</div></div><div class="proj-right"><div class="proj-badge review">À valider</div><div class="proj-time">45m</div></div></div>
                    </div>
                    <div class="sec-head"><span class="sec-title">En cours</span><div class="sec-line"></div></div>
                    <div class="card-list">
                        <div class="proj" onclick="selectProject(3)"><div class="proj-status-bar diagnostic"></div><div class="proj-icon copilot"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/></svg></div><div class="proj-info"><div class="proj-title">Diagnostic PAC Mitsubishi</div><div class="proj-meta">Jean Dupont • Hôtel Mercure</div></div><div class="proj-right"><div class="proj-badge diagnostic">Diagnostic</div><div class="proj-time">45m</div></div></div>
                        <div class="proj" onclick="selectProject(4)"><div class="proj-status-bar drafting"></div><div class="proj-icon assistant"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/></svg></div><div class="proj-info"><div class="proj-title">Maintenance Daikin VRV</div><div class="proj-meta">Marie Leblanc • Carrefour</div></div><div class="proj-right"><div class="proj-badge drafting">Rédaction</div><div class="proj-time">1h 12m</div></div></div>
                    </div>
                </div>
            </div>
            <div class="page-drawer" id="projectsDrawer">
                <div class="drawer-header">
                    <div class="drawer-close" onclick="closePageDrawer('projects')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18M6 6l12 12"/></svg></div>
                    <div class="drawer-title-wrap"><div class="drawer-title" id="projectDrawerTitle">-</div><div class="drawer-subtitle" id="projectDrawerSubtitle">-</div></div>
                    <div class="drawer-badge" id="projectDrawerBadge">-</div>
                </div>
                <div class="drawer-body" id="projectDrawerBody"></div>
                <div class="drawer-footer" id="projectDrawerFooter"></div>
            </div>
        </div>
    </div>

    <!-- TEAM PAGE -->
    <div class="full-page" id="pageTeam">
        <div class="page-layout">
            <div class="page-main">
                <div class="page-header">
                    <div class="page-back" onclick="closePage()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 12H5M12 19l-7-7 7-7"/></svg></div>
                    <div class="page-title-wrap"><div class="page-title">Équipe</div><div class="page-subtitle">7 actifs / 9 total</div></div>
                    <div class="page-actions"><button class="page-action-btn" onclick="openPageDrawer('team', 'addTech')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg></button></div>
                </div>
                <div class="page-content">
                    <div class="stats cols-4">
                        <div class="stat"><div class="stat-value green">7</div><div class="stat-label">Actifs</div></div>
                        <div class="stat"><div class="stat-value yellow">1</div><div class="stat-label">Idle</div></div>
                        <div class="stat"><div class="stat-value">1</div><div class="stat-label">Offline</div></div>
                        <div class="stat"><div class="stat-value">24m</div><div class="stat-label">Moy.</div></div>
                    </div>
                    <div class="sec-head"><span class="sec-title">Actifs</span><div class="sec-line"></div></div>
                    <div class="card-list">
                        <div class="tech" onclick="selectTech('t1')"><div class="tech-avatar">JD<div class="tech-status live"></div></div><div class="tech-info"><div class="tech-name">Jean Dupont</div><div class="tech-project">Mitsubishi • Diagnostic PAC</div></div><div class="tech-right"><span class="tech-time">2m</span></div></div>
                        <div class="tech" onclick="selectTech('t2')"><div class="tech-avatar">ML<div class="tech-status live"></div></div><div class="tech-info"><div class="tech-name">Marie Leblanc</div><div class="tech-project">Daikin • Maintenance</div></div><div class="tech-right"><span class="tech-time">5m</span></div></div>
                    </div>
                    <div class="sec-head"><span class="sec-title">Attention requise</span><div class="sec-line"></div></div>
                    <div class="card-list">
                        <div class="tech needs-attention" onclick="selectTech('t5')"><div class="tech-avatar">PB<div class="tech-status idle"></div></div><div class="tech-info"><div class="tech-name">Pierre Bernard</div><div class="tech-project">Carrier • Rédaction bloquée</div></div><div class="tech-right"><span class="tech-time warning">18m idle</span></div></div>
                    </div>
                </div>
            </div>
            <div class="page-drawer" id="teamDrawer">
                <div class="drawer-header">
                    <div class="drawer-close" onclick="closePageDrawer('team')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18M6 6l12 12"/></svg></div>
                    <div class="drawer-title-wrap"><div class="drawer-title" id="techDrawerTitle">-</div><div class="drawer-subtitle" id="techDrawerSubtitle">-</div></div>
                    <div class="drawer-badge" id="techDrawerBadge">-</div>
                </div>
                <div class="drawer-body" id="techDrawerBody"></div>
            </div>
        </div>
        <div class="nested-drawer" id="nestedProjectDrawer">
            <div class="drawer-header">
                <div class="drawer-close" onclick="closeNestedDrawer()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18M6 6l12 12"/></svg></div>
                <div class="drawer-title-wrap"><div class="drawer-title" id="nestedProjectTitle">-</div><div class="drawer-subtitle" id="nestedProjectSubtitle">-</div></div>
                <div class="drawer-badge" id="nestedProjectBadge">-</div>
            </div>
            <div class="drawer-body" id="nestedProjectBody"></div>
            <div class="drawer-footer" id="nestedProjectFooter"></div>
        </div>
    </div>

    <!-- STATS PAGE -->
    <div class="full-page" id="pageStats">
        <div class="page-layout">
            <div class="page-main">
                <div class="page-header">
                    <div class="page-back" onclick="closePage()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 12H5M12 19l-7-7 7-7"/></svg></div>
                    <div class="page-title-wrap"><div class="page-title">Statistiques</div><div class="page-subtitle">Décembre 2024</div></div>
                </div>
                <div class="page-content">
                    <div class="stats" style="grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 20px;">
                        <div class="stat" style="padding:16px;"><div class="stat-value green" style="font-size:28px;">156</div><div class="stat-label">Projets complétés</div><div style="font-size:10px;color:var(--assistant);margin-top:4px;">↑ +12% vs nov.</div></div>
                        <div class="stat" style="padding:16px;"><div class="stat-value orange" style="font-size:28px;">32m</div><div class="stat-label">Temps moyen</div><div style="font-size:10px;color:var(--assistant);margin-top:4px;">↓ -8% vs nov.</div></div>
                    </div>
                    <div class="sec-head"><span class="sec-title">Top Techniciens</span><div class="sec-line"></div></div>
                    <div class="card-list">
                        <div class="tech"><div class="tech-avatar">ML</div><div class="tech-info"><div class="tech-name">Marie Leblanc</div><div class="tech-project">32 projets • 28m moy.</div></div><div class="tech-right"><span class="tech-time" style="color: var(--assistant);">100%</span></div></div>
                        <div class="tech"><div class="tech-avatar">JD</div><div class="tech-info"><div class="tech-name">Jean Dupont</div><div class="tech-project">28 projets • 32m moy.</div></div><div class="tech-right"><span class="tech-time" style="color: var(--assistant);">98%</span></div></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Hidden file inputs -->
    <input type="file" id="cameraInput" accept="image/*" capture="environment" class="hidden-input" onchange="handleFileSelect(event, 'camera')">
    <input type="file" id="fileInput" accept="image/*,.pdf,.doc,.docx" class="hidden-input" onchange="handleFileSelect(event, 'file')">
    </div><!-- End main-app -->

    <!-- Image Viewer -->
    <div class="image-viewer" id="imageViewer" onclick="closeImageViewer()">
        <button class="image-viewer-close"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><use href="#icon-x"/></svg></button>
        <img id="imageViewerImg" src="" alt="">
    </div>

    <!-- Toast -->
    <div class="toast" id="toast"></div>

    <script>
        // ═══════════════════════════════════════════════════════════════
        // SUPABASE CONFIGURATION
        // ═══════════════════════════════════════════════════════════════
        const SUPABASE_URL = 'https://fwuhzraxqrvmpqxnzpqm.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZ3dWh6cmF4cXJ2bXBxeG56cHFtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYyNTcyMTksImV4cCI6MjA4MTgzMzIxOX0.8ryQm1tsdx5ox3aFJiiflmwuEGGxxH_PlobGxXMgFuQ';

        // ANTI-LOOP: localStorage flag to detect redirect loops
        const REDIRECT_FLAG = 'fixair_redirect_in_progress';

        let sb = null;
        let currentUserId = null;
        let currentAdminProfile = null;
        let realtimeSubscriptions = [];

        // Live data from database
        let liveTeamData = {};
        let liveProjectData = {};
        let livePendingShares = [];

        // Auth state
        let loginStep = 0;
        let isNewUser = false;
        let existingUserName = '';
        let isPasswordRecovery = false;
        let supabaseUser = null;

        // Parse URL hash for auth tokens
        function parseHashParams(hash) {
            if (!hash || hash.length < 2) return {};
            const params = {};
            const hashContent = hash.substring(1);
            const pairs = hashContent.split('&');
            for (const pair of pairs) {
                const [key, value] = pair.split('=');
                if (key && value) {
                    params[decodeURIComponent(key)] = decodeURIComponent(value);
                }
            }
            return params;
        }

        const initialHash = window.location.hash;
        const hashParams = parseHashParams(initialHash);
        const hasAccessToken = !!hashParams.access_token;
        const hasRefreshToken = !!hashParams.refresh_token;
        const tokenType = hashParams.type;
        const isRecoveryLink = tokenType === 'recovery';

        // Clean URL hash
        if (initialHash) {
            window.history.replaceState(null, '', window.location.pathname + window.location.search);
        }

        function initSupabase() {
            try {
                sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
                    auth: {
                        persistSession: true,
                        autoRefreshToken: true,
                        detectSessionInUrl: true
                    }
                });
                console.log('✅ Supabase initialized');
                return true;
            } catch (err) {
                console.error('❌ Supabase init error:', err);
                return false;
            }
        }

        // ═══════════════════════════════════════════════════════════════
        // AUTHENTICATION - LOGIN FLOW (Same as Technician App)
        // ═══════════════════════════════════════════════════════════════

        function setLoginStatus(message, type = 'info', showReset = false) {
            const statusEl = document.getElementById('loginStatus');
            if (!statusEl) return;
            statusEl.className = 'login-status ' + type;
            if (showReset) {
                statusEl.innerHTML = message + ' <a onclick="resetPassword()">Réinitialiser</a>';
            } else {
                statusEl.textContent = message;
            }
        }

        function clearLoginStatus() {
            const statusEl = document.getElementById('loginStatus');
            if (statusEl) {
                statusEl.textContent = '';
                statusEl.className = 'login-status';
            }
        }

        async function resetPassword() {
            const email = document.getElementById('loginEmailInput').value.trim();
            if (!email.includes('@')) {
                setLoginStatus('Entrez votre email d\'abord', 'error');
                return;
            }
            try {
                const redirectUrl = window.location.origin + window.location.pathname;
                const { error } = await sb.auth.resetPasswordForEmail(email, { redirectTo: redirectUrl });
                if (error) {
                    setLoginStatus('Erreur: ' + error.message, 'error');
                } else {
                    setLoginStatus('Email de réinitialisation envoyé ! Vérifiez votre boîte mail (et spam).', 'success');
                }
            } catch (err) {
                setLoginStatus('Erreur lors de l\'envoi', 'error');
            }
        }

        async function nextLoginStep() {
            const btn = document.getElementById('loginBtn');

            if (loginStep === 0) {
                // Step 0: Check email
                const email = document.getElementById('loginEmailInput').value.trim();
                if (!email.includes('@')) {
                    setLoginStatus('Veuillez entrer un email valide', 'error');
                    return;
                }

                clearLoginStatus();
                btn.disabled = true;
                btn.innerHTML = '<span class="icon" style="animation: spin 1s linear infinite;"><svg><use href="#icon-arrow-right"/></svg></span>';

                try {
                    // Check if user exists in public.users
                    const { data: publicUser } = await sb
                        .from('users')
                        .select('id, first_name, status, role')
                        .eq('email', email)
                        .maybeSingle();

                    if (publicUser && publicUser.id) {
                        isNewUser = false;
                        existingUserName = publicUser.first_name || '';

                        const pwdInput = document.getElementById('loginPasswordInput');
                        pwdInput.placeholder = 'Entrez votre mot de passe';
                        if (existingUserName) {
                            setLoginStatus('Bienvenue ' + existingUserName + ' ! Entrez votre mot de passe', 'info');
                        } else {
                            setLoginStatus('Bienvenue ! Entrez votre mot de passe', 'info');
                        }

                        loginStep = 1;
                        updateLoginUI();
                    } else {
                        // Admin app does not allow new signups
                        isNewUser = true;
                        setLoginStatus('Compte non trouve. Les comptes admin sont crees sur invitation uniquement.', 'error', true);
                        // Don't advance to next step
                    }

                } catch (error) {
                    console.error('Check email error:', error);
                    setLoginStatus('Erreur de connexion. Reessayez.', 'error');
                } finally {
                    btn.disabled = false;
                    btn.innerHTML = '<span class="icon"><svg><use href="#icon-arrow-right"/></svg></span>';
                }

            } else if (loginStep === 1) {
                // Step 1: Password
                const email = document.getElementById('loginEmailInput').value.trim();
                const password = document.getElementById('loginPasswordInput').value;

                if (password.length < 6) {
                    setLoginStatus('Mot de passe: 6 caractères minimum', 'error');
                    return;
                }

                if (isNewUser) {
                    // Admin app does not allow new signups - this should not be reached
                    setLoginStatus('Les inscriptions ne sont pas autorisees sur cette application.', 'error');
                    return;
                } else {
                    // Existing user: try login
                    btn.disabled = true;
                    btn.innerHTML = '<span class="icon" style="animation: spin 1s linear infinite;"><svg><use href="#icon-arrow-right"/></svg></span>';

                    try {
                        const { data, error } = await sb.auth.signInWithPassword({ email, password });

                        if (error) {
                            setLoginStatus('Mot de passe incorrect', 'error', true);
                        } else {
                            clearLoginStatus();
                            supabaseUser = data.user;

                            // Persist session
                            localStorage.setItem('supabase.auth.token', JSON.stringify({
                                currentSession: data.session,
                                expiresAt: data.session.expires_at
                            }));

                            // Load user profile and check role (by email)
                            const profile = await loadUserProfile(data.user.email);

                            if (profile) {
                                currentAdminProfile = profile;
                                currentUserId = profile.id;

                                // Check approval status
                                if (profile.status !== 'approved' && profile.status !== 'active') {
                                    showPendingScreen(profile.email);
                                    return;
                                }

                                // Check role - only manager or admin can access
                                if (profile.role && !['manager', 'admin', 'owner'].includes(profile.role)) {
                                    showAccessDeniedScreen(profile.email);
                                    return;
                                }

                                // Success - show main app
                                toast('Bienvenue ' + (profile.first_name || 'Manager') + ' !');
                                showMainApp();
                            } else {
                                setLoginStatus('Erreur: profil non trouvé', 'error');
                            }
                        }
                    } catch (error) {
                        setLoginStatus('Erreur de connexion au serveur', 'error');
                        console.error('Login error:', error);
                    } finally {
                        btn.disabled = false;
                        btn.innerHTML = '<span class="icon"><svg><use href="#icon-arrow-right"/></svg></span>';
                    }
                }
            } else if (loginStep === 2) {
                // Step 2: Phone number
                const phone = document.getElementById('loginPhoneInput').value.trim();
                if (!phone || phone.length < 8) {
                    setLoginStatus('Veuillez entrer un numéro de téléphone valide', 'error');
                    return;
                }

                clearLoginStatus();
                setLoginStatus('Comment vous appelez-vous ?', 'info');
                loginStep = 3;
                document.getElementById('loginBtn').innerHTML = '<span class="icon"><svg><use href="#icon-check"/></svg></span>';
                document.getElementById('loginBtn').onclick = completeSignup;
                updateLoginUI();
            }
        }

        function updateLoginUI() {
            document.getElementById('loginSlider').style.transform = `translateX(-${loginStep * 100}%)`;
            document.getElementById('loginSphere').style.display = loginStep === 0 ? 'flex' : 'none';
            document.getElementById('loginBack').style.display = loginStep === 0 ? 'none' : 'flex';
        }

        function prevLoginStep() {
            if (loginStep > 0) {
                loginStep--;
                clearLoginStatus();
                updateLoginUI();
                if (loginStep < 3) {
                    document.getElementById('loginBtn').innerHTML = '<span class="icon"><svg><use href="#icon-arrow-right"/></svg></span>';
                    document.getElementById('loginBtn').onclick = nextLoginStep;
                }
            }
        }

        async function completeSignup() {
            const name = document.getElementById('loginNameInput').value.trim();
            if (!name) { setLoginStatus('Entrez votre prénom', 'error'); return; }

            const email = document.getElementById('loginEmailInput').value.trim();
            const password = document.getElementById('loginPasswordInput').value;
            const phone = document.getElementById('loginPhoneInput').value.trim();

            const btn = document.getElementById('loginBtn');
            btn.disabled = true;
            btn.innerHTML = '<span class="icon" style="animation: spin 1s linear infinite;"><svg><use href="#icon-check"/></svg></span>';

            try {
                const { data, error } = await sb.auth.signUp({
                    email,
                    password,
                    options: {
                        data: { first_name: name, phone: phone }
                    }
                });

                if (error) {
                    const errMsg = error.message.toLowerCase();
                    if (errMsg.includes('already registered') || errMsg.includes('already exists')) {
                        setLoginStatus('Ce compte existe déjà. Essayez de vous connecter.', 'error', true);
                        isNewUser = false;
                        loginStep = 0;
                        updateLoginUI();
                    } else {
                        setLoginStatus(error.message || 'Erreur lors de la création du compte', 'error');
                    }
                    return;
                }

                if (data.user && !data.user.email_confirmed_at) {
                    showEmailConfirmScreen(email);
                    toast('Vérifiez votre email !');
                } else if (data.user) {
                    supabaseUser = data.user;
                    showPendingScreen(email);
                    toast('Compte créé !');
                }

            } catch (error) {
                setLoginStatus('Erreur de connexion', 'error');
                console.error('Register error:', error);
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<span class="icon"><svg><use href="#icon-check"/></svg></span>';
            }
        }

        async function loadUserProfile(email) {
            try {
                // Query by email (most reliable)
                const { data, error } = await sb
                    .from('users')
                    .select('*')
                    .eq('email', email)
                    .maybeSingle();

                if (error) {
                    console.error('Error loading user profile:', error);
                    return null;
                }
                return data;
            } catch (err) {
                console.error('Exception loading user profile:', err);
                return null;
            }
        }

        // Screen helper functions
        function showEmailConfirmScreen(email) {
            clearLoginStatus();
            document.getElementById('confirmEmail').textContent = email;
            document.getElementById('loginScreen').classList.remove('active');
            document.getElementById('mainApp').classList.remove('active');
            document.getElementById('pendingScreen').classList.remove('active');
            document.getElementById('accessDeniedScreen').classList.remove('active');
            document.getElementById('emailConfirmScreen').classList.add('active');
        }

        function showPendingScreen(email) {
            document.getElementById('pendingEmail').textContent = email;
            document.getElementById('loadingScreen').classList.remove('active');
            document.getElementById('mainApp').classList.remove('active');
            document.getElementById('accessDeniedScreen').classList.remove('active');
            document.getElementById('pendingScreen').classList.add('active');
        }

        function showAccessDeniedScreen(email, role) {
            // Determine redirect URL based on role
            let redirectUrl = 'https://go.fixair.ai';
            let appName = 'Technicien';

            if (role === 'manager') {
                redirectUrl = 'https://go.fixair.ai/manager';
                appName = 'Manager';
            } else if (role === 'technician') {
                redirectUrl = 'https://go.fixair.ai';
                appName = 'Technicien';
            }

            // Update the access denied screen content dynamically
            const accessDeniedScreen = document.getElementById('accessDeniedScreen');
            const container = accessDeniedScreen.querySelector('.pending-container');
            if (container) {
                container.innerHTML = `
                    <div class="pending-logo">
                        <svg viewBox="0 0 235 48" style="height: 40px; color: var(--copilot);"><use href="#icon-fixair-logo"/></svg>
                    </div>
                    <h1 class="pending-title">Acces reserve</h1>
                    <p class="pending-subtitle">
                        Cette application est reservee aux administrateurs.
                        En tant que ${role}, vous serez redirige vers l'application ${appName}.
                    </p>
                    <div class="pending-email">${email}</div>
                    <a href="${redirectUrl}" style="display:inline-block;background:var(--copilot);color:white;padding:12px 32px;border-radius:8px;text-decoration:none;font-weight:600;margin-top:16px;">
                        Aller a l'app ${appName}
                    </a>
                    <button class="pending-logout" onclick="logout()" style="margin-top:8px;">
                        Se deconnecter
                    </button>
                `;
            }

            document.getElementById('loadingScreen').classList.remove('active');
            document.getElementById('mainApp').classList.remove('active');
            document.getElementById('pendingScreen').classList.remove('active');
            document.getElementById('accessDeniedScreen').classList.add('active');
        }

        function showPasswordResetScreen() {
            document.getElementById('loadingScreen').classList.remove('active');
            document.getElementById('pendingScreen').classList.remove('active');
            document.getElementById('mainApp').classList.remove('active');
            document.getElementById('accessDeniedScreen').classList.remove('active');
            document.getElementById('passwordResetScreen').classList.add('active');
        }

        function redirectToTechnicianApp() {
            window.location.href = '/';
        }

        function backToLogin() {
            window.location.replace('https://go.fixair.ai/auth');
        }

        async function logoutFromPending() {
            await sb.auth.signOut();
            localStorage.removeItem('supabase.auth.token');
            localStorage.removeItem(REDIRECT_FLAG);
            window.location.replace('https://go.fixair.ai/auth?logout=true');
        }

        async function setNewPassword() {
            const newPass = document.getElementById('newPasswordInput').value;
            const confirmPass = document.getElementById('confirmPasswordInput').value;
            const statusEl = document.getElementById('passwordResetStatus');

            if (!newPass || newPass.length < 6) {
                statusEl.style.display = 'block';
                statusEl.style.background = 'rgba(239,68,68,0.2)';
                statusEl.style.border = '1px solid rgba(239,68,68,0.5)';
                statusEl.style.color = '#ef4444';
                statusEl.textContent = 'Le mot de passe doit contenir au moins 6 caractères';
                return;
            }

            if (newPass !== confirmPass) {
                statusEl.style.display = 'block';
                statusEl.style.background = 'rgba(239,68,68,0.2)';
                statusEl.style.border = '1px solid rgba(239,68,68,0.5)';
                statusEl.style.color = '#ef4444';
                statusEl.textContent = 'Les mots de passe ne correspondent pas';
                return;
            }

            statusEl.style.display = 'block';
            statusEl.style.background = 'rgba(59,130,246,0.2)';
            statusEl.style.border = '1px solid rgba(59,130,246,0.5)';
            statusEl.style.color = '#3b82f6';
            statusEl.textContent = 'Mise à jour en cours...';

            try {
                const { error } = await sb.auth.updateUser({ password: newPass });

                if (error) {
                    statusEl.style.background = 'rgba(239,68,68,0.2)';
                    statusEl.style.border = '1px solid rgba(239,68,68,0.5)';
                    statusEl.style.color = '#ef4444';
                    statusEl.textContent = 'Erreur: ' + error.message;
                    return;
                }

                statusEl.style.background = 'rgba(16,185,129,0.2)';
                statusEl.style.border = '1px solid rgba(16,185,129,0.5)';
                statusEl.style.color = '#10b981';
                statusEl.textContent = 'Mot de passe mis à jour ! Redirection...';

                isPasswordRecovery = false;
                localStorage.removeItem('supabase.auth.token');
                await sb.auth.signOut();

                // Redirect to auth page after brief delay
                setTimeout(() => {
                    window.location.replace('https://go.fixair.ai/auth');
                }, 1500);

            } catch (err) {
                statusEl.style.background = 'rgba(239,68,68,0.2)';
                statusEl.style.border = '1px solid rgba(239,68,68,0.5)';
                statusEl.style.color = '#ef4444';
                statusEl.textContent = 'Erreur lors de la mise à jour';
            }
        }

        function cancelPasswordReset() {
            isPasswordRecovery = false;
            localStorage.removeItem('supabase.auth.token');
            sb.auth.signOut();
            window.location.replace('https://go.fixair.ai/auth');
        }

        function showMainApp() {
            document.getElementById('loadingScreen').classList.remove('active');
            document.getElementById('pendingScreen').classList.remove('active');
            document.getElementById('accessDeniedScreen').classList.remove('active');
            document.getElementById('passwordResetScreen').classList.remove('active');
            document.getElementById('mainApp').classList.add('active');

            // Update header avatar with user initials
            if (currentAdminProfile) {
                const initials = getInitials(currentAdminProfile.first_name, currentAdminProfile.last_name);
                document.getElementById('headerAvatar').textContent = initials;
            }

            loadAllData();
        }

        // ═══════════════════════════════════════════════════════════════
        // PROFILE MENU
        // ═══════════════════════════════════════════════════════════════
        function showProfileMenu() {
            const profile = currentAdminProfile;
            if (!profile) return;

            const menuHTML = `
                <div id="profileOverlay" onclick="closeProfileMenu()" style="position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:998;"></div>
                <div id="profilePanel" style="position:fixed;top:0;right:0;bottom:0;width:320px;background:#161b22;border-left:1px solid rgba(255,255,255,0.1);z-index:999;padding:24px;overflow-y:auto;animation:slideInProfile 0.3s ease;">
                    <style>
                        @keyframes slideInProfile { from { transform: translateX(100%); } to { transform: translateX(0); } }
                    </style>

                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:24px;">
                        <h2 style="color:white;font-size:18px;margin:0;">Mon Profil</h2>
                        <button onclick="closeProfileMenu()" style="background:none;border:none;color:rgba(255,255,255,0.6);font-size:24px;cursor:pointer;line-height:1;">&times;</button>
                    </div>

                    <div style="text-align:center;margin-bottom:24px;">
                        <div style="width:80px;height:80px;border-radius:50%;background:linear-gradient(135deg,#FF6B35,#ff8f5a);display:flex;align-items:center;justify-content:center;margin:0 auto 12px;font-size:28px;font-weight:600;color:white;">
                            ${getInitials(profile.first_name, profile.last_name)}
                        </div>
                        <div style="color:white;font-size:16px;font-weight:600;">${profile.first_name || ''} ${profile.last_name || ''}</div>
                        <div style="color:rgba(255,255,255,0.5);font-size:13px;">${profile.email}</div>
                        <div style="margin-top:8px;display:inline-block;padding:4px 12px;background:rgba(255,107,53,0.15);border-radius:12px;font-size:11px;color:#FF6B35;text-transform:uppercase;">
                            ${profile.role}
                        </div>
                    </div>

                    <div style="border-top:1px solid rgba(255,255,255,0.1);padding-top:20px;">
                        <div style="margin-bottom:16px;">
                            <label style="display:block;font-size:11px;color:rgba(255,255,255,0.4);margin-bottom:4px;">Prénom</label>
                            <div style="color:white;font-size:14px;">${profile.first_name || '-'}</div>
                        </div>

                        <div style="margin-bottom:16px;">
                            <label style="display:block;font-size:11px;color:rgba(255,255,255,0.4);margin-bottom:4px;">Nom</label>
                            <div style="color:white;font-size:14px;">${profile.last_name || '-'}</div>
                        </div>

                        <div style="margin-bottom:16px;">
                            <label style="display:block;font-size:11px;color:rgba(255,255,255,0.4);margin-bottom:4px;">Email</label>
                            <div style="color:white;font-size:14px;">${profile.email || '-'}</div>
                        </div>

                        <div style="margin-bottom:16px;">
                            <label style="display:block;font-size:11px;color:rgba(255,255,255,0.4);margin-bottom:4px;">Téléphone</label>
                            <div style="color:white;font-size:14px;">${profile.phone || '-'}</div>
                        </div>

                        ${profile.company_name ? `
                        <div style="margin-bottom:16px;">
                            <label style="display:block;font-size:11px;color:rgba(255,255,255,0.4);margin-bottom:4px;">Entreprise</label>
                            <div style="color:white;font-size:14px;">${profile.company_name}</div>
                        </div>
                        ` : ''}
                    </div>

                    <div style="border-top:1px solid rgba(255,255,255,0.1);padding-top:20px;margin-top:20px;">
                        <button onclick="logout()" style="width:100%;background:rgba(239,68,68,0.1);border:1px solid rgba(239,68,68,0.3);color:#ef4444;padding:12px;border-radius:8px;font-size:14px;cursor:pointer;transition:all 0.2s;">
                            Se déconnecter
                        </button>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', menuHTML);
        }

        function closeProfileMenu() {
            document.getElementById('profileOverlay')?.remove();
            document.getElementById('profilePanel')?.remove();
        }

        async function logout() {
            await sb.auth.signOut();
            localStorage.removeItem('supabase.auth.token');
            localStorage.removeItem(REDIRECT_FLAG);
            cleanupSubscriptions();
            window.location.replace('https://go.fixair.ai/auth?logout=true');
        }

        // Initialize auth on page load
        async function initAuth() {
            // Clear redirect flag - we arrived successfully
            localStorage.removeItem(REDIRECT_FLAG);

            // Handle URL tokens (from password reset links)
            if (hasAccessToken && hasRefreshToken) {
                if (isRecoveryLink) {
                    isPasswordRecovery = true;
                }

                try {
                    const { data, error } = await sb.auth.setSession({
                        access_token: hashParams.access_token,
                        refresh_token: hashParams.refresh_token
                    });

                    if (error) {
                        isPasswordRecovery = false;
                        window.location.replace('https://go.fixair.ai/auth');
                        return;
                    }

                    if (data.session) {
                        localStorage.setItem('supabase.auth.token', JSON.stringify({
                            currentSession: data.session,
                            expiresAt: data.session.expires_at
                        }));
                    }

                    if (isRecoveryLink) {
                        showPasswordResetScreen();
                        return;
                    } else if (data.session && data.session.user) {
                        await handleAuthenticatedUser(data.session.user);
                        return;
                    }
                } catch (err) {
                    isPasswordRecovery = false;
                    window.location.replace('https://go.fixair.ai/auth');
                    return;
                }
            }

            // Check for existing session via Supabase SDK
            try {
                const { data: { session }, error } = await sb.auth.getSession();

                if (session && session.user) {
                    await handleAuthenticatedUser(session.user);
                    return;
                }

                // Try localStorage as fallback
                const stored = localStorage.getItem('supabase.auth.token');
                if (stored) {
                    const parsed = JSON.parse(stored);
                    if (parsed.currentSession) {
                        const { data, error } = await sb.auth.setSession({
                            access_token: parsed.currentSession.access_token,
                            refresh_token: parsed.currentSession.refresh_token
                        });
                        if (!error && data.session) {
                            await handleAuthenticatedUser(data.session.user);
                            return;
                        }
                    }
                }
            } catch (err) {
                console.log('Session check error:', err);
            }

            // No valid session found
            console.log('No valid session found');

            // Check if we just came from auth (has timestamp param) - prevent loop
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('t')) {
                // We have timestamp - came from auth but session failed
                // Show error instead of redirecting again (stops loop)
                document.body.innerHTML = `
                    <div style="min-height:100vh;display:flex;align-items:center;justify-content:center;background:#0D1117;font-family:sans-serif;">
                        <div style="text-align:center;color:white;">
                            <h1 style="color:#FF6B35;">❌ Erreur de session</h1>
                            <p>Impossible de charger votre session.</p>
                            <a href="https://go.fixair.ai/auth?logout=true" style="color:#FF6B35;">Retour à la connexion</a>
                        </div>
                    </div>
                `;
                return;
            }

            // No timestamp = fresh visit, redirect to auth
            window.location.replace('https://go.fixair.ai/auth');
        }

        async function handleAuthenticatedUser(user) {
            supabaseUser = user;

            // Load user profile (by email)
            const profile = await loadUserProfile(user.email);

            if (profile) {
                currentAdminProfile = profile;
                currentUserId = profile.id;

                // Check approval status
                if (profile.status !== 'approved' && profile.status !== 'active') {
                    showPendingScreen(profile.email);
                    return;
                }

                // Check role - only admin can access Admin App
                if (profile.role && !['admin', 'owner'].includes(profile.role)) {
                    showAccessDeniedScreen(profile.email, profile.role);
                    return;
                }

                // Success - show main app
                showMainApp();
            } else {
                showPendingScreen(user.email);
            }
        }

        // Legacy functions for compatibility
        async function checkManagerAuth() {
            try {
                const { data: { session } } = await sb.auth.getSession();
                if (!session) {
                    console.log('No session - showing login');
                    return null;
                }

                const { data: profile } = await sb
                    .from('users')
                    .select('*')
                    .eq('id', session.user.id)
                    .maybeSingle();

                if (!profile) {
                    console.log('No profile found');
                    return null;
                }

                currentUserId = profile.id;
                currentAdminProfile = profile;

                // Check if user is an admin
                if (profile.role && !['admin', 'owner'].includes(profile.role)) {
                    console.log('User role is:', profile.role, '- not an admin');
                    return null;
                }

                console.log('✅ Manager authenticated:', profile.email);
                return profile;
            } catch (err) {
                console.error('Auth check error:', err);
                return null;
            }
        }

        async function managerLogout() {
            await logout();
        }

        // ═══════════════════════════════════════════════════════════════
        // DATA LOADING - TEAM
        // ═══════════════════════════════════════════════════════════════
        async function loadTeamMembers() {
            if (!currentUserId) return;
            
            try {
                liveTeamData = {};
                
                // 1. Get INTERNE technicians (where manager_id = current user)
                const { data: internes, error: interneError } = await sb
                    .from('users')
                    .select('*')
                    .eq('manager_id', currentUserId);
                
                if (interneError) console.error('Error loading internes:', interneError);
                
                for (const tech of internes || []) {
                    const techId = tech.id;
                    const initials = getInitials(tech.first_name, tech.last_name);
                    
                    // Get technician's projects
                    const { data: projects } = await sb
                        .from('projects')
                        .select('id, title, client_name, status, brand')
                        .eq('user_id', techId)
                        .order('created_at', { ascending: false })
                        .limit(10);
                    
                    // Get current project
                    let currentProject = null;
                    if (tech.current_project_id) {
                        const { data: proj } = await sb
                            .from('projects')
                            .select('id, title, client_name, status, brand')
                            .eq('id', tech.current_project_id)
                            .maybeSingle();
                        currentProject = proj;
                    } else if (projects && projects.length > 0) {
                        currentProject = projects[0];
                    }
                    
                    // Get messages between manager and tech
                    const { data: messages } = await sb
                        .from('team_messages')
                        .select('*')
                        .or(`and(sender_id.eq.${currentUserId},receiver_id.eq.${techId}),and(sender_id.eq.${techId},receiver_id.eq.${currentUserId})`)
                        .order('created_at', { ascending: true })
                        .limit(20);
                    
                    liveTeamData[techId] = {
                        id: techId,
                        name: `${tech.first_name || ''} ${tech.last_name || ''}`.trim() || tech.email,
                        initials: initials,
                        email: tech.email,
                        status: tech.live_status || tech.status || 'offline',
                        badge: getStatusBadge(tech.live_status || tech.status),
                        memberType: 'internal', // INTERNE
                        currentProject: currentProject ? currentProject.title : 'Aucun projet',
                        client: currentProject ? currentProject.client_name : '',
                        stats: { projects: projects?.length || 0, completed: 0, avgTime: '-', rate: '-' },
                        projects: (projects || []).map(p => ({
                            id: p.id,
                            title: p.title,
                            client: p.client_name,
                            status: p.status,
                            badge: getStatusBadge(p.status)
                        })),
                        messages: (messages || []).map(m => ({
                            type: m.sender_id === currentUserId ? 'sent' : 'received',
                            text: m.content,
                            time: formatTime(m.created_at)
                        }))
                    };
                }
                
                // 2. Get EXTERNE technicians (via accepted availability_shares)
                const { data: externes, error: externeError } = await sb
                    .from('availability_shares')
                    .select('*, technician:technician_id(*)')
                    .eq('accepted_by_manager_id', currentUserId)
                    .eq('status', 'accepted');
                
                if (externeError) console.error('Error loading externes:', externeError);
                
                for (const share of externes || []) {
                    const tech = share.technician;
                    if (!tech) continue;
                    
                    const techId = tech.id;
                    if (liveTeamData[techId]) continue; // Already added as interne
                    
                    const initials = getInitials(tech.first_name, tech.last_name);
                    
                    liveTeamData[techId] = {
                        id: techId,
                        name: `${tech.first_name || ''} ${tech.last_name || ''}`.trim() || tech.email,
                        initials: initials,
                        email: tech.email,
                        status: tech.live_status || tech.status || 'offline',
                        badge: getStatusBadge(tech.live_status || tech.status),
                        memberType: 'external', // EXTERNE
                        sharedSlots: share.time_slots || [],
                        currentProject: 'Disponibilité partagée',
                        client: '',
                        stats: { projects: 0, completed: 0, avgTime: '-', rate: '-' },
                        projects: [],
                        messages: []
                    };
                }
                
                console.log('✅ Loaded', Object.keys(liveTeamData).length, 'team members (INTERNE + EXTERNE)');
                updateTeamUI();
                
            } catch (err) {
                console.error('Error loading team:', err);
            }
        }

        // ═══════════════════════════════════════════════════════════════
        // DATA LOADING - PROJECTS
        // ═══════════════════════════════════════════════════════════════
        async function loadProjects() {
            if (!currentUserId) return;
            
            try {
                // Get projects from all team technicians (INTERNE)
                const teamTechIds = Object.keys(liveTeamData).filter(id => 
                    liveTeamData[id].memberType === 'internal'
                );
                
                // Also include manager's own projects for demo
                teamTechIds.push(currentUserId);
                
                let allProjects = [];
                
                if (teamTechIds.length > 0) {
                    const { data: projects, error } = await sb
                        .from('projects')
                        .select(`
                            *,
                            technician:user_id(id, first_name, last_name),
                            report:reports(id, status, created_at)
                        `)
                        .in('user_id', teamTechIds)
                        .order('updated_at', { ascending: false })
                        .limit(50);
                    
                    if (error) {
                        console.error('Error loading projects:', error);
                    } else {
                        allProjects = projects || [];
                    }
                }
                
                liveProjectData = {};
                for (const p of allProjects) {
                    const techName = p.technician ? 
                        `${p.technician.first_name || ''} ${p.technician.last_name || ''}`.trim() : 
                        'Non assigné';
                    
                    const report = p.report?.[0];
                    const extractedData = p.extracted_data || {};
                    
                    liveProjectData[p.id] = {
                        id: p.id,
                        title: p.title || `Projet ${p.brand || ''}`,
                        tech: techName,
                        techId: p.user_id,
                        client: p.client_name || '',
                        equipment: p.brand || '',
                        duration: getProjectDuration(p.created_at),
                        status: p.status || 'in_progress',
                        badge: getStatusBadge(p.status),
                        progress: { 
                            identification: extractedData.clientName ? 100 : 0, 
                            diagnostic: extractedData.problemDescription ? 100 : 0, 
                            mesures: extractedData.measurements ? 100 : 0, 
                            conclusion: extractedData.solution ? 100 : 0 
                        },
                        report: {
                            client: p.client_name || '',
                            address: p.client_address || '',
                            equipment: `${p.brand || ''} ${p.equipment_model || ''}`.trim(),
                            problem: p.problem_description || extractedData.problemDescription || '',
                            actions: p.solution_summary || extractedData.actions || ''
                        }
                    };
                }
                
                console.log('✅ Loaded', Object.keys(liveProjectData).length, 'projects');
                updateProjectsUI();
                
            } catch (err) {
                console.error('Error loading projects:', err);
            }
        }

        // ═══════════════════════════════════════════════════════════════
        // DATA LOADING - AVAILABILITY SHARES (PENDING)
        // ═══════════════════════════════════════════════════════════════
        async function loadPendingShares() {
            if (!currentAdminProfile?.email) return;
            
            try {
                const { data: shares, error } = await sb
                    .from('availability_shares')
                    .select(`
                        *,
                        technician:users!technician_id(id, first_name, last_name, email, avatar_url)
                    `)
                    .eq('recipient_email', currentAdminProfile.email)
                    .eq('status', 'pending');
                
                if (error) throw error;
                
                livePendingShares = shares || [];
                console.log('✅ Loaded', livePendingShares.length, 'pending availability shares');
                
                // Show notification if any pending
                if (livePendingShares.length > 0) {
                    showPendingSharesNotification();
                }
                
            } catch (err) {
                console.error('Error loading shares:', err);
            }
        }

        function showPendingSharesNotification() {
            const count = livePendingShares.length;
            toast(`🔗 ${count} technicien${count > 1 ? 's' : ''} souhaite${count > 1 ? 'nt' : ''} partager leurs disponibilités`);
        }

        // ═══════════════════════════════════════════════════════════════
        // ACCEPT AVAILABILITY SHARE (Add as EXTERNE)
        // ═══════════════════════════════════════════════════════════════
        async function acceptAvailabilityShare(shareId) {
            try {
                // Get share details
                const share = livePendingShares.find(s => s.id === shareId);
                if (!share) {
                    toast('❌ Partage non trouvé');
                    return;
                }
                
                // Update share status to accepted
                const { error: updateError } = await sb
                    .from('availability_shares')
                    .update({
                        status: 'accepted',
                        accepted_by_manager_id: currentUserId,
                        accepted_at: new Date().toISOString()
                    })
                    .eq('id', shareId);
                
                if (updateError) throw updateError;
                
                // Create calendar events from shared slots
                if (share.time_slots && Array.isArray(share.time_slots)) {
                    for (const slot of share.time_slots) {
                        const { error: eventError } = await sb
                            .from('calendar_events')
                            .insert({
                                user_id: share.technician_id,
                                title: 'Disponible (partagé)',
                                type: 'availability',
                                date: slot.date,
                                start_time: slot.start,
                                end_time: slot.end,
                                visibility: 'shared',
                                share_id: shareId,
                                visible_to_manager_id: currentUserId
                            });
                        
                        if (eventError) console.error('Error creating event:', eventError);
                    }
                }
                
                toast('✅ Technicien externe ajouté à votre équipe!');
                
                // Refresh data
                await loadPendingShares();
                await loadTeamMembers();
                closeAvailabilityShareModal();
                
            } catch (err) {
                console.error('Error accepting share:', err);
                toast('❌ Erreur: ' + err.message);
            }
        }

        async function rejectAvailabilityShare(shareId) {
            try {
                await sb
                    .from('availability_shares')
                    .update({ status: 'rejected' })
                    .eq('id', shareId);
                
                toast('Partage refusé');
                await loadPendingShares();
                closeAvailabilityShareModal();
                
            } catch (err) {
                toast('❌ Erreur: ' + err.message);
            }
        }

        // ═══════════════════════════════════════════════════════════════
        // REAL-TIME SUBSCRIPTIONS
        // ═══════════════════════════════════════════════════════════════
        async function setupRealtimeSubscriptions() {
            if (!currentUserId) return;
            
            // Subscribe to team status changes (users with manager_id = me)
            const teamSub = sb
                .channel('team-status')
                .on('postgres_changes', {
                    event: 'UPDATE',
                    schema: 'public',
                    table: 'users',
                    filter: `manager_id=eq.${currentUserId}`
                }, (payload) => {
                    console.log('Team member update:', payload);
                    loadTeamMembers(); // Reload team
                })
                .subscribe();
            
            realtimeSubscriptions.push(teamSub);
            
            // Subscribe to project updates (for team technicians)
            // Note: Can't filter by multiple user_ids, so we listen to all and filter in handler
            const projectSub = sb
                .channel('project-updates')
                .on('postgres_changes', {
                    event: '*',
                    schema: 'public',
                    table: 'projects'
                }, (payload) => {
                    // Check if this project belongs to our team
                    const techId = payload.new?.user_id || payload.old?.user_id;
                    if (techId && (liveTeamData[techId] || techId === currentUserId)) {
                        console.log('Project update:', payload);
                        loadProjects();
                    }
                })
                .subscribe();
            
            realtimeSubscriptions.push(projectSub);
            
            // Subscribe to new messages (where I'm sender or receiver)
            const messageSub = sb
                .channel('team-messages')
                .on('postgres_changes', {
                    event: 'INSERT',
                    schema: 'public',
                    table: 'team_messages',
                    filter: `receiver_id=eq.${currentUserId}`
                }, (payload) => {
                    console.log('New message received:', payload);
                    handleNewMessage(payload.new);
                })
                .subscribe();
            
            realtimeSubscriptions.push(messageSub);
            
            // Subscribe to new availability shares (pending shares for me)
            if (currentAdminProfile?.email) {
                const shareSub = sb
                    .channel('availability-shares')
                    .on('postgres_changes', {
                        event: 'INSERT',
                        schema: 'public',
                        table: 'availability_shares',
                        filter: `recipient_email=eq.${currentAdminProfile.email}`
                    }, (payload) => {
                        console.log('New availability share:', payload);
                        loadPendingShares();
                        showNewShareNotification(payload.new);
                    })
                    .subscribe();
                
                realtimeSubscriptions.push(shareSub);
            }
            
            console.log('✅ Real-time subscriptions active');
        }

        function cleanupSubscriptions() {
            realtimeSubscriptions.forEach(sub => {
                if (sub && sub.unsubscribe) {
                    sub.unsubscribe();
                }
            });
            realtimeSubscriptions = [];
        }

        function handleNewMessage(message) {
            // Update message in UI if chat is open
            const techId = message.sender_id === currentUserId ? message.recipient_id : message.sender_id;
            if (liveTeamData[techId]) {
                liveTeamData[techId].messages.push({
                    type: message.sender_id === currentUserId ? 'sent' : 'received',
                    text: message.content,
                    time: formatTime(message.created_at)
                });
            }
            toast('💬 Nouveau message');
        }

        function showNewShareNotification(share) {
            toast(`🔗 Nouvelle demande de partage de disponibilités`);
        }

        // ═══════════════════════════════════════════════════════════════
        // SEND MESSAGE
        // ═══════════════════════════════════════════════════════════════
        async function sendTeamMessage(receiverId, content) {
            try {
                const { error } = await sb
                    .from('team_messages')
                    .insert({
                        sender_id: currentUserId,
                        receiver_id: receiverId,
                        content: content,
                        content_type: 'text'
                    });
                
                if (error) throw error;
                return true;
            } catch (err) {
                console.error('Error sending message:', err);
                toast('❌ Erreur envoi message');
                return false;
            }
        }

        // ═══════════════════════════════════════════════════════════════
        // INVITE TECHNICIAN (INTERNE)
        // ═══════════════════════════════════════════════════════════════
        async function inviteInterneTechnician(email, firstName, lastName, phone) {
            try {
                const token = crypto.randomUUID();
                
                // Create invitation record
                const { data: invitation, error: invError } = await sb
                    .from('invitations')
                    .insert({
                        inviter_id: currentUserId,
                        email: email,
                        phone: phone,
                        first_name: firstName,
                        last_name: lastName,
                        member_type: 'internal',
                        role: 'technician',
                        token: token,
                        status: 'pending'
                    })
                    .select()
                    .single();
                
                if (invError) throw invError;
                
                // Call Edge Function to send invitation email
                try {
                    const response = await fetch(`${SUPABASE_URL}/functions/v1/send-invite`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                        },
                        body: JSON.stringify({
                            email: email,
                            firstName: firstName,
                            lastName: lastName,
                            phone: phone,
                            inviterId: currentUserId,
                            token: token
                        })
                    });
                    
                    const result = await response.json();
                    
                    if (response.ok) {
                        console.log('✅ Invitation email sent:', result);
                        invitation.emailSent = true;
                    } else {
                        console.warn('⚠️ Email not sent:', result.error);
                        invitation.emailSent = false;
                    }
                } catch (emailErr) {
                    console.warn('⚠️ Edge Function not available:', emailErr.message);
                    invitation.emailSent = false;
                }
                
                return invitation;
                
            } catch (err) {
                console.error('Error inviting technician:', err);
                toast('❌ Erreur: ' + err.message);
                return null;
            }
        }

        // ═══════════════════════════════════════════════════════════════
        // HELPER FUNCTIONS
        // ═══════════════════════════════════════════════════════════════
        function getInitials(firstName, lastName) {
            const f = (firstName || '')[0] || '';
            const l = (lastName || '')[0] || '';
            return (f + l).toUpperCase() || '??';
        }

        function getStatusBadge(status) {
            const badges = {
                'live': 'Actif', 'active': 'Actif',
                'idle': 'Idle', 
                'offline': 'Hors ligne',
                'pending': 'En attente',
                'diagnostic': 'Diagnostic',
                'drafting': 'Rédaction',
                'review': 'À valider',
                'completed': 'Terminé'
            };
            return badges[status] || status;
        }

        function formatTime(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            return date.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
        }

        function getProjectDuration(createdAt) {
            if (!createdAt) return '-';
            const diff = Date.now() - new Date(createdAt).getTime();
            const hours = Math.floor(diff / (1000 * 60 * 60));
            const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            if (hours > 0) return `${hours}h ${minutes}m`;
            return `${minutes}m`;
        }

        // ═══════════════════════════════════════════════════════════════
        // UI UPDATE FUNCTIONS
        // ═══════════════════════════════════════════════════════════════
        function updateTeamUI() {
            // Update home team section
            const homeTeamList = document.querySelector('.home-content .card-list:last-of-type');
            if (homeTeamList && Object.keys(liveTeamData).length > 0) {
                const teamHtml = Object.entries(liveTeamData).slice(0, 3).map(([id, tech]) => {
                    const statusClass = tech.status === 'active' || tech.status === 'live' ? 'live' : 
                                        tech.status === 'idle' ? 'idle' : 'offline';
                    const needsAttention = tech.status === 'idle';
                    const typeTag = tech.memberType === 'external' ? '<span class="tech-tag externe">[EXT]</span>' : '';
                    
                    return `<div class="tech ${needsAttention ? 'needs-attention' : ''}" onclick="openHomeDrawer('tech', '${id}')">
                        <div class="tech-avatar">${tech.initials}<div class="tech-status ${statusClass}"></div></div>
                        <div class="tech-info">
                            <div class="tech-name">${tech.name} ${typeTag}</div>
                            <div class="tech-project">${tech.currentProject}</div>
                        </div>
                        <div class="tech-right"><span class="tech-time">${tech.status === 'idle' ? 'idle' : ''}</span></div>
                    </div>`;
                }).join('');
                homeTeamList.innerHTML = teamHtml;
            }
            
            // Update team count in section header
            const teamHeader = document.querySelector('.home-content .sec-head:last-of-type .sec-action');
            if (teamHeader) {
                const total = Object.keys(liveTeamData).length;
                const active = Object.values(liveTeamData).filter(t => t.status === 'active' || t.status === 'live').length;
                teamHeader.textContent = `${active} / ${total}`;
            }
        }

        function updateProjectsUI() {
            // Update home priority section
            const homeProjList = document.querySelector('.home-content .card-list:first-of-type');
            if (homeProjList && Object.keys(liveProjectData).length > 0) {
                const projHtml = Object.entries(liveProjectData)
                    .filter(([id, p]) => p.status === 'review' || p.status === 'diagnostic')
                    .slice(0, 2)
                    .map(([id, proj]) => {
                        return `<div class="proj" onclick="openHomeDrawer('project', '${id}')">
                            <div class="proj-status-bar ${proj.status}"></div>
                            <div class="proj-icon ${proj.status}"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg></div>
                            <div class="proj-info">
                                <div class="proj-title">${proj.title}</div>
                                <div class="proj-meta">${proj.tech} • ${proj.client}</div>
                            </div>
                            <div class="proj-right">
                                <div class="proj-badge ${proj.status}">${proj.badge}</div>
                                <div class="proj-time">${proj.duration}</div>
                            </div>
                        </div>`;
                    }).join('');
                homeProjList.innerHTML = projHtml || '<div style="text-align:center;color:var(--text-dim);padding:20px;font-size:11px;">Aucun projet prioritaire</div>';
            }
        }

        function updateDashboardStats() {
            const stats = {
                diagnostic: Object.values(liveProjectData).filter(p => p.status === 'diagnostic').length,
                drafting: Object.values(liveProjectData).filter(p => p.status === 'drafting').length,
                review: Object.values(liveProjectData).filter(p => p.status === 'review').length,
                completed: Object.values(liveProjectData).filter(p => p.status === 'completed').length
            };
            
            const statValues = document.querySelectorAll('.home-content .stat-value');
            if (statValues.length >= 4) {
                statValues[0].textContent = stats.diagnostic;
                statValues[1].textContent = stats.drafting;
                statValues[2].textContent = stats.review;
                // Keep scheduled as is for now
            }
            
            // Update hero
            const heroValue = document.querySelector('.hero-value');
            if (heroValue) {
                const completed = stats.completed;
                const target = 12; // Daily target
                heroValue.innerHTML = `${completed}<span>/${target}</span>`;
            }
        }

        // ═══════════════════════════════════════════════════════════════
        // AVAILABILITY SHARE MODAL
        // ═══════════════════════════════════════════════════════════════
        function showAvailabilityShareModal(shareId) {
            const share = livePendingShares.find(s => s.id === shareId);
            if (!share) return;
            
            const tech = share.technician;
            const slots = share.time_slots || [];
            
            const slotsHtml = slots.map(s => `
                <div class="share-slot-item">
                    <span>${s.date}</span>
                    <span>${s.start} - ${s.end}</span>
                </div>
            `).join('');
            
            const modal = document.createElement('div');
            modal.id = 'availabilityShareModal';
            modal.className = 'availability-share-modal';
            modal.innerHTML = `
                <div class="share-modal-content">
                    <div class="share-modal-header">
                        <h3>Demande de partage</h3>
                        <button onclick="closeAvailabilityShareModal()" class="share-modal-close">×</button>
                    </div>
                    <div class="share-modal-body">
                        <div class="share-tech-info">
                            <div class="share-tech-avatar">${getInitials(tech?.first_name, tech?.last_name)}</div>
                            <div>
                                <div class="share-tech-name">${tech?.first_name || ''} ${tech?.last_name || ''}</div>
                                <div class="share-tech-email">${tech?.email || ''}</div>
                            </div>
                        </div>
                        <div class="share-slots-list">
                            <div class="share-slots-title">Créneaux proposés:</div>
                            ${slotsHtml}
                        </div>
                    </div>
                    <div class="share-modal-footer">
                        <button class="drawer-btn secondary" onclick="rejectAvailabilityShare('${shareId}')">Refuser</button>
                        <button class="drawer-btn primary" onclick="acceptAvailabilityShare('${shareId}')">✓ Accepter comme EXTERNE</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function closeAvailabilityShareModal() {
            const modal = document.getElementById('availabilityShareModal');
            if (modal) modal.remove();
        }

        // ═══════════════════════════════════════════════════════════════
        // MAIN INITIALIZATION
        // ═══════════════════════════════════════════════════════════════
        async function loadAllData() {
            await loadTeamMembers();
            await loadProjects();
            await loadPendingShares();
            await setupRealtimeSubscriptions();
            updateDashboardStats();
        }

        async function initManagerApp() {
            console.log('🚀 Initializing FixAIR Admin V16...');

            // Initialize Supabase
            if (!initSupabase()) {
                console.error('Failed to init Supabase');
                return;
            }

            // Initialize auth - this will handle showing login or main app
            await initAuth();

            console.log('✅ Manager App V16 initialized');
        }

        // Run init on DOM ready
        document.addEventListener('DOMContentLoaded', () => {
            initManagerApp();
        });

        // Cleanup on page unload
        window.addEventListener('beforeunload', cleanupSubscriptions);

        // ═══ ORIGINAL DATA (FALLBACK FOR DEMO) ═══
        const techData = {
            't1': { name: 'Jean Dupont', initials: 'JD', status: 'live', badge: 'Actif', currentProject: 'Diagnostic PAC Mitsubishi', client: 'Hôtel Mercure', stats: { projects: 3, completed: 2, avgTime: '32 min', rate: '98%' }, projects: [{ id: 3, title: 'Diagnostic PAC Mitsubishi', client: 'Hôtel Mercure', status: 'diagnostic', badge: 'En cours' }], messages: [{ type: 'received', text: 'Bonjour, j\'ai un souci avec le compresseur', time: '14:23' }, { type: 'sent', text: 'OK je regarde ça. Tu as vérifié les pressions ?', time: '14:25' }] },
            't2': { name: 'Marie Leblanc', initials: 'ML', status: 'live', badge: 'Actif', currentProject: 'Maintenance Daikin VRV', client: 'Carrefour', stats: { projects: 4, completed: 3, avgTime: '28 min', rate: '100%' }, projects: [{ id: 4, title: 'Maintenance Daikin VRV', client: 'Carrefour', status: 'drafting', badge: 'Rédaction' }], messages: [] },
            't5': { name: 'Pierre Bernard', initials: 'PB', status: 'idle', badge: 'Idle', currentProject: 'Rapport Carrier 30XA', client: 'BNP Paribas', stats: { projects: 2, completed: 1, avgTime: '45 min', rate: '88%' }, projects: [{ id: 1, title: 'Rapport Carrier 30XA', client: 'BNP Paribas', status: 'review', badge: 'À valider' }], messages: [{ type: 'sent', text: 'Tu as besoin d\'aide ?', time: '14:10' }] }
        };

        const projectData = {
            1: { title: 'Rapport Carrier 30XA', tech: 'Pierre Bernard', techId: 't5', client: 'BNP Paribas', equipment: 'Carrier 30XA', duration: '2h 05m', status: 'review', badge: 'À valider', progress: { identification: 100, diagnostic: 100, mesures: 100, conclusion: 100 }, report: { client: 'BNP Paribas - Tour Montparnasse', address: '33 Avenue du Maine, 75015 Paris', equipment: 'Carrier 30XA - Groupe froid', problem: 'Bruit anormal compresseur. HP excessive.', actions: 'Nettoyage condenseur, vérification circuit frigorifique, contrôle des pressions.' }},
            2: { title: 'Diagnostic LG Multi V', tech: 'Antoine Girard', techId: 't4', client: 'IKEA', equipment: 'LG Multi V', duration: '45m', status: 'review', badge: 'À valider', progress: { identification: 100, diagnostic: 100, mesures: 100, conclusion: 100 }, report: { client: 'IKEA Paris Nord', address: 'ZAC Paris Nord 2', equipment: 'LG Multi V 5 HP', problem: 'Erreur code 53 - Communication défaillante', actions: 'Reset cartes électroniques, vérification câblage' }},
            3: { title: 'Diagnostic PAC Mitsubishi', tech: 'Jean Dupont', techId: 't1', client: 'Hôtel Mercure', equipment: 'Mitsubishi PUHZ', duration: '45m', status: 'diagnostic', badge: 'Diagnostic', progress: { identification: 100, diagnostic: 65, mesures: 0, conclusion: 0 }, report: { client: 'Hôtel Mercure Paris Centre', address: '20 Rue de la Gaîté, 75014 Paris', equipment: 'Mitsubishi PUHZ-SHW230YKA', problem: 'Analyse en cours - Défaut compresseur suspecté', actions: 'Diagnostic en cours...' }},
            4: { title: 'Maintenance Daikin VRV', tech: 'Marie Leblanc', techId: 't2', client: 'Carrefour', equipment: 'Daikin VRV IV', duration: '1h 12m', status: 'drafting', badge: 'Rédaction', progress: { identification: 100, diagnostic: 100, mesures: 100, conclusion: 68 }, report: { client: 'Carrefour Montreuil', address: '1 Rue de Paris, 93100 Montreuil', equipment: 'Daikin VRV IV RXYQ10T', problem: 'Maintenance préventive annuelle', actions: 'Contrôle pressions, nettoyage filtres, vérification électrique.' }}
        };

        // ElevenLabs config - Exact from technician app
        const ELEVENLABS_API_KEY = 'sk_22d550a1aecd2627750e50b5cf337ef5372bbbbcd35c8b71';

        // State
        let homeCalView = 'day';
        let currentPhotoPanel = null;
        let recordings = {};
        let audioContexts = {};
        let analysers = {};
        let waveformIntervals = {};
        let voiceTimers = {};

        // ═══ TOAST ═══
        function toast(msg) {
            const t = document.getElementById('toast');
            t.textContent = msg;
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 2500);
        }

        // ═══ CALENDAR ═══
        function setHomeCalView(view, btn) {
            homeCalView = view;
            document.querySelectorAll('#homeCalendar .calendar-tab').forEach(t => t.classList.remove('active'));
            if (btn) btn.classList.add('active');
            renderHomeCalendar();
        }

        function navHomeCal(dir) { renderHomeCalendar(); }

        function renderHomeCalendar() {
            const container = document.getElementById('homeCalContent');
            const title = document.getElementById('homeCalTitle');

            if (homeCalView === 'day') {
                title.textContent = 'Lundi 30 Décembre';
                container.innerHTML = buildDayView('home');
            } else if (homeCalView === 'week') {
                title.textContent = 'Semaine 1';
                container.innerHTML = buildWeekView('home');
            } else {
                title.textContent = 'Décembre 2024';
                container.innerHTML = buildMonthView('home');
            }
        }

        function buildDayView(context) {
            // Full day 6:00 - 20:00
            const hours = ['06:00','07:00','08:00','09:00','10:00','11:00','12:00','13:00','14:00','15:00','16:00','17:00','18:00','19:00','20:00'];
            const events = {
                '09:00': { id: 3, title: 'Diagnostic PAC Mitsubishi', meta: 'Jean Dupont • Hôtel Mercure', status: 'diagnostic' },
                '11:00': { id: 4, title: 'Maintenance Daikin VRV', meta: 'Marie Leblanc • Carrefour', status: 'drafting' },
                '14:00': { id: 1, title: 'Rapport Carrier 30XA', meta: 'Pierre Bernard • BNP Paribas', status: 'review' },
                '16:00': { id: 2, title: 'Diagnostic LG Multi V', meta: 'Antoine Girard • IKEA', status: 'diagnostic' }
            };

            return `<div class="calendar-daily">${hours.map(h => {
                const ev = events[h];
                return `<div class="daily-slot">
                    <div class="daily-time">${h}</div>
                    <div class="daily-content ${ev ? 'has-event ' + ev.status : ''}" ${ev ? `onclick="openProjectFromCal(${ev.id}, '${context}')"` : ''}>
                        ${ev ? `<div class="daily-event-title">${ev.title}</div><div class="daily-event-meta">${ev.meta}</div>` : ''}
                    </div>
                </div>`;
            }).join('')}</div>`;
        }

        function buildWeekView(context) {
            // All days equal width, scroll to see Saturday/Sunday
            const days = [
                { num: 30, day: 'Lun', today: true },
                { num: 31, day: 'Mar' },
                { num: 1, day: 'Mer' },
                { num: 2, day: 'Jeu' },
                { num: 3, day: 'Ven' },
                { num: 4, day: 'Sam' },
                { num: 5, day: 'Dim' }
            ];

            const events = {
                '30-AM': [{ id: 3, title: 'PAC Mitsu.', status: 'diagnostic' }, { id: 4, title: 'Daikin VRV', status: 'drafting' }],
                '30-PM': [{ id: 1, title: 'Carrier 30XA', status: 'review' }, { id: 2, title: 'LG Multi V', status: 'diagnostic' }],
                '31-AM': [{ id: 5, title: 'Trane CGB', status: 'diagnostic' }],
                '1-AM': [{ id: 6, title: 'York YK', status: 'drafting' }],
                '2-PM': [{ id: 7, title: 'Samsung DVM', status: 'diagnostic' }],
                '3-AM': [{ id: 8, title: 'McQuay', status: 'review' }]
            };

            const wrapperClass = context === 'drawer' ? 'calendar-week-wrapper drawer-week-wrapper' : 'calendar-week-wrapper';
            const weekClass = context === 'drawer' ? 'calendar-week drawer-week' : 'calendar-week';

            return `<div class="${wrapperClass}"><div class="${weekClass}">
                <div></div>
                ${days.map(d => `<div class="week-header-cell ${d.today ? 'today' : ''}" onclick="goToDayView(${d.num}, '${context}')"><div class="day-num">${d.num}</div><div>${d.day}</div></div>`).join('')}
                <div class="week-time-label">AM</div>
                ${days.map(d => {
                    const dayEvents = events[d.num + '-AM'] || [];
                    return `<div class="week-slot">${dayEvents.map(e => `<div class="week-slot-event ${e.status}" onclick="openProjectFromCal(${e.id}, '${context}')">${e.title}</div>`).join('')}</div>`;
                }).join('')}
                <div class="week-time-label">PM</div>
                ${days.map(d => {
                    const dayEvents = events[d.num + '-PM'] || [];
                    return `<div class="week-slot">${dayEvents.map(e => `<div class="week-slot-event ${e.status}" onclick="openProjectFromCal(${e.id}, '${context}')">${e.title}</div>`).join('')}</div>`;
                }).join('')}
            </div></div>`;
        }

        function buildMonthView(context) {
            const daysWithEvents = [2, 4, 6, 9, 10, 12, 16, 18, 20, 23, 27, 30];
            return `<div class="calendar-grid">
                <div class="calendar-day-header">Lun</div><div class="calendar-day-header">Mar</div><div class="calendar-day-header">Mer</div><div class="calendar-day-header">Jeu</div><div class="calendar-day-header">Ven</div><div class="calendar-day-header">Sam</div><div class="calendar-day-header">Dim</div>
                ${[25,26,27,28,29,30].map(d => `<div class="calendar-day other-month">${d}</div>`).join('')}
                ${Array.from({length: 31}, (_, i) => i + 1).map(d => `<div class="calendar-day ${d === 30 ? 'today' : ''} ${daysWithEvents.includes(d) ? 'has-events' : ''}" onclick="goToDayView(${d}, '${context}')">${d}</div>`).join('')}
            </div>`;
        }

        function goToDayView(dayNum, context) {
            if (context === 'home') {
                homeCalView = 'day';
                document.querySelectorAll('#homeCalendar .calendar-tab').forEach(t => t.classList.remove('active'));
                document.querySelector('#homeCalendar .calendar-tab').classList.add('active');
                document.getElementById('homeCalTitle').textContent = dayNum + ' Décembre';
                document.getElementById('homeCalContent').innerHTML = buildDayView('home');
            }
        }

        function openProjectFromCal(id, context) {
            if (context === 'home') {
                openHomeDrawer('project', id);
            } else {
                selectProject(id);
            }
        }

        // ═══ NAVIGATION ═══
        function openHomeDrawer(type, id) {
            document.getElementById('homeWrapper').classList.add('drawer-open');
            if (type === 'project') {
                // Use live data if available, otherwise fall back to mock
                const data = liveProjectData[id] || projectData[id]; if (!data) return;
                document.getElementById('homeDrawerTitle').textContent = data.title;
                document.getElementById('homeDrawerSubtitle').textContent = `${data.tech} • ${data.client}`;
                const badge = document.getElementById('homeDrawerBadge');
                badge.className = 'drawer-badge ' + data.status; badge.textContent = data.badge;
                const tech = liveTeamData[data.techId] || techData[data.techId] || { initials: '??', name: data.tech, badge: 'Offline', messages: [] };
                document.getElementById('homeDrawerBody').innerHTML = buildProjectContent(data, tech, 'homeProject');
                document.getElementById('homeDrawerFooter').innerHTML = '<button class="drawer-btn primary"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>Valider</button>';
                setTimeout(() => initChatHandlers('homeProject'), 100);
            } else if (type === 'tech') {
                // Use live data if available, otherwise fall back to mock
                const data = liveTeamData[id] || techData[id]; if (!data) return;
                document.getElementById('homeDrawerTitle').textContent = data.name;
                document.getElementById('homeDrawerSubtitle').textContent = data.currentProject;
                const badge = document.getElementById('homeDrawerBadge');
                badge.className = 'drawer-badge ' + data.status; badge.textContent = data.badge;
                // Add EXTERNE indicator
                if (data.memberType === 'external') {
                    document.getElementById('homeDrawerTitle').innerHTML = data.name + ' <span class="tech-tag externe">[EXTERNE]</span>';
                }
                document.getElementById('homeDrawerBody').innerHTML = buildTechContent(data, 'homeTech', true);
                document.getElementById('homeDrawerFooter').innerHTML = '';
                setTimeout(() => initChatHandlers('homeTech'), 100);
            } else if (type === 'share') {
                // New: Open availability share modal
                showAvailabilityShareModal(id);
            }
        }

        function closeHomeDrawer() { 
            document.getElementById('homeWrapper').classList.remove('drawer-open'); 
            closeHomeNestedDrawer();
        }

        function openHomeNestedProject(id) {
            const data = projectData[id]; if (!data) return;
            document.getElementById('homeNestedDrawer').classList.add('active');
            document.getElementById('homeNestedTitle').textContent = data.title;
            document.getElementById('homeNestedSubtitle').textContent = `${data.tech} • ${data.client}`;
            const badge = document.getElementById('homeNestedBadge');
            badge.className = 'drawer-badge ' + data.status; badge.textContent = data.badge;
            const tech = techData[data.techId] || { initials: '??', name: data.tech, badge: 'Offline', messages: [] };
            document.getElementById('homeNestedBody').innerHTML = buildProjectContent(data, tech, 'homeNested');
            document.getElementById('homeNestedFooter').innerHTML = '<button class="drawer-btn primary"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>Valider</button>';
            setTimeout(() => initChatHandlers('homeNested'), 100);
        }

        function closeHomeNestedDrawer() {
            document.getElementById('homeNestedDrawer').classList.remove('active');
        }

        function openPage(page) {
            closeHomeDrawer();
            document.getElementById('homeWrapper').style.display = 'none';
            const map = { 'projects': 'pageProjects', 'team': 'pageTeam', 'stats': 'pageStats' };
            if (map[page]) document.getElementById(map[page]).classList.add('active');
        }

        function closePage() {
            document.querySelectorAll('.full-page').forEach(p => p.classList.remove('active', 'drawer-open'));
            document.querySelectorAll('.nested-drawer').forEach(d => d.classList.remove('active'));
            document.getElementById('homeWrapper').style.display = '';
        }

        function goHome() { closePage(); }

        function openPageDrawer(page, type) {
            const pageEl = document.getElementById('page' + page.charAt(0).toUpperCase() + page.slice(1));
            pageEl.classList.add('drawer-open');
            if (page === 'projects') {
                if (type === 'calendar') {
                    document.getElementById('projectDrawerTitle').textContent = 'Planning';
                    document.getElementById('projectDrawerSubtitle').textContent = 'Vue calendrier';
                    document.getElementById('projectDrawerBadge').style.display = 'none';
                    document.getElementById('projectDrawerBody').innerHTML = buildCalendarDrawerContent();
                    document.getElementById('projectDrawerFooter').innerHTML = '';
                } else if (type === 'create') {
                    document.getElementById('projectDrawerTitle').textContent = 'Nouveau Projet';
                    document.getElementById('projectDrawerSubtitle').textContent = 'Créer et assigner';
                    document.getElementById('projectDrawerBadge').style.display = 'none';
                    document.getElementById('projectDrawerBody').innerHTML = buildCreateProjectContent();
                    document.getElementById('projectDrawerFooter').innerHTML = '<button class="drawer-btn secondary" onclick="closePageDrawer(\'projects\')">Annuler</button><button class="drawer-btn orange">Créer</button>';
                }
            } else if (page === 'team' && type === 'addTech') {
                document.getElementById('techDrawerTitle').textContent = 'Nouveau Technicien';
                document.getElementById('techDrawerSubtitle').textContent = 'Inviter un membre';
                document.getElementById('techDrawerBadge').style.display = 'none';
                document.getElementById('techDrawerBody').innerHTML = buildAddTechContent();
            }
        }

        function closePageDrawer(page) {
            document.getElementById('page' + page.charAt(0).toUpperCase() + page.slice(1)).classList.remove('drawer-open');
        }

        function selectProject(id) {
            const data = liveProjectData[id] || projectData[id]; if (!data) return;
            document.getElementById('pageProjects').classList.add('drawer-open');
            document.getElementById('projectDrawerTitle').textContent = data.title;
            document.getElementById('projectDrawerSubtitle').textContent = `${data.tech} • ${data.client}`;
            const badge = document.getElementById('projectDrawerBadge');
            badge.style.display = ''; badge.className = 'drawer-badge ' + data.status; badge.textContent = data.badge;
            const tech = liveTeamData[data.techId] || techData[data.techId] || { initials: '??', name: data.tech, badge: 'Offline', messages: [] };
            document.getElementById('projectDrawerBody').innerHTML = buildProjectContent(data, tech, 'pageProject');
            document.getElementById('projectDrawerFooter').innerHTML = '<button class="drawer-btn primary"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>Valider</button>';
            setTimeout(() => initChatHandlers('pageProject'), 100);
        }

        function selectTech(id) {
            closeNestedDrawer();
            const data = liveTeamData[id] || techData[id]; if (!data) return;
            document.getElementById('pageTeam').classList.add('drawer-open');
            document.getElementById('techDrawerTitle').textContent = data.name;
            // Add EXTERNE indicator
            if (data.memberType === 'external') {
                document.getElementById('techDrawerTitle').innerHTML = data.name + ' <span class="tech-tag externe">[EXTERNE]</span>';
            }
            document.getElementById('techDrawerSubtitle').textContent = data.currentProject;
            const badge = document.getElementById('techDrawerBadge');
            badge.style.display = ''; badge.className = 'drawer-badge ' + data.status; badge.textContent = data.badge;
            document.getElementById('techDrawerBody').innerHTML = buildTechContent(data, 'pageTech', true);
            setTimeout(() => initChatHandlers('pageTech'), 100);
        }

        function openNestedProject(id) {
            const data = projectData[id]; if (!data) return;
            document.getElementById('nestedProjectDrawer').classList.add('active');
            document.getElementById('nestedProjectTitle').textContent = data.title;
            document.getElementById('nestedProjectSubtitle').textContent = `${data.tech} • ${data.client}`;
            const badge = document.getElementById('nestedProjectBadge');
            badge.className = 'drawer-badge ' + data.status; badge.textContent = data.badge;
            const tech = techData[data.techId] || { initials: '??', name: data.tech, badge: 'Offline', messages: [] };
            document.getElementById('nestedProjectBody').innerHTML = buildProjectContent(data, tech, 'nestedProject');
            document.getElementById('nestedProjectFooter').innerHTML = '<button class="drawer-btn primary"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>Valider</button>';
            setTimeout(() => initChatHandlers('nestedProject'), 100);
        }

        function closeNestedDrawer() {
            document.getElementById('nestedProjectDrawer').classList.remove('active');
        }

        // ═══ CONTENT BUILDERS ═══
        function buildProjectContent(data, tech, prefix) {
            let msgs = tech.messages.length ? tech.messages.map(m => `<div class="msg ${m.type === 'sent' ? 'user' : 'ai'}"><div class="msg-bubble">${m.text}</div><div class="msg-time">${m.time}</div></div>`).join('') : '<div style="text-align:center;color:var(--text-dim);padding:20px;font-size:11px;">Aucun message</div>';
            
            // Report preview matching the screenshot exactly
            const statusBadge = data.status === 'review' ? 'À valider' : data.status === 'drafting' ? 'Rédaction' : 'Diagnostic';
            const badgeClass = data.status === 'review' ? 'assistant' : data.status === 'drafting' ? 'assistant' : 'copilot';
            const reportPreview = `
            <div class="report-preview-card">
                <div class="report-preview-outer-title">Aperçu du rapport</div>
                <div class="report-preview-inner">
                    <div class="report-preview-header">
                        <span class="report-preview-title">Rapport ${data.equipment}</span>
                        <span class="report-preview-badge" style="background:var(--${badgeClass}-bg);color:var(--${badgeClass});border-color:var(--${badgeClass}-border);">${statusBadge}</span>
                    </div>
                    <div class="r-field"><div class="r-label">Client</div><div class="r-value">${data.report.client}</div></div>
                    <div class="r-field"><div class="r-label">Adresse</div><div class="r-value">${data.report.address}</div></div>
                    <div class="r-field"><div class="r-label">Équipement</div><div class="r-value">${data.report.equipment}</div></div>
                    <div class="r-field"><div class="r-label">Problème</div><div class="r-value">${data.report.problem}</div></div>
                    <div class="r-field"><div class="r-label">Actions</div><div class="r-value">${data.report.actions}</div></div>
                </div>
            </div>`;

            return `
            <div class="info-card"><div class="info-card-title">Informations</div><div class="info-row"><span class="info-label">Technicien</span><span class="info-value">${data.tech}</span></div><div class="info-row"><span class="info-label">Client</span><span class="info-value">${data.client}</span></div><div class="info-row"><span class="info-label">Équipement</span><span class="info-value">${data.equipment}</span></div><div class="info-row"><span class="info-label">Durée</span><span class="info-value orange">${data.duration}</span></div></div>
            <div class="info-card"><div class="info-card-title">Progression du rapport</div><div class="report-sections"><div class="report-section"><span class="report-section-name">Identification</span><div class="report-section-bar"><div class="report-section-fill" style="width:${data.progress.identification}%"></div></div><span class="report-section-percent">${data.progress.identification}%</span></div><div class="report-section"><span class="report-section-name">Diagnostic</span><div class="report-section-bar"><div class="report-section-fill" style="width:${data.progress.diagnostic}%"></div></div><span class="report-section-percent">${data.progress.diagnostic}%</span></div><div class="report-section"><span class="report-section-name">Mesures</span><div class="report-section-bar"><div class="report-section-fill" style="width:${data.progress.mesures}%"></div></div><span class="report-section-percent">${data.progress.mesures}%</span></div><div class="report-section"><span class="report-section-name">Conclusion</span><div class="report-section-bar"><div class="report-section-fill" style="width:${data.progress.conclusion}%"></div></div><span class="report-section-percent">${data.progress.conclusion}%</span></div></div></div>
            ${reportPreview}
            <div class="chat-card"><div class="chat-card-header"><div class="chat-card-avatar">${tech.initials}</div><div class="chat-card-info"><div class="chat-card-name">${tech.name}</div><div class="chat-card-status">${tech.badge||'Offline'}</div></div></div><div class="chat-card-messages" id="${prefix}Messages">${msgs}</div>${buildChatInput(prefix)}</div>`;
        }

        function buildTechContent(data, prefix, showProjectClick = false) {
            let sc = data.status==='live'?'green':data.status==='idle'?'yellow':data.status==='pending'?'purple':'';
            const clickFn = showProjectClick ? (prefix === 'homeTech' ? 'openHomeNestedProject' : 'openNestedProject') : '';
            let prj = data.projects.length ? data.projects.map(p => `<div class="mini-project" onclick="${clickFn}(${p.id})"><div class="mini-project-bar ${p.status}"></div><div class="mini-project-info"><div class="mini-project-title">${p.title}</div><div class="mini-project-meta">${p.client}</div></div><span class="mini-project-badge ${p.status}">${p.badge}</span></div>`).join('') : '<div style="font-size:11px;color:var(--text-dim);text-align:center;padding:20px;">Aucun projet</div>';
            let msgs = data.messages.length ? data.messages.map(m => `<div class="msg ${m.type === 'sent' ? 'user' : 'ai'}"><div class="msg-bubble">${m.text}</div><div class="msg-time">${m.time}</div></div>`).join('') : '<div style="text-align:center;color:var(--text-dim);padding:20px;font-size:11px;">Aucun message</div>';
            
            return `
            <div class="info-card"><div class="info-card-title">Informations</div><div class="info-row"><span class="info-label">Statut</span><span class="info-value ${sc}">${data.badge}</span></div><div class="info-row"><span class="info-label">Projet actuel</span><span class="info-value">${data.currentProject}</span></div><div class="info-row"><span class="info-label">Client</span><span class="info-value">${data.client}</span></div></div>
            <div class="info-card"><div class="info-card-title">Statistiques (semaine)</div><div class="info-row"><span class="info-label">Projets</span><span class="info-value">${data.stats.projects}</span></div><div class="info-row"><span class="info-label">Complétés</span><span class="info-value green">${data.stats.completed}</span></div><div class="info-row"><span class="info-label">Temps moy.</span><span class="info-value">${data.stats.avgTime}</span></div><div class="info-row"><span class="info-label">Taux succès</span><span class="info-value green">${data.stats.rate}</span></div></div>
            <div class="info-card"><div class="info-card-title">Projets du technicien</div>${prj}</div>
            <div class="info-card"><div class="info-card-title">Disponibilité</div>${buildSmallAvailability(prefix)}</div>
            <div class="chat-card"><div class="chat-card-header"><div class="chat-card-avatar">${data.initials}</div><div class="chat-card-info"><div class="chat-card-name">${data.name}</div><div class="chat-card-status">${data.badge}</div></div></div><div class="chat-card-messages" id="${prefix}Messages">${msgs}</div>${buildChatInput(prefix)}</div>`;
        }

        function buildSmallAvailability(techId) {
            return `<div class="avail-card">
                <div class="avail-tabs">
                    <button class="avail-tab active" onclick="setAvailView('${techId}', 'day', this)">Jour</button>
                    <button class="avail-tab" onclick="setAvailView('${techId}', 'week', this)">Semaine</button>
                    <button class="avail-tab" onclick="setAvailView('${techId}', 'month', this)">Mois</button>
                </div>
                <div class="avail-content" id="availContent${techId}">
                    ${buildAvailDay()}
                </div>
            </div>`;
        }

        function setAvailView(techId, view, btn) {
            const container = document.getElementById('availContent' + techId);
            if (!container) return;
            
            // Update tabs
            const tabs = btn.parentElement.querySelectorAll('.avail-tab');
            tabs.forEach(t => t.classList.remove('active'));
            btn.classList.add('active');
            
            // Update content
            if (view === 'day') {
                container.innerHTML = buildAvailDay();
            } else if (view === 'week') {
                container.innerHTML = buildAvailWeek();
            } else {
                container.innerHTML = buildAvailMonth();
            }
        }

        function buildAvailDay() {
            const hours = ['08:00','09:00','10:00','11:00','12:00','13:00','14:00','15:00','16:00','17:00'];
            const busy = ['09:00','10:00','14:00','15:00'];
            return `<div class="avail-daily">${hours.map(h => {
                const isBusy = busy.includes(h);
                return `<div class="avail-slot">
                    <div class="avail-time">${h}</div>
                    <div class="avail-block ${isBusy ? 'busy' : 'available'}">${isBusy ? 'Intervention' : 'Disponible'}</div>
                </div>`;
            }).join('')}</div>`;
        }

        function buildAvailWeek() {
            const days = ['L','M','M','J','V','S','D'];
            return `<div class="avail-week">
                <div></div>${days.map(d => `<div class="avail-week-header">${d}</div>`).join('')}
                <div class="avail-week-time">AM</div>
                ${days.map((d,i) => `<div class="avail-week-slot ${i<5 && Math.random()>0.5 ? 'available' : i<5 ? 'busy' : ''}"></div>`).join('')}
                <div class="avail-week-time">PM</div>
                ${days.map((d,i) => `<div class="avail-week-slot ${i<5 && Math.random()>0.4 ? 'available' : i<5 ? 'busy' : ''}"></div>`).join('')}
            </div>`;
        }

        function buildAvailMonth() {
            const availDays = [2, 3, 6, 7, 8, 9, 10, 13, 14, 15, 16, 17, 20, 21, 22, 23, 24, 27, 28, 29, 30, 31];
            const busyDays = [4, 5, 11, 12, 18, 19, 25, 26];
            return `<div class="avail-month">
                <div class="avail-month-header">L</div><div class="avail-month-header">M</div><div class="avail-month-header">M</div><div class="avail-month-header">J</div><div class="avail-month-header">V</div><div class="avail-month-header">S</div><div class="avail-month-header">D</div>
                ${[30,31].map(d => `<div class="avail-month-day other">${d}</div>`).join('')}
                ${Array.from({length: 31}, (_, i) => i + 1).map(d => {
                    const cls = availDays.includes(d) ? 'available' : busyDays.includes(d) ? 'busy' : '';
                    return `<div class="avail-month-day ${cls}">${d}</div>`;
                }).join('')}
            </div>`;
        }

        function buildCalendarDrawerContent() {
            return `<div class="calendar-card drawer-calendar" style="margin:0;border:none;background:transparent;display:flex;flex-direction:column;height:100%;">
                <div class="calendar-header" style="padding-left:0;flex-shrink:0;"><span class="calendar-month">Semaine 1</span><div class="calendar-nav"><button class="calendar-nav-btn"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 18l-6-6 6-6"/></svg></button><button class="calendar-nav-btn"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 18l6-6-6-6"/></svg></button></div></div>
                <div class="calendar-tabs" style="padding-left:0;flex-shrink:0;">
                    <button class="calendar-tab" onclick="setDrawerCalView('day', this)">Jour</button>
                    <button class="calendar-tab active" onclick="setDrawerCalView('week', this)">Semaine</button>
                    <button class="calendar-tab" onclick="setDrawerCalView('month', this)">Mois</button>
                </div>
                <div id="drawerCalContent" style="flex:1;overflow:auto;">${buildWeekView('drawer')}</div>
            </div>`;
        }

        let drawerCalView = 'week';
        function setDrawerCalView(view, btn) {
            drawerCalView = view;
            document.querySelectorAll('#projectDrawerBody .calendar-tab').forEach(t => t.classList.remove('active'));
            if (btn) btn.classList.add('active');
            const container = document.getElementById('drawerCalContent');
            if (view === 'day') container.innerHTML = buildDayView('drawer');
            else if (view === 'week') container.innerHTML = buildWeekView('drawer');
            else container.innerHTML = buildMonthView('drawer');
        }

        function buildCreateProjectContent() {
            return `<div class="form-field"><label class="form-label">Date du projet</label><input type="date" class="form-input" id="createProjectDate" onchange="onProjectDateChange()"></div>
            <div class="form-field"><label class="form-label">Client</label><input type="text" class="form-input" placeholder="Nom du client"></div>
            <div class="form-field"><label class="form-label">Adresse</label><input type="text" class="form-input" placeholder="Adresse d'intervention"></div>
            <div class="form-field"><label class="form-label">Équipement</label><select class="form-input form-select"><option value="">Sélectionner</option><option>Carrier 30XA</option><option>Daikin VRV IV</option><option>Mitsubishi PUHZ</option><option>LG Multi V</option></select></div>
            <div class="form-field"><label class="form-label">Description</label><textarea class="form-input form-textarea" placeholder="Détails..."></textarea></div>
            <div class="form-field"><label class="form-label">Assigner à</label><div class="tech-selector" id="techSelectorCreate">${Object.entries(techData).filter(([k,v])=>v.status!=='pending').map(([k,v])=>`<div class="tech-option" data-tech-id="${k}" onclick="selectTechForProject('${k}', this)"><div class="tech-option-avatar">${v.initials}</div><div class="tech-option-info"><div class="tech-option-name">${v.name}</div><div class="tech-option-avail">Disponible</div></div></div>`).join('')}</div></div>
            <div id="selectedTechAvailability" style="display:none;margin-top:12px;"></div>`;
        }

        function selectTechForProject(techId, element) {
            // Toggle selection
            const wasSelected = element.classList.contains('selected');
            document.querySelectorAll('#techSelectorCreate .tech-option').forEach(el => el.classList.remove('selected'));
            
            const availContainer = document.getElementById('selectedTechAvailability');
            
            if (wasSelected) {
                // Deselect - hide availability
                availContainer.style.display = 'none';
                availContainer.innerHTML = '';
            } else {
                // Select - show availability calendar
                element.classList.add('selected');
                const tech = techData[techId];
                availContainer.style.display = 'block';
                availContainer.innerHTML = `
                    <div class="info-card" style="margin-bottom:0;">
                        <div class="info-card-title">Disponibilité de ${tech.name}</div>
                        ${buildSmallAvailability(techId + '_create')}
                    </div>`;
            }
        }

        function onProjectDateChange() {
            const dateInput = document.getElementById('createProjectDate');
            const techSelector = document.getElementById('techSelectorCreate');
            const availContainer = document.getElementById('selectedTechAvailability');
            
            if (dateInput.value) {
                // Date selected - filter technicians available on this date (demo: all available)
                document.querySelectorAll('#techSelectorCreate .tech-option').forEach(el => {
                    // In real app, check availability for selected date
                    el.style.display = 'flex';
                });
                // Hide availability calendar when date is selected (user knows the date)
                availContainer.style.display = 'none';
            } else {
                // No date - show all technicians
                document.querySelectorAll('#techSelectorCreate .tech-option').forEach(el => {
                    el.style.display = 'flex';
                });
            }
        }

        function buildAddTechContent() {
            return `
                <div class="form-field"><label class="form-label">Prénom</label><input type="text" class="form-input" id="inviteFirstName" placeholder="Prénom"></div>
                <div class="form-field"><label class="form-label">Nom</label><input type="text" class="form-input" id="inviteLastName" placeholder="Nom"></div>
                <div class="form-field"><label class="form-label">Email</label><input type="email" class="form-input" id="inviteEmail" placeholder="email@exemple.com"></div>
                <div class="form-field"><label class="form-label">Téléphone</label><input type="tel" class="form-input" id="invitePhone" placeholder="+33 6 00 00 00 00"></div>
                <div class="info-card" style="background:var(--assistant-bg);border-color:var(--assistant-border);">
                    <div style="font-size:11px;color:var(--assistant);"><strong>📧 Invitation automatique</strong><br>Le technicien recevra un email d'invitation.</div>
                </div>
                <div class="drawer-footer" style="border:none;padding:16px 0 0 0;">
                    <button class="drawer-btn secondary" onclick="closePageDrawer('team')">Annuler</button>
                    <button class="drawer-btn orange" onclick="handleInviteClick()">Inviter</button>
                </div>
            `;
        }
        
        async function handleInviteClick() {
            const email = document.getElementById('inviteEmail')?.value?.trim();
            const firstName = document.getElementById('inviteFirstName')?.value?.trim();
            const lastName = document.getElementById('inviteLastName')?.value?.trim();
            const phone = document.getElementById('invitePhone')?.value?.trim();
            
            if (!email) {
                toast('❌ Email requis');
                return;
            }
            
            // Disable button to prevent double-click
            event.target.disabled = true;
            event.target.textContent = 'Envoi...';
            
            const result = await inviteInterneTechnician(email, firstName, lastName, phone);
            
            if (result) {
                // Show success modal with invitation link
                showInvitationSuccessModal(result, email);
            } else {
                event.target.disabled = false;
                event.target.textContent = 'Inviter';
            }
        }
        
        function showInvitationSuccessModal(invitation, email) {
            const inviteLink = `${window.location.origin}/invite?token=${invitation.token}`;
            const emailSent = invitation.emailSent;
            
            // Create modal HTML
            const modalHTML = `
                <div id="inviteSuccessModal" style="position:fixed;inset:0;background:rgba(0,0,0,0.8);z-index:9999;display:flex;align-items:center;justify-content:center;padding:20px;">
                    <div style="background:var(--bg-secondary);border-radius:16px;padding:24px;max-width:400px;width:100%;border:1px solid var(--border);">
                        <div style="text-align:center;margin-bottom:20px;">
                            <div style="font-size:48px;margin-bottom:12px;">${emailSent ? '📧' : '✅'}</div>
                            <h3 style="color:var(--text);margin-bottom:8px;">${emailSent ? 'Invitation envoyée!' : 'Invitation créée!'}</h3>
                            <p style="color:var(--text-dim);font-size:13px;">
                                ${emailSent 
                                    ? `Un email d'invitation a été envoyé à <strong>${email}</strong>` 
                                    : `Une invitation a été créée pour <strong>${email}</strong>`
                                }
                            </p>
                        </div>
                        
                        ${emailSent ? `
                            <div style="background:var(--assistant-bg);border:1px solid var(--assistant-border);border-radius:8px;padding:12px;margin-bottom:16px;">
                                <div style="font-size:12px;color:var(--assistant);">
                                    ✅ Email envoyé automatiquement!<br>
                                    <span style="font-size:11px;opacity:0.8;">Le technicien recevra un lien de connexion.</span>
                                </div>
                            </div>
                        ` : ''}
                        
                        <div style="background:var(--card);border:1px solid var(--border);border-radius:8px;padding:12px;margin-bottom:16px;">
                            <label style="font-size:11px;color:var(--text-dim);display:block;margin-bottom:6px;">Lien d'invitation (backup)</label>
                            <input type="text" id="inviteLinkInput" value="${inviteLink}" readonly style="width:100%;background:var(--bg);border:1px solid var(--border);border-radius:6px;padding:10px;color:var(--text);font-size:12px;">
                        </div>
                        
                        <div style="display:flex;gap:10px;">
                            <button onclick="copyInviteLink()" style="flex:1;background:var(--assistant);color:white;border:none;border-radius:8px;padding:12px;font-weight:600;cursor:pointer;">📋 Copier le lien</button>
                        </div>
                        
                        <div style="margin-top:12px;">
                            <button onclick="closeInviteSuccessModal()" style="width:100%;background:transparent;color:var(--text-dim);border:1px solid var(--border);border-radius:8px;padding:10px;cursor:pointer;">Fermer</button>
                        </div>
                        
                        ${!emailSent ? `
                            <p style="text-align:center;margin-top:16px;font-size:11px;color:var(--text-dim);">
                                💡 Envoyez ce lien au technicien par email ou SMS.
                            </p>
                        ` : ''}
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            closePageDrawer('team');
        }
        
        function copyInviteLink() {
            const input = document.getElementById('inviteLinkInput');
            input.select();
            document.execCommand('copy');
            toast('✅ Lien copié!');
        }
        
        function closeInviteSuccessModal() {
            document.getElementById('inviteSuccessModal')?.remove();
        }

        function buildChatInput(prefix) {
            return `<div class="chat-input-wrap">
                <div class="attach-menu" id="${prefix}AttachMenu">
                    <div class="attach-opt" onclick="attachAction('camera','${prefix}')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><use href="#icon-camera"/></svg>Photo / Scan</div>
                    <div class="attach-opt" onclick="attachAction('file','${prefix}')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><use href="#icon-paperclip"/></svg>Importer</div>
                </div>
                <div class="input-row" id="${prefix}InputRow">
                    <button class="plus-btn" onclick="toggleAttach('${prefix}')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><use href="#icon-plus"/></svg></button>
                    <div class="input-area">
                        <textarea class="input-text" id="${prefix}Input" placeholder="Message..." rows="1" oninput="handleChatInput('${prefix}')" onkeydown="handleKeydown(event,'${prefix}')"></textarea>
                        <div class="voice-waveform" id="${prefix}Waveform">
                            <div class="wave-bars" id="${prefix}Bars"></div>
                            <div class="voice-timer" id="${prefix}Timer">0:00</div>
                        </div>
                    </div>
                    <button class="action-btn" id="${prefix}ActionBtn" onclick="handleAction('${prefix}')">
                        <div class="icon-wrap">
                            <span class="btn-icon mic-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/></svg></span>
                            <span class="btn-icon send-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="19" x2="12" y2="5"/><polyline points="5 12 12 5 19 12"/></svg></span>
                            <span class="btn-icon stop-icon"><svg viewBox="0 0 24 24" fill="currentColor"><rect x="6" y="6" width="12" height="12" rx="2"/></svg></span>
                        </div>
                    </button>
                    <div class="transcription-sphere" id="${prefix}TranscriptionSphere">
                        <div class="sphere-fog-wrap"><div class="sphere-fog-transcribe"></div><div class="sphere-fog-transcribe-2"></div></div>
                        <div class="sphere-highlight"></div>
                    </div>
                </div>
            </div>`;
        }

        // ═══ CHAT HANDLERS - Exact from technician app ═══
        function initChatHandlers(prefix) {
            const input = document.getElementById(prefix + 'Input');
            if (input) {
                input.style.height = 'auto';
                input.style.height = Math.min(input.scrollHeight, 100) + 'px';
            }
        }

        function handleChatInput(prefix) {
            const input = document.getElementById(prefix + 'Input');
            const btn = document.getElementById(prefix + 'ActionBtn');
            if (!input || !btn) return;
            
            const hasText = input.value.trim().length > 0;
            if (hasText) {
                btn.classList.add('has-text');
                btn.classList.remove('recording');
            } else {
                btn.classList.remove('has-text');
            }
            
            input.style.height = 'auto';
            input.style.height = Math.min(input.scrollHeight, 100) + 'px';
        }

        function handleKeydown(event, prefix) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                const input = document.getElementById(prefix + 'Input');
                if (input.value.trim()) sendMessage(prefix);
            }
        }

        function handleAction(prefix) {
            const input = document.getElementById(prefix + 'Input');
            const btn = document.getElementById(prefix + 'ActionBtn');
            if (!input || !btn) return;

            if (btn.classList.contains('recording')) {
                stopRecording(prefix);
            } else if (input.value.trim()) {
                sendMessage(prefix);
                btn.classList.remove('has-text');
            } else {
                startRecording(prefix);
            }
        }

        function sendMessage(prefix) {
            const input = document.getElementById(prefix + 'Input');
            const container = document.getElementById(prefix + 'Messages');
            if (!input || !container || !input.value.trim()) return;

            const now = new Date();
            const time = now.getHours().toString().padStart(2, '0') + ':' + now.getMinutes().toString().padStart(2, '0');
            
            const emptyMsg = container.querySelector('div[style*="text-align:center"]');
            if (emptyMsg) emptyMsg.remove();

            container.innerHTML += `<div class="msg user"><div class="msg-bubble">${input.value}</div><div class="msg-time">${time}</div></div>`;
            container.scrollTop = container.scrollHeight;

            input.value = '';
            input.style.height = 'auto';
            handleChatInput(prefix);
        }

        // ═══ ATTACHMENT - Exact from technician app ═══
        function toggleAttach(prefix) {
            closeAllAttach();
            const menu = document.getElementById(prefix + 'AttachMenu');
            if (menu) menu.classList.toggle('show');
        }

        function closeAllAttach() {
            document.querySelectorAll('.attach-menu').forEach(m => m.classList.remove('show'));
        }

        function attachAction(type, prefix) {
            closeAllAttach();
            currentPhotoPanel = prefix;
            console.log('📸 attachAction:', type, 'prefix:', prefix);
            
            if (type === 'camera') {
                document.getElementById('cameraInput').click();
            } else if (type === 'file') {
                document.getElementById('fileInput').click();
            }
        }

        function handleFileSelect(event, source) {
            const file = event.target.files[0];
            console.log('📸 handleFileSelect:', source, 'file:', file?.name, 'prefix:', currentPhotoPanel);
            
            if (!file) return;
            
            if (file.type.startsWith('image/')) {
                if (file.size > 10 * 1024 * 1024) {
                    toast('Image trop volumineuse (max 10MB)');
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    addPhotoToChat(currentPhotoPanel, e.target.result);
                };
                reader.onerror = function(e) {
                    toast('Erreur lecture fichier');
                };
                reader.readAsDataURL(file);
            } else {
                toast('Fichier: ' + file.name);
            }
            
            event.target.value = '';
        }

        function addPhotoToChat(prefix, imageData) {
            const container = document.getElementById(prefix + 'Messages');
            if (!container) {
                toast('Erreur: chat non trouvé');
                return;
            }

            const msgId = 'photo-' + Date.now();
            const emptyMsg = container.querySelector('div[style*="text-align:center"]');
            if (emptyMsg) emptyMsg.remove();

            const msgDiv = document.createElement('div');
            msgDiv.className = 'msg user';
            msgDiv.id = msgId;
            msgDiv.dataset.imageData = imageData;
            
            msgDiv.innerHTML = `
                <div class="msg-bubble" style="padding:8px;">
                    <div class="photo-container">
                        <img src="${imageData}" class="msg-image" onclick="openImageViewer(this.src)">
                        <button class="photo-delete" onclick="deletePhotoMsg('${msgId}')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><use href="#icon-x"/></svg></button>
                    </div>
                    <div class="photo-actions-inline">
                        <button class="photo-action-btn" onclick="extractFromPhoto('${msgId}')">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><use href="#icon-search"/></svg>
                            Extraire
                        </button>
                        <button class="photo-action-btn" onclick="addToReport('${msgId}')">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><use href="#icon-clipboard"/></svg>
                            Rapport
                        </button>
                    </div>
                </div>
                <div class="msg-time">${new Date().toLocaleTimeString('fr-FR', {hour:'2-digit',minute:'2-digit'})}</div>`;
            
            container.appendChild(msgDiv);
            container.scrollTop = container.scrollHeight;
            toast('Photo ajoutée');
        }

        function deletePhotoMsg(msgId) {
            const msg = document.getElementById(msgId);
            if (msg) {
                msg.remove();
                toast('Photo supprimée');
            }
        }

        function extractFromPhoto(msgId) {
            toast('Extraction en cours...');
            setTimeout(() => toast('Texte extrait avec succès'), 1500);
        }

        function addToReport(msgId) {
            const btn = document.querySelector(`#${msgId} .photo-action-btn:last-child`);
            if (btn) {
                btn.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><use href="#icon-check"/></svg> Ajouté';
                btn.classList.add('success');
                btn.disabled = true;
            }
            toast('Photo ajoutée au rapport');
        }

        function openImageViewer(src) {
            const viewer = document.getElementById('imageViewer');
            const img = document.getElementById('imageViewerImg');
            img.src = src;
            viewer.classList.add('active');
        }

        function closeImageViewer() {
            document.getElementById('imageViewer').classList.remove('active');
        }

        // ═══ VOICE RECORDING - Exact from technician app ═══
        async function startRecording(prefix) {
            const inputRow = document.getElementById(prefix + 'InputRow');
            const btn = document.getElementById(prefix + 'ActionBtn');
            const barsContainer = document.getElementById(prefix + 'Bars');
            const input = document.getElementById(prefix + 'Input');

            if (barsContainer) barsContainer.innerHTML = '';
            input.value = '';
            input.placeholder = '🎤 En écoute...';

            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const source = audioContext.createMediaStreamSource(stream);
                const analyser = audioContext.createAnalyser();
                analyser.fftSize = 256;
                analyser.smoothingTimeConstant = 0.4;
                source.connect(analyser);
                
                audioContexts[prefix] = audioContext;
                analysers[prefix] = analyser;
                
                const mediaRecorder = new MediaRecorder(stream, { mimeType: 'audio/webm' });
                const audioChunks = [];
                
                mediaRecorder.ondataavailable = (event) => {
                    if (event.data.size > 0) audioChunks.push(event.data);
                };
                
                mediaRecorder.onstop = async () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                    await transcribeWithElevenLabs(prefix, audioBlob);
                };
                
                mediaRecorder.start();
                recordings[prefix] = { stream, startTime: Date.now(), mediaRecorder };
                
            } catch (err) {
                console.log('Mic access denied, using simulation');
                recordings[prefix] = { startTime: Date.now(), simulated: true };
            }
            
            inputRow.classList.add('recording');
            btn.classList.add('recording');
            btn.classList.remove('has-text');
            
            waveformIntervals[prefix] = setInterval(() => updateWaveform(prefix), 80);
            voiceTimers[prefix] = setInterval(() => updateVoiceTimer(prefix), 100);
        }

        function updateWaveform(prefix) {
            const barsContainer = document.getElementById(prefix + 'Bars');
            if (!barsContainer) return;

            let height = 4;
            if (analysers[prefix]) {
                const dataArray = new Uint8Array(analysers[prefix].frequencyBinCount);
                analysers[prefix].getByteFrequencyData(dataArray);
                const avg = dataArray.reduce((a, b) => a + b, 0) / dataArray.length;
                height = Math.max(4, (avg / 180) * 28);
            } else {
                height = 4 + Math.random() * 20;
            }

            const bar = document.createElement('div');
            bar.className = 'wave-bar';
            bar.style.height = height + 'px';
            barsContainer.appendChild(bar);

            const maxBars = Math.floor(barsContainer.offsetWidth / 5);
            while (barsContainer.children.length > maxBars) {
                barsContainer.removeChild(barsContainer.firstChild);
            }
        }

        function updateVoiceTimer(prefix) {
            const timerEl = document.getElementById(prefix + 'Timer');
            const recording = recordings[prefix];
            if (!recording || !timerEl) return;
            
            const elapsed = (Date.now() - recording.startTime) / 1000;
            const minutes = Math.floor(elapsed / 60);
            const seconds = Math.floor(elapsed % 60);
            timerEl.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
        }

        function stopRecording(prefix) {
            const inputRow = document.getElementById(prefix + 'InputRow');
            const btn = document.getElementById(prefix + 'ActionBtn');
            const barsContainer = document.getElementById(prefix + 'Bars');
            const input = document.getElementById(prefix + 'Input');
            const sphere = document.getElementById(prefix + 'TranscriptionSphere');

            const isSimulated = recordings[prefix]?.simulated;
            const hasRealRecording = recordings[prefix]?.mediaRecorder;

            if (hasRealRecording) {
                btn.style.display = 'none';
                sphere.classList.add('active');
            }

            if (recordings[prefix]?.mediaRecorder && recordings[prefix].mediaRecorder.state === 'recording') {
                recordings[prefix].mediaRecorder.stop();
            }

            if (recordings[prefix]?.stream) {
                recordings[prefix].stream.getTracks().forEach(track => track.stop());
            }
            if (audioContexts[prefix]) {
                audioContexts[prefix].close();
            }
            if (waveformIntervals[prefix]) {
                clearInterval(waveformIntervals[prefix]);
            }
            if (voiceTimers[prefix]) {
                clearInterval(voiceTimers[prefix]);
            }

            if (barsContainer) barsContainer.innerHTML = '';
            inputRow.classList.remove('recording');
            btn.classList.remove('recording');

            if (isSimulated) {
                btn.style.display = 'none';
                sphere.classList.add('active');
                
                setTimeout(() => {
                    sphere.classList.remove('active');
                    btn.style.display = 'flex';
                    
                    const transcriptions = [
                        "Le compresseur fait un bruit anormal",
                        "Erreur E6 sur l'unité extérieure",
                        "La pression HP est trop élevée"
                    ];
                    input.value = transcriptions[Math.floor(Math.random() * transcriptions.length)];
                    input.placeholder = 'Message...';
                    handleChatInput(prefix);
                    toast('🎤 Transcription terminée');
                }, 1500);
            }

            delete recordings[prefix];
            delete audioContexts[prefix];
            delete analysers[prefix];

            const timerEl = document.getElementById(prefix + 'Timer');
            if (timerEl) timerEl.textContent = '0:00';
        }

        async function transcribeWithElevenLabs(prefix, audioBlob) {
            const input = document.getElementById(prefix + 'Input');
            const btn = document.getElementById(prefix + 'ActionBtn');
            const sphere = document.getElementById(prefix + 'TranscriptionSphere');

            btn.style.display = 'none';
            sphere.classList.add('active');
            input.placeholder = '';

            try {
                const formData = new FormData();
                formData.append('file', audioBlob, 'recording.webm');
                formData.append('model_id', 'scribe_v1');
                formData.append('language_code', 'fra');

                const response = await fetch('https://api.elevenlabs.io/v1/speech-to-text', {
                    method: 'POST',
                    headers: { 'xi-api-key': ELEVENLABS_API_KEY },
                    body: formData
                });

                if (!response.ok) throw new Error('API error');

                const result = await response.json();
                const transcription = result.text || '';

                sphere.classList.remove('active');
                btn.style.display = 'flex';

                if (transcription.trim()) {
                    input.value = transcription.trim();
                    input.placeholder = 'Message...';
                    handleChatInput(prefix);
                    toast('🎤 Transcription terminée');
                } else {
                    input.placeholder = 'Message...';
                    toast('❌ Aucune parole détectée');
                }

            } catch (error) {
                console.error('ElevenLabs error:', error);
                sphere.classList.remove('active');
                btn.style.display = 'flex';
                input.placeholder = 'Message...';

                const transcriptions = ["Erreur de connexion", "Le compresseur ne démarre pas"];
                input.value = transcriptions[Math.floor(Math.random() * transcriptions.length)];
                handleChatInput(prefix);
                toast('❌ Erreur transcription (simulation)');
            }
        }

        // Close menus on click outside
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.plus-btn') && !e.target.closest('.attach-menu')) {
                closeAllAttach();
            }
        });

        // Initialize
        renderHomeCalendar();
    </script>
</body>
</html>

