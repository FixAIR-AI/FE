<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <link rel="icon" type="image/svg+xml" href="../favicon.svg">
    <title>FixAIR Master</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --copilot: #a78bfa;
            --copilot-glow: rgba(167, 139, 250, 0.4);
            --copilot-bg: rgba(167, 139, 250, 0.08);
            --copilot-border: rgba(167, 139, 250, 0.2);
            --assistant: #22c55e;
            --assistant-glow: rgba(34, 197, 94, 0.4);
            --assistant-bg: rgba(34, 197, 94, 0.08);
            --assistant-border: rgba(34, 197, 94, 0.2);
            --review: #3B82F6;
            --review-bg: rgba(59, 130, 246, 0.08);
            --review-border: rgba(59, 130, 246, 0.2);
            --warning: #eab308;
            --warning-bg: rgba(234, 179, 8, 0.08);
            --warning-border: rgba(234, 179, 8, 0.2);
            --bg: #0D1117;
            --bg-secondary: #161b22;
            --card: rgba(255, 255, 255, 0.03);
            --border: rgba(255, 255, 255, 0.06);
            --text: rgba(255, 255, 255, 0.9);
            --text-dim: rgba(255, 255, 255, 0.35);
            --grid-color: rgba(255,255,255,0.015);
            --content-width: 520px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg);
            background-image:
                linear-gradient(var(--grid-color) 1px, transparent 1px),
                linear-gradient(90deg, var(--grid-color) 1px, transparent 1px);
            background-size: 32px 32px;
            color: var(--text);
            min-height: 100vh;
            min-height: 100dvh;
            overflow-x: hidden;
        }

        /* ═══ SVG DEFS ═══ */
        .svg-defs { position: absolute; width: 0; height: 0; overflow: hidden; }

        /* ═══ AUTH SCREENS ═══ */
        .screen { position: fixed; top: 0; left: 0; right: 0; bottom: 0; display: none; flex-direction: column; background: var(--bg); background-image: linear-gradient(var(--grid-color) 1px, transparent 1px), linear-gradient(90deg, var(--grid-color) 1px, transparent 1px); background-size: 32px 32px; z-index: 9000; }
        .screen.active { display: flex; }
        .main-app { height: 100%; display: none; }
        .main-app.active { display: flex; flex-direction: column; }

        /* LOGIN SCREEN */
        .login-screen { justify-content: center; align-items: center; padding: 24px; }
        .login-container { width: 100%; max-width: 380px; display: flex; flex-direction: column; align-items: center; }
        .scan-line { position: fixed; top: 0; left: 0; width: 100%; height: 2px; background: linear-gradient(90deg, transparent, var(--copilot), transparent); box-shadow: 0 0 20px var(--copilot-glow); animation: scanDown 2s ease-out forwards; }
        @keyframes scanDown { to { top: 50%; opacity: 0; } }
        .login-title { font-size: 22px; font-weight: 300; margin-bottom: 4px; color: rgba(255,255,255,0.9); }
        .login-sub { font-size: 12px; color: var(--text-dim); margin-bottom: 32px; }
        .login-logo { width: 160px; height: auto; margin-bottom: 24px; color: var(--copilot); }
        .login-logo svg { width: 100%; height: auto; }
        .login-bar { display: flex; align-items: center; gap: 8px; padding: 5px 5px 5px 8px; background: var(--card); border: 1px solid var(--border); border-radius: 40px; width: 100%; opacity: 0; animation: fadeUp 0.5s ease 1.5s forwards; }
        @keyframes fadeUp { to { opacity: 1; } }
        @keyframes spin { to { transform: rotate(360deg); } }
        .login-mini { width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; position: relative; }
        .glass-sphere { width: 26px; height: 26px; border-radius: 50%; position: relative; overflow: hidden; animation: glowPulse 8s ease-in-out infinite; }
        @keyframes glowPulse {
            0%, 100% { box-shadow: 0 0 14px rgba(167,139,250,0.7), 0 0 28px rgba(167,139,250,0.3); }
            25% { box-shadow: 0 0 14px rgba(239,68,68,0.7), 0 0 28px rgba(239,68,68,0.3); }
            50% { box-shadow: 0 0 14px rgba(59,130,246,0.7), 0 0 28px rgba(59,130,246,0.3); }
            75% { box-shadow: 0 0 14px rgba(234,179,8,0.7), 0 0 28px rgba(234,179,8,0.3); }
        }
        .glass-sphere::before { content: ''; position: absolute; top: 2px; left: 4px; width: 5px; height: 4px; border-radius: 50%; background: radial-gradient(circle, rgba(255,255,255,0.5), transparent 70%); z-index: 10; }
        .sphere-fog-container { position: absolute; inset: 0; border-radius: 50%; overflow: hidden; background: rgba(20,24,32,0.3); }
        .sphere-fog { position: absolute; inset: -50%; border-radius: 50%; background: radial-gradient(circle at 30% 40%, currentColor, transparent 50%), radial-gradient(circle at 70% 60%, currentColor, transparent 40%); filter: blur(2px); animation: fogSwirl 6s ease-in-out infinite, fogColor 8s ease-in-out infinite; opacity: 0.9; }
        @keyframes fogSwirl { 0% { transform: rotate(0deg) translate(0, 0); } 25% { transform: rotate(90deg) translate(2px, -2px); } 50% { transform: rotate(180deg) translate(0, 0); } 75% { transform: rotate(270deg) translate(-2px, 2px); } 100% { transform: rotate(360deg) translate(0, 0); } }
        @keyframes fogColor { 0%, 100% { color: #a78bfa; } 25% { color: #ef4444; } 50% { color: #3B82F6; } 75% { color: #eab308; } }
        .sphere-fog-2 { position: absolute; inset: -30%; border-radius: 50%; background: radial-gradient(circle at 60% 30%, currentColor, transparent 45%); filter: blur(2px); animation: fogSwirl2 5s ease-in-out infinite reverse, fogColor2 8s ease-in-out infinite; opacity: 0.7; }
        @keyframes fogSwirl2 { 0% { transform: rotate(0deg) scale(0.9); } 50% { transform: rotate(180deg) scale(1.1); } 100% { transform: rotate(360deg) scale(0.9); } }
        @keyframes fogColor2 { 0%, 100% { color: #3B82F6; } 25% { color: #eab308; } 50% { color: #a78bfa; } 75% { color: #ef4444; } }
        .login-icon-slot { width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; position: relative; flex-shrink: 0; }
        .login-back { width: 32px; height: 32px; border-radius: 50%; background: rgba(255,255,255,0.05); border: none; color: var(--text-dim); cursor: pointer; display: none; align-items: center; justify-content: center; flex-shrink: 0; transition: all 0.2s; }
        .login-back:hover { background: rgba(255,255,255,0.1); color: var(--text); }
        .login-back svg { width: 16px; height: 16px; stroke: currentColor; fill: none; }
        .login-input-container { flex: 1; position: relative; height: 32px; overflow: hidden; }
        .login-input-slider { display: flex; transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1); height: 100%; }
        .login-input-slide { min-width: 100%; display: flex; align-items: center; }
        .login-input { flex: 1; padding: 8px; background: transparent; border: none; color: white; font-size: 13px; outline: none; caret-color: white; }
        .login-input::placeholder { color: rgba(255,255,255,0.25); }
        .login-input:-webkit-autofill,
        .login-input:-webkit-autofill:hover,
        .login-input:-webkit-autofill:focus,
        .login-input:-webkit-autofill:active {
            -webkit-box-shadow: 0 0 0 1000px transparent inset !important;
            -webkit-text-fill-color: white !important;
            background-color: transparent !important;
            background: transparent !important;
            transition: background-color 9999s ease-out 9999s !important;
            caret-color: white !important;
        }
        .icon { display: inline-flex; align-items: center; justify-content: center; }
        .login-btn { width: 32px; height: 32px; border-radius: 50%; background: linear-gradient(135deg, #a78bfa, #8b5cf6); border: none; color: white; cursor: pointer; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
        .login-btn .icon { width: 12px; height: 12px; }
        .login-btn .icon svg { width: 100%; height: 100%; }
        .login-btn:disabled { opacity: 0.5; cursor: not-allowed; }

        /* LOGIN STATUS MESSAGES */
        .login-status {
            min-height: 24px;
            margin-top: 16px;
            text-align: center;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        .login-status:empty { display: none; }
        .login-status.success { color: #22c55e; }
        .login-status.error { color: #ef4444; }
        .login-status.info { color: rgba(255,255,255,0.7); }
        .login-status a {
            color: inherit;
            text-decoration: underline;
            cursor: pointer;
            margin-left: 8px;
        }
        .login-status a:hover { opacity: 0.8; }

        /* ACCESS DENIED SCREEN */
        .pending-screen { display: none; }
        .pending-screen.active { display: flex; }
        .pending-container { display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 24px; padding: 40px; text-align: center; }
        .pending-logo { margin-bottom: 8px; }
        .pending-logo svg { height: 40px; width: auto; }
        .pending-title { font-size: 24px; font-weight: 700; color: var(--text); }
        .pending-subtitle { font-size: 14px; color: var(--text-dim); max-width: 300px; line-height: 1.5; }
        .pending-email { font-size: 13px; color: var(--copilot); font-weight: 500; padding: 8px 16px; background: rgba(167,139,250,0.1); border-radius: 8px; }
        .pending-logout { margin-top: 16px; padding: 10px 24px; background: transparent; border: 1px solid var(--border); border-radius: 8px; color: var(--text-dim); font-size: 13px; cursor: pointer; transition: all 0.2s; }
        .pending-logout:hover { background: rgba(255,255,255,0.05); color: var(--text); }

        /* TOAST */
        .toast { position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%) translateY(100px); background: rgba(30,35,44,0.98); border: 1px solid var(--border); padding: 12px 20px; border-radius: 12px; font-size: 13px; z-index: 9999; opacity: 0; transition: all 0.3s; pointer-events: none; }
        .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }

        /* ═══ MAIN APP STYLES ═══ */

        .app-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 20px;
            padding-top: max(16px, env(safe-area-inset-top));
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
        }
        .app-header-left { display: flex; align-items: center; gap: 12px; }
        .app-header-logo { color: var(--copilot); height: 32px; }
        .app-header-logo svg { height: 100%; width: auto; }
        .app-header-title { font-size: 16px; font-weight: 600; }
        .app-header-badge { font-size: 10px; padding: 3px 8px; border-radius: 4px; background: var(--copilot-bg); color: var(--copilot); font-weight: 600; margin-left: 8px; }
        .app-header-right { display: flex; align-items: center; gap: 12px; }
        .user-menu { display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 6px 12px; border-radius: 8px; transition: background 0.2s; }
        .user-menu:hover { background: var(--card); }
        .user-avatar { width: 32px; height: 32px; border-radius: 50%; background: var(--copilot-bg); border: 1px solid var(--copilot-border); display: flex; align-items: center; justify-content: center; color: var(--copilot); font-weight: 600; font-size: 13px; }
        .user-name { font-size: 13px; color: var(--text); }
        .logout-btn { padding: 8px 16px; border-radius: 8px; border: 1px solid var(--border); background: transparent; color: var(--text-dim); font-size: 13px; cursor: pointer; transition: all 0.2s; }
        .logout-btn:hover { background: rgba(255,255,255,0.05); color: var(--text); }

        .app-content {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
        }
        .app-content-inner {
            max-width: 1200px;
            margin: 0 auto;
        }

        /* Placeholder content */
        .placeholder-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 400px;
            text-align: center;
            color: var(--text-dim);
        }
        .placeholder-icon { font-size: 64px; margin-bottom: 24px; opacity: 0.5; }
        .placeholder-title { font-size: 24px; font-weight: 600; color: var(--text); margin-bottom: 8px; }
        .placeholder-subtitle { font-size: 14px; max-width: 400px; }

        /* ═══ RESPONSIVE - LARGER SCREENS ═══ */
        @media (min-width: 420px) {
            .login-btn { width: 38px; height: 38px; }
            .login-btn .icon { width: 14px; height: 14px; }
        }
    </style>
</head>
<body>
    <!-- SVG DEFINITIONS -->
    <svg class="svg-defs" xmlns="http://www.w3.org/2000/svg">
        <defs>
            <symbol id="icon-fixair-logo" viewBox="0 0 235 48"><path d="M35.1986 6.4H17.4706C15.4226 6.4 13.5666 6.912 11.9026 7.936C10.2386 8.96 8.89463 10.3253 7.87063 12.032C6.88929 13.696 6.39863 15.552 6.39863 17.6V48H-0.00137472V16C-0.00137472 13.7387 0.467959 11.648 1.40663 9.728C2.34529 7.76533 3.62529 6.08 5.24663 4.672C6.91063 3.22133 8.78796 2.09067 10.8786 1.28C12.9693 0.426664 15.1666 -3.8147e-06 17.4706 -3.8147e-06H35.1986V6.4ZM48.8306 4.8C48.8306 6.12266 48.3613 7.25333 47.4226 8.192C46.484 9.13066 45.3533 9.6 44.0306 9.6C42.708 9.6 41.5773 9.13066 40.6386 8.192C39.7 7.25333 39.2306 6.12266 39.2306 4.8C39.2306 3.47733 39.7 2.34666 40.6386 1.408C41.5773 0.46933 42.708 -3.8147e-06 44.0306 -3.8147e-06C45.3533 -3.8147e-06 46.484 0.46933 47.4226 1.408C48.3613 2.34666 48.8306 3.47733 48.8306 4.8ZM47.2306 48H40.8306V22.4H9.59863V16H47.2306V48ZM97.7161 48H88.5641L74.8681 34.752L61.4281 48H52.2761L70.4521 30.464L52.2761 12.8H61.4281L97.7161 48ZM97.7161 12.8L82.4841 27.648L77.8761 23.552L88.5641 12.8H97.7161Z" fill="currentColor"/><path d="M154.461 48H148.061V35.2H112.285V28.8H148.061V9.6H125.085C122.183 9.6 119.517 10.3253 117.085 11.776C114.653 13.184 112.711 15.104 111.261 17.536C109.853 19.968 109.149 22.656 109.149 25.6V48H102.749V25.6C102.749 22.528 103.325 19.648 104.477 16.96C105.629 14.2293 107.229 11.84 109.277 9.792C111.325 7.70133 113.693 6.08 116.381 4.928C119.111 3.776 122.013 3.2 125.085 3.2H154.461V48ZM171.604 48H165.204V3.2H171.604V48ZM234.041 48H225.401L211.961 35.2H192.313V28.864H218.041C219.833 28.864 221.454 28.4373 222.905 27.584C224.356 26.688 225.508 25.5147 226.361 24.064C227.214 22.5707 227.641 20.9493 227.641 19.2C227.641 17.408 227.214 15.7867 226.361 14.336C225.508 12.8853 224.356 11.7333 222.905 10.88C221.454 10.0267 219.833 9.6 218.041 9.6H188.729V48H182.329V3.2H218.041C220.985 3.2 223.673 3.92533 226.105 5.376C228.537 6.784 230.457 8.704 231.865 11.136C233.316 13.568 234.041 16.256 234.041 19.2C234.041 21.8453 233.444 24.2987 232.249 26.56C231.097 28.8213 229.497 30.6987 227.449 32.192C225.444 33.6427 223.161 34.5813 220.601 35.008L234.041 48Z" fill="currentColor"/></symbol>
            <symbol id="icon-arrow-left" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 12H5M12 19l-7-7 7-7"/></symbol>
            <symbol id="icon-arrow-right" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 12h14M12 5l7 7-7 7"/></symbol>
            <symbol id="icon-shield" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></symbol>
        </defs>
    </svg>

    <!-- LOGIN SCREEN -->
    <div class="screen login-screen active" id="loginScreen">
        <div class="scan-line"></div>
        <div class="login-container">
            <div class="login-logo"><svg viewBox="0 0 235 48"><use href="#icon-fixair-logo"/></svg></div>
            <h1 class="login-title">FixAIR Master</h1>
            <p class="login-sub">Administration centrale - Acces restreint</p>
            <div class="login-bar">
                <div class="login-icon-slot">
                    <div class="login-mini" id="loginSphere"><div class="glass-sphere"><div class="sphere-fog-container"><div class="sphere-fog"></div><div class="sphere-fog-2"></div></div></div></div>
                    <button type="button" class="login-back" id="loginBack" onclick="prevLoginStep()"><svg viewBox="0 0 24 24"><use href="#icon-arrow-left"/></svg></button>
                </div>
                <div class="login-input-container">
                    <div class="login-input-slider" id="loginSlider">
                        <div class="login-input-slide">
                            <input type="email" class="login-input" id="loginEmailInput" placeholder="Adresse email autorisee" onkeypress="if(event.key==='Enter')nextLoginStep()">
                        </div>
                        <div class="login-input-slide">
                            <input type="password" class="login-input" id="loginPasswordInput" placeholder="Mot de passe" onkeypress="if(event.key==='Enter')nextLoginStep()">
                        </div>
                    </div>
                </div>
                <button type="button" class="login-btn" id="loginBtn" onclick="nextLoginStep()"><span class="icon"><svg><use href="#icon-arrow-right"/></svg></span></button>
            </div>
            <div class="login-status" id="loginStatus"></div>
        </div>
    </div>

    <!-- ACCESS DENIED SCREEN -->
    <div class="screen pending-screen" id="accessDeniedScreen">
        <div class="scan-line"></div>
        <div class="pending-container">
            <div class="pending-logo">
                <svg viewBox="0 0 235 48" style="height: 40px; color: var(--copilot);"><use href="#icon-fixair-logo"/></svg>
            </div>
            <div style="font-size: 48px; margin: 16px 0;">&#128274;</div>
            <h1 class="pending-title">Acces non autorise</h1>
            <p class="pending-subtitle">
                Cette zone est reservee aux administrateurs Master de FixAIR. Votre email n'est pas dans la liste des utilisateurs autorises.
            </p>
            <div class="pending-email" id="accessDeniedEmail"></div>
            <button class="pending-logout" onclick="logout()">
                Se deconnecter
            </button>
        </div>
    </div>

    <!-- TOAST -->
    <div class="toast" id="toast"></div>

    <!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>FixAIR Master</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --master: #8B5CF6;
            --master-bg: rgba(139, 92, 246, 0.08);
            --master-border: rgba(139, 92, 246, 0.2);
            --copilot: #FF6B35;
            --copilot-glow: rgba(255, 107, 53, 0.4);
            --copilot-bg: rgba(255, 107, 53, 0.08);
            --copilot-border: rgba(255, 107, 53, 0.2);
            --assistant: #22c55e;
            --assistant-glow: rgba(34, 197, 94, 0.4);
            --assistant-bg: rgba(34, 197, 94, 0.08);
            --assistant-border: rgba(34, 197, 94, 0.2);
            --hotline: #ef4444;
            --review: #3B82F6;
            --review-bg: rgba(59, 130, 246, 0.08);
            --warning: #eab308;
            --warning-bg: rgba(234, 179, 8, 0.08);
            --warning-border: rgba(234, 179, 8, 0.2);
            --danger: #ef4444;
            --danger-bg: rgba(239, 68, 68, 0.08);
            --danger-border: rgba(239, 68, 68, 0.2);
            --bg: #0D1117;
            --bg-secondary: #161b22;
            --card: rgba(255, 255, 255, 0.03);
            --border: rgba(255, 255, 255, 0.06);
            --text: rgba(255, 255, 255, 0.9);
            --text-dim: rgba(255, 255, 255, 0.35);
            --grid-color: rgba(255,255,255,0.015);
            --content-width: 600px;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; scrollbar-width: thin; scrollbar-color: rgba(255,255,255,0.15) transparent; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.15); border-radius: 3px; }
        body { font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif; background: var(--bg); background-image: linear-gradient(var(--grid-color) 1px, transparent 1px), linear-gradient(90deg, var(--grid-color) 1px, transparent 1px); background-size: 32px 32px; color: var(--text); min-height: 100vh; min-height: 100dvh; overflow-x: hidden; }

        /* ═══ HOME LAYOUT ═══ */
        .home-wrapper { display: flex; min-height: 100vh; min-height: 100dvh; }
        .home-main { flex: 1; display: flex; flex-direction: column; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); min-width: 0; }
        .home-wrapper.drawer-open .home-main { flex: 0 0 50%; max-width: 50%; }
        .home-content { flex: 1; overflow-y: auto; padding: 16px; padding-bottom: calc(80px + env(safe-area-inset-bottom)); background: var(--bg); background-image: linear-gradient(var(--grid-color) 1px, transparent 1px), linear-gradient(90deg, var(--grid-color) 1px, transparent 1px); background-size: 32px 32px; }
        .home-content-inner { max-width: var(--content-width); margin: 0 auto; }

        /* ═══ HEADER ═══ */
        .master-header { display: flex; align-items: center; justify-content: space-between; padding: 16px; padding-top: max(16px, env(safe-area-inset-top)); background: linear-gradient(180deg, rgba(13,17,23,0.98), transparent); position: sticky; top: 0; z-index: 50; }
        .master-logo { display: flex; align-items: center; gap: 8px; }
        .master-logo svg { height: 28px; color: var(--master); }
        .master-user { display: flex; align-items: center; gap: 10px; }
        .master-avatar { width: 36px; height: 36px; border-radius: 50%; background: var(--master-bg); border: 2px solid var(--master); display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 600; color: var(--master); }
        .connection-status { display: flex; align-items: center; gap: 6px; font-size: 10px; color: var(--text-dim); padding: 4px 10px; background: var(--card); border: 1px solid var(--border); border-radius: 20px; }
        .connection-dot { width: 6px; height: 6px; border-radius: 50%; background: var(--danger); }
        .connection-dot.connected { background: var(--assistant); }
        .connection-dot.loading { background: var(--warning); animation: pulse 1s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }

        /* ═══ BOTTOM NAV ═══ */
        .home-nav { position: fixed; bottom: 0; left: 0; right: 0; display: flex; justify-content: center; padding: 8px 16px; padding-bottom: max(8px, env(safe-area-inset-bottom)); z-index: 100; }
        .home-wrapper.drawer-open .home-nav { right: 50%; }
        .nav-pill { display: flex; justify-content: space-around; align-items: center; background: rgba(30, 35, 44, 0.98); backdrop-filter: blur(20px); border: 1px solid var(--border); border-radius: 14px; padding: 6px 16px; width: 100%; max-width: 580px; }
        .nav-item { display: flex; flex-direction: column; align-items: center; gap: 2px; padding: 8px 16px; color: rgba(255, 255, 255, 0.3); cursor: pointer; transition: color 0.2s; }
        .nav-item:hover { color: rgba(255, 255, 255, 0.5); }
        .nav-item.active { color: var(--master); }
        .nav-icon { width: 20px; height: 20px; }
        .nav-label { font-size: 10px; font-weight: 500; }

        /* ═══ DRAWERS ═══ */
        .home-drawer { position: fixed; top: 0; right: 0; width: 50%; height: 100%; background: var(--bg-secondary); border-left: 1px solid var(--border); display: flex; flex-direction: column; transform: translateX(100%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); z-index: 150; }
        .home-wrapper.drawer-open .home-drawer { transform: translateX(0); }
        @media (max-width: 900px) { .home-wrapper.drawer-open .home-main { flex: 0 0 100%; max-width: 100%; opacity: 0.3; pointer-events: none; } .home-wrapper.drawer-open .home-nav { right: 0; opacity: 0.3; pointer-events: none; } .home-drawer { width: 100%; } }
        .drawer-header { display: flex; align-items: center; gap: 12px; padding: 16px; padding-top: max(16px, env(safe-area-inset-top)); border-bottom: 1px solid var(--border); flex-shrink: 0; }
        .drawer-close { width: 32px; height: 32px; border-radius: 50%; background: var(--card); border: 1px solid var(--border); display: flex; align-items: center; justify-content: center; cursor: pointer; color: var(--text-dim); transition: all 0.2s; }
        .drawer-close:hover { background: rgba(255,255,255,0.05); color: var(--text); }
        .drawer-close svg { width: 16px; height: 16px; }
        .drawer-title-wrap { flex: 1; }
        .drawer-title { font-size: 14px; font-weight: 600; }
        .drawer-subtitle { font-size: 11px; color: var(--text-dim); margin-top: 2px; }
        .drawer-badge { font-size: 10px; padding: 4px 10px; border-radius: 6px; font-weight: 500; }
        .drawer-badge.master { background: var(--master-bg); color: var(--master); border: 1px solid var(--master-border); }
        .drawer-badge.pending { background: var(--warning-bg); color: var(--warning); border: 1px solid var(--warning-border); }
        .drawer-badge.approved { background: var(--assistant-bg); color: var(--assistant); border: 1px solid var(--assistant-border); }
        .drawer-badge.rejected { background: var(--danger-bg); color: var(--danger); border: 1px solid var(--danger-border); }
        .drawer-badge.suspended { background: rgba(107, 114, 128, 0.1); color: #6b7280; border: 1px solid rgba(107, 114, 128, 0.2); }
        .drawer-badge.free { background: rgba(156, 163, 175, 0.1); color: #9ca3af; border: 1px solid rgba(156, 163, 175, 0.2); }
        
        /* Role badges for drawer */
        .drawer-badge.role-technician, .drawer-badge.role-tech { background: rgba(59, 130, 246, 0.15); color: #60a5fa; border: 1px solid rgba(59, 130, 246, 0.3); }
        .drawer-badge.role-admin { background: rgba(139, 92, 246, 0.15); color: #a78bfa; border: 1px solid rgba(139, 92, 246, 0.3); }
        .drawer-badge.role-manager { background: rgba(236, 72, 153, 0.15); color: #f472b6; border: 1px solid rgba(236, 72, 153, 0.3); }
        .drawer-body { flex: 1; overflow-y: auto; padding: 16px; }
        .drawer-footer { display: flex; gap: 10px; padding: 16px; border-top: 1px solid var(--border); flex-shrink: 0; }
        .drawer-btn { flex: 1; padding: 12px; border-radius: 10px; font-size: 12px; font-weight: 600; cursor: pointer; transition: all 0.2s; border: none; display: flex; align-items: center; justify-content: center; gap: 6px; }
        .drawer-btn.primary { background: var(--master); color: white; }
        .drawer-btn.secondary { background: var(--card); color: var(--text); border: 1px solid var(--border); }
        .drawer-btn.success { background: var(--assistant); color: white; }
        .drawer-btn.danger { background: rgba(239, 68, 68, 0.15); color: #ef4444; border: 1px solid rgba(239, 68, 68, 0.3); }
        .drawer-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .drawer-btn svg { width: 14px; height: 14px; }

        /* ═══ CARDS ═══ */
        .stats-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 20px; }
        .stat-card { background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 14px; }
        .stat-card.highlight { border-color: var(--master-border); background: var(--master-bg); }
        .stat-label { font-size: 10px; color: var(--text-dim); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px; }
        .stat-value { font-size: 24px; font-weight: 700; }
        .stat-value.master { color: var(--master); }
        .stat-value.green { color: var(--assistant); }
        .stat-value.orange { color: var(--copilot); }
        .stat-value.blue { color: var(--review); }
        .stat-trend { font-size: 10px; color: var(--assistant); margin-top: 4px; }
        .sec-head { display: flex; align-items: center; gap: 10px; margin: 20px 0 12px 0; }
        .sec-title { font-size: 11px; font-weight: 600; color: var(--text-dim); text-transform: uppercase; letter-spacing: 0.5px; white-space: nowrap; }
        .sec-line { flex: 1; height: 1px; background: var(--border); }
        .sec-action { font-size: 11px; color: var(--master); cursor: pointer; }
        .card-list { display: flex; flex-direction: column; gap: 8px; }
        .technician-card, .enterprise-card { display: flex; align-items: center; gap: 12px; padding: 12px 14px; background: var(--card); border: 1px solid var(--border); border-radius: 10px; cursor: pointer; transition: all 0.2s; }
        .technician-card:hover, .enterprise-card:hover { background: rgba(255,255,255,0.04); border-color: rgba(255,255,255,0.1); }
        
        /* ═══ ENTERPRISE CARD DETAILED ═══ */
        .enterprise-logo { width: 40px; height: 40px; border-radius: 8px; background: linear-gradient(135deg, var(--copilot-bg), var(--copilot)); display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 14px; color: white; flex-shrink: 0; }
        .enterprise-info { flex: 1; min-width: 0; overflow: hidden; }
        .enterprise-name { font-size: 14px; font-weight: 600; color: var(--text); margin-bottom: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .enterprise-meta { font-size: 11px; color: var(--text-dim); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 100%; }
        .enterprise-right { display: flex; flex-direction: column; align-items: flex-end; gap: 4px; }
        .enterprise-badge { font-size: 10px; font-weight: 600; padding: 3px 8px; border-radius: 4px; }
        .enterprise-badge.starter { background: var(--copilot-bg); color: var(--copilot); border: 1px solid var(--copilot-border); }
        .enterprise-badge.free { background: rgba(107, 114, 128, 0.1); color: #9ca3af; border: 1px solid rgba(107, 114, 128, 0.2); }
        .enterprise-badge.pro { background: rgba(139, 92, 246, 0.1); color: #a78bfa; border: 1px solid rgba(139, 92, 246, 0.2); }
        .enterprise-badge.master { background: rgba(236, 72, 153, 0.1); color: #f472b6; border: 1px solid rgba(236, 72, 153, 0.2); }
        .enterprise-badge.pending { background: rgba(251, 191, 36, 0.1); color: #fbbf24; border: 1px solid rgba(251, 191, 36, 0.2); }
        
        /* ═══ HOVER ACTIONS FOR PENDING CARDS ═══ */
        .card-hover-actions {
            display: none;
            align-items: center;
            gap: 4px;
        }
        .enterprise-card.pending:hover .card-hover-actions,
        .technician-card.pending:hover .card-hover-actions {
            display: flex;
        }
        .enterprise-card.pending:hover .enterprise-badge.pending,
        .technician-card.pending:hover .status-badge-pending {
            display: none;
        }
        .card-action-btn {
            width: 28px;
            height: 28px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.15s ease;
        }
        .card-action-btn.approve {
            background: var(--assistant-bg);
            color: var(--assistant);
            border: 1px solid var(--assistant-border);
        }
        .card-action-btn.approve:hover {
            background: var(--assistant);
            color: var(--bg);
        }
        .card-action-btn.reject {
            background: var(--danger-bg);
            color: var(--danger);
            border: 1px solid var(--danger-border);
        }
        .card-action-btn.reject:hover {
            background: var(--danger);
            color: white;
        }
        
        /* Status badge for pending (to hide on hover) */
        .status-badge-pending {
            font-size: 9px;
            font-weight: 600;
            padding: 3px 8px;
            border-radius: 4px;
            background: rgba(251, 191, 36, 0.1);
            color: #fbbf24;
            border: 1px solid rgba(251, 191, 36, 0.2);
        }
        
        /* ═══ STATUS BUTTONS (instead of ugly dropdown) ═══ */
        .status-buttons { display: flex; gap: 8px; flex-wrap: wrap; }
        .status-btn { flex: 1; min-width: 90px; padding: 10px 12px; border-radius: 8px; border: 1px solid var(--border); background: var(--card); color: var(--text-dim); font-size: 12px; font-weight: 500; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 6px; }
        .status-btn:hover { background: rgba(255,255,255,0.05); }
        .status-btn.active { border-width: 2px; }
        .status-btn.pending.active { background: rgba(251, 191, 36, 0.1); border-color: #fbbf24; color: #fbbf24; }
        .status-btn.approved.active { background: rgba(34, 197, 94, 0.1); border-color: var(--assistant); color: var(--assistant); }
        .status-btn.rejected.active { background: rgba(239, 68, 68, 0.1); border-color: #ef4444; color: #ef4444; }
        .status-btn.suspended.active { background: rgba(107, 114, 128, 0.1); border-color: #6b7280; color: #6b7280; }
        
        /* ═══ STATUS DROPDOWN (replaces big buttons) ═══ */
        .status-dropdown-wrapper { position: relative; display: inline-block; }
        .status-tag { display: inline-flex; align-items: center; gap: 4px; font-size: 11px; font-weight: 500; padding: 4px 10px; border-radius: 6px; cursor: pointer; transition: all 0.2s; }
        .status-tag:hover { filter: brightness(1.1); }
        .status-tag.pending { background: rgba(251, 191, 36, 0.1); color: #fbbf24; border: 1px solid rgba(251, 191, 36, 0.2); }
        .status-tag.approved { background: rgba(34, 197, 94, 0.1); color: var(--assistant); border: 1px solid rgba(34, 197, 94, 0.2); }
        .status-tag.rejected { background: rgba(239, 68, 68, 0.1); color: #ef4444; border: 1px solid rgba(239, 68, 68, 0.2); }
        .status-tag.suspended { background: rgba(107, 114, 128, 0.1); color: #6b7280; border: 1px solid rgba(107, 114, 128, 0.2); }
        .status-tag svg { width: 12px; height: 12px; }
        .status-dropdown { position: absolute; top: 100%; left: 0; margin-top: 4px; background: var(--card); border: 1px solid var(--border); border-radius: 8px; padding: 4px; min-width: 140px; z-index: 100; display: none; box-shadow: 0 4px 12px rgba(0,0,0,0.3); }
        .status-dropdown.show { display: block; }
        .status-dropdown-item { display: flex; align-items: center; gap: 8px; padding: 8px 10px; border-radius: 6px; cursor: pointer; font-size: 12px; color: var(--text); transition: background 0.2s; }
        .status-dropdown-item:hover { background: rgba(255,255,255,0.05); }
        .status-dropdown-item .dot { width: 8px; height: 8px; border-radius: 50%; }
        .status-dropdown-item .dot.pending { background: #fbbf24; }
        .status-dropdown-item .dot.approved { background: var(--assistant); }
        .status-dropdown-item .dot.rejected { background: #ef4444; }
        .status-dropdown-item .dot.suspended { background: #6b7280; }
        
        /* ═══ PLAN CARD ═══ */
        .plan-card { background: rgba(255, 107, 53, 0.06); border: 1px solid var(--copilot-border); border-radius: 12px; padding: 14px; margin-bottom: 12px; }
        .plan-card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; }
        .plan-name { font-size: 14px; font-weight: 700; color: var(--copilot); }
        .plan-price { font-size: 13px; color: var(--text-dim); }
        .plan-progress { height: 4px; background: rgba(255,255,255,0.1); border-radius: 2px; overflow: hidden; margin-bottom: 6px; }
        .plan-progress-fill { height: 100%; background: var(--copilot); border-radius: 2px; transition: width 0.3s; }
        .plan-next { font-size: 10px; color: var(--text-dim); }
        
        /* ═══ USER LIST IN ENTERPRISE ═══ */
        .user-list-item { display: flex; align-items: center; gap: 10px; padding: 10px 12px; background: var(--card); border: 1px solid var(--border); border-radius: 8px; cursor: pointer; transition: all 0.2s; margin-bottom: 8px; }
        .user-list-item:last-child { margin-bottom: 0; }
        .user-list-item:hover { background: rgba(255,255,255,0.04); }
        .user-list-item.expanded { border-color: var(--assistant-border); background: rgba(34, 197, 94, 0.03); }
        .user-avatar-sm { width: 32px; height: 32px; border-radius: 50%; background: var(--card); border: 1px solid var(--border); display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: 600; color: var(--text); position: relative; }
        .user-avatar-sm .status-dot { position: absolute; bottom: -2px; right: -2px; width: 10px; height: 10px; border-radius: 50%; border: 2px solid var(--bg); }
        .user-avatar-sm .status-dot.pending { background: #fbbf24; }
        .user-avatar-sm .status-dot.approved { background: var(--assistant); }
        .user-avatar-sm .status-dot.rejected { background: #ef4444; }
        .user-list-info { flex: 1; min-width: 0; }
        .user-list-name { font-size: 12px; font-weight: 500; color: var(--text); }
        .user-list-role { font-size: 10px; color: var(--text-dim); }
        .user-list-badge { font-size: 9px; font-weight: 600; padding: 2px 6px; border-radius: 4px; background: rgba(34, 197, 94, 0.1); color: var(--assistant); }
        
        /* ═══ USER EXPAND PANEL ═══ */
        .user-expand { display: none; padding: 12px; background: rgba(0,0,0,0.2); border-radius: 0 0 8px 8px; margin-top: -9px; margin-bottom: 8px; border: 1px solid var(--border); border-top: none; }
        .user-expand.show { display: block; }
        .user-expand-row { display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid rgba(255,255,255,0.04); font-size: 11px; }
        .user-expand-row:last-child { border-bottom: none; }
        .user-expand-label { color: var(--text-dim); }
        .user-expand-value { color: var(--text); font-weight: 500; }
        
        /* ═══ PROJECT CARDS - EXACT FROM TECHNICIAN APP ═══ */
        .proj { display: flex; align-items: center; gap: 12px; padding: 14px 14px 14px 18px; background: var(--card); border: 1px solid var(--border); border-radius: 12px; cursor: pointer; transition: all 0.2s; -webkit-user-select: none; user-select: none; position: relative; overflow: hidden; min-height: 64px; }
        .proj::before { content: ''; position: absolute; left: 0; top: 12px; bottom: 12px; width: 3px; border-radius: 0 2px 2px 0; }
        .proj.copilot-bar::before { background: var(--copilot); }
        .proj.assistant-bar::before { background: var(--assistant); }
        .proj.both-bar::before { background: linear-gradient(180deg, var(--copilot) 0%, var(--assistant) 100%); }
        .proj:hover { background: rgba(255,255,255,0.04); border-color: rgba(255,255,255,0.15); }
        .proj-icons { display: flex; align-items: center; position: relative; width: 36px; height: 36px; flex-shrink: 0; }
        .proj-icons.dual { width: 44px; height: 40px; }
        .proj-icon { width: 36px; height: 36px; border-radius: 10px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
        .proj-icon.copilot { background: var(--copilot-bg); color: var(--copilot); }
        .proj-icon.assistant { background: var(--assistant-bg); color: var(--assistant); }
        .proj-icon .icon { width: 16px; height: 16px; }
        .proj-icon .star-icon { width: 18px; height: 18px; }
        .proj-icon .star-icon svg { fill: currentColor; stroke: none; }
        .proj-icons .proj-icon.back { position: absolute; top: 0; left: 0; width: 32px; height: 32px; border-radius: 8px; }
        .proj-icons .proj-icon.back .icon { width: 14px; height: 14px; }
        .proj-icons .proj-icon.back .star-icon { width: 16px; height: 16px; }
        .proj-icons .proj-icon.front { position: absolute; bottom: 0; right: 0; width: 32px; height: 32px; border-radius: 8px; box-shadow: -2px -2px 8px rgba(0,0,0,0.3); }
        .proj-icons .proj-icon.front .icon { width: 14px; height: 14px; }
        .proj-info { flex: 1; min-width: 0; }
        .proj-title { font-size: 13px; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-bottom: 4px; }
        .proj-meta { font-size: 11px; color: var(--text-dim); }
        .proj-right { display: flex; flex-direction: column; align-items: flex-end; gap: 4px; flex-shrink: 0; }
        .proj-time { font-size: 11px; color: rgba(255,255,255,0.25); }
        .proj-brand { font-size: 9px; font-weight: 500; padding: 3px 8px; border-radius: 4px; background: rgba(255,255,255,0.06); color: rgba(255,255,255,0.5); white-space: nowrap; }
        
        /* ═══ OCR CARD STYLES ═══ */
        .ocr-card { background: var(--card); border: 1px solid var(--border); border-radius: 12px; overflow: hidden; margin-top: 8px; }
        .ocr-card-header { display: flex; align-items: center; gap: 10px; padding: 12px 14px; background: rgba(34, 197, 94, 0.08); border-bottom: 1px solid var(--border); }
        .ocr-card-header .icon { width: 20px; height: 20px; color: var(--assistant); }
        .ocr-card-header .icon svg { width: 20px; height: 20px; }
        .ocr-card-header-title { font-weight: 600; font-size: 13px; color: var(--text); }
        .ocr-card-header-method { margin-left: auto; font-size: 11px; color: var(--text-dim); background: var(--bg); padding: 3px 8px; border-radius: 10px; }
        .ocr-ai-summary { padding: 14px; font-size: 13px; line-height: 1.6; border-bottom: 1px solid var(--border); }
        .ocr-ai-summary p { margin: 0 0 8px 0; }
        .ocr-ai-summary p:last-child { margin-bottom: 0; }
        .ocr-ai-summary strong { color: var(--copilot); }
        .ocr-ai-summary ul, .ocr-ai-summary ol { margin: 8px 0; padding-left: 20px; }
        .ocr-ai-summary li { margin: 4px 0; }
        .ocr-ai-summary h2 { font-size: 14px; font-weight: 700; color: var(--assistant); margin: 12px 0 8px 0; text-transform: uppercase; letter-spacing: 0.5px; }
        .ocr-ai-summary h2:first-child { margin-top: 0; }
        .ocr-raw-section { border-top: 1px solid var(--border); }
        .ocr-raw-toggle { width: 100%; padding: 10px 14px; background: transparent; border: none; color: var(--text-dim); font-size: 12px; cursor: pointer; display: flex; align-items: center; justify-content: space-between; transition: all 0.2s; }
        .ocr-raw-toggle:hover { background: rgba(255,255,255,0.03); color: var(--text); }
        .ocr-raw-toggle .chevron { transition: transform 0.2s; }
        .ocr-raw-toggle.open .chevron { transform: rotate(180deg); }
        .ocr-raw-content { display: none; max-height: 200px; overflow-y: auto; padding: 12px 14px; background: var(--bg); font-family: monospace; font-size: 11px; line-height: 1.5; white-space: pre-wrap; word-break: break-word; color: var(--text-dim); }
        .ocr-raw-content.show { display: block; }
        .ocr-structured { padding: 14px; }
        .ocr-structured-row { display: flex; align-items: baseline; padding: 6px 0; border-bottom: 1px solid rgba(255,255,255,0.04); }
        .ocr-structured-row:last-child { border-bottom: none; }
        .ocr-structured-label { font-size: 11px; color: var(--text-dim); width: 100px; flex-shrink: 0; }
        .ocr-structured-value { font-size: 12px; color: var(--text); font-weight: 500; }
        .ocr-structured-value.mono { font-family: monospace; }
        .ocr-structured-value.error { color: var(--hotline); }
        .ocr-table { width: 100%; border-collapse: collapse; margin: 8px 0; font-size: 11px; }
        .ocr-table th { background: rgba(255,255,255,0.05); padding: 8px 10px; text-align: left; font-weight: 600; color: var(--text-dim); border-bottom: 1px solid var(--border); }
        .ocr-table td { padding: 8px 10px; border-bottom: 1px solid rgba(255,255,255,0.04); color: var(--text); }
        .ocr-table tr:last-child td { border-bottom: none; }
        .technician-avatar, .enterprise-logo { width: 40px; height: 40px; border-radius: 50%; background: var(--assistant-bg); display: flex; align-items: center; justify-content: center; font-size: 14px; font-weight: 600; color: var(--assistant); position: relative; }
        .enterprise-logo { border-radius: 10px; background: var(--master-bg); color: var(--master); }
        .technician-status { position: absolute; bottom: 0; right: 0; width: 12px; height: 12px; border-radius: 50%; border: 2px solid var(--bg-secondary); }
        .technician-status.online { background: var(--assistant); }
        .technician-status.idle { background: var(--warning); }
        .technician-status.offline { background: #6b7280; }
        .technician-info, .enterprise-info, .project-info { flex: 1; min-width: 0; overflow: hidden; }
        .technician-name, .enterprise-name, .project-title { font-size: 13px; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .technician-meta, .enterprise-meta, .project-meta { font-size: 11px; color: var(--text-dim); margin-top: 2px; display: flex; align-items: center; gap: 6px; max-width: 66%; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .technician-right, .enterprise-right, .project-right { display: flex; flex-direction: column; align-items: flex-end; gap: 4px; }
        .technician-badge, .enterprise-badge { font-size: 9px; padding: 3px 8px; border-radius: 4px; font-weight: 500; }
        .technician-badge.approved { background: var(--assistant-bg); color: var(--assistant); }
        .technician-badge.pending { background: var(--warning-bg); color: var(--warning); }
        .technician-badge.rejected { background: var(--danger-bg); color: var(--danger); }
        
        /* Role badges */
        .technician-badge.role-tech { background: rgba(255, 107, 53, 0.15); color: var(--copilot); border: 1px solid rgba(255, 107, 53, 0.3); }
        .technician-badge.role-admin { background: rgba(139, 92, 246, 0.15); color: #a78bfa; border: 1px solid rgba(139, 92, 246, 0.3); }
        .technician-badge.role-manager { background: rgba(34, 197, 94, 0.15); color: var(--assistant); border: 1px solid rgba(34, 197, 94, 0.3); }
        
        /* Small role tags (like Admin tag in user list) */
        .role-tag { font-size: 9px; font-weight: 600; padding: 2px 6px; border-radius: 4px; }
        .role-tag.tech { background: rgba(255, 107, 53, 0.1); color: var(--copilot); }
        .role-tag.admin { background: rgba(139, 92, 246, 0.1); color: #a78bfa; }
        .role-tag.manager { background: rgba(34, 197, 94, 0.1); color: var(--assistant); }
        
        /* Status text below role - all gray and discreet */
        .technician-status-text { font-size: 10px; color: var(--text-dim); margin-top: 2px; }
        .enterprise-badge.pro { background: var(--master-bg); color: var(--master); }
        .project-icon { width: 44px; height: 44px; border-radius: 10px; background: var(--copilot-bg); display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
        .project-icon svg { width: 20px; height: 20px; color: var(--copilot); }
        .project-brand { font-size: 9px; padding: 3px 8px; border-radius: 4px; background: var(--review-bg); color: var(--review); font-weight: 500; }
        .project-indicators { display: flex; gap: 4px; }
        .project-indicator { width: 20px; height: 20px; border-radius: 4px; display: flex; align-items: center; justify-content: center; }
        .project-indicator svg { width: 12px; height: 12px; }
        .project-indicator.copilot { background: var(--copilot-bg); color: var(--copilot); }
        .project-indicator.assistant { background: var(--assistant-bg); color: var(--assistant); }
        .project-indicator.inactive { opacity: 0.3; }
        .info-card { background: var(--card); border: 1px solid var(--border); border-radius: 10px; padding: 14px; margin-bottom: 12px; }
        .info-card-title { font-size: 9px; font-weight: 600; color: var(--text-dim); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 12px; }
        .info-row { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid var(--border); }
        .info-row:last-child { border-bottom: none; }
        .info-label { font-size: 11px; color: var(--text-dim); }
        .info-value { font-size: 11px; font-weight: 500; }
        .info-value.green { color: var(--assistant); }
        .info-value.orange { color: var(--copilot); }
        .info-value.yellow { color: var(--warning); }
        .info-value.red { color: var(--danger); }
        .status-select { width: 100%; padding: 12px 14px; background: var(--bg); border: 2px solid var(--border); border-radius: 8px; color: var(--text); font-size: 13px; font-weight: 500; cursor: pointer; appearance: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='20' height='20' viewBox='0 0 24 24' fill='none' stroke='white' stroke-width='2'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 12px center; }
        .status-select:focus { outline: none; border-color: var(--master); }
        .quick-actions { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 20px; }
        .quick-action { display: flex; flex-direction: column; align-items: center; gap: 6px; padding: 14px 10px; background: var(--card); border: 1px solid var(--border); border-radius: 10px; cursor: pointer; transition: all 0.2s; }
        .quick-action:hover { background: rgba(255,255,255,0.04); border-color: var(--master-border); }
        .quick-action svg { width: 20px; height: 20px; color: var(--master); }
        .quick-action span { font-size: 10px; color: var(--text-dim); text-align: center; }
        .chart-card { background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 16px; margin-bottom: 16px; }
        .chart-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
        .chart-title { font-size: 12px; font-weight: 600; }
        .chart-period { font-size: 10px; color: var(--text-dim); padding: 4px 8px; background: var(--bg); border-radius: 4px; }
        .chart-bars { display: flex; align-items: flex-end; gap: 8px; height: 100px; }
        .chart-bar { flex: 1; background: var(--master-bg); border-radius: 4px 4px 0 0; transition: all 0.3s; }
        .chart-bar:hover { background: var(--master); }
        .chart-labels { display: flex; justify-content: space-between; margin-top: 8px; }
        .chart-label { font-size: 9px; color: var(--text-dim); }
        .full-page { position: fixed; inset: 0; background: var(--bg); background-image: linear-gradient(var(--grid-color) 1px, transparent 1px), linear-gradient(90deg, var(--grid-color) 1px, transparent 1px); background-size: 32px 32px; z-index: 200; display: none; flex-direction: column; }
        .full-page.active { display: flex; }
        .page-layout { display: flex; flex: 1; overflow: hidden; }
        .page-main { flex: 1; display: flex; flex-direction: column; min-width: 0; }
        .full-page.drawer-open .page-main { flex: 0 0 50%; max-width: 50%; }
        .page-content { flex: 1; overflow-y: auto; padding: 16px; background: var(--bg); background-image: linear-gradient(var(--grid-color) 1px, transparent 1px), linear-gradient(90deg, var(--grid-color) 1px, transparent 1px); background-size: 32px 32px; }
        .page-drawer { position: fixed; top: 0; right: 0; width: 50%; height: 100%; background: var(--bg-secondary); border-left: 1px solid var(--border); display: flex; flex-direction: column; transform: translateX(100%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); z-index: 250; }
        .full-page.drawer-open .page-drawer { transform: translateX(0); }
        @media (max-width: 900px) { .full-page.drawer-open .page-main { flex: 0 0 100%; max-width: 100%; opacity: 0.3; pointer-events: none; } .page-drawer { width: 100%; } }
        .page-header { display: flex; align-items: center; gap: 12px; padding: 12px 16px; padding-top: max(12px, env(safe-area-inset-top)); background: var(--bg-secondary); border-bottom: 1px solid var(--border); flex-shrink: 0; }
        .page-back { width: 32px; height: 32px; border-radius: 50%; background: var(--card); border: 1px solid var(--border); display: flex; align-items: center; justify-content: center; cursor: pointer; color: var(--text-dim); transition: all 0.2s; }
        .page-back:hover { background: rgba(255,255,255,0.05); color: var(--text); }
        .page-back svg { width: 16px; height: 16px; }
        .page-title-wrap { flex: 1; }
        .page-title { font-size: 16px; font-weight: 600; }
        .page-subtitle { font-size: 11px; color: var(--text-dim); margin-top: 2px; }
        .page-content-inner { max-width: var(--content-width); margin: 0 auto; }
        .search-bar { display: flex; align-items: center; gap: 10px; padding: 10px 14px; background: var(--card); border: 1px solid var(--border); border-radius: 10px; margin-bottom: 16px; }
        .search-bar svg { width: 16px; height: 16px; color: var(--text-dim); }
        .search-bar input { flex: 1; background: transparent; border: none; outline: none; font-size: 13px; color: var(--text); }
        .tabs { display: flex; gap: 4px; margin-bottom: 16px; background: var(--card); padding: 4px; border-radius: 8px; border: 1px solid var(--border); }
        .tab { flex: 1; padding: 8px 12px; font-size: 11px; font-weight: 500; color: var(--text-dim); background: transparent; border: none; border-radius: 6px; cursor: pointer; transition: all 0.2s; }
        .tab:hover { color: var(--text); }
        .tab.active { background: var(--master-bg); color: var(--master); }
        .loading-spinner { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 40px; }
        .spinner { width: 32px; height: 32px; border: 3px solid var(--border); border-top-color: var(--master); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .empty-state { text-align: center; padding: 40px 20px; }
        .empty-title { font-size: 14px; font-weight: 600; margin-bottom: 4px; }

        /* ═══════════════════════════════════════════════════════════════════════════
           CHAT VIEW - FROM TECHNICIAN APP
           ═══════════════════════════════════════════════════════════════════════════ */
        .project-view-overlay { position: fixed; inset: 0; background: var(--bg); background-image: linear-gradient(var(--grid-color) 1px, transparent 1px), linear-gradient(90deg, var(--grid-color) 1px, transparent 1px); background-size: 32px 32px; z-index: 300; display: none; flex-direction: column; }
        .project-view-overlay.active { display: flex; }
        .chat-view { display: flex; flex: 1; overflow: hidden; }
        .chat-view.single { flex-direction: column; }
        .chat-view.split { flex-direction: row; }
        @media (max-width: 767px) { .chat-view.split { flex-direction: column; } }
        .panel { display: flex; flex-direction: column; flex: 1; min-width: 0; min-height: 0; overflow: hidden; position: relative; background: var(--bg); background-image: linear-gradient(var(--grid-color) 1px, transparent 1px), linear-gradient(90deg, var(--grid-color) 1px, transparent 1px); background-size: 32px 32px; }
        .panel.copilot { --mode-color: var(--copilot); --mode-bg: var(--copilot-bg); --mode-border: var(--copilot-border); }
        .panel.assistant { --mode-color: var(--assistant); --mode-bg: var(--assistant-bg); --mode-border: var(--assistant-border); }
        .panel.copilot { --mode-color: var(--copilot); --mode-glow: var(--copilot-glow); --mode-bg: var(--copilot-bg); --mode-border: var(--copilot-border); }
        .panel.assistant { --mode-color: var(--assistant); --mode-glow: var(--assistant-glow); --mode-bg: var(--assistant-bg); --mode-border: var(--assistant-border); }
        .panel-header { display: flex; align-items: center; gap: 8px; padding: 10px 12px; padding-top: max(10px, env(safe-area-inset-top)); flex-shrink: 0; border-bottom: 1px solid var(--border); background: var(--bg-secondary); }
        .chat-view.split .panel-header { padding-top: 10px; }
        .panel-back { width: 32px; height: 32px; border-radius: 50%; background: var(--card); border: 1px solid var(--border); color: rgba(255,255,255,0.5); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; flex-shrink: 0; }
        .panel-back:hover { background: rgba(255,255,255,0.05); color: rgba(255,255,255,0.8); }
        .panel-back svg { width: 14px; height: 14px; }
        .panel-info { flex: 1; min-width: 0; display: flex; align-items: center; gap: 8px; }
        .panel-title { font-size: 13px; font-weight: 600; color: var(--mode-color); }
        .panel-separator { width: 1px; height: 12px; background: rgba(255,255,255,0.15); }
        .panel-brand { font-size: 12px; color: var(--text-dim); }
        .header-actions { display: flex; gap: 6px; flex-shrink: 0; }
        .h-btn { width: 32px; height: 32px; border-radius: 8px; background: var(--card); border: 1px solid var(--border); color: rgba(255,255,255,0.5); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
        .h-btn:hover { background: rgba(255,255,255,0.05); color: rgba(255,255,255,0.8); }
        .h-btn.active { background: var(--mode-bg); border-color: var(--mode-border); color: var(--mode-color); }
        .h-btn svg { width: 14px; height: 14px; }
        .chat-body { flex: 1; overflow-y: auto; overflow-x: hidden; padding: 14px; display: flex; flex-direction: column; gap: 10px; min-height: 0; -webkit-overflow-scrolling: touch; background: var(--bg); background-image: linear-gradient(var(--grid-color) 1px, transparent 1px), linear-gradient(90deg, var(--grid-color) 1px, transparent 1px); background-size: 32px 32px; }

        /* ═══ MESSAGES - EXACT FROM TECHNICIAN APP ═══ */
        .msg { max-width: 90%; animation: msgIn 0.3s ease; }
        @keyframes msgIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
        .msg.user { align-self: flex-end; max-width: 80%; }
        .msg.ai { align-self: flex-start; }
        .msg.ai.report { max-width: 98%; width: 98%; }
        .msg-bubble { padding: 12px 16px; border-radius: 16px; font-size: 13px; line-height: 1.5; position: relative; }
        .msg.user .msg-bubble { background: linear-gradient(135deg, var(--mode-color), color-mix(in srgb, var(--mode-color) 80%, black)); color: white; border-bottom-right-radius: 4px; }
        .msg.ai .msg-bubble { background: var(--card); border: 1px solid var(--border); border-bottom-left-radius: 4px; }
        .msg-head { display: flex; align-items: center; gap: 6px; margin-bottom: 6px; padding-bottom: 6px; border-bottom: 1px solid var(--border); }
        .msg-avatar { width: 22px; height: 22px; border-radius: 50%; background: linear-gradient(135deg, color-mix(in srgb, var(--mode-color) 70%, white), var(--mode-color)); display: flex; align-items: center; justify-content: center; }
        .msg-avatar .icon { width: 10px; height: 10px; color: white; }
        .msg-avatar svg { width: 10px; height: 10px; color: white; }
        .msg-name { font-size: 11px; font-weight: 600; color: var(--mode-color); }
        .msg-time { display: block; font-size: 9px; color: var(--text-dim); margin-top: 4px; opacity: 0.7; }
        .msg.user .msg-time { text-align: right; }
        .msg-image { max-width: 100%; max-height: 300px; border-radius: 12px; cursor: pointer; transition: transform 0.2s; display: block; margin: 8px 0; object-fit: contain; background: rgba(0,0,0,0.2); }
        .msg-image:hover { transform: scale(1.02); box-shadow: 0 4px 20px rgba(0,0,0,0.3); }
        .msg-bubble > .msg-image:first-child { margin-top: 0; }
        .msg-bubble > .msg-image:last-child { margin-bottom: 0; }
        
        /* Markdown styling in AI messages */
        .msg-bubble p { margin: 8px 0; }
        .msg-bubble p:first-child { margin-top: 0; }
        .msg-bubble p:last-child { margin-bottom: 0; }
        .msg-bubble ul, .msg-bubble ol { margin: 8px 0; padding-left: 20px; }
        .msg-bubble li { margin: 4px 0; }
        .msg-bubble strong { font-weight: 600; color: var(--text); }
        .msg-bubble em { font-style: italic; }
        .msg-bubble h1, .msg-bubble h2, .msg-bubble h3 { color: var(--mode-color); font-weight: 700; margin: 16px 0 8px 0; line-height: 1.3; }
        .msg-bubble h1:first-child, .msg-bubble h2:first-child, .msg-bubble h3:first-child { margin-top: 0; }
        .msg-bubble h1 { font-size: 18px; }
        .msg-bubble h2 { font-size: 16px; }
        .msg-bubble h3 { font-size: 14px; }
        .msg-bubble code { background: rgba(255,255,255,0.1); padding: 2px 6px; border-radius: 4px; font-family: monospace; font-size: 12px; }
        .msg-bubble pre { background: rgba(0,0,0,0.3); padding: 12px; border-radius: 8px; overflow-x: auto; margin: 8px 0; }
        .msg-bubble pre code { background: none; padding: 0; }

        /* ═══ REPORT CARD IN CHAT ═══ */
        .report-card { background: #1E1E2E; border: 1px solid rgba(255,255,255,0.08); border-radius: 16px; padding: 16px 24px 20px 24px; margin-top: 12px; line-height: 1.5; position: relative; }
        .report-card .report-title { display: block; font-size: 17px; font-weight: 700; color: var(--assistant); margin-bottom: 4px; padding-right: 36px; }
        .report-card h1 { font-size: 17px; font-weight: 700; color: var(--assistant); margin: 0 0 4px 0; border: none; }
        .report-card h2 { font-size: 14px; font-weight: 600; color: var(--assistant); text-transform: uppercase; letter-spacing: 0.3px; border: none; margin: 18px 0 8px 0; }
        .report-card h3 { font-size: 13px; font-weight: 600; color: rgba(255,255,255,0.7); margin: 12px 0 4px 0; border: none; }
        .report-card p { margin: 4px 0; font-size: 14px; color: rgba(255,255,255,0.9); }
        .report-card ul, .report-card ol { margin: 2px 0 6px 0; padding-left: 18px; }
        .report-card li { margin: 1px 0; font-size: 14px; color: rgba(255,255,255,0.9); line-height: 1.4; }
        .report-card hr { margin: 16px 0; border: none; border-top: 1px solid rgba(255,255,255,0.06); }
        .report-card strong { color: rgba(255,255,255,0.55); font-weight: 600; }
        .report-card table { width: 100%; border-collapse: collapse; margin: 10px 0; font-size: 13px; }
        .report-card th { background: rgba(255,255,255,0.06); color: var(--assistant); font-weight: 600; text-align: left; padding: 8px 10px; border: 1px solid rgba(255,255,255,0.08); }
        .report-card td { padding: 6px 10px; border: 1px solid rgba(255,255,255,0.06); color: rgba(255,255,255,0.8); }

        /* ═══ RPT STYLES - STRUCTURED REPORT IN CHAT ═══ */
        .rpt { max-width: 100%; margin-top: 8px; }
        .rpt-header { margin-bottom: 16px; padding-bottom: 12px; border-bottom: 1px solid var(--border); }
        .rpt-header-top { display: flex; justify-content: space-between; align-items: flex-start; gap: 12px; margin-bottom: 10px; }
        .rpt-brand { font-size: 10px; font-weight: 600; text-transform: uppercase; letter-spacing: 1.2px; margin-bottom: 4px; }
        .rpt-brand.mitsubishi { color: #E60012; }
        .rpt-brand.daikin { color: #00A0E4; }
        .rpt-brand.carrier { color: #0033A0; }
        .rpt-brand.general { color: var(--assistant); }
        .rpt-title { font-size: 18px; font-weight: 600; color: var(--text); letter-spacing: -0.3px; margin: 0; }
        .rpt-status { display: flex; align-items: center; gap: 5px; padding: 5px 10px; border-radius: 6px; white-space: nowrap; flex-shrink: 0; }
        .rpt-status.conforme { background: rgba(34,197,94,0.12); }
        .rpt-status.non-conforme { background: rgba(239,68,68,0.1); }
        .rpt-status.en-cours { background: rgba(245,158,11,0.12); }
        .rpt-status-dot { width: 5px; height: 5px; border-radius: 50%; }
        .rpt-status.conforme .rpt-status-dot { background: #22c55e; }
        .rpt-status.conforme .rpt-status-text { color: #22c55e; }
        .rpt-status.non-conforme .rpt-status-dot { background: #ef4444; }
        .rpt-status.non-conforme .rpt-status-text { color: #ef4444; }
        .rpt-status.en-cours .rpt-status-dot { background: #f59e0b; }
        .rpt-status.en-cours .rpt-status-text { color: #f59e0b; }
        .rpt-status-text { font-size: 10px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.3px; }
        .rpt-meta { display: flex; flex-wrap: wrap; gap: 6px 14px; font-size: 11px; color: var(--text-dim); }
        .rpt-meta .val { color: rgba(255,255,255,0.65); font-weight: 500; }
        .rpt-card { background: rgba(255,255,255,0.02); border: 1px solid var(--border); border-radius: 14px; overflow: hidden; }
        .rpt-section { padding: 14px 16px; border-bottom: 1px solid rgba(255,255,255,0.04); }
        .rpt-section:last-child { border-bottom: none; }
        .rpt-label { font-size: 9px; font-weight: 600; color: var(--assistant); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px; }
        .rpt-text { font-size: 13px; color: rgba(255,255,255,0.7); line-height: 1.6; margin: 0; }
        .rpt-text strong.err { color: #ef4444; font-weight: 600; }
        .rpt-text strong.ok { color: #22c55e; font-weight: 600; }
        .rpt-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 14px; }
        @media (max-width: 600px) { .rpt-grid { grid-template-columns: 1fr; } }
        .rpt-group { display: flex; flex-direction: column; gap: 5px; }
        .rpt-row { display: flex; align-items: baseline; padding-bottom: 5px; border-bottom: 1px solid rgba(255,255,255,0.04); gap: 8px; flex-wrap: wrap; }
        .rpt-row:last-child { border-bottom: none; padding-bottom: 0; }
        .rpt-row-label { font-size: 11px; color: var(--text-dim); flex-shrink: 0; }
        .rpt-row-value { font-size: 12px; color: var(--text); font-weight: 500; word-break: break-word; }
        .rpt-row-value.mono { font-family: monospace; font-size: 11px; }
        .rpt-row-value.error { color: #ef4444; }
        .rpt-row-value.success { color: #22c55e; }
        
        /* Travaux list */
        .rpt-list { display: flex; flex-direction: column; gap: 2px; }
        .rpt-item { display: flex; align-items: flex-start; gap: 10px; padding: 9px 12px; background: rgba(255,255,255,0.03); border-radius: 6px; }
        .rpt-item:first-child { border-radius: 6px 6px 2px 2px; }
        .rpt-item:last-child { border-radius: 2px 2px 6px 6px; }
        .rpt-item:only-child { border-radius: 6px; }
        .rpt-icon { width: 14px; height: 14px; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0; font-size: 8px; font-weight: 700; margin-top: 2px; }
        .rpt-icon.done { background: rgba(34,197,94,0.12); color: #22c55e; }
        .rpt-icon.pending { background: rgba(245,158,11,0.12); color: #f59e0b; }
        .rpt-icon.error { background: rgba(239,68,68,0.1); color: #ef4444; }
        .rpt-item-text { font-size: 12px; color: rgba(255,255,255,0.7); line-height: 1.5; }
        
        /* Mesures */
        .rpt-measures { display: flex; flex-direction: row; flex-wrap: wrap; gap: 5px; }
        .rpt-measure { flex: 1; min-width: 140px; background: rgba(255,255,255,0.03); border-radius: 8px; padding: 10px 12px; display: flex; justify-content: space-between; align-items: center; }
        .rpt-measure-info { display: flex; flex-direction: column; gap: 1px; }
        .rpt-measure-name { font-size: 11px; color: rgba(255,255,255,0.7); font-weight: 500; }
        .rpt-measure-note { font-size: 10px; color: var(--text-dim); }
        .rpt-measure-note.ok { color: #22c55e; }
        .rpt-measure-note.error { color: #ef4444; }
        .rpt-measure-val { font-size: 13px; font-weight: 600; font-family: monospace; }
        .rpt-measure-val.ok { color: #22c55e; }
        .rpt-measure-val.error { color: #ef4444; }
        .rpt-measure-val.neutral { color: var(--text); }
        
        /* Résultat */
        .rpt-result-status { font-size: 14px; line-height: 1.4; margin-bottom: 4px; }
        .rpt-result-status .err { color: #ef4444; font-weight: 600; }
        .rpt-result-status .ok { color: #22c55e; font-weight: 600; }
        .rpt-result-status .lbl { color: var(--text); font-weight: 500; }
        .rpt-result-desc { font-size: 12px; color: var(--text-dim); line-height: 1.5; }
        
        /* Checklist fallback */
        .rpt-checklist { list-style: none; margin: 0; padding: 0; display: flex; flex-direction: column; gap: 4px; }
        .rpt-checklist li { display: flex; align-items: flex-start; gap: 10px; font-size: 12px; color: rgba(255,255,255,0.8); line-height: 1.5; padding: 8px 12px; background: rgba(255,255,255,0.03); border-radius: 6px; }
        .rpt-checklist li .check-icon { flex-shrink: 0; width: 18px; height: 18px; display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: 700; border-radius: 50%; }
        .rpt-checklist li.done .check-icon { background: rgba(34,197,94,0.15); color: #22c55e; }
        .rpt-checklist li.error .check-icon { background: rgba(239,68,68,0.15); color: #ef4444; }

        /* ═══ DIVIDER ═══ */
        .divider { width: 8px; background: var(--border); cursor: col-resize; position: relative; flex-shrink: 0; transition: background 0.2s; display: flex; align-items: center; justify-content: center; touch-action: none; -webkit-user-select: none; user-select: none; }
        .divider:hover, .divider.dragging { background: rgba(255,255,255,0.1); }
        .divider-grip { display: flex; flex-direction: column; gap: 3px; }
        .divider-grip span { width: 3px; height: 3px; background: rgba(255,255,255,0.3); border-radius: 50%; }
        .divider:hover .divider-grip span, .divider.dragging .divider-grip span { background: rgba(255,255,255,0.6); }
        @media (max-width: 767px) { .divider { width: 100%; height: 8px; cursor: row-resize; } .divider-grip { flex-direction: row; } }
        .chat-empty { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; color: var(--text-dim); gap: 8px; }
        .chat-empty svg { width: 48px; height: 48px; opacity: 0.3; }

        /* ═══ REPORT SHEET ═══ */
        .report-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,0.4); z-index: 399; opacity: 0; pointer-events: none; transition: opacity 0.3s; }
        .report-backdrop.show { opacity: 1; pointer-events: auto; }
        .report-sheet { position: fixed; top: 0; right: 0; width: 100%; max-width: 55%; height: 100%; background: var(--bg-secondary); border-left: 1px solid var(--assistant-border); z-index: 400; display: flex; flex-direction: column; transform: translateX(100%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .report-sheet.open { transform: translateX(0); }
        @media (max-width: 900px) { .report-sheet { max-width: 70%; } }
        @media (max-width: 600px) { .report-sheet { max-width: 100%; border-left: none; } }
        .report-header { display: flex; align-items: center; gap: 10px; padding: 12px 14px; padding-top: max(12px, env(safe-area-inset-top)); border-bottom: 1px solid var(--border); flex-shrink: 0; }
        .report-close { width: 28px; height: 28px; border-radius: 50%; background: transparent; border: 1px solid var(--border); color: rgba(255,255,255,0.5); cursor: pointer; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
        .report-close:hover { background: rgba(255,255,255,0.05); color: var(--text); }
        .report-close svg { width: 12px; height: 12px; }
        .report-title-bar { flex: 1; display: flex; align-items: center; gap: 12px; }
        .report-title-text { font-size: 14px; font-weight: 600; color: var(--assistant); }
        .report-progress { flex: 1; display: flex; align-items: center; gap: 8px; }
        .report-progress-bar { flex: 1; height: 3px; background: rgba(255,255,255,0.1); border-radius: 2px; overflow: hidden; }
        .report-progress-fill { height: 100%; width: 0%; background: var(--review); border-radius: 2px; transition: width 0.4s ease; }
        .report-progress-text { font-size: 11px; font-weight: 600; color: var(--review); white-space: nowrap; }
        .report-body { flex: 1; overflow-y: auto; padding: 16px; }
        .report-footer { display: flex; gap: 10px; padding: 12px 16px; border-top: 1px solid var(--border); flex-shrink: 0; }
        .report-btn { flex: 1; padding: 10px; border-radius: 8px; font-size: 12px; font-weight: 600; cursor: pointer; transition: all 0.2s; border: none; display: flex; align-items: center; justify-content: center; gap: 6px; }
        .report-btn.secondary { background: var(--card); color: var(--text); border: 1px solid var(--border); }
        .report-btn.primary { background: var(--assistant); color: white; }
        .report-btn svg { width: 14px; height: 14px; }
        
        /* ═══ REPORT PREVIEW STYLES ═══ */
        .rpt-preview { font-size: 13px; }
        .rpt-preview-header { margin-bottom: 20px; padding-bottom: 16px; border-bottom: 1px solid var(--border); }
        .rpt-preview-brand { font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 1.5px; margin-bottom: 6px; }
        .rpt-preview-brand.mitsubishi { color: #E60012; }
        .rpt-preview-brand.daikin { color: #00A0E4; }
        .rpt-preview-brand.carrier { color: #0033A0; }
        .rpt-preview-brand.general { color: var(--assistant); }
        .rpt-preview-title-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .rpt-preview-title-row h2 { font-size: 16px; font-weight: 600; margin: 0; }
        .rpt-preview-status { font-size: 10px; font-weight: 600; padding: 5px 12px; border-radius: 6px; text-transform: uppercase; }
        .rpt-preview-status.conforme { background: rgba(34,197,94,0.15); color: #22c55e; }
        .rpt-preview-status.non-conforme { background: rgba(239,68,68,0.15); color: #ef4444; }
        .rpt-preview-status.en-cours { background: rgba(245,158,11,0.15); color: #f59e0b; }
        .rpt-preview-meta { display: flex; flex-wrap: wrap; gap: 16px; font-size: 11px; color: var(--text-dim); }
        .rpt-preview-meta strong { color: rgba(255,255,255,0.7); margin-left: 4px; }
        .rpt-preview-section { background: rgba(255,255,255,0.02); border: 1px solid var(--border); border-radius: 12px; padding: 16px; margin-bottom: 12px; }
        .rpt-preview-section.result { border-color: var(--assistant-border); background: var(--assistant-bg); }
        .rpt-preview-section-title { font-size: 10px; font-weight: 600; color: var(--text-dim); text-transform: uppercase; letter-spacing: 0.8px; margin-bottom: 12px; }
        .rpt-preview-text { font-size: 13px; color: rgba(255,255,255,0.8); line-height: 1.6; }
        .rpt-preview-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px 24px; }
        @media (max-width: 600px) { .rpt-preview-grid { grid-template-columns: 1fr; } }
        .rpt-preview-group { display: flex; flex-direction: column; gap: 8px; }
        .rpt-preview-group .rpt-preview-section-title { margin-bottom: 8px; }
        .rpt-preview-row { display: flex; justify-content: space-between; align-items: baseline; padding: 6px 0; border-bottom: 1px solid rgba(255,255,255,0.04); }
        .rpt-preview-row:last-child { border-bottom: none; }
        .rpt-preview-row .label { font-size: 11px; color: var(--text-dim); }
        .rpt-preview-row .value { font-size: 12px; color: var(--text); font-weight: 500; text-align: right; }
        .rpt-preview-row .value.mono { font-family: monospace; }
        .rpt-preview-row .placeholder { color: rgba(255,255,255,0.25); font-style: italic; font-weight: 400; }
        .rpt-preview-checklist { list-style: none; margin: 0; padding: 0; display: flex; flex-direction: column; gap: 6px; }
        .rpt-preview-checklist li { display: flex; align-items: flex-start; gap: 10px; padding: 10px 12px; background: rgba(255,255,255,0.03); border-radius: 8px; font-size: 12px; }
        .rpt-preview-checklist li .check { width: 20px; height: 20px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: 700; flex-shrink: 0; }
        .rpt-preview-checklist li.done .check { background: rgba(34,197,94,0.15); color: #22c55e; }
        .rpt-preview-checklist li.pending .check { background: rgba(239,68,68,0.15); color: #ef4444; }
        .rpt-preview-measures { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
        .measure-card { background: rgba(255,255,255,0.03); border-radius: 10px; padding: 12px; text-align: center; }
        .measure-card.error { border: 1px solid rgba(239,68,68,0.3); }
        .measure-label { font-size: 10px; color: var(--text-dim); margin-bottom: 4px; }
        .measure-value { font-size: 14px; font-weight: 600; font-family: monospace; }
        .measure-card.error .measure-value { color: #ef4444; }
        .result-status { display: inline-block; font-size: 12px; font-weight: 600; padding: 6px 14px; border-radius: 6px; margin-bottom: 10px; }
        .result-status.conforme { background: rgba(34,197,94,0.15); color: #22c55e; }
        .result-status.non-conforme { background: rgba(239,68,68,0.15); color: #ef4444; }
        .result-status.en-cours { background: rgba(245,158,11,0.15); color: #f59e0b; }
        .result-desc { font-size: 13px; color: rgba(255,255,255,0.7); line-height: 1.5; }
        
        /* ═══ EXTRACTION CARD STYLES ═══ */
        .extraction-card { background: rgba(34,197,94,0.08); border: 1px solid rgba(34,197,94,0.2); border-radius: 12px; overflow: hidden; margin: 10px 0; }
        .extraction-header { display: flex; align-items: center; justify-content: space-between; padding: 10px 14px; border-bottom: 1px solid rgba(34,197,94,0.15); }
        .extraction-header-left { display: flex; align-items: center; gap: 8px; }
        .extraction-icon { width: 20px; height: 20px; color: var(--assistant); }
        .extraction-title { font-size: 13px; font-weight: 600; color: var(--assistant); }
        .extraction-badge { font-size: 10px; padding: 3px 8px; background: rgba(255,255,255,0.1); border-radius: 4px; color: rgba(255,255,255,0.7); }
        .extraction-body { padding: 14px; }
        .extraction-section { margin-bottom: 12px; }
        .extraction-section:last-child { margin-bottom: 0; }
        .extraction-section-title { font-size: 12px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px; }
        .extraction-list { list-style: none; margin: 0; padding: 0; }
        .extraction-list li { display: flex; align-items: baseline; gap: 8px; padding: 4px 0; font-size: 13px; }
        .extraction-list li .label { color: var(--copilot); font-weight: 600; }
        .extraction-list li .value { color: var(--text); }
        .photo-analysis-bar { display: flex; align-items: center; gap: 12px; padding: 10px 14px; background: rgba(139, 92, 246, 0.15); border-radius: 10px; margin: 8px 0; }
        .photo-analysis-thumb { width: 48px; height: 48px; border-radius: 8px; object-fit: cover; background: rgba(0,0,0,0.3); }
        .photo-analysis-text { font-size: 12px; color: var(--copilot); }
        .photo-analysis-text::before { content: '📷 '; }

        /* ═══ EMAIL COMMUNICATION CARD ═══ */
        .email-card { background: var(--card); border: 1px solid var(--border); border-radius: 10px; padding: 14px; margin-bottom: 12px; }
        .email-card-header { display: flex; align-items: center; gap: 8px; margin-bottom: 14px; padding-bottom: 10px; border-bottom: 1px solid var(--border); }
        .email-card-header svg { width: 16px; height: 16px; color: var(--master); }
        .email-card-header span { font-size: 9px; font-weight: 600; color: var(--text-dim); text-transform: uppercase; letter-spacing: 0.5px; }
        .email-form-group { margin-bottom: 12px; }
        .email-form-label { display: block; font-size: 11px; color: var(--text-dim); margin-bottom: 6px; }
        .email-form-input { width: 100%; padding: 10px 12px; background: var(--bg); border: 1px solid var(--border); border-radius: 8px; font-size: 12px; color: var(--text); font-family: inherit; transition: border-color 0.2s; resize: none; }
        .email-form-input:focus { outline: none; border-color: var(--master); }
        .email-form-input::placeholder { color: var(--text-dim); }
        .email-form-textarea { min-height: 100px; line-height: 1.5; }
        .email-send-btn { width: 100%; display: flex; align-items: center; justify-content: center; gap: 8px; padding: 11px; background: var(--master); color: white; border: none; border-radius: 8px; font-size: 12px; font-weight: 600; cursor: pointer; transition: all 0.2s; font-family: inherit; }
        .email-send-btn:hover { filter: brightness(1.1); }
        .email-send-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .email-send-btn svg { width: 14px; height: 14px; }
        .email-send-btn .spinner { width: 14px; height: 14px; border: 2px solid rgba(255,255,255,0.3); border-top-color: white; border-radius: 50%; animation: spin 0.8s linear infinite; }
        
        /* Email History */
        .email-history { margin-top: 14px; padding-top: 12px; border-top: 1px solid var(--border); }
        .email-history-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px; }
        .email-history-title { font-size: 9px; font-weight: 600; color: var(--text-dim); text-transform: uppercase; letter-spacing: 0.5px; }
        .email-history-count { font-size: 10px; padding: 2px 8px; background: var(--master-bg); color: var(--master); border-radius: 10px; font-weight: 600; }
        .email-list { display: flex; flex-direction: column; gap: 6px; }
        .email-item { background: rgba(255,255,255,0.02); border: 1px solid var(--border); border-radius: 8px; overflow: hidden; transition: border-color 0.2s; }
        .email-item:hover { border-color: rgba(255,255,255,0.1); }
        .email-item-header { display: flex; align-items: center; gap: 10px; padding: 10px 12px; cursor: pointer; user-select: none; }
        .email-item-left { flex: 1; min-width: 0; }
        .email-item-subject { font-size: 12px; font-weight: 500; color: var(--text); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .email-item-date { font-size: 10px; color: var(--text-dim); margin-top: 2px; }
        .email-item-stats { display: flex; align-items: center; gap: 6px; flex-shrink: 0; }
        .email-stat { display: flex; align-items: center; gap: 3px; font-size: 10px; font-weight: 500; padding: 3px 8px; border-radius: 4px; }
        .email-stat.opened { background: var(--assistant-bg); color: var(--assistant); }
        .email-stat.not-opened { background: var(--warning-bg); color: var(--warning); }
        .email-stat.clicks { background: var(--review-bg); color: var(--review); }
        .email-item-chevron { width: 16px; height: 16px; color: var(--text-dim); transition: transform 0.2s; flex-shrink: 0; }
        .email-item.expanded .email-item-chevron { transform: rotate(180deg); }
        .email-item-body { display: none; padding: 12px; border-top: 1px solid var(--border); background: rgba(0,0,0,0.15); }
        .email-item.expanded .email-item-body { display: block; }
        .email-preview { font-size: 11px; color: var(--text-dim); line-height: 1.5; max-height: 60px; overflow: hidden; margin-bottom: 10px; padding: 8px 10px; background: var(--bg); border-radius: 6px; }
        .email-tracking-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }
        .email-tracking-stat { text-align: center; padding: 10px 8px; background: var(--bg); border-radius: 6px; }
        .email-tracking-stat .value { font-size: 16px; font-weight: 700; color: var(--text); }
        .email-tracking-stat .value.green { color: var(--assistant); }
        .email-tracking-stat .label { font-size: 9px; color: var(--text-dim); text-transform: uppercase; margin-top: 2px; }
        .email-clicks-section { margin-top: 10px; padding-top: 10px; border-top: 1px solid var(--border); }
        .email-clicks-title { font-size: 9px; font-weight: 600; color: var(--text-dim); text-transform: uppercase; margin-bottom: 6px; }
        .email-click-item { display: flex; justify-content: space-between; align-items: center; padding: 6px 8px; background: var(--bg); border-radius: 4px; margin-bottom: 4px; font-size: 10px; }
        .email-click-item:last-child { margin-bottom: 0; }
        .email-click-link { color: var(--review); font-weight: 500; }
        .email-click-time { color: var(--text-dim); }
        .email-empty { text-align: center; padding: 16px; color: var(--text-dim); font-size: 11px; }
        .email-toast { position: fixed; bottom: 20px; right: 20px; padding: 12px 20px; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 10px; font-size: 12px; color: var(--text); z-index: 10000; animation: slideInToast 0.3s ease; box-shadow: 0 4px 20px rgba(0,0,0,0.3); }
        .email-toast.success { border-color: var(--assistant-border); background: var(--assistant-bg); color: var(--assistant); }
        .email-toast.error { border-color: var(--danger-border); background: var(--danger-bg); color: var(--danger); }
        @keyframes slideInToast { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    </style>
</head>
<body>
    <div class="home-wrapper" id="homeWrapper">
        <div class="home-main">
            <header class="master-header">
                <div class="master-logo">
                    <!-- FixAIR Logo in Purple -->
                    <svg viewBox="0 0 140 32" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M6.5 4C3.46 4 1 6.46 1 9.5v13c0 3.04 2.46 5.5 5.5 5.5h13c3.04 0 5.5-2.46 5.5-5.5V15l-7 7H6.5c-.28 0-.5-.22-.5-.5v-13c0-.28.22-.5.5-.5H17l7-7H6.5z" fill="currentColor"/>
                        <path d="M25 4v11l-7 7V11l7-7z" fill="currentColor" fill-opacity="0.5"/>
                        <path d="M36 8h9.5v2.2h-6.8v4h5.8v2.2h-5.8v5.6H36V8z" fill="currentColor"/>
                        <path d="M48 8h2.7v6.1h.1L55.4 8h3.2l-5 6.5 5.4 7.5h-3.3l-4.6-6.6h-.1v6.6H48V8z" fill="currentColor" fill-opacity="0.7"/>
                        <path d="M67 8h2.8l5.2 14h-2.9l-1.1-3.2h-5.3L64.6 22h-2.8L67 8zm3.3 8.7l-1.9-5.5h-.1l-1.9 5.5h3.9z" fill="currentColor" fill-opacity="0.7"/>
                        <path d="M78 8h2.7v14H78V8z" fill="currentColor" fill-opacity="0.7"/>
                        <path d="M84 8h6.5c3.2 0 5.2 1.6 5.2 4.4 0 2.2-1.2 3.6-3.2 4.1l3.6 5.5h-3.1l-3.2-5.2h-3.1v5.2H84V8zm6.2 6.7c1.7 0 2.7-.8 2.7-2.2 0-1.4-1-2.2-2.7-2.2h-3.5v4.4h3.5z" fill="currentColor" fill-opacity="0.7"/>
                        <text x="100" y="22" font-family="Inter, sans-serif" font-size="11" font-weight="600" fill="currentColor" fill-opacity="0.4">MASTER</text>
                    </svg>
                </div>
                <div class="master-user">
                    <div class="connection-status"><div class="connection-dot" id="connectionDot"></div><span id="connectionText">Connexion...</span></div>
                    <div class="master-avatar">HA</div>
                </div>
            </header>
            <div class="home-content">
                <div class="home-content-inner">
                    <div class="quick-actions">
                        <div class="quick-action"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5v14M5 12h14"/></svg><span>Nouvelle<br>Entreprise</span></div>
                        <div class="quick-action"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="5" width="20" height="14" rx="2"/><path d="M2 10h20"/></svg><span>Gérer<br>Abonnements</span></div>
                        <div class="quick-action"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg><span>Voir<br>Analytics</span></div>
                    </div>
                    <div class="stats-grid">
                        <div class="stat-card highlight"><div class="stat-label">Entreprises</div><div class="stat-value master">24</div><div class="stat-trend">+3 ce mois</div></div>
                        <div class="stat-card"><div class="stat-label">Techniciens</div><div class="stat-value green" id="statTechnicians">-</div><div class="stat-trend" id="statTechniciansTrend">Chargement...</div></div>
                        <div class="stat-card"><div class="stat-label">Entreprises</div><div class="stat-value orange" id="statProjects">-</div><div class="stat-trend" id="statProjectsTrend">Chargement...</div></div>
                        <div class="stat-card"><div class="stat-label">MRR</div><div class="stat-value blue">€18,450</div><div class="stat-trend">+8.2%</div></div>
                    </div>
                    <div class="chart-card"><div class="chart-header"><span class="chart-title">Revenus mensuels</span><span class="chart-period">6 derniers mois</span></div><div class="chart-bars"><div class="chart-bar" style="height:45%"></div><div class="chart-bar" style="height:55%"></div><div class="chart-bar" style="height:62%"></div><div class="chart-bar" style="height:58%"></div><div class="chart-bar" style="height:75%"></div><div class="chart-bar" style="height:92%"></div></div><div class="chart-labels"><span class="chart-label">Juil</span><span class="chart-label">Août</span><span class="chart-label">Sept</span><span class="chart-label">Oct</span><span class="chart-label">Nov</span><span class="chart-label">Déc</span></div></div>
                    <div class="sec-head"><span class="sec-title">Entreprises</span><div class="sec-line"></div><span class="sec-action" onclick="openPage('enterprises')">Voir tout</span></div>
                    <div class="card-list" id="enterprisesListHome"></div>
                    <div class="sec-head"><span class="sec-title">Techniciens</span><div class="sec-line"></div><span class="sec-action" onclick="openPage('users')">Voir tout</span></div>
                    <div class="card-list" id="techniciansListHome"><div class="loading-spinner"><div class="spinner"></div></div></div>
                </div>
            </div>
        </div>
        <div class="home-drawer" id="homeDrawer">
            <div class="drawer-header"><div class="drawer-close" onclick="closeHomeDrawer()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18M6 6l12 12"/></svg></div><div class="drawer-title-wrap"><div class="drawer-title" id="homeDrawerTitle">-</div><div class="drawer-subtitle" id="homeDrawerSubtitle">-</div></div><div class="drawer-badge" id="homeDrawerBadge">-</div></div>
            <div class="drawer-body" id="homeDrawerBody"></div>
            <div class="drawer-footer" id="homeDrawerFooter"></div>
        </div>
        <nav class="home-nav"><div class="nav-pill"><div class="nav-item active" onclick="goHome()"><svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/></svg><span class="nav-label">Dashboard</span></div><div class="nav-item" onclick="openPage('enterprises')"><svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 21h18M5 21V7l7-4 7 4v14"/></svg><span class="nav-label">Entreprises</span></div><div class="nav-item" onclick="openPage('users')"><svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/><circle cx="9" cy="7" r="4"/></svg><span class="nav-label">Utilisateurs</span></div><div class="nav-item" onclick="openPage('settings')"><svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/></svg><span class="nav-label">Paramètres</span></div></div></nav>
    </div>

    <div class="full-page" id="pageUsers">
        <div class="page-layout">
            <div class="page-main">
                <div class="page-header"><div class="page-back" onclick="closePage()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 12H5M12 19l-7-7 7-7"/></svg></div><div class="page-title-wrap"><div class="page-title">Utilisateurs</div><div class="page-subtitle" id="usersPageSubtitle">Chargement...</div></div></div>
                <div class="page-content"><div class="page-content-inner">
                    <div class="search-bar"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35"/></svg><input type="text" placeholder="Rechercher..." id="usersSearchInput" oninput="filterUsers()"></div>
                    <div class="tabs" id="usersTabs"><button class="tab active" onclick="filterUsersByRole('all')">Tous (<span id="countAll">0</span>)</button><button class="tab" onclick="filterUsersByRole('technician')">Technicien (<span id="countTech">0</span>)</button><button class="tab" onclick="filterUsersByRole('manager')">Manager (<span id="countManager">0</span>)</button><button class="tab" onclick="filterUsersByRole('admin')">Admin (<span id="countAdmin">0</span>)</button></div>
                    <div class="card-list" id="usersListPage"><div class="loading-spinner"><div class="spinner"></div></div></div>
                </div></div>
            </div>
            <div class="page-drawer" id="usersDrawer">
                <div class="drawer-header"><div class="drawer-close" onclick="closePageDrawer('users')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18M6 6l12 12"/></svg></div><div class="drawer-title-wrap"><div class="drawer-title" id="usersDrawerTitle">-</div><div class="drawer-subtitle" id="usersDrawerSubtitle">-</div></div><div class="drawer-badge" id="usersDrawerBadge">-</div></div>
                <div class="drawer-body" id="usersDrawerBody"></div>
                <div class="drawer-footer" id="usersDrawerFooter"></div>
            </div>
        </div>
    </div>

    <div class="full-page" id="pageEnterprises">
        <div class="page-layout">
            <div class="page-main">
                <div class="page-header"><div class="page-back" onclick="closePage()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 12H5M12 19l-7-7 7-7"/></svg></div><div class="page-title-wrap"><div class="page-title">Entreprises</div><div class="page-subtitle" id="enterprisesPageSubtitle">Chargement...</div></div></div>
                <div class="page-content"><div class="page-content-inner">
                    <div class="search-bar"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35"/></svg><input type="text" placeholder="Rechercher une entreprise..." id="enterprisesSearchInput" oninput="filterEnterprises()"></div>
                    <div class="card-list" id="enterprisesList"></div>
                </div></div>
            </div>
            <div class="page-drawer" id="enterprisesDrawer">
                <div class="drawer-header"><div class="drawer-close" onclick="closePageDrawer('enterprises')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18M6 6l12 12"/></svg></div><div class="drawer-title-wrap"><div class="drawer-title" id="enterprisesDrawerTitle">-</div><div class="drawer-subtitle" id="enterprisesDrawerSubtitle">-</div></div><div class="drawer-badge" id="enterprisesDrawerBadge">-</div></div>
                <div class="drawer-body" id="enterprisesDrawerBody"></div>
                <div class="drawer-footer" id="enterprisesDrawerFooter"></div>
            </div>
        </div>
    </div>
    <div class="full-page" id="pageSettings"><div class="page-layout"><div class="page-main"><div class="page-header"><div class="page-back" onclick="closePage()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 12H5M12 19l-7-7 7-7"/></svg></div><div class="page-title-wrap"><div class="page-title">Paramètres</div></div></div><div class="page-content"><div class="page-content-inner"><div class="info-card"><div class="info-card-title">Base de données</div><div class="info-row"><span class="info-label">Utilisateurs</span><span class="info-value green" id="settingsUserCount">-</span></div><div class="info-row"><span class="info-label">Projets</span><span class="info-value orange" id="settingsProjectCount">-</span></div><div class="info-row"><span class="info-label">Chats</span><span class="info-value blue" id="settingsChatCount">-</span></div></div></div></div></div></div></div>

    <!-- PROJECT VIEW -->
    <div class="project-view-overlay" id="projectViewOverlay">
        <div class="chat-view single" id="chatView">
            <div class="panel copilot" id="panelCopilot" style="flex-basis:50%;">
                <header class="panel-header">
                    <button class="panel-back" onclick="closeProjectView()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 12H5M12 19l-7-7 7-7"/></svg></button>
                    <div class="panel-info">
                        <div class="panel-title">FixAIR Copilot</div>
                        <div class="panel-separator"></div>
                        <div class="panel-brand" id="copilotBrand">-</div>
                    </div>
                    <div class="header-actions">
                        <button class="h-btn" onclick="toggleSplit()" title="Split view"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><line x1="12" y1="3" x2="12" y2="21"/></svg></button>
                    </div>
                </header>
                <div class="chat-body" id="copilotBody"></div>
            </div>
            <div class="divider" id="divider" style="display:none;"><div class="divider-grip"><span></span><span></span><span></span></div></div>
            <div class="panel assistant" id="panelAssistant" style="display:none;flex-basis:50%;">
                <header class="panel-header">
                    <button class="panel-back" onclick="closeProjectView()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 12H5M12 19l-7-7 7-7"/></svg></button>
                    <div class="panel-info">
                        <div class="panel-title">FixAIR Assistant</div>
                        <div class="panel-separator"></div>
                        <div class="panel-brand" id="assistantBrand">-</div>
                    </div>
                    <div class="header-actions">
                        <button class="h-btn" onclick="openReportSheet()" title="Voir rapport"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 11l3 3L22 4"/><path d="M21 12v7a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2h11"/></svg></button>
                        <button class="h-btn" onclick="toggleSplit()" title="Split view"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><line x1="12" y1="3" x2="12" y2="21"/></svg></button>
                    </div>
                </header>
                <div class="chat-body" id="assistantBody"></div>
            </div>
        </div>
    </div>

    <!-- REPORT SHEET -->
    <div class="report-backdrop" id="reportBackdrop" onclick="closeReportSheet()"></div>
    <div class="report-sheet" id="reportSheet">
        <div class="report-header">
            <button class="report-close" onclick="closeReportSheet()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18M6 6l12 12"/></svg></button>
            <div class="report-title-bar">
                <span class="report-title-text">Rapport d'intervention</span>
                <div class="report-progress"><div class="report-progress-bar"><div class="report-progress-fill" id="reportProgressFill"></div></div><span class="report-progress-text" id="reportProgressText">0%</span></div>
            </div>
        </div>
        <div class="report-body" id="reportBody"></div>
        <div class="report-footer">
            <button class="report-btn secondary"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/></svg>Partager</button>
            <button class="report-btn primary"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="12" y1="18" x2="12" y2="12"/><line x1="9" y1="15" x2="15" y2="15"/></svg>Exporter PDF</button>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://fwuhzraxqrvmpqxnzpqm.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZ3dWh6cmF4cXJ2bXBxeG56cHFtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYyNTcyMTksImV4cCI6MjA4MTgzMzIxOX0.8ryQm1tsdx5ox3aFJiiflmwuEGGxxH_PlobGxXMgFuQ';
        const N8N_WEBHOOK_URL = 'https://cherhabil.app.n8n.cloud/webhook/fixair-approval';

        let allUsers = [], allProjects = [], allChats = [], allMessages = [];
        let allEnterprises = [], allTechnicians = [];
        let currentFilter = 'all', selectedUserId = null, currentProjectId = null;
        let isSplit = false, currentMode = 'copilot', currentProjectData = null, currentReportData = null;

        const enterpriseData = {
            e1: { name: 'ClimaFroid Services', initials: 'CL', plan: 'Pro', techs: 12, projects: 47 },
            e2: { name: 'ThermoFlex HVAC', initials: 'TF', plan: 'Pro', techs: 8, projects: 31 },
            e3: { name: 'AirExpert Solutions', initials: 'AE', plan: 'Starter', techs: 5, projects: 18 },
            e4: { name: 'NordVentilation', initials: 'NV', plan: 'Trial', techs: 3, projects: 4 }
        };

        // ═══ SUPABASE HELPERS ═══
        async function supabaseQuery(table, options = {}) {
            let url = `${SUPABASE_URL}/rest/v1/${table}`;
            const params = new URLSearchParams();
            if (options.select) params.append('select', options.select);
            if (options.order) params.append('order', options.order);
            if (options.limit) params.append('limit', options.limit);
            if (params.toString()) url += `?${params.toString()}`;
            const response = await fetch(url, { headers: { 'apikey': SUPABASE_ANON_KEY, 'Authorization': `Bearer ${SUPABASE_ANON_KEY}` } });
            if (!response.ok) throw new Error(`Supabase error: ${response.status}`);
            return response.json();
        }

        async function supabaseUpdate(table, id, data) {
            const url = `${SUPABASE_URL}/rest/v1/${table}?id=eq.${id}`;
            const response = await fetch(url, { method: 'PATCH', headers: { 'apikey': SUPABASE_ANON_KEY, 'Authorization': `Bearer ${SUPABASE_ANON_KEY}`, 'Content-Type': 'application/json', 'Prefer': 'return=representation' }, body: JSON.stringify(data) });
            if (!response.ok) throw new Error(`Update failed: ${response.status}`);
            return response.json();
        }

        function setConnectionStatus(status) {
            const dot = document.getElementById('connectionDot'), text = document.getElementById('connectionText');
            dot.className = 'connection-dot';
            if (status === 'connected') { dot.classList.add('connected'); text.textContent = 'Connecté'; }
            else if (status === 'loading') { dot.classList.add('loading'); text.textContent = 'Connexion...'; }
            else text.textContent = 'Déconnecté';
        }

        async function loadAllData() {
            setConnectionStatus('loading');
            try {
                allUsers = await supabaseQuery('users', { select: '*', order: 'created_at.desc' });
                allProjects = await supabaseQuery('projects', { select: '*', order: 'updated_at.desc' });
                allChats = await supabaseQuery('chats', { select: '*', order: 'started_at.desc' });
                allMessages = await supabaseQuery('messages', { select: '*', order: 'created_at.asc', limit: '2000' });
                
                // Separate enterprises and technicians
                // Enterprise = role is 'admin' AND has company_name
                // Technician = everyone else (role is 'technician' or no role, or no company_name)
                allEnterprises = allUsers.filter(u => {
                    const role = (u.role || '').toLowerCase();
                    const hasCompany = u.company_name && u.company_name.trim() !== '';
                    return role === 'admin' && hasCompany;
                });
                
                allTechnicians = allUsers.filter(u => {
                    const role = (u.role || '').toLowerCase();
                    const hasCompany = u.company_name && u.company_name.trim() !== '';
                    // Technician = not admin, OR admin without company
                    return role !== 'admin' || !hasCompany;
                });
                
                console.log('Data loaded:', { 
                    users: allUsers.length, 
                    enterprises: allEnterprises.length, 
                    technicians: allTechnicians.length,
                    projects: allProjects.length, 
                    chats: allChats.length, 
                    messages: allMessages.length 
                });
                
                // Debug: show enterprise detection
                if (allEnterprises.length > 0) {
                    console.log('✅ Enterprises found:', allEnterprises.map(e => ({ 
                        email: e.email, 
                        role: e.role, 
                        company: e.company_name 
                    })));
                } else {
                    console.log('⚠️ No enterprises found. Checking users with admin role:');
                    const admins = allUsers.filter(u => (u.role || '').toLowerCase() === 'admin');
                    console.log('Admins:', admins.map(a => ({ email: a.email, role: a.role, company: a.company_name })));
                }
                setConnectionStatus('connected');
                updateDashboard();
                updateSettingsPage();
                renderEnterprisesHome();
            } catch (error) {
                console.error('Error:', error);
                setConnectionStatus('error');
            }
        }

        // ═══ HELPERS ═══
        function getInitials(name) { if (!name) return '??'; const parts = name.split(/[@\s]+/); return parts.length >= 2 ? (parts[0][0] + parts[1][0]).toUpperCase() : name.substring(0, 2).toUpperCase(); }
        function formatStatus(s) { return { approved: 'Approuvé', pending: 'En attente', rejected: 'Rejeté', suspended: 'Suspendu' }[s] || 'En attente'; }
        function formatDate(d) { return d ? new Date(d).toLocaleDateString('fr-FR', { day: 'numeric', month: 'short', year: 'numeric' }) : '-'; }
        function formatTimeAgo(d) { if (!d) return '-'; const diff = Math.floor((new Date() - new Date(d)) / 1000); if (diff < 60) return 'À l\'instant'; if (diff < 3600) return `Il y a ${Math.floor(diff/60)} min`; if (diff < 86400) return `Il y a ${Math.floor(diff/3600)}h`; return `Il y a ${Math.floor(diff/86400)}j`; }

        // ═══ PARSE MARKDOWN ═══
        function parseMarkdown(text) {
            if (!text) return '';
            
            // ═══ STEP 1: Strip [REPORT_DATA] blocks completely ═══
            text = text.replace(/\[REPORT_DATA\][\s\S]*?\[\/REPORT_DATA\]/g, '').trim();
            
            // If empty after stripping, return empty
            if (!text) return '';
            
            // ═══ STEP 2: Extract and store images separately ═══
            const images = [];
            text = text.replace(/(data:image\/[a-zA-Z+]+;base64,[A-Za-z0-9+/=]+)/g, (match) => {
                images.push(match);
                return `__IMAGE_${images.length - 1}__`;
            });
            
            // Trim text for pattern matching
            const trimmed = text.trim();
            
            // ═══ STEP 3: Check for extraction result patterns ═══
            if (text.includes('RÉSUMÉ') && (text.includes('Marque:') || text.includes('Modèle:') || text.includes('N° série:'))) {
                return renderExtractionCard(text, images);
            }
            
            // ═══ STEP 3b: Check for OCR result JSON ═══
            // Pattern: {"type":"ocr_result"...} anywhere in the text
            if (trimmed.includes('"type":"ocr_result"') || trimmed.includes('"type": "ocr_result"')) {
                // Find the JSON part - look for opening brace before type
                let jsonStart = trimmed.indexOf('{"type":"ocr_result"');
                if (jsonStart === -1) jsonStart = trimmed.indexOf('{"type": "ocr_result"');
                if (jsonStart === -1) jsonStart = trimmed.indexOf('{\"type\":\"ocr_result\"');
                
                if (jsonStart >= 0) {
                    // Find matching closing brace
                    let depth = 0, jsonEnd = jsonStart;
                    for (let i = jsonStart; i < trimmed.length; i++) {
                        if (trimmed[i] === '{') depth++;
                        else if (trimmed[i] === '}') {
                            depth--;
                            if (depth === 0) { jsonEnd = i + 1; break; }
                        }
                    }
                    
                    const jsonStr = trimmed.substring(jsonStart, jsonEnd);
                    try {
                        const ocrData = JSON.parse(jsonStr);
                        if (ocrData.type === 'ocr_result') {
                            return restoreImages(renderOCRCard(ocrData), images);
                        }
                    } catch (e) {
                        console.log('OCR JSON parse failed:', e.message);
                    }
                }
            }
            
            // ═══ STEP 4: Check for JSON report ═══
            
            // Check code block JSON
            const codeBlockMatch = trimmed.match(/```\s*(?:json)?\s*([\s\S]*?)\s*```/);
            if (codeBlockMatch) {
                const jsonContent = codeBlockMatch[1].trim();
                if (jsonContent.startsWith('{')) {
                    try {
                        const jsonData = JSON.parse(jsonContent);
                        if (jsonData.type === 'report' || jsonData.resume || jsonData.travaux_effectues) {
                            const introMatch = trimmed.match(/^([\s\S]*?)```/);
                            const intro = introMatch ? introMatch[1].trim() : '';
                            let result = intro ? `<p>${escapeHtml(intro)}</p>` : '';
                            result += renderStructuredReport(jsonData.data || jsonData);
                            return restoreImages(result, images);
                        }
                    } catch (e) {}
                }
            }
            
            // Check raw JSON (starts with {)
            if (trimmed.startsWith('{') && trimmed.endsWith('}')) {
                try {
                    const jsonData = JSON.parse(trimmed);
                    if (jsonData.type === 'report' || jsonData.resume || jsonData.travaux_effectues) {
                        return restoreImages(renderStructuredReport(jsonData.data || jsonData), images);
                    }
                } catch (e) {}
            }
            
            // ═══ CRITICAL: Check for JSON embedded in text (intro text + JSON) ═══
            // Pattern: some text... {"type":"report"...} or text + {json}
            const jsonStartIndex = trimmed.indexOf('{"type":"report"');
            if (jsonStartIndex > 0) {
                const introText = trimmed.substring(0, jsonStartIndex).trim();
                const jsonText = trimmed.substring(jsonStartIndex);
                try {
                    const jsonData = JSON.parse(jsonText);
                    let result = introText ? processBasicMarkdown(introText) : '';
                    result += renderStructuredReport(jsonData.data || jsonData);
                    return restoreImages(result, images);
                } catch (e) {
                    console.log('Embedded JSON parse failed:', e.message);
                }
            }
            
            // Also check for text + {"data":{...}} pattern  
            const dataJsonIndex = trimmed.indexOf('{"data":{');
            if (dataJsonIndex > 0) {
                const introText = trimmed.substring(0, dataJsonIndex).trim();
                const jsonText = trimmed.substring(dataJsonIndex);
                try {
                    const jsonData = JSON.parse(jsonText);
                    if (jsonData.data && (jsonData.data.resume || jsonData.data.brand)) {
                        let result = introText ? processBasicMarkdown(introText) : '';
                        result += renderStructuredReport(jsonData.data);
                        return restoreImages(result, images);
                    }
                } catch (e) {}
            }
            
            // ═══ STEP 5: Basic markdown parsing ═══
            let html = escapeHtml(text);
            
            // Headers
            html = html.replace(/^### (.*$)/gm, '<h3>$1</h3>');
            html = html.replace(/^## (.*$)/gm, '<h2>$1</h2>');
            html = html.replace(/^# (.*$)/gm, '<h1>$1</h1>');
            
            // Bold and italic
            html = html.replace(/\*\*\*(.*?)\*\*\*/g, '<strong><em>$1</em></strong>');
            html = html.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            html = html.replace(/\*(.*?)\*/g, '<em>$1</em>');
            
            // Code
            html = html.replace(/`([^`]+)`/g, '<code>$1</code>');
            
            // Lists
            html = html.replace(/^\s*[-*•]\s+(.*$)/gm, '<li>$1</li>');
            html = html.replace(/(<li>.*<\/li>\n?)+/g, '<ul>$&</ul>');
            
            // Paragraphs
            html = html.replace(/\n\n+/g, '</p><p>');
            html = html.replace(/\n/g, '<br>');
            
            // Wrap in paragraph if needed
            if (!html.startsWith('<h') && !html.startsWith('<ul') && !html.startsWith('__IMAGE_')) {
                html = '<p>' + html + '</p>';
            }
            
            // Clean up
            html = html.replace(/<p><\/p>/g, '');
            html = html.replace(/<p><br><\/p>/g, '');
            
            // ═══ STEP 6: Restore images as proper img tags ═══
            return restoreImages(html, images);
        }
        
        function renderExtractionCard(text, images) {
            // Extract fields from text
            const getField = (label) => {
                const match = text.match(new RegExp(label + '\\s*[:\\s]\\s*([^\\n•*]+)', 'i'));
                return match ? match[1].trim() : 'Non visible';
            };
            
            const marque = getField('Marque');
            const modele = getField('Modèle');
            const serie = getField('N° série|Numéro de série|Serie');
            const puissance = getField('Puissance');
            
            let html = '';
            
            // Add image if present
            if (images.length > 0) {
                html += `<div class="photo-analysis-bar"><img src="${images[0]}" class="photo-analysis-thumb" onclick="openImageViewer(this.src)"><span class="photo-analysis-text">Analyse de cette photo</span></div>`;
            }
            
            html += `<div class="extraction-card">
                <div class="extraction-header">
                    <div class="extraction-header-left">
                        <svg class="extraction-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M23 19a2 2 0 01-2 2H3a2 2 0 01-2-2V8a2 2 0 012-2h4l2-3h6l2 3h4a2 2 0 012 2z"/><circle cx="12" cy="13" r="4"/></svg>
                        <span class="extraction-title">Extraction d'image</span>
                    </div>
                    <span class="extraction-badge">✨ IA Vision</span>
                </div>
                <div class="extraction-body">
                    <div class="extraction-section">
                        <div class="extraction-section-title">RÉSUMÉ</div>
                        <ul class="extraction-list">
                            <li><span class="label">Marque:</span> <span class="value">${marque}</span></li>
                            <li><span class="label">Modèle:</span> <span class="value">${modele}</span></li>
                            <li><span class="label">N° série:</span> <span class="value">${serie}</span></li>
                            <li><span class="label">Puissance:</span> <span class="value">${puissance}</span></li>
                        </ul>
                    </div>
                </div>
            </div>`;
            
            return html;
        }
        
        function escapeHtml(text) {
            return text.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
        }
        
        function processBasicMarkdown(text) {
            let html = escapeHtml(text);
            // Bold
            html = html.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            // Italic
            html = html.replace(/\*(.*?)\*/g, '<em>$1</em>');
            // Paragraphs
            html = html.replace(/\n\n+/g, '</p><p>');
            html = html.replace(/\n/g, '<br>');
            return '<p>' + html + '</p>';
        }
        
        function restoreImages(html, images) {
            images.forEach((src, i) => {
                html = html.replace(`__IMAGE_${i}__`, `<img src="${src}" class="msg-image" onclick="openImageViewer(this.src)">`);
            });
            return html;
        }
        
        function openImageViewer(src) {
            window.open(src, '_blank');
        }
        
        // ═══ RENDER OCR CARD ═══
        function renderOCRCard(ocrData) {
            const method = ocrData.method || 'vision';
            const text = ocrData.text || '';
            const structured = ocrData.structuredInfo || {};
            const rawId = 'ocr-raw-' + Date.now();
            
            let html = `<div class="ocr-card">`;
            
            // Header
            html += `
                <div class="ocr-card-header">
                    <span class="icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M23 19a2 2 0 01-2 2H3a2 2 0 01-2-2V8a2 2 0 012-2h4l2-3h6l2 3h4a2 2 0 012 2z"/><circle cx="12" cy="13" r="4"/></svg></span>
                    <span class="ocr-card-header-title">Extraction d'image</span>
                    <span class="ocr-card-header-method">${method === 'vision' ? '✨ IA Vision' : '📝 OCR'}</span>
                </div>`;
            
            // AI Summary / Content
            html += `<div class="ocr-ai-summary">`;
            
            // Clean the text first
            let cleanText = text
                .replace(/\\n/g, '\n')
                .replace(/\\t/g, '\t')
                .replace(/\\"/g, '"');
            
            // Check if text looks like table data (has | separators or multiple columns)
            if (cleanText.includes('|') && cleanText.split('|').length > 5) {
                html += renderOCRTable(cleanText);
            } else if (method === 'vision' && cleanText) {
                // Vision returns formatted text - parse it nicely
                html += parseOCRText(cleanText);
            } else if (cleanText) {
                // Tesseract - show word count and structured data
                const wordCount = cleanText.split(/\s+/).filter(w => w.length > 0).length;
                html += `<p><strong>${wordCount} mots</strong> extraits de l'image.</p>`;
                
                // Show structured info if available
                if (structured && structured.hasData) {
                    html += `<div class="ocr-structured">`;
                    if (structured.brand) html += `<div class="ocr-structured-row"><span class="ocr-structured-label">Marque</span><span class="ocr-structured-value">${escapeHtml(structured.brand)}</span></div>`;
                    if (structured.model) html += `<div class="ocr-structured-row"><span class="ocr-structured-label">Modèle</span><span class="ocr-structured-value mono">${escapeHtml(structured.model)}</span></div>`;
                    if (structured.serial) html += `<div class="ocr-structured-row"><span class="ocr-structured-label">N° série</span><span class="ocr-structured-value mono">${escapeHtml(structured.serial)}</span></div>`;
                    if (structured.errorCodes && structured.errorCodes.length > 0) {
                        html += `<div class="ocr-structured-row"><span class="ocr-structured-label">Code erreur</span><span class="ocr-structured-value error">${structured.errorCodes.join(', ')}</span></div>`;
                    }
                    html += `</div>`;
                }
                
                // Also try to extract structured data from raw text
                if (!structured || !structured.hasData) {
                    html += parseOCRText(cleanText);
                }
            }
            
            html += `</div>`;
            
            // Raw text toggle (for long text)
            if (cleanText && cleanText.length > 300) {
                html += `
                    <div class="ocr-raw-section">
                        <button class="ocr-raw-toggle" onclick="toggleOCRRaw('${rawId}', this)">
                            <span>📄 Voir le texte brut</span>
                            <span class="chevron">▼</span>
                        </button>
                        <div id="${rawId}" class="ocr-raw-content">${escapeHtml(cleanText)}</div>
                    </div>`;
            }
            
            html += `</div>`;
            return html;
        }
        
        // Render table data from OCR
        function renderOCRTable(text) {
            // Split into lines and find table rows
            const lines = text.split('\n').filter(l => l.includes('|'));
            if (lines.length < 2) return parseOCRText(text);
            
            // Parse header and rows
            const parseRow = (line) => line.split('|').map(cell => cell.trim()).filter(c => c);
            const headers = parseRow(lines[0]);
            
            if (headers.length < 2) return parseOCRText(text);
            
            let html = `<div style="overflow-x:auto;"><table class="ocr-table"><thead><tr>`;
            headers.forEach(h => html += `<th>${escapeHtml(h)}</th>`);
            html += `</tr></thead><tbody>`;
            
            // Skip header separator if present (----)
            const dataStart = lines[1].includes('---') ? 2 : 1;
            
            for (let i = dataStart; i < Math.min(lines.length, 20); i++) { // Limit to 20 rows
                const cells = parseRow(lines[i]);
                if (cells.length > 0) {
                    html += `<tr>`;
                    cells.forEach(c => html += `<td>${escapeHtml(c)}</td>`);
                    // Fill empty cells if row is shorter than header
                    for (let j = cells.length; j < headers.length; j++) {
                        html += `<td></td>`;
                    }
                    html += `</tr>`;
                }
            }
            
            html += `</tbody></table></div>`;
            
            if (lines.length > 20) {
                html += `<p style="font-size:11px;color:var(--text-dim);margin-top:8px;">+ ${lines.length - 20} lignes supplémentaires...</p>`;
            }
            
            return html;
        }
        
        // Parse OCR text into nice HTML
        function parseOCRText(text) {
            if (!text) return '';
            
            // First unescape any escaped characters
            let clean = text
                .replace(/\\n/g, '\n')
                .replace(/\\t/g, '\t')
                .replace(/\\"/g, '"');
            
            // Check if it's already HTML - if so, strip it and parse fresh
            if (clean.includes('<div class=') || clean.includes('<span class=')) {
                // Extract just the text content by removing HTML tags
                clean = clean.replace(/<[^>]+>/g, ' ').replace(/\s+/g, ' ').trim();
            }
            
            let html = escapeHtml(clean);
            
            // Headers (## RÉSUMÉ, ## ANALYSE, etc.)
            html = html.replace(/^##\s+(.*)$/gm, '</p><h2>$1</h2><p>');
            html = html.replace(/^#\s+(.*)$/gm, '</p><h2>$1</h2><p>');
            
            // Bold
            html = html.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            
            // Field extraction (- Marque: xxx, - Modèle: xxx)
            html = html.replace(/^[-•]\s*(Marque|Modèle|N°\s*série|Puissance|Tension|Réfrigérant|Code erreur|Référence|Désignation)\s*:\s*(.*)$/gim, 
                '<div class="ocr-structured-row"><span class="ocr-structured-label">$1</span><span class="ocr-structured-value">$2</span></div>');
            
            // Regular list items
            html = html.replace(/^[-•]\s+(.*)$/gm, '<li>$1</li>');
            html = html.replace(/(<li>.*<\/li>\n?)+/g, '<ul>$&</ul>');
            
            // Paragraphs
            html = html.replace(/\n\n+/g, '</p><p>');
            html = html.replace(/\n/g, '<br>');
            
            // Wrap if needed
            if (!html.startsWith('<h') && !html.startsWith('<ul') && !html.startsWith('<div') && !html.startsWith('</p>')) {
                html = '<p>' + html + '</p>';
            }
            
            // Cleanup
            html = html.replace(/<p><\/p>/g, '');
            html = html.replace(/<p><br><\/p>/g, '');
            html = html.replace(/<\/p><p>/g, '</p><p>');
            html = html.replace(/^<\/p>/g, '');
            html = html.replace(/<p>$/g, '');
            
            return html;
        }
        
        // Toggle raw OCR text
        function toggleOCRRaw(id, btn) {
            const el = document.getElementById(id);
            if (el) {
                el.classList.toggle('show');
                btn.classList.toggle('open');
            }
        }

        // ═══ RENDER STRUCTURED REPORT - Matches Technician App Exactly ═══
        function renderStructuredReport(data) {
            currentReportData = data;
            const has = (val) => val && (Array.isArray(val) ? val.length > 0 : (typeof val === 'object' ? Object.keys(val).length > 0 : true));
            const esc = (str) => str ? String(str).replace(/</g, '&lt;').replace(/>/g, '&gt;') : '';
            const brandClass = data.brand_key || currentProjectData?.brand?.toLowerCase() || 'general';
            
            // Status
            let statusClass = 'en-cours', statusText = 'En cours';
            if (data.status) {
                const s = data.status.toLowerCase();
                if (s.includes('conforme') && !s.includes('non')) { statusClass = 'conforme'; statusText = 'Conforme'; }
                else if (s.includes('non') || s.includes('refus')) { statusClass = 'non-conforme'; statusText = 'Non conforme'; }
                else statusText = data.status;
            }

            let html = `<div class="rpt">`;
            
            // ═══ HEADER ═══
            html += `
            <div class="rpt-header">
                <div class="rpt-header-top">
                    <div>
                        <div class="rpt-brand ${brandClass}">${esc(data.brand || 'FixAIR')}</div>
                        <h1 class="rpt-title">Rapport d'intervention</h1>
                    </div>
                    <div class="rpt-status ${statusClass}">
                        <span class="rpt-status-dot"></span>
                        <span class="rpt-status-text">${esc(statusText)}</span>
                    </div>
                </div>
                <div class="rpt-meta">
                    ${data.reference ? `<span>Réf <span class="val">${esc(data.reference)}</span></span>` : ''}
                    ${data.type_intervention ? `<span>Type <span class="val">${esc(data.type_intervention)}</span></span>` : ''}
                    ${data.date ? `<span>Date <span class="val">${esc(data.date)}</span></span>` : ''}
                </div>
            </div>`;
            
            // ═══ MAIN CARD ═══
            html += `<div class="rpt-card">`;
            
            // 1. RÉSUMÉ
            if (has(data.resume)) {
                const resumeText = data.resume.replace(/NON CONFORME/gi, '<strong class="err">NON CONFORME</strong>')
                                              .replace(/CONFORME/gi, '<strong class="ok">CONFORME</strong>');
                html += `
                <div class="rpt-section">
                    <div class="rpt-label">Résumé</div>
                    <p class="rpt-text">${resumeText}</p>
                </div>`;
            }
            
            // 2. CLIENT
            if (has(data.client)) {
                html += `
                <div class="rpt-section">
                    <div class="rpt-label">Client</div>`;
                if (data.client.societe) html += `<div class="rpt-row"><span class="rpt-row-label">Société</span><span class="rpt-row-value">${esc(data.client.societe)}</span></div>`;
                if (data.client.dossier) html += `<div class="rpt-row"><span class="rpt-row-label">N° Dossier</span><span class="rpt-row-value mono">${esc(data.client.dossier)}</span></div>`;
                if (data.client.contact) html += `<div class="rpt-row"><span class="rpt-row-label">Contact</span><span class="rpt-row-value">${esc(data.client.contact)}</span></div>`;
                if (data.client.telephone) html += `<div class="rpt-row"><span class="rpt-row-label">Téléphone</span><span class="rpt-row-value">${esc(data.client.telephone)}</span></div>`;
                html += `</div>`;
            }
            
            // 3. SYSTÈME
            if (has(data.systeme)) {
                html += `
                <div class="rpt-section">
                    <div class="rpt-label">Système</div>`;
                if (data.systeme.type) html += `<div class="rpt-row"><span class="rpt-row-label">Type</span><span class="rpt-row-value">${esc(data.systeme.type)}</span></div>`;
                if (data.systeme.modele) html += `<div class="rpt-row"><span class="rpt-row-label">Modèle UE</span><span class="rpt-row-value mono">${esc(data.systeme.modele)}</span></div>`;
                if (data.systeme.serie) html += `<div class="rpt-row"><span class="rpt-row-label">N° Série</span><span class="rpt-row-value mono">${esc(data.systeme.serie)}</span></div>`;
                if (data.systeme.fluide) html += `<div class="rpt-row"><span class="rpt-row-label">Fluide</span><span class="rpt-row-value">${esc(data.systeme.fluide)}</span></div>`;
                html += `</div>`;
            }
            
            // 4. TRAVAUX EFFECTUÉS
            if (has(data.travaux_effectues)) {
                html += `
                <div class="rpt-section">
                    <div class="rpt-label">Travaux effectués</div>
                    <div class="rpt-list">`;
                data.travaux_effectues.forEach(t => {
                    const text = typeof t === 'string' ? t : (t.texte || t.text || t.description || t.label || '');
                    const status = typeof t === 'object' ? t.status : 'done';
                    const isDone = status === 'done' || t.fait === true || t.fait === 'oui';
                    const isError = status === 'error' || t.fait === false || t.fait === 'non';
                    const iconClass = isDone ? 'done' : (isError ? 'error' : 'pending');
                    const iconChar = isDone ? '✓' : (isError ? '✗' : '→');
                    html += `
                        <div class="rpt-item">
                            <span class="rpt-icon ${iconClass}">${iconChar}</span>
                            <span class="rpt-item-text">${esc(text)}</span>
                        </div>`;
                });
                html += `</div></div>`;
            }
            
            // 5. MESURES
            if (has(data.mesures)) {
                html += `
                <div class="rpt-section">
                    <div class="rpt-label">Mesures</div>
                    <div class="rpt-measures">`;
                
                // Handle both array and object formats
                const measuresArray = Array.isArray(data.mesures) ? data.mesures : 
                    Object.entries(data.mesures).map(([k, v]) => ({ label: k, valeur: v, nom: k, value: v }));
                
                measuresArray.forEach(m => {
                    const label = m.label || m.nom || '';
                    const value = m.valeur || m.value || '';
                    const note = m.note || m.cible || '';
                    const status = m.status || (String(value).toLowerCase().includes('hs') ? 'error' : 'neutral');
                    const valClass = status === 'ok' ? 'ok' : (status === 'error' ? 'error' : 'neutral');
                    const noteClass = status === 'ok' ? 'ok' : (status === 'error' ? 'error' : '');
                    html += `
                        <div class="rpt-measure">
                            <div class="rpt-measure-info">
                                <div class="rpt-measure-name">${esc(label)}</div>
                                ${note ? `<div class="rpt-measure-note ${noteClass}">${esc(note)}</div>` : ''}
                            </div>
                            <div class="rpt-measure-val ${valClass}">${esc(value)}</div>
                        </div>`;
                });
                html += `</div></div>`;
            }
            
            // 6. RÉSULTAT
            if (has(data.resultat)) {
                const r = typeof data.resultat === 'object' ? data.resultat : { statut: data.resultat };
                const statut = r.statut || r.status || data.status || '';
                const isResolved = statut.toLowerCase().includes('résolu') && !statut.toLowerCase().includes('non');
                const resClass = isResolved ? 'ok' : 'err';
                const resText = isResolved ? 'Résolu' : 'Non résolu';
                const label = r.label || r.titre || (statut.includes('—') ? statut.split('—')[1]?.trim() : '');
                const description = r.description || r.texte || '';
                
                html += `
                <div class="rpt-section">
                    <div class="rpt-label">Résultat</div>
                    <div class="rpt-result-status">
                        <span class="${resClass}">${resText}</span>
                        ${label ? `<span class="lbl"> — ${esc(label)}</span>` : ''}
                    </div>
                    ${description ? `<div class="rpt-result-desc">${esc(description)}</div>` : ''}
                </div>`;
            }
            
            html += `</div></div>`;
            return html;
        }

        // ═══ DASHBOARD ═══
        function updateDashboard() {
            // Stats - show technicians count
            document.getElementById('statTechnicians').textContent = allTechnicians.length;
            const pendingTechs = allTechnicians.filter(u => !u.status || u.status === 'pending').length;
            document.getElementById('statTechniciansTrend').textContent = pendingTechs > 0 ? `${pendingTechs} en attente` : 'Tous approuvés';
            
            // Stats - show enterprises count
            document.getElementById('statProjects').textContent = allEnterprises.length;
            const pendingEnts = allEnterprises.filter(u => !u.status || u.status === 'pending').length;
            document.getElementById('statProjectsTrend').textContent = pendingEnts > 0 ? `${pendingEnts} en attente` : `${allProjects.length} projets`;
            
            updateTechniciansListHome();
            renderEnterprisesHome();
        }

        function updateTechniciansListHome() {
            const container = document.getElementById('techniciansListHome');
            if (allTechnicians.length === 0) { 
                container.innerHTML = '<div class="empty-state"><div class="empty-title">Aucun technicien</div></div>'; 
                return; 
            }
            container.innerHTML = allTechnicians.slice(0, 4).map(u => buildTechnicianCard(u)).join('');
        }

        function renderEnterprisesHome() {
            const container = document.getElementById('enterprisesListHome');
            if (allEnterprises.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-title">Aucune entreprise</div></div>';
                return;
            }
            container.innerHTML = allEnterprises.slice(0, 4).map(e => buildEnterpriseCard(e)).join('');
        }
        
        function buildEnterpriseCard(enterprise, onclick) {
            const companyName = enterprise.company_name || enterprise.company || enterprise.business_name || enterprise.first_name || enterprise.name || 'Entreprise';
            const initials = getInitials(companyName);
            const status = enterprise.status || 'pending';
            const plan = enterprise.subscribed || enterprise.plan || enterprise.subscription_plan || 'Free';
            const planCapitalized = plan.charAt(0).toUpperCase() + plan.slice(1);
            const planClass = plan.toLowerCase().replace(/\s+/g, '');
            
            // Count ALL users linked to this enterprise - REAL data from Supabase
            const enterpriseUsers = allUsers.filter(u => u.enterprise_id === enterprise.id || u.company_id === enterprise.id);
            const adminCount = enterpriseUsers.filter(u => (u.role || '').toLowerCase() === 'admin').length;
            const managerCount = enterpriseUsers.filter(u => (u.role || '').toLowerCase() === 'manager').length;
            const techCount = enterpriseUsers.filter(u => (u.role || 'technician').toLowerCase() === 'technician').length;
            
            // Count projects from all enterprise users
            const enterpriseUserIds = enterpriseUsers.map(u => u.id);
            const projectCount = allProjects.filter(p => enterpriseUserIds.includes(p.user_id)).length;
            
            const clickFn = onclick || `openHomeDrawer('enterprise','${enterprise.id}')`;
            
            // Build meta info - REAL data from Supabase
            let metaInfo = '';
            if (status === 'pending') {
                // For pending: show admin name (Admin)
                const adminName = enterprise.first_name || enterprise.name || '';
                metaInfo = adminName ? `${adminName} (Admin)` : 'En attente de validation';
            } else {
                // For approved: ALWAYS show all counts - admin • managers • techs • projets
                metaInfo = `${adminCount} admin${adminCount > 1 ? 's' : ''} • ${managerCount} manager${managerCount > 1 ? 's' : ''} • ${techCount} tech${techCount > 1 ? 's' : ''} • ${projectCount} projet${projectCount > 1 ? 's' : ''}`;
            }
            
            // Build right section with hover actions for pending
            let rightContent = '';
            if (status === 'pending') {
                rightContent = `
                    <span class="enterprise-badge pending">En attente</span>
                    <div class="card-hover-actions">
                        <button class="card-action-btn approve" onclick="event.stopPropagation(); quickApprove('enterprise', '${enterprise.id}')" title="Approuver">✓</button>
                        <button class="card-action-btn reject" onclick="event.stopPropagation(); quickReject('enterprise', '${enterprise.id}')" title="Rejeter">✕</button>
                    </div>`;
            } else {
                rightContent = `<span class="enterprise-badge ${planClass}">${planCapitalized}</span>`;
            }
            
            return `<div class="enterprise-card ${status === 'pending' ? 'pending' : ''}" onclick="${clickFn}">
                <div class="enterprise-logo">${initials}</div>
                <div class="enterprise-info">
                    <div class="enterprise-name">${companyName}</div>
                    <div class="enterprise-meta">${metaInfo}</div>
                </div>
                <div class="enterprise-right">
                    ${rightContent}
                </div>
            </div>`;
        }

        function updateSettingsPage() {
            document.getElementById('settingsUserCount').textContent = allUsers.length;
            document.getElementById('settingsProjectCount').textContent = allProjects.length;
            document.getElementById('settingsChatCount').textContent = allChats.length;
        }

        // ═══ NAV ═══
        function goHome() { document.querySelectorAll('.full-page').forEach(p => p.classList.remove('active')); document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active')); document.querySelector('.nav-item').classList.add('active'); }
        function openPage(page) { document.querySelectorAll('.full-page').forEach(p => p.classList.remove('active')); const el = document.getElementById('page' + page.charAt(0).toUpperCase() + page.slice(1)); if (el) el.classList.add('active'); if (page === 'users') populateUsersList(); if (page === 'enterprises') populateEnterprisesList(); }
        function closePage() { document.querySelectorAll('.full-page').forEach(p => p.classList.remove('active', 'drawer-open')); goHome(); }

        // ═══ CARDS ═══
        function buildTechnicianCard(user, onclick) {
            const initials = getInitials(user.first_name || user.name || user.email);
            const status = user.status || 'pending';
            const role = (user.role || 'technician').toLowerCase();
            const clickFn = onclick || `openHomeDrawer('technician','${user.id}')`;
            
            // ═══ ONLINE STATUS - Real data from Supabase ═══
            // The Technician App updates: live_status + updated_at
            // Priority: live_status (primary) > timestamps (fallback)
            // 🟢 online = live_status === 'online'
            // 🟠 idle = live_status === 'idle'
            // ⚫ offline = live_status === 'offline' or not set
            let onlineStatus = 'offline';
            const now = new Date();
            const fiveMinutesAgo = new Date(now - 5 * 60 * 1000);
            const thirtyMinutesAgo = new Date(now - 30 * 60 * 1000);
            
            // Check live_status first (updated by Technician App)
            if (user.live_status === 'online') {
                onlineStatus = 'online';
            } else if (user.live_status === 'idle') {
                onlineStatus = 'idle';
            } else if (user.live_status === 'offline') {
                onlineStatus = 'offline';
            } else {
                // Fallback: check timestamps if live_status not set
                // Priority: updated_at (updated with live_status) > last_seen_at > last_login
                const lastActivity = user.updated_at || user.last_seen_at || user.last_login;
                if (lastActivity) {
                    const lastTime = new Date(lastActivity);
                    if (lastTime >= fiveMinutesAgo) {
                        onlineStatus = 'online';
                    } else if (lastTime >= thirtyMinutesAgo) {
                        onlineStatus = 'idle';
                    } else {
                        onlineStatus = 'offline';
                    }
                } else if (user.is_active === true) {
                    onlineStatus = 'online';
                } else if (user.is_active === false) {
                    onlineStatus = 'idle';
                }
            }
            
            // Role badge display
            const roleDisplay = role === 'admin' ? 'Admin' : (role === 'manager' ? 'Manager' : 'Tech');
            const roleClass = role === 'admin' ? 'admin' : (role === 'manager' ? 'manager' : 'tech');
            
            // Avatar color based on role
            let avatarStyle = '';
            if (role === 'admin') {
                avatarStyle = 'background: rgba(139, 92, 246, 0.15); color: #a78bfa;';
            } else if (role === 'manager') {
                avatarStyle = 'background: var(--assistant-bg); color: var(--assistant);';
            } else {
                avatarStyle = 'background: var(--copilot-bg); color: var(--copilot);';
            }
            
            // ═══ META INFO - Real data from Supabase ═══
            let metaInfo = '';
            if (status === 'pending') {
                // For pending users: show type
                if (role === 'technician' && !user.company_id && !user.enterprise_id) {
                    metaInfo = 'Technicien indépendant';
                } else {
                    metaInfo = `${roleDisplay} en attente`;
                }
            } else {
                // For approved users: show different info based on role
                if (role === 'admin') {
                    // Admin: show managers count + techs count + projects count
                    const companyUsers = allUsers.filter(u => u.company_id === user.company_id || u.enterprise_id === user.enterprise_id);
                    const managerCount = companyUsers.filter(u => (u.role || '').toLowerCase() === 'manager').length;
                    const techCount = companyUsers.filter(u => (u.role || 'technician').toLowerCase() === 'technician').length;
                    const projectCount = allProjects.filter(p => companyUsers.some(u => u.id === p.user_id)).length;
                    metaInfo = `${managerCount} manager${managerCount > 1 ? 's' : ''} • ${techCount} tech${techCount > 1 ? 's' : ''} • ${projectCount} projet${projectCount > 1 ? 's' : ''}`;
                } else if (role === 'manager') {
                    // Manager: show techs count + projects count
                    const teamTechs = allUsers.filter(u => u.manager_id === user.id).length;
                    const teamProjects = allProjects.filter(p => {
                        const pUser = allUsers.find(u => u.id === p.user_id);
                        return pUser && pUser.manager_id === user.id;
                    }).length;
                    metaInfo = `${teamTechs} technicien${teamTechs > 1 ? 's' : ''} • ${teamProjects} projet${teamProjects > 1 ? 's' : ''}`;
                } else {
                    // Technician: show projects count + REAL last activity from Supabase
                    const userProjects = allProjects.filter(p => p.user_id === user.id).length;
                    
                    // ═══ ACTIVITY DISPLAY LOGIC ═══
                    // If user is ONLINE (green dot) → show "Actif maintenant"
                    // If user is IDLE (orange dot) → show "Inactif depuis X"
                    // If user is OFFLINE (gray dot) → show "Actif il y a X"
                    let activityText = '';
                    
                    if (onlineStatus === 'online') {
                        // User is currently online - show "Actif maintenant"
                        activityText = 'Actif maintenant';
                    } else if (onlineStatus === 'idle') {
                        // User is idle - show since when
                        // Use updated_at since Technician App updates it with live_status
                        const idleTime = user.updated_at || user.last_seen_at;
                        if (idleTime) {
                            activityText = 'Inactif ' + formatTimeAgo(idleTime);
                        } else {
                            activityText = 'Inactif';
                        }
                    } else {
                        // User is offline - show last activity time
                        // Priority: updated_at (updated by Technician App) > last_seen_at > last_login
                        const lastActivityDate = user.updated_at || user.last_seen_at || user.last_login;
                        
                        if (lastActivityDate) {
                            activityText = 'Actif ' + formatTimeAgo(lastActivityDate);
                        }
                    }
                    
                    metaInfo = `${userProjects} projet${userProjects > 1 ? 's' : ''}${activityText ? ' • ' + activityText : ''}`;
                }
            }
            
            // Build right section
            let rightContent = '';
            if (status === 'pending') {
                rightContent = `
                    <span class="status-badge-pending">En attente</span>
                    <div class="card-hover-actions">
                        <button class="card-action-btn approve" onclick="event.stopPropagation(); quickApprove('user', '${user.id}')" title="Approuver">✓</button>
                        <button class="card-action-btn reject" onclick="event.stopPropagation(); quickReject('user', '${user.id}')" title="Rejeter">✕</button>
                    </div>`;
            } else {
                rightContent = `<span class="role-tag ${roleClass}">${roleDisplay}</span>`;
            }
            
            return `<div class="technician-card ${status === 'pending' ? 'pending' : ''}" onclick="${clickFn}">
                <div class="technician-avatar" style="${avatarStyle}">${initials}<div class="technician-status ${onlineStatus}"></div></div>
                <div class="technician-info">
                    <div class="technician-name">${user.first_name || user.name || 'Sans nom'}</div>
                    <div class="technician-meta">${metaInfo}</div>
                </div>
                <div class="technician-right">
                    ${rightContent}
                </div>
            </div>`;
        }

        function buildProjectCard(project) {
            const chats = allChats.filter(c => c.project_id === project.id);
            const hasCopilot = chats.some(c => c.type === 'copilot' || c.chat_type === 'copilot');
            const hasAssistant = chats.some(c => c.type === 'assistant' || c.chat_type === 'assistant');
            // SVG icons
            const starIcon = `<svg viewBox="0 0 200 200"><path d="M100.2 0C101.792 25.9476 98.6996 63.9402 117.082 82.3225C135.464 100.705 174.052 98.2076 200 99.8V100.2C174.051 101.79 135.763 98.9969 117.38 117.38C98.997 135.763 101.79 174.051 100.2 200H99.8C98.2103 174.051 100.109 136.06 81.7264 117.678C63.3436 99.2949 25.9485 101.79 0 100.2V99.8C25.9476 98.2076 63.6424 100.406 82.0246 82.0242C100.407 63.642 98.2076 25.9476 99.8 0H100.2Z"/></svg>`;
            const clipIcon = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><rect x="8" y="2" width="8" height="4" rx="1" ry="1"/><path d="M9 14l2 2 4-4"/></svg>`;
            
            // Determine bar class based on chat types
            const hasBoth = hasCopilot && hasAssistant;
            let barClass = 'copilot-bar';
            if (hasBoth) barClass = 'both-bar';
            else if (hasAssistant) barClass = 'assistant-bar';
            
            // Icon HTML based on modes used
            let iconHtml = '';
            if (hasBoth) {
                iconHtml = `<div class="proj-icons dual">
                    <div class="proj-icon copilot back"><span class="star-icon">${starIcon}</span></div>
                    <div class="proj-icon assistant front"><span class="icon">${clipIcon}</span></div>
                </div>`;
            } else if (hasAssistant) {
                iconHtml = `<div class="proj-icon assistant"><span class="icon">${clipIcon}</span></div>`;
            } else {
                iconHtml = `<div class="proj-icon copilot"><span class="star-icon">${starIcon}</span></div>`;
            }
            
            // Mode label
            const modeLabel = hasBoth ? 'Diagnostic + Rapport' : (hasAssistant ? 'Rapport' : 'Diagnostic');
            
            // Brand display with history if changed
            let brandDisplay = '';
            if (project.brand) {
                const brandLabel = project.brand.charAt(0).toUpperCase() + project.brand.slice(1);
                if (project.original_brand && project.original_brand !== project.brand) {
                    const originalLabel = project.original_brand.charAt(0).toUpperCase() + project.original_brand.slice(1);
                    brandDisplay = `${originalLabel} → ${brandLabel}`;
                } else {
                    brandDisplay = brandLabel;
                }
            }
            
            return `<div class="proj ${barClass}" onclick="openProjectView('${project.id}')">
                ${iconHtml}
                <div class="proj-info">
                    <div class="proj-title">${project.title || 'Projet sans titre'}</div>
                    <div class="proj-meta">${modeLabel}${brandDisplay ? ' • ' + brandDisplay : ''}</div>
                </div>
                <span class="proj-time">${formatTimeAgo(project.updated_at)}</span>
            </div>`;
        }

        // ═══ DRAWERS ═══
        function openHomeDrawer(type, id) {
            document.getElementById('homeWrapper').classList.add('drawer-open');
            if (type === 'enterprise') {
                const enterprise = allEnterprises.find(e => e.id === id);
                if (!enterprise) return;
                selectedUserId = id;
                
                const companyName = enterprise.company_name || enterprise.company || enterprise.business_name || enterprise.first_name || enterprise.name || 'Entreprise';
                const status = enterprise.status || 'pending';
                const plan = enterprise.subscribed || enterprise.plan || enterprise.subscription_plan || 'Free';
                const planCapitalized = plan.charAt(0).toUpperCase() + plan.slice(1);
                const techCount = allTechnicians.filter(t => t.enterprise_id === enterprise.id || t.company_id === enterprise.id).length;
                
                document.getElementById('homeDrawerTitle').textContent = companyName;
                document.getElementById('homeDrawerSubtitle').textContent = `${techCount} techniciens • ${enterprise.email}`;
                document.getElementById('homeDrawerBadge').textContent = status === 'pending' ? 'En attente' : planCapitalized;
                document.getElementById('homeDrawerBadge').className = 'drawer-badge ' + (status === 'pending' ? 'pending' : plan.toLowerCase());
                document.getElementById('homeDrawerBody').innerHTML = buildEnterpriseDrawerContent(enterprise);
                document.getElementById('homeDrawerFooter').innerHTML = `
                    <button class="drawer-btn danger" onclick="suspendEnterprise('${id}')">Suspendre</button>
                    <button class="drawer-btn secondary" onclick="closeHomeDrawer()">Fermer</button>
                    <button class="drawer-btn primary" id="saveStatusBtn" onclick="saveStatus()">Enregistrer</button>`;
            } else if (type === 'technician') {
                const user = allTechnicians.find(u => u.id === id) || allUsers.find(u => u.id === id); 
                if (!user) return;
                selectedUserId = id;
                document.getElementById('homeDrawerTitle').textContent = user.first_name || user.name || 'Sans nom';
                document.getElementById('homeDrawerSubtitle').textContent = user.email;
                const status = user.status || 'pending';
                document.getElementById('homeDrawerBadge').textContent = formatStatus(status);
                document.getElementById('homeDrawerBadge').className = 'drawer-badge ' + status;
                document.getElementById('homeDrawerBody').innerHTML = buildTechnicianDrawerContent(user);
                document.getElementById('homeDrawerFooter').innerHTML = `<button class="drawer-btn secondary" onclick="closeHomeDrawer()">Fermer</button><button class="drawer-btn primary" id="saveStatusBtn" onclick="saveStatus()">Enregistrer</button>`;
            }
        }
        
        function suspendEnterprise(id) {
            if (confirm('Êtes-vous sûr de vouloir suspendre cette entreprise ?')) {
                selectStatus('suspended');
            }
        }
        function closeHomeDrawer() { document.getElementById('homeWrapper').classList.remove('drawer-open'); selectedUserId = null; }
        function openPageDrawer(page, action, id) {
            document.getElementById('page' + page.charAt(0).toUpperCase() + page.slice(1)).classList.add('drawer-open');
            if (page === 'users') {
                const user = allUsers.find(u => u.id === id); if (!user) return;
                selectedUserId = id;
                document.getElementById('usersDrawerTitle').textContent = user.first_name || user.name || 'Sans nom';
                document.getElementById('usersDrawerSubtitle').textContent = user.email;
                const status = user.status || 'pending';
                const role = (user.role || 'technician').toLowerCase();
                const roleDisplay = role === 'admin' ? 'Admin' : (role === 'manager' ? 'Manager' : 'Technicien');
                document.getElementById('usersDrawerBadge').textContent = roleDisplay;
                document.getElementById('usersDrawerBadge').className = 'drawer-badge role-' + role;
                document.getElementById('usersDrawerBody').innerHTML = buildTechnicianDrawerContent(user);
                document.getElementById('usersDrawerFooter').innerHTML = `<button class="drawer-btn secondary" onclick="closePageDrawer('users')">Fermer</button><button class="drawer-btn primary" id="saveStatusBtn" onclick="saveStatus()">Enregistrer</button>`;
            } else if (page === 'enterprises') {
                const enterprise = allEnterprises.find(e => e.id === id); if (!enterprise) return;
                selectedUserId = id;
                const companyName = enterprise.company_name || enterprise.company || enterprise.first_name || 'Entreprise';
                const status = enterprise.status || 'pending';
                const plan = enterprise.subscribed || enterprise.plan || 'Free';
                const planCapitalized = plan.charAt(0).toUpperCase() + plan.slice(1);
                const techCount = allTechnicians.filter(t => t.enterprise_id === enterprise.id || t.company_id === enterprise.id).length;
                
                document.getElementById('enterprisesDrawerTitle').textContent = companyName;
                document.getElementById('enterprisesDrawerSubtitle').textContent = `${techCount} techniciens • ${enterprise.email}`;
                document.getElementById('enterprisesDrawerBadge').textContent = status === 'pending' ? 'En attente' : planCapitalized;
                document.getElementById('enterprisesDrawerBadge').className = 'drawer-badge ' + (status === 'pending' ? 'pending' : plan.toLowerCase());
                document.getElementById('enterprisesDrawerBody').innerHTML = buildEnterpriseDrawerContent(enterprise);
                document.getElementById('enterprisesDrawerFooter').innerHTML = `
                    <button class="drawer-btn danger" onclick="suspendEnterprise('${id}')">Suspendre</button>
                    <button class="drawer-btn secondary" onclick="closePageDrawer('enterprises')">Fermer</button>
                    <button class="drawer-btn primary" id="saveStatusBtn" onclick="saveStatus()">Enregistrer</button>`;
            }
        }
        function closePageDrawer(page) { document.getElementById('page' + page.charAt(0).toUpperCase() + page.slice(1)).classList.remove('drawer-open'); selectedUserId = null; }

        function buildTechnicianDrawerContent(user) {
            const status = user.status || 'pending';
            const role = (user.role || 'technician').toLowerCase();
            const roleDisplay = role === 'admin' ? 'Administrateur' : (role === 'manager' ? 'Manager' : 'Technicien');
            const userProjects = allProjects.filter(p => p.user_id === user.id);
            const userChats = allChats.filter(c => userProjects.some(p => p.id === c.project_id));
            
            const statusIcon = status === 'approved' ? '✓' : (status === 'rejected' ? '✗' : (status === 'suspended' ? '⊘' : '⏱'));
            const statusLabel = formatStatus(status);
            
            // Load email history after a short delay
            setTimeout(() => loadEmailHistory(user.id), 150);
            
            return `
                <div class="info-card">
                    <div class="info-card-title">Informations</div>
                    <div class="info-row"><span class="info-label">Email</span><span class="info-value">${user.email}</span></div>
                    <div class="info-row"><span class="info-label">Téléphone</span><span class="info-value">${user.phone || user.phone_number || '-'}</span></div>
                    <div class="info-row"><span class="info-label">Rôle</span><span class="info-value">${roleDisplay}</span></div>
                    <div class="info-row"><span class="info-label">Créé le</span><span class="info-value">${formatDate(user.created_at)}</span></div>
                    <div class="info-row">
                        <span class="info-label">Statut</span>
                        <div class="status-dropdown-wrapper">
                            <span class="status-tag ${status}" onclick="toggleStatusDropdown(event)">${statusIcon} ${statusLabel} <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg></span>
                            <div class="status-dropdown" id="statusDropdown">
                                <div class="status-dropdown-item" onclick="selectStatusFromDropdown('pending')"><span class="dot pending"></span>En attente</div>
                                <div class="status-dropdown-item" onclick="selectStatusFromDropdown('approved')"><span class="dot approved"></span>Approuvé</div>
                                <div class="status-dropdown-item" onclick="selectStatusFromDropdown('rejected')"><span class="dot rejected"></span>Rejeté</div>
                            </div>
                            <input type="hidden" id="statusSelect" value="${status}">
                        </div>
                    </div>
                </div>
                <div class="info-card">
                    <div class="info-card-title">Statistiques</div>
                    <div class="info-row"><span class="info-label">Projets</span><span class="info-value orange">${userProjects.length}</span></div>
                    <div class="info-row"><span class="info-label">Chats</span><span class="info-value blue">${userChats.length}</span></div>
                </div>
                <div class="info-card">
                    <div class="info-card-title">Projets (${userProjects.length})</div>
                    <div class="card-list">${userProjects.length > 0 ? userProjects.map(p => buildProjectCard(p)).join('') : '<div style="text-align:center;padding:20px;color:var(--text-dim);font-size:12px;">Aucun projet</div>'}</div>
                </div>
                
                <div class="email-card" id="emailCard-${user.id}">
                    <div class="email-card-header">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg>
                        <span>Communication Email</span>
                    </div>
                    <div class="email-form-group">
                        <label class="email-form-label">Sujet</label>
                        <input type="text" class="email-form-input" id="emailSubject-${user.id}" placeholder="Ex: Suivi de votre diagnostic">
                    </div>
                    <div class="email-form-group">
                        <label class="email-form-label">Message</label>
                        <textarea class="email-form-input email-form-textarea" id="emailContent-${user.id}" placeholder="Écrivez votre message ici...&#10;&#10;Astuce: Vous pouvez ajouter des liens avec &lt;a href='URL'&gt;texte&lt;/a&gt;"></textarea>
                    </div>
                    <div class="email-form-group">
                        <label class="email-form-label" style="display:flex;align-items:center;justify-content:space-between;">
                            <span>Signature (HTML optionnel)</span>
                            <span style="font-size:9px;color:var(--master);cursor:pointer;" onclick="toggleSignatureField('${user.id}')">▼ Personnaliser</span>
                        </label>
                        <div id="signatureWrapper-${user.id}" style="display:none;">
                            <textarea class="email-form-input email-form-textarea" id="emailSignature-${user.id}" style="min-height:80px;font-family:monospace;font-size:11px;" placeholder="HTML signature (avec images, logos, etc.)&#10;&#10;Exemple:&#10;&lt;img src='https://...' width='100' /&gt;&#10;&lt;div&gt;Votre nom&lt;/div&gt;"></textarea>
                            <div style="font-size:10px;color:var(--text-dim);margin-top:4px;">💡 Laissez vide pour utiliser la signature FixAIR par défaut</div>
                        </div>
                    </div>
                    <button class="email-send-btn" id="emailSendBtn-${user.id}" onclick="sendEmailToUser('${user.id}')">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/></svg>
                        Envoyer l'email
                    </button>
                    
                    <div class="email-history">
                        <div class="email-history-header">
                            <span class="email-history-title">Historique des emails</span>
                            <span class="email-history-count" id="emailCount-${user.id}">0</span>
                        </div>
                        <div class="email-list" id="emailList-${user.id}">
                            <div class="email-empty">Chargement...</div>
                        </div>
                    </div>
                </div>`;
        }
        
        function buildEnterpriseDrawerContent(enterprise) {
            const status = enterprise.status || 'pending';
            const plan = enterprise.subscribed || enterprise.plan || enterprise.subscription_plan || 'Free';
            const planCapitalized = plan.charAt(0).toUpperCase() + plan.slice(1);
            const companyName = enterprise.company_name || enterprise.company || enterprise.business_name || enterprise.first_name || enterprise.name || 'Entreprise';
            const adminName = enterprise.first_name ? `${enterprise.first_name} ${enterprise.last_name || ''}`.trim() : (enterprise.name || companyName);
            const techsLinked = allTechnicians.filter(t => t.enterprise_id === enterprise.id || t.company_id === enterprise.id);
            const projectCount = allProjects.filter(p => p.user_id === enterprise.id).length;
            
            // Calculate plan progress (mock for now - 70% of billing cycle)
            const progressPercent = 70;
            const nextPayment = new Date();
            nextPayment.setMonth(nextPayment.getMonth() + 1);
            nextPayment.setDate(1);
            const planPrices = { 'Free': '€0/mois', 'free': '€0/mois', 'Starter': '€49/mois', 'starter': '€49/mois', 'Pro': '€149/mois', 'pro': '€149/mois', 'Master': '€399/mois', 'master': '€399/mois' };
            
            return `
                <div class="plan-card">
                    <div class="plan-card-header">
                        <span class="plan-name">${planCapitalized} Plan</span>
                        <span class="plan-price">${planPrices[plan] || '€0/mois'}</span>
                    </div>
                    <div class="plan-progress">
                        <div class="plan-progress-fill" style="width: ${progressPercent}%"></div>
                    </div>
                    <div class="plan-next">Prochain paiement: ${formatDate(nextPayment)}</div>
                </div>
                
                <div class="info-card">
                    <div class="info-card-title">Informations</div>
                    <div class="info-row"><span class="info-label">Email</span><span class="info-value">${enterprise.email}</span></div>
                    <div class="info-row"><span class="info-label">Téléphone</span><span class="info-value">${enterprise.phone || enterprise.phone_number || enterprise.telephone || '-'}</span></div>
                    <div class="info-row"><span class="info-label">Langue</span><span class="info-value">${enterprise.language === 'fr' ? 'Français' : (enterprise.language === 'en' ? 'English' : enterprise.language || '-')}</span></div>
                    <div class="info-row"><span class="info-label">Email confirmé</span><span class="info-value ${enterprise.email_confirmed ? 'green' : 'yellow'}">${enterprise.email_confirmed ? '✓ Oui' : '✗ Non'}</span></div>
                    <div class="info-row"><span class="info-label">Actif</span><span class="info-value ${enterprise.is_active ? 'green' : 'red'}">${enterprise.is_active ? '✓ Oui' : '✗ Non'}</span></div>
                    <div class="info-row"><span class="info-label">Créé le</span><span class="info-value">${formatDate(enterprise.created_at)}</span></div>
                    <div class="info-row">
                        <span class="info-label">Statut</span>
                        <div class="status-dropdown-wrapper">
                            <span class="status-tag ${status}" onclick="toggleStatusDropdown(event)">${status === 'approved' ? '✓' : (status === 'rejected' ? '✗' : (status === 'suspended' ? '⊘' : '⏱'))} ${formatStatus(status)} <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg></span>
                            <div class="status-dropdown" id="statusDropdown">
                                <div class="status-dropdown-item" onclick="selectStatusFromDropdown('pending')"><span class="dot pending"></span>En attente</div>
                                <div class="status-dropdown-item" onclick="selectStatusFromDropdown('approved')"><span class="dot approved"></span>Approuvé</div>
                                <div class="status-dropdown-item" onclick="selectStatusFromDropdown('rejected')"><span class="dot rejected"></span>Rejeté</div>
                                <div class="status-dropdown-item" onclick="selectStatusFromDropdown('suspended')"><span class="dot suspended"></span>Suspendu</div>
                            </div>
                            <input type="hidden" id="statusSelect" value="${status}">
                        </div>
                    </div>
                </div>
                
                <div class="info-card">
                    <div class="info-card-title">Statistiques</div>
                    <div class="info-row"><span class="info-label">Admins</span><span class="info-value green">1</span></div>
                    <div class="info-row"><span class="info-label">Managers</span><span class="info-value green">${enterprise.manager_count || 0}</span></div>
                    <div class="info-row"><span class="info-label">Techniciens</span><span class="info-value blue">${techsLinked.length}</span></div>
                    <div class="info-row"><span class="info-label">Projets actifs</span><span class="info-value orange">${projectCount}</span></div>
                </div>
                
                <div class="info-card">
                    <div class="info-card-title">Utilisateurs (1)</div>
                    <div class="user-list-item" onclick="toggleUserExpand(this, '${enterprise.id}')">
                        <div class="user-avatar-sm">
                            ${getInitials(adminName)}
                            <div class="status-dot ${status}"></div>
                        </div>
                        <div class="user-list-info">
                            <div class="user-list-name">${adminName}</div>
                            <div class="user-list-role">Administrateur</div>
                        </div>
                        <span class="user-list-badge">Admin</span>
                    </div>
                    <div class="user-expand" id="userExpand-${enterprise.id}">
                        <div class="user-expand-row"><span class="user-expand-label">Prénom</span><span class="user-expand-value">${enterprise.first_name || '-'}</span></div>
                        <div class="user-expand-row"><span class="user-expand-label">Nom</span><span class="user-expand-value">${enterprise.last_name || '-'}</span></div>
                        <div class="user-expand-row"><span class="user-expand-label">Email</span><span class="user-expand-value">${enterprise.email}</span></div>
                        <div class="user-expand-row"><span class="user-expand-label">Téléphone</span><span class="user-expand-value">${enterprise.phone || enterprise.phone_number || enterprise.telephone || '-'}</span></div>
                        <div class="user-expand-row"><span class="user-expand-label">Rôle</span><span class="user-expand-value">${enterprise.role || 'Admin'}</span></div>
                        <div class="user-expand-row"><span class="user-expand-label">Créé le</span><span class="user-expand-value">${formatDate(enterprise.created_at)}</span></div>
                    </div>
                </div>`;
        }
        
        function toggleStatusDropdown(event) {
            event.stopPropagation();
            const dropdown = event.target.closest('.status-dropdown-wrapper').querySelector('.status-dropdown');
            
            // Close any other open dropdowns
            document.querySelectorAll('.status-dropdown.show').forEach(d => {
                if (d !== dropdown) d.classList.remove('show');
            });
            
            dropdown.classList.toggle('show');
        }
        
        function selectStatusFromDropdown(newStatus) {
            // Update hidden input
            document.getElementById('statusSelect').value = newStatus;
            
            // Update the tag display
            const statusIcon = newStatus === 'approved' ? '✓' : (newStatus === 'rejected' ? '✗' : (newStatus === 'suspended' ? '⊘' : '⏱'));
            const statusLabel = formatStatus(newStatus);
            const tag = document.querySelector('.status-tag');
            if (tag) {
                tag.className = 'status-tag ' + newStatus;
                tag.innerHTML = `${statusIcon} ${statusLabel} <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>`;
            }
            
            // Close dropdown
            document.querySelectorAll('.status-dropdown.show').forEach(d => d.classList.remove('show'));
        }
        
        // Close dropdown when clicking outside
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.status-dropdown-wrapper')) {
                document.querySelectorAll('.status-dropdown.show').forEach(d => d.classList.remove('show'));
            }
        });
        
        function selectStatus(newStatus) {
            selectStatusFromDropdown(newStatus);
        }
        
        function toggleUserExpand(el, userId) {
            const expandEl = document.getElementById('userExpand-' + userId);
            if (expandEl) {
                expandEl.classList.toggle('show');
                el.classList.toggle('expanded');
            }
        }

        // ═══ PROJECT VIEW ═══
        function openProjectView(projectId) {
            currentProjectId = projectId;
            const project = allProjects.find(p => p.id === projectId);
            if (!project) return;
            currentProjectData = project;
            currentReportData = project.report_data || project.reportData || project.extracted_report || null;

            const projectChats = allChats.filter(c => c.project_id === projectId);
            const copilotChat = projectChats.find(c => c.type === 'copilot' || c.chat_type === 'copilot');
            const assistantChat = projectChats.find(c => c.type === 'assistant' || c.chat_type === 'assistant');

            const brand = project.brand || 'Multi-marques';
            document.getElementById('copilotBrand').textContent = brand;
            document.getElementById('assistantBrand').textContent = brand;

            renderChatMessages('copilot', copilotChat);
            renderChatMessages('assistant', assistantChat);

            const hasBoth = copilotChat && assistantChat;
            if (hasBoth) {
                isSplit = true;
                enableSplitView();
            } else if (assistantChat && !copilotChat) {
                currentMode = 'assistant';
                document.getElementById('panelCopilot').style.display = 'none';
                document.getElementById('panelAssistant').style.display = 'flex';
            } else {
                currentMode = 'copilot';
                document.getElementById('panelCopilot').style.display = 'flex';
                document.getElementById('panelAssistant').style.display = 'none';
            }

            document.getElementById('projectViewOverlay').classList.add('active');
        }

        function renderChatMessages(type, chat) {
            const body = document.getElementById(type + 'Body');
            const modeName = type === 'copilot' ? 'Copilot' : 'Assistant';
            const modeColor = type === 'copilot' ? 'var(--copilot)' : 'var(--assistant)';
            
            if (!chat) {
                body.innerHTML = `<div class="chat-empty"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z"/></svg><div>Aucun message ${modeName}</div></div>`;
                return;
            }

            const messages = allMessages.filter(m => m.chat_id === chat.id);
            if (messages.length === 0) {
                body.innerHTML = `<div class="chat-empty"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z"/></svg><div>Aucun message</div></div>`;
                return;
            }

            body.innerHTML = messages.map(m => {
                const role = m.role || m.sender || 'user';
                const isUser = role === 'user' || role === 'human';
                const content = m.content || m.message || m.text || '';
                
                if (isUser) {
                    return `<div class="msg user"><div class="msg-bubble">${parseMarkdown(content)}</div><span class="msg-time">${formatTimeAgo(m.created_at)}</span></div>`;
                } else {
                    // Check if this message contains a report
                    const hasReport = content.includes('"type":"report"') || 
                                     content.includes('"resume"') || 
                                     content.includes('"travaux_effectues"') ||
                                     content.includes('RÉSUMÉ') && content.includes('CLIENT');
                    const reportClass = hasReport ? ' report' : '';
                    
                    // Use exact icons from technician app
                    const iconSvg = type === 'copilot' 
                        ? `<svg viewBox="0 0 200 200" fill="currentColor"><path d="M100.2 0C101.792 25.9476 98.6996 63.9402 117.082 82.3225C135.464 100.705 174.052 98.2076 200 99.8V100.2C174.051 101.79 135.763 98.9969 117.38 117.38C98.997 135.763 101.79 174.051 100.2 200H99.8C98.2103 174.051 100.109 136.06 81.7264 117.678C63.3436 99.2949 25.9485 101.79 0 100.2V99.8C25.9476 98.2076 63.6424 100.406 82.0246 82.0242C100.407 63.642 98.2076 25.9476 99.8 0H100.2Z"/></svg>`
                        : `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><rect x="8" y="2" width="8" height="4" rx="1" ry="1"/><path d="M9 14l2 2 4-4"/></svg>`;
                    
                    return `<div class="msg ai${reportClass}"><div class="msg-bubble"><div class="msg-head"><div class="msg-avatar">${iconSvg}</div><span class="msg-name">FixAIR ${modeName}</span></div>${parseMarkdown(content)}</div><span class="msg-time">${formatTimeAgo(m.created_at)}</span></div>`;
                }
            }).join('');

            body.scrollTop = body.scrollHeight;
            
            // Try to extract report data from messages
            messages.forEach(m => {
                const content = m.content || m.message || '';
                const reportMatch = content.match(/\[REPORT_DATA\]([\s\S]*?)\[\/REPORT_DATA\]/);
                if (reportMatch) {
                    try {
                        currentReportData = JSON.parse(reportMatch[1]);
                    } catch (e) {}
                }
            });
        }

        function closeProjectView() {
            document.getElementById('projectViewOverlay').classList.remove('active');
            currentProjectId = null;
            currentProjectData = null;
            currentReportData = null;
            isSplit = false;
            document.getElementById('chatView').classList.remove('split');
            document.getElementById('chatView').classList.add('single');
            document.getElementById('panelCopilot').style.display = 'flex';
            document.getElementById('panelCopilot').style.flexBasis = '50%';
            document.getElementById('panelAssistant').style.display = 'none';
            document.getElementById('panelAssistant').style.flexBasis = '50%';
            document.getElementById('divider').style.display = 'none';
        }

        // ═══ SPLIT VIEW ═══
        function toggleSplit() {
            if (!currentProjectId) return;
            const projectChats = allChats.filter(c => c.project_id === currentProjectId);
            const copilotChat = projectChats.find(c => c.type === 'copilot' || c.chat_type === 'copilot');
            const assistantChat = projectChats.find(c => c.type === 'assistant' || c.chat_type === 'assistant');
            if (!copilotChat || !assistantChat) return;
            if (isSplit) disableSplitView(); else enableSplitView();
        }

        function enableSplitView() {
            isSplit = true;
            document.getElementById('chatView').classList.remove('single');
            document.getElementById('chatView').classList.add('split');
            document.getElementById('panelCopilot').style.display = 'flex';
            document.getElementById('panelAssistant').style.display = 'flex';
            document.getElementById('divider').style.display = 'flex';
            document.querySelectorAll('.h-btn[title="Split view"]').forEach(b => b.classList.add('active'));
        }

        function disableSplitView() {
            isSplit = false;
            document.getElementById('chatView').classList.remove('split');
            document.getElementById('chatView').classList.add('single');
            document.getElementById('divider').style.display = 'none';
            if (currentMode === 'assistant') {
                document.getElementById('panelCopilot').style.display = 'none';
                document.getElementById('panelAssistant').style.display = 'flex';
            } else {
                document.getElementById('panelCopilot').style.display = 'flex';
                document.getElementById('panelAssistant').style.display = 'none';
            }
            document.querySelectorAll('.h-btn[title="Split view"]').forEach(b => b.classList.remove('active'));
        }

        // ═══ DIVIDER DRAG ═══
        const divider = document.getElementById('divider');
        const pC = document.getElementById('panelCopilot');
        const pA = document.getElementById('panelAssistant');
        let isDrag = false;
        divider.addEventListener('mousedown', startDrag);
        divider.addEventListener('touchstart', startDrag, { passive: false });
        function startDrag(e) { if (!isSplit) return; isDrag = true; divider.classList.add('dragging'); document.body.style.cursor = window.innerWidth > 767 ? 'col-resize' : 'row-resize'; document.body.style.userSelect = 'none'; e.preventDefault(); }
        document.addEventListener('mousemove', drag);
        document.addEventListener('touchmove', drag, { passive: false });
        function drag(e) {
            if (!isDrag) return;
            e.preventDefault();
            const cv = document.getElementById('chatView');
            const rect = cv.getBoundingClientRect();
            const isHorizontal = window.innerWidth > 767;
            let pos, size, offset, pct;
            if (isHorizontal) { pos = e.touches ? e.touches[0].clientX : e.clientX; size = rect.width; offset = pos - rect.left; }
            else { pos = e.touches ? e.touches[0].clientY : e.clientY; size = rect.height; offset = pos - rect.top; }
            pct = Math.max(25, Math.min(75, (offset / size) * 100));
            pC.style.flexBasis = pct + '%';
            pA.style.flexBasis = (100 - pct) + '%';
        }
        document.addEventListener('mouseup', stopDrag);
        document.addEventListener('touchend', stopDrag);
        function stopDrag() { if (!isDrag) return; isDrag = false; divider.classList.remove('dragging'); document.body.style.cursor = ''; document.body.style.userSelect = ''; }

        // ═══ REPORT SHEET ═══
        function openReportSheet() {
            const data = currentReportData || {};
            document.getElementById('reportBody').innerHTML = renderReportPreview(data);
            
            // Calculate completion
            const completion = calculateReportCompletion(data);
            document.getElementById('reportProgressFill').style.width = completion + '%';
            document.getElementById('reportProgressText').textContent = completion + '%';
            
            document.getElementById('reportBackdrop').classList.add('show');
            document.getElementById('reportSheet').classList.add('open');
        }
        
        function calculateReportCompletion(data) {
            const fields = [
                data.resume,
                data.reference,
                data.date,
                data.type_intervention,
                data.client?.societe,
                data.client?.contact,
                data.client?.telephone,
                data.site?.adresse,
                data.site?.ville,
                data.systeme?.type,
                data.systeme?.modele,
                data.systeme?.serie,
                data.travaux_effectues?.length > 0,
                data.mesures,
                data.resultat
            ];
            const filled = fields.filter(f => f && f !== '').length;
            return Math.round((filled / fields.length) * 100);
        }
        
        function renderReportPreview(data) {
            const brandNames = {
                'mitsubishi': 'MITSUBISHI ELECTRIC',
                'daikin': 'DAIKIN',
                'carrier': 'CARRIER',
                'lg': 'LG',
                'samsung': 'SAMSUNG',
                'general': 'MULTI-MARQUES'
            };
            
            const brandClass = data.brand_key || currentProjectData?.brand?.toLowerCase() || 'general';
            const brandName = brandNames[brandClass] || data.brand || brandNames[currentProjectData?.brand?.toLowerCase()] || 'FIXAIR';
            const today = new Date().toLocaleDateString('fr-FR');
            
            // Status
            let statusClass = 'en-cours', statusText = 'En cours';
            if (data.status) {
                const s = data.status.toLowerCase();
                if (s.includes('conforme') && !s.includes('non')) { statusClass = 'conforme'; statusText = 'Conforme'; }
                else if (s.includes('non') || s.includes('refus')) { statusClass = 'non-conforme'; statusText = 'Non conforme'; }
            }
            
            const val = (v, placeholder = '') => v || `<span class="placeholder">${placeholder}</span>`;
            
            let html = `<div class="rpt-preview">`;
            
            // Header
            html += `
            <div class="rpt-preview-header">
                <div class="rpt-preview-brand ${brandClass}">${brandName}</div>
                <div class="rpt-preview-title-row">
                    <h2>Rapport d'intervention</h2>
                    <div class="rpt-preview-status ${statusClass}">${statusText}</div>
                </div>
                <div class="rpt-preview-meta">
                    <span>RÉF <strong>${val(data.reference, 'FX-2025-XXXX')}</strong></span>
                    <span>TYPE <strong>${val(data.type_intervention, 'Type')}</strong></span>
                    <span>DATE <strong>${val(data.date, today)}</strong></span>
                </div>
            </div>`;
            
            // Résumé
            html += `
            <div class="rpt-preview-section">
                <div class="rpt-preview-section-title">RÉSUMÉ DE L'INTERVENTION</div>
                <div class="rpt-preview-text">${val(data.resume, 'Description de l\'intervention...')}</div>
            </div>`;
            
            // Informations Site & Client
            html += `
            <div class="rpt-preview-section">
                <div class="rpt-preview-grid">
                    <div class="rpt-preview-group">
                        <div class="rpt-preview-section-title">INFORMATIONS SITE</div>
                        <div class="rpt-preview-row"><span class="label">N° Affaire</span><span class="value">${val(data.site?.numero_affaire, 'Numéro d\'affaire')}</span></div>
                        <div class="rpt-preview-row"><span class="label">Lieu</span><span class="value">${val(data.site?.adresse, 'Adresse')}</span></div>
                        <div class="rpt-preview-row"><span class="label">Ville</span><span class="value">${val(data.site?.ville, 'Code postal + Ville')}</span></div>
                    </div>
                    <div class="rpt-preview-group">
                        <div class="rpt-preview-section-title">INFORMATIONS CLIENT</div>
                        <div class="rpt-preview-row"><span class="label">Société</span><span class="value">${val(data.client?.societe, 'Nom de l\'entreprise')}</span></div>
                        <div class="rpt-preview-row"><span class="label">Contact</span><span class="value">${val(data.client?.contact, 'Nom du contact')}</span></div>
                        <div class="rpt-preview-row"><span class="label">Téléphone</span><span class="value">${val(data.client?.telephone, '06 XX XX XX XX')}</span></div>
                        <div class="rpt-preview-row"><span class="label">Réf. Client</span><span class="value">${val(data.client?.reference, 'Référence client')}</span></div>
                    </div>
                </div>
            </div>`;
            
            // Dates
            html += `
            <div class="rpt-preview-section">
                <div class="rpt-preview-section-title">DATES D'INTERVENTION</div>
                <div class="rpt-preview-grid">
                    <div class="rpt-preview-row"><span class="label">Date début</span><span class="value">${val(data.intervention?.date_debut || data.date, 'JJ/MM/AAAA')}</span></div>
                    <div class="rpt-preview-row"><span class="label">Date fin</span><span class="value">${val(data.intervention?.date_fin, 'JJ/MM/AAAA')}</span></div>
                    <div class="rpt-preview-row"><span class="label">Heure début</span><span class="value">${val(data.intervention?.heure_debut, 'HH:MM')}</span></div>
                    <div class="rpt-preview-row"><span class="label">Heure fin</span><span class="value">${val(data.intervention?.heure_fin, 'HH:MM')}</span></div>
                </div>
            </div>`;
            
            // Système & Équipement
            html += `
            <div class="rpt-preview-section">
                <div class="rpt-preview-section-title">SYSTÈME & ÉQUIPEMENT</div>
                <div class="rpt-preview-grid">
                    <div class="rpt-preview-row"><span class="label">Type système</span><span class="value">${val(data.systeme?.type, 'VRF / Split / etc.')}</span></div>
                    <div class="rpt-preview-row"><span class="label">Puissance</span><span class="value">${val(data.systeme?.puissance, 'kW')}</span></div>
                    <div class="rpt-preview-row"><span class="label">Modèle</span><span class="value mono">${val(data.systeme?.modele, 'Référence modèle')}</span></div>
                    <div class="rpt-preview-row"><span class="label">Année install.</span><span class="value">${val(data.systeme?.annee_installation, 'AAAA')}</span></div>
                    <div class="rpt-preview-row"><span class="label">N° Série</span><span class="value mono">${val(data.systeme?.serie, 'Numéro de série')}</span></div>
                    <div class="rpt-preview-row"><span class="label">Garantie</span><span class="value">${val(data.systeme?.garantie, 'Statut garantie')}</span></div>
                </div>
            </div>`;
            
            // Fluide frigorigène
            html += `
            <div class="rpt-preview-section">
                <div class="rpt-preview-section-title">FLUIDE FRIGORIGÈNE</div>
                <div class="rpt-preview-grid">
                    <div class="rpt-preview-row"><span class="label">Type fluide</span><span class="value">${val(data.fluide?.type || data.systeme?.fluide, 'R410A / R32 / etc.')}</span></div>
                    <div class="rpt-preview-row"><span class="label">Type huile</span><span class="value">${val(data.fluide?.huile, 'POE, PVE...')}</span></div>
                    <div class="rpt-preview-row"><span class="label">Charge initiale</span><span class="value">${val(data.fluide?.charge_initiale, 'kg')}</span></div>
                    <div class="rpt-preview-row"><span class="label">Charge totale</span><span class="value">${val(data.fluide?.charge_totale, 'kg')}</span></div>
                </div>
            </div>`;
            
            // Travaux effectués
            if (data.travaux_effectues && data.travaux_effectues.length > 0) {
                html += `
                <div class="rpt-preview-section">
                    <div class="rpt-preview-section-title">TRAVAUX EFFECTUÉS</div>
                    <ul class="rpt-preview-checklist">`;
                data.travaux_effectues.forEach(t => {
                    const isDone = t.fait === true || t.fait === 'oui' || t.statut === 'fait';
                    const text = typeof t === 'string' ? t : (t.description || t.texte || t.label || '');
                    html += `<li class="${isDone ? 'done' : 'pending'}"><span class="check">${isDone ? '✓' : '✗'}</span><span>${text}</span></li>`;
                });
                html += `</ul></div>`;
            }
            
            // Mesures
            if (data.mesures) {
                html += `
                <div class="rpt-preview-section">
                    <div class="rpt-preview-section-title">MESURES</div>
                    <div class="rpt-preview-measures">`;
                if (typeof data.mesures === 'object') {
                    for (const [key, val] of Object.entries(data.mesures)) {
                        const isOk = !String(val).toLowerCase().includes('hs') && !String(val).toLowerCase().includes('non');
                        html += `<div class="measure-card ${isOk ? '' : 'error'}"><div class="measure-label">${key}</div><div class="measure-value">${val}</div></div>`;
                    }
                }
                html += `</div></div>`;
            }
            
            // Résultat
            html += `
            <div class="rpt-preview-section result">
                <div class="rpt-preview-section-title">RÉSULTAT</div>
                <div class="result-status ${statusClass}">${val(data.resultat?.statut || data.status, 'Statut')}</div>
                <div class="result-desc">${val(data.resultat?.description || data.resultat, 'Description du résultat...')}</div>
            </div>`;
            
            html += `</div>`;
            return html;
        }

        function closeReportSheet() {
            document.getElementById('reportBackdrop').classList.remove('show');
            document.getElementById('reportSheet').classList.remove('open');
        }

        // ═══ USERS ═══
        function populateUsersList() {
            const container = document.getElementById('usersListPage');
            const techCount = allUsers.filter(u => (u.role || 'technician').toLowerCase() === 'technician').length;
            const managerCount = allUsers.filter(u => (u.role || '').toLowerCase() === 'manager').length;
            const adminCount = allUsers.filter(u => (u.role || '').toLowerCase() === 'admin').length;
            
            document.getElementById('usersPageSubtitle').textContent = `${allUsers.length} utilisateurs • ${techCount} techs • ${managerCount} managers • ${adminCount} admins`;
            
            // Update tab counts
            updateUserCounts();
            
            // Filter by role
            let filtered = currentFilter === 'all' ? allUsers : allUsers.filter(u => (u.role || 'technician').toLowerCase() === currentFilter);
            if (filtered.length === 0) { container.innerHTML = '<div class="empty-state"><div class="empty-title">Aucun utilisateur</div></div>'; return; }
            container.innerHTML = filtered.map(u => buildTechnicianCard(u, `openPageDrawer('users','view','${u.id}')`)).join('');
        }

        function populateEnterprisesList() {
            const container = document.getElementById('enterprisesList');
            const pending = allEnterprises.filter(e => !e.status || e.status === 'pending').length;
            document.getElementById('enterprisesPageSubtitle').textContent = `${allEnterprises.length} entreprises • ${pending} en attente`;
            
            if (allEnterprises.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-title">Aucune entreprise</div></div>';
                return;
            }
            container.innerHTML = allEnterprises.map(e => buildEnterpriseCard(e, `openPageDrawer('enterprises','view','${e.id}')`)).join('');
        }
        
        function filterEnterprises() {
            const search = document.getElementById('enterprisesSearchInput').value.toLowerCase();
            let filtered = allEnterprises;
            if (search) {
                filtered = allEnterprises.filter(e => 
                    (e.company_name||'').toLowerCase().includes(search) || 
                    (e.email||'').toLowerCase().includes(search) ||
                    (e.first_name||'').toLowerCase().includes(search)
                );
            }
            document.getElementById('enterprisesList').innerHTML = filtered.length > 0 
                ? filtered.map(e => buildEnterpriseCard(e, `openPageDrawer('enterprises','view','${e.id}')`)).join('') 
                : '<div class="empty-state"><div class="empty-title">Aucun résultat</div></div>';
        }

        function filterUsersByRole(role) {
            currentFilter = role;
            document.querySelectorAll('#usersTabs .tab').forEach((t, i) => { 
                t.classList.remove('active'); 
                if ((role==='all'&&i===0)||(role==='technician'&&i===1)||(role==='manager'&&i===2)||(role==='admin'&&i===3)) t.classList.add('active'); 
            });
            populateUsersList();
        }
        
        function updateUserCounts() {
            const techCount = allUsers.filter(u => (u.role || 'technician').toLowerCase() === 'technician').length;
            const managerCount = allUsers.filter(u => (u.role || '').toLowerCase() === 'manager').length;
            const adminCount = allUsers.filter(u => (u.role || '').toLowerCase() === 'admin').length;
            
            document.getElementById('countAll').textContent = allUsers.length;
            document.getElementById('countTech').textContent = techCount;
            document.getElementById('countManager').textContent = managerCount;
            document.getElementById('countAdmin').textContent = adminCount;
        }

        function filterUsers() {
            const search = document.getElementById('usersSearchInput').value.toLowerCase();
            let filtered = currentFilter === 'all' ? allUsers : allUsers.filter(u => (u.role || 'technician').toLowerCase() === currentFilter);
            if (search) filtered = filtered.filter(u => (u.name||'').toLowerCase().includes(search) || (u.first_name||'').toLowerCase().includes(search) || (u.email||'').toLowerCase().includes(search));
            document.getElementById('usersListPage').innerHTML = filtered.length > 0 ? filtered.map(u => buildTechnicianCard(u, `openPageDrawer('users','view','${u.id}')`)).join('') : '<div class="empty-state"><div class="empty-title">Aucun résultat</div></div>';
        }

        // ═══ QUICK ACTIONS (Approve/Reject from card hover) ═══
        async function quickApprove(type, id) {
            const user = allUsers.find(u => u.id === id);
            if (!user) return;
            
            // Show loading state on card
            const card = document.querySelector(`.technician-card[onclick*="${id}"], .enterprise-card[onclick*="${id}"]`);
            if (card) card.style.opacity = '0.5';
            
            try {
                await supabaseUpdate('users', id, { status: 'approved' });
                
                // Update local data
                const idx = allUsers.findIndex(u => u.id === id);
                if (idx >= 0) allUsers[idx].status = 'approved';
                const entIdx = allEnterprises.findIndex(u => u.id === id);
                if (entIdx >= 0) allEnterprises[entIdx].status = 'approved';
                const techIdx = allTechnicians.findIndex(u => u.id === id);
                if (techIdx >= 0) allTechnicians[techIdx].status = 'approved';
                
                // Send webhook
                try {
                    const role = (user.role || '').toLowerCase();
                    const hasCompany = user.company_name && user.company_name.trim() !== '';
                    const isEnterprise = role === 'admin' && hasCompany;
                    
                    await fetch(N8N_WEBHOOK_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            user_id: user.id,
                            user_type: isEnterprise ? 'enterprise' : 'technician',
                            role: user.role,
                            status: 'approved',
                            previous_status: user.status || 'pending',
                            email: user.email,
                            first_name: user.first_name,
                            last_name: user.last_name,
                            company_name: user.company_name,
                            plan: user.subscribed || user.plan || 'free'
                        })
                    });
                } catch (e) { console.error('Webhook error:', e); }
                
                // Refresh UI
                updateDashboard();
                renderEnterprisesHome();
                renderTechniciansHome();
                populateUsersList();
                populateEnterprisesList();
                
                console.log('✅ Quick approved:', id);
            } catch (error) {
                console.error('Error:', error);
                alert('Erreur: ' + error.message);
            } finally {
                if (card) card.style.opacity = '1';
            }
        }
        
        async function quickReject(type, id) {
            if (!confirm('Êtes-vous sûr de vouloir rejeter cette demande ?')) return;
            
            const user = allUsers.find(u => u.id === id);
            if (!user) return;
            
            const card = document.querySelector(`.technician-card[onclick*="${id}"], .enterprise-card[onclick*="${id}"]`);
            if (card) card.style.opacity = '0.5';
            
            try {
                await supabaseUpdate('users', id, { status: 'rejected' });
                
                // Update local data
                const idx = allUsers.findIndex(u => u.id === id);
                if (idx >= 0) allUsers[idx].status = 'rejected';
                const entIdx = allEnterprises.findIndex(u => u.id === id);
                if (entIdx >= 0) allEnterprises[entIdx].status = 'rejected';
                const techIdx = allTechnicians.findIndex(u => u.id === id);
                if (techIdx >= 0) allTechnicians[techIdx].status = 'rejected';
                
                // Refresh UI
                updateDashboard();
                renderEnterprisesHome();
                renderTechniciansHome();
                populateUsersList();
                populateEnterprisesList();
                
                console.log('❌ Quick rejected:', id);
            } catch (error) {
                console.error('Error:', error);
                alert('Erreur: ' + error.message);
            } finally {
                if (card) card.style.opacity = '1';
            }
        }

        // ═══ SAVE STATUS ═══
        async function saveStatus() {
            if (!selectedUserId) return;
            const select = document.getElementById('statusSelect');
            if (!select) {
                console.error('❌ statusSelect not found');
                return;
            }
            const newStatus = select.value;
            const user = allUsers.find(u => u.id === selectedUserId); 
            if (!user) {
                console.error('❌ User not found:', selectedUserId);
                return;
            }
            
            console.log('📝 Saving status:', { userId: selectedUserId, newStatus, previousStatus: user.status });
            
            const btn = document.getElementById('saveStatusBtn');
            btn.disabled = true;
            btn.innerHTML = '<div class="spinner" style="width:14px;height:14px;border-width:2px;"></div>';
            
            try {
                // Update database - this works for ALL status changes
                await supabaseUpdate('users', selectedUserId, { status: newStatus });
                console.log('✅ Database updated successfully');
                
                // Send webhook for ALL status changes (not just approved)
                try { 
                    const role = (user.role || '').toLowerCase();
                    const hasCompany = user.company_name && user.company_name.trim() !== '';
                    const isEnterprise = role === 'admin' && hasCompany;
                    
                    // Build complete user data payload with ALL Supabase fields
                    const webhookPayload = {
                        // ═══ IDENTITY ═══
                        user_id: user.id,
                        user_type: isEnterprise ? 'enterprise' : 'technician',
                        role: user.role || null,
                        
                        // ═══ STATUS ═══
                        status: newStatus,
                        previous_status: user.status || 'pending',
                        status_changed_at: new Date().toISOString(),
                        is_active: user.is_active ?? true,
                        
                        // ═══ CONTACT INFO ═══
                        email: user.email,
                        email_confirmed: user.email_confirmed ?? false,
                        phone: user.phone || user.phone_number || null,
                        
                        // ═══ PERSONAL INFO ═══
                        first_name: user.first_name || null,
                        last_name: user.last_name || null,
                        
                        // ═══ COMPANY INFO (for enterprises) ═══
                        company_name: user.company_name || null,
                        company_address: user.address || user.company_address || null,
                        company_siret: user.siret || user.company_siret || null,
                        
                        // ═══ SUBSCRIPTION ═══
                        plan: user.subscribed || user.plan || 'free',
                        subscription_type: user.subscribed || 'free',
                        
                        // ═══ METADATA ═══
                        language: user.language || 'fr',
                        created_at: user.created_at,
                        updated_at: user.updated_at,
                        
                        // ═══ STATISTICS ═══
                        project_count: allProjects.filter(p => p.user_id === user.id).length,
                        
                        // ═══ FULL USER OBJECT ═══
                        full_user_data: user
                    };
                    
                    await fetch(N8N_WEBHOOK_URL, { 
                        method: 'POST', 
                        headers: { 'Content-Type': 'application/json' }, 
                        body: JSON.stringify(webhookPayload) 
                    });
                    
                    console.log('📤 Webhook sent:', webhookPayload);
                } catch (e) {
                    console.error('Webhook error:', e);
                }
                
                // Update local data
                const idx = allUsers.findIndex(u => u.id === selectedUserId);
                if (idx >= 0) allUsers[idx].status = newStatus;
                
                // Update enterprise/technician arrays
                const entIdx = allEnterprises.findIndex(u => u.id === selectedUserId);
                if (entIdx >= 0) allEnterprises[entIdx].status = newStatus;
                const techIdx = allTechnicians.findIndex(u => u.id === selectedUserId);
                if (techIdx >= 0) allTechnicians[techIdx].status = newStatus;
                
                btn.innerHTML = '✅';
                btn.classList.add('success');
                
                // Update badges
                ['homeDrawerBadge', 'usersDrawerBadge', 'enterprisesDrawerBadge'].forEach(id => { 
                    const b = document.getElementById(id); 
                    if (b) { 
                        b.textContent = formatStatus(newStatus); 
                        b.className = 'drawer-badge ' + newStatus; 
                    } 
                });
                
                updateDashboard(); 
                populateUsersList();
                
                setTimeout(() => { 
                    closeHomeDrawer(); 
                    closePageDrawer('users'); 
                }, 1000);
                
            } catch (error) {
                console.error('Error:', error);
                btn.innerHTML = '❌'; 
                btn.disabled = false;
                alert('Erreur: ' + error.message);
            }
        }
        
        function formatStatusExtended(s) { 
            return { 
                approved: 'Approuvé', 
                pending: 'En attente', 
                rejected: 'Rejeté',
                suspended: 'Suspendu'
            }[s] || 'En attente'; 
        }

        // ═══ EMAIL COMMUNICATION SYSTEM ═══
        const EMAIL_SEND_WEBHOOK = 'https://cherhabil.app.n8n.cloud/webhook/email-send';
        
        async function loadEmailHistory(userId) {
            const listEl = document.getElementById('emailList-' + userId);
            const countEl = document.getElementById('emailCount-' + userId);
            if (!listEl) return;
            
            try {
                const response = await fetch(
                    `${SUPABASE_URL}/rest/v1/sent_emails?recipient_user_id=eq.${userId}&order=sent_at.desc`,
                    { headers: { 'apikey': SUPABASE_ANON_KEY, 'Authorization': `Bearer ${SUPABASE_ANON_KEY}` } }
                );
                
                if (!response.ok) {
                    listEl.innerHTML = '<div class="email-empty">Aucun email envoyé</div>';
                    if (countEl) countEl.textContent = '0';
                    return;
                }
                
                const emails = await response.json();
                if (countEl) countEl.textContent = emails.length;
                
                if (!emails || emails.length === 0) {
                    listEl.innerHTML = '<div class="email-empty">Aucun email envoyé</div>';
                    return;
                }
                
                listEl.innerHTML = emails.map(email => renderEmailItem(email)).join('');
                
                // Load click details for each email
                emails.forEach(email => loadEmailClicks(email.id));
                
            } catch (error) {
                console.error('Error loading email history:', error);
                listEl.innerHTML = '<div class="email-empty">Aucun email envoyé</div>';
                if (countEl) countEl.textContent = '0';
            }
        }
        
        function renderEmailItem(email) {
            const date = new Date(email.sent_at);
            const dateStr = date.toLocaleDateString('fr-FR', { day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit' });
            
            const openedBadge = email.opened 
                ? `<span class="email-stat opened">✓ ${email.open_count || 1}x</span>`
                : `<span class="email-stat not-opened">Non ouvert</span>`;
            
            const clicksBadge = email.total_clicks > 0 
                ? `<span class="email-stat clicks">${email.total_clicks} clic${email.total_clicks > 1 ? 's' : ''}</span>`
                : '';
            
            const preview = (email.body_text || '').substring(0, 120) + ((email.body_text || '').length > 120 ? '...' : '');
            
            return `
                <div class="email-item" data-email-id="${email.id}">
                    <div class="email-item-header" onclick="toggleEmailExpand(this)">
                        <div class="email-item-left">
                            <div class="email-item-subject">${escapeHtmlEmail(email.subject || 'Sans sujet')}</div>
                            <div class="email-item-date">${dateStr}</div>
                        </div>
                        <div class="email-item-stats">
                            ${openedBadge}
                            ${clicksBadge}
                        </div>
                        <svg class="email-item-chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>
                    </div>
                    <div class="email-item-body">
                        <div class="email-preview">${escapeHtmlEmail(preview)}</div>
                        <div class="email-tracking-grid">
                            <div class="email-tracking-stat">
                                <div class="value ${email.opened ? 'green' : ''}">${email.opened ? '✓' : '—'}</div>
                                <div class="label">Ouvert</div>
                            </div>
                            <div class="email-tracking-stat">
                                <div class="value">${email.open_count || 0}</div>
                                <div class="label">Ouvertures</div>
                            </div>
                            <div class="email-tracking-stat">
                                <div class="value">${email.total_clicks || 0}</div>
                                <div class="label">Clics</div>
                            </div>
                        </div>
                        ${email.first_opened_at ? `
                            <div style="margin-top:8px;font-size:10px;color:var(--text-dim);">
                                Première ouverture: ${new Date(email.first_opened_at).toLocaleString('fr-FR')}
                                ${email.last_opened_at && email.last_opened_at !== email.first_opened_at ? '<br>Dernière: ' + new Date(email.last_opened_at).toLocaleString('fr-FR') : ''}
                            </div>
                        ` : ''}
                        <div class="email-clicks-section" id="clicks-${email.id}"></div>
                    </div>
                </div>
            `;
        }
        
        function toggleEmailExpand(header) {
            const item = header.closest('.email-item');
            item.classList.toggle('expanded');
        }
        
        async function loadEmailClicks(emailId) {
            const container = document.getElementById('clicks-' + emailId);
            if (!container) return;
            
            try {
                const response = await fetch(
                    `${SUPABASE_URL}/rest/v1/email_link_clicks?sent_email_id=eq.${emailId}&order=clicked_at.desc`,
                    { headers: { 'apikey': SUPABASE_ANON_KEY, 'Authorization': `Bearer ${SUPABASE_ANON_KEY}` } }
                );
                
                const clicks = await response.json();
                if (!clicks || clicks.length === 0) {
                    container.innerHTML = '';
                    return;
                }
                
                container.innerHTML = `
                    <div class="email-clicks-title">Détail des clics</div>
                    ${clicks.map(c => `
                        <div class="email-click-item">
                            <span class="email-click-link">${escapeHtmlEmail(c.link_text || c.link_url || 'Lien')}</span>
                            <span class="email-click-time">${new Date(c.clicked_at).toLocaleString('fr-FR')}</span>
                        </div>
                    `).join('')}
                `;
            } catch (error) {
                console.error('Error loading clicks:', error);
            }
        }
        
        function toggleSignatureField(userId) {
            const wrapper = document.getElementById('signatureWrapper-' + userId);
            if (wrapper) {
                wrapper.style.display = wrapper.style.display === 'none' ? 'block' : 'none';
            }
        }
        
        async function sendEmailToUser(userId) {
            const subjectEl = document.getElementById('emailSubject-' + userId);
            const contentEl = document.getElementById('emailContent-' + userId);
            const signatureEl = document.getElementById('emailSignature-' + userId);
            const btnEl = document.getElementById('emailSendBtn-' + userId);
            
            if (!subjectEl || !contentEl || !btnEl) return;
            
            const subject = subjectEl.value.trim();
            const content = contentEl.value.trim();
            const signatureHtml = signatureEl ? signatureEl.value.trim() : '';
            
            if (!subject) {
                showEmailToast('Veuillez entrer un sujet', 'error');
                subjectEl.focus();
                return;
            }
            if (!content) {
                showEmailToast('Veuillez entrer un message', 'error');
                contentEl.focus();
                return;
            }
            
            const user = allUsers.find(u => u.id === userId);
            if (!user) {
                showEmailToast('Utilisateur non trouvé', 'error');
                return;
            }
            
            // Disable button and show loading
            const originalBtnContent = btnEl.innerHTML;
            btnEl.disabled = true;
            btnEl.innerHTML = '<div class="spinner"></div> Envoi...';
            
            try {
                // Get user activity data
                const userProjects = allProjects.filter(p => p.user_id === user.id);
                const userChats = allChats.filter(c => userProjects.some(p => p.id === c.project_id));
                const hasCopilot = userChats.some(c => c.type === 'copilot' || c.chat_type === 'copilot');
                const hasAssistant = userChats.some(c => c.type === 'assistant' || c.chat_type === 'assistant');
                
                const payload = {
                    subject: subject,
                    body_text: content,
                    campaign_tag: 'manual_master_app',
                    technician: {
                        id: user.id,
                        email: user.email,
                        full_name: user.first_name ? `${user.first_name} ${user.last_name || ''}`.trim() : user.email,
                        first_name: user.first_name,
                        created_at: user.created_at,
                        last_login_at: user.last_login || user.last_seen_at,
                        last_active_at: user.last_seen_at || user.updated_at,
                        status: user.status,
                        has_used_copilot: hasCopilot,
                        has_used_assistant: hasAssistant,
                        company_name: user.company_name,
                        role: user.role,
                        project_count: userProjects.length,
                        chat_count: userChats.length
                    }
                };
                
                // Add custom signature if provided
                if (signatureHtml) {
                    payload.signature_html = signatureHtml;
                }
                
                const response = await fetch(EMAIL_SEND_WEBHOOK, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showEmailToast('✓ Email envoyé avec succès!', 'success');
                    subjectEl.value = '';
                    contentEl.value = '';
                    if (signatureEl) signatureEl.value = '';
                    // Reload email history after a short delay
                    setTimeout(() => loadEmailHistory(userId), 1500);
                } else {
                    throw new Error(result.error || 'Erreur lors de l\'envoi');
                }
                
            } catch (error) {
                console.error('Error sending email:', error);
                showEmailToast('Erreur: ' + error.message, 'error');
            } finally {
                btnEl.disabled = false;
                btnEl.innerHTML = originalBtnContent;
            }
        }
        
        function showEmailToast(message, type = 'info') {
            // Remove existing toast
            const existing = document.querySelector('.email-toast');
            if (existing) existing.remove();
            
            const toast = document.createElement('div');
            toast.className = 'email-toast ' + type;
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                if (toast.parentNode) toast.remove();
            }, 3500);
        }
        
        function escapeHtmlEmail(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        document.addEventListener('DOMContentLoaded', loadAllData);
    </script>
</body>
</html>
    <div class="main-app" id="mainApp">
        <header class="app-header">
            <div class="app-header-left">
                <div class="app-header-logo"><svg viewBox="0 0 235 48"><use href="#icon-fixair-logo"/></svg></div>
                <span class="app-header-title">FixAIR Master</span>
                <span class="app-header-badge">ADMIN</span>
            </div>
            <div class="app-header-right">
                <div class="user-menu">
                    <div class="user-avatar" id="userAvatar">H</div>
                    <span class="user-name" id="userName">Admin</span>
                </div>
                <button class="logout-btn" onclick="logout()">Deconnexion</button>
            </div>
        </header>
        <main class="app-content">
            <div class="app-content-inner">
                <div class="placeholder-content">
                    <div class="placeholder-icon">&#128272;</div>
                    <h2 class="placeholder-title">Bienvenue sur FixAIR Master</h2>
                    <p class="placeholder-subtitle">
                        Le contenu du tableau de bord Master sera affiche ici. Vous etes connecte en tant qu'administrateur autorise.
                    </p>
                </div>
            </div>
        </main>
    </div>

    <script>
        // ═══ AUTH - SUPABASE CLIENT ═══
        // Note: SUPABASE_URL and SUPABASE_ANON_KEY are already declared in dashboard script above
        let sb = null;
        let supabaseUser = null;
        let currentProfile = null;
        let loginStep = 0;

        // Initialize Supabase
        function initSupabase() {
            if (!window.supabase) {
                setTimeout(initSupabase, 100);
                return;
            }
            sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
                auth: {
                    autoRefreshToken: true,
                    persistSession: true,
                    detectSessionInUrl: true
                }
            });
            initAuth();
        }

        // ═══ AUTH FUNCTIONS ═══
        async function initAuth() {
            try {
                const { data: { session } } = await sb.auth.getSession();
                if (session && session.user) {
                    await handleAuthenticatedUser(session.user);
                }
            } catch (err) {
                console.error('Init auth error:', err);
            }

            // Listen for auth changes
            sb.auth.onAuthStateChange(async (event, session) => {
                if (event === 'SIGNED_IN' && session?.user) {
                    await handleAuthenticatedUser(session.user);
                } else if (event === 'SIGNED_OUT') {
                    showLoginScreen();
                }
            });
        }

        async function handleAuthenticatedUser(user) {
            supabaseUser = user;
            const email = user.email?.toLowerCase();

            // Load user profile and check role
            const { data: userData, error } = await sb
                .from('users')
                .select('*')
                .eq('id', user.id)
                .single();

            if (error || !userData) {
                showAccessDeniedScreen(email);
                return;
            }

            // Check role - must be 'master' only
            if (userData.role !== 'master') {
                showAccessDeniedScreen(email);
                return;
            }

            currentProfile = userData;
            showMainApp(userData);
        }

        async function loadUserProfile(authId) {
            try {
                const { data, error } = await sb
                    .from('users')
                    .select('*')
                    .eq('id', authId)
                    .maybeSingle();
                if (error) return null;
                return data;
            } catch (err) {
                console.error('Load profile error:', err);
                return null;
            }
        }

        // ═══ LOGIN FLOW ═══
        async function nextLoginStep() {
            const btn = document.getElementById('loginBtn');

            if (loginStep === 0) {
                // Step 0: Check email exists and has master role
                const email = document.getElementById('loginEmailInput').value.trim().toLowerCase();

                if (!email.includes('@')) {
                    setLoginStatus('Veuillez entrer un email valide', 'error');
                    return;
                }

                clearLoginStatus();
                btn.disabled = true;
                btn.innerHTML = '<span class="icon" style="animation: spin 1s linear infinite;"><svg><use href="#icon-arrow-right"/></svg></span>';

                try {
                    // Check if user exists and has master role
                    const { data: publicUser } = await sb
                        .from('users')
                        .select('id, first_name, email, role')
                        .eq('email', email)
                        .maybeSingle();

                    if (!publicUser) {
                        setLoginStatus('Compte non trouve', 'error');
                        btn.disabled = false;
                        btn.innerHTML = '<span class="icon"><svg><use href="#icon-arrow-right"/></svg></span>';
                        return;
                    }

                    if (publicUser.role !== 'master') {
                        setLoginStatus('Acces reserve aux administrateurs Master', 'error');
                        btn.disabled = false;
                        btn.innerHTML = '<span class="icon"><svg><use href="#icon-arrow-right"/></svg></span>';
                        return;
                    }

                    setLoginStatus('Bienvenue ' + (publicUser.first_name || 'Admin') + ' !', 'success');
                    loginStep = 1;
                    updateLoginUI();

                } catch (error) {
                    console.error('Check email error:', error);
                    setLoginStatus('Erreur de connexion', 'error');
                } finally {
                    btn.disabled = false;
                    btn.innerHTML = '<span class="icon"><svg><use href="#icon-arrow-right"/></svg></span>';
                }

            } else if (loginStep === 1) {
                // Step 1: Password login
                const email = document.getElementById('loginEmailInput').value.trim();
                const password = document.getElementById('loginPasswordInput').value;

                if (!password) {
                    setLoginStatus('Veuillez entrer votre mot de passe', 'error');
                    return;
                }

                btn.disabled = true;
                btn.innerHTML = '<span class="icon" style="animation: spin 1s linear infinite;"><svg><use href="#icon-arrow-right"/></svg></span>';
                setLoginStatus('Connexion...', 'info');

                try {
                    const { data, error } = await sb.auth.signInWithPassword({ email, password });

                    if (error) {
                        if (error.message.includes('Invalid login credentials')) {
                            setLoginStatus('Email ou mot de passe incorrect', 'error');
                        } else {
                            setLoginStatus('Erreur: ' + error.message, 'error');
                        }
                        return;
                    }

                    clearLoginStatus();
                    // handleAuthenticatedUser will be called by onAuthStateChange

                } catch (error) {
                    setLoginStatus('Erreur de connexion au serveur', 'error');
                    console.error('Login error:', error);
                } finally {
                    btn.disabled = false;
                    btn.innerHTML = '<span class="icon"><svg><use href="#icon-arrow-right"/></svg></span>';
                }
            }
        }

        function prevLoginStep() {
            if (loginStep > 0) {
                loginStep--;
                clearLoginStatus();
                updateLoginUI();
            }
        }

        function updateLoginUI() {
            document.getElementById('loginSlider').style.transform = `translateX(-${loginStep * 100}%)`;
            document.getElementById('loginSphere').style.display = loginStep === 0 ? 'flex' : 'none';
            document.getElementById('loginBack').style.display = loginStep === 0 ? 'none' : 'flex';

            if (loginStep === 1) {
                setTimeout(() => document.getElementById('loginPasswordInput').focus(), 400);
            }
        }

        // ═══ SCREEN HELPERS ═══
        function showLoginScreen() {
            document.getElementById('loginScreen').classList.add('active');
            document.getElementById('accessDeniedScreen').classList.remove('active');
            document.getElementById('mainApp').classList.remove('active');
            loginStep = 0;
            updateLoginUI();
            clearLoginStatus();
        }

        function showAccessDeniedScreen(email) {
            document.getElementById('accessDeniedEmail').textContent = email;
            document.getElementById('loginScreen').classList.remove('active');
            document.getElementById('mainApp').classList.remove('active');
            document.getElementById('accessDeniedScreen').classList.add('active');
        }

        function showMainApp(profile) {
            document.getElementById('loginScreen').classList.remove('active');
            document.getElementById('accessDeniedScreen').classList.remove('active');
            document.getElementById('mainApp').classList.add('active');

            // Update UI with profile info
            const firstName = profile?.first_name || profile?.email?.split('@')[0] || 'Admin';
            document.getElementById('userName').textContent = firstName;
            document.getElementById('userAvatar').textContent = firstName.charAt(0).toUpperCase();

            toast('Bienvenue ' + firstName + ' !');
        }

        async function logout() {
            try {
                await sb.auth.signOut();
            } catch (err) {
                console.error('Logout error:', err);
            }
            supabaseUser = null;
            currentProfile = null;
            document.getElementById('loginEmailInput').value = '';
            document.getElementById('loginPasswordInput').value = '';
            showLoginScreen();
            toast('Deconnecte');
        }

        // ═══ UTILITIES ═══
        function setLoginStatus(message, type) {
            const status = document.getElementById('loginStatus');
            status.textContent = message;
            status.className = 'login-status ' + type;
        }

        function clearLoginStatus() {
            const status = document.getElementById('loginStatus');
            status.textContent = '';
            status.className = 'login-status';
        }

        let toastTimeout = null;
        function toast(message) {
            const t = document.getElementById('toast');
            if (!t) return;
            t.textContent = message;
            t.classList.add('show');
            if (toastTimeout) clearTimeout(toastTimeout);
            toastTimeout = setTimeout(() => {
                t.classList.remove('show');
            }, 2000);
        }

        // ═══ INIT ═══
        document.addEventListener('DOMContentLoaded', initSupabase);
    </script>
</body>
</html>
