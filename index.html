<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FixAIR Auth Test v3</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            background: #0a0a0a; 
            color: #fff;
            min-height: 100vh;
            padding: 20px;
        }
        .container { max-width: 500px; margin: 0 auto; }
        h1 { color: #10b981; margin-bottom: 20px; }
        h2 { color: #888; font-size: 14px; margin: 20px 0 10px; text-transform: uppercase; }
        
        .card {
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .form-group { margin-bottom: 15px; }
        label { display: block; color: #888; font-size: 12px; margin-bottom: 5px; }
        input {
            width: 100%;
            padding: 12px;
            background: #0a0a0a;
            border: 1px solid #333;
            border-radius: 8px;
            color: #fff;
            font-size: 16px;
        }
        input:focus { outline: none; border-color: #10b981; }
        
        button {
            width: 100%;
            padding: 12px 20px;
            background: #10b981;
            color: #000;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 10px;
        }
        button:hover { background: #0d9668; }
        button:disabled { background: #333; color: #666; cursor: not-allowed; }
        button.secondary { background: #333; color: #fff; }
        button.danger { background: #ef4444; }
        
        .status {
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            font-size: 14px;
        }
        .status.success { background: #10b98133; border: 1px solid #10b981; }
        .status.error { background: #ef444433; border: 1px solid #ef4444; }
        .status.info { background: #3b82f633; border: 1px solid #3b82f6; }
        
        .log {
            background: #000;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 15px;
            font-family: monospace;
            font-size: 11px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-break: break-all;
        }
        .log .time { color: #666; }
        .log .success { color: #10b981; }
        .log .error { color: #ef4444; }
        .log .info { color: #3b82f6; }
        .log .warn { color: #f59e0b; }
        
        .hidden { display: none; }
        
        .user-info {
            background: #10b98122;
            border: 1px solid #10b981;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }
        .user-info p { margin: 5px 0; font-size: 14px; }
        .user-info strong { color: #10b981; }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #888;
        }
        .spinner {
            display: inline-block;
            width: 30px;
            height: 30px;
            border: 3px solid #333;
            border-top-color: #10b981;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .recovery-card {
            background: #f59e0b22;
            border: 2px solid #f59e0b;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”§ FixAIR Auth Test v3</h1>
        
        <!-- Loading State -->
        <div class="card" id="loadingCard">
            <div class="loading">
                <div class="spinner"></div>
                <p style="margin-top: 15px;" id="loadingText">Initialisation...</p>
            </div>
        </div>
        
        <!-- Password Recovery Form (shown when clicking reset link) -->
        <div class="card recovery-card hidden" id="recoveryCard">
            <h2>ğŸ”‘ DÃ©finir un nouveau mot de passe</h2>
            <p style="color: #f59e0b; margin-bottom: 15px;">Vous avez cliquÃ© sur un lien de rÃ©initialisation</p>
            <div class="form-group">
                <label>Nouveau mot de passe</label>
                <input type="password" id="newPassword" placeholder="Min 6 caractÃ¨res">
            </div>
            <div class="form-group">
                <label>Confirmer le mot de passe</label>
                <input type="password" id="confirmPassword" placeholder="RÃ©pÃ©tez le mot de passe">
            </div>
            <button onclick="updatePassword()">Mettre Ã  jour le mot de passe</button>
            <div id="recoveryStatus"></div>
        </div>
        
        <!-- Current State -->
        <div class="card hidden" id="stateCard">
            <h2>Ã‰tat actuel</h2>
            <div id="currentState">
                <p>Chargement...</p>
            </div>
        </div>
        
        <!-- User Info (when logged in) -->
        <div class="card hidden" id="userInfoCard">
            <h2>Utilisateur connectÃ©</h2>
            <div class="user-info">
                <p><strong>Email:</strong> <span id="userEmail">-</span></p>
                <p><strong>Auth ID:</strong> <span id="userAuthId">-</span></p>
                <p><strong>Email confirmÃ© (auth):</strong> <span id="userEmailConfirmed">-</span></p>
                <p><strong>Status (public.users):</strong> <span id="userProfileStatus">-</span></p>
            </div>
            <button class="danger" onclick="logout()">Se dÃ©connecter</button>
            <button class="secondary" onclick="refreshState()" style="margin-top: 5px;">RafraÃ®chir</button>
        </div>
        
        <!-- Auth Forms (when not logged in) -->
        <div id="authForms" class="hidden">
            <!-- Signup -->
            <div class="card">
                <h2>1. CrÃ©er un compte</h2>
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="signupEmail" placeholder="nouveau@email.com">
                </div>
                <div class="form-group">
                    <label>Mot de passe</label>
                    <input type="password" id="signupPassword" placeholder="Min 6 caractÃ¨res">
                </div>
                <div class="form-group">
                    <label>PrÃ©nom</label>
                    <input type="text" id="signupName" placeholder="Votre prÃ©nom">
                </div>
                <button onclick="signup()">CrÃ©er le compte</button>
                <div id="signupStatus"></div>
            </div>
            
            <!-- Login -->
            <div class="card">
                <h2>2. Se connecter</h2>
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="loginEmail" placeholder="votre@email.com">
                </div>
                <div class="form-group">
                    <label>Mot de passe</label>
                    <input type="password" id="loginPassword" placeholder="Votre mot de passe">
                </div>
                <button onclick="login()">Se connecter</button>
                <div id="loginStatus"></div>
            </div>
            
            <!-- Password Reset -->
            <div class="card">
                <h2>3. RÃ©initialiser mot de passe</h2>
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="resetEmail" placeholder="votre@email.com">
                </div>
                <button class="secondary" onclick="resetPassword()">Envoyer le lien</button>
                <div id="resetStatus"></div>
            </div>
        </div>
        
        <!-- Admin Actions -->
        <div class="card hidden" id="adminCard">
            <h2>ğŸ”§ Actions Admin</h2>
            <div class="form-group">
                <label>Email Ã  approuver</label>
                <input type="email" id="approveEmail" placeholder="user@email.com">
            </div>
            <button class="secondary" onclick="approveUser()">Approuver</button>
            <div id="approveStatus"></div>
        </div>
        
        <!-- Debug Log -->
        <div class="card">
            <h2>ğŸ“‹ Log</h2>
            <div class="log" id="debugLog"></div>
            <button class="secondary" onclick="clearLog()" style="margin-top: 10px;">Effacer</button>
        </div>
    </div>

    <script>
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // CONFIGURATION
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        const SUPABASE_URL = 'https://fwuhzraxqrvmpqxnzpqm.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZ3dWh6cmF4cXJ2bXBxeG56cHFtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYyNTcyMTksImV4cCI6MjA4MTgzMzIxOX0.8ryQm1tsdx5ox3aFJiiflmwuEGGxxH_PlobGxXMgFuQ';
        
        let db = null;
        let isReady = false;
        let isRecoveryMode = false;
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // LOGGING
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function log(message, type = 'info') {
            const logEl = document.getElementById('debugLog');
            const time = new Date().toLocaleTimeString();
            logEl.innerHTML += `<span class="time">[${time}]</span> <span class="${type}">${message}</span>\n`;
            logEl.scrollTop = logEl.scrollHeight;
            console.log(`[${type.toUpperCase()}]`, message);
        }
        
        function clearLog() {
            document.getElementById('debugLog').innerHTML = '';
        }
        
        function showStatus(elementId, message, type) {
            const el = document.getElementById(elementId);
            if (el) {
                el.className = 'status ' + type;
                el.textContent = message;
            }
        }
        
        function setLoadingText(text) {
            document.getElementById('loadingText').textContent = text;
        }
        
        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // DETECT URL TOKEN TYPE
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function detectUrlToken() {
            const hash = window.location.hash;
            const params = new URLSearchParams(hash.replace('#', ''));
            
            if (hash.includes('type=recovery')) {
                return 'recovery';
            } else if (hash.includes('type=signup') || hash.includes('type=email_confirmation')) {
                return 'signup';
            } else if (hash.includes('access_token')) {
                return 'token';
            }
            return null;
        }
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // INITIALIZATION
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        async function init() {
            log('ğŸš€ Initializing v3...');
            log('URL: ' + window.location.href);
            
            // Detect token type
            const tokenType = detectUrlToken();
            
            if (tokenType) {
                log('ğŸ“§ Token detected: ' + tokenType, 'info');
                setLoadingText('Traitement du lien...');
            }
            
            // Create Supabase client
            db = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            log('âœ… Supabase client created');
            
            // Setup auth listener FIRST
            db.auth.onAuthStateChange((event, session) => {
                log(`ğŸ”” Auth event: ${event}`, event === 'SIGNED_IN' ? 'success' : 'info');
                
                if (event === 'PASSWORD_RECOVERY') {
                    log('ğŸ”‘ PASSWORD_RECOVERY mode activated!', 'warn');
                    isRecoveryMode = true;
                    showRecoveryForm();
                } else if (event === 'SIGNED_IN' && session && !isRecoveryMode) {
                    if (isReady) {
                        checkCurrentState();
                    }
                } else if (event === 'SIGNED_OUT') {
                    isRecoveryMode = false;
                    if (isReady) {
                        checkCurrentState();
                    }
                } else if (event === 'USER_UPDATED') {
                    log('âœ… User updated (password changed?)', 'success');
                    isRecoveryMode = false;
                    hideRecoveryForm();
                    checkCurrentState();
                }
            });
            
            // If we have a token, wait for Supabase to process it
            if (tokenType) {
                setLoadingText('Validation du token...');
                
                // Wait for auth state to settle
                await new Promise((resolve) => {
                    let resolved = false;
                    
                    const timeout = setTimeout(() => {
                        if (!resolved) {
                            log('âš ï¸ Token processing timeout (5s)', 'warn');
                            resolved = true;
                            resolve();
                        }
                    }, 5000);
                    
                    // Also listen for specific events
                    const checkInterval = setInterval(async () => {
                        const { data: { session } } = await db.auth.getSession();
                        if (session || isRecoveryMode) {
                            if (!resolved) {
                                clearTimeout(timeout);
                                clearInterval(checkInterval);
                                resolved = true;
                                await sleep(500); // Extra buffer
                                resolve();
                            }
                        }
                    }, 500);
                });
                
                // Clear the hash from URL (but keep the page functional)
                if (!isRecoveryMode) {
                    window.history.replaceState(null, '', window.location.pathname);
                    log('âœ… URL cleaned');
                }
            } else {
                // No token - just wait a moment for initial session
                await sleep(500);
            }
            
            isReady = true;
            log('âœ… Ready!', 'success');
            
            // Hide loading
            document.getElementById('loadingCard').classList.add('hidden');
            
            // Show appropriate UI
            if (isRecoveryMode) {
                showRecoveryForm();
            } else {
                document.getElementById('stateCard').classList.remove('hidden');
                document.getElementById('adminCard').classList.remove('hidden');
                await checkCurrentState();
            }
        }
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // RECOVERY FORM
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function showRecoveryForm() {
            document.getElementById('loadingCard').classList.add('hidden');
            document.getElementById('recoveryCard').classList.remove('hidden');
            document.getElementById('stateCard').classList.add('hidden');
            document.getElementById('userInfoCard').classList.add('hidden');
            document.getElementById('authForms').classList.add('hidden');
            document.getElementById('adminCard').classList.add('hidden');
            log('ğŸ“ Showing password recovery form', 'info');
        }
        
        function hideRecoveryForm() {
            document.getElementById('recoveryCard').classList.add('hidden');
            document.getElementById('stateCard').classList.remove('hidden');
            document.getElementById('adminCard').classList.remove('hidden');
        }
        
        async function updatePassword() {
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            if (!newPassword || newPassword.length < 6) {
                showStatus('recoveryStatus', 'Mot de passe minimum 6 caractÃ¨res', 'error');
                return;
            }
            
            if (newPassword !== confirmPassword) {
                showStatus('recoveryStatus', 'Les mots de passe ne correspondent pas', 'error');
                return;
            }
            
            log('ğŸ” Updating password...');
            
            try {
                const { data, error } = await db.auth.updateUser({
                    password: newPassword
                });
                
                if (error) {
                    log('Error: ' + error.message, 'error');
                    showStatus('recoveryStatus', error.message, 'error');
                    return;
                }
                
                log('âœ… Password updated!', 'success');
                showStatus('recoveryStatus', 'âœ… Mot de passe mis Ã  jour!', 'success');
                
                // Clear URL hash
                window.history.replaceState(null, '', window.location.pathname);
                
                // Wait then show normal UI
                await sleep(1500);
                isRecoveryMode = false;
                hideRecoveryForm();
                checkCurrentState();
                
            } catch (err) {
                log('Exception: ' + err.message, 'error');
                showStatus('recoveryStatus', err.message, 'error');
            }
        }
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // CHECK CURRENT STATE
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        async function checkCurrentState() {
            if (isRecoveryMode) return;
            
            log('Checking auth state...');
            
            try {
                const { data: { session }, error } = await db.auth.getSession();
                
                if (error) {
                    log('Session error: ' + error.message, 'error');
                    updateStateDisplay(null);
                    return;
                }
                
                if (session && session.user) {
                    log('âœ… Logged in: ' + session.user.email, 'success');
                    await checkPublicUser(session.user);
                    updateStateDisplay(session.user);
                } else {
                    log('Not logged in', 'info');
                    updateStateDisplay(null);
                }
            } catch (err) {
                log('Exception: ' + err.message, 'error');
                updateStateDisplay(null);
            }
        }
        
        async function refreshState() {
            log('ğŸ”„ Refreshing...');
            await checkCurrentState();
        }
        
        async function checkPublicUser(authUser) {
            log('Checking public.users...');
            
            try {
                const { data, error } = await db
                    .from('users')
                    .select('*')
                    .eq('id', authUser.id)
                    .maybeSingle();
                
                if (error) {
                    log('Query error: ' + error.message, 'error');
                    document.getElementById('userProfileStatus').textContent = 'Error';
                    return null;
                }
                
                if (data) {
                    log('âœ… Found - Status: ' + data.status, 'success');
                    document.getElementById('userProfileStatus').textContent = data.status;
                    return data;
                } else {
                    log('âš ï¸ NOT in public.users - creating...', 'warn');
                    
                    const { error: insertError } = await db
                        .from('users')
                        .insert({
                            id: authUser.id,
                            email: authUser.email,
                            first_name: authUser.user_metadata?.first_name || '',
                            status: 'pending',
                            email_confirmed: authUser.email_confirmed_at ? true : false,
                            created_at: new Date().toISOString()
                        });
                    
                    if (insertError) {
                        log('Insert error: ' + insertError.message, 'error');
                    } else {
                        log('âœ… Created!', 'success');
                        document.getElementById('userProfileStatus').textContent = 'pending (created)';
                    }
                    return null;
                }
            } catch (err) {
                log('Exception: ' + err.message, 'error');
                return null;
            }
        }
        
        function updateStateDisplay(user) {
            const stateEl = document.getElementById('currentState');
            const userInfoCard = document.getElementById('userInfoCard');
            const authForms = document.getElementById('authForms');
            
            if (user) {
                stateEl.innerHTML = '<p style="color: #10b981;">âœ… ConnectÃ©</p>';
                userInfoCard.classList.remove('hidden');
                authForms.classList.add('hidden');
                
                document.getElementById('userEmail').textContent = user.email;
                document.getElementById('userAuthId').textContent = user.id;
                document.getElementById('userEmailConfirmed').textContent = 
                    user.email_confirmed_at ? 'âœ… Oui' : 'âŒ Non';
            } else {
                stateEl.innerHTML = '<p style="color: #888;">Pas connectÃ©</p>';
                userInfoCard.classList.add('hidden');
                authForms.classList.remove('hidden');
            }
        }
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // SIGNUP
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        async function signup() {
            const email = document.getElementById('signupEmail').value.trim();
            const password = document.getElementById('signupPassword').value;
            const name = document.getElementById('signupName').value.trim();
            
            if (!email || !password) {
                showStatus('signupStatus', 'Email et mot de passe requis', 'error');
                return;
            }
            
            log('ğŸ“ Signing up: ' + email);
            
            try {
                const { data, error } = await db.auth.signUp({
                    email: email,
                    password: password,
                    options: {
                        data: { first_name: name },
                        emailRedirectTo: window.location.origin + window.location.pathname
                    }
                });
                
                if (error) {
                    log('Signup error: ' + error.message, 'error');
                    showStatus('signupStatus', error.message, 'error');
                    return;
                }
                
                log('âœ… Signup OK! ID: ' + data.user?.id, 'success');
                
                if (data.user && !data.user.email_confirmed_at) {
                    showStatus('signupStatus', 'âœ… VÃ©rifiez votre email!', 'success');
                } else {
                    showStatus('signupStatus', 'âœ… Compte crÃ©Ã©!', 'success');
                }
                
                setTimeout(checkCurrentState, 1000);
            } catch (err) {
                log('Exception: ' + err.message, 'error');
                showStatus('signupStatus', err.message, 'error');
            }
        }
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // LOGIN
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        async function login() {
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value;
            
            if (!email || !password) {
                showStatus('loginStatus', 'Email et mot de passe requis', 'error');
                return;
            }
            
            log('ğŸ” Logging in: ' + email);
            
            try {
                const { data, error } = await db.auth.signInWithPassword({ email, password });
                
                if (error) {
                    log('Login error: ' + error.message, 'error');
                    showStatus('loginStatus', error.message, 'error');
                    return;
                }
                
                log('âœ… Login OK!', 'success');
                showStatus('loginStatus', 'âœ… ConnectÃ©!', 'success');
                checkCurrentState();
            } catch (err) {
                log('Exception: ' + err.message, 'error');
                showStatus('loginStatus', err.message, 'error');
            }
        }
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // LOGOUT
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        async function logout() {
            log('ğŸ‘‹ Logging out...');
            
            try {
                const { error } = await db.auth.signOut();
                if (error) {
                    log('Logout error: ' + error.message, 'error');
                    return;
                }
                log('âœ… Logged out', 'success');
                checkCurrentState();
            } catch (err) {
                log('Exception: ' + err.message, 'error');
            }
        }
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // PASSWORD RESET
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        async function resetPassword() {
            const email = document.getElementById('resetEmail').value.trim();
            
            if (!email) {
                showStatus('resetStatus', 'Email requis', 'error');
                return;
            }
            
            log('ğŸ“§ Sending reset to: ' + email);
            
            try {
                const { error } = await db.auth.resetPasswordForEmail(email, {
                    redirectTo: window.location.origin + window.location.pathname
                });
                
                if (error) {
                    log('Reset error: ' + error.message, 'error');
                    showStatus('resetStatus', error.message, 'error');
                    return;
                }
                
                log('âœ… Email sent!', 'success');
                showStatus('resetStatus', 'âœ… VÃ©rifiez votre email!', 'success');
            } catch (err) {
                log('Exception: ' + err.message, 'error');
                showStatus('resetStatus', err.message, 'error');
            }
        }
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // APPROVE USER
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        async function approveUser() {
            const email = document.getElementById('approveEmail').value.trim();
            
            if (!email) {
                showStatus('approveStatus', 'Email requis', 'error');
                return;
            }
            
            log('âœ… Approving: ' + email);
            
            try {
                const { data, error } = await db
                    .from('users')
                    .update({ status: 'approved' })
                    .eq('email', email)
                    .select();
                
                if (error) {
                    log('Error: ' + error.message, 'error');
                    showStatus('approveStatus', error.message, 'error');
                    return;
                }
                
                if (data && data.length > 0) {
                    log('âœ… Approved!', 'success');
                    showStatus('approveStatus', 'âœ… ApprouvÃ©!', 'success');
                } else {
                    log('User not found', 'error');
                    showStatus('approveStatus', 'Non trouvÃ©', 'error');
                }
            } catch (err) {
                log('Exception: ' + err.message, 'error');
                showStatus('approveStatus', err.message, 'error');
            }
        }
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // START
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        init();
    </script>
</body>
</html>
