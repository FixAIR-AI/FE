<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FixAIR Auth - Minimal</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: -apple-system, sans-serif; background: #0a0a0a; color: #fff; min-height: 100vh; padding: 20px; }
        .container { max-width: 450px; margin: 0 auto; }
        h1 { color: #10b981; margin-bottom: 20px; font-size: 24px; }
        .card { background: #1a1a1a; border: 1px solid #333; border-radius: 12px; padding: 20px; margin-bottom: 15px; }
        .card h2 { color: #888; font-size: 12px; margin-bottom: 15px; text-transform: uppercase; }
        label { display: block; color: #888; font-size: 12px; margin-bottom: 5px; }
        input { width: 100%; padding: 12px; background: #0a0a0a; border: 1px solid #333; border-radius: 8px; color: #fff; font-size: 16px; margin-bottom: 10px; }
        input:focus { outline: none; border-color: #10b981; }
        button { width: 100%; padding: 12px; background: #10b981; color: #000; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; }
        button:hover { background: #0d9668; }
        button.secondary { background: #333; color: #fff; }
        button.danger { background: #ef4444; }
        .status { padding: 10px; border-radius: 8px; margin: 10px 0; font-size: 14px; }
        .status.success { background: #10b98133; border: 1px solid #10b981; }
        .status.error { background: #ef444433; border: 1px solid #ef4444; }
        .status.warning { background: #f59e0b33; border: 1px solid #f59e0b; }
        .hidden { display: none; }
        .loading { text-align: center; padding: 30px; }
        .spinner { width: 30px; height: 30px; border: 3px solid #333; border-top-color: #10b981; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 15px; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .user-box { background: #10b98122; border: 1px solid #10b981; border-radius: 8px; padding: 15px; margin-bottom: 15px; }
        .user-box p { margin: 5px 0; font-size: 14px; }
        .log { background: #000; border-radius: 8px; padding: 10px; font-family: monospace; font-size: 11px; max-height: 200px; overflow-y: auto; white-space: pre-wrap; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ðŸ”§ FixAIR Auth</h1>
        
        <!-- Loading -->
        <div class="card" id="loadingCard">
            <div class="loading">
                <div class="spinner"></div>
                <p id="loadingText">Chargement...</p>
            </div>
        </div>
        
        <!-- Password Reset Form -->
        <div class="card hidden" id="resetPasswordCard">
            <h2>ðŸ”‘ Nouveau mot de passe</h2>
            <div class="status warning">Vous avez cliquÃ© sur un lien de rÃ©initialisation</div>
            <label>Nouveau mot de passe</label>
            <input type="password" id="newPassword" placeholder="Min 6 caractÃ¨res">
            <label>Confirmer</label>
            <input type="password" id="confirmPassword" placeholder="RÃ©pÃ©tez">
            <button onclick="setNewPassword()">Mettre Ã  jour</button>
            <div id="resetPasswordStatus"></div>
        </div>
        
        <!-- Logged In -->
        <div class="card hidden" id="loggedInCard">
            <h2>âœ… ConnectÃ©</h2>
            <div class="user-box">
                <p><strong>Email:</strong> <span id="userEmail">-</span></p>
                <p><strong>Status:</strong> <span id="userStatus">-</span></p>
            </div>
            <button class="danger" onclick="doLogout()">Se dÃ©connecter</button>
        </div>
        
        <!-- Not Logged In -->
        <div class="card hidden" id="signupCard">
            <h2>1. CrÃ©er un compte</h2>
            <label>Email</label>
            <input type="email" id="signupEmail" placeholder="email@example.com">
            <label>Mot de passe</label>
            <input type="password" id="signupPassword" placeholder="Min 6 caractÃ¨res">
            <label>PrÃ©nom</label>
            <input type="text" id="signupName" placeholder="Votre prÃ©nom">
            <button onclick="doSignup()">CrÃ©er</button>
            <div id="signupStatus"></div>
        </div>
        
        <div class="card hidden" id="loginCard">
            <h2>2. Se connecter</h2>
            <label>Email</label>
            <input type="email" id="loginEmail" placeholder="email@example.com">
            <label>Mot de passe</label>
            <input type="password" id="loginPassword" placeholder="Mot de passe">
            <button onclick="doLogin()">Connexion</button>
            <div id="loginStatus"></div>
        </div>
        
        <div class="card hidden" id="forgotCard">
            <h2>3. Mot de passe oubliÃ©</h2>
            <label>Email</label>
            <input type="email" id="forgotEmail" placeholder="email@example.com">
            <button class="secondary" onclick="doForgotPassword()">Envoyer le lien</button>
            <div id="forgotStatus"></div>
        </div>
        
        <!-- Log -->
        <div class="card">
            <h2>Log</h2>
            <div class="log" id="log"></div>
        </div>
    </div>

    <script>
        // ===========================================
        // CONFIGURATION
        // ===========================================
        const SUPABASE_URL = 'https://fwuhzraxqrvmpqxnzpqm.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZ3dWh6cmF4cXJ2bXBxeG56cHFtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYyNTcyMTksImV4cCI6MjA4MTgzMzIxOX0.8ryQm1tsdx5ox3aFJiiflmwuEGGxxH_PlobGxXMgFuQ';
        
        let db = null;
        let currentUser = null;
        let isPasswordRecovery = false;
        let isReady = false;  // Prevents duplicate handling
        
        // ===========================================
        // LOGGING
        // ===========================================
        function log(msg) {
            const el = document.getElementById('log');
            const time = new Date().toLocaleTimeString();
            el.innerHTML += `[${time}] ${msg}\n`;
            el.scrollTop = el.scrollHeight;
            console.log(msg);
        }
        
        function showStatus(id, msg, type) {
            const el = document.getElementById(id);
            if (el) {
                el.className = 'status ' + type;
                el.innerHTML = msg;
            }
        }
        
        function showLoading(text) {
            document.getElementById('loadingText').textContent = text;
            document.getElementById('loadingCard').classList.remove('hidden');
        }
        
        function hideLoading() {
            document.getElementById('loadingCard').classList.add('hidden');
        }
        
        // ===========================================
        // UI UPDATES
        // ===========================================
        function showLoggedIn(user, status) {
            hideLoading();
            document.getElementById('resetPasswordCard').classList.add('hidden');
            document.getElementById('loggedInCard').classList.remove('hidden');
            document.getElementById('signupCard').classList.add('hidden');
            document.getElementById('loginCard').classList.add('hidden');
            document.getElementById('forgotCard').classList.add('hidden');
            
            document.getElementById('userEmail').textContent = user.email;
            document.getElementById('userStatus').textContent = status || 'unknown';
        }
        
        function showLoggedOut() {
            hideLoading();
            document.getElementById('resetPasswordCard').classList.add('hidden');
            document.getElementById('loggedInCard').classList.add('hidden');
            document.getElementById('signupCard').classList.remove('hidden');
            document.getElementById('loginCard').classList.remove('hidden');
            document.getElementById('forgotCard').classList.remove('hidden');
        }
        
        function showPasswordReset() {
            hideLoading();
            document.getElementById('resetPasswordCard').classList.remove('hidden');
            document.getElementById('loggedInCard').classList.add('hidden');
            document.getElementById('signupCard').classList.add('hidden');
            document.getElementById('loginCard').classList.add('hidden');
            document.getElementById('forgotCard').classList.add('hidden');
        }
        
        // ===========================================
        // GET USER STATUS FROM public.users
        // ===========================================
        async function getUserStatus(userId) {
            try {
                const { data, error } = await db
                    .from('users')
                    .select('status')
                    .eq('id', userId)
                    .maybeSingle();
                
                if (error) {
                    log('Status error: ' + error.message);
                    return 'error';
                }
                
                if (data) {
                    return data.status;
                }
                
                // User not in public.users - create them
                log('Creating user in public.users...');
                await db.from('users').insert({
                    id: userId,
                    email: currentUser.email,
                    status: 'pending',
                    created_at: new Date().toISOString()
                });
                return 'pending';
                
            } catch (err) {
                log('Exception: ' + err.message);
                return 'error';
            }
        }
        
        // ===========================================
        // LOAD USER AND SHOW APP (uses session from callback - no getSession call)
        // ===========================================
        async function loadUserAndShowApp(user) {
            if (!user) {
                log('No user provided');
                showLoggedOut();
                return;
            }

            currentUser = user;
            log('Logged in: ' + user.email);

            try {
                const status = await getUserStatus(user.id);
                showLoggedIn(user, status);
            } catch (err) {
                log('Error loading user status: ' + err.message);
                showLoggedIn(user, 'unknown');
            }
        }
        
        // ===========================================
        // AUTH ACTIONS
        // ===========================================
        async function doSignup() {
            const email = document.getElementById('signupEmail').value.trim();
            const password = document.getElementById('signupPassword').value;
            const name = document.getElementById('signupName').value.trim();
            
            if (!email || !password) {
                showStatus('signupStatus', 'Email et mot de passe requis', 'error');
                return;
            }
            
            log('Signing up: ' + email);
            
            try {
                const { data, error } = await db.auth.signUp({
                    email,
                    password,
                    options: {
                        data: { first_name: name },
                        emailRedirectTo: window.location.origin + window.location.pathname
                    }
                });
                
                if (error) {
                    showStatus('signupStatus', error.message, 'error');
                    return;
                }
                
                log('Signup OK!');
                showStatus('signupStatus', 'âœ… VÃ©rifiez votre email!', 'success');
                
            } catch (err) {
                showStatus('signupStatus', err.message, 'error');
            }
        }
        
        async function doLogin() {
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value;
            
            if (!email || !password) {
                showStatus('loginStatus', 'Email et mot de passe requis', 'error');
                return;
            }
            
            log('Logging in: ' + email);
            
            try {
                const { error } = await db.auth.signInWithPassword({ email, password });
                
                if (error) {
                    showStatus('loginStatus', error.message, 'error');
                    return;
                }
                
                log('Login OK!');
                // Auth state change will handle UI update
                
            } catch (err) {
                showStatus('loginStatus', err.message, 'error');
            }
        }
        
        async function doLogout() {
            log('Logging out...');
            localStorage.removeItem('supabase.auth.token');
            await db.auth.signOut();
        }
        
        async function doForgotPassword() {
            const email = document.getElementById('forgotEmail').value.trim();
            
            if (!email) {
                showStatus('forgotStatus', 'Email requis', 'error');
                return;
            }
            
            log('Sending reset: ' + email);
            
            try {
                const { error } = await db.auth.resetPasswordForEmail(email, {
                    redirectTo: window.location.origin + window.location.pathname
                });
                
                if (error) {
                    showStatus('forgotStatus', error.message, 'error');
                    return;
                }
                
                showStatus('forgotStatus', 'âœ… VÃ©rifiez votre email!', 'success');
                
            } catch (err) {
                showStatus('forgotStatus', err.message, 'error');
            }
        }
        
        async function setNewPassword() {
            const newPass = document.getElementById('newPassword').value;
            const confirmPass = document.getElementById('confirmPassword').value;

            if (!newPass || newPass.length < 6) {
                showStatus('resetPasswordStatus', 'Min 6 caractÃ¨res', 'error');
                return;
            }

            if (newPass !== confirmPass) {
                showStatus('resetPasswordStatus', 'Les mots de passe ne correspondent pas', 'error');
                return;
            }

            log('Updating password...');

            try {
                const { error } = await db.auth.updateUser({ password: newPass });

                if (error) {
                    showStatus('resetPasswordStatus', error.message, 'error');
                    return;
                }

                log('Password updated!');
                showStatus('resetPasswordStatus', 'âœ… Mot de passe mis Ã  jour!', 'success');

                // Clean URL AFTER successful update
                window.history.replaceState(null, '', window.location.pathname);

                // USER_UPDATED event will fire automatically and handle UI update
                // No need to call anything manually - just reset the recovery flag
                isPasswordRecovery = false;

            } catch (err) {
                showStatus('resetPasswordStatus', err.message, 'error');
            }
        }
        
        // ===========================================
        // PARSE URL HASH FOR TOKENS
        // ===========================================
        function parseHashParams(hash) {
            if (!hash || hash.length < 2) return {};
            const params = {};
            const hashContent = hash.substring(1); // Remove #
            const pairs = hashContent.split('&');
            for (const pair of pairs) {
                const [key, value] = pair.split('=');
                if (key && value) {
                    params[decodeURIComponent(key)] = decodeURIComponent(value);
                }
            }
            return params;
        }

        // ===========================================
        // INITIALIZATION
        // ===========================================
        async function init() {
            log('Starting...');
            showLoading('Initialisation...');

            // Parse URL hash for tokens BEFORE creating client
            const hash = window.location.hash;
            const hashParams = parseHashParams(hash);

            const hasAccessToken = !!hashParams.access_token;
            const hasRefreshToken = !!hashParams.refresh_token;
            const tokenType = hashParams.type; // 'recovery', 'signup', 'magiclink', etc.
            const isRecoveryLink = tokenType === 'recovery';

            if (isRecoveryLink) {
                log('Recovery token detected in URL');
                showLoading('Traitement du lien de rÃ©cupÃ©ration...');
            } else if (hasAccessToken) {
                log('Auth token detected in URL (type: ' + (tokenType || 'unknown') + ')');
                showLoading('Confirmation en cours...');
            }

            // CRITICAL: Clean URL hash BEFORE creating Supabase client
            // This prevents Supabase from internally trying to process the tokens
            // which causes AbortError in fresh browsers
            if (hash) {
                window.history.replaceState(null, '', window.location.pathname + window.location.search);
                log('URL hash removed before client creation');
            }

            // Create Supabase client - DISABLE automatic features
            db = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY, {
                auth: {
                    autoRefreshToken: false,
                    persistSession: false,
                    detectSessionInUrl: false
                }
            });

            log('Client created');

            // Set up auth state change listener FIRST
            db.auth.onAuthStateChange((event, session) => {
                log('Auth event: ' + event);

                if (event === 'PASSWORD_RECOVERY') {
                    log('PASSWORD_RECOVERY mode');
                    isPasswordRecovery = true;
                    isReady = true;
                    showPasswordReset();
                } else if (event === 'SIGNED_IN') {
                    if (isPasswordRecovery) {
                        // During password recovery, stay on reset form
                        showPasswordReset();
                    } else {
                        isReady = true;
                        loadUserAndShowApp(session.user);
                    }
                } else if (event === 'SIGNED_OUT') {
                    isPasswordRecovery = false;
                    isReady = true;
                    currentUser = null;
                    showLoggedOut();
                } else if (event === 'USER_UPDATED') {
                    log('User updated');
                    isPasswordRecovery = false;
                    isReady = true;
                    if (session && session.user) {
                        loadUserAndShowApp(session.user);
                    }
                } else if (event === 'INITIAL_SESSION') {
                    // Only handle if we're NOT processing URL tokens manually
                    if (!hasAccessToken) {
                        if (session && session.user) {
                            isReady = true;
                            loadUserAndShowApp(session.user);
                        } else {
                            isReady = true;
                            showLoggedOut();
                        }
                    }
                }
            });

            // If we have tokens in URL, manually set the session
            if (hasAccessToken && hasRefreshToken) {
                log('Manually processing URL tokens...');

                try {
                    // Set the session using the tokens from the URL
                    const { data, error } = await db.auth.setSession({
                        access_token: hashParams.access_token,
                        refresh_token: hashParams.refresh_token
                    });

                    if (error) {
                        log('setSession error: ' + error.message);
                        showLoggedOut();
                        return;
                    }

                    log('Session set successfully');

                    // Manually persist session to localStorage since we disabled persistSession
                    if (data.session) {
                        localStorage.setItem('supabase.auth.token', JSON.stringify({
                            currentSession: data.session,
                            expiresAt: data.session.expires_at
                        }));
                        log('Session saved to localStorage');
                    }

                    // Handle based on token type
                    if (isRecoveryLink) {
                        log('Showing password reset form');
                        isPasswordRecovery = true;
                        isReady = true;
                        showPasswordReset();
                    } else if (data.session && data.session.user) {
                        log('User authenticated: ' + data.session.user.email);
                        isReady = true;
                        loadUserAndShowApp(data.session.user);
                    }

                } catch (err) {
                    log('Exception during token processing: ' + err.message);
                    console.error('Token processing error:', err);
                    showLoggedOut();
                }
            } else if (hasAccessToken && !hasRefreshToken) {
                // Some flows only have access_token - try to use it anyway
                log('Only access_token found, attempting session...');

                try {
                    const { data, error } = await db.auth.setSession({
                        access_token: hashParams.access_token,
                        refresh_token: hashParams.access_token // Use same token as fallback
                    });

                    if (error) {
                        log('setSession error (no refresh): ' + error.message);
                        showLoggedOut();
                        return;
                    }

                    // Manually persist session
                    if (data.session) {
                        localStorage.setItem('supabase.auth.token', JSON.stringify({
                            currentSession: data.session,
                            expiresAt: data.session.expires_at
                        }));
                    }

                    if (isRecoveryLink) {
                        isPasswordRecovery = true;
                        isReady = true;
                        showPasswordReset();
                    } else if (data.session && data.session.user) {
                        isReady = true;
                        loadUserAndShowApp(data.session.user);
                    }

                } catch (err) {
                    log('Exception: ' + err.message);
                    showLoggedOut();
                }
            } else {
                // No URL tokens - check localStorage for existing session
                try {
                    const stored = localStorage.getItem('supabase.auth.token');
                    if (stored) {
                        const parsed = JSON.parse(stored);
                        if (parsed.currentSession) {
                            log('Found stored session, restoring...');
                            const { data, error } = await db.auth.setSession({
                                access_token: parsed.currentSession.access_token,
                                refresh_token: parsed.currentSession.refresh_token
                            });
                            if (!error && data.session) {
                                isReady = true;
                                loadUserAndShowApp(data.session.user);
                                return;
                            }
                        }
                    }
                } catch (err) {
                    log('Error restoring session: ' + err.message);
                }
                // No valid session found
                isReady = true;
                showLoggedOut();
            }
        }
        
        // Start
        init();
    </script>
</body>
</html>
