<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>FixAIR Operations</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            /* V7 Colors - Purple/Navy from fixair-admin-complete */
            --card-bg: #252a3d;
            --card-bg-hover: #2d3348;
            --card-bg-transparent: rgba(37, 42, 61, 0.25);
            --card-bg-semi: rgba(37, 42, 61, 0.55);
            --card-bg-glass: rgba(37, 42, 61, 0.85);
            --page-bg: #0d0f14;
            
            /* Accent Colors */
            --accent-blue: #5096ff;
            --accent-green: #50dc78;
            --accent-purple: #9966ff;
            --accent-orange: #ffaa32;
            --accent-cyan: #50dcdc;
            --accent-red: #ee5566;
            
            /* Team Colors */
            --team-nord: #5096ff;
            --team-sud: #50dc78;
            --team-direct: #ffaa32;
            
            /* Glows */
            --glow-nord: rgba(80, 150, 255, 0.4);
            --glow-sud: rgba(80, 220, 120, 0.4);
            --glow-direct: rgba(255, 170, 50, 0.4);
            
            /* Text */
            --text-primary: rgba(255, 255, 255, 0.92);
            --text-secondary: rgba(255, 255, 255, 0.6);
            --text-tertiary: rgba(255, 255, 255, 0.35);
            --text-muted: rgba(255, 255, 255, 0.2);
            
            /* Borders & Effects */
            --border-subtle: rgba(255, 255, 255, 0.06);
            --border-light: rgba(255, 255, 255, 0.1);
            --glow: 0 8px 32px rgba(0, 0, 0, 0.4);
            --glow-strong: 0 12px 48px rgba(0, 0, 0, 0.5);
            
            /* Security Layer CSS Variables */
            --copilot: #FF6B35;
            --copilot-glow: rgba(255, 107, 53, 0.4);
            --copilot-bg: rgba(255, 107, 53, 0.08);
            --copilot-border: rgba(255, 107, 53, 0.2);
            --bg: #0D1117;
            --bg-secondary: #161b22;
            --card: rgba(255, 255, 255, 0.03);
            --border: rgba(255, 255, 255, 0.06);
            --text: rgba(255, 255, 255, 0.9);
            --text-dim: rgba(255, 255, 255, 0.35);
            --grid-color: rgba(255,255,255,0.015);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--page-bg);
            color: var(--text-primary);
            height: 100vh;
            overflow: hidden;
        }

        #map { position: fixed; inset: 0; z-index: 0; }

        /* ═══════════════════════════════════════════════════════════
           BOTTOM BAR - Spotlight Navigation
           Circle height = Main card height = 64px
        ═══════════════════════════════════════════════════════════ */
        .bottom-bar {
            position: fixed;
            bottom: 24px;
            left: 24px;
            z-index: 100;
            display: flex;
            align-items: flex-end;
            gap: 12px;
        }

        /* Navigation Circles - TRUE CIRCLES (width = height = 64px) */
        .nav-circle {
            width: 64px;
            height: 64px;
            border-radius: 50%;
            background: var(--card-bg);
            border: 1px solid var(--border-subtle);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: width 0.25s ease, border-radius 0.25s ease, gap 0.25s ease, border-color 0.2s ease;
            box-shadow: var(--glow);
            color: white;
            gap: 0;
            overflow: hidden;
            white-space: nowrap;
            flex-shrink: 0;
        }
        .nav-circle:hover {
            width: 150px;
            border-radius: 100px;
            gap: 10px;
            border-color: var(--border-light);
        }
        .nav-circle.active {
            border-color: rgba(80, 150, 255, 0.4);
        }
        .nav-circle svg { 
            width: 22px; 
            height: 22px; 
            fill: currentColor;
            flex-shrink: 0;
        }
        .nav-circle .nav-text {
            font-size: 13px;
            font-weight: 500;
            width: 0;
            opacity: 0;
            transition: width 0.25s ease, opacity 0.2s ease;
            overflow: hidden;
        }
        .nav-circle:hover .nav-text {
            width: 70px;
            opacity: 1;
        }

        .profile-initials {
            font-weight: 700;
            font-size: 16px;
            letter-spacing: -0.5px;
            flex-shrink: 0;
        }

        /* ═══════════════════════════════════════════════════════════
           APPLE DOCK NAVIGATION - Circle that expands horizontally
        ═══════════════════════════════════════════════════════════ */
        .dock-container {
            position: relative;
        }

        .dock {
            height: 64px;
            display: flex;
            align-items: center;
            background: var(--card-bg);
            border: 1px solid var(--border-subtle);
            border-radius: 100px;
            padding: 0 12px;
            box-shadow: var(--glow);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            overflow: hidden;
            width: 64px;
        }

        .dock:hover {
            width: auto;
            padding: 0 14px;
        }

        .dock-item {
            width: 0;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.25s cubic-bezier(0.34, 1.56, 0.64, 1);
            position: relative;
            opacity: 0;
            overflow: hidden;
            flex-shrink: 0;
        }

        .dock-item:first-child {
            width: 40px;
            opacity: 1;
        }

        .dock:hover .dock-item {
            width: 44px;
            opacity: 1;
        }

        .dock-item-icon {
            width: 36px;
            height: 36px;
            min-width: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255,255,255,0.08);
            border-radius: 10px;
            color: var(--text-secondary);
            transition: all 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .dock-item svg {
            width: 18px;
            height: 18px;
            fill: currentColor;
            transition: all 0.2s;
        }

        .dock-item:hover {
            transform: translateY(-10px);
        }

        .dock-item:hover .dock-item-icon {
            transform: scale(1.25);
            background: rgba(255,255,255,0.15);
            color: white;
        }

        .dock:hover .dock-item:hover + .dock-item .dock-item-icon,
        .dock:hover .dock-item:has(+ .dock-item:hover) .dock-item-icon {
            transform: scale(1.08);
        }

        .dock:hover .dock-item:hover + .dock-item,
        .dock:hover .dock-item:has(+ .dock-item:hover) {
            transform: translateY(-4px);
        }

        .dock-divider {
            width: 0;
            height: 28px;
            background: var(--border-subtle);
            margin: 0;
            flex-shrink: 0;
            pointer-events: none;
            opacity: 0;
            transition: all 0.25s ease;
        }

        .dock:hover .dock-divider {
            width: 1px;
            margin: 0 8px;
            opacity: 1;
        }

        .dock-tooltip {
            position: absolute;
            bottom: 76px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--card-bg);
            border: 1px solid var(--border-subtle);
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 500;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: all 0.15s ease;
            pointer-events: none;
            box-shadow: var(--glow);
        }

        .dock-tooltip.visible {
            opacity: 1;
            visibility: visible;
        }

        /* ═══════════════════════════════════════════════════════════
           MAIN CARD - EXACT from fixair-admin-complete (480px)
        ═══════════════════════════════════════════════════════════ */
        .map-left-panel {
            display: flex;
            flex-direction: column;
            max-height: calc(100vh - 120px);
            width: 480px;
        }

        /* Projects List */
        .map-projects-list {
            display: none;
            flex-direction: column;
            gap: 6px;
            max-height: calc(100vh - 220px);
            overflow-y: auto;
            padding: 8px;
            padding-bottom: 12px;
            background: var(--card-bg-transparent);
            backdrop-filter: blur(20px);
            border: 1px solid var(--border-subtle);
            border-bottom: 1px solid var(--border-light);
            border-radius: 14px 14px 0 0;
        }
        .map-projects-list::-webkit-scrollbar { width: 4px; }
        .map-projects-list::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.1); border-radius: 2px; }
        .map-left-panel.expanded .map-projects-list { display: flex; }

        /* Main Summary Card - 480px width, 64px height collapsed */
        .map-main-card {
            background: var(--card-bg);
            border: 1px solid var(--border-subtle);
            border-radius: 100px;
            padding: 16px 28px;
            display: flex;
            align-items: center;
            box-shadow: var(--glow);
            cursor: pointer;
            transition: all 0.35s cubic-bezier(0.4, 0, 0.2, 1);
            width: 480px;
            height: 64px;
        }
        .map-left-panel.expanded .map-main-card {
            border-radius: 0 0 14px 14px;
            border-top-color: var(--border-light);
            height: auto;
            padding: 20px 28px;
        }

        .map-main-card .section {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }
        .map-main-card .section-right { align-items: flex-end; }
        .map-main-card .section-center { align-items: stretch; flex: 1; }

        .map-main-card .divider {
            width: 1px;
            height: 28px;
            background: var(--border-light);
            margin: 0 20px;
            transition: all 0.35s ease;
        }
        .map-left-panel.expanded .map-main-card .divider {
            height: 44px;
            margin: 0 24px;
        }

        .map-main-card .count {
            font-size: 32px;
            font-weight: 700;
            line-height: 1;
            transition: font-size 0.35s ease;
        }
        .map-left-panel.expanded .map-main-card .count { font-size: 36px; }

        .map-main-card .count-label {
            font-size: 11px;
            color: var(--text-tertiary);
            margin-top: 4px;
            display: none;
        }
        .map-left-panel.expanded .map-main-card .count-label { display: block; }

        .map-main-card .progress-header {
            display: none;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            margin-bottom: 8px;
        }
        .map-left-panel.expanded .map-main-card .progress-header { display: flex; }

        .map-main-card .label {
            font-size: 9px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .map-main-card .progress-row {
            display: flex;
            align-items: center;
            gap: 12px;
            width: 100%;
        }

        .map-main-card .progress-bar {
            flex: 1;
            height: 6px;
            background: rgba(255, 255, 255, 0.08);
            border-radius: 3px;
            overflow: hidden;
        }
        .map-main-card .progress-fill {
            height: 100%;
            width: 78%;
            background: var(--accent-green);
            border-radius: 3px;
        }

        .map-main-card .progress-value {
            font-size: 18px;
            font-weight: 600;
            color: var(--accent-green);
        }
        .map-main-card .progress-value-inline {
            font-size: 14px;
            font-weight: 600;
            color: var(--accent-green);
            white-space: nowrap;
        }
        .map-left-panel.expanded .map-main-card .progress-value-inline { display: none; }

        .map-main-card .trend {
            font-size: 13px;
            font-weight: 600;
            color: var(--accent-green);
            transition: font-size 0.35s ease;
        }
        .map-left-panel.expanded .map-main-card .trend { font-size: 16px; }

        .map-main-card .trend-label {
            font-size: 10px;
            color: var(--text-muted);
            margin-top: 4px;
            display: none;
        }
        .map-left-panel.expanded .map-main-card .trend-label { display: block; }

        /* Map Project Card */
        .map-project-card {
            background: var(--card-bg-semi);
            backdrop-filter: blur(12px);
            border: 1px solid var(--border-subtle);
            border-radius: 12px;
            padding: 14px 16px;
            display: grid;
            grid-template-columns: 4px 1fr auto auto;
            align-items: center;
            gap: 14px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .map-project-card:hover {
            background: var(--card-bg);
            border-color: var(--border-light);
        }
        .map-project-card.active {
            background: var(--card-bg);
            border-color: rgba(80, 150, 255, 0.3);
        }

        .map-project-card .team-bar {
            width: 4px;
            align-self: stretch;
            border-radius: 2px;
            min-height: 36px;
        }
        .map-project-card .team-bar.nord { background: var(--team-nord); box-shadow: 0 0 8px var(--glow-nord); }
        .map-project-card .team-bar.sud { background: var(--team-sud); box-shadow: 0 0 8px var(--glow-sud); }
        .map-project-card .team-bar.direct { background: var(--team-direct); box-shadow: 0 0 8px var(--glow-direct); }

        .map-project-card .content { min-width: 0; }
        .map-project-card .title { font-size: 13px; font-weight: 500; margin-bottom: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .map-project-card .tech { font-size: 11px; color: var(--text-tertiary); }

        .map-project-card .progress { display: flex; align-items: center; gap: 10px; }
        .map-project-card .progress-bar { width: 60px; height: 3px; background: rgba(255, 255, 255, 0.08); border-radius: 2px; overflow: hidden; }
        .map-project-card .progress-fill { height: 100%; border-radius: 2px; }
        .map-project-card .progress-value { font-size: 11px; font-weight: 600; color: var(--text-secondary); min-width: 32px; text-align: right; }

        .map-project-card .id {
            font-size: 10px;
            color: var(--text-muted);
            background: rgba(255, 255, 255, 0.04);
            padding: 4px 8px;
            border-radius: 4px;
        }

        /* ═══════════════════════════════════════════════════════════
           VIEW TOGGLE - Right side, aligned with Mapbox controls
        ═══════════════════════════════════════════════════════════ */
        .view-toggle {
            position: fixed;
            right: 10px;
            bottom: 130px;
            z-index: 50;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0;
            background: var(--card-bg);
            border-radius: 10px;
            border: 1px solid var(--border-subtle);
            box-shadow: var(--glow);
            overflow: hidden;
        }
        .toggle-btn {
            width: 29px;
            height: 29px;
            background: transparent;
            border: none;
            border-bottom: 1px solid var(--border-subtle);
            color: var(--text-tertiary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }
        .toggle-btn:last-child { border-bottom: none; }
        .toggle-btn:hover { color: var(--text-secondary); background: rgba(255,255,255,0.03); }
        .toggle-btn.active { background: rgba(80,150,255,0.15); color: var(--accent-blue); }
        .toggle-btn svg { width: 14px; height: 14px; fill: currentColor; }

        /* ═══════════════════════════════════════════════════════════
           FULL PAGES - Same colors as main card
        ═══════════════════════════════════════════════════════════ */
        .full-page {
            position: fixed;
            inset: 0;
            background: var(--page-bg);
            z-index: 200;
            display: none;
            flex-direction: column;
        }
        .full-page.active { display: flex; }
        .page-layout { display: flex; flex: 1; overflow: hidden; }
        .page-main { flex: 1; display: flex; flex-direction: column; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); min-width: 0; }
        .full-page.drawer-open .page-main { flex: 0 0 50%; max-width: 50%; }
        .page-content { flex: 1; overflow-y: auto; padding: 24px; scrollbar-width: none; }
        .page-content::-webkit-scrollbar { width: 6px; }
        .page-content::-webkit-scrollbar-track { background: transparent; }
        .page-content::-webkit-scrollbar-thumb { background: transparent; border-radius: 3px; transition: background 0.3s; }
        .page-content:hover::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.15); }
        .drawer-body { flex: 1; overflow-y: auto; padding: 20px; scrollbar-width: none; }
        .drawer-body::-webkit-scrollbar { width: 6px; }
        .drawer-body::-webkit-scrollbar-track { background: transparent; }
        .drawer-body::-webkit-scrollbar-thumb { background: transparent; border-radius: 3px; }
        .drawer-body:hover::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.15); }
        .page-content-inner { max-width: 700px; margin: 0 auto; }

        .page-header {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 24px;
            padding-top: max(12px, env(safe-area-inset-top));
            background: var(--card-bg);
            border-bottom: 1px solid var(--border-subtle);
            flex-shrink: 0;
            height: 56px;
        }
        .page-back {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border-subtle);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: var(--text-tertiary);
            transition: all 0.2s;
            flex-shrink: 0;
        }
        .page-back:hover { background: rgba(255,255,255,0.08); color: var(--text-primary); }
        .page-back svg { width: 16px; height: 16px; }
        .page-title-wrap { flex: 1; display: flex; align-items: center; gap: 8px; }
        .page-title { font-size: 16px; font-weight: 600; }
        .page-subtitle { font-size: 13px; color: var(--text-tertiary); }
        .page-subtitle::before { content: '•'; margin-right: 8px; }
        .page-actions { display: flex; gap: 8px; }
        .page-action-btn {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: rgba(80, 150, 255, 0.15);
            border: 1px solid rgba(80, 150, 255, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: var(--accent-blue);
            transition: all 0.2s;
        }
        .page-action-btn:hover { background: rgba(80,150,255,0.25); transform: scale(1.05); }
        .page-action-btn svg { width: 16px; height: 16px; }
        .page-action-btn.secondary { background: rgba(255,255,255,0.05); border-color: var(--border-subtle); color: var(--text-tertiary); }
        .page-action-btn.secondary:hover { background: rgba(255,255,255,0.08); color: var(--text-primary); }

        /* Stats Grid */
        .stats { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 20px; }

        /* Search & Filter Bar */
        .search-filter-bar {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 20px;
        }
        .search-input-wrap {
            position: relative;
        }
        .search-input-wrap::before {
            content: '';
            position: absolute;
            left: 16px;
            top: 50%;
            transform: translateY(-50%);
            width: 16px;
            height: 16px;
            background: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='rgba(255,255,255,0.3)' viewBox='0 0 16 16'%3E%3Cpath d='M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z'/%3E%3C/svg%3E") no-repeat center;
        }
        .search-input {
            width: 100%;
            background: rgba(255,255,255,0.03);
            border: 1px solid var(--border-subtle);
            border-radius: 12px;
            padding: 12px 16px 12px 44px;
            font-size: 14px;
            color: var(--text-primary);
            outline: none;
            transition: all 0.2s;
        }
        .search-input:focus { border-color: var(--accent-blue); background: rgba(255,255,255,0.05); }
        .search-input::placeholder { color: var(--text-muted); }
        .filter-tabs {
            display: flex;
            background: rgba(255,255,255,0.02);
            border: 1px solid var(--border-subtle);
            border-radius: 12px;
            padding: 4px;
            gap: 4px;
        }
        .filter-tab {
            flex: 1;
            padding: 10px 16px;
            font-size: 13px;
            font-weight: 500;
            text-align: center;
            color: var(--text-tertiary);
            background: transparent;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .filter-tab:hover { color: var(--text-secondary); background: rgba(255,255,255,0.03); }
        .filter-tab.active { background: rgba(80, 150, 255, 0.15); color: var(--accent-blue); }
        .stat {
            background: var(--card-bg);
            border: 1px solid var(--border-subtle);
            border-radius: 14px;
            padding: 18px 16px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        .stat:hover { background: var(--card-bg-hover); border-color: var(--border-light); }
        .stat-value { font-size: 28px; font-weight: 700; letter-spacing: -1px; margin-bottom: 4px; }
        .stat-value.blue { color: var(--accent-blue); }
        .stat-value.green { color: var(--accent-green); }
        .stat-value.orange { color: var(--accent-orange); }
        .stat-value.purple { color: var(--accent-purple); }
        .stat-label { font-size: 10px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; }

        /* Section Headers */
        .sec-head { display: flex; align-items: center; gap: 12px; margin-bottom: 14px; }
        .sec-title { font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-muted); }
        .sec-line { flex: 1; height: 1px; background: var(--border-subtle); }
        .sec-action { font-size: 12px; color: var(--accent-blue); cursor: pointer; }

        /* Cards List */
        .card-list { display: flex; flex-direction: column; gap: 12px; margin-bottom: 24px; }

        .proj {
            display: flex;
            align-items: center;
            gap: 14px;
            padding: 16px;
            background: var(--card-bg);
            border: 1px solid var(--border-subtle);
            border-radius: 14px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }
        .proj:hover { background: var(--card-bg-hover); border-color: var(--border-light); }
        .proj-status-bar { position: absolute; left: 0; top: 14px; bottom: 14px; width: 4px; border-radius: 0 2px 2px 0; }
        .proj-status-bar.nord { background: var(--team-nord); }
        .proj-status-bar.sud { background: var(--team-sud); }
        .proj-status-bar.direct { background: var(--team-direct); }
        .proj-icon {
            width: 42px;
            height: 42px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            margin-left: 6px;
        }
        .proj-icon.nord { background: rgba(80, 150, 255, 0.15); color: var(--team-nord); }
        .proj-icon.sud { background: rgba(80, 220, 120, 0.15); color: var(--team-sud); }
        .proj-icon.direct { background: rgba(255, 170, 50, 0.15); color: var(--team-direct); }
        .proj-icon svg { width: 18px; height: 18px; }
        .proj-info { flex: 1; min-width: 0; }
        .proj-title { font-size: 14px; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-bottom: 4px; }
        .proj-meta { font-size: 12px; color: var(--text-tertiary); }
        .proj-right { text-align: right; flex-shrink: 0; }
        .proj-progress { display: flex; align-items: center; gap: 10px; margin-bottom: 6px; }
        .proj-progress-bar { width: 70px; height: 4px; background: rgba(255,255,255,0.08); border-radius: 2px; overflow: hidden; }
        .proj-progress-fill { height: 100%; border-radius: 2px; }
        .proj-progress-value { font-size: 12px; font-weight: 600; min-width: 36px; text-align: right; }
        .proj-id { font-size: 10px; color: var(--text-muted); }

        .tech-card {
            display: flex;
            align-items: center;
            gap: 14px;
            padding: 16px;
            background: var(--card-bg);
            border: 1px solid var(--border-subtle);
            border-radius: 14px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .tech-card:hover { background: var(--card-bg-hover); border-color: var(--border-light); }
        .tech-avatar {
            width: 42px;
            height: 42px;
            border-radius: 50%;
            background: rgba(255,255,255,0.06);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 600;
            position: relative;
            flex-shrink: 0;
        }
        .tech-status {
            position: absolute;
            bottom: -2px;
            right: -2px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            border: 2px solid var(--card-bg);
        }
        .tech-status.live { background: var(--accent-green); box-shadow: 0 0 8px rgba(80,220,120,0.5); }
        .tech-status.idle { background: var(--accent-orange); }
        .tech-status.offline { background: #4b5563; }
        .tech-info { flex: 1; min-width: 0; }
        .tech-name { font-size: 14px; font-weight: 500; margin-bottom: 2px; }
        .tech-project { font-size: 12px; color: var(--text-tertiary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .tech-right { display: flex; align-items: center; gap: 12px; flex-shrink: 0; }
        .tech-stats { font-size: 12px; color: var(--text-tertiary); }

        /* ═══════════════════════════════════════════════════════════
           PAGE DRAWER (50% width)
        ═══════════════════════════════════════════════════════════ */
        .page-drawer {
            position: fixed;
            top: 0;
            right: 0;
            width: 50%;
            height: 100%;
            background: var(--card-bg-glass);
            backdrop-filter: blur(24px);
            border-left: 1px solid var(--border-subtle);
            display: flex;
            flex-direction: column;
            transform: translateX(100%);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 250;
        }
        .full-page.drawer-open .page-drawer { transform: translateX(0); }

        .drawer-header {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 20px;
            padding-top: max(12px, env(safe-area-inset-top));
            border-bottom: 1px solid var(--border-subtle);
            flex-shrink: 0;
            height: 56px;
            background: var(--card-bg);
        }
        .drawer-close {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: transparent;
            border: 1px solid var(--border-subtle);
            color: var(--text-tertiary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            flex-shrink: 0;
        }
        .drawer-close:hover { background: rgba(255,255,255,0.05); color: var(--text-primary); }
        .drawer-close svg { width: 12px; height: 12px; }
        .drawer-title-wrap { flex: 1; display: flex; align-items: center; gap: 8px; }
        .drawer-title { font-size: 15px; font-weight: 600; }
        .drawer-divider { width: 1px; height: 16px; background: var(--border-light); }
        .drawer-subtitle { font-size: 13px; color: var(--text-tertiary); }
        .drawer-badge { font-size: 11px; padding: 5px 12px; border-radius: 8px; font-weight: 500; }
        .drawer-badge.nord { background: rgba(80, 150, 255, 0.15); color: var(--team-nord); }
        .drawer-badge.sud { background: rgba(80, 220, 120, 0.15); color: var(--team-sud); }
        .drawer-badge.direct { background: rgba(255, 170, 50, 0.15); color: var(--team-direct); }
        .drawer-badge.live { background: rgba(80, 220, 120, 0.15); color: var(--accent-green); }
        .drawer-badge.idle { background: rgba(255, 170, 50, 0.15); color: var(--accent-orange); }
        .drawer-badge.offline { background: rgba(75,85,99,0.2); color: #9ca3af; }
        .drawer-footer {
            display: flex;
            gap: 10px;
            padding: 16px 20px;
            padding-bottom: max(16px, env(safe-area-inset-bottom));
            border-top: 1px solid var(--border-subtle);
            flex-shrink: 0;
        }
        .drawer-btn {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            padding: 10px 16px;
            border-radius: 10px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            border: none;
            transition: all 0.2s;
        }
        .drawer-btn.primary { background: linear-gradient(135deg, var(--accent-green), #38b058); color: white; }
        .drawer-btn.primary:hover { box-shadow: 0 4px 16px var(--glow-sud); }
        .drawer-btn.secondary { background: rgba(255,255,255,0.05); border: 1px solid var(--border-subtle); color: var(--text-secondary); }
        .drawer-btn.blue { background: linear-gradient(135deg, var(--accent-blue), #3a7fde); color: white; }
        .drawer-btn svg { width: 14px; height: 14px; }

        /* Info Cards */
        .info-card {
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid var(--border-subtle);
            border-radius: 14px;
            padding: 18px;
            margin-bottom: 16px;
        }
        .info-card-title { font-size: 10px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 14px; }
        .info-row { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid var(--border-subtle); }
        .info-row:last-child { border-bottom: none; }
        .info-label { font-size: 12px; color: var(--text-tertiary); }
        .info-value { font-size: 12px; font-weight: 500; }
        .info-value.green { color: var(--accent-green); }
        .info-value.blue { color: var(--accent-blue); }
        .info-value.orange { color: var(--accent-orange); }

        /* Mini Project Cards (in tech drawer) */
        .mini-project {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px;
            background: rgba(255,255,255,0.02);
            border-radius: 8px;
            margin-bottom: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .mini-project:hover { background: rgba(255,255,255,0.05); }
        .mini-project-bar {
            width: 3px;
            height: 32px;
            border-radius: 2px;
        }
        .mini-project-bar.nord { background: var(--team-nord); }
        .mini-project-bar.sud { background: var(--team-sud); }
        .mini-project-bar.direct { background: var(--team-direct); }
        .mini-project-info { flex: 1; }
        .mini-project-title { font-size: 12px; font-weight: 500; margin-bottom: 2px; }
        .mini-project-meta { font-size: 10px; color: var(--text-tertiary); }
        .mini-project-progress { font-size: 12px; font-weight: 600; }

        /* Progress Section */
        .progress-section { margin-bottom: 20px; }
        .progress-header { display: flex; justify-content: space-between; margin-bottom: 10px; }
        .progress-label { font-size: 11px; color: var(--text-muted); }
        .progress-value { font-size: 24px; font-weight: 700; }
        .progress-bar-large { height: 8px; background: rgba(255, 255, 255, 0.08); border-radius: 4px; overflow: hidden; }
        .progress-fill-large { height: 100%; border-radius: 4px; }

        /* Report Sections */
        .report-sections { display: flex; flex-direction: column; gap: 10px; }
        .report-section { display: flex; align-items: center; gap: 12px; }
        .report-section-name { font-size: 12px; color: var(--text-secondary); min-width: 100px; }
        .report-section-bar { flex: 1; height: 4px; background: rgba(255,255,255,0.08); border-radius: 2px; overflow: hidden; }
        .report-section-fill { height: 100%; background: var(--accent-green); border-radius: 2px; }
        .report-section-percent { font-size: 11px; font-weight: 600; color: var(--accent-green); min-width: 36px; text-align: right; }

        /* Chat Card */
        .chat-card {
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid var(--border-subtle);
            border-radius: 14px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        .chat-card-header { display: flex; align-items: center; gap: 12px; padding: 14px 16px; border-bottom: 1px solid var(--border-subtle); }
        .chat-card-avatar { width: 32px; height: 32px; border-radius: 50%; background: rgba(255,255,255,0.06); display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 600; }
        .chat-card-info { flex: 1; }
        .chat-card-name { font-size: 13px; font-weight: 500; }
        .chat-card-status { font-size: 11px; color: var(--accent-green); }
        .chat-messages { height: 220px; overflow-y: auto; padding: 16px; display: flex; flex-direction: column; gap: 10px; }
        .msg { display: flex; flex-direction: column; max-width: 85%; }
        .msg.user { align-self: flex-end; align-items: flex-end; }
        .msg.ai { align-self: flex-start; align-items: flex-start; }
        .msg-bubble { padding: 12px 16px; border-radius: 16px; font-size: 13px; line-height: 1.5; }
        .msg.user .msg-bubble { background: linear-gradient(135deg, var(--accent-blue), #3a7fde); color: white; border-bottom-right-radius: 4px; }
        .msg.ai .msg-bubble { background: rgba(255,255,255,0.05); border: 1px solid var(--border-subtle); border-bottom-left-radius: 4px; }
        .msg-time { font-size: 10px; color: var(--text-muted); margin-top: 4px; padding: 0 8px; }
        .chat-input-wrap { padding: 12px 14px; border-top: 1px solid var(--border-subtle); }
        .chat-input-row { display: flex; align-items: center; gap: 10px; padding: 8px; background: rgba(255,255,255,0.03); border: 1px solid var(--border-subtle); border-radius: 28px; }
        .chat-add-btn { width: 32px; height: 32px; border-radius: 50%; background: rgba(255,255,255,0.05); border: none; color: var(--text-tertiary); cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .chat-add-btn:hover { background: rgba(255,255,255,0.1); color: var(--text-primary); }
        .chat-input { flex: 1; background: transparent; border: none; color: white; font-size: 14px; outline: none; padding: 8px 12px; }
        .chat-input::placeholder { color: var(--text-muted); }
        .chat-send { width: 36px; height: 36px; border-radius: 50%; background: var(--accent-blue); border: none; color: white; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .chat-send svg { width: 16px; height: 16px; }

        /* Mini Project Cards */
        .mini-project { display: flex; align-items: center; gap: 12px; padding: 12px; background: rgba(255,255,255,0.02); border-radius: 10px; cursor: pointer; transition: all 0.2s; }
        .mini-project:hover { background: rgba(255,255,255,0.05); }
        .mini-project-bar { width: 3px; height: 28px; border-radius: 2px; }
        .mini-project-bar.nord { background: var(--team-nord); }
        .mini-project-bar.sud { background: var(--team-sud); }
        .mini-project-bar.direct { background: var(--team-direct); }
        .mini-project-info { flex: 1; min-width: 0; }
        .mini-project-title { font-size: 12px; font-weight: 500; margin-bottom: 2px; }
        .mini-project-meta { font-size: 10px; color: var(--text-muted); }
        .mini-project-progress { font-size: 11px; font-weight: 600; color: var(--text-secondary); }

        /* Availability Section */
        .avail-card { margin-top: 8px; }
        .avail-tabs { display: flex; gap: 4px; margin-bottom: 12px; }
        .avail-tab { flex: 1; padding: 8px; font-size: 11px; font-weight: 500; text-align: center; background: rgba(255,255,255,0.03); border: 1px solid var(--border-subtle); border-radius: 8px; cursor: pointer; color: var(--text-tertiary); transition: all 0.2s; }
        .avail-tab:hover { color: var(--text-secondary); }
        .avail-tab.active { background: rgba(80, 150, 255, 0.15); border-color: rgba(80, 150, 255, 0.3); color: var(--accent-blue); }
        .avail-daily { display: flex; flex-direction: column; gap: 6px; }
        .avail-slot { display: flex; align-items: center; gap: 10px; }
        .avail-time { font-size: 10px; color: var(--text-muted); min-width: 40px; }
        .avail-block { flex: 1; padding: 8px 12px; font-size: 11px; border-radius: 6px; }
        .avail-block.available { background: rgba(80, 220, 120, 0.1); color: var(--accent-green); }
        .avail-block.busy { background: rgba(255, 170, 50, 0.1); color: var(--accent-orange); }

        /* Map Markers */
        .map-marker { cursor: pointer; transition: all 0.25s ease; opacity: 0.8; }
        .map-marker:hover, .map-marker.active { opacity: 1; transform: scale(1.15); z-index: 100; }
        .pin { position: relative; }
        .pin-body { width: 40px; height: 40px; border-radius: 50% 50% 50% 4px; transform: rotate(-45deg); display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 700; color: white; }
        .pin-body span { transform: rotate(45deg); }
        .pin-body.nord { background: var(--team-nord); box-shadow: 0 4px 24px var(--glow-nord); }
        .pin-body.sud { background: var(--team-sud); box-shadow: 0 4px 24px var(--glow-sud); }
        .pin-body.direct { background: var(--team-direct); box-shadow: 0 4px 24px var(--glow-direct); }
        .pin-card { position: absolute; bottom: calc(100% + 12px); left: 50%; transform: translateX(-50%); width: 200px; background: var(--card-bg); border: 1px solid var(--border-light); border-radius: 12px; padding: 12px; opacity: 0; visibility: hidden; transition: all 0.2s; z-index: 1000; box-shadow: var(--glow); }
        .map-marker:hover .pin-card { opacity: 1; visibility: visible; }
        .pin-card-title { font-size: 12px; font-weight: 600; margin-bottom: 4px; }
        .pin-card-address { font-size: 10px; color: var(--text-tertiary); margin-bottom: 10px; }
        .pin-card-progress { display: flex; align-items: center; gap: 8px; }
        .pin-card-bar { flex: 1; height: 4px; background: rgba(255,255,255,0.06); border-radius: 2px; }
        .pin-card-fill { height: 100%; border-radius: 2px; }
        .pin-card-value { font-size: 11px; font-weight: 600; }

        .mapboxgl-ctrl-group { background: var(--card-bg) !important; border: 1px solid var(--border-subtle) !important; border-radius: 12px !important; box-shadow: var(--glow) !important; }
        .mapboxgl-ctrl-group button { background: transparent !important; }
        .mapboxgl-ctrl-group button:hover { background: rgba(255,255,255,0.06) !important; }
        .mapboxgl-ctrl-group button .mapboxgl-ctrl-icon { filter: invert(1) opacity(0.4); }

        /* ═══════════════════════════════════════════════════════════
           MAP DRAWER - Opens on map view when clicking project
        ═══════════════════════════════════════════════════════════ */
        .map-drawer {
            position: fixed;
            top: 0;
            right: 0;
            width: 50%;
            height: 100%;
            background: var(--card-bg-glass);
            backdrop-filter: blur(24px);
            border-left: 1px solid var(--border-subtle);
            display: flex;
            flex-direction: column;
            transform: translateX(100%);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 150;
        }
        .map-drawer.visible { transform: translateX(0); }

        /* ═══════════════════════════════════════════════════════════
           CALENDAR VIEW - V3 with Drawer-style colors & rounded corners
        ═══════════════════════════════════════════════════════════ */
        .calendar-view {
            position: fixed;
            inset: 0;
            background: var(--card-bg-glass);
            backdrop-filter: blur(24px);
            z-index: 300;
            display: none;
            flex-direction: column;
        }
        .calendar-view.active { display: flex; }

        .calendar-header-bar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 20px 24px;
            border-bottom: 1px solid var(--border-subtle);
            flex-shrink: 0;
        }
        .calendar-nav { display: flex; align-items: center; gap: 12px; }
        .calendar-nav-btn {
            width: 36px;
            height: 36px;
            border-radius: 10px;
            background: rgba(255,255,255,0.05);
            border: 1px solid var(--border-subtle);
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        .calendar-nav-btn:hover { background: rgba(255,255,255,0.08); color: white; }
        .calendar-month-title { font-size: 20px; font-weight: 600; }

        .calendar-header-right {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        /* View Toggles */
        .calendar-view-toggles {
            display: flex;
            background: rgba(255,255,255,0.03);
            border: 1px solid var(--border-subtle);
            border-radius: 10px;
            padding: 4px;
            gap: 4px;
        }
        .cal-view-btn {
            padding: 8px 16px;
            font-size: 13px;
            font-weight: 500;
            color: var(--text-tertiary);
            background: transparent;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .cal-view-btn:hover { color: var(--text-secondary); }
        .cal-view-btn.active {
            background: rgba(80,150,255,0.2);
            color: var(--accent-blue);
        }

        .calendar-close {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: rgba(255,255,255,0.05);
            border: 1px solid var(--border-subtle);
            color: var(--text-tertiary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        .calendar-close:hover { background: rgba(255,255,255,0.08); color: white; }

        /* Month View */
        .calendar-grid-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 20px 24px 24px;
            overflow: hidden;
        }
        .calendar-grid-container.hidden { display: none; }

        .calendar-weekdays {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
            margin-bottom: 8px;
            flex-shrink: 0;
        }
        .calendar-weekday {
            text-align: center;
            font-size: 12px;
            font-weight: 500;
            color: var(--text-muted);
            text-transform: uppercase;
            padding: 12px;
        }

        .calendar-days {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
            flex: 1;
        }

        .calendar-day {
            background: var(--card-bg);
            border: 1px solid var(--border-subtle);
            padding: 10px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
            min-height: 0;
            overflow: hidden;
        }
        .calendar-day:hover { background: var(--card-bg-hover); border-color: var(--border-light); }
        .calendar-day.other { opacity: 0.3; }
        .calendar-day.today { border-color: var(--accent-blue); border-width: 2px; }
        .calendar-day-num { font-size: 14px; font-weight: 600; margin-bottom: 6px; }
        .calendar-day.today .calendar-day-num { color: var(--accent-blue); }

        /* Rounded corners for month view outer cells */
        .calendar-day.corner-tl { border-top-left-radius: 12px; }
        .calendar-day.corner-tr { border-top-right-radius: 12px; }
        .calendar-day.corner-bl { border-bottom-left-radius: 12px; }
        .calendar-day.corner-br { border-bottom-right-radius: 12px; }

        .calendar-events-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 2px;
            overflow: hidden;
        }

        .calendar-event {
            font-size: 10px;
            padding: 4px 6px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .calendar-event.nord { background: rgba(80,150,255,0.2); color: var(--team-nord); }
        .calendar-event.sud { background: rgba(80,220,120,0.2); color: var(--team-sud); }
        .calendar-event.direct { background: rgba(255,170,50,0.2); color: var(--team-direct); }

        .calendar-more { font-size: 10px; color: var(--text-muted); padding: 2px 6px; }

        /* Day View - Full Screen Gantt */
        .day-view-container {
            flex: 1;
            display: none;
            flex-direction: column;
            padding: 20px 24px 24px;
            overflow: hidden;
        }
        .day-view-container.active { display: flex; }

        .day-view-timeline {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            background: var(--card-bg);
            border: 1px solid var(--border-subtle);
            border-radius: 12px;
        }

        .time-row {
            display: flex;
            min-height: 50px;
            border-bottom: 1px solid var(--border-subtle);
        }
        .time-row:last-child { border-bottom: none; }

        .time-label {
            width: 60px;
            padding: 12px;
            font-size: 11px;
            font-weight: 500;
            color: var(--text-muted);
            border-right: 1px solid var(--border-subtle);
            flex-shrink: 0;
            display: flex;
            align-items: flex-start;
        }

        .time-slots {
            flex: 1;
            display: flex;
            gap: 8px;
            padding: 8px;
            align-items: flex-start;
        }

        .gantt-task {
            flex: 1;
            min-width: 150px;
            max-width: 300px;
            padding: 10px 14px;
            border-radius: 6px;
            display: flex;
            flex-direction: column;
            gap: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .gantt-task:hover { transform: translateY(-2px); }
        .gantt-task.nord { background: rgba(80,150,255,0.15); border-left: 3px solid var(--team-nord); }
        .gantt-task.sud { background: rgba(80,220,120,0.15); border-left: 3px solid var(--team-sud); }
        .gantt-task.direct { background: rgba(255,170,50,0.15); border-left: 3px solid var(--team-direct); }
        .gantt-task-title { font-size: 12px; font-weight: 500; }
        .gantt-task-tech { font-size: 11px; color: var(--text-tertiary); }

        /* Week View - Full Screen */
        .week-view-container {
            flex: 1;
            display: none;
            flex-direction: column;
            padding: 20px 24px 24px;
            overflow: hidden;
        }
        .week-view-container.active { display: flex; }

        .week-weekdays {
            display: grid;
            grid-template-columns: 60px repeat(7, 1fr);
            gap: 4px;
            margin-bottom: 8px;
            flex-shrink: 0;
        }
        .week-time-header { width: 60px; }

        .week-grid {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            background: var(--card-bg);
            border: 1px solid var(--border-subtle);
            border-radius: 12px;
        }

        .week-time-row {
            display: grid;
            grid-template-columns: 60px repeat(7, 1fr);
            min-height: 50px;
            border-bottom: 1px solid var(--border-subtle);
        }
        .week-time-row:last-child { border-bottom: none; }

        .week-time-label {
            padding: 8px;
            font-size: 10px;
            color: var(--text-muted);
            text-align: right;
            border-right: 1px solid var(--border-subtle);
        }
        .week-cell {
            border-right: 1px solid var(--border-subtle);
            padding: 4px;
            min-height: 50px;
        }
        .week-cell:last-child { border-right: none; }
        .week-event {
            font-size: 10px;
            padding: 4px 6px;
            margin-bottom: 2px;
            border-radius: 4px;
            cursor: pointer;
        }
        .week-event:hover { opacity: 0.8; }
        .week-event.nord { background: rgba(80,150,255,0.2); color: var(--team-nord); }
        .week-event.sud { background: rgba(80,220,120,0.2); color: var(--team-sud); }
        .week-event.direct { background: rgba(255,170,50,0.2); color: var(--team-direct); }

        /* Invite Form */
        .invite-form { display: flex; flex-direction: column; gap: 16px; }
        .form-group { display: flex; flex-direction: column; gap: 6px; }
        .form-label { font-size: 11px; font-weight: 500; color: var(--text-secondary); }
        .form-input {
            background: rgba(255,255,255,0.03);
            border: 1px solid var(--border-subtle);
            border-radius: 10px;
            padding: 14px 16px;
            font-size: 14px;
            color: var(--text-primary);
            outline: none;
            transition: all 0.2s;
        }
        .form-input:focus { border-color: var(--accent-blue); background: rgba(255,255,255,0.05); }
        .form-input::placeholder { color: var(--text-muted); }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .form-select {
            background: rgba(255,255,255,0.03);
            border: 1px solid var(--border-subtle);
            border-radius: 10px;
            padding: 14px 16px;
            font-size: 14px;
            color: var(--text-primary);
            cursor: pointer;
            appearance: none;
        }
        .form-select:focus { border-color: var(--accent-blue); outline: none; }

        /* Tech Select Items for New Project */
        .tech-select-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            cursor: pointer;
            transition: all 0.2s;
            border-radius: 8px;
        }
        .tech-select-item:hover { background: rgba(255,255,255,0.05); }

        /* Notification System - Apple Glass Style */
        .notification-icon {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 100; /* Lower than drawer (250) so it goes UNDER */
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: var(--card-bg-glass);
            backdrop-filter: blur(20px);
            border: 1px solid var(--border-subtle);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: var(--glow);
            transition: all 0.2s;
        }
        .notification-icon:hover { background: var(--card-bg-hover); }
        .notification-icon svg { width: 18px; height: 18px; fill: var(--text-secondary); }
        .notification-dot {
            position: absolute;
            top: 8px;
            right: 10px;
            width: 8px;
            height: 8px;
            background: var(--accent-red);
            border-radius: 50%;
        }
        .notification-panel {
            position: fixed;
            top: 74px;
            right: 20px;
            width: 380px;
            max-height: 500px;
            z-index: 100;
            display: none;
            flex-direction: column;
            gap: 10px;
        }
        .notification-panel.visible { display: flex; }
        .notification-card {
            background: rgba(30, 35, 50, 0.75);
            backdrop-filter: blur(40px) saturate(180%);
            -webkit-backdrop-filter: blur(40px) saturate(180%);
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: 16px;
            padding: 16px 18px;
            display: flex;
            align-items: flex-start;
            gap: 14px;
            cursor: pointer;
            position: relative;
            animation: slideInRight 0.3s ease;
            transition: all 0.2s;
        }
        .notification-card:hover {
            background: rgba(40, 45, 65, 0.85);
            transform: translateX(-4px);
        }
        @keyframes slideInRight {
            from { opacity: 0; transform: translateX(30px); }
            to { opacity: 1; transform: translateX(0); }
        }
        .notification-close-wrap {
            position: absolute;
            top: -6px;
            left: -6px;
            opacity: 0;
            transition: opacity 0.15s;
        }
        .notification-card:hover .notification-close-wrap { opacity: 1; }
        .notification-close {
            width: 22px;
            height: 22px;
            border-radius: 50%;
            background: rgba(80,80,90,0.9);
            border: 1px solid rgba(255,255,255,0.15);
            color: rgba(255,255,255,0.7);
            font-size: 14px;
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.15s;
        }
        .notification-close:hover { background: rgba(100,100,110,1); color: white; }
        .notification-avatar {
            width: 40px;
            height: 40px;
            min-width: 40px;
            border-radius: 10px;
            background: rgba(80,150,255,0.15);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 13px;
            font-weight: 600;
            color: var(--accent-blue);
            flex-shrink: 0;
        }
        .notification-content { flex: 1; min-width: 0; }
        .notification-title { font-size: 14px; font-weight: 600; margin-bottom: 3px; }
        .notification-text { font-size: 13px; color: var(--text-secondary); line-height: 1.4; margin-bottom: 6px; }
        .notification-time { font-size: 11px; color: var(--text-muted); }
        .notification-details {
            position: absolute;
            bottom: 14px;
            right: 16px;
            padding: 5px 12px;
            background: rgba(255,255,255,0.1);
            border: none;
            border-radius: 6px;
            color: var(--text-secondary);
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            opacity: 0;
            transition: all 0.15s;
        }
        .notification-card:hover .notification-details { opacity: 1; }
        .notification-details:hover { background: rgba(255,255,255,0.15); color: white; }

        @media (max-width: 900px) {
            .full-page.drawer-open .page-main { flex: 0 0 100%; max-width: 100%; opacity: 0.3; pointer-events: none; }
            .page-drawer { width: 100%; }
            .notification-panel { right: 16px; left: 16px; width: auto; }
        }

        /* ═══════════════════════════════════════════════════════════════
           SECURITY LAYER - LOGIN SCREENS CSS
        ═══════════════════════════════════════════════════════════════ */
        /* ═══ AUTH SCREENS ═══ */
        .screen { position: fixed; top: 0; left: 0; right: 0; bottom: 0; display: none; flex-direction: column; background: var(--bg); background-image: linear-gradient(var(--grid-color) 1px, transparent 1px), linear-gradient(90deg, var(--grid-color) 1px, transparent 1px); background-size: 32px 32px; z-index: 1; }
        .screen.active { display: flex; }
        .main-app { height: 100%; }

        /* LOGIN SCREEN */
        .login-screen { justify-content: center; align-items: center; padding: 24px; }
        .login-container { width: 100%; max-width: 380px; display: flex; flex-direction: column; align-items: center; }
        .scan-line { position: fixed; top: 0; left: 0; width: 100%; height: 2px; background: linear-gradient(90deg, transparent, var(--copilot), transparent); box-shadow: 0 0 20px var(--copilot-glow); animation: scanDown 2s ease-out forwards; }
        @keyframes scanDown { to { top: 50%; opacity: 0; } }
        .login-title { font-size: 22px; font-weight: 300; margin-bottom: 4px; color: rgba(255,255,255,0.9); }
        .login-sub { font-size: 12px; color: var(--text-dim); margin-bottom: 32px; }
        .login-logo { width: 160px; height: auto; margin-bottom: 24px; color: var(--copilot); }
        .login-logo svg { width: 100%; height: auto; }
        .login-bar { display: flex; align-items: center; gap: 8px; padding: 5px 5px 5px 8px; background: var(--card); border: 1px solid var(--border); border-radius: 40px; width: 100%; opacity: 0; animation: fadeUp 0.5s ease 1.5s forwards; }
        @keyframes fadeUp { to { opacity: 1; } }
        @keyframes spin { to { transform: rotate(360deg); } }
        .login-mini { width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; position: relative; }
        .glass-sphere { width: 26px; height: 26px; border-radius: 50%; position: relative; overflow: hidden; animation: glowPulse 8s ease-in-out infinite; }
        @keyframes glowPulse {
            0%, 100% { box-shadow: 0 0 14px rgba(255,107,53,0.7), 0 0 28px rgba(255,107,53,0.3); }
            25% { box-shadow: 0 0 14px rgba(239,68,68,0.7), 0 0 28px rgba(239,68,68,0.3); }
            50% { box-shadow: 0 0 14px rgba(59,130,246,0.7), 0 0 28px rgba(59,130,246,0.3); }
            75% { box-shadow: 0 0 14px rgba(234,179,8,0.7), 0 0 28px rgba(234,179,8,0.3); }
        }
        .glass-sphere::before { content: ''; position: absolute; top: 2px; left: 4px; width: 5px; height: 4px; border-radius: 50%; background: radial-gradient(circle, rgba(255,255,255,0.5), transparent 70%); z-index: 10; }
        .sphere-fog-container { position: absolute; inset: 0; border-radius: 50%; overflow: hidden; background: rgba(20,24,32,0.3); }
        .sphere-fog { position: absolute; inset: -50%; border-radius: 50%; background: radial-gradient(circle at 30% 40%, currentColor, transparent 50%), radial-gradient(circle at 70% 60%, currentColor, transparent 40%); filter: blur(2px); animation: fogSwirl 6s ease-in-out infinite, fogColor 8s ease-in-out infinite; opacity: 0.9; }
        @keyframes fogSwirl { 0% { transform: rotate(0deg) translate(0, 0); } 25% { transform: rotate(90deg) translate(2px, -2px); } 50% { transform: rotate(180deg) translate(0, 0); } 75% { transform: rotate(270deg) translate(-2px, 2px); } 100% { transform: rotate(360deg) translate(0, 0); } }
        @keyframes fogColor { 0%, 100% { color: #FF6B35; } 25% { color: #ef4444; } 50% { color: #3B82F6; } 75% { color: #eab308; } }
        .sphere-fog-2 { position: absolute; inset: -30%; border-radius: 50%; background: radial-gradient(circle at 60% 30%, currentColor, transparent 45%); filter: blur(2px); animation: fogSwirl2 5s ease-in-out infinite reverse, fogColor2 8s ease-in-out infinite; opacity: 0.7; }
        @keyframes fogSwirl2 { 0% { transform: rotate(0deg) scale(0.9); } 50% { transform: rotate(180deg) scale(1.1); } 100% { transform: rotate(360deg) scale(0.9); } }
        @keyframes fogColor2 { 0%, 100% { color: #3B82F6; } 25% { color: #eab308; } 50% { color: #FF6B35; } 75% { color: #ef4444; } }
        .login-icon-slot { width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; position: relative; flex-shrink: 0; }
        .login-back { width: 32px; height: 32px; border-radius: 50%; background: rgba(255,255,255,0.05); border: none; color: var(--text-dim); cursor: pointer; display: none; align-items: center; justify-content: center; flex-shrink: 0; transition: all 0.2s; }
        .login-back:hover { background: rgba(255,255,255,0.1); color: var(--text); }
        .login-back svg { width: 16px; height: 16px; stroke: currentColor; fill: none; }
        .login-input-container { flex: 1; position: relative; height: 32px; overflow: hidden; }
        .login-input-slider { display: flex; transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1); height: 100%; }
        .login-input-slide { min-width: 100%; display: flex; align-items: center; }
        .login-input { flex: 1; padding: 8px; background: transparent; border: none; color: white; font-size: 13px; outline: none; caret-color: white; }
        .login-input::placeholder { color: rgba(255,255,255,0.25); }
        .login-input:-webkit-autofill,
        .login-input:-webkit-autofill:hover,
        .login-input:-webkit-autofill:focus,
        .login-input:-webkit-autofill:active {
            -webkit-box-shadow: 0 0 0 1000px transparent inset !important;
            -webkit-text-fill-color: white !important;
            background-color: transparent !important;
            background: transparent !important;
            transition: background-color 9999s ease-out 9999s !important;
            caret-color: white !important;
        }
        .icon { display: inline-flex; align-items: center; justify-content: center; }
        .login-btn { width: 32px; height: 32px; border-radius: 50%; background: linear-gradient(135deg, #FF6B35, #E55A2B); border: none; color: white; cursor: pointer; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
        .login-btn .icon { width: 12px; height: 12px; }
        .login-btn .icon svg { width: 100%; height: 100%; }
        .login-btn:disabled { opacity: 0.5; cursor: not-allowed; }

        /* LOGIN STATUS MESSAGES */
        .login-status {
            min-height: 24px;
            margin-top: 16px;
            text-align: center;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        .login-status:empty { display: none; }
        .login-status.success { color: #22c55e; }
        .login-status.error { color: #ef4444; }
        .login-status.info { color: rgba(255,255,255,0.7); }
        .login-status a {
            color: inherit;
            text-decoration: underline;
            cursor: pointer;
            margin-left: 8px;
        }
        .login-status a:hover { opacity: 0.8; }

        /* PENDING & CONFIRMATION SCREENS */
        .pending-screen { display: none; }
        .pending-screen.active { display: flex; }
        .pending-container { display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 24px; padding: 40px; text-align: center; }
        .pending-logo { margin-bottom: 8px; }
        .pending-logo svg { height: 40px; width: auto; }
        .pending-title { font-size: 24px; font-weight: 700; color: var(--text); }
        .pending-subtitle { font-size: 14px; color: var(--text-dim); max-width: 300px; line-height: 1.5; }
        .pending-email { font-size: 13px; color: var(--copilot); font-weight: 500; padding: 8px 16px; background: rgba(255,107,53,0.1); border-radius: 8px; }
        .pending-logout { margin-top: 16px; padding: 10px 24px; background: transparent; border: 1px solid var(--border); border-radius: 8px; color: var(--text-dim); font-size: 13px; cursor: pointer; transition: all 0.2s; }
        .pending-logout:hover { background: rgba(255,255,255,0.05); color: var(--text); }


        /* Toast notification */
        .toast { position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%) translateY(100px); background: rgba(30,35,44,0.98); border: 1px solid var(--border); padding: 12px 20px; border-radius: 10px; font-size: 13px; color: var(--text); z-index: 9999; opacity: 0; transition: all 0.3s; pointer-events: none; }
        .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }
    </style>
</head>
<body>
    <!-- SVG Definitions for login icons -->
<body>
    <!-- SVG DEFINITIONS - Exact from technician app -->
    <svg class="svg-defs" xmlns="http://www.w3.org/2000/svg">
        <defs>
            <symbol id="icon-fixair-logo" viewBox="0 0 235 48"><path d="M35.1986 6.4H17.4706C15.4226 6.4 13.5666 6.912 11.9026 7.936C10.2386 8.96 8.89463 10.3253 7.87063 12.032C6.88929 13.696 6.39863 15.552 6.39863 17.6V48H-0.00137472V16C-0.00137472 13.7387 0.467959 11.648 1.40663 9.728C2.34529 7.76533 3.62529 6.08 5.24663 4.672C6.91063 3.22133 8.78796 2.09067 10.8786 1.28C12.9693 0.426664 15.1666 -3.8147e-06 17.4706 -3.8147e-06H35.1986V6.4ZM48.8306 4.8C48.8306 6.12266 48.3613 7.25333 47.4226 8.192C46.484 9.13066 45.3533 9.6 44.0306 9.6C42.708 9.6 41.5773 9.13066 40.6386 8.192C39.7 7.25333 39.2306 6.12266 39.2306 4.8C39.2306 3.47733 39.7 2.34666 40.6386 1.408C41.5773 0.46933 42.708 -3.8147e-06 44.0306 -3.8147e-06C45.3533 -3.8147e-06 46.484 0.46933 47.4226 1.408C48.3613 2.34666 48.8306 3.47733 48.8306 4.8ZM47.2306 48H40.8306V22.4H9.59863V16H47.2306V48ZM97.7161 48H88.5641L74.8681 34.752L61.4281 48H52.2761L70.4521 30.464L52.2761 12.8H61.4281L97.7161 48ZM97.7161 12.8L82.4841 27.648L77.8761 23.552L88.5641 12.8H97.7161Z" fill="currentColor"/><path d="M154.461 48H148.061V35.2H112.285V28.8H148.061V9.6H125.085C122.183 9.6 119.517 10.3253 117.085 11.776C114.653 13.184 112.711 15.104 111.261 17.536C109.853 19.968 109.149 22.656 109.149 25.6V48H102.749V25.6C102.749 22.528 103.325 19.648 104.477 16.96C105.629 14.2293 107.229 11.84 109.277 9.792C111.325 7.70133 113.693 6.08 116.381 4.928C119.111 3.776 122.013 3.2 125.085 3.2H154.461V48ZM171.604 48H165.204V3.2H171.604V48ZM234.041 48H225.401L211.961 35.2H192.313V28.864H218.041C219.833 28.864 221.454 28.4373 222.905 27.584C224.356 26.688 225.508 25.5147 226.361 24.064C227.214 22.5707 227.641 20.9493 227.641 19.2C227.641 17.408 227.214 15.7867 226.361 14.336C225.508 12.8853 224.356 11.7333 222.905 10.88C221.454 10.0267 219.833 9.6 218.041 9.6H188.729V48H182.329V3.2H218.041C220.985 3.2 223.673 3.92533 226.105 5.376C228.537 6.784 230.457 8.704 231.865 11.136C233.316 13.568 234.041 16.256 234.041 19.2C234.041 21.8453 233.444 24.2987 232.249 26.56C231.097 28.8213 229.497 30.6987 227.449 32.192C225.444 33.6427 223.161 34.5813 220.601 35.008L234.041 48Z" fill="currentColor"/></symbol>
            <symbol id="icon-plus" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></symbol>
            <symbol id="icon-camera" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></symbol>
            <symbol id="icon-paperclip" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"/></symbol>
            <symbol id="icon-x" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></symbol>
            <symbol id="icon-check" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></symbol>
            <symbol id="icon-search" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></symbol>
            <symbol id="icon-clipboard" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><rect x="8" y="2" width="8" height="4" rx="1" ry="1"/></symbol>
            <symbol id="icon-arrow-left" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 12H5M12 19l-7-7 7-7"/></symbol>
            <symbol id="icon-arrow-right" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 12h14M12 5l7 7-7 7"/></symbol>
        </defs>


    <!-- ═══════════════════════════════════════════════════════════════
         SECURITY LAYER - LOGIN SCREENS
    ═══════════════════════════════════════════════════════════════ -->
    <!-- LOGIN SCREEN -->
    <div class="screen login-screen active" id="loginScreen">
        <div class="scan-line"></div>
        <div class="login-container">
            <div class="login-logo"><svg viewBox="0 0 235 48"><use href="#icon-fixair-logo"/></svg></div>
            <h1 class="login-title" data-i18n="login.title">Espace Admin</h1>
            <p class="login-sub" data-i18n="login.subtitle">Connectez-vous à votre compte admin</p>
            <div class="login-bar">
                <div class="login-icon-slot">
                    <div class="login-mini" id="loginSphere"><div class="glass-sphere"><div class="sphere-fog-container"><div class="sphere-fog"></div><div class="sphere-fog-2"></div></div></div></div>
                    <button type="button" class="login-back" id="loginBack" onclick="prevLoginStep()"><svg viewBox="0 0 24 24"><use href="#icon-arrow-left"/></svg></button>
                </div>
                <div class="login-input-container">
                    <div class="login-input-slider" id="loginSlider">
                        <div class="login-input-slide">
                            <input type="email" class="login-input" id="loginEmailInput" data-i18n-placeholder="login.emailPlaceholder" placeholder="Quelle est votre adresse email ?" onkeypress="if(event.key==='Enter')nextLoginStep()">
                        </div>
                        <div class="login-input-slide">
                            <input type="password" class="login-input" id="loginPasswordInput" data-i18n-placeholder="login.passwordPlaceholder" placeholder="Entrez votre mot de passe" onkeypress="if(event.key==='Enter')nextLoginStep()">
                        </div>
                    </div>
                </div>
                <button type="button" class="login-btn" id="loginBtn" onclick="nextLoginStep()"><span class="icon"><svg><use href="#icon-arrow-right"/></svg></span></button>
            </div>
            <div class="login-status" id="loginStatus"></div>
        </div>
    </div>

    <!-- EMAIL CONFIRMATION SCREEN -->
    <div class="screen pending-screen" id="emailConfirmScreen">
        <div class="scan-line"></div>
        <div class="pending-container">
            <div class="pending-logo">
                <svg viewBox="0 0 235 48" style="height: 40px; color: var(--copilot);"><use href="#icon-fixair-logo"/></svg>
            </div>
            <div class="pending-icon" style="font-size: 48px; margin: 16px 0;">&#9993;</div>
            <h1 class="pending-title" data-i18n="confirm.title">Vérifiez vos emails</h1>
            <p class="pending-subtitle" data-i18n="confirm.message">
                Nous avons envoyé un lien de confirmation à votre adresse email.
            </p>
            <div class="pending-email" id="confirmEmail"></div>
            <button class="pending-logout" onclick="resendConfirmation()" style="margin-top: 8px; border-color: var(--copilot); color: var(--copilot);" data-i18n="confirm.resend">
                Renvoyer l'email
            </button>
            <button class="pending-logout" onclick="backToLogin()" data-i18n="confirm.backToLogin">
                Retour à la connexion
            </button>
        </div>
    </div>

    <!-- PENDING APPROVAL SCREEN -->
    <div class="screen pending-screen" id="pendingScreen">
        <div class="scan-line"></div>
        <div class="pending-container">
            <div class="pending-logo">
                <svg viewBox="0 0 235 48" style="height: 40px; color: var(--copilot);"><use href="#icon-fixair-logo"/></svg>
            </div>
            <div class="pending-icon" style="font-size: 48px; margin: 16px 0;">&#9203;</div>
            <h1 class="pending-title" data-i18n="pending.title">Compte en attente</h1>
            <p class="pending-subtitle" data-i18n="pending.message">
                Votre compte est en attente de validation par un administrateur.
            </p>
            <div class="pending-email" id="pendingEmail"></div>
            <button class="pending-logout" onclick="checkApprovalStatus()" style="margin-top: 8px; background: var(--copilot); color: white; border: none;" id="checkStatusBtn" data-i18n="pending.checkStatus">
                Vérifier le statut
            </button>
            <button class="pending-logout" onclick="logoutFromPending()" data-i18n="pending.logout">
                Se déconnecter
            </button>
        </div>
    </div>

    <!-- ACCESS DENIED SCREEN (for technicians trying to access manager) -->
    <div class="screen pending-screen" id="accessDeniedScreen">
        <div class="scan-line"></div>
        <div class="pending-container">
            <div class="pending-logo">
                <svg viewBox="0 0 235 48" style="height: 40px; color: var(--copilot);"><use href="#icon-fixair-logo"/></svg>
            </div>
            <h1 class="pending-title" data-i18n="denied.title">Accès refusé</h1>
            <p class="pending-subtitle" data-i18n="denied.message">
                Vous n'avez pas les droits d'accès à cette section.
            </p>
            <div class="pending-email" id="accessDeniedEmail"></div>
            <button class="pending-logout" onclick="redirectToTechnicianApp()" style="margin-top: 8px; background: var(--copilot); color: white; border: none;" data-i18n="denied.goToTechApp">
                Aller à l'app Technicien
            </button>
            <button class="pending-logout" onclick="logoutFromPending()" data-i18n="denied.logout">
                Se déconnecter
            </button>
        </div>
    </div>

    <!-- PASSWORD RESET SCREEN -->
    <div class="screen pending-screen" id="passwordResetScreen">
        <div class="scan-line"></div>
        <div class="pending-container">
            <div class="pending-logo">
                <svg viewBox="0 0 235 48" style="height: 40px; color: var(--copilot);"><use href="#icon-fixair-logo"/></svg>
            </div>
            <h1 class="pending-title" data-i18n="reset.title">Nouveau mot de passe</h1>
            <p class="pending-subtitle" data-i18n="reset.instruction">
                Entrez votre nouveau mot de passe
            </p>
            <div style="width: 100%; max-width: 300px; margin: 20px auto;">
                <input type="password" id="newPasswordInput" data-i18n-placeholder="reset.placeholder" placeholder="Nouveau mot de passe"
                    style="width: 100%; padding: 12px 16px; background: var(--card); border: 1px solid var(--border); border-radius: 8px; color: var(--text); font-size: 14px; margin-bottom: 12px;">
                <input type="password" id="confirmPasswordInput" data-i18n-placeholder="reset.confirmPlaceholder" placeholder="Confirmer le mot de passe"
                    style="width: 100%; padding: 12px 16px; background: var(--card); border: 1px solid var(--border); border-radius: 8px; color: var(--text); font-size: 14px; margin-bottom: 12px;">
                <div id="passwordResetStatus" style="margin-bottom: 12px; padding: 8px; border-radius: 6px; font-size: 13px; display: none;"></div>
                <button onclick="setNewPassword()"
                    style="width: 100%; padding: 12px 16px; background: var(--copilot); border: none; border-radius: 8px; color: #000; font-size: 14px; font-weight: 600; cursor: pointer;" data-i18n="reset.button">
                    Mettre à jour
                </button>
            </div>
            <button class="pending-logout" onclick="cancelPasswordReset()" style="margin-top: 8px;" data-i18n="common.cancel">
                Annuler
            </button>
        </div>
    </div>


    <!-- ═══════════════════════════════════════════════════════════════
         MAIN APP - V7 UI (shown after successful login)
    ═══════════════════════════════════════════════════════════════ -->
    <div class="screen main-app" id="mainApp">
    <div id="map"></div>

    <!-- NOTIFICATION ICON (Apple Style) -->
    <div class="notification-icon" id="notificationIcon" onclick="toggleNotifications()">
        <svg viewBox="0 0 16 16"><path d="M8 16a2 2 0 0 0 2-2H6a2 2 0 0 0 2 2zM8 1.918l-.797.161A4.002 4.002 0 0 0 4 6c0 .628-.134 2.197-.459 3.742-.16.767-.376 1.566-.663 2.258h10.244c-.287-.692-.502-1.49-.663-2.258C12.134 8.197 12 6.628 12 6a4.002 4.002 0 0 0-3.203-3.92L8 1.917zM14.22 12c.223.447.481.801.78 1H1c.299-.199.557-.553.78-1C2.68 10.2 3 6.88 3 6c0-2.42 1.72-4.44 4.005-4.901a1 1 0 1 1 1.99 0A5.002 5.002 0 0 1 13 6c0 .88.32 4.2 1.22 6z"/></svg>
        <div class="notification-dot" id="notifDot"></div>
    </div>

    <!-- NOTIFICATION PANEL (Apple Glass) -->
    <div class="notification-panel" id="notifPanel">
        <div class="notification-card" onclick="openNotificationDetail('msg-1')">
            <div class="notification-close-wrap">
                <button class="notification-close" onclick="event.stopPropagation(); dismissNotif(this)">×</button>
            </div>
            <div class="notification-avatar">JJ</div>
            <div class="notification-content">
                <div class="notification-title">Message de Jean Jr.</div>
                <div class="notification-text">Diagnostic en cours, problème compresseur identifié sur le projet E1-024</div>
                <div class="notification-time">Il y a 5 min</div>
            </div>
            <button class="notification-details" onclick="event.stopPropagation(); openNotificationDetail('msg-1')">Détails</button>
        </div>
        <div class="notification-card" onclick="openNotificationDetail('report-1')">
            <div class="notification-close-wrap">
                <button class="notification-close" onclick="event.stopPropagation(); dismissNotif(this)">×</button>
            </div>
            <div class="notification-avatar" style="background:rgba(80,220,120,0.15);color:var(--accent-green);">✓</div>
            <div class="notification-content">
                <div class="notification-title">Rapport validé</div>
                <div class="notification-text">E1-028 - Remplacement Compresseur terminé avec succès</div>
                <div class="notification-time">Il y a 15 min</div>
            </div>
            <button class="notification-details" onclick="event.stopPropagation(); openNotificationDetail('report-1')">Détails</button>
        </div>
    </div>

    <!-- BOTTOM BAR - Apple Dock + Two Main Cards -->
    <div class="bottom-bar">
        <!-- Apple Dock Navigation (Circle that expands) -->
        <div class="dock-container" id="dockContainer">
            <div class="dock" id="mainDock">
                <!-- Dashboard icon (always visible) -->
                <div class="dock-item" data-tooltip="Dashboard" onclick="goToDashboard()">
                    <div class="dock-item-icon">
                        <svg viewBox="0 0 16 16"><path d="M0 1.5A1.5 1.5 0 0 1 1.5 0h2A1.5 1.5 0 0 1 5 1.5v2A1.5 1.5 0 0 1 3.5 5h-2A1.5 1.5 0 0 1 0 3.5v-2zM1.5 1a.5.5 0 0 0-.5.5v2a.5.5 0 0 0 .5.5h2a.5.5 0 0 0 .5-.5v-2a.5.5 0 0 0-.5-.5h-2zM0 8a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V8zm1 3v2a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2H1zm14-1V8a1 1 0 0 0-1-1H2a1 1 0 0 0-1 1v2h14z"/></svg>
                    </div>
                </div>
                <div class="dock-divider"></div>
                <!-- Projets icon -->
                <div class="dock-item" data-tooltip="Projets" onclick="showProjectsPage()">
                    <div class="dock-item-icon">
                        <svg viewBox="0 0 16 16"><path d="M9.828 3h3.982a2 2 0 0 1 1.992 2.181l-.637 7A2 2 0 0 1 13.174 14H2.825a2 2 0 0 1-1.991-1.819l-.637-7a1.99 1.99 0 0 1 .342-1.31L.5 3a2 2 0 0 1 2-2h3.672a2 2 0 0 1 1.414.586l.828.828A2 2 0 0 0 9.828 3zm-8.322.12C1.72 3.042 1.95 3 2.19 3h5.396l-.707-.707A1 1 0 0 0 6.172 2H2.5a1 1 0 0 0-1 .981l.006.139z"/></svg>
                    </div>
                </div>
                <!-- Équipes icon -->
                <div class="dock-item" data-tooltip="Équipes" onclick="showTeamsPage()">
                    <div class="dock-item-icon">
                        <svg viewBox="0 0 16 16"><path d="M7 14s-1 0-1-1 1-4 5-4 5 3 5 4-1 1-1 1H7zm4-6a3 3 0 1 0 0-6 3 3 0 0 0 0 6z"/><path fill-rule="evenodd" d="M5.216 14A2.238 2.238 0 0 1 5 13c0-1.355.68-2.75 1.936-3.72A6.325 6.325 0 0 0 5 9c-4 0-5 3-5 4s1 1 1 1h4.216z"/><path d="M4.5 8a2.5 2.5 0 1 0 0-5 2.5 2.5 0 0 0 0 5z"/></svg>
                    </div>
                </div>
                <div class="dock-divider"></div>
                <!-- Settings icon -->
                <div class="dock-item" data-tooltip="Paramètres" onclick="showSettingsPage()">
                    <div class="dock-item-icon">
                        <svg viewBox="0 0 16 16"><path d="M8 4.754a3.246 3.246 0 1 0 0 6.492 3.246 3.246 0 0 0 0-6.492zM5.754 8a2.246 2.246 0 1 1 4.492 0 2.246 2.246 0 0 1-4.492 0z"/><path d="M9.796 1.343c-.527-1.79-3.065-1.79-3.592 0l-.094.319a.873.873 0 0 1-1.255.52l-.292-.16c-1.64-.892-3.433.902-2.54 2.541l.159.292a.873.873 0 0 1-.52 1.255l-.319.094c-1.79.527-1.79 3.065 0 3.592l.319.094a.873.873 0 0 1 .52 1.255l-.16.292c-.892 1.64.901 3.434 2.541 2.54l.292-.159a.873.873 0 0 1 1.255.52l.094.319c.527 1.79 3.065 1.79 3.592 0l.094-.319a.873.873 0 0 1 1.255-.52l.292.16c1.64.893 3.434-.902 2.54-2.541l-.159-.292a.873.873 0 0 1 .52-1.255l.319-.094c1.79-.527 1.79-3.065 0-3.592l-.319-.094a.873.873 0 0 1-.52-1.255l.16-.292c.893-1.64-.902-3.433-2.541-2.54l-.292.159a.873.873 0 0 1-1.255-.52l-.094-.319zm-2.633.283c.246-.835 1.428-.835 1.674 0l.094.319a1.873 1.873 0 0 0 2.693 1.115l.291-.16c.764-.415 1.6.42 1.184 1.185l-.159.292a1.873 1.873 0 0 0 1.116 2.692l.318.094c.835.246.835 1.428 0 1.674l-.319.094a1.873 1.873 0 0 0-1.115 2.693l.16.291c.415.764-.42 1.6-1.185 1.184l-.291-.159a1.873 1.873 0 0 0-2.693 1.116l-.094.318c-.246.835-1.428.835-1.674 0l-.094-.319a1.873 1.873 0 0 0-2.692-1.115l-.292.16c-.764.415-1.6-.42-1.184-1.185l.159-.291A1.873 1.873 0 0 0 1.945 8.93l-.319-.094c-.835-.246-.835-1.428 0-1.674l.319-.094A1.873 1.873 0 0 0 3.06 4.377l-.16-.292c-.415-.764.42-1.6 1.185-1.184l.292.159a1.873 1.873 0 0 0 2.692-1.115l.094-.319z"/></svg>
                    </div>
                </div>
            </div>
            <div class="dock-tooltip" id="dockTooltip"></div>
        </div>

        <!-- Main Card 1 - PROJECTS -->
        <div class="map-left-panel" id="mapLeftPanel">
            <div class="map-projects-list" id="mapProjectsList"></div>
            <div class="map-main-card" id="mapMainCard">
                <div class="section">
                    <span class="count">47</span>
                    <span class="count-label">projets actifs</span>
                </div>
                <div class="divider"></div>
                <div class="section section-center">
                    <div class="progress-header">
                        <span class="label">Progression globale</span>
                        <span class="progress-value">78%</span>
                    </div>
                    <div class="progress-row">
                        <div class="progress-bar">
                            <div class="progress-fill"></div>
                        </div>
                        <span class="progress-value-inline">78%</span>
                    </div>
                </div>
                <div class="divider"></div>
                <div class="section section-right">
                    <span class="trend">↑ 12%</span>
                    <span class="trend-label">cette semaine</span>
                </div>
            </div>
        </div>

        <!-- Main Card 2 - TECHNICIANS (Better KPIs) -->
        <div class="map-left-panel" id="techLeftPanel">
            <div class="map-projects-list" id="techListDropdown"></div>
            <div class="map-main-card" id="techMainCard">
                <div class="section">
                    <span class="count">8</span>
                    <span class="count-label">techniciens</span>
                </div>
                <div class="divider"></div>
                <div class="section section-center">
                    <div class="progress-header">
                        <span class="label">Interventions jour</span>
                        <span class="progress-value">12</span>
                    </div>
                    <div class="progress-row">
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: 85%;"></div>
                        </div>
                        <span class="progress-value-inline">85%</span>
                    </div>
                </div>
                <div class="divider"></div>
                <div class="section section-right">
                    <span class="trend">4.2h</span>
                    <span class="trend-label">temps moyen</span>
                </div>
            </div>
        </div>
    </div>

    <!-- VIEW TOGGLE - Right side aligned with Mapbox controls -->
    <div class="view-toggle" id="viewToggle">
        <button class="toggle-btn active" onclick="switchView('map')" title="Carte">
            <svg viewBox="0 0 16 16"><path d="M15.817.113A.5.5 0 0 1 16 .5v14a.5.5 0 0 1-.402.49l-5 1a.5.5 0 0 1-.196 0L5.5 15.01l-4.902.98A.5.5 0 0 1 0 15.5v-14a.5.5 0 0 1 .402-.49l5-1a.5.5 0 0 1 .196 0L10.5.99l4.902-.98a.5.5 0 0 1 .415.103zM10 1.91l-4-.8v12.98l4 .8V1.91zm1 12.98 4-.8V1.11l-4 .8v12.98zm-6-.8V1.11l-4 .8v12.98l4-.8z"/></svg>
        </button>
        <button class="toggle-btn" onclick="switchView('calendar')" title="Calendrier">
            <svg viewBox="0 0 16 16"><path d="M3.5 0a.5.5 0 0 1 .5.5V1h8V.5a.5.5 0 0 1 1 0V1h1a2 2 0 0 1 2 2v11a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V3a2 2 0 0 1 2-2h1V.5a.5.5 0 0 1 .5-.5zM2 2a1 1 0 0 0-1 1v1h14V3a1 1 0 0 0-1-1H2zm13 3H1v9a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1V5z"/></svg>
        </button>
    </div>

    <!-- MAP DRAWER - For project details on map view -->
    <div class="map-drawer" id="mapDrawer">
        <div class="drawer-header">
            <div class="drawer-close" onclick="closeMapDrawer()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18M6 6l12 12"/></svg></div>
            <div class="drawer-title-wrap">
                <div class="drawer-title" id="mapDTitle">E1-024</div>
                <div class="drawer-subtitle" id="mapDSubtitle">Jean Jr. • Hôtel Novotel</div>
            </div>
            <span class="drawer-badge nord" id="mapDBadge">Équipe Nord</span>
        </div>
        <div class="drawer-body" id="mapDrawerBody"></div>
        <div class="drawer-footer">
            <button class="drawer-btn secondary">Historique</button>
            <button class="drawer-btn primary"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>Valider</button>
        </div>
    </div>

    <!-- TECH DRAWER - For technician details on map view -->
    <div class="map-drawer" id="techMapDrawer">
        <div class="drawer-header">
            <div class="drawer-close" onclick="closeTechMapDrawer()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18M6 6l12 12"/></svg></div>
            <div class="drawer-title-wrap">
                <div class="drawer-title" id="techMDName">Jean Junior</div>
                <div class="drawer-subtitle" id="techMDRole">Technicien • Équipe Nord</div>
            </div>
            <span class="drawer-badge live" id="techMDStatus">En ligne</span>
        </div>
        <div class="drawer-body" id="techMapDrawerBody"></div>
        <div class="drawer-footer">
            <button class="drawer-btn secondary" onclick="openTechChat()">Message</button>
            <button class="drawer-btn primary" onclick="callTechnician()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/></svg>Appeler</button>
        </div>
    </div>

    <!-- CALENDAR VIEW - Improved V3 with view toggles -->
    <div class="calendar-view" id="calendarView">
        <div class="calendar-header-bar">
            <div class="calendar-nav">
                <button class="calendar-nav-btn" onclick="calendarPrev()"><svg viewBox="0 0 16 16" fill="currentColor" width="16" height="16"><path fill-rule="evenodd" d="M11.354 1.646a.5.5 0 0 1 0 .708L5.707 8l5.647 5.646a.5.5 0 0 1-.708.708l-6-6a.5.5 0 0 1 0-.708l6-6a.5.5 0 0 1 .708 0z"/></svg></button>
                <span class="calendar-month-title" id="calMonthTitle">Janvier 2026</span>
                <button class="calendar-nav-btn" onclick="calendarNext()"><svg viewBox="0 0 16 16" fill="currentColor" width="16" height="16"><path fill-rule="evenodd" d="M4.646 1.646a.5.5 0 0 1 .708 0l6 6a.5.5 0 0 1 0 .708l-6 6a.5.5 0 0 1-.708-.708L10.293 8 4.646 2.354a.5.5 0 0 1 0-.708z"/></svg></button>
            </div>
            <div class="calendar-header-right">
                <div class="calendar-view-toggles">
                    <button class="cal-view-btn" onclick="setCalendarView('day')">Jour</button>
                    <button class="cal-view-btn" onclick="setCalendarView('week')">Semaine</button>
                    <button class="cal-view-btn active" onclick="setCalendarView('month')">Mois</button>
                </div>
                <div class="calendar-close" onclick="closeCalendar()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18"><path d="M18 6L6 18M6 6l12 12"/></svg></div>
            </div>
        </div>

        <!-- MONTH VIEW -->
        <div class="calendar-grid-container" id="monthViewContainer">
            <div class="calendar-weekdays">
                <div class="calendar-weekday">Lun</div>
                <div class="calendar-weekday">Mar</div>
                <div class="calendar-weekday">Mer</div>
                <div class="calendar-weekday">Jeu</div>
                <div class="calendar-weekday">Ven</div>
                <div class="calendar-weekday">Sam</div>
                <div class="calendar-weekday">Dim</div>
            </div>
            <div class="calendar-days" id="calendarDays"></div>
        </div>

        <!-- DAY VIEW -->
        <div class="day-view-container" id="dayViewContainer">
            <div class="day-view-timeline" id="dayTimeline"></div>
        </div>

        <!-- WEEK VIEW -->
        <div class="week-view-container" id="weekViewContainer">
            <div class="calendar-weekdays week-weekdays" id="weekWeekdays">
                <div class="calendar-weekday week-time-header"></div>
                <div class="calendar-weekday">Lun</div>
                <div class="calendar-weekday">Mar</div>
                <div class="calendar-weekday">Mer</div>
                <div class="calendar-weekday">Jeu</div>
                <div class="calendar-weekday">Ven</div>
                <div class="calendar-weekday">Sam</div>
                <div class="calendar-weekday">Dim</div>
            </div>
            <div class="week-grid" id="weekGrid"></div>
        </div>
    </div>

    <!-- PROJECTS PAGE -->
    <div class="full-page" id="projectsPage">
        <div class="page-layout">
            <div class="page-main">
                <div class="page-header">
                    <div class="page-back" onclick="closePage()">
                        <svg viewBox="0 0 16 16" fill="currentColor"><path fill-rule="evenodd" d="M12 8a.5.5 0 0 1-.5.5H5.707l2.147 2.146a.5.5 0 0 1-.708.708l-3-3a.5.5 0 0 1 0-.708l3-3a.5.5 0 1 1 .708.708L5.707 7.5H11.5a.5.5 0 0 1 .5.5z"/></svg>
                    </div>
                    <div class="page-title-wrap">
                        <div class="page-title">Projets</div>
                        <div class="page-subtitle">12 actifs aujourd'hui</div>
                    </div>
                    <div class="page-actions">
                        <div class="page-action-btn" onclick="openNewProject()">
                            <svg viewBox="0 0 16 16" fill="currentColor"><path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/></svg>
                        </div>
                    </div>
                </div>
                <div class="page-content">
                    <div class="page-content-inner">
                        <div class="search-filter-bar">
                            <div class="search-input-wrap">
                                <input type="text" class="search-input" placeholder="Rechercher..." onkeyup="filterProjects(this.value)">
                            </div>
                            <div class="filter-tabs">
                                <button class="filter-tab active" onclick="setProjectFilter('all', this)">Tous (47)</button>
                                <button class="filter-tab" onclick="setProjectFilter('nord', this)">Nord (18)</button>
                                <button class="filter-tab" onclick="setProjectFilter('sud', this)">Sud (16)</button>
                                <button class="filter-tab" onclick="setProjectFilter('direct', this)">Direct (13)</button>
                            </div>
                        </div>
                        <div class="stats">
                            <div class="stat"><div class="stat-value blue">47</div><div class="stat-label">Total</div></div>
                            <div class="stat"><div class="stat-value green">32</div><div class="stat-label">En cours</div></div>
                            <div class="stat"><div class="stat-value orange">8</div><div class="stat-label">En attente</div></div>
                            <div class="stat"><div class="stat-value purple">7</div><div class="stat-label">Terminés</div></div>
                        </div>
                        <div class="sec-head"><span class="sec-title">Projets actifs</span><span class="sec-line"></span></div>
                        <div class="card-list" id="projectCardList"></div>
                    </div>
                </div>
            </div>
            <div class="page-drawer" id="projectDrawer">
                <div class="drawer-header">
                    <div class="drawer-close" onclick="closeDrawer()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18M6 6l12 12"/></svg></div>
                    <div class="drawer-title-wrap">
                        <div class="drawer-title" id="dTitle">E1-024</div>
                        <div class="drawer-divider"></div>
                        <div class="drawer-subtitle" id="dSubtitle">Jean Jr. • Hôtel Novotel</div>
                    </div>
                    <span class="drawer-badge nord" id="dBadge">Nord</span>
                </div>
                <div class="drawer-body" id="projectDrawerBody"></div>
                <div class="drawer-footer" id="projectDrawerFooter">
                    <button class="drawer-btn secondary">Historique</button>
                    <button class="drawer-btn primary"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>Valider</button>
                </div>
            </div>
        </div>
    </div>

    <!-- TEAMS PAGE -->
    <div class="full-page" id="teamsPage">
        <div class="page-layout">
            <div class="page-main">
                <div class="page-header">
                    <div class="page-back" onclick="closePage()">
                        <svg viewBox="0 0 16 16" fill="currentColor"><path fill-rule="evenodd" d="M12 8a.5.5 0 0 1-.5.5H5.707l2.147 2.146a.5.5 0 0 1-.708.708l-3-3a.5.5 0 0 1 0-.708l3-3a.5.5 0 1 1 .708.708L5.707 7.5H11.5a.5.5 0 0 1 .5.5z"/></svg>
                    </div>
                    <div class="page-title-wrap">
                        <div class="page-title">Équipes</div>
                        <div class="page-subtitle">15 membres</div>
                    </div>
                    <div class="page-actions">
                        <div class="page-action-btn" onclick="openInviteDrawer()">
                            <svg viewBox="0 0 16 16" fill="currentColor"><path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/></svg>
                        </div>
                    </div>
                </div>
                <div class="page-content">
                    <div class="page-content-inner">
                        <div class="search-filter-bar">
                            <div class="search-input-wrap">
                                <input type="text" class="search-input" placeholder="Rechercher..." onkeyup="filterTeams(this.value)">
                            </div>
                            <div class="filter-tabs">
                                <button class="filter-tab active" onclick="setTeamFilter('all', this)">Tous (15)</button>
                                <button class="filter-tab" onclick="setTeamFilter('manager', this)">Managers (3)</button>
                                <button class="filter-tab" onclick="setTeamFilter('tech', this)">Techniciens (12)</button>
                            </div>
                        </div>
                        <div class="stats">
                            <div class="stat"><div class="stat-value blue">15</div><div class="stat-label">Total</div></div>
                            <div class="stat"><div class="stat-value purple">3</div><div class="stat-label">Managers</div></div>
                            <div class="stat"><div class="stat-value green">12</div><div class="stat-label">Techniciens</div></div>
                            <div class="stat"><div class="stat-value orange">8</div><div class="stat-label">En intervention</div></div>
                        </div>
                        <div class="sec-head" id="managersSection"><span class="sec-title">Managers</span><span class="sec-line"></span></div>
                        <div class="card-list" id="managersCardList"></div>
                        <div class="sec-head" id="techsSection"><span class="sec-title">Techniciens</span><span class="sec-line"></span></div>
                        <div class="card-list" id="techsCardList"></div>
                    </div>
                </div>
            </div>
            <div class="page-drawer" id="teamDrawer">
                <div class="drawer-header">
                    <div class="drawer-close" onclick="closeDrawer()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18M6 6l12 12"/></svg></div>
                    <div class="drawer-title-wrap">
                        <div class="drawer-title" id="tName">Jean Dupont</div>
                        <div class="drawer-divider"></div>
                        <div class="drawer-subtitle" id="tRole">Manager • Équipe Nord</div>
                    </div>
                    <span class="drawer-badge live" id="tBadge">En ligne</span>
                </div>
                <div class="drawer-body" id="techDrawerBody"></div>
                <div class="drawer-footer" id="techDrawerFooter">
                    <button class="drawer-btn secondary">Historique</button>
                    <button class="drawer-btn blue">Contacter</button>
                </div>
            </div>
        </div>
    </div>

    <!-- NESTED PROJECT DRAWER (for tech -> project) -->
    <div class="page-drawer" id="nestedProjectDrawer" style="z-index:300; transform:translateX(100%);">
        <div class="drawer-header">
            <div class="drawer-close" onclick="closeNestedDrawer()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18M6 6l12 12"/></svg></div>
            <div class="drawer-title-wrap">
                <div class="drawer-title" id="nestedTitle">-</div>
                <div class="drawer-subtitle" id="nestedSubtitle">-</div>
            </div>
            <span class="drawer-badge nord" id="nestedBadge">-</span>
        </div>
        <div class="drawer-body" id="nestedProjectBody"></div>
        <div class="drawer-footer">
            <button class="drawer-btn secondary">Historique</button>
            <button class="drawer-btn primary"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>Valider</button>
        </div>
    </div>

    <!-- PROFILE DRAWER -->
    <div class="page-drawer" id="profileDrawer" style="z-index:300; transform:translateX(100%);">
        <div class="drawer-header">
            <div class="drawer-close" onclick="closeProfileDrawer()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18M6 6l12 12"/></svg></div>
            <div class="drawer-title-wrap">
                <div class="drawer-title">Profil & Paramètres</div>
            </div>
        </div>
        <div class="drawer-body">
            <div style="text-align:center; padding:28px 0; border-bottom:1px solid var(--border-subtle); margin-bottom:20px;">
                <div style="width:80px; height:80px; border-radius:20px; background:linear-gradient(135deg, var(--accent-blue), var(--accent-purple)); display:flex; align-items:center; justify-content:center; font-size:28px; font-weight:700; color:white; margin:0 auto 16px; box-shadow: 0 8px 24px rgba(80,150,255,0.3);">HC</div>
                <div style="font-size:20px; font-weight:700; margin-bottom:4px;">Houssam Cherhabil</div>
                <div style="font-size:13px; color:var(--accent-blue);">Administrateur</div>
            </div>
            <div class="info-card">
                <div class="info-card-title">Notifications</div>
                <div class="info-row"><span class="info-label">Notifications email</span><span class="info-value green">Activé</span></div>
                <div class="info-row"><span class="info-label">Notifications push</span><span class="info-value green">Activé</span></div>
            </div>
            <div class="info-card">
                <div class="info-card-title">Équipes</div>
                <div class="info-row"><span class="info-label">Équipe Nord</span><span class="info-value">4 techniciens</span></div>
                <div class="info-row"><span class="info-label">Équipe Sud</span><span class="info-value">5 techniciens</span></div>
                <div class="info-row"><span class="info-label">Direct</span><span class="info-value">3 techniciens</span></div>
            </div>
        </div>
        <div class="drawer-footer">
            <button class="drawer-btn secondary" style="color:#ef4444;">Déconnexion</button>
        </div>
    </div>

    </div><!-- END mainApp -->
    
    <!-- Toast notification element -->
    <div class="toast" id="toast"></div>

    <script>
        // ═══════════════════════════════════════════════════════════════
        // SECURITY LAYER - AUTHENTICATION
        // ═══════════════════════════════════════════════════════════════
        // ═══════════════════════════════════════════════════════════════
        // TOAST NOTIFICATION
        // ═══════════════════════════════════════════════════════════════
        function toast(msg) {
            const t = document.getElementById('toast');
            if (t) {
                t.textContent = msg;
                t.classList.add('show');
                setTimeout(() => t.classList.remove('show'), 2500);
            }
        }

        // ═══════════════════════════════════════════════════════════════
        // TRANSLATIONS
        // ═══════════════════════════════════════════════════════════════
        const translations = {
            fr: {
                'login.pageTitle': 'FixAIR Admin - Connexion',
                'login.title': 'Espace Admin',
                'login.subtitle': 'Connectez-vous à votre compte admin',
                'login.emailPlaceholder': 'Email professionnel',
                'login.passwordPlaceholder': 'Mot de passe',
                'login.checkButton': 'Continuer',
                'login.loginButton': 'Se connecter',
                'login.forgotPassword': 'Mot de passe oublié ?',

                'confirm.title': 'Vérifiez vos emails',
                'confirm.message': 'Nous avons envoyé un lien de confirmation à votre adresse email.',
                'confirm.spam': 'Pensez à vérifier vos spams si vous ne trouvez pas l\'email.',
                'confirm.resend': 'Renvoyer l\'email',
                'confirm.backToLogin': 'Retour à la connexion',

                'pending.title': 'Compte en attente',
                'pending.message': 'Votre compte est en attente de validation par un administrateur.',
                'pending.logout': 'Se déconnecter',
                'pending.checkStatus': 'Vérifier le statut',

                'denied.title': 'Accès refusé',
                'denied.message': 'Vous n\'avez pas les droits d\'accès à cette section.',
                'denied.logout': 'Se déconnecter',
                'denied.goToTechApp': 'Aller à l\'app Technicien',

                'reset.title': 'Nouveau mot de passe',
                'reset.instruction': 'Entrez votre nouveau mot de passe',
                'reset.placeholder': 'Nouveau mot de passe',
                'reset.confirmPlaceholder': 'Confirmer le mot de passe',
                'reset.button': 'Mettre à jour',

                'errors.invalidEmail': 'Veuillez entrer un email valide',
                'errors.enterEmailFirst': 'Entrez votre email d\'abord',
                'errors.sendError': 'Erreur lors de l\'envoi',
                'errors.connectionProblem': 'Problème de connexion. Veuillez réessayer.',
                'errors.wrongPassword': 'Mot de passe incorrect',
                'errors.enterPassword': 'Veuillez entrer votre mot de passe',
                'errors.profileNotFound': 'Erreur: profil non trouvé',
                'errors.serverConnection': 'Erreur de connexion au serveur',
                'errors.notAdminAccount': 'Ce compte n\'est pas un compte admin',

                'status.connecting': 'Connexion...',
                'status.resetSent': 'Email de réinitialisation envoyé ! Vérifiez votre boîte mail (et spam).',
                'status.welcome': 'Bienvenue',
                'status.welcomeName': 'Bienvenue {name} !',
                'status.redirectSignup': 'Redirection vers la page d\'inscription...',
                'status.technicianAccount': 'Ce compte est un compte technicien. Redirection...',
                'status.managerAccount': 'Ce compte est un compte manager. Redirection...'
            },
            en: {
                'login.pageTitle': 'FixAIR Admin - Login',
                'login.title': 'Admin Portal',
                'login.subtitle': 'Sign in to your admin account',
                'login.emailPlaceholder': 'Professional email',
                'login.passwordPlaceholder': 'Password',
                'login.checkButton': 'Continue',
                'login.loginButton': 'Sign in',
                'login.forgotPassword': 'Forgot password?',

                'confirm.title': 'Check your emails',
                'confirm.message': 'We sent a confirmation link to your email address.',
                'confirm.spam': 'Remember to check your spam folder if you don\'t find the email.',
                'confirm.resend': 'Resend email',
                'confirm.backToLogin': 'Back to login',

                'pending.title': 'Account pending',
                'pending.message': 'Your account is pending validation by an administrator.',
                'pending.logout': 'Sign out',
                'pending.checkStatus': 'Check status',

                'denied.title': 'Access denied',
                'denied.message': 'You don\'t have access rights to this section.',
                'denied.logout': 'Sign out',
                'denied.goToTechApp': 'Go to Technician app',

                'reset.title': 'New password',
                'reset.instruction': 'Enter your new password',
                'reset.placeholder': 'New password',
                'reset.confirmPlaceholder': 'Confirm password',
                'reset.button': 'Update',

                'errors.invalidEmail': 'Please enter a valid email',
                'errors.enterEmailFirst': 'Enter your email first',
                'errors.sendError': 'Error sending',
                'errors.connectionProblem': 'Connection problem. Please try again.',
                'errors.wrongPassword': 'Incorrect password',
                'errors.enterPassword': 'Please enter your password',
                'errors.profileNotFound': 'Error: profile not found',
                'errors.serverConnection': 'Server connection error',
                'errors.notAdminAccount': 'This account is not an admin account',

                'status.connecting': 'Connecting...',
                'status.resetSent': 'Password reset email sent! Check your inbox (and spam).',
                'status.welcome': 'Welcome',
                'status.welcomeName': 'Welcome {name}!',
                'status.redirectSignup': 'Redirecting to signup page...',
                'status.technicianAccount': 'This is a technician account. Redirecting...',
                'status.managerAccount': 'This is a manager account. Redirecting...'
            }
        };

        let currentLang = 'fr';

        function initLanguage() {
            let lang = localStorage.getItem('fixair_language');
            if (!lang) {
                const browserLang = navigator.language || navigator.userLanguage;
                lang = browserLang.startsWith('en') ? 'en' : 'fr';
                localStorage.setItem('fixair_language', lang);
            }
            currentLang = lang;
            applyLanguage(lang);
            return lang;
        }

        function t(key) {
            const lang = currentLang || localStorage.getItem('fixair_language') || 'fr';
            if (translations[lang] && translations[lang][key]) {
                return translations[lang][key];
            }
            if (translations['fr'] && translations['fr'][key]) {
                return translations['fr'][key];
            }
            return key;
        }

        function applyLanguage(lang) {
            currentLang = lang;
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                const text = t(key);
                if (text !== key) el.textContent = text;
            });
            document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
                const key = el.getAttribute('data-i18n-placeholder');
                const text = t(key);
                if (text !== key) el.placeholder = text;
            });
            const titleEl = document.querySelector('[data-i18n-title]');
            if (titleEl) {
                const key = titleEl.getAttribute('data-i18n-title');
                const text = t(key);
                if (text !== key) document.title = text;
            }
        }

        // ═══════════════════════════════════════════════════════════════
        // SUPABASE CONFIGURATION
        // ═══════════════════════════════════════════════════════════════
        const SUPABASE_URL = 'https://fwuhzraxqrvmpqxnzpqm.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZ3dWh6cmF4cXJ2bXBxeG56cHFtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYyNTcyMTksImV4cCI6MjA4MTgzMzIxOX0.8ryQm1tsdx5ox3aFJiiflmwuEGGxxH_PlobGxXMgFuQ';
        
        let sb = null;
        let currentUserId = null;
        let currentAdminProfile = null;
        let realtimeSubscriptions = [];

        // Live data from database
        let liveTeamData = {};
        let liveProjectData = {};
        let livePendingShares = [];

        // Auth state
        let loginStep = 0;
        let isNewUser = false;
        let existingUserName = '';
        let isPasswordRecovery = false;
        let supabaseUser = null;

        // Parse URL hash for auth tokens
        function parseHashParams(hash) {
            if (!hash || hash.length < 2) return {};
            const params = {};
            const hashContent = hash.substring(1);
            const pairs = hashContent.split('&');
            for (const pair of pairs) {
                const [key, value] = pair.split('=');
                if (key && value) {
                    params[decodeURIComponent(key)] = decodeURIComponent(value);
                }
            }
            return params;
        }

        const initialHash = window.location.hash;
        const hashParams = parseHashParams(initialHash);
        const hasAccessToken = !!hashParams.access_token;
        const hasRefreshToken = !!hashParams.refresh_token;
        const tokenType = hashParams.type;
        const isRecoveryLink = tokenType === 'recovery';

        // Clean URL hash
        if (initialHash) {
            window.history.replaceState(null, '', window.location.pathname + window.location.search);
        }

        function initSupabase() {
            try {
                sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
                    auth: {
                        lock: false,           // CRITICAL: Disable lock to prevent AbortError
                        persistSession: true,  // Enable session persistence
                        autoRefreshToken: true,
                        detectSessionInUrl: false,
                        storageKey: 'fixair-auth'
                    }
                });
                // console.log('✅ Supabase initialized');
                return true;
            } catch (err) {
                console.error('❌ Supabase init error:', err);
                return false;
            }
        }

        // ═══════════════════════════════════════════════════════════════
        // AUTHENTICATION - LOGIN FLOW (Same as Technician App)
        // ═══════════════════════════════════════════════════════════════

        function setLoginStatus(message, type = 'info', showReset = false) {
            const statusEl = document.getElementById('loginStatus');
            if (!statusEl) return;
            statusEl.className = 'login-status ' + type;
            if (showReset) {
                statusEl.innerHTML = message + ' <a onclick="resetPassword()">Réinitialiser</a>';
            } else {
                statusEl.textContent = message;
            }
        }

        function clearLoginStatus() {
            const statusEl = document.getElementById('loginStatus');
            if (statusEl) {
                statusEl.textContent = '';
                statusEl.className = 'login-status';
            }
        }

        async function resetPassword() {
            const email = document.getElementById('loginEmailInput').value.trim();
            if (!email.includes('@')) {
                setLoginStatus(t('errors.enterEmailFirst'), 'error');
                return;
            }
            try {
                const redirectUrl = window.location.origin + window.location.pathname;
                const { error } = await sb.auth.resetPasswordForEmail(email, { redirectTo: redirectUrl });
                if (error) {
                    setLoginStatus('Erreur: ' + error.message, 'error');
                } else {
                    setLoginStatus(t('status.resetSent'), 'success');
                }
            } catch (err) {
                setLoginStatus(t('errors.sendError'), 'error');
            }
        }

        async function nextLoginStep() {
            const btn = document.getElementById('loginBtn');

            if (loginStep === 0) {
                // Step 0: Check email
                const email = document.getElementById('loginEmailInput').value.trim();
                if (!email.includes('@')) {
                    setLoginStatus(t('errors.invalidEmail'), 'error');
                    return;
                }

                clearLoginStatus();
                btn.disabled = true;
                btn.innerHTML = '<span class="icon" style="animation: spin 1s linear infinite;"><svg><use href="#icon-arrow-right"/></svg></span>';

                try {
                    // Check if user exists in public.users
                    const { data: publicUser, error: publicError } = await sb
                        .from('users')
                        .select('id, first_name, status, role')
                        .eq('email', email)
                        .maybeSingle();

                    // FIRST: Check if there was an error (timeout, network, etc)
                    if (publicError) {
                        console.error('Email check failed with error:', publicError);
                        setLoginStatus(t('errors.connectionProblem'), 'error');
                        return;
                    }

                    // THEN: Check if user exists (only if no error)
                    if (publicUser && publicUser.id) {
                        // User exists - check role
                        if (publicUser.role && !['admin', 'owner'].includes(publicUser.role)) {
                            // Wrong role - redirect to appropriate app
                            if (publicUser.role === 'technician') {
                                setLoginStatus(t('status.technicianAccount'), 'info');
                                setTimeout(() => { window.location.replace('https://go.fixair.ai'); }, 1500);
                            } else if (publicUser.role === 'manager') {
                                setLoginStatus(t('status.managerAccount'), 'info');
                                setTimeout(() => { window.location.replace('https://go.fixair.ai/manager'); }, 1500);
                            } else {
                                setLoginStatus(t('errors.notAdminAccount'), 'error');
                            }
                            return;
                        }

                        isNewUser = false;
                        existingUserName = publicUser.first_name || '';

                        if (existingUserName) {
                            setLoginStatus(t('status.welcomeName').replace('{name}', existingUserName), 'success');
                        } else {
                            setLoginStatus(t('status.welcome') + ' !', 'success');
                        }

                        loginStep = 1;
                        updateLoginUI();
                    } else {
                        // No error AND no user = genuinely new user, redirect to signup
                        console.log('User not found in database, redirecting to signup');
                        setLoginStatus(t('status.redirectSignup'), 'info');
                        setTimeout(() => {
                            window.location.href = 'https://go.fixair.ai/auth?email=' + encodeURIComponent(email) + '&from=admin';
                        }, 1000);
                    }

                } catch (error) {
                    console.error('Check email exception:', error);
                    setLoginStatus(t('errors.connectionProblem'), 'error');
                } finally {
                    btn.disabled = false;
                    btn.innerHTML = '<span class="icon"><svg><use href="#icon-arrow-right"/></svg></span>';
                }

            } else if (loginStep === 1) {
                // Step 1: Password - login existing user
                const email = document.getElementById('loginEmailInput').value.trim();
                const password = document.getElementById('loginPasswordInput').value;

                if (!password) {
                    setLoginStatus(t('errors.enterPassword'), 'error');
                    return;
                }

                btn.disabled = true;
                btn.innerHTML = '<span class="icon" style="animation: spin 1s linear infinite;"><svg><use href="#icon-arrow-right"/></svg></span>';
                setLoginStatus(t('status.connecting'), 'info');

                try {
                    const { data, error } = await sb.auth.signInWithPassword({ email, password });

                    if (error) {
                        setLoginStatus(t('errors.wrongPassword'), 'error', true);
                        return;
                    }

                    clearLoginStatus();
                    supabaseUser = data.user;

                    // Load user profile and check role
                    const profile = await loadUserProfile(data.user.id);

                    if (profile) {
                        currentAdminProfile = profile;
                        currentUserId = profile.id;

                        // Check approval status
                        if (profile.status !== 'approved' && profile.status !== 'active') {
                            showPendingScreen(profile.email);
                            return;
                        }

                        // Check role - only admin can access
                        if (profile.role && !['admin', 'owner'].includes(profile.role)) {
                            showAccessDeniedScreen(profile.email);
                            return;
                        }

                        // Success - show main app
                        toast('Bienvenue ' + (profile.first_name || 'Admin') + ' !');
                        showMainApp();
                    } else {
                        setLoginStatus(t('errors.profileNotFound'), 'error');
                    }
                } catch (error) {
                    setLoginStatus(t('errors.serverConnection'), 'error');
                    console.error('Login error:', error);
                } finally {
                    btn.disabled = false;
                    btn.innerHTML = '<span class="icon"><svg><use href="#icon-arrow-right"/></svg></span>';
                }
            }
        }

        function updateLoginUI() {
            document.getElementById('loginSlider').style.transform = `translateX(-${loginStep * 100}%)`;
            document.getElementById('loginSphere').style.display = loginStep === 0 ? 'flex' : 'none';
            document.getElementById('loginBack').style.display = loginStep === 0 ? 'none' : 'flex';
        }

        function prevLoginStep() {
            if (loginStep > 0) {
                loginStep--;
                clearLoginStatus();
                updateLoginUI();
            }
        }

        async function loadUserProfile(authId) {
            try {
                const { data, error } = await sb
                    .from('users')
                    .select('*')
                    .eq('id', authId)
                    .maybeSingle();

                if (error) {
                    console.error('Error loading user profile:', error);
                    return null;
                }
                return data;
            } catch (err) {
                console.error('Exception loading user profile:', err);
                return null;
            }
        }

        // Screen helper functions
        function showEmailConfirmScreen(email) {
            clearLoginStatus();
            document.getElementById('confirmEmail').textContent = email;
            document.getElementById('loginScreen').classList.remove('active');
            document.getElementById('mainApp').classList.remove('active');
            document.getElementById('pendingScreen').classList.remove('active');
            document.getElementById('accessDeniedScreen').classList.remove('active');
            document.getElementById('emailConfirmScreen').classList.add('active');
        }

        function showPendingScreen(email) {
            clearLoginStatus();
            document.getElementById('pendingEmail').textContent = email;
            document.getElementById('loginScreen').classList.remove('active');
            document.getElementById('mainApp').classList.remove('active');
            document.getElementById('emailConfirmScreen').classList.remove('active');
            document.getElementById('accessDeniedScreen').classList.remove('active');
            document.getElementById('pendingScreen').classList.add('active');
        }

        function showAccessDeniedScreen(email, role) {
            clearLoginStatus();

            // Determine redirect URL based on role
            let redirectUrl = 'https://go.fixair.ai';
            let appName = 'Technicien';

            if (role === 'manager') {
                redirectUrl = 'https://go.fixair.ai/manager';
                appName = 'Manager';
            } else if (role === 'technician') {
                redirectUrl = 'https://go.fixair.ai';
                appName = 'Technicien';
            }

            // Update the access denied screen content dynamically
            const accessDeniedScreen = document.getElementById('accessDeniedScreen');
            const container = accessDeniedScreen.querySelector('.pending-container');
            if (container) {
                container.innerHTML = `
                    <div class="pending-logo">
                        <svg viewBox="0 0 235 48" style="height: 40px; color: var(--copilot);"><use href="#icon-fixair-logo"/></svg>
                    </div>
                    <h1 class="pending-title">Acces reserve</h1>
                    <p class="pending-subtitle">
                        Cette application est reservee aux administrateurs.
                        En tant que ${role}, vous serez redirige vers l'application ${appName}.
                    </p>
                    <div class="pending-email">${email}</div>
                    <a href="${redirectUrl}" style="display:inline-block;background:var(--copilot);color:white;padding:12px 32px;border-radius:8px;text-decoration:none;font-weight:600;margin-top:16px;">
                        Aller a l'app ${appName}
                    </a>
                    <button class="pending-logout" onclick="logout()" style="margin-top:8px;">
                        Se deconnecter
                    </button>
                `;
            }

            document.getElementById('loginScreen').classList.remove('active');
            document.getElementById('mainApp').classList.remove('active');
            document.getElementById('emailConfirmScreen').classList.remove('active');
            document.getElementById('pendingScreen').classList.remove('active');
            document.getElementById('accessDeniedScreen').classList.add('active');
        }

        function showPasswordResetScreen() {
            document.getElementById('loginScreen').classList.remove('active');
            document.getElementById('pendingScreen').classList.remove('active');
            document.getElementById('emailConfirmScreen').classList.remove('active');
            document.getElementById('mainApp').classList.remove('active');
            document.getElementById('accessDeniedScreen').classList.remove('active');
            document.getElementById('passwordResetScreen').classList.add('active');
        }

        function redirectToTechnicianApp() {
            window.location.href = '/';
        }

        async function checkApprovalStatus() {
            const btn = document.getElementById('checkStatusBtn');
            const originalText = btn.textContent;
            btn.disabled = true;
            btn.textContent = 'Vérification...';

            try {
                const { data: { user } } = await sb.auth.getUser();
                if (!user) {
                    btn.disabled = false;
                    btn.textContent = originalText;
                    toast('Session expirée, veuillez vous reconnecter');
                    logoutFromPending();
                    return;
                }

                const profile = await loadUserProfile(user.id);
                if (profile && (profile.status === 'approved' || profile.status === 'active')) {
                    // Check role
                    if (profile.role && !['admin', 'owner'].includes(profile.role)) {
                        showAccessDeniedScreen(profile.email);
                        return;
                    }
                    currentAdminProfile = profile;
                    currentUserId = profile.id;
                    toast('Accès approuvé ! Bienvenue ' + (profile.first_name || 'Admin') + ' !');
                    showMainApp();
                } else {
                    toast('Votre compte est toujours en attente de validation');
                    btn.disabled = false;
                    btn.textContent = originalText;
                }
            } catch (err) {
                console.error('Check status error:', err);
                toast('Erreur lors de la vérification');
                btn.disabled = false;
                btn.textContent = originalText;
            }
        }

        async function resendConfirmation() {
            const email = document.getElementById('confirmEmail').textContent;
            try {
                const { error } = await sb.auth.resend({ type: 'signup', email: email });
                if (error) {
                    toast('Erreur: ' + error.message);
                } else {
                    toast('Email renvoyé !');
                }
            } catch (err) {
                toast('Erreur lors de l\'envoi');
            }
        }

        function backToLogin() {
            clearLoginStatus();
            document.getElementById('emailConfirmScreen').classList.remove('active');
            document.getElementById('pendingScreen').classList.remove('active');
            document.getElementById('accessDeniedScreen').classList.remove('active');
            document.getElementById('loginScreen').classList.add('active');

            loginStep = 0;
            const emailInput = document.getElementById('loginEmailInput');
            const passwordInput = document.getElementById('loginPasswordInput');
            if (emailInput) emailInput.value = '';
            if (passwordInput) passwordInput.value = '';
            updateLoginUI();
        }

        async function logoutFromPending() {
            await sb.auth.signOut();
            localStorage.removeItem('supabase.auth.token');
            supabaseUser = null;
            currentUserId = null;
            currentAdminProfile = null;
            isPasswordRecovery = false;
            clearLoginStatus();

            document.getElementById('pendingScreen').classList.remove('active');
            document.getElementById('emailConfirmScreen').classList.remove('active');
            document.getElementById('accessDeniedScreen').classList.remove('active');
            document.getElementById('mainApp').classList.remove('active');
            document.getElementById('loginScreen').classList.add('active');

            loginStep = 0;
            const emailInput = document.getElementById('loginEmailInput');
            const passwordInput = document.getElementById('loginPasswordInput');
            if (emailInput) emailInput.value = '';
            if (passwordInput) passwordInput.value = '';
            document.getElementById('loginSlider').style.transform = 'translateX(0)';
            document.getElementById('loginSphere').style.display = 'flex';
            document.getElementById('loginBack').style.display = 'none';
            document.getElementById('loginBtn').innerHTML = '<span class="icon"><svg><use href="#icon-arrow-right"/></svg></span>';
            document.getElementById('loginBtn').onclick = nextLoginStep;

            toast('Déconnecté');
        }

        async function setNewPassword() {
            const newPass = document.getElementById('newPasswordInput').value;
            const confirmPass = document.getElementById('confirmPasswordInput').value;
            const statusEl = document.getElementById('passwordResetStatus');

            if (!newPass || newPass.length < 6) {
                statusEl.style.display = 'block';
                statusEl.style.background = 'rgba(239,68,68,0.2)';
                statusEl.style.border = '1px solid rgba(239,68,68,0.5)';
                statusEl.style.color = '#ef4444';
                statusEl.textContent = 'Le mot de passe doit contenir au moins 6 caractères';
                return;
            }

            if (newPass !== confirmPass) {
                statusEl.style.display = 'block';
                statusEl.style.background = 'rgba(239,68,68,0.2)';
                statusEl.style.border = '1px solid rgba(239,68,68,0.5)';
                statusEl.style.color = '#ef4444';
                statusEl.textContent = 'Les mots de passe ne correspondent pas';
                return;
            }

            statusEl.style.display = 'block';
            statusEl.style.background = 'rgba(59,130,246,0.2)';
            statusEl.style.border = '1px solid rgba(59,130,246,0.5)';
            statusEl.style.color = '#3b82f6';
            statusEl.textContent = 'Mise à jour en cours...';

            try {
                const { error } = await sb.auth.updateUser({ password: newPass });

                if (error) {
                    statusEl.style.background = 'rgba(239,68,68,0.2)';
                    statusEl.style.border = '1px solid rgba(239,68,68,0.5)';
                    statusEl.style.color = '#ef4444';
                    statusEl.textContent = 'Erreur: ' + error.message;
                    return;
                }

                statusEl.style.background = 'rgba(16,185,129,0.2)';
                statusEl.style.border = '1px solid rgba(16,185,129,0.5)';
                statusEl.style.color = '#10b981';
                statusEl.textContent = 'Mot de passe mis à jour avec succès !';

                isPasswordRecovery = false;
                document.getElementById('newPasswordInput').value = '';
                document.getElementById('confirmPasswordInput').value = '';

                localStorage.removeItem('supabase.auth.token');
                await sb.auth.signOut();

                setTimeout(() => {
                    document.getElementById('passwordResetScreen').classList.remove('active');
                    document.getElementById('loginScreen').classList.add('active');
                    statusEl.style.display = 'none';
                    toast('Connectez-vous avec votre nouveau mot de passe');
                }, 2000);

            } catch (err) {
                statusEl.style.background = 'rgba(239,68,68,0.2)';
                statusEl.style.border = '1px solid rgba(239,68,68,0.5)';
                statusEl.style.color = '#ef4444';
                statusEl.textContent = 'Erreur lors de la mise à jour';
            }
        }

        function cancelPasswordReset() {
            isPasswordRecovery = false;
            localStorage.removeItem('supabase.auth.token');
            sb.auth.signOut();

            document.getElementById('passwordResetScreen').classList.remove('active');
            document.getElementById('loginScreen').classList.add('active');

            document.getElementById('newPasswordInput').value = '';
            document.getElementById('confirmPasswordInput').value = '';
            document.getElementById('passwordResetStatus').style.display = 'none';
        }

        function showMainApp() {
            document.getElementById('loginScreen').classList.remove('active');
            document.getElementById('emailConfirmScreen').classList.remove('active');
            document.getElementById('pendingScreen').classList.remove('active');
            document.getElementById('accessDeniedScreen').classList.remove('active');
            document.getElementById('passwordResetScreen').classList.remove('active');
            document.getElementById('mainApp').classList.add('active');

            // Initialize V7 UI after login
            initV7UI();
        }

        async function logout() {
            await sb.auth.signOut();
            localStorage.removeItem('supabase.auth.token');
            cleanupSubscriptions();
            supabaseUser = null;
            currentUserId = null;
            currentAdminProfile = null;
            loginStep = 0;
            isNewUser = false;
            isPasswordRecovery = false;
            clearLoginStatus();

            const emailInput = document.getElementById('loginEmailInput');
            const passwordInput = document.getElementById('loginPasswordInput');
            if (emailInput) emailInput.value = '';
            if (passwordInput) passwordInput.value = '';
            document.getElementById('loginSlider').style.transform = 'translateX(0)';
            document.getElementById('loginSphere').style.display = 'flex';
            document.getElementById('loginBack').style.display = 'none';
            document.getElementById('loginBtn').innerHTML = '<span class="icon"><svg><use href="#icon-arrow-right"/></svg></span>';
            document.getElementById('loginBtn').onclick = nextLoginStep;

            // Show login screen (stay on same app)
            document.getElementById('mainApp').classList.remove('active');
            document.getElementById('pendingScreen').classList.remove('active');
            document.getElementById('emailConfirmScreen').classList.remove('active');
            document.getElementById('accessDeniedScreen').classList.remove('active');
            document.getElementById('passwordResetScreen').classList.remove('active');
            document.getElementById('loginScreen').classList.add('active');

            toast('Déconnecté');
        }

        // Initialize auth on page load
        async function initAuth() {
            // Check if email passed in URL (from /auth redirect)
            const urlParams = new URLSearchParams(window.location.search);
            const emailParam = urlParams.get('email');
            if (emailParam) {
                const emailInput = document.getElementById('loginEmailInput');
                if (emailInput) {
                    emailInput.value = decodeURIComponent(emailParam);
                }
                // Clean URL
                window.history.replaceState({}, document.title, window.location.pathname);
            }

            if (hasAccessToken && hasRefreshToken) {
                if (isRecoveryLink) {
                    isPasswordRecovery = true;
                }

                try {
                    const { data, error } = await sb.auth.setSession({
                        access_token: hashParams.access_token,
                        refresh_token: hashParams.refresh_token
                    });

                    if (error) {
                        isPasswordRecovery = false;
                        return;
                    }

                    // Manually persist session to localStorage for reliability
                    if (data.session) {
                        localStorage.setItem('supabase.auth.token', JSON.stringify({
                            currentSession: data.session,
                            expiresAt: data.session.expires_at
                        }));
                    }

                    if (isRecoveryLink) {
                        showPasswordResetScreen();
                    } else if (data.session && data.session.user) {
                        await handleAuthenticatedUser(data.session.user);
                    }
                } catch (err) {
                    isPasswordRecovery = false;
                }
            } else {
                // No URL tokens - check localStorage for existing session
                try {
                    const stored = localStorage.getItem('supabase.auth.token');
                    if (stored) {
                        const parsed = JSON.parse(stored);
                        if (parsed.currentSession) {
                            const { data, error } = await sb.auth.setSession({
                                access_token: parsed.currentSession.access_token,
                                refresh_token: parsed.currentSession.refresh_token
                            });
                            if (!error && data.session) {
                                await handleAuthenticatedUser(data.session.user);
                                return;
                            }
                        }
                    }
                } catch (err) {
                    // console.log('No valid stored session');
                }
            }
        }

        async function handleAuthenticatedUser(user) {
            supabaseUser = user;

            // Load user profile
            const profile = await loadUserProfile(user.id);

            if (profile) {
                currentAdminProfile = profile;
                currentUserId = profile.id;

                // Check approval status
                if (profile.status !== 'approved' && profile.status !== 'active') {
                    showPendingScreen(profile.email);
                    return;
                }

                // Check role - only admin can access Admin App
                if (profile.role && !['admin', 'owner'].includes(profile.role)) {
                    showAccessDeniedScreen(profile.email, profile.role);
                    return;
                }

                // Success - show main app
                showMainApp();
            } else {
                showPendingScreen(user.email);
            }
        }

        // Legacy functions for compatibility
        async function checkManagerAuth() {
            try {
                const { data: { session } } = await sb.auth.getSession();
                if (!session) {
                    // console.log('No session - showing login');
                    return null;
                }

                const { data: profile } = await sb
                    .from('users')
                    .select('*')
                    .eq('id', session.user.id)
                    .maybeSingle();

                if (!profile) {
                    // console.log('No profile found');
                    return null;
                }

                currentUserId = profile.id;
                currentAdminProfile = profile;

                // Check if user is an admin
                if (profile.role && !['admin', 'owner'].includes(profile.role)) {
                    // console.log('User role is:', profile.role, '- not an admin');
                    return null;
                }

                // console.log('✅ Manager authenticated:', profile.email);
                return profile;
            } catch (err) {
                console.error('Auth check error:', err);
                return null;
            }
        }

        async function managerLogout() {
            await logout();
        }



        // ═══════════════════════════════════════════════════════════════
        // V7 UI CODE (unchanged)
        // ═══════════════════════════════════════════════════════════════
        const projects = [
            {id:'E1-024',name:'Diagnostic VRF',address:'Hôtel Novotel, La Défense',tech:'Jean Jr.',techId:4,manager:'Jean Dupont',team:'nord',progress:{total:45,identification:100,diagnostic:60,mesures:20,conclusion:0},equipment:'Daikin VRV IV',priority:'Haute',coords:[2.2378,48.8924]},
            {id:'E1-025',name:'Maintenance Préventive',address:'Bureaux JLL, Boulogne',tech:'Marie L.',techId:5,manager:'Sophie Martin',team:'sud',progress:{total:78,identification:100,diagnostic:100,mesures:80,conclusion:30},equipment:'Carrier 30XA',priority:'Normale',coords:[2.24,48.84]},
            {id:'E1-026',name:'Diagnostic Clim Split',address:'Restaurant Bella Vita, Paris 15',tech:'Pierre B.',techId:6,manager:'Jean Dupont',team:'nord',progress:{total:62,identification:100,diagnostic:80,mesures:40,conclusion:20},equipment:'Mitsubishi MSZ',priority:'Normale',coords:[2.29,48.845]},
            {id:'E1-027',name:'Vérification Installation',address:"Centre Commercial O'Parinor",tech:'Thomas H.',techId:7,manager:'Pierre Admin',team:'direct',progress:{total:30,identification:100,diagnostic:20,mesures:0,conclusion:0},equipment:'Trane RTAC',priority:'Basse',coords:[2.41,48.95]},
            {id:'E1-028',name:'Remplacement Compresseur',address:'Tour Montparnasse',tech:'Antoine B.',techId:8,manager:'Sophie Martin',team:'sud',progress:{total:100,identification:100,diagnostic:100,mesures:100,conclusion:100},equipment:'Carrier 30RB',priority:'Haute',coords:[2.32,48.842]},
            {id:'E1-029',name:'Mise en service PAC',address:'Résidence Les Jardins, Neuilly',tech:'Marc L.',techId:9,manager:'Jean Dupont',team:'nord',progress:{total:15,identification:60,diagnostic:0,mesures:0,conclusion:0},equipment:'Daikin Altherma',priority:'Normale',coords:[2.27,48.885]},
            {id:'E1-030',name:'Dépannage Urgence',address:'Clinique Saint-Louis, Paris 10',tech:'Luc M.',techId:10,manager:'Sophie Martin',team:'sud',progress:{total:55,identification:100,diagnostic:70,mesures:30,conclusion:10},equipment:'Carrier 30XA',priority:'Urgente',coords:[2.37,48.875]},
            {id:'E1-031',name:'Audit Énergétique',address:'Siège BNP, Paris 9',tech:'Claire D.',techId:11,manager:'Jean Dupont',team:'nord',progress:{total:88,identification:100,diagnostic:100,mesures:90,conclusion:60},equipment:'Multiple',priority:'Haute',coords:[2.33,48.872]}
        ];

        const teamMembers = [
            {id:1,name:'Jean Dupont',initials:'JD',role:'manager',team:'Nord',projects:12,techs:4,status:'live',currentProject:'Supervision',client:'Multi-sites',stats:{projects:12,completed:8,avgTime:'2.3h',rate:'94%'},messages:[{type:'received',text:'Rapport E1-024 validé',time:'14:32'}]},
            {id:2,name:'Sophie Martin',initials:'SM',role:'manager',team:'Sud',projects:15,techs:5,status:'live',currentProject:'Supervision',client:'Multi-sites',stats:{projects:15,completed:11,avgTime:'2.1h',rate:'96%'},messages:[]},
            {id:3,name:'Pierre Admin',initials:'PA',role:'manager',team:'Direct',projects:8,techs:3,status:'idle',currentProject:'Supervision',client:'Multi-sites',stats:{projects:8,completed:5,avgTime:'2.8h',rate:'88%'},messages:[]},
            {id:4,name:'Jean Jr.',initials:'JJ',role:'tech',team:'Nord',status:'live',currentProject:'Diagnostic VRF',client:'Hôtel Novotel',stats:{projects:3,completed:2,avgTime:'2.5h',rate:'92%'},messages:[{type:'received',text:'Diagnostic en cours, problème compresseur identifié',time:'Il y a 15 min'},{type:'received',text:'Besoin pièce réf. COMP-DK-450',time:'Il y a 10 min'}],projectIds:['E1-024','E1-029']},
            {id:5,name:'Marie L.',initials:'ML',role:'tech',team:'Sud',status:'live',currentProject:'Maintenance',client:'Bureaux JLL',stats:{projects:2,completed:1,avgTime:'2.2h',rate:'95%'},messages:[],projectIds:['E1-025']},
            {id:6,name:'Pierre B.',initials:'PB',role:'tech',team:'Nord',status:'offline',currentProject:'Diagnostic Clim',client:'Restaurant Bella Vita',stats:{projects:2,completed:1,avgTime:'3.0h',rate:'85%'},messages:[],projectIds:['E1-026']},
            {id:7,name:'Thomas H.',initials:'TH',role:'tech',team:'Direct',status:'live',currentProject:'Vérification',client:"O'Parinor",stats:{projects:1,completed:0,avgTime:'-',rate:'-'},messages:[],projectIds:['E1-027']},
            {id:8,name:'Antoine B.',initials:'AB',role:'tech',team:'Sud',status:'live',currentProject:'Remplacement',client:'Tour Montparnasse',stats:{projects:2,completed:2,avgTime:'1.8h',rate:'100%'},messages:[],projectIds:['E1-028']},
            {id:9,name:'Marc L.',initials:'MCL',role:'tech',team:'Nord',status:'idle',currentProject:'Mise en service',client:'Résidence Les Jardins',stats:{projects:1,completed:0,avgTime:'-',rate:'-'},messages:[],projectIds:['E1-029']},
            {id:10,name:'Luc M.',initials:'LM',role:'tech',team:'Sud',status:'live',currentProject:'Dépannage',client:'Clinique Saint-Louis',stats:{projects:2,completed:1,avgTime:'2.0h',rate:'90%'},messages:[],projectIds:['E1-030']},
            {id:11,name:'Claire D.',initials:'CD',role:'tech',team:'Nord',status:'live',currentProject:'Audit',client:'Siège BNP',stats:{projects:1,completed:0,avgTime:'-',rate:'-'},messages:[],projectIds:['E1-031']},
            {id:12,name:'Hugo T.',initials:'HT',role:'tech',team:'Direct',status:'offline',currentProject:'-',client:'-',stats:{projects:2,completed:2,avgTime:'2.4h',rate:'91%'},messages:[],projectIds:[]}
        ];

        let map, markers = {};

        function initMap() {
            if (typeof mapboxgl === 'undefined') {
                console.error('Mapbox GL not loaded');
                return;
            }
            mapboxgl.accessToken = 'pk.eyJ1IjoiZml4YWlyIiwiYSI6ImNta3JuZGs0eDEzaDAzaHNhaW5mcHg4NnEifQ.qnO4DRefFVdrTym0pZOETw';
            map = new mapboxgl.Map({
                container: 'map',
                style: 'mapbox://styles/fixair/cmkrnkhsl001b01r65zopewtt',
                center: [2.3522, 48.8566],
                zoom: 11
            });
            map.addControl(new mapboxgl.NavigationControl(), 'bottom-right');
            map.on('load', () => {
                const tc = {nord: 'var(--team-nord)', sud: 'var(--team-sud)', direct: 'var(--team-direct)'};
                projects.forEach(p => {
                    const el = document.createElement('div');
                    el.className = 'map-marker';
                    const initials = p.tech.split(' ').map(n => n[0]).join('');
                    el.innerHTML = `<div class="pin"><div class="pin-body ${p.team}"><span>${initials}</span></div><div class="pin-card"><div class="pin-card-title">${p.name}</div><div class="pin-card-address">${p.address}</div><div class="pin-card-progress"><div class="pin-card-bar"><div class="pin-card-fill" style="width:${p.progress.total}%;background:${tc[p.team]}"></div></div><span class="pin-card-value" style="color:${tc[p.team]}">${p.progress.total}%</span></div></div></div>`;
                    el.addEventListener('click', () => openMapProjectDetail(p.id));
                    markers[p.id] = new mapboxgl.Marker(el).setLngLat(p.coords).addTo(map);
                });
            });
        }

        function renderMapProjectsList() {
            const tc = {nord:'var(--team-nord)',sud:'var(--team-sud)',direct:'var(--team-direct)'};
            document.getElementById('mapProjectsList').innerHTML = projects.slice(0, 6).map(p => `
                <div class="map-project-card" onclick="openMapProjectDetail('${p.id}')">
                    <div class="team-bar ${p.team}"></div>
                    <div class="content">
                        <div class="title">${p.name}</div>
                        <div class="tech">${p.tech} • ${p.address.split(',')[0]}</div>
                    </div>
                    <div class="progress">
                        <div class="progress-bar"><div class="progress-fill" style="width:${p.progress.total}%;background:${tc[p.team]}"></div></div>
                        <span class="progress-value" style="color:${tc[p.team]}">${p.progress.total}%</span>
                    </div>
                    <span class="id">${p.id}</span>
                </div>
            `).join('');
        }

        function renderProjectCards() {
            const tc = {nord:'var(--team-nord)',sud:'var(--team-sud)',direct:'var(--team-direct)'};
            document.getElementById('projectCardList').innerHTML = projects.map(p => `
                <div class="proj" onclick="openProjectDetail('${p.id}')">
                    <div class="proj-status-bar ${p.team}"></div>
                    <div class="proj-icon ${p.team}">
                        <svg viewBox="0 0 16 16" fill="currentColor"><path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/><path d="m8.93 6.588-2.29.287-.082.38.45.083c.294.07.352.176.288.469l-.738 3.468c-.194.897.105 1.319.808 1.319.545 0 1.178-.252 1.465-.598l.088-.416c-.2.176-.492.246-.686.246-.275 0-.375-.193-.304-.533L8.93 6.588z"/><circle cx="8" cy="4.5" r="1"/></svg>
                    </div>
                    <div class="proj-info">
                        <div class="proj-title">${p.name}</div>
                        <div class="proj-meta">${p.tech} • ${p.address.split(',')[0]}</div>
                    </div>
                    <div class="proj-right">
                        <div class="proj-progress">
                            <div class="proj-progress-bar"><div class="proj-progress-fill" style="width:${p.progress.total}%;background:${tc[p.team]}"></div></div>
                            <span class="proj-progress-value" style="color:${tc[p.team]}">${p.progress.total}%</span>
                        </div>
                        <div class="proj-id">${p.id}</div>
                    </div>
                </div>
            `).join('');
        }

        function renderTeamCards() {
            const managers = teamMembers.filter(m => m.role === 'manager');
            const techs = teamMembers.filter(m => m.role === 'tech');
            
            document.getElementById('managersCardList').innerHTML = managers.map(m => `
                <div class="tech-card" onclick="openTechDetail(${m.id})">
                    <div class="tech-avatar">${m.initials}<div class="tech-status ${m.status}"></div></div>
                    <div class="tech-info"><div class="tech-name">${m.name}</div><div class="tech-project">Équipe ${m.team} • ${m.techs} techniciens</div></div>
                    <div class="tech-right"><span class="tech-stats">${m.projects} projets</span></div>
                </div>
            `).join('');
            
            document.getElementById('techsCardList').innerHTML = techs.map(m => `
                <div class="tech-card" onclick="openTechDetail(${m.id})">
                    <div class="tech-avatar">${m.initials}<div class="tech-status ${m.status}"></div></div>
                    <div class="tech-info"><div class="tech-name">${m.name}</div><div class="tech-project">${m.currentProject}</div></div>
                    <div class="tech-right"><span class="tech-stats">Équipe ${m.team}</span></div>
                </div>
            `).join('');
        }

        // Main card hover - Projects
        const panel = document.getElementById('mapLeftPanel');
        const mainCard = document.getElementById('mapMainCard');
        mainCard.addEventListener('mouseenter', () => panel.classList.add('expanded'));
        panel.addEventListener('mouseleave', () => panel.classList.remove('expanded'));

        // Main card hover - Technicians (SAME UI as Projects card)
        const techPanel = document.getElementById('techLeftPanel');
        const techMainCard = document.getElementById('techMainCard');
        techMainCard.addEventListener('mouseenter', () => techPanel.classList.add('expanded'));
        techPanel.addEventListener('mouseleave', () => techPanel.classList.remove('expanded'));

        // Render tech list in dropdown (same style as projects)
        function renderTechListDropdown() {
            const tc = {nord:'var(--team-nord)',sud:'var(--team-sud)',direct:'var(--team-direct)'};
            const techs = teamMembers.filter(m => m.role === 'tech');
            document.getElementById('techListDropdown').innerHTML = techs.map(t => `
                <div class="map-project-card" onclick="flyToTechProject(${t.id})">
                    <div class="team-bar ${t.team}"></div>
                    <div class="content">
                        <div class="title">${t.name}</div>
                        <div class="tech">${t.currentProject} • ${t.status === 'live' ? 'En ligne' : t.status === 'idle' ? 'Inactif' : 'Hors ligne'}</div>
                    </div>
                    <div class="progress">
                        <div class="progress-bar"><div class="progress-fill" style="width:${t.status === 'live' ? 100 : t.status === 'idle' ? 50 : 0}%;background:${t.status === 'live' ? 'var(--accent-green)' : t.status === 'idle' ? 'var(--accent-orange)' : 'var(--text-muted)'}"></div></div>
                        <span class="progress-value" style="color:${t.status === 'live' ? 'var(--accent-green)' : t.status === 'idle' ? 'var(--accent-orange)' : 'var(--text-muted)'}">${t.status === 'live' ? 'En ligne' : t.status === 'idle' ? 'Inactif' : 'Offline'}</span>
                    </div>
                    <span class="id">${t.initials}</span>
                </div>
            `).join('');
        }

        // Fly to tech's current project AND open TECH drawer
        function flyToTechProject(techId) {
            const tech = teamMembers.find(t => t.id === techId);
            if (!tech) return;
            
            // Find project by tech name
            const project = projects.find(p => p.tech === tech.name);
            
            // Center pin on LEFT side of screen (drawer will be on right)
            if (project && project.coords) {
                const screenWidth = window.innerWidth;
                map.flyTo({ 
                    center: project.coords, 
                    zoom: 15,
                    offset: [-screenWidth * 0.25, 0]
                });
                Object.values(markers).forEach(m => m.getElement().classList.remove('active'));
                if (markers[project.id]) markers[project.id].getElement().classList.add('active');
            }
            
            // Open TECH drawer (not project drawer)
            openTechMapDrawer(tech);
        }

        // Open Tech Map Drawer
        function openTechMapDrawer(tech) {
            // Hide notification and view toggle
            document.getElementById('notificationIcon').style.display = 'none';
            document.getElementById('viewToggle').style.display = 'none';
            
            // Close map drawer if open
            document.getElementById('mapDrawer').classList.remove('visible');
            
            // Populate tech drawer
            document.getElementById('techMDName').textContent = tech.name;
            document.getElementById('techMDRole').textContent = `Technicien • Équipe ${tech.team.charAt(0).toUpperCase() + tech.team.slice(1)}`;
            document.getElementById('techMDStatus').textContent = tech.status === 'live' ? 'En ligne' : tech.status === 'idle' ? 'Inactif' : 'Hors ligne';
            document.getElementById('techMDStatus').className = 'drawer-badge ' + tech.status;
            document.getElementById('techMapDrawerBody').innerHTML = buildTechMapDrawerContent(tech);
            
            // Show drawer
            document.getElementById('techMapDrawer').classList.add('visible');
        }

        function closeTechMapDrawer() {
            document.getElementById('techMapDrawer').classList.remove('visible');
            document.getElementById('notificationIcon').style.display = '';
            document.getElementById('viewToggle').style.display = '';
            Object.values(markers).forEach(m => m.getElement().classList.remove('active'));
        }

        function buildTechMapDrawerContent(tech) {
            const techProjects = projects.filter(p => p.tech === tech.name);
            const tc = {nord:'var(--team-nord)',sud:'var(--team-sud)',direct:'var(--team-direct)'};
            
            const projectsHtml = techProjects.length ? techProjects.map(p => `
                <div class="mini-project" onclick="openProjectFromTechDrawer('${p.id}')">
                    <div class="mini-project-bar ${p.team}"></div>
                    <div class="mini-project-info">
                        <div class="mini-project-title">${p.name}</div>
                        <div class="mini-project-meta">${p.id} • ${p.address.split(',')[0]}</div>
                    </div>
                    <div class="mini-project-progress" style="color:${tc[p.team]}">${p.progress.total}%</div>
                </div>
            `).join('') : '<div style="font-size:12px;color:var(--text-muted);text-align:center;padding:16px;">Aucun projet assigné</div>';
            
            return `
                <div class="info-card">
                    <div class="info-card-title">Informations</div>
                    <div class="info-row"><span class="info-label">Statut</span><span class="info-value ${tech.status === 'live' ? 'green' : tech.status === 'idle' ? 'orange' : ''}">${tech.status === 'live' ? 'En ligne' : tech.status === 'idle' ? 'Inactif' : 'Hors ligne'}</span></div>
                    <div class="info-row"><span class="info-label">Projet actuel</span><span class="info-value">${tech.currentProject}</span></div>
                    <div class="info-row"><span class="info-label">Équipe</span><span class="info-value">${tech.team.charAt(0).toUpperCase() + tech.team.slice(1)}</span></div>
                </div>
                <div class="info-card">
                    <div class="info-card-title">Statistiques (semaine)</div>
                    <div class="info-row"><span class="info-label">Interventions</span><span class="info-value">5</span></div>
                    <div class="info-row"><span class="info-label">Complétées</span><span class="info-value green">4</span></div>
                    <div class="info-row"><span class="info-label">Temps moyen</span><span class="info-value">3.5h</span></div>
                    <div class="info-row"><span class="info-label">Taux succès</span><span class="info-value green">92%</span></div>
                </div>
                <div class="info-card">
                    <div class="info-card-title">Projets assignés</div>
                    ${projectsHtml}
                </div>
            `;
        }

        // Open project from tech drawer
        function openProjectFromTechDrawer(projectId) {
            closeTechMapDrawer();
            openMapProjectDetail(projectId);
        }

        function openTechChat() { alert('Chat avec technicien'); }
        function callTechnician() { alert('Appel technicien'); }

        // Calendar functions
        let currentCalMonth = 0;
        let currentCalYear = 2026;
        let currentCalendarView = 'month';
        let currentDayDate = null;
        const calMonths = ['Janvier','Février','Mars','Avril','Mai','Juin','Juillet','Août','Septembre','Octobre','Novembre','Décembre'];
        const calDays = ['Dimanche','Lundi','Mardi','Mercredi','Jeudi','Vendredi','Samedi'];

        // Calendar events data
        const calendarEvents = [
            { date: '2026-01-25', title: 'Maintenance Novotel', tech: 'Jean Jr.', team: 'nord', time: '09:00' },
            { date: '2026-01-25', title: 'PAC Résidence', tech: 'Marc P.', team: 'sud', time: '09:00' },
            { date: '2026-01-25', title: 'CB21 Maintenance', tech: 'Sophie M.', team: 'nord', time: '14:00' },
            { date: '2026-01-27', title: 'Installation VRV', tech: 'Pierre D.', team: 'direct', time: '08:00' },
            { date: '2026-01-27', title: 'Diagnostic PAC', tech: 'Lucas B.', team: 'sud', time: '10:00' },
            { date: '2026-01-28', title: 'Révision annuelle', tech: 'Emma L.', team: 'nord', time: '09:00' },
            { date: '2026-01-29', title: 'Dépannage urgent', tech: 'Jean Jr.', team: 'nord', time: '08:00' },
            { date: '2026-01-30', title: 'Formation client', tech: 'Sophie M.', team: 'nord', time: '14:00' },
        ];

        function switchView(v) {
            document.querySelectorAll('.toggle-btn').forEach(b => b.classList.remove('active'));
            event.target.closest('.toggle-btn').classList.add('active');
            if (v === 'calendar') {
                document.getElementById('notificationIcon').style.display = 'none';
                currentCalendarView = 'month';
                renderCalendar();
                document.getElementById('calendarView').classList.add('active');
            } else {
                document.getElementById('calendarView').classList.remove('active');
                document.getElementById('notificationIcon').style.display = '';
            }
        }

        function closeCalendar() {
            document.getElementById('calendarView').classList.remove('active');
            document.getElementById('notificationIcon').style.display = '';
            document.querySelectorAll('.toggle-btn').forEach(b => b.classList.remove('active'));
            document.querySelector('.toggle-btn').classList.add('active');
        }

        function setCalendarView(view) {
            currentCalendarView = view;
            document.querySelectorAll('.cal-view-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
            
            document.getElementById('monthViewContainer').classList.toggle('hidden', view !== 'month');
            document.getElementById('dayViewContainer').classList.toggle('active', view === 'day');
            document.getElementById('weekViewContainer').classList.toggle('active', view === 'week');
            
            if (view === 'month') renderCalendar();
            else if (view === 'day') renderDayView();
            else if (view === 'week') renderWeekView();
        }

        function calendarPrev() {
            if (currentCalendarView === 'month') {
                currentCalMonth--;
                if (currentCalMonth < 0) { currentCalMonth = 11; currentCalYear--; }
                renderCalendar();
            } else if (currentCalendarView === 'day' && currentDayDate) {
                currentDayDate.setDate(currentDayDate.getDate() - 1);
                renderDayView();
            } else if (currentCalendarView === 'week') {
                currentCalMonth--;
                if (currentCalMonth < 0) { currentCalMonth = 11; currentCalYear--; }
                renderWeekView();
            }
        }

        function calendarNext() {
            if (currentCalendarView === 'month') {
                currentCalMonth++;
                if (currentCalMonth > 11) { currentCalMonth = 0; currentCalYear++; }
                renderCalendar();
            } else if (currentCalendarView === 'day' && currentDayDate) {
                currentDayDate.setDate(currentDayDate.getDate() + 1);
                renderDayView();
            } else if (currentCalendarView === 'week') {
                currentCalMonth++;
                if (currentCalMonth > 11) { currentCalMonth = 0; currentCalYear++; }
                renderWeekView();
            }
        }

        function renderCalendar() {
            document.getElementById('calMonthTitle').textContent = `${calMonths[currentCalMonth]} ${currentCalYear}`;
            
            const firstDay = new Date(currentCalYear, currentCalMonth, 1).getDay();
            const daysInMonth = new Date(currentCalYear, currentCalMonth + 1, 0).getDate();
            const startOffset = (firstDay === 0 ? 6 : firstDay - 1);
            const today = new Date();
            
            let html = '';
            const prevDays = new Date(currentCalYear, currentCalMonth, 0).getDate();
            const totalCells = startOffset + daysInMonth;
            const rows = Math.ceil(totalCells / 7);
            const totalNeeded = rows * 7;
            
            let cellIndex = 0;
            
            // Previous month days
            for (let i = startOffset - 1; i >= 0; i--) {
                const cornerClass = getCornerClass(cellIndex, totalNeeded);
                html += `<div class="calendar-day other ${cornerClass}"><span class="calendar-day-num">${prevDays - i}</span></div>`;
                cellIndex++;
            }
            
            // Current month days
            for (let d = 1; d <= daysInMonth; d++) {
                const isToday = currentCalYear === today.getFullYear() && currentCalMonth === today.getMonth() && d === today.getDate();
                const dateStr = `${currentCalYear}-${String(currentCalMonth + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
                const dayEvents = calendarEvents.filter(e => e.date === dateStr);
                const eventsHtml = dayEvents.slice(0, 3).map(e => `<div class="calendar-event ${e.team}">${e.tech}</div>`).join('');
                const moreHtml = dayEvents.length > 3 ? `<div class="calendar-more">+${dayEvents.length - 3}</div>` : '';
                const cornerClass = getCornerClass(cellIndex, totalNeeded);
                
                html += `<div class="calendar-day${isToday ? ' today' : ''} ${cornerClass}" onclick="openDayView(${d}, ${currentCalMonth}, ${currentCalYear})">
                    <span class="calendar-day-num">${d}</span>
                    <div class="calendar-events-container">${eventsHtml}${moreHtml}</div>
                </div>`;
                cellIndex++;
            }
            
            // Next month days
            const remaining = totalNeeded - cellIndex;
            for (let i = 1; i <= remaining; i++) {
                const cornerClass = getCornerClass(cellIndex, totalNeeded);
                html += `<div class="calendar-day other ${cornerClass}"><span class="calendar-day-num">${i}</span></div>`;
                cellIndex++;
            }
            
            document.getElementById('calendarDays').innerHTML = html;
        }

        function getCornerClass(index, total) {
            const cols = 7;
            const rows = total / cols;
            const row = Math.floor(index / cols);
            const col = index % cols;
            
            let classes = [];
            if (row === 0 && col === 0) classes.push('corner-tl');
            if (row === 0 && col === cols - 1) classes.push('corner-tr');
            if (row === rows - 1 && col === 0) classes.push('corner-bl');
            if (row === rows - 1 && col === cols - 1) classes.push('corner-br');
            return classes.join(' ');
        }

        function openDayView(day, month, year) {
            currentDayDate = new Date(year, month, day);
            currentCalendarView = 'day';
            document.querySelectorAll('.cal-view-btn').forEach(b => b.classList.remove('active'));
            document.querySelector('.cal-view-btn').classList.add('active');
            
            document.getElementById('monthViewContainer').classList.add('hidden');
            document.getElementById('dayViewContainer').classList.add('active');
            document.getElementById('weekViewContainer').classList.remove('active');
            
            renderDayView();
        }

        function renderDayView() {
            if (!currentDayDate) currentDayDate = new Date();
            
            const day = currentDayDate.getDate();
            const month = currentDayDate.getMonth();
            const year = currentDayDate.getFullYear();
            const dayOfWeek = currentDayDate.getDay();
            
            document.getElementById('calMonthTitle').textContent = `${calDays[dayOfWeek]} ${day} ${calMonths[month]} ${year}`;
            
            const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
            const dayEvents = calendarEvents.filter(e => e.date === dateStr);
            
            // Group events by time
            const timeSlots = {};
            for (let h = 6; h <= 20; h++) {
                const time = `${String(h).padStart(2, '0')}:00`;
                timeSlots[time] = dayEvents.filter(e => e.time === time);
            }
            
            let html = '';
            for (let h = 6; h <= 20; h++) {
                const time = `${String(h).padStart(2, '0')}:00`;
                const events = timeSlots[time];
                
                html += `<div class="time-row">
                    <div class="time-label">${time}</div>
                    <div class="time-slots">
                        ${events.map(e => `
                            <div class="gantt-task ${e.team}">
                                <div class="gantt-task-title">${e.title}</div>
                                <div class="gantt-task-tech">${e.tech}</div>
                            </div>
                        `).join('')}
                    </div>
                </div>`;
            }
            
            document.getElementById('dayTimeline').innerHTML = html;
        }

        function renderWeekView() {
            document.getElementById('calMonthTitle').textContent = `${calMonths[currentCalMonth]} ${currentCalYear}`;
            
            // Get start of week (Monday)
            const startOfWeek = new Date(currentCalYear, currentCalMonth, 1);
            const dayOfWeek = startOfWeek.getDay();
            startOfWeek.setDate(startOfWeek.getDate() - (dayOfWeek === 0 ? 6 : dayOfWeek - 1) + 21);
            
            // Update weekday headers with dates
            let headerHtml = '<div class="calendar-weekday week-time-header"></div>';
            for (let i = 0; i < 7; i++) {
                const d = new Date(startOfWeek);
                d.setDate(startOfWeek.getDate() + i);
                headerHtml += `<div class="calendar-weekday">${calDays[(i + 1) % 7].substring(0, 3)}</div>`;
            }
            document.getElementById('weekWeekdays').innerHTML = headerHtml;
            
            // Build grid
            let gridHtml = '';
            for (let h = 6; h <= 20; h++) {
                gridHtml += `<div class="week-time-row">
                    <div class="week-time-label">${String(h).padStart(2, '0')}:00</div>`;
                
                for (let i = 0; i < 7; i++) {
                    const d = new Date(startOfWeek);
                    d.setDate(startOfWeek.getDate() + i);
                    const dateStr = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
                    const time = `${String(h).padStart(2, '0')}:00`;
                    const events = calendarEvents.filter(e => e.date === dateStr && e.time === time);
                    
                    gridHtml += `<div class="week-cell">
                        ${events.map(e => `<div class="week-event ${e.team}">${e.tech}</div>`).join('')}
                    </div>`;
                }
                gridHtml += '</div>';
            }
            document.getElementById('weekGrid').innerHTML = gridHtml;
        }

        // Notification functions
        function toggleNotifications() {
            const panel = document.getElementById('notifPanel');
            panel.classList.toggle('visible');
        }

        function dismissNotif(btn) {
            const card = btn.closest('.notification-card');
            card.style.animation = 'none';
            card.style.opacity = '0';
            card.style.transform = 'translateX(20px)';
            card.style.transition = 'all 0.2s ease';
            setTimeout(() => card.remove(), 200);
            // Check if no more notifications
            setTimeout(() => {
                if (!document.querySelectorAll('.notification-card').length) {
                    document.getElementById('notifDot').style.display = 'none';
                }
            }, 250);
        }

        function showProjectsPage() {
            document.getElementById('projectsPage').classList.add('active');
            document.getElementById('teamsPage').classList.remove('active');
            renderProjectCards();
        }

        function showTeamsPage() {
            document.getElementById('teamsPage').classList.add('active');
            document.getElementById('projectsPage').classList.remove('active');
            renderTeamCards();
        }

        function goToDashboard() {
            closePage();
            closeMapDrawer();
            closeTechMapDrawer();
            closeCalendar();
        }

        function showSettingsPage() {
            alert('Paramètres Admin - À venir');
        }

        function openNotificationDetail(notifId) {
            document.getElementById('notifPanel').classList.remove('visible');
            // Could open a specific project or chat based on notifId
            alert('Ouvrir détail: ' + notifId);
        }

        // Dock tooltip functionality
        function initDockTooltips() {
            const dockItems = document.querySelectorAll('.dock-item');
            const tooltip = document.getElementById('dockTooltip');
            
            dockItems.forEach(item => {
                item.addEventListener('mouseenter', (e) => {
                    const text = item.getAttribute('data-tooltip');
                    if (text) {
                        tooltip.textContent = text;
                        tooltip.classList.add('visible');
                        const rect = item.getBoundingClientRect();
                        const dockRect = document.getElementById('dockContainer').getBoundingClientRect();
                        tooltip.style.left = (rect.left - dockRect.left + rect.width/2) + 'px';
                    }
                });
                item.addEventListener('mouseleave', () => {
                    tooltip.classList.remove('visible');
                });
            });
        }

        function closePage() {
            document.getElementById('projectsPage').classList.remove('active', 'drawer-open');
            document.getElementById('teamsPage').classList.remove('active', 'drawer-open');
            closeNestedDrawer();
        }

        function buildProjectDrawerContent(p) {
            const tech = teamMembers.find(t => t.id === p.techId) || {initials:'??',name:p.tech,messages:[]};
            const msgs = tech.messages.length ? tech.messages.map(m => `<div class="msg ${m.type === 'sent' ? 'user' : 'ai'}"><div class="msg-bubble">${m.text}</div><div class="msg-time">${m.time}</div></div>`).join('') : '<div style="text-align:center;color:var(--text-muted);padding:20px;font-size:12px;">Aucun message</div>';
            
            return `
            <div class="info-card">
                <div class="info-card-title">Informations</div>
                <div class="info-row"><span class="info-label">Technicien</span><span class="info-value">${p.tech}</span></div>
                <div class="info-row"><span class="info-label">Manager</span><span class="info-value">${p.manager}</span></div>
                <div class="info-row"><span class="info-label">Équipement</span><span class="info-value">${p.equipment}</span></div>
                <div class="info-row"><span class="info-label">Priorité</span><span class="info-value ${p.priority==='Haute'||p.priority==='Urgente'?'orange':''}">${p.priority}</span></div>
            </div>
            <div class="info-card">
                <div class="info-card-title">Progression du rapport</div>
                <div class="report-sections">
                    <div class="report-section"><span class="report-section-name">Identification</span><div class="report-section-bar"><div class="report-section-fill" style="width:${p.progress.identification}%"></div></div><span class="report-section-percent">${p.progress.identification}%</span></div>
                    <div class="report-section"><span class="report-section-name">Diagnostic</span><div class="report-section-bar"><div class="report-section-fill" style="width:${p.progress.diagnostic}%"></div></div><span class="report-section-percent">${p.progress.diagnostic}%</span></div>
                    <div class="report-section"><span class="report-section-name">Mesures</span><div class="report-section-bar"><div class="report-section-fill" style="width:${p.progress.mesures}%"></div></div><span class="report-section-percent">${p.progress.mesures}%</span></div>
                    <div class="report-section"><span class="report-section-name">Conclusion</span><div class="report-section-bar"><div class="report-section-fill" style="width:${p.progress.conclusion}%"></div></div><span class="report-section-percent">${p.progress.conclusion}%</span></div>
                </div>
            </div>
            <div class="info-card" style="background:rgba(80,150,255,0.05);border-color:rgba(80,150,255,0.15);">
                <div class="info-card-title" style="color:var(--accent-blue);">Aperçu du rapport</div>
                <div style="font-size:12px;color:var(--text-secondary);line-height:1.6;">
                    <strong>Équipement:</strong> ${p.equipment}<br>
                    <strong>Problème:</strong> Dysfonctionnement compresseur principal<br>
                    <strong>Diagnostic:</strong> Pression anormale détectée...
                </div>
            </div>
            <div class="chat-card">
                <div class="chat-card-header">
                    <div class="chat-card-avatar">${tech.initials}</div>
                    <div class="chat-card-info"><div class="chat-card-name">${tech.name}</div><div class="chat-card-status">${tech.status === 'live' ? 'En ligne' : tech.status === 'idle' ? 'Inactif' : 'Hors ligne'}</div></div>
                </div>
                <div class="chat-messages">${msgs}</div>
                <div class="chat-input-wrap">
                    <div class="chat-input-row">
                        <button class="chat-add-btn"><svg viewBox="0 0 16 16" fill="currentColor" width="14" height="14"><path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/></svg></button>
                        <input type="text" class="chat-input" placeholder="Message...">
                        <button class="chat-send"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 19V5M5 12l7-7 7 7"/></svg></button>
                    </div>
                </div>
            </div>`;
        }

        function buildTechDrawerContent(m) {
            const techProjects = m.projectIds ? projects.filter(p => m.projectIds.includes(p.id)) : [];
            const prjHtml = techProjects.length ? techProjects.map(p => `
                <div class="mini-project" onclick="openNestedProject('${p.id}')">
                    <div class="mini-project-bar ${p.team}"></div>
                    <div class="mini-project-info"><div class="mini-project-title">${p.name}</div><div class="mini-project-meta">${p.address.split(',')[0]}</div></div>
                    <span class="mini-project-progress">${p.progress.total}%</span>
                </div>
            `).join('') : '<div style="font-size:12px;color:var(--text-muted);text-align:center;padding:16px;">Aucun projet</div>';
            
            const msgs = m.messages && m.messages.length ? m.messages.map(msg => `<div class="msg ${msg.type === 'sent' ? 'user' : 'ai'}"><div class="msg-bubble">${msg.text}</div><div class="msg-time">${msg.time}</div></div>`).join('') : '<div style="text-align:center;color:var(--text-muted);padding:20px;font-size:12px;">Aucun message</div>';
            
            return `
            <div class="info-card">
                <div class="info-card-title">Informations</div>
                <div class="info-row"><span class="info-label">Statut</span><span class="info-value ${m.status==='live'?'green':m.status==='idle'?'orange':''}">${m.status==='live'?'En ligne':m.status==='idle'?'Inactif':'Hors ligne'}</span></div>
                <div class="info-row"><span class="info-label">Projet actuel</span><span class="info-value">${m.currentProject}</span></div>
                <div class="info-row"><span class="info-label">Client</span><span class="info-value">${m.client}</span></div>
            </div>
            <div class="info-card">
                <div class="info-card-title">Statistiques (semaine)</div>
                <div class="info-row"><span class="info-label">Projets</span><span class="info-value">${m.stats.projects}</span></div>
                <div class="info-row"><span class="info-label">Complétés</span><span class="info-value green">${m.stats.completed}</span></div>
                <div class="info-row"><span class="info-label">Temps moyen</span><span class="info-value">${m.stats.avgTime}</span></div>
                <div class="info-row"><span class="info-label">Taux succès</span><span class="info-value green">${m.stats.rate}</span></div>
            </div>
            <div class="info-card">
                <div class="info-card-title">Projets du technicien</div>
                ${prjHtml}
            </div>
            <div class="info-card">
                <div class="info-card-title">Disponibilité</div>
                <div class="avail-card">
                    <div class="avail-tabs">
                        <button class="avail-tab active">Jour</button>
                        <button class="avail-tab">Semaine</button>
                        <button class="avail-tab">Mois</button>
                    </div>
                    <div class="avail-daily">
                        <div class="avail-slot"><div class="avail-time">08:00</div><div class="avail-block available">Disponible</div></div>
                        <div class="avail-slot"><div class="avail-time">09:00</div><div class="avail-block busy">Intervention</div></div>
                        <div class="avail-slot"><div class="avail-time">10:00</div><div class="avail-block busy">Intervention</div></div>
                        <div class="avail-slot"><div class="avail-time">11:00</div><div class="avail-block available">Disponible</div></div>
                        <div class="avail-slot"><div class="avail-time">14:00</div><div class="avail-block busy">Intervention</div></div>
                        <div class="avail-slot"><div class="avail-time">15:00</div><div class="avail-block available">Disponible</div></div>
                        <div class="avail-slot"><div class="avail-time">16:00</div><div class="avail-block available">Disponible</div></div>
                    </div>
                </div>
            </div>
            <div class="chat-card">
                <div class="chat-card-header">
                    <div class="chat-card-avatar">${m.initials}</div>
                    <div class="chat-card-info"><div class="chat-card-name">${m.name}</div><div class="chat-card-status">${m.status==='live'?'En ligne':m.status==='idle'?'Inactif':'Hors ligne'}</div></div>
                </div>
                <div class="chat-messages">${msgs}</div>
                <div class="chat-input-wrap">
                    <div class="chat-input-row">
                        <button class="chat-add-btn"><svg viewBox="0 0 16 16" fill="currentColor" width="14" height="14"><path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/></svg></button>
                        <input type="text" class="chat-input" placeholder="Message...">
                        <button class="chat-send"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 19V5M5 12l7-7 7 7"/></svg></button>
                    </div>
                </div>
            </div>`;
        }

        function openProjectDetail(id) {
            const p = projects.find(x => x.id === id);
            if (!p) return;
            document.getElementById('dTitle').textContent = p.id;
            document.getElementById('dSubtitle').textContent = `${p.tech} • ${p.address.split(',')[0]}`;
            document.getElementById('dBadge').textContent = `Équipe ${p.team.charAt(0).toUpperCase() + p.team.slice(1)}`;
            document.getElementById('dBadge').className = 'drawer-badge ' + p.team;
            document.getElementById('dBadge').style.display = '';
            document.getElementById('projectDrawerBody').innerHTML = buildProjectDrawerContent(p);
            document.getElementById('projectDrawerFooter').innerHTML = '<button class="drawer-btn secondary">Historique</button><button class="drawer-btn primary"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>Valider</button>';
            document.getElementById('projectsPage').classList.add('drawer-open');
        }

        function openMapProjectDetail(id) {
            const p = projects.find(x => x.id === id);
            if (!p) return;
            
            // Hide notification and close tech drawer
            document.getElementById('notificationIcon').style.display = 'none';
            document.getElementById('techMapDrawer').classList.remove('visible');
            
            // Open drawer on MAP view
            document.getElementById('mapDTitle').textContent = p.id;
            document.getElementById('mapDSubtitle').textContent = `${p.tech} • ${p.address.split(',')[0]}`;
            document.getElementById('mapDBadge').textContent = p.team.charAt(0).toUpperCase() + p.team.slice(1);
            document.getElementById('mapDBadge').className = 'drawer-badge ' + p.team;
            document.getElementById('mapDrawerBody').innerHTML = buildProjectDrawerContent(p);
            document.getElementById('mapDrawer').classList.add('visible');
            // Hide toggle when drawer is open
            document.getElementById('viewToggle').style.display = 'none';
            // Center pin in LEFT HALF of screen
            if (map && p.coords) {
                const screenWidth = window.innerWidth;
                const offsetLng = (p.coords[0] - map.getCenter().lng) * 0.25;
                map.flyTo({
                    center: [p.coords[0] - offsetLng * 0.5, p.coords[1]], 
                    zoom: 14, 
                    duration: 1000,
                    offset: [-screenWidth * 0.25, 0]
                });
            }
            // Highlight marker
            Object.values(markers).forEach(m => m.getElement().classList.remove('active'));
            if (markers[p.id]) markers[p.id].getElement().classList.add('active');
        }

        function closeMapDrawer() {
            document.getElementById('mapDrawer').classList.remove('visible');
            document.getElementById('viewToggle').style.display = '';
            document.getElementById('notificationIcon').style.display = '';
            Object.values(markers).forEach(m => m.getElement().classList.remove('active'));
        }

        function openTechDetail(id) {
            closeNestedDrawer();
            const m = teamMembers.find(x => x.id === id);
            if (!m) return;
            document.getElementById('tName').textContent = m.name;
            document.getElementById('tRole').textContent = (m.role === 'manager' ? 'Manager' : 'Technicien') + ' • Équipe ' + m.team;
            document.getElementById('tBadge').textContent = m.status === 'live' ? 'En ligne' : m.status === 'idle' ? 'Inactif' : 'Hors ligne';
            document.getElementById('tBadge').className = 'drawer-badge ' + m.status;
            document.getElementById('techDrawerBody').innerHTML = buildTechDrawerContent(m);
            document.getElementById('teamsPage').classList.add('drawer-open');
        }

        function openNestedProject(id) {
            const p = projects.find(x => x.id === id);
            if (!p) return;
            document.getElementById('nestedTitle').textContent = p.id;
            document.getElementById('nestedSubtitle').textContent = `${p.tech} • ${p.address.split(',')[0]}`;
            document.getElementById('nestedBadge').textContent = `Équipe ${p.team.charAt(0).toUpperCase() + p.team.slice(1)}`;
            document.getElementById('nestedBadge').className = 'drawer-badge ' + p.team;
            document.getElementById('nestedProjectBody').innerHTML = buildProjectDrawerContent(p);
            document.getElementById('nestedProjectDrawer').style.transform = 'translateX(0)';
        }

        function closeNestedDrawer() {
            document.getElementById('nestedProjectDrawer').style.transform = 'translateX(100%)';
        }

        function closeDrawer() {
            document.getElementById('projectsPage').classList.remove('drawer-open');
            document.getElementById('teamsPage').classList.remove('drawer-open');
            closeNestedDrawer();
        }

        function openProfileDrawer() {
            document.getElementById('profileDrawer').style.transform = 'translateX(0)';
        }

        function closeProfileDrawer() {
            document.getElementById('profileDrawer').style.transform = 'translateX(100%)';
        }

        function openInviteDrawer() {
            document.getElementById('tName').textContent = 'Inviter un membre';
            document.getElementById('tRole').textContent = 'Nouveau technicien ou manager';
            document.getElementById('tBadge').style.display = 'none';
            document.getElementById('techDrawerBody').innerHTML = `
                <div class="invite-form">
                    <div class="form-row">
                        <div class="form-group"><label class="form-label">Prénom</label><input type="text" class="form-input" placeholder="Jean"></div>
                        <div class="form-group"><label class="form-label">Nom</label><input type="text" class="form-input" placeholder="Dupont"></div>
                    </div>
                    <div class="form-group"><label class="form-label">Email</label><input type="email" class="form-input" placeholder="jean.dupont@example.com"></div>
                    <div class="form-group"><label class="form-label">Téléphone</label><input type="tel" class="form-input" placeholder="+33 6 12 34 56 78"></div>
                    <div class="form-group"><label class="form-label">Rôle</label><select class="form-select"><option>Technicien</option><option>Manager</option></select></div>
                    <div class="form-group"><label class="form-label">Équipe</label><select class="form-select"><option>Équipe Nord</option><option>Équipe Sud</option><option>Direct</option></select></div>
                </div>
            `;
            document.getElementById('techDrawerFooter').innerHTML = '<button class="drawer-btn secondary" onclick="closeDrawer()">Annuler</button><button class="drawer-btn primary">Envoyer invitation</button>';
            document.getElementById('teamsPage').classList.add('drawer-open');
        }

        function openNewProject() {
            document.getElementById('dTitle').textContent = 'Nouveau Projet';
            document.getElementById('dSubtitle').textContent = 'Créer et assigner';
            document.getElementById('dBadge').style.display = 'none';
            
            // Build tech cards like in teams page
            const techCards = teamMembers.filter(t => t.role === 'tech').map(t => `
                <div class="tech-card tech-select-card" onclick="selectTechForProject(${t.id}, this)" style="padding:12px;">
                    <div class="tech-avatar" style="width:36px;height:36px;font-size:12px;">${t.initials}<div class="tech-status ${t.status}"></div></div>
                    <div class="tech-info"><div class="tech-name" style="font-size:13px;">${t.name}</div><div class="tech-project" style="font-size:11px;color:${t.status==='live'?'var(--accent-green)':t.status==='idle'?'var(--accent-orange)':'var(--text-muted)'};">${t.status==='live'?'Disponible':t.status==='idle'?'Inactif':'Hors ligne'}</div></div>
                </div>
            `).join('');
            
            document.getElementById('projectDrawerBody').innerHTML = `
                <div class="invite-form">
                    <div class="form-group">
                        <label class="form-label">NOM DU PROJET</label>
                        <input type="text" class="form-input" placeholder="Ex: Diagnostic VRF">
                    </div>
                    <div class="form-group">
                        <label class="form-label">CLIENT</label>
                        <input type="text" class="form-input" placeholder="Nom du client">
                    </div>
                    <div class="form-group">
                        <label class="form-label">ADRESSE</label>
                        <input type="text" class="form-input" placeholder="Adresse d'intervention">
                    </div>
                    <div class="form-group">
                        <label class="form-label">ÉQUIPEMENT</label>
                        <select class="form-select"><option>Sélectionner</option><option>Daikin VRV</option><option>Carrier 30XA</option><option>Mitsubishi MSZ</option><option>Trane RTAC</option></select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">DESCRIPTION</label>
                        <textarea class="form-input" rows="3" placeholder="Détails..."></textarea>
                    </div>
                </div>
                <div style="margin-top:20px;">
                    <div style="font-size:10px;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:12px;">ASSIGNER À</div>
                    <div class="card-list" style="margin-bottom:0;gap:8px;">
                        ${techCards}
                    </div>
                </div>
                <div id="techCalendarContainer" style="margin-top:20px;display:none;">
                    <div class="info-card" style="margin-bottom:0;border-color:rgba(80,150,255,0.2);background:rgba(80,150,255,0.05);">
                        <div class="info-card-title" style="color:var(--accent-blue);">DISPONIBILITÉ DE <span id="selectedTechName">-</span></div>
                        <div class="avail-card">
                            <div class="avail-tabs">
                                <button class="avail-tab active" onclick="setNewProjAvail('day', this)">Jour</button>
                                <button class="avail-tab" onclick="setNewProjAvail('week', this)">Semaine</button>
                                <button class="avail-tab" onclick="setNewProjAvail('month', this)">Mois</button>
                            </div>
                            <div class="avail-daily" id="newProjAvailSlots">
                                <div class="avail-slot"><div class="avail-time">08:00</div><div class="avail-block available" onclick="selectTimeSlot(this)">Disponible</div></div>
                                <div class="avail-slot"><div class="avail-time">09:00</div><div class="avail-block busy">Intervention</div></div>
                                <div class="avail-slot"><div class="avail-time">10:00</div><div class="avail-block busy">Intervention</div></div>
                                <div class="avail-slot"><div class="avail-time">11:00</div><div class="avail-block available" onclick="selectTimeSlot(this)">Disponible</div></div>
                                <div class="avail-slot"><div class="avail-time">12:00</div><div class="avail-block available" onclick="selectTimeSlot(this)">Disponible</div></div>
                                <div class="avail-slot"><div class="avail-time">13:00</div><div class="avail-block available" onclick="selectTimeSlot(this)">Disponible</div></div>
                                <div class="avail-slot"><div class="avail-time">14:00</div><div class="avail-block busy">Intervention</div></div>
                                <div class="avail-slot"><div class="avail-time">15:00</div><div class="avail-block available" onclick="selectTimeSlot(this)">Disponible</div></div>
                                <div class="avail-slot"><div class="avail-time">16:00</div><div class="avail-block available" onclick="selectTimeSlot(this)">Disponible</div></div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('projectDrawerFooter').innerHTML = '<button class="drawer-btn secondary" onclick="closeDrawer()">Annuler</button><button class="drawer-btn primary">Créer</button>';
            document.getElementById('projectsPage').classList.add('drawer-open');
        }

        function selectTechForProject(techId, el) {
            // Highlight selected tech card
            document.querySelectorAll('.tech-select-card').forEach(c => {
                c.style.background = '';
                c.style.borderColor = 'var(--border-subtle)';
            });
            el.style.background = 'rgba(80,150,255,0.1)';
            el.style.borderColor = 'rgba(80,150,255,0.3)';
            
            // Show calendar section
            const tech = teamMembers.find(t => t.id === techId);
            if (tech) {
                document.getElementById('selectedTechName').textContent = tech.name.toUpperCase();
                document.getElementById('techCalendarContainer').style.display = 'block';
                // Scroll to calendar
                document.getElementById('techCalendarContainer').scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }

        function setNewProjAvail(view, btn) {
            document.querySelectorAll('#techCalendarContainer .avail-tab').forEach(t => t.classList.remove('active'));
            btn.classList.add('active');
            // Could switch view content here
        }

        function selectTimeSlot(el) {
            document.querySelectorAll('.avail-block.selected').forEach(b => {
                b.classList.remove('selected');
                b.style.background = '';
                b.style.border = '';
            });
            el.classList.add('selected');
            el.style.background = 'rgba(80,150,255,0.25)';
            el.style.border = '1px solid var(--accent-blue)';
        }

        // Filter functions
        function filterProjects(query) {
            const cards = document.querySelectorAll('#projectCardList .proj');
            query = query.toLowerCase();
            cards.forEach(c => {
                const text = c.textContent.toLowerCase();
                c.style.display = text.includes(query) ? '' : 'none';
            });
        }

        function filterTeams(query) {
            const cards = document.querySelectorAll('#managersCardList .tech-card, #techsCardList .tech-card');
            query = query.toLowerCase();
            cards.forEach(c => {
                const text = c.textContent.toLowerCase();
                c.style.display = text.includes(query) ? '' : 'none';
            });
        }

        function setProjectFilter(filter, btn) {
            document.querySelectorAll('#projectsPage .filter-tab').forEach(t => t.classList.remove('active'));
            btn.classList.add('active');
            const cards = document.querySelectorAll('#projectCardList .proj');
            cards.forEach(c => {
                if (filter === 'all') {
                    c.style.display = '';
                } else {
                    const hasTeam = c.querySelector('.proj-status-bar.' + filter) || c.querySelector('.proj-icon.' + filter);
                    c.style.display = hasTeam ? '' : 'none';
                }
            });
        }

        function setTeamFilter(filter, btn) {
            document.querySelectorAll('#teamsPage .filter-tab').forEach(t => t.classList.remove('active'));
            btn.classList.add('active');
            const managersSection = document.getElementById('managersSection');
            const managersList = document.getElementById('managersCardList');
            const techsSection = document.getElementById('techsSection');
            const techsList = document.getElementById('techsCardList');
            
            if (filter === 'all') {
                managersSection.style.display = '';
                managersList.style.display = '';
                techsSection.style.display = '';
                techsList.style.display = '';
            } else if (filter === 'manager') {
                managersSection.style.display = '';
                managersList.style.display = '';
                techsSection.style.display = 'none';
                techsList.style.display = 'none';
            } else {
                managersSection.style.display = 'none';
                managersList.style.display = 'none';
                techsSection.style.display = '';
                techsList.style.display = '';
            }
        }
        function showCalendar() { alert('Calendrier'); }

        // V7 UI initialization function (called after login)
        function initV7UI() {
            // Small delay to ensure DOM is ready
            setTimeout(() => {
                if (typeof mapboxgl !== 'undefined') {
                    initMap();
                }
                renderMapProjectsList();
                renderTechListDropdown();
                initDockTooltips();
            }, 100);
        }

        // Page load - initialize security layer
        document.addEventListener('DOMContentLoaded', () => {
            initLanguage();
            initSupabase();
            initAuth();
        });
    </script>
</body>
</html>
