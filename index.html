<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FixAIR Auth Test</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            background: #0a0a0a; 
            color: #fff;
            min-height: 100vh;
            padding: 20px;
        }
        .container { max-width: 500px; margin: 0 auto; }
        h1 { color: #10b981; margin-bottom: 20px; }
        h2 { color: #888; font-size: 14px; margin: 20px 0 10px; text-transform: uppercase; }
        
        .card {
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .form-group { margin-bottom: 15px; }
        label { display: block; color: #888; font-size: 12px; margin-bottom: 5px; }
        input {
            width: 100%;
            padding: 12px;
            background: #0a0a0a;
            border: 1px solid #333;
            border-radius: 8px;
            color: #fff;
            font-size: 16px;
        }
        input:focus { outline: none; border-color: #10b981; }
        
        button {
            width: 100%;
            padding: 12px 20px;
            background: #10b981;
            color: #000;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 10px;
        }
        button:hover { background: #0d9668; }
        button:disabled { background: #333; color: #666; cursor: not-allowed; }
        button.secondary { background: #333; color: #fff; }
        button.danger { background: #ef4444; }
        
        .status {
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            font-size: 14px;
        }
        .status.success { background: #10b98133; border: 1px solid #10b981; }
        .status.error { background: #ef444433; border: 1px solid #ef4444; }
        .status.info { background: #3b82f633; border: 1px solid #3b82f6; }
        
        .log {
            background: #000;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 15px;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-break: break-all;
        }
        .log .time { color: #666; }
        .log .success { color: #10b981; }
        .log .error { color: #ef4444; }
        .log .info { color: #3b82f6; }
        
        .hidden { display: none; }
        
        .user-info {
            background: #10b98122;
            border: 1px solid #10b981;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }
        .user-info p { margin: 5px 0; font-size: 14px; }
        .user-info strong { color: #10b981; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”§ FixAIR Auth Test</h1>
        
        <!-- Current State -->
        <div class="card">
            <h2>Ã‰tat actuel</h2>
            <div id="currentState">
                <p>Chargement...</p>
            </div>
        </div>
        
        <!-- User Info (when logged in) -->
        <div class="card hidden" id="userInfoCard">
            <h2>Utilisateur connectÃ©</h2>
            <div class="user-info">
                <p><strong>Email:</strong> <span id="userEmail">-</span></p>
                <p><strong>Auth ID:</strong> <span id="userAuthId">-</span></p>
                <p><strong>Email confirmÃ©:</strong> <span id="userEmailConfirmed">-</span></p>
                <p><strong>Profile Status:</strong> <span id="userProfileStatus">-</span></p>
            </div>
            <button class="danger" onclick="logout()">Se dÃ©connecter</button>
        </div>
        
        <!-- Auth Forms (when not logged in) -->
        <div id="authForms">
            <!-- Signup -->
            <div class="card">
                <h2>1. CrÃ©er un compte</h2>
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="signupEmail" placeholder="nouveau@email.com">
                </div>
                <div class="form-group">
                    <label>Mot de passe</label>
                    <input type="password" id="signupPassword" placeholder="Min 6 caractÃ¨res">
                </div>
                <div class="form-group">
                    <label>PrÃ©nom</label>
                    <input type="text" id="signupName" placeholder="Votre prÃ©nom">
                </div>
                <button onclick="signup()">CrÃ©er le compte</button>
                <div id="signupStatus"></div>
            </div>
            
            <!-- Login -->
            <div class="card">
                <h2>2. Se connecter</h2>
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="loginEmail" placeholder="votre@email.com">
                </div>
                <div class="form-group">
                    <label>Mot de passe</label>
                    <input type="password" id="loginPassword" placeholder="Votre mot de passe">
                </div>
                <button onclick="login()">Se connecter</button>
                <div id="loginStatus"></div>
            </div>
            
            <!-- Password Reset -->
            <div class="card">
                <h2>3. RÃ©initialiser mot de passe</h2>
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="resetEmail" placeholder="votre@email.com">
                </div>
                <button class="secondary" onclick="resetPassword()">Envoyer le lien</button>
                <div id="resetStatus"></div>
            </div>
        </div>
        
        <!-- Admin Actions -->
        <div class="card">
            <h2>ğŸ”§ Actions Admin</h2>
            <div class="form-group">
                <label>Email Ã  approuver</label>
                <input type="email" id="approveEmail" placeholder="user@email.com">
            </div>
            <button class="secondary" onclick="approveUser()">Approuver l'utilisateur</button>
            <div id="approveStatus"></div>
        </div>
        
        <!-- Debug Log -->
        <div class="card">
            <h2>ğŸ“‹ Log de dÃ©bogage</h2>
            <div class="log" id="debugLog"></div>
            <button class="secondary" onclick="clearLog()" style="margin-top: 10px;">Effacer le log</button>
        </div>
    </div>

    <script>
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // CONFIGURATION
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        const SUPABASE_URL = 'https://fwuhzraxqrvmpqxnzpqm.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZ3dWh6cmF4cXJ2bXBxeG56cHFtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYyNTcyMTksImV4cCI6MjA4MTgzMzIxOX0.8ryQm1tsdx5ox3aFJiiflmwuEGGxxH_PlobGxXMgFuQ';
        
        // Initialize Supabase client (use 'db' to avoid conflict with window.supabase)
        const db = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // LOGGING
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function log(message, type = 'info') {
            const logEl = document.getElementById('debugLog');
            const time = new Date().toLocaleTimeString();
            const colorClass = type === 'error' ? 'error' : type === 'success' ? 'success' : 'info';
            logEl.innerHTML += `<span class="time">[${time}]</span> <span class="${colorClass}">${message}</span>\n`;
            logEl.scrollTop = logEl.scrollHeight;
            console.log(`[${type.toUpperCase()}]`, message);
        }
        
        function clearLog() {
            document.getElementById('debugLog').innerHTML = '';
        }
        
        function showStatus(elementId, message, type) {
            const el = document.getElementById(elementId);
            el.className = 'status ' + type;
            el.textContent = message;
        }
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // CHECK CURRENT STATE
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        async function checkCurrentState() {
            log('Checking current auth state...');
            
            // Check URL for email confirmation
            const hash = window.location.hash;
            if (hash.includes('access_token') || hash.includes('type=')) {
                log('ğŸ“§ Email confirmation/recovery token detected in URL', 'info');
                // Clear the hash after processing
                setTimeout(() => {
                    window.history.replaceState(null, '', window.location.pathname);
                }, 1000);
            }
            
            try {
                const { data: { session }, error } = await db.auth.getSession();
                
                if (error) {
                    log('Session error: ' + error.message, 'error');
                    updateStateDisplay(null);
                    return;
                }
                
                if (session && session.user) {
                    log('âœ… Session found: ' + session.user.email, 'success');
                    log('Auth ID: ' + session.user.id);
                    log('Email confirmed: ' + (session.user.email_confirmed_at ? 'Yes' : 'No'));
                    
                    // Check public.users
                    await checkPublicUser(session.user);
                    updateStateDisplay(session.user);
                } else {
                    log('No active session', 'info');
                    updateStateDisplay(null);
                }
            } catch (err) {
                log('Exception: ' + err.message, 'error');
                updateStateDisplay(null);
            }
        }
        
        async function checkPublicUser(authUser) {
            log('Checking public.users for ID: ' + authUser.id);
            
            try {
                // Use maybeSingle() instead of single() to avoid 406 error
                const { data, error } = await db
                    .from('users')
                    .select('*')
                    .eq('id', authUser.id)
                    .maybeSingle();
                
                if (error) {
                    log('public.users query error: ' + error.message, 'error');
                    document.getElementById('userProfileStatus').textContent = 'Error: ' + error.message;
                    return null;
                }
                
                if (data) {
                    log('âœ… Found in public.users - Status: ' + data.status, 'success');
                    document.getElementById('userProfileStatus').textContent = data.status + ' âœ“';
                    return data;
                } else {
                    log('âš ï¸ NOT found in public.users! Creating...', 'error');
                    document.getElementById('userProfileStatus').textContent = 'Creating...';
                    
                    // Try to create the user
                    const { error: insertError } = await db
                        .from('users')
                        .insert({
                            id: authUser.id,
                            email: authUser.email,
                            first_name: authUser.user_metadata?.first_name || '',
                            status: 'pending',
                            created_at: new Date().toISOString()
                        });
                    
                    if (insertError) {
                        log('Failed to create: ' + insertError.message, 'error');
                        document.getElementById('userProfileStatus').textContent = 'Error creating: ' + insertError.message;
                    } else {
                        log('âœ… Created public.users record!', 'success');
                        document.getElementById('userProfileStatus').textContent = 'pending (just created)';
                    }
                    return null;
                }
            } catch (err) {
                log('Exception checking public.users: ' + err.message, 'error');
                return null;
            }
        }
        
        function updateStateDisplay(user) {
            const stateEl = document.getElementById('currentState');
            const userInfoCard = document.getElementById('userInfoCard');
            const authForms = document.getElementById('authForms');
            
            if (user) {
                stateEl.innerHTML = '<p style="color: #10b981;">âœ… ConnectÃ©</p>';
                userInfoCard.classList.remove('hidden');
                authForms.classList.add('hidden');
                
                document.getElementById('userEmail').textContent = user.email;
                document.getElementById('userAuthId').textContent = user.id;
                document.getElementById('userEmailConfirmed').textContent = 
                    user.email_confirmed_at ? 'âœ… Oui' : 'âŒ Non';
            } else {
                stateEl.innerHTML = '<p style="color: #888;">Pas connectÃ©</p>';
                userInfoCard.classList.add('hidden');
                authForms.classList.remove('hidden');
            }
        }
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // SIGNUP
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        async function signup() {
            const email = document.getElementById('signupEmail').value.trim();
            const password = document.getElementById('signupPassword').value;
            const name = document.getElementById('signupName').value.trim();
            
            if (!email || !password) {
                showStatus('signupStatus', 'Email et mot de passe requis', 'error');
                return;
            }
            
            log('ğŸ“ Signing up: ' + email);
            
            try {
                const { data, error } = await db.auth.signUp({
                    email: email,
                    password: password,
                    options: {
                        data: { first_name: name },
                        emailRedirectTo: window.location.href.split('#')[0]
                    }
                });
                
                if (error) {
                    log('Signup error: ' + error.message, 'error');
                    showStatus('signupStatus', error.message, 'error');
                    return;
                }
                
                log('âœ… Signup successful!', 'success');
                log('User ID: ' + data.user?.id);
                log('Email confirmation required: ' + (!data.user?.email_confirmed_at));
                
                if (data.user && !data.user.email_confirmed_at) {
                    showStatus('signupStatus', 'âœ… Compte crÃ©Ã©! VÃ©rifiez votre email pour confirmer.', 'success');
                } else {
                    showStatus('signupStatus', 'âœ… Compte crÃ©Ã© et confirmÃ©!', 'success');
                }
                
                // Refresh state
                setTimeout(checkCurrentState, 1000);
                
            } catch (err) {
                log('Signup exception: ' + err.message, 'error');
                showStatus('signupStatus', err.message, 'error');
            }
        }
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // LOGIN
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        async function login() {
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value;
            
            if (!email || !password) {
                showStatus('loginStatus', 'Email et mot de passe requis', 'error');
                return;
            }
            
            log('ğŸ” Logging in: ' + email);
            
            try {
                const { data, error } = await db.auth.signInWithPassword({
                    email: email,
                    password: password
                });
                
                if (error) {
                    log('Login error: ' + error.message, 'error');
                    showStatus('loginStatus', error.message, 'error');
                    return;
                }
                
                log('âœ… Login successful!', 'success');
                showStatus('loginStatus', 'âœ… ConnectÃ©!', 'success');
                
                // Refresh state
                checkCurrentState();
                
            } catch (err) {
                log('Login exception: ' + err.message, 'error');
                showStatus('loginStatus', err.message, 'error');
            }
        }
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // LOGOUT
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        async function logout() {
            log('ğŸ‘‹ Logging out...');
            
            try {
                const { error } = await db.auth.signOut();
                
                if (error) {
                    log('Logout error: ' + error.message, 'error');
                    return;
                }
                
                log('âœ… Logged out', 'success');
                checkCurrentState();
                
            } catch (err) {
                log('Logout exception: ' + err.message, 'error');
            }
        }
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // PASSWORD RESET
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        async function resetPassword() {
            const email = document.getElementById('resetEmail').value.trim();
            
            if (!email) {
                showStatus('resetStatus', 'Email requis', 'error');
                return;
            }
            
            log('ğŸ“§ Sending password reset to: ' + email);
            
            try {
                const { error } = await db.auth.resetPasswordForEmail(email, {
                    redirectTo: window.location.href.split('#')[0]
                });
                
                if (error) {
                    log('Reset error: ' + error.message, 'error');
                    showStatus('resetStatus', error.message, 'error');
                    return;
                }
                
                log('âœ… Reset email sent!', 'success');
                showStatus('resetStatus', 'âœ… Email envoyÃ©! VÃ©rifiez votre boÃ®te mail.', 'success');
                
            } catch (err) {
                log('Reset exception: ' + err.message, 'error');
                showStatus('resetStatus', err.message, 'error');
            }
        }
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // APPROVE USER (Admin)
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        async function approveUser() {
            const email = document.getElementById('approveEmail').value.trim();
            
            if (!email) {
                showStatus('approveStatus', 'Email requis', 'error');
                return;
            }
            
            log('âœ… Approving user: ' + email);
            
            try {
                const { data, error } = await db
                    .from('users')
                    .update({ status: 'approved' })
                    .eq('email', email)
                    .select();
                
                if (error) {
                    log('Approve error: ' + error.message, 'error');
                    showStatus('approveStatus', error.message, 'error');
                    return;
                }
                
                if (data && data.length > 0) {
                    log('âœ… User approved!', 'success');
                    showStatus('approveStatus', 'âœ… Utilisateur approuvÃ©!', 'success');
                } else {
                    log('âš ï¸ User not found in public.users', 'error');
                    showStatus('approveStatus', 'Utilisateur non trouvÃ©', 'error');
                }
                
            } catch (err) {
                log('Approve exception: ' + err.message, 'error');
                showStatus('approveStatus', err.message, 'error');
            }
        }
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // AUTH STATE LISTENER
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        db.auth.onAuthStateChange((event, session) => {
            log('ğŸ”” Auth state changed: ' + event, event === 'SIGNED_IN' ? 'success' : 'info');
            
            if (event === 'SIGNED_IN' && session) {
                log('User signed in: ' + session.user.email);
                checkCurrentState();
            } else if (event === 'SIGNED_OUT') {
                log('User signed out');
                checkCurrentState();
            } else if (event === 'USER_UPDATED') {
                log('User updated');
                checkCurrentState();
            }
        });
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // INITIALIZE
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        log('ğŸš€ FixAIR Auth Test initialized');
        log('URL: ' + window.location.href);
        
        // Check state on load
        checkCurrentState();
    </script>
</body>
</html>
