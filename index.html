<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>FixAIR V48 - Photo Capture + OCR</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --copilot: #FF6B35;
            --copilot-glow: rgba(255, 107, 53, 0.4);
            --copilot-bg: rgba(255, 107, 53, 0.08);
            --copilot-border: rgba(255, 107, 53, 0.2);
            --assistant: #22c55e;
            --assistant-glow: rgba(34, 197, 94, 0.4);
            --assistant-bg: rgba(34, 197, 94, 0.08);
            --assistant-border: rgba(34, 197, 94, 0.2);
            --hotline: #ef4444;
            --hotline-glow: rgba(239, 68, 68, 0.4);
            --bg: #0D1117;
            --bg-secondary: #161b22;
            --card: rgba(255, 255, 255, 0.03);
            --border: rgba(255, 255, 255, 0.06);
            --text: rgba(255, 255, 255, 0.9);
            --text-dim: rgba(255, 255, 255, 0.35);
            --content-width: 520px;
            --app-height: 100%;
            --grid-color: rgba(255,255,255,0.015);
            --input-bg: rgba(255,255,255,0.03);
            --msg-user-bg: rgba(255,255,255,0.06);
            --msg-ai-bg: transparent;
            --shadow-color: rgba(0,0,0,0.3);
            --scrollbar-thumb: rgba(255, 255, 255, 0.15);
            --scrollbar-thumb-hover: rgba(255, 255, 255, 0.25);
            --scrollbar-track: transparent;
        }
        
        /* LIGHT THEME */
        [data-theme="light"] {
            --bg: #F8FAFC;
            --bg-secondary: #FFFFFF;
            --card: #FFFFFF;
            --border: rgba(0, 0, 0, 0.08);
            --text: #1E293B;
            --text-dim: #64748B;
            --grid-color: rgba(0,0,0,0.03);
            --input-bg: #FFFFFF;
            --msg-user-bg: rgba(0,0,0,0.04);
            --msg-ai-bg: transparent;
            --shadow-color: rgba(0,0,0,0.08);
            --copilot-bg: rgba(255, 107, 53, 0.1);
            --copilot-border: rgba(255, 107, 53, 0.25);
            --assistant-bg: rgba(34, 197, 94, 0.1);
            --assistant-border: rgba(34, 197, 94, 0.25);
            --assistant: #16a34a;
            --hotline: #dc2626;
            --scrollbar-thumb: rgba(0, 0, 0, 0.15);
            --scrollbar-thumb-hover: rgba(0, 0, 0, 0.25);
            --scrollbar-track: transparent;
        }
        
        /* ==================== SCROLLBAR STYLING ==================== */
        /* Firefox scrollbar */
        * {
            scrollbar-width: thin;
            scrollbar-color: var(--scrollbar-thumb) var(--scrollbar-track);
        }
        
        /* Webkit scrollbar (Chrome, Safari, Edge) */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        ::-webkit-scrollbar-track {
            background: var(--scrollbar-track);
        }
        ::-webkit-scrollbar-thumb {
            background: var(--scrollbar-thumb);
            border-radius: 3px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: var(--scrollbar-thumb-hover);
        }
        ::-webkit-scrollbar-corner {
            background: transparent;
        }
        
        /* Hide scrollbar for specific elements while keeping scroll functionality */
        .brand-select-row::-webkit-scrollbar,
        .brand-dropdown::-webkit-scrollbar {
            display: none;
        }
        .brand-select-row,
        .brand-dropdown {
            scrollbar-width: none;
            -ms-overflow-style: none;
        }
        
        /* ==================== LIGHT THEME COMPONENT OVERRIDES ==================== */
        [data-theme="light"] .nav {
            background: rgba(255,255,255,0.98) !important;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.08);
        }
        [data-theme="light"] .app-header {
            background: linear-gradient(180deg, rgba(248,250,252,0.98), rgba(248,250,252,0.8), transparent) !important;
        }
        [data-theme="light"] .login-bar,
        [data-theme="light"] .brand-pill,
        [data-theme="light"] .proj,
        [data-theme="light"] .form-input,
        [data-theme="light"] .brand-select-row {
            box-shadow: 0 1px 3px rgba(0,0,0,0.04);
        }
        [data-theme="light"] .proj:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }
        [data-theme="light"] .brand-dropdown {
            background: rgba(255,255,255,0.98);
            box-shadow: 0 8px 24px rgba(0,0,0,0.15);
        }
        [data-theme="light"] .panel-brand-dropdown {
            background: rgba(255,255,255,0.98);
            border-color: rgba(0,0,0,0.1);
            box-shadow: 0 8px 24px rgba(0,0,0,0.15);
        }
        [data-theme="light"] .panel-brand-option {
            color: rgba(0,0,0,0.6);
        }
        [data-theme="light"] .panel-brand-option:hover {
            background: rgba(0,0,0,0.04);
            color: #000;
        }
        [data-theme="light"] .panel-brand-btn .panel-brand-text {
            color: rgba(0,0,0,0.5);
        }
        [data-theme="light"] .panel-brand-btn:hover .panel-brand-text {
            color: #000;
        }
        [data-theme="light"] .panel-brand-btn .brand-arrow {
            color: rgba(0,0,0,0.4);
        }
        [data-theme="light"] .panel-brand-btn:hover .brand-arrow {
            color: #000;
        }
        [data-theme="light"] .brand-chip:hover,
        [data-theme="light"] .brand-dropdown-item:hover {
            background: rgba(0,0,0,0.04);
        }
        [data-theme="light"] .login-input::placeholder,
        [data-theme="light"] .input-text::placeholder,
        [data-theme="light"] .form-input::placeholder {
            color: #94A3B8;
        }
        [data-theme="light"] .panel-header,
        [data-theme="light"] .profile-header {
            background: rgba(255,255,255,0.95) !important;
        }
        [data-theme="light"] .input-row {
            background: var(--card);
            border-color: rgba(0,0,0,0.08);
        }
        [data-theme="light"] .input-row:focus-within {
            border-color: var(--copilot);
            box-shadow: 0 0 0 3px rgba(255,107,53,0.1);
        }
        [data-theme="light"] .report-sheet {
            background: rgba(255,255,255,0.98) !important;
        }
        [data-theme="light"] .photo-modal-content {
            background: rgba(255,255,255,0.98);
        }
        [data-theme="light"] .attach-menu {
            background: rgba(255,255,255,0.98);
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        }
        [data-theme="light"] .attach-opt:hover {
            background: rgba(0,0,0,0.04);
        }
        [data-theme="light"] .toast {
            background: rgba(255,255,255,0.98);
        }
        [data-theme="light"] .toggle-chat {
            background: rgba(255,255,255,0.95);
            border-color: rgba(0,0,0,0.08);
        }
        [data-theme="light"] .toggle-chat:hover {
            background: rgba(255,255,255,0.98);
        }
        [data-theme="light"] .h-btn {
            background: var(--card);
            border-color: rgba(0,0,0,0.08);
        }
        [data-theme="light"] .h-btn:hover {
            background: rgba(0,0,0,0.04);
        }
        [data-theme="light"] .msg-act:hover {
            background: rgba(0,0,0,0.04);
        }
        [data-theme="light"] .divider:hover,
        [data-theme="light"] .divider.dragging {
            background: rgba(0,0,0,0.12);
        }
        [data-theme="light"] .ring-bg {
            stroke: rgba(0,0,0,0.06);
        }
        [data-theme="light"] .panel-back:hover,
        [data-theme="light"] .profile-back:hover {
            background: rgba(0,0,0,0.06);
        }
        [data-theme="light"] .hotline-close {
            background: var(--card);
            border-color: var(--border);
        }
        [data-theme="light"] .hotline-close:hover {
            background: rgba(0,0,0,0.04);
        }
        [data-theme="light"] .onboarding-step {
            background: rgba(255,255,255,0.98);
        }
        [data-theme="light"] .onboarding-step:hover {
            background: rgba(0,0,0,0.02);
        }
        [data-theme="light"] .step-check.pending {
            background: rgba(0,0,0,0.03);
            border-color: rgba(0,0,0,0.12);
        }
        [data-theme="light"] .brand-select-option {
            background: rgba(0,0,0,0.02);
            border-color: rgba(0,0,0,0.06);
        }
        [data-theme="light"] .brand-select-option:hover {
            background: rgba(0,0,0,0.04);
        }
        [data-theme="light"] .congrats-close {
            background: rgba(0,0,0,0.03);
            border-color: rgba(0,0,0,0.08);
        }
        [data-theme="light"] .congrats-close:hover {
            background: rgba(0,0,0,0.06);
        }
        [data-theme="light"] .photo-option {
            background: rgba(0,0,0,0.02);
            border-color: rgba(0,0,0,0.06);
        }
        [data-theme="light"] .photo-option:hover {
            background: rgba(0,0,0,0.04);
        }
        [data-theme="light"] .login-back {
            background: rgba(0,0,0,0.04);
        }
        [data-theme="light"] .login-back:hover {
            background: rgba(0,0,0,0.08);
        }
        [data-theme="light"] .sphere-fog-container {
            background: rgba(255,255,255,0.3);
        }
        [data-theme="light"] .form-input:focus {
            border-color: var(--copilot);
            box-shadow: 0 0 0 3px rgba(255,107,53,0.1);
        }
        [data-theme="light"] .login-bar {
            background: var(--card);
        }
        [data-theme="light"] .login-input:-webkit-autofill,
        [data-theme="light"] .login-input:-webkit-autofill:hover,
        [data-theme="light"] .login-input:-webkit-autofill:focus,
        [data-theme="light"] .login-input:-webkit-autofill:active {
            -webkit-box-shadow: 0 0 0 1000px var(--card) inset !important;
            -webkit-text-fill-color: var(--text) !important;
        }
        
        /* ==================== LIGHT THEME - NAVIGATION & ICONS ==================== */
        [data-theme="light"] .nav-item {
            color: #64748B;
        }
        [data-theme="light"] .nav-item:hover {
            color: #1E293B;
        }
        [data-theme="light"] .nav-item.active {
            color: var(--copilot);
        }
        
        /* ==================== LIGHT THEME - BACK BUTTONS & ARROWS ==================== */
        [data-theme="light"] .panel-back,
        [data-theme="light"] .profile-back,
        [data-theme="light"] .hotline-back,
        [data-theme="light"] .report-close {
            color: #64748B;
            background: rgba(0,0,0,0.04);
            border-color: rgba(0,0,0,0.08);
        }
        [data-theme="light"] .panel-back .icon,
        [data-theme="light"] .profile-back .icon,
        [data-theme="light"] .hotline-back .icon,
        [data-theme="light"] .report-close .icon {
            color: #64748B;
        }
        [data-theme="light"] .panel-back:hover .icon,
        [data-theme="light"] .profile-back:hover .icon {
            color: #1E293B;
        }
        
        /* ==================== LIGHT THEME - BRAND CHIPS & DROPDOWN ==================== */
        [data-theme="light"] .brand-chip {
            color: #64748B;
            border-color: rgba(0,0,0,0.12);
        }
        [data-theme="light"] .brand-chip.active {
            color: var(--copilot);
        }
        [data-theme="light"] .brand-pill-text {
            color: #1E293B;
        }
        [data-theme="light"] .brand-dropdown-name {
            color: #1E293B;
        }
        [data-theme="light"] .brand-dropdown-item.disabled .brand-dropdown-name {
            color: #78909C;
        }
        
        /* ==================== LIGHT THEME - TOGGLE CARDS (Copilot/Assistant) ==================== */
        [data-theme="light"] .toggle-card {
            background: #FFFFFF !important;
            border: 1px solid rgba(0,0,0,0.1);
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        }
        [data-theme="light"] .toggle-card:hover {
            background: #F1F5F9 !important;
            border-color: rgba(0,0,0,0.15);
            box-shadow: 0 4px 16px rgba(0,0,0,0.1);
        }
        [data-theme="light"] .toggle-card:active {
            background: #E2E8F0 !important;
        }
        [data-theme="light"] .toggle-card-title {
            color: #1E293B !important;
        }
        [data-theme="light"] .toggle-card:hover .toggle-card-title,
        [data-theme="light"] .toggle-card:active .toggle-card-title {
            color: #1E293B !important;
        }
        [data-theme="light"] .toggle-card-desc {
            color: #64748B;
        }
        [data-theme="light"] .toggle-card-arrow {
            color: #94A3B8;
        }
        [data-theme="light"] .toggle-card:hover .toggle-card-arrow {
            color: #64748B;
        }
        /* Icon backgrounds matching proj-icon style */
        [data-theme="light"] .toggle-card.copilot .toggle-card-icon {
            background: var(--copilot-bg);
            color: var(--copilot);
        }
        [data-theme="light"] .toggle-card.assistant .toggle-card-icon {
            background: var(--assistant-bg);
            color: var(--assistant);
        }
        
        /* ==================== LIGHT THEME - MODE TOGGLE ==================== */
        [data-theme="light"] .mode-btn {
            color: #64748B;
            background: rgba(0,0,0,0.04);
        }
        [data-theme="light"] .mode-btn .mode-icon {
            color: #94A3B8;
        }
        [data-theme="light"] .mode-btn.copilot.active {
            background: var(--copilot-bg);
            color: var(--copilot);
        }
        [data-theme="light"] .mode-btn.copilot.active .mode-icon {
            color: var(--copilot);
        }
        [data-theme="light"] .mode-btn.assistant.active {
            background: var(--assistant-bg);
            color: var(--assistant);
        }
        [data-theme="light"] .mode-btn.assistant.active .mode-icon {
            color: var(--assistant);
        }
        
        /* ==================== LIGHT THEME - PLUS BUTTON & ACTIONS ==================== */
        [data-theme="light"] .plus-btn {
            color: #64748B;
            background: #F8FAFC;
            border-color: rgba(0,0,0,0.1);
        }
        [data-theme="light"] .panel.copilot .plus-btn .icon {
            color: var(--copilot);
        }
        [data-theme="light"] .panel.assistant .plus-btn .icon {
            color: var(--assistant);
        }
        [data-theme="light"] .plus-btn:hover {
            background: #F1F5F9;
        }
        
        /* ==================== LIGHT THEME - MESSAGE ACTIONS (Copy, etc) ==================== */
        [data-theme="light"] .msg-act {
            color: rgba(0,0,0,0.25);
            background: transparent;
        }
        [data-theme="light"] .msg-act .icon {
            color: rgba(0,0,0,0.25);
        }
        [data-theme="light"] .msg-act:hover {
            color: rgba(0,0,0,0.6);
            background: rgba(0,0,0,0.05);
        }
        [data-theme="light"] .msg-act:hover .icon {
            color: rgba(0,0,0,0.6);
        }
        
        /* ==================== LIGHT THEME - HEADER BUTTONS ==================== */
        [data-theme="light"] .h-btn {
            color: #64748B;
            background: rgba(0,0,0,0.02);
            border-color: rgba(0,0,0,0.08);
        }
        [data-theme="light"] .h-btn .icon {
            color: #64748B;
        }
        [data-theme="light"] .h-btn:hover {
            color: #1E293B;
            background: rgba(0,0,0,0.05);
        }
        [data-theme="light"] .h-btn:hover .icon {
            color: #1E293B;
        }
        
        /* ==================== LIGHT THEME - REPORT SHEET ==================== */
        [data-theme="light"] .report-close {
            color: #64748B;
        }
        [data-theme="light"] .report-close .icon {
            color: #64748B;
        }
        [data-theme="light"] .r-btn.secondary {
            color: #64748B;
            background: rgba(0,0,0,0.02);
            border-color: rgba(0,0,0,0.08);
        }
        [data-theme="light"] .r-btn.secondary .icon {
            color: #64748B;
        }
        [data-theme="light"] .r-label {
            color: #64748B;
        }
        [data-theme="light"] .r-value {
            color: #1E293B;
        }
        [data-theme="light"] .r-section-title {
            color: #1E293B;
        }
        
        /* ==================== LIGHT THEME - PHOTO OPTIONS ==================== */
        [data-theme="light"] .photo-option-title {
            color: #1E293B;
        }
        [data-theme="light"] .photo-option-desc {
            color: #64748B;
        }
        
        /* ==================== LIGHT THEME - ATTACH MENU ==================== */
        [data-theme="light"] .attach-opt {
            color: #1E293B;
        }
        [data-theme="light"] .attach-opt .icon {
            color: var(--mode-color);
        }
        
        /* ==================== LIGHT THEME - HOTLINE ==================== */
        [data-theme="light"] .hotline-close {
            color: #64748B;
            background: #FFFFFF;
            border-color: rgba(0,0,0,0.08);
        }
        [data-theme="light"] .hotline-close .icon {
            color: #64748B;
        }
        [data-theme="light"] .hotline-close:hover {
            color: #1E293B;
        }
        
        /* ==================== LIGHT THEME - PROJECT CARDS ==================== */
        [data-theme="light"] .proj {
            background: #FFFFFF !important;
            border-color: rgba(0,0,0,0.08);
        }
        [data-theme="light"] .proj:hover {
            background: #F8FAFC !important;
            border-color: rgba(0,0,0,0.12);
        }
        [data-theme="light"] .proj:active {
            background: #F1F5F9 !important;
        }
        [data-theme="light"] .proj-title {
            color: #1E293B;
        }
        [data-theme="light"] .proj-meta,
        [data-theme="light"] .proj-time {
            color: #64748B;
        }
        
        /* ==================== LIGHT THEME - PROJECTS PAGE ==================== */
        [data-theme="light"] .projects-page-header::after {
            background: linear-gradient(to bottom, #F8FAFC 0%, #F8FAFC 20%, transparent 100%);
        }
        
        /* Toggle Switch Styles */
        .setting-toggle { 
            display: flex; 
            align-items: center; 
            justify-content: space-between; 
            padding: 14px 16px; 
            background: var(--card); 
            border: 1px solid var(--border); 
            border-radius: 12px; 
            margin-bottom: 12px;
        }
        .setting-toggle-info { display: flex; flex-direction: column; gap: 2px; }
        .setting-toggle-label { font-size: 13px; font-weight: 500; color: var(--text); }
        .setting-toggle-desc { font-size: 11px; color: var(--text-dim); }
        .toggle-switch { 
            position: relative; 
            width: 50px; 
            height: 28px; 
            background: var(--border); 
            border-radius: 14px; 
            cursor: pointer; 
            transition: all 0.3s ease;
            flex-shrink: 0;
        }
        .toggle-switch.active { background: var(--copilot); }
        .toggle-switch::after { 
            content: ''; 
            position: absolute; 
            top: 3px; 
            left: 3px; 
            width: 22px; 
            height: 22px; 
            background: white; 
            border-radius: 50%; 
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .toggle-switch.active::after { transform: translateX(22px); }
        
        /* Language Selector */
        .lang-selector {
            display: flex;
            gap: 8px;
        }
        .lang-btn {
            padding: 8px 16px;
            border-radius: 8px;
            border: 1px solid var(--border);
            background: var(--card);
            color: var(--text-dim);
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .lang-btn.active {
            background: var(--copilot-bg);
            border-color: var(--copilot-border);
            color: var(--copilot);
        }
        .lang-btn:hover:not(.active) {
            background: var(--border);
        }
        
        /* Settings Section Divider */
        .settings-divider {
            height: 1px;
            background: var(--border);
            margin: 20px 0;
        }
        .settings-section-title {
            font-size: 11px;
            font-weight: 600;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 12px;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        /* CRITICAL: Prevent any gap or overflow */
        html { 
            width: 100%; 
            height: 100%;
            height: -webkit-fill-available;
            margin: 0;
            padding: 0;
            background: var(--bg); 
            background-image: linear-gradient(var(--grid-color) 1px, transparent 1px), linear-gradient(90deg, var(--grid-color) 1px, transparent 1px); 
            background-size: 32px 32px;
            background-attachment: fixed;
            overflow: hidden !important;
            overscroll-behavior: none;
            -webkit-text-size-adjust: 100%;
            /* Prevent any content from showing outside */
            position: relative;
        }
        body { 
            width: 100%; 
            height: 100%;
            height: -webkit-fill-available;
            min-height: 100%;
            max-height: 100%;
            margin: 0;
            padding: 0;
            padding-bottom: env(safe-area-inset-bottom, 0px);
            font-family: 'Inter', -apple-system, sans-serif; 
            background: var(--bg); 
            background-image: linear-gradient(var(--grid-color) 1px, transparent 1px), linear-gradient(90deg, var(--grid-color) 1px, transparent 1px); 
            background-size: 32px 32px;
            background-attachment: fixed;
            color: var(--text); 
            overflow: hidden !important;
            position: fixed; 
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            overscroll-behavior: none;
            -webkit-text-size-adjust: 100%;
            display: flex;
            flex-direction: column;
        }
        
        /* App wrapper to contain everything */
        .app-wrapper {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            overflow: hidden;
            background: var(--bg);
        }
        input, textarea, select { font-size: 16px !important; }
        .icon { display: inline-flex; align-items: center; justify-content: center; }
        .icon svg { width: 100%; height: 100%; stroke: currentColor; stroke-width: 1.5; fill: none; stroke-linecap: round; stroke-linejoin: round; }
        .screen { position: fixed; top: 0; left: 0; right: 0; bottom: 0; display: none; flex-direction: column; background: var(--bg); background-image: linear-gradient(var(--grid-color) 1px, transparent 1px), linear-gradient(90deg, var(--grid-color) 1px, transparent 1px); background-size: 32px 32px; z-index: 1; }
        .screen.active { display: flex; }

        /* ==================== LOGIN ==================== */
        .login-screen { justify-content: center; align-items: center; padding: 24px; }
        .login-container { width: 100%; max-width: 380px; display: flex; flex-direction: column; align-items: center; }
        .scan-line { position: fixed; top: 0; left: 0; width: 100%; height: 2px; background: linear-gradient(90deg, transparent, var(--copilot), transparent); box-shadow: 0 0 20px var(--copilot-glow); animation: scanDown 2s ease-out forwards; }
        @keyframes scanDown { to { top: 50%; opacity: 0; } }
        .login-title { font-size: 22px; font-weight: 300; margin-bottom: 4px; color: rgba(255,255,255,0.9); }
        .login-sub { font-size: 12px; color: var(--text-dim); margin-bottom: 32px; }
        .login-logo { width: 160px; height: auto; margin-bottom: 24px; color: var(--copilot); }
        .login-logo svg { width: 100%; height: auto; }
        .login-bar { display: flex; align-items: center; gap: 8px; padding: 5px 5px 5px 8px; background: var(--card); border: 1px solid var(--border); border-radius: 40px; width: 100%; opacity: 0; animation: fadeUp 0.5s ease 1.5s forwards; }
        @keyframes fadeUp { to { opacity: 1; } }
        @keyframes spin { to { transform: rotate(360deg); } }
        .login-mini { width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; position: relative; }
        .glass-sphere { width: 26px; height: 26px; border-radius: 50%; position: relative; overflow: hidden; animation: glowPulse 8s ease-in-out infinite; }
        @keyframes glowPulse { 
            0%, 100% { box-shadow: 0 0 14px rgba(255,107,53,0.7), 0 0 28px rgba(255,107,53,0.3); } 
            25% { box-shadow: 0 0 14px rgba(239,68,68,0.7), 0 0 28px rgba(239,68,68,0.3); } 
            50% { box-shadow: 0 0 14px rgba(59,130,246,0.7), 0 0 28px rgba(59,130,246,0.3); } 
            75% { box-shadow: 0 0 14px rgba(234,179,8,0.7), 0 0 28px rgba(234,179,8,0.3); } 
        }
        .glass-sphere::before { content: ''; position: absolute; top: 2px; left: 4px; width: 5px; height: 4px; border-radius: 50%; background: radial-gradient(circle, rgba(255,255,255,0.5), transparent 70%); z-index: 10; }
        .sphere-fog-container { position: absolute; inset: 0; border-radius: 50%; overflow: hidden; background: rgba(20,24,32,0.3); }
        .sphere-fog { position: absolute; inset: -50%; border-radius: 50%; background: radial-gradient(circle at 30% 40%, currentColor, transparent 50%), radial-gradient(circle at 70% 60%, currentColor, transparent 40%); filter: blur(2px); animation: fogSwirl 6s ease-in-out infinite, fogColor 8s ease-in-out infinite; opacity: 0.9; }
        @keyframes fogSwirl { 0% { transform: rotate(0deg) translate(0, 0); } 25% { transform: rotate(90deg) translate(2px, -2px); } 50% { transform: rotate(180deg) translate(0, 0); } 75% { transform: rotate(270deg) translate(-2px, 2px); } 100% { transform: rotate(360deg) translate(0, 0); } }
        @keyframes fogColor { 0%, 100% { color: #FF6B35; } 25% { color: #ef4444; } 50% { color: #3B82F6; } 75% { color: #eab308; } }
        .sphere-fog-2 { position: absolute; inset: -30%; border-radius: 50%; background: radial-gradient(circle at 60% 30%, currentColor, transparent 45%); filter: blur(2px); animation: fogSwirl2 5s ease-in-out infinite reverse, fogColor2 8s ease-in-out infinite; opacity: 0.7; }
        @keyframes fogSwirl2 { 0% { transform: rotate(0deg) scale(0.9); } 50% { transform: rotate(180deg) scale(1.1); } 100% { transform: rotate(360deg) scale(0.9); } }
        @keyframes fogColor2 { 0%, 100% { color: #3B82F6; } 25% { color: #eab308; } 50% { color: #FF6B35; } 75% { color: #ef4444; } }
        .login-input { flex: 1; padding: 8px; background: transparent; border: none; color: white; font-size: 13px; outline: none; caret-color: white; }
        .login-input::placeholder { color: rgba(255,255,255,0.25); }
        .login-input:-webkit-autofill,
        .login-input:-webkit-autofill:hover,
        .login-input:-webkit-autofill:focus,
        .login-input:-webkit-autofill:active {
            -webkit-box-shadow: 0 0 0 1000px transparent inset !important;
            -webkit-text-fill-color: white !important;
            background-color: transparent !important;
            background: transparent !important;
            transition: background-color 9999s ease-out 9999s !important;
            caret-color: white !important;
        }
        .login-btn { width: 32px; height: 32px; border-radius: 50%; background: linear-gradient(135deg, #FF6B35, #E55A2B); border: none; color: white; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .login-btn .icon { width: 12px; height: 12px; }

        /* ==================== MAIN APP ==================== */
        .main-app { height: 100%; }
        .app-header { position: fixed; top: 0; left: 0; right: 0; display: flex; align-items: center; justify-content: center; padding: 12px 16px; padding-top: max(12px, env(safe-area-inset-top)); z-index: 100; background: linear-gradient(180deg, rgba(13,17,23,0.95), transparent); }
        .header-inner { width: 100%; max-width: var(--content-width); display: flex; align-items: center; justify-content: space-between; }
        .header-left { display: flex; align-items: center; }
        .header-logo-svg { height: 20px; color: var(--copilot); }
        .header-logo-svg svg { height: 100%; width: auto; }
        /* BRAND DROPDOWN */
        .brand-pill { display: flex; align-items: center; gap: 6px; padding: 6px 12px; background: var(--card); border: 1px solid var(--border); border-radius: 16px; cursor: pointer; position: relative; }
        .brand-pill-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--assistant); box-shadow: 0 0 6px var(--assistant); }
        .brand-pill.has-brand .brand-pill-dot { display: block; }
        .brand-pill-text { font-size: 11px; font-weight: 500; color: rgba(255,255,255,0.6); }
        .brand-pill-arrow { width: 10px; height: 10px; color: rgba(255,255,255,0.3); transition: transform 0.2s; }
        .brand-pill.open .brand-pill-arrow { transform: rotate(180deg); }
        
        .brand-dropdown { position: absolute; top: calc(100% + 6px); right: 0; min-width: 160px; max-height: 280px; overflow-y: auto; background: rgba(20,24,32,0.98); border: 1px solid var(--border); border-radius: 12px; padding: 6px; display: none; flex-direction: column; gap: 2px; z-index: 200; box-shadow: 0 8px 24px rgba(0,0,0,0.4); backdrop-filter: blur(20px); }
        .brand-dropdown.show { display: flex; }
        .brand-dropdown-item { display: flex; align-items: center; gap: 8px; padding: 8px 12px; border-radius: 8px; cursor: pointer; transition: all 0.2s; }
        .brand-dropdown-item:hover { background: rgba(255,255,255,0.06); }
        .brand-dropdown-item.active { background: rgba(34,197,94,0.15); border: 1px solid rgba(34,197,94,0.3); }
        .brand-dropdown-item.disabled { cursor: default; opacity: 0.35; padding: 6px 12px; }
        .brand-dropdown-item.disabled:hover { background: transparent; }
        .brand-dropdown-dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }
        .brand-dropdown-item.active .brand-dropdown-dot { box-shadow: 0 0 6px currentColor; }
        .brand-dropdown-name { font-size: 12px; font-weight: 500; color: rgba(255,255,255,0.8); flex: 1; }
        .brand-dropdown-item.disabled .brand-dropdown-name { font-size: 11px; color: rgba(255,255,255,0.3); }
        .brand-dropdown-check { width: 14px; height: 14px; color: #22c55e; opacity: 0; }
        .brand-dropdown-item.selected .brand-dropdown-check { opacity: 1; }
        .brand-dropdown-divider { height: 1px; background: var(--border); margin: 4px 0; position: sticky; top: 0; z-index: 1; }

        .app-content { height: 100%; padding-top: calc(56px + env(safe-area-inset-top)); padding-bottom: calc(70px + env(safe-area-inset-bottom)); overflow-y: auto; overflow-x: hidden; display: flex; flex-direction: column; align-items: center; }
        
        /* CENTERED CONTENT CONTAINER */
        .home, .projects-page { 
            width: 100%; 
            max-width: var(--content-width); 
            padding: 16px; 
            display: flex; 
            flex-direction: column; 
            gap: 20px; 
        }

        /* ==================== IMPROVED PROGRESS RING (BIGGER) ==================== */
        .activity-section { text-align: center; margin-bottom: 8px; }
        .activity-ring-container { position: relative; width: 180px; height: 180px; margin: 0 auto 12px; }
        .activity-ring-svg { width: 100%; height: 100%; transform: rotate(-90deg); }
        .ring-bg { fill: none; stroke: rgba(255,255,255,0.04); stroke-width: 11; }
        .ring-progress { fill: none; stroke-width: 11; stroke-linecap: round; stroke-dasharray: 440; stroke-dashoffset: 119; filter: drop-shadow(0 0 8px rgba(34, 197, 94, 0.5)); transition: stroke-dashoffset 1s ease, stroke 0.5s ease; }
        .ring-progress.cold { stroke: url(#coldGradient); filter: drop-shadow(0 0 8px rgba(125, 64, 255, 0.5)); }
        .ring-progress.warm { stroke: url(#warmGradient); filter: drop-shadow(0 0 8px rgba(255, 107, 53, 0.5)); }
        .ring-progress.hot { stroke: url(#hotGradient); filter: drop-shadow(0 0 8px rgba(34, 197, 94, 0.5)); }
        .activity-ring-inner { position: absolute; inset: 28px; border-radius: 50%; background: radial-gradient(circle at 30% 30%, rgba(34,197,94,0.08), transparent 60%); display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .activity-value { font-size: 32px; font-weight: 800; background: linear-gradient(135deg, #22c55e, #4ade80); -webkit-background-clip: text; -webkit-text-fill-color: transparent; line-height: 1; }
        .activity-label { font-size: 9px; font-weight: 600; color: var(--text-dim); text-transform: uppercase; letter-spacing: 1px; margin-top: 2px; }
        
        /* STATUS - NO BACKGROUND, JUST TEXT */
        .activity-status { display: inline-flex; align-items: center; justify-content: center; gap: 6px; }
        .status-fire { font-size: 16px; animation: fireWiggle 0.5s ease-in-out infinite; }
        @keyframes fireWiggle { 0%, 100% { transform: rotate(-5deg); } 50% { transform: rotate(5deg); } }
        .status-text { font-size: 12px; font-weight: 600; color: var(--copilot); text-transform: uppercase; letter-spacing: 1px; }

        /* ==================== GAMIFICATION STATS - FIRE GROWTH ==================== */
        .stats-section {
            text-align: center;
            margin-bottom: 10px !important; /* 10px + 20px gap = 30px total to cards */
        }
        
        .stats-week-label {
            font-size: 11px;
            color: var(--text-dim);
            margin-bottom: 24px;
            text-transform: uppercase;
            letter-spacing: 1.5px;
        }
        
        .stats-ring-container {
            position: relative;
            width: 160px;
            height: 160px;
            margin: 0 auto 28px;
        }
        
        .stats-ring {
            width: 100%;
            height: 100%;
        }
        
        .stats-ring-bg {
            fill: none;
            stroke: rgba(255,255,255,0.06);
            stroke-width: 10;
        }
        
        .stats-ring-progress {
            fill: none;
            stroke: url(#fireGrowthGradient);
            stroke-width: 10;
            stroke-linecap: round;
            stroke-dasharray: 339.292;
            stroke-dashoffset: 339.292;
            transition: stroke-dashoffset 1s cubic-bezier(0.4, 0, 0.2, 1);
            filter: drop-shadow(0 0 12px rgba(234, 88, 12, 0.5));
        }
        
        .stats-ring-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
        }
        
        .stats-ring-percent {
            font-size: 36px;
            font-weight: 800;
            background: linear-gradient(135deg, #EA580C, #FCD34D);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        /* Ring Tooltip */
        .stats-ring-tooltip {
            position: absolute;
            top: calc(100% + 15px);
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.95);
            color: #fff;
            padding: 10px 14px;
            border-radius: 10px;
            font-size: 11px;
            line-height: 1.5;
            width: 240px;
            text-align: center;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.2s, visibility 0.2s;
            z-index: 1000;
            pointer-events: none;
            box-shadow: 0 4px 20px rgba(0,0,0,0.4);
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        .stats-ring-tooltip::before {
            content: '';
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 6px solid transparent;
            border-bottom-color: rgba(0, 0, 0, 0.95);
        }
        
        .stats-ring-container:hover .stats-ring-tooltip {
            opacity: 1;
            visibility: visible;
        }
        
        /* Stats Inline Row */
        .stats-inline {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 16px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }
        
        .stats-item {
            display: flex;
            align-items: baseline;
            gap: 3px;
            position: relative;
            cursor: default;
        }
        
        .stats-item-icon {
            font-size: 16px;
            align-self: center;
        }
        
        .stats-item-value {
            font-size: 15px;
            font-weight: 700;
            color: var(--text);
        }
        
        .stats-item-unit {
            font-size: 12px;
            font-weight: 500;
            color: #FFFFFF;
        }
        
        .stats-item-label {
            font-size: 11px;
            font-weight: 400;
            color: var(--text-dim);
            margin-left: 2px;
        }
        
        .stats-separator {
            width: 1px;
            height: 16px;
            background: rgba(255, 255, 255, 0.1);
            align-self: center;
        }
        
        .stats-message {
            font-size: 13px;
            font-weight: 600;
            color: #22C55E;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        /* Green/neon emoji for "Efficace" level */
        .green-emoji {
            display: inline-block;
            filter: hue-rotate(80deg) saturate(2) brightness(1.3);
            text-shadow: 0 0 10px rgba(34, 197, 94, 0.8), 0 0 20px rgba(34, 197, 94, 0.5);
        }
        
        /* Tooltip for stats explanation */
        .stats-tooltip {
            position: absolute;
            bottom: calc(100% + 10px);
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.95);
            color: #fff;
            padding: 10px 14px;
            border-radius: 10px;
            font-size: 11px;
            line-height: 1.5;
            width: 220px;
            text-align: center;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.2s, visibility 0.2s;
            z-index: 1000;
            pointer-events: none;
            box-shadow: 0 4px 20px rgba(0,0,0,0.4);
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        .stats-tooltip::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 6px solid transparent;
            border-top-color: rgba(0, 0, 0, 0.95);
        }
        
        .stats-item:hover .stats-tooltip {
            opacity: 1;
            visibility: visible;
        }
        
        /* Light theme overrides */
        [data-theme="light"] .stats-ring-bg {
            stroke: rgba(0, 0, 0, 0.08);
        }
        
        [data-theme="light"] .stats-separator {
            background: rgba(0, 0, 0, 0.1);
        }
        
        [data-theme="light"] .stats-tooltip {
            background: rgba(30, 30, 30, 0.98);
        }
        
        [data-theme="light"] .stats-tooltip::after {
            border-top-color: rgba(30, 30, 30, 0.98);
        }

        /* ==================== HOMEPAGE TOGGLE CARDS (V2 STYLE) ==================== */
        .modules-toggle { display: flex; gap: 12px; }
        
        .toggle-card { 
            flex: 1; 
            display: flex; 
            align-items: center; 
            gap: 12px; 
            padding: 18px 16px; 
            border-radius: 14px; 
            cursor: pointer; 
            transition: all 0.3s ease;
            text-decoration: none;
        }
        
        .toggle-card.copilot { 
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .toggle-card.assistant { 
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .toggle-card.copilot:hover { 
            background: rgba(255, 255, 255, 0.12);
            border-color: rgba(255, 255, 255, 0.15);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.25);
            transform: translateY(-2px);
        }
        .toggle-card.assistant:hover { 
            background: rgba(255, 255, 255, 0.12);
            border-color: rgba(255, 255, 255, 0.15);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.25);
            transform: translateY(-2px);
        }
        
        .toggle-card-icon { 
            width: 40px; 
            height: 40px; 
            border-radius: 10px; 
            display: flex; 
            align-items: center; 
            justify-content: center;
            transition: all 0.3s;
            flex-shrink: 0;
        }
        .toggle-card.copilot .toggle-card-icon { background: rgba(255, 255, 255, 0.1); color: var(--copilot); }
        .toggle-card.assistant .toggle-card-icon { background: rgba(255, 255, 255, 0.1); color: var(--assistant); }
        
        .toggle-card-icon .icon { width: 20px; height: 20px; }
        .toggle-card-icon .star-icon { width: 22px; height: 22px; }
        .toggle-card-icon .star-icon svg { fill: currentColor; stroke: none; }
        
        .toggle-card-content { flex: 1; }
        .toggle-card-title { 
            font-size: 16px; 
            font-weight: 600; 
            margin-bottom: 4px;
            transition: color 0.3s;
            color: rgba(255, 255, 255, 0.9);
        }
        .toggle-card.copilot:hover .toggle-card-title { color: white; }
        .toggle-card.assistant:hover .toggle-card-title { color: white; }
        
        .toggle-card-desc { font-size: 11px; color: var(--text-dim); white-space: nowrap; }
        .toggle-card-desc .highlight-copilot { color: rgba(255, 107, 53, 0.7); }
        .toggle-card-desc .highlight-assistant { color: rgba(34, 197, 94, 0.7); }

        .toggle-card-arrow { 
            width: 18px; 
            height: 18px; 
            transition: all 0.3s;
            flex-shrink: 0;
            color: rgba(255, 255, 255, 0.25);
        }
        .toggle-card:hover .toggle-card-arrow { color: rgba(255, 255, 255, 0.5); transform: translateX(4px); }

        /* BRAND CHIPS - Horizontal scrollable single line */
        .brand-select-row { 
            display: flex; 
            align-items: center; 
            gap: 8px; 
            padding: 12px; 
            background: var(--card); 
            border: 1px solid var(--border); 
            border-radius: 12px; 
            flex-wrap: nowrap;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }
        .brand-select-row::-webkit-scrollbar { display: none; }
        .brand-label { font-size: 11px; color: var(--text-dim); flex-shrink: 0; }
        .brand-chip { padding: 6px 12px; background: transparent; border: 1px solid var(--border); border-radius: 14px; font-size: 11px; color: rgba(255,255,255,0.5); cursor: pointer; transition: all 0.2s; flex-shrink: 0; white-space: nowrap; }
        .brand-chip:hover { background: rgba(255,255,255,0.03); }
        .brand-chip.active { background: var(--copilot-bg); border-color: var(--copilot-border); color: var(--copilot); }

        /* SECTION HEADERS */
        .sec-head { display: flex; align-items: center; gap: 8px; margin-bottom: 10px; }
        .sec-title { font-size: 10px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-dim); }
        .sec-line { flex: 1; height: 1px; background: var(--border); }

        /* PROJECTS LIST */
        .projects { display: flex; flex-direction: column; gap: 10px; }
        .proj { display: flex; align-items: center; gap: 12px; padding: 14px 14px; background: var(--card); border: 1px solid var(--border); border-radius: 12px; cursor: pointer; transition: all 0.2s; -webkit-user-select: none; user-select: none; -webkit-touch-callout: none; }
        .proj:hover { background: rgba(255,255,255,0.04); border-color: rgba(255,255,255,0.15); }
        .proj-icons { display: flex; align-items: center; position: relative; width: 36px; height: 36px; flex-shrink: 0; }
        .proj-icons.dual { width: 44px; height: 40px; }
        .proj-icon { width: 36px; height: 36px; border-radius: 10px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
        .proj-icon.copilot { background: var(--copilot-bg); color: var(--copilot); }
        .proj-icon.assistant { background: var(--assistant-bg); color: var(--assistant); }
        .proj-icon .icon { width: 16px; height: 16px; }
        .proj-icon .star-icon { width: 18px; height: 18px; }
        .proj-icon .star-icon svg { fill: currentColor; stroke: none; }
        .proj-icons .proj-icon.back { position: absolute; top: 0; left: 0; width: 32px; height: 32px; border-radius: 8px; }
        .proj-icons .proj-icon.back .icon { width: 14px; height: 14px; }
        .proj-icons .proj-icon.back .star-icon { width: 16px; height: 16px; }
        .proj-icons .proj-icon.front { position: absolute; bottom: 0; right: 0; width: 32px; height: 32px; border-radius: 8px; box-shadow: -2px -2px 8px rgba(0,0,0,0.3); }
        .proj-icons .proj-icon.front .icon { width: 14px; height: 14px; }
        .proj-info { flex: 1; min-width: 0; }
        .proj-title { font-size: 13px; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-bottom: 4px; }
        .proj-meta { font-size: 11px; color: var(--text-dim); }
        .proj-time { font-size: 11px; color: rgba(255,255,255,0.25); }
        
        /* PROJECT CONTEXT MENU */
        .project-context-menu {
            position: fixed;
            background: rgba(30,35,44,0.98);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 6px;
            min-width: 160px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.4);
            z-index: 10000;
            display: none;
        }
        .project-context-menu.show { display: block; }
        .context-menu-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            color: rgba(255,255,255,0.85);
            transition: all 0.15s;
        }
        .context-menu-item:hover { background: rgba(255,255,255,0.08); }
        .context-menu-item .icon { width: 16px; height: 16px; color: rgba(255,255,255,0.5); }
        .context-menu-item:hover .icon { color: rgba(255,255,255,0.8); }
        .context-menu-item.delete { color: #ef4444; }
        .context-menu-item.delete .icon { color: #ef4444; }
        .context-menu-item.delete:hover { background: rgba(239,68,68,0.15); }
        [data-theme="light"] .project-context-menu { background: rgba(255,255,255,0.98); border-color: rgba(0,0,0,0.08); }
        [data-theme="light"] .context-menu-item { color: #374151; }
        [data-theme="light"] .context-menu-item:hover { background: rgba(0,0,0,0.05); }
        [data-theme="light"] .context-menu-item .icon { color: rgba(0,0,0,0.4); }
        
        /* RENAME MODAL */
        .rename-modal {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.6);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10001;
        }
        .rename-modal.show { display: flex; }
        .rename-modal-content {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 24px;
            width: 90%;
            max-width: 360px;
        }
        .rename-modal-title { font-size: 16px; font-weight: 600; margin-bottom: 16px; }
        .rename-modal-input {
            width: 100%;
            padding: 12px;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text);
            font-size: 14px;
            margin-bottom: 16px;
        }
        .rename-modal-input:focus { outline: none; border-color: var(--assistant); }
        .rename-modal-buttons { display: flex; gap: 10px; justify-content: flex-end; }
        .rename-modal-btn {
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            border: none;
        }
        .rename-modal-btn.cancel { background: var(--bg); color: var(--text-dim); }
        .rename-modal-btn.save { background: var(--assistant); color: white; }

        /* NAV WITH CENTERED HOTLINE SPHERE */
        .nav { 
            position: fixed; 
            bottom: 0; 
            bottom: env(safe-area-inset-bottom, 0px);
            left: 50%; 
            transform: translateX(-50%); 
            width: calc(100% - 16px); 
            max-width: 580px; 
            display: flex; 
            justify-content: center; 
            padding: 6px 16px; 
            padding-bottom: max(10px, env(safe-area-inset-bottom, 10px)); 
            background: rgba(30,35,44,0.98); 
            backdrop-filter: blur(20px); 
            -webkit-backdrop-filter: blur(20px);
            z-index: 99999; 
            border-top: 1px solid var(--border); 
            border-left: 1px solid var(--border); 
            border-right: 1px solid var(--border); 
            border-radius: 14px 14px 0 0;
        }
        /* HIDE nav when chat is open */
        .chat-view.active ~ .nav { display: none !important; }
        .nav-inner { width: 100%; display: flex; justify-content: space-around; align-items: flex-end; }
        .nav-item { display: flex; flex-direction: column; align-items: center; gap: 2px; padding: 5px 16px; color: rgba(255,255,255,0.3); cursor: pointer; transition: color 0.2s; }
        .nav-item:hover { color: rgba(255,255,255,0.5); }
        .nav-item.active { color: var(--copilot); }
        .nav-icon { width: 20px; height: 20px; }
        .nav-label { font-size: 10px; font-weight: 500; }

        .nav-hotline { display: flex; flex-direction: column; align-items: center; gap: 2px; padding: 5px 16px; color: rgba(255,255,255,0.3); cursor: pointer; transition: color 0.2s; }
        .nav-hotline:hover { color: rgba(255,255,255,0.5); }
        .nav-hotline .nav-icon { width: 20px; height: 20px; }
        .nav-hotline-waves { display: flex; align-items: center; justify-content: center; gap: 2px; width: 20px; height: 20px; }
        .nav-hotline-waves .wave-bar { width: 3px; background: currentColor; border-radius: 2px; animation: navWave 1s ease-in-out infinite; }
        .nav-hotline-waves .wave-bar:nth-child(1) { height: 6px; animation-delay: 0s; }
        .nav-hotline-waves .wave-bar:nth-child(2) { height: 12px; animation-delay: 0.1s; }
        .nav-hotline-waves .wave-bar:nth-child(3) { height: 18px; animation-delay: 0.2s; }
        .nav-hotline-waves .wave-bar:nth-child(4) { height: 12px; animation-delay: 0.3s; }
        .nav-hotline-waves .wave-bar:nth-child(5) { height: 6px; animation-delay: 0.4s; }
        @keyframes navWave { 0%, 100% { transform: scaleY(0.6); } 50% { transform: scaleY(1); } }

        /* ==================== PROJECTS PAGE ==================== */
        .projects-page { display: none; flex-direction: column; height: 100%; position: relative; }
        .projects-page.active { display: flex; }
        .projects-page-header { 
            margin-bottom: 0; 
            position: sticky; 
            top: 0; 
            background: transparent;
            padding-top: 8px; 
            padding-bottom: 16px; 
            z-index: 10; 
        }
        /* Gradient fade effect below header */
        .projects-page-header::after {
            content: '';
            position: absolute;
            left: -20px;
            right: -20px;
            bottom: -50px;
            height: 50px;
            background: linear-gradient(to bottom, var(--bg) 0%, var(--bg) 20%, transparent 100%);
            pointer-events: none;
            z-index: 9;
        }
        .projects-page-title { font-size: 18px; font-weight: 600; margin-bottom: 4px; }
        .projects-page-sub { font-size: 12px; color: var(--text-dim); }
        .projects-list { 
            display: flex; 
            flex-direction: column; 
            gap: 10px; 
            flex: 1; 
            overflow-y: auto; 
            padding-top: 10px;
            padding-bottom: calc(90px + env(safe-area-inset-bottom));
            /* Hide scrollbar completely */
            scrollbar-width: none;
            -ms-overflow-style: none;
        }
        .projects-list::-webkit-scrollbar {
            display: none;
        }

        /* ==================== CHAT VIEW (FULL WIDTH) ==================== */
        .chat-view { 
            position: fixed; 
            top: 0;
            left: 0;
            right: 0;
            bottom: 0; /* Full screen - nav is hidden when chat is open */
            display: none; 
            z-index: 200; 
            background: var(--bg); 
            background-image: linear-gradient(var(--grid-color) 1px, transparent 1px), linear-gradient(90deg, var(--grid-color) 1px, transparent 1px); 
            background-size: 32px 32px;
            overflow: hidden;
        }
        .chat-view.active { display: flex; }
        .chat-view.single { flex-direction: column; }
        .chat-view.split { flex-direction: row; }
        @media (max-width: 767px) { 
            .chat-view.split { flex-direction: column; }
        }

        .panel { 
            display: flex; 
            flex-direction: column; 
            flex: 1; 
            min-width: 0; 
            min-height: 0; 
            overflow: hidden;
            position: relative;
        }
        .panel.copilot { --mode-color: var(--copilot); --mode-glow: var(--copilot-glow); --mode-bg: var(--copilot-bg); --mode-border: var(--copilot-border); }
        .panel.assistant { --mode-color: var(--assistant); --mode-glow: var(--assistant-glow); --mode-bg: var(--assistant-bg); --mode-border: var(--assistant-border); }

        .panel-header { display: flex; align-items: center; gap: 8px; padding: 10px 12px; padding-top: max(10px, env(safe-area-inset-top)); flex-shrink: 0; border-bottom: 1px solid var(--border); background: var(--bg-secondary); }
        .chat-view.split .panel-header { padding-top: 10px; }
        .panel-back { width: 32px; height: 32px; border-radius: 50%; background: var(--card); border: 1px solid var(--border); color: rgba(255,255,255,0.5); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; flex-shrink: 0; }
        .panel-back:hover { background: rgba(255,255,255,0.05); color: rgba(255,255,255,0.8); }
        .panel-back .icon { width: 14px; height: 14px; }
        .panel-info { flex: 1; min-width: 0; display: flex; align-items: center; gap: 8px; }
        .panel-title { font-size: 13px; font-weight: 600; color: var(--mode-color); }
        .panel-separator { width: 1px; height: 12px; background: rgba(255,255,255,0.15); }
        .panel-brand { font-size: 12px; color: var(--text-dim); }
        .panel-project { font-size: 11px; color: var(--text-dim); opacity: 0.7; max-width: 120px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* CLICKABLE BRAND TAG IN CHAT HEADER - No chip, original style */
        .panel-brand-wrapper { position: relative; display: flex; align-items: center; }
        .panel-brand-btn {
            display: flex;
            align-items: center;
            gap: 4px;
            cursor: pointer;
            transition: all 0.2s;
            background: none;
            border: none;
            padding: 0;
        }
        .panel-brand-btn .panel-brand-text {
            font-size: 12px;
            color: var(--text-dim);
            transition: color 0.2s;
        }
        .panel-brand-btn:hover .panel-brand-text {
            color: #fff;
        }
        .panel-brand-btn .brand-arrow {
            width: 10px;
            height: 10px;
            color: var(--text-dim);
            opacity: 0.6;
            transition: all 0.2s;
        }
        .panel-brand-btn:hover .brand-arrow {
            color: #fff;
            opacity: 1;
        }
        .panel-brand-wrapper.open .brand-arrow {
            transform: rotate(180deg);
        }
        .panel-brand-dropdown {
            position: absolute;
            top: calc(100% + 8px);
            left: 0;
            min-width: 180px;
            background: rgba(30, 32, 38, 0.95);
            border: 1px solid rgba(255,255,255,0.15);
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.5);
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-8px);
            transition: all 0.2s;
            max-height: 320px;
            overflow-y: auto;
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
        }
        .panel-brand-wrapper.open .panel-brand-dropdown {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }
        .panel-brand-option {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 11px 14px;
            cursor: pointer;
            transition: background 0.15s;
            font-size: 13px;
            color: rgba(255,255,255,0.7);
        }
        .panel-brand-option:first-child { border-radius: 11px 11px 0 0; }
        .panel-brand-option:last-child { border-radius: 0 0 11px 11px; }
        .panel-brand-option:hover {
            background: rgba(255,255,255,0.08);
            color: #fff;
        }
        .panel-brand-option.selected {
            background: var(--mode-bg);
            color: var(--mode-color);
        }
        .panel-brand-option .brand-check {
            width: 14px;
            height: 14px;
            opacity: 0;
            color: var(--mode-color);
            flex-shrink: 0;
        }
        .panel-brand-option.selected .brand-check {
            opacity: 1;
        }

        /* MODE TOGGLE */
        .mode-toggle { display: flex; background: var(--card); border: 1px solid var(--border); border-radius: 8px; overflow: hidden; flex-shrink: 0; height: 32px; }
        .mode-btn { display: flex; align-items: center; justify-content: center; gap: 5px; padding: 0 10px; font-size: 10px; font-weight: 500; color: rgba(255,255,255,0.35); cursor: pointer; transition: all 0.2s; border-right: 1px solid var(--border); }
        .mode-btn:last-child { border-right: none; }
        .mode-btn .mode-icon { width: 16px; height: 16px; opacity: 0.5; display: flex; align-items: center; justify-content: center; }
        .mode-btn .mode-icon svg { width: 100%; height: 100%; }
        .mode-btn .mode-icon.star-icon svg { fill: currentColor; stroke: none; }
        .mode-btn .mode-icon.clip-icon svg { fill: none; stroke: currentColor; stroke-width: 1.5; }
        
        .mode-btn.copilot.active { background: var(--copilot-bg); color: var(--copilot); }
        .mode-btn.copilot.active .mode-icon { opacity: 1; color: var(--copilot); }
        .mode-btn.assistant.active { background: var(--assistant-bg); color: var(--assistant); }
        .mode-btn.assistant.active .mode-icon { opacity: 1; color: var(--assistant); }

        .header-actions { display: flex; gap: 6px; flex-shrink: 0; }
        .h-btn { width: 32px; height: 32px; border-radius: 8px; background: var(--card); border: 1px solid var(--border); color: rgba(255,255,255,0.5); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
        .h-btn:hover { background: rgba(255,255,255,0.05); color: rgba(255,255,255,0.8); }
        .h-btn.active { background: var(--mode-bg); border-color: var(--mode-border); color: var(--mode-color); }
        .h-btn .icon { width: 14px; height: 14px; }
        .h-btn .icon svg { width: 100%; height: 100%; }
        
        /* Report button - always visible in Assistant mode */
        .h-btn.report-btn { display: none; } /* Hidden by default (Copilot) */
        .panel.assistant .h-btn.report-btn { display: flex; } /* Visible in Assistant */
        .h-btn.report-btn .icon { width: 18px; height: 18px; display: flex; align-items: center; justify-content: center; }
        .h-btn.report-btn .icon svg { width: 18px; height: 18px; stroke: rgba(255,255,255,0.7); }
        .h-btn.report-btn:hover .icon svg { stroke: rgba(255,255,255,1); }
        .h-btn.report-btn.has-data { 
            border-color: var(--assistant); 
            color: var(--assistant);
            animation: reportPulse 2s ease-in-out infinite;
        }
        .h-btn.report-btn.has-data .icon svg { stroke: var(--assistant); }
        @keyframes reportPulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0); }
            50% { box-shadow: 0 0 0 4px rgba(34, 197, 94, 0.2); }
        }

        .chat-body { 
            flex: 1; 
            overflow-y: auto; 
            overflow-x: hidden;
            padding: 14px; 
            display: flex; 
            flex-direction: column; 
            gap: 10px; 
            min-height: 0;
            -webkit-overflow-scrolling: touch;
        }
        .msg { max-width: 90%; animation: msgIn 0.3s ease; }
        @keyframes msgIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
        .msg.user { align-self: flex-end; max-width: 80%; }
        .msg.ai { align-self: flex-start; }
        
        /* Report messages - normal bubble with card inside */
        .msg.ai.report { max-width: 98%; width: 98%; }
        
        /* Report card inside the bubble */
        .report-card {
            background: #1E1E2E;
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: 16px;
            padding: 16px 24px 20px 24px;
            margin-top: 12px;
            line-height: 1.5;
            position: relative;
        }
        /* Report card menu */
        .report-menu {
            position: absolute;
            top: 12px;
            right: 12px;
            z-index: 10;
        }
        .report-menu-btn {
            width: 28px;
            height: 28px;
            border-radius: 8px;
            background: transparent;
            border: none;
            color: rgba(255,255,255,0.4);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        .report-menu-btn:hover {
            background: rgba(255,255,255,0.08);
            color: rgba(255,255,255,0.8);
        }
        .report-menu-btn .icon {
            width: 16px;
            height: 16px;
        }
        .report-menu-dropdown {
            position: absolute;
            top: calc(100% + 4px);
            right: 0;
            min-width: 150px;
            background: rgba(20,24,32,0.98);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 6px;
            display: none;
            flex-direction: column;
            gap: 2px;
            z-index: 200;
            box-shadow: 0 8px 24px rgba(0,0,0,0.4);
            backdrop-filter: blur(20px);
        }
        .report-menu-dropdown.show {
            display: flex;
        }
        .report-menu-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            color: rgba(255,255,255,0.8);
            font-size: 13px;
            font-weight: 500;
        }
        .report-menu-item:hover {
            background: rgba(255,255,255,0.06);
        }
        .report-menu-item .icon {
            width: 16px;
            height: 16px;
            color: rgba(255,255,255,0.5);
        }
        .report-menu-item:hover .icon {
            color: rgba(255,255,255,0.8);
        }
        /* Light theme report menu */
        [data-theme="light"] .report-menu-btn {
            color: rgba(0,0,0,0.3);
        }
        [data-theme="light"] .report-menu-btn:hover {
            background: rgba(0,0,0,0.05);
            color: rgba(0,0,0,0.7);
        }
        [data-theme="light"] .report-menu-dropdown {
            background: rgba(255,255,255,0.98);
            border-color: rgba(0,0,0,0.08);
            box-shadow: 0 8px 24px rgba(0,0,0,0.15);
        }
        [data-theme="light"] .report-menu-item {
            color: #374151;
        }
        [data-theme="light"] .report-menu-item:hover {
            background: rgba(0,0,0,0.04);
        }
        [data-theme="light"] .report-menu-item .icon {
            color: rgba(0,0,0,0.4);
        }
        [data-theme="light"] .report-menu-item:hover .icon {
            color: rgba(0,0,0,0.7);
        }
        
        /* Report main title */
        .report-card .report-title {
            display: block;
            font-size: 17px; 
            font-weight: 700;
            color: var(--assistant);
            margin-bottom: 4px;
            padding-right: 36px;
        }
        .report-card h1 { 
            font-size: 17px; 
            font-weight: 700;
            color: var(--assistant);
            margin: 0 0 4px 0;
            border: none;
            padding-right: 36px;
        }
        /* Report section titles - green */
        .report-card h2 { 
            font-size: 14px; 
            font-weight: 600;
            color: var(--assistant);
            text-transform: uppercase;
            letter-spacing: 0.3px;
            border: none;
            margin: 18px 0 8px 0;
        }
        .report-card h2:first-of-type { margin-top: 10px; }
        /* Report subsection titles */
        .report-card h3 { 
            font-size: 13px; 
            font-weight: 600;
            color: rgba(255,255,255,0.7);
            margin: 12px 0 4px 0;
            border: none;
        }
        /* Report paragraphs */
        .report-card p { 
            margin: 4px 0; 
            font-size: 14px;
            color: rgba(255,255,255,0.9);
        }
        /* Report first paragraph (reference line) */
        .report-card > p:first-of-type {
            color: rgba(255,255,255,0.5);
            font-size: 12px;
            margin-bottom: 8px;
        }
        /* Report lists - tighter spacing */
        .report-card ul, 
        .report-card ol { 
            margin: 2px 0 6px 0; 
            padding-left: 18px; 
        }
        .report-card li { 
            margin: 1px 0; 
            font-size: 14px;
            color: rgba(255,255,255,0.9);
            line-height: 1.4;
        }
        /* Report horizontal rules - fewer and subtle */
        .report-card hr {
            margin: 16px 0;
            border: none;
            border-top: 1px solid rgba(255,255,255,0.06);
            height: 0;
        }
        /* Report bold text - labels are slightly gray */
        .report-card strong {
            color: rgba(255,255,255,0.55);
            font-weight: 600;
        }
        /* Report tables */
        .report-card table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
            font-size: 13px;
        }
        .report-card th {
            background: rgba(255,255,255,0.06);
            color: var(--assistant);
            font-weight: 600;
            text-align: left;
            padding: 8px 10px;
            border: 1px solid rgba(255,255,255,0.08);
        }
        .report-card td {
            padding: 6px 10px;
            border: 1px solid rgba(255,255,255,0.06);
            color: rgba(255,255,255,0.8);
        }
        .report-card tbody tr:hover {
            background: rgba(255,255,255,0.02);
        }
        /* Report footer */
        .report-card .report-footer,
        .report-card em:last-child {
            display: block;
            margin-top: 16px;
            padding-top: 10px;
            border-top: 1px solid rgba(255,255,255,0.06);
            font-size: 11px;
            color: rgba(255,255,255,0.35);
            font-style: italic;
        }
        
        /* Light theme report card */
        [data-theme="light"] .report-card {
            background: #f1f5f9;
            border: 1px solid rgba(0,0,0,0.06);
        }
        [data-theme="light"] .report-card .report-title,
        [data-theme="light"] .report-card h1 { 
            color: var(--assistant);
        }
        [data-theme="light"] .report-card h2 {
            color: var(--assistant);
        }
        [data-theme="light"] .report-card h3 { 
            color: rgba(0,0,0,0.6);
        }
        [data-theme="light"] .report-card p,
        [data-theme="light"] .report-card li { 
            color: #1a1a1a;
        }
        [data-theme="light"] .report-card > p:first-of-type {
            color: rgba(0,0,0,0.45);
        }
        [data-theme="light"] .report-card strong {
            color: rgba(0,0,0,0.5);
        }
        [data-theme="light"] .report-card hr {
            border-top: 1px solid rgba(0,0,0,0.06);
        }
        [data-theme="light"] .report-card th {
            background: rgba(0,0,0,0.04);
            color: var(--assistant);
            border-color: rgba(0,0,0,0.08);
        }
        [data-theme="light"] .report-card td {
            border-color: rgba(0,0,0,0.06);
            color: #374151;
        }
        [data-theme="light"] .report-card .report-footer,
        [data-theme="light"] .report-card em:last-child {
            color: rgba(0,0,0,0.35);
            border-top: 1px solid rgba(0,0,0,0.06);
        }
        
        .msg-bubble { padding: 12px 16px; border-radius: 16px; font-size: 13px; line-height: 1.5; position: relative; }
        .msg.user .msg-bubble { background: linear-gradient(135deg, var(--mode-color), color-mix(in srgb, var(--mode-color) 80%, black)); color: white; border-bottom-right-radius: 4px; }
        .msg.ai .msg-bubble { background: var(--card); border: 1px solid var(--border); border-bottom-left-radius: 4px; }
        
        /* Markdown styling in AI messages */
        .msg.ai .msg-bubble h1, .msg.ai .msg-bubble h2, .msg.ai .msg-bubble h3 { 
            color: var(--mode-color); 
            font-weight: 700; 
            margin: 16px 0 8px 0;
            line-height: 1.3;
        }
        .msg.ai .msg-bubble h1:first-child, .msg.ai .msg-bubble h2:first-child, .msg.ai .msg-bubble h3:first-child { margin-top: 0; }
        .msg.ai .msg-bubble h1 { font-size: 18px; }
        .msg.ai .msg-bubble h2 { font-size: 16px; }
        .msg.ai .msg-bubble h3 { font-size: 14px; }
        .msg.ai .msg-bubble p { margin: 8px 0; }
        .msg.ai .msg-bubble ul, .msg.ai .msg-bubble ol { margin: 8px 0; padding-left: 20px; }
        .msg.ai .msg-bubble li { margin: 4px 0; }
        .msg.ai .msg-bubble strong { font-weight: 600; color: var(--text); }
        .msg.ai .msg-bubble em { font-style: italic; }
        .msg.ai .msg-bubble code { 
            background: rgba(255,255,255,0.1); 
            padding: 2px 6px; 
            border-radius: 4px; 
            font-family: monospace; 
            font-size: 12px; 
        }
        .msg.ai .msg-bubble pre { 
            background: rgba(0,0,0,0.3); 
            padding: 12px; 
            border-radius: 8px; 
            overflow-x: auto; 
            margin: 8px 0;
        }
        .msg.ai .msg-bubble pre code { background: transparent; padding: 0; }
        .msg.ai .msg-bubble hr { border: none; border-top: 1px solid rgba(255,255,255,0.1); margin: 12px 0; height: 0; }
        .msg.ai .msg-bubble blockquote { 
            border-left: 3px solid var(--mode-color); 
            padding-left: 12px; 
            margin: 8px 0; 
            color: var(--text-dim); 
        }
        .msg.ai .msg-bubble table { width: 100%; border-collapse: collapse; margin: 8px 0; font-size: 12px; }
        .msg.ai .msg-bubble th, .msg.ai .msg-bubble td { border: 1px solid var(--border); padding: 8px; text-align: left; }
        .msg.ai .msg-bubble th { background: rgba(255,255,255,0.05); font-weight: 600; }
        
        /* Light theme markdown overrides */
        [data-theme="light"] .msg.ai .msg-bubble h1,
        [data-theme="light"] .msg.ai .msg-bubble h2,
        [data-theme="light"] .msg.ai .msg-bubble h3 {
            color: var(--mode-color);
        }
        [data-theme="light"] .msg.ai .msg-bubble strong { color: #1E293B; }
        [data-theme="light"] .msg.ai .msg-bubble code { background: rgba(0,0,0,0.06); }
        [data-theme="light"] .msg.ai .msg-bubble pre { background: #F1F5F9; }
        
        /* Loading indicator for messages */
        .msg-loading { display: flex; gap: 4px; padding: 8px 0; }
        .msg-loading span { 
            width: 8px; 
            height: 8px; 
            background: var(--mode-color, #10B981); 
            border-radius: 50%; 
            animation: msgBounce 1.4s ease-in-out infinite both;
        }
        .msg-loading span:nth-child(1) { animation-delay: -0.32s; }
        .msg-loading span:nth-child(2) { animation-delay: -0.16s; }
        @keyframes msgBounce {
            0%, 80%, 100% { transform: scale(0.6); opacity: 0.4; }
            40% { transform: scale(1); opacity: 1; }
        }
        
        .msg-head { display: flex; align-items: center; gap: 6px; margin-bottom: 6px; padding-bottom: 6px; border-bottom: 1px solid var(--border); }
        .msg-avatar { width: 18px; height: 18px; border-radius: 50%; background: linear-gradient(135deg, color-mix(in srgb, var(--mode-color) 70%, white), var(--mode-color)); display: flex; align-items: center; justify-content: center; }
        .msg-avatar .icon { width: 8px; height: 8px; color: white; }
        .msg-name { font-size: 10px; font-weight: 600; color: var(--mode-color); }
        .msg-acts { display: none; }
        .msg-act { position: absolute; top: 12px; right: 12px; padding: 6px; background: transparent; border: none; border-radius: 6px; font-size: 9px; color: rgba(255,255,255,0.3); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; opacity: 0; }
        .msg-bubble:hover .msg-act { opacity: 1; }
        .msg-act:hover { background: rgba(255,255,255,0.08); color: rgba(255,255,255,0.7); }
        .msg-act .icon { width: 14px; height: 14px; }

        .chat-input { 
            padding: 12px 14px; 
            padding-bottom: max(12px, env(safe-area-inset-bottom)); 
            flex-shrink: 0; 
            background: var(--bg); 
            position: relative;
            z-index: 10;
        }
        .chat-view.split .chat-input { padding-bottom: 12px; }
        .input-row:focus-within { border-color: var(--mode-border); }
        .input-row.recording { border-color: var(--mode-border); }
        
        .plus-btn { width: 36px; height: 36px; border-radius: 50%; background: rgba(255,255,255,0.06); border: 1px solid var(--border); color: rgba(255,255,255,0.5); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; flex-shrink: 0; z-index: 2; }
        .plus-btn:hover { background: rgba(255,255,255,0.1); color: rgba(255,255,255,0.8); }
        .plus-btn .icon { width: 16px; height: 16px; }
        /* Plus icon color matches mode */
        .panel.copilot .plus-btn .icon { color: var(--copilot); }
        .panel.assistant .plus-btn .icon { color: var(--assistant); }
        
        /* Attach menu - positioned above input row */
        .attach-menu { position: absolute; bottom: 100%; left: 14px; margin-bottom: 4px; background: rgba(20,24,32,0.98); border: 1px solid var(--border); border-radius: 10px; padding: 4px; display: none; flex-direction: column; gap: 2px; min-width: 180px; z-index: 10; box-shadow: 0 4px 20px rgba(0,0,0,0.4); }
        .attach-menu.show { display: flex; }
        .attach-opt { display: flex; align-items: center; gap: 8px; padding: 8px 10px; border-radius: 6px; font-size: 11px; color: rgba(255,255,255,0.7); cursor: pointer; transition: background 0.2s; }
        .attach-opt:hover { background: rgba(255,255,255,0.05); }
        .attach-opt .icon { width: 14px; height: 14px; color: var(--mode-color); }
        
        /* Input area wrapper */
        .input-area { flex: 1; position: relative; min-height: 36px; display: flex; align-items: flex-end; }
        .input-text { width: 100%; background: transparent; border: none; color: white; font-family: inherit; font-size: 13px; line-height: 1.5; outline: none; padding: 8px 10px; position: relative; z-index: 1; resize: none; overflow-y: hidden; min-height: 36px; max-height: 25vh; }
        .input-text::placeholder { color: rgba(255,255,255,0.25); }
        .input-text.scrollable { overflow-y: auto; }
        .input-row.recording .input-text { opacity: 0; pointer-events: none; }
        .input-row.expanded { border-radius: 16px; }
        .input-row { display: flex; align-items: flex-end; gap: 8px; padding: 6px; background: var(--card); border: 1px solid var(--border); border-radius: 24px; transition: border-color 0.2s, border-radius 0.2s; position: relative; }
        
        /* Voice waveform */
        .voice-waveform { position: absolute; left: 0; right: 0; top: 0; bottom: 0; display: flex; align-items: center; justify-content: space-between; padding: 0; opacity: 0; pointer-events: none; transition: opacity 0.3s ease; }
        .input-row.recording .voice-waveform { opacity: 1; }
        .wave-bars { flex: 1; display: flex; align-items: center; justify-content: flex-end; gap: 2px; height: 100%; padding: 0; overflow: hidden; }
        .wave-bar { width: 3px; min-width: 3px; height: 3px; border-radius: 2px; flex-shrink: 0; }
        .voice-waveform.copilot .wave-bar { background: var(--copilot); }
        .voice-waveform.assistant .wave-bar { background: var(--assistant); }
        .voice-timer { font-size: 11px; font-weight: 600; font-variant-numeric: tabular-nums; color: var(--text); min-width: 36px; text-align: right; opacity: 0.7; padding-right: 4px; background: linear-gradient(to right, transparent, var(--card) 20%); padding-left: 12px; }
        
        /* Dynamic action button (mic/send/stop) */
        .action-btn { width: 36px; height: 36px; border-radius: 50%; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: transform 0.2s; flex-shrink: 0; z-index: 2; position: relative; }
        .action-btn.copilot { background: linear-gradient(135deg, var(--copilot), #E55A2B); color: white; }
        .action-btn.assistant { background: linear-gradient(135deg, var(--assistant), #16a34a); color: white; }
        .action-btn:hover { transform: scale(1.05); }
        .action-btn:active { transform: scale(0.95); }
        .action-btn .icon-wrap { position: relative; width: 16px; height: 16px; }
        .action-btn .btn-icon { position: absolute; top: 0; left: 0; width: 16px; height: 16px; transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1); }
        .action-btn .btn-icon svg { width: 16px; height: 16px; }
        .action-btn .mic-icon { opacity: 1; transform: scale(1); }
        .action-btn .send-icon { opacity: 0; transform: scale(0.5) translateY(6px); }
        .action-btn .stop-icon { opacity: 0; transform: scale(0); }
        .action-btn.has-text .mic-icon { opacity: 0; transform: scale(0.5) translateY(-6px); }
        .action-btn.has-text .send-icon { opacity: 1; transform: scale(1) translateY(0); }
        .action-btn.recording .mic-icon { opacity: 0; transform: scale(0); }
        .action-btn.recording .stop-icon { opacity: 1; transform: scale(1); }
        /* Red stop button during recording */
        .action-btn.recording { background: rgb(174, 62, 50) !important; }
        
        /*  TRANSCRIPTION GLASS SPHERE  */
        .action-btn.transcribing { display: none; }
        .transcription-sphere {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            position: relative;
            overflow: hidden;
            flex-shrink: 0;
            z-index: 2;
            display: none;
            animation: sphereGlow 3s ease-in-out infinite;
        }
        .transcription-sphere.active { display: block; }
        @keyframes sphereGlow {
            0%, 100% { box-shadow: 0 0 14px rgba(255,107,53,0.7), 0 0 28px rgba(255,107,53,0.3); }
            25% { box-shadow: 0 0 14px rgba(239,68,68,0.7), 0 0 28px rgba(239,68,68,0.3); }
            50% { box-shadow: 0 0 14px rgba(59,130,246,0.7), 0 0 28px rgba(59,130,246,0.3); }
            75% { box-shadow: 0 0 14px rgba(234,179,8,0.7), 0 0 28px rgba(234,179,8,0.3); }
        }
        .sphere-fog-wrap {
            position: absolute;
            inset: 0;
            border-radius: 50%;
            overflow: hidden;
            background: rgba(20,24,32,0.3);
        }
        .sphere-fog-transcribe {
            position: absolute;
            inset: -50%;
            border-radius: 50%;
            background: radial-gradient(circle at 30% 40%, currentColor, transparent 50%), radial-gradient(circle at 70% 60%, currentColor, transparent 40%);
            filter: blur(3px);
            animation: fogSwirlT 4s ease-in-out infinite, fogColorT 3s ease-in-out infinite;
            opacity: 0.9;
        }
        .sphere-fog-transcribe-2 {
            position: absolute;
            inset: -30%;
            border-radius: 50%;
            background: radial-gradient(circle at 60% 30%, currentColor, transparent 45%);
            filter: blur(3px);
            animation: fogSwirlT2 3s ease-in-out infinite reverse, fogColorT2 3s ease-in-out infinite;
            opacity: 0.7;
        }
        .sphere-highlight {
            position: absolute;
            top: 4px;
            left: 8px;
            width: 8px;
            height: 6px;
            border-radius: 50%;
            background: radial-gradient(circle, rgba(255,255,255,0.5), transparent 70%);
            z-index: 10;
        }
        @keyframes fogSwirlT {
            0% { transform: rotate(0deg) translate(0, 0); }
            25% { transform: rotate(90deg) translate(2px, -2px); }
            50% { transform: rotate(180deg) translate(0, 0); }
            75% { transform: rotate(270deg) translate(-2px, 2px); }
            100% { transform: rotate(360deg) translate(0, 0); }
        }
        @keyframes fogColorT {
            0%, 100% { color: #FF6B35; }
            25% { color: #ef4444; }
            50% { color: #3B82F6; }
            75% { color: #eab308; }
        }
        @keyframes fogSwirlT2 {
            0% { transform: rotate(0deg) scale(0.9); }
            50% { transform: rotate(180deg) scale(1.1); }
            100% { transform: rotate(360deg) scale(0.9); }
        }
        @keyframes fogColorT2 {
            0%, 100% { color: #3B82F6; }
            25% { color: #eab308; }
            50% { color: #FF6B35; }
            75% { color: #ef4444; }
        }
        /*  END TRANSCRIPTION SPHERE  */

        /* DIVIDER */
        .divider { width: 8px; background: var(--border); cursor: col-resize; position: relative; flex-shrink: 0; transition: background 0.2s; display: flex; align-items: center; justify-content: center; touch-action: none; -webkit-user-select: none; user-select: none; }
        .divider:hover, .divider.dragging { background: rgba(255,255,255,0.1); }
        .divider-grip { display: flex; flex-direction: column; gap: 3px; }
        .divider-grip span { width: 3px; height: 3px; background: rgba(255,255,255,0.3); border-radius: 50%; }
        .divider:hover .divider-grip span, .divider.dragging .divider-grip span { background: rgba(255,255,255,0.6); }
        @media (max-width: 767px) { .divider { width: 100%; height: 8px; cursor: row-resize; } .divider-grip { flex-direction: row; } }

        /* PHOTO MODAL */
        .photo-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.7); backdrop-filter: blur(8px); z-index: 600; display: none; align-items: center; justify-content: center; padding: 20px; }
        .photo-modal.active { display: flex; }
        .photo-modal-content { width: 100%; max-width: 300px; background: rgba(20,24,32,0.98); border: 1px solid var(--border); border-radius: 14px; overflow: hidden; }
        .photo-modal-header { padding: 14px; border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 10px; }
        .photo-modal-preview { width: 40px; height: 40px; border-radius: 8px; background: rgba(255,255,255,0.1); display: flex; align-items: center; justify-content: center; }
        .photo-modal-preview .icon { width: 20px; height: 20px; color: var(--copilot); }
        .photo-modal-title { font-size: 13px; font-weight: 600; }
        .photo-modal-sub { font-size: 10px; color: var(--text-dim); margin-top: 2px; }
        .photo-modal-body { padding: 10px; }
        .photo-option { display: flex; align-items: center; gap: 10px; padding: 12px; background: var(--card); border: 1px solid var(--border); border-radius: 10px; cursor: pointer; margin-bottom: 6px; transition: all 0.2s; }
        .photo-option:hover { background: rgba(255,255,255,0.05); }
        .photo-option:last-child { margin-bottom: 0; }
        .photo-option-icon { width: 36px; height: 36px; border-radius: 8px; display: flex; align-items: center; justify-content: center; }
        .photo-option-icon.extract { background: var(--copilot-bg); color: var(--copilot); }
        .photo-option-icon.report { background: var(--assistant-bg); color: var(--assistant); }
        .photo-option-icon .icon { width: 16px; height: 16px; }
        .photo-option-text { flex: 1; }
        .photo-option-title { font-size: 12px; font-weight: 600; margin-bottom: 2px; }
        .photo-option-desc { font-size: 10px; color: var(--text-dim); }
        .photo-modal-footer { padding: 10px 14px 14px; }
        
        /* Photo full preview */
        .photo-full-preview { 
            padding: 0 14px; 
            margin-bottom: 10px;
            display: none;
        }
        .photo-full-preview.has-image { display: block; }
        .photo-full-preview img { 
            width: 100%; 
            max-height: 200px; 
            object-fit: cover; 
            border-radius: 10px; 
            border: 1px solid var(--border);
        }
        .photo-modal-preview.has-image { 
            background: transparent; 
            overflow: hidden;
        }
        .photo-modal-preview.has-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 8px;
        }
        .photo-modal-preview.has-image .icon { display: none; }
        
        /* Send option icon */
        .photo-option-icon.send { background: var(--copilot-bg); }
        .photo-option-icon.send .icon { color: var(--copilot); }
        
        /* Chat images */
        .msg-image { 
            max-width: 100%; 
            border-radius: 12px; 
            cursor: pointer;
            transition: transform 0.2s;
            display: block;
        }
        .msg-image:hover { transform: scale(1.02); }
        
        /* Photo container with delete button */
        .photo-container {
            position: relative;
            display: inline-block;
            max-width: 240px;
        }
        .photo-container .msg-image {
            max-width: 100%;
        }
        .photo-delete {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: rgba(0,0,0,0.6);
            border: none;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.2s;
        }
        .photo-container:hover .photo-delete { opacity: 1; }
        .photo-delete .icon { width: 14px; height: 14px; }
        .photo-delete:hover { background: var(--hotline); }
        
        /* Inline action buttons below photo */
        .photo-actions-inline {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }
        .photo-action-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 12px;
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text);
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }
        .photo-action-btn:hover {
            background: rgba(255,255,255,0.08);
            border-color: rgba(255,255,255,0.15);
        }
        .photo-action-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .photo-action-btn.success {
            background: var(--assistant-bg);
            border-color: var(--assistant-border);
            color: var(--assistant);
        }
        .photo-action-btn .icon { width: 14px; height: 14px; }
        
        /* OCR Quote (linked photo) */
        .ocr-quote {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 10px;
            background: rgba(255,107,53,0.08);
            border-left: 3px solid var(--copilot);
            border-radius: 0 8px 8px 0;
            margin-bottom: 12px;
            cursor: pointer;
            transition: background 0.2s;
        }
        .ocr-quote:hover {
            background: rgba(255,107,53,0.15);
        }
        .ocr-quote-thumb {
            width: 40px;
            height: 40px;
            object-fit: cover;
            border-radius: 6px;
        }
        .ocr-quote-label {
            font-size: 11px;
            color: var(--copilot);
            font-weight: 500;
        }
        .ocr-result {
            font-size: 13px;
            line-height: 1.6;
        }
        .ocr-loading {
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--text-dim);
            font-size: 12px;
        }
        .ocr-spinner {
            width: 16px;
            height: 16px;
            border: 2px solid var(--border);
            border-top-color: var(--copilot);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* 
           OCR EXTRACTION CARD - Compact UI
            */
        
        /* Main OCR card container */
        .ocr-card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 12px;
            overflow: hidden;
            margin-top: 10px;
        }
        
        /* Card header with icon */
        .ocr-card-header {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 14px;
            background: rgba(34, 197, 94, 0.08);
            border-bottom: 1px solid var(--border);
        }
        .ocr-card-header .icon {
            width: 20px;
            height: 20px;
            color: var(--assistant);
        }
        .ocr-card-header-title {
            font-weight: 600;
            font-size: 13px;
            color: var(--text);
        }
        .ocr-card-header-method {
            margin-left: auto;
            font-size: 11px;
            color: var(--text-dim);
            background: var(--bg);
            padding: 3px 8px;
            border-radius: 10px;
        }
        
        /* AI Summary section - prominent */
        .ocr-ai-summary {
            padding: 14px;
            font-size: 13px;
            line-height: 1.6;
            border-bottom: 1px solid var(--border);
        }
        .ocr-ai-summary p {
            margin: 0 0 8px 0;
        }
        .ocr-ai-summary p:last-child {
            margin-bottom: 0;
        }
        .ocr-ai-summary strong {
            color: var(--copilot);
        }
        .ocr-ai-summary ul, .ocr-ai-summary ol {
            margin: 8px 0;
            padding-left: 20px;
        }
        .ocr-ai-summary li {
            margin: 4px 0;
        }
        
        /* Extracted text - scrollable */
        .ocr-raw-section {
            border-top: 1px solid var(--border);
        }
        .ocr-raw-toggle {
            width: 100%;
            padding: 10px 14px;
            background: transparent;
            border: none;
            color: var(--text-dim);
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: all 0.2s;
        }
        .ocr-raw-toggle:hover {
            background: rgba(255,255,255,0.03);
            color: var(--text);
        }
        .ocr-raw-toggle .chevron {
            transition: transform 0.2s;
        }
        .ocr-raw-toggle.open .chevron {
            transform: rotate(180deg);
        }
        .ocr-raw-content {
            display: none;
            max-height: 150px;
            overflow-y: auto;
            padding: 12px 14px;
            background: var(--bg);
            font-family: monospace;
            font-size: 11px;
            line-height: 1.5;
            white-space: pre-wrap;
            word-break: break-word;
            color: var(--text-dim);
        }
        .ocr-raw-content.show {
            display: block;
        }
        
        /* Action buttons in card footer */
        .ocr-card-actions {
            display: flex;
            gap: 8px;
            padding: 10px 14px;
            border-top: 1px solid var(--border);
            background: rgba(0,0,0,0.1);
        }
        
        /* Legacy classes for backward compatibility */
        .ocr-raw-text {
            font-family: monospace;
            font-size: 12px;
            background: var(--card);
            padding: 14px;
            border-radius: 10px;
            margin-top: 10px;
            white-space: pre-wrap;
            word-break: break-word;
            border: 1px solid var(--border);
            line-height: 1.6;
            max-height: 150px;
            overflow-y: auto;
        }
        
        /* OCR section titles */
        .ocr-section-title {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-dim);
            margin: 14px 0 8px 0;
        }
        
        /* OCR structured content from AI */
        .ocr-structured {
            margin-top: 12px;
        }
        .ocr-structured-content {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 14px;
            font-size: 13px;
            line-height: 1.6;
        }
        .ocr-structured-content strong {
            color: var(--copilot);
        }
        
        /* Collapsible raw text */
        .ocr-raw-details {
            margin-top: 12px;
        }
        .ocr-raw-details summary {
            cursor: pointer;
            color: var(--text-dim);
            font-size: 12px;
            padding: 8px 0;
            user-select: none;
        }
        .ocr-raw-details summary:hover {
            color: var(--text);
        }
        .ocr-raw-details[open] summary {
            color: var(--copilot);
        }
        
        /* No text detected */
        .ocr-no-text {
            padding: 16px;
            text-align: center;
            color: var(--text-dim);
        }
        
        /* OCR structured summary */
        .ocr-summary {
            background: rgba(34, 197, 94, 0.08);
            border: 1px solid rgba(34, 197, 94, 0.2);
            border-radius: 10px;
            padding: 14px;
            margin-top: 12px;
        }
        .ocr-summary-title {
            font-size: 12px;
            font-weight: 600;
            color: var(--assistant);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .ocr-summary-grid {
            display: grid;
            grid-template-columns: auto 1fr;
            gap: 6px 12px;
            font-size: 12px;
        }
        .ocr-summary-label {
            color: var(--text-dim);
        }
        .ocr-summary-value {
            font-weight: 500;
            font-family: monospace;
        }
        .ocr-summary-value.error {
            color: var(--hotline);
            font-weight: 700;
        }
        .ocr-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }
        .ocr-action-btn {
            padding: 8px 14px;
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 12px;
            color: var(--text);
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .ocr-action-btn:hover {
            background: rgba(255,255,255,0.08);
        }
        .ocr-action-btn .icon {
            width: 14px;
            height: 14px;
        }
        .ocr-action-btn.error-btn {
            background: rgba(239, 68, 68, 0.15);
            border-color: rgba(239, 68, 68, 0.3);
            color: var(--hotline);
        }
        .ocr-action-btn.error-btn:hover {
            background: rgba(239, 68, 68, 0.25);
        }
        
        /* File attachment style */
        .file-attachment {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 14px;
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 10px;
        }
        .file-icon {
            padding: 6px 8px;
            background: var(--copilot-bg);
            border-radius: 6px;
            font-size: 10px;
            font-weight: 700;
            color: var(--copilot);
        }
        .file-name {
            font-size: 13px;
            color: var(--text);
        }
        
        /* Scroll to bottom button */
        .scroll-bottom-btn {
            position: absolute;
            bottom: 90px;
            left: 50%;
            transform: translateX(-50%);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(30, 35, 44, 0.7);
            backdrop-filter: blur(8px);
            border: 1px solid rgba(255,255,255,0.1);
            color: rgba(255,255,255,0.6);
            cursor: pointer;
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10;
            transition: all 0.2s;
        }
        .scroll-bottom-btn.visible { display: flex; }
        .scroll-bottom-btn:hover { 
            background: rgba(30, 35, 44, 0.9);
            color: var(--text);
            border-color: rgba(255,255,255,0.2);
        }
        .scroll-bottom-btn .icon { 
            width: 18px; 
            height: 18px; 
            transform: rotate(-90deg);
        }
        
        /* Photo name modal (for report) */
        .photo-name-modal {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.8);
            backdrop-filter: blur(8px);
            z-index: 650;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .photo-name-modal.active { display: flex; }
        .photo-name-content {
            width: 100%;
            max-width: 320px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 16px;
            overflow: hidden;
        }
        .photo-name-header {
            padding: 16px;
            border-bottom: 1px solid var(--border);
        }
        .photo-name-title {
            font-size: 15px;
            font-weight: 600;
            margin-bottom: 4px;
        }
        .photo-name-sub {
            font-size: 11px;
            color: var(--text-dim);
        }
        .photo-name-preview {
            padding: 12px;
        }
        .photo-name-preview img {
            width: 100%;
            max-height: 180px;
            object-fit: cover;
            border-radius: 10px;
            border: 1px solid var(--border);
        }
        .photo-name-input-wrap {
            padding: 0 16px 16px;
        }
        .photo-name-input {
            width: 100%;
            padding: 12px 14px;
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 10px;
            color: var(--text);
            font-size: 14px;
            outline: none;
            transition: border-color 0.2s;
        }
        .photo-name-input:focus {
            border-color: var(--assistant);
        }
        .photo-name-input::placeholder {
            color: var(--text-dim);
        }
        .photo-name-actions {
            display: flex;
            gap: 10px;
            padding: 0 16px 16px;
        }
        .photo-name-cancel {
            flex: 1;
            padding: 12px;
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 10px;
            color: var(--text-dim);
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }
        .photo-name-cancel:hover {
            background: rgba(255,255,255,0.05);
        }
        .photo-name-confirm {
            flex: 1.5;
            padding: 12px;
            background: var(--assistant);
            border: none;
            border-radius: 10px;
            color: white;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .photo-name-confirm:hover {
            filter: brightness(1.1);
        }
        
        /* Image loading state */
        .msg-image-loading {
            width: 200px;
            height: 150px;
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-dim);
            font-size: 12px;
        }
        
        /* Image viewer modal */
        .image-viewer {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.95);
            z-index: 700;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .image-viewer.active { display: flex; }
        .image-viewer img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            border-radius: 8px;
        }
        .image-viewer-close {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(255,255,255,0.1);
            border: none;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .image-viewer-close .icon { width: 20px; height: 20px; }
        .photo-cancel { width: 100%; padding: 10px; background: transparent; border: 1px solid var(--border); border-radius: 8px; color: rgba(255,255,255,0.6); font-size: 12px; font-weight: 500; cursor: pointer; transition: all 0.2s; }
        .photo-cancel:hover { background: rgba(255,255,255,0.05); }

        /* REPORT SHEET - Live Preview Drawer */
        .report-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,0.4); z-index: 299; opacity: 0; pointer-events: none; transition: opacity 0.3s; }
        .report-backdrop.show { opacity: 1; pointer-events: auto; }
        .report-sheet { position: fixed; top: 0; right: 0; width: 100%; max-width: 55%; height: 100%; background: var(--bg-secondary); border-left: 1px solid var(--assistant-border); z-index: 300; display: flex; flex-direction: column; transform: translateX(100%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .report-sheet.open { transform: translateX(0); }
        @media (max-width: 900px) { .report-sheet { max-width: 70%; } }
        @media (max-width: 600px) { .report-sheet { max-width: 100%; border-left: none; } }
        .report-header { display: flex; align-items: center; gap: 10px; padding: 12px 14px; padding-top: max(12px, env(safe-area-inset-top)); border-bottom: 1px solid var(--border); flex-shrink: 0; }
        .report-close { width: 28px; height: 28px; border-radius: 50%; background: transparent; border: 1px solid var(--border); color: rgba(255,255,255,0.5); cursor: pointer; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
        .report-close .icon { width: 12px; height: 12px; }
        .report-title { font-size: 14px; font-weight: 600; color: var(--assistant); white-space: nowrap; }
        .report-progress { flex: 1; display: flex; align-items: center; gap: 8px; min-width: 60px; }
        .report-progress-bar { flex: 1; height: 3px; background: rgba(255,255,255,0.1); border-radius: 2px; overflow: hidden; }
        .report-progress-fill { height: 100%; width: 0%; background: #3B82F6; border-radius: 2px; transition: width 0.4s ease; }
        .report-progress-text { font-size: 11px; font-weight: 600; color: #3B82F6; white-space: nowrap; }
        .report-body { flex: 1; overflow-y: auto; padding: 14px; }
        
        /* Live preview container */
        .report-preview-container { min-height: 100%; }
        .report-preview-empty { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 300px; text-align: center; color: var(--text-dim); }
        .report-preview-empty .icon { width: 48px; height: 48px; margin-bottom: 16px; opacity: 0.3; }
        .report-preview-empty p { font-size: 13px; max-width: 250px; line-height: 1.5; }
        
        /* Report preview styles - same as chat report but adapted for drawer */
        .report-body .rpt { font-size: 12px; }
        .report-body .rpt-header { padding: 12px; }
        .report-body .rpt-title { font-size: 14px; }
        .report-body .rpt-section { padding: 12px; }
        .report-body .rpt-label { font-size: 10px; }
        .report-body .rpt-text { font-size: 12px; }
        .report-body .rpt-row { font-size: 11px; }
        
        .r-field { margin-bottom: 12px; }
        .r-label { font-size: 9px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.3px; color: var(--text-dim); margin-bottom: 4px; }
        .r-value { font-size: 13px; padding: 9px 11px; background: var(--card); border: 1px solid var(--border); border-radius: 8px; min-height: 40px; }
        .report-footer { display: flex; gap: 8px; padding: 12px 14px; padding-bottom: max(12px, env(safe-area-inset-bottom)); border-top: 1px solid var(--border); flex-shrink: 0; }
        .r-btn { flex: 1; display: flex; align-items: center; justify-content: center; gap: 6px; padding: 11px; border-radius: 10px; font-size: 12px; font-weight: 600; cursor: pointer; border: none; transition: all 0.2s; }
        .r-btn.primary { background: linear-gradient(135deg, #22c55e, #16a34a); color: white; }
        .r-btn.primary:hover { box-shadow: 0 4px 14px var(--assistant-glow); }
        .r-btn.secondary { background: var(--card); border: 1px solid var(--border); color: rgba(255,255,255,0.6); }
        .r-btn .icon { width: 14px; height: 14px; }

        /* ==================== HOTLINE VIEW ==================== */
        .hotline-view { position: fixed; inset: 0; display: none; z-index: 200; background: var(--bg); background-image: linear-gradient(var(--grid-color) 1px, transparent 1px), linear-gradient(90deg, var(--grid-color) 1px, transparent 1px); background-size: 32px 32px; }
        .hotline-view.active { display: block; }
        .hotline-close { position: absolute; top: max(16px, env(safe-area-inset-top)); right: 16px; width: 40px; height: 40px; border-radius: 50%; background: var(--card); border: 1px solid var(--border); color: rgba(255,255,255,0.5); cursor: pointer; display: flex; align-items: center; justify-content: center; z-index: 300; transition: all 0.2s; }
        .hotline-close:hover { background: rgba(255,255,255,0.08); color: rgba(255,255,255,0.8); }
        .hotline-close .icon { width: 18px; height: 18px; }

        .hotline-widget { width: 100%; padding: 40px 20px; position: absolute; top: 50%; left: 0; right: 0; transform: translateY(-50%); z-index: 100; text-align: center; transition: all 0.8s cubic-bezier(0.4, 0, 0.2, 1); }
        .hotline-widget.chat-mode { top: 10px; transform: translateY(0); padding-top: max(80px, calc(40px + env(safe-area-inset-top))); padding-bottom: 20px; }

        .pulse-sphere { position: relative; width: 140px; height: 140px; margin: 0 auto; cursor: pointer; transition: filter 0.3s ease, width 0.6s ease, height 0.6s ease; filter: drop-shadow(0 4px 20px rgba(239, 68, 68, 0.4)); }
        .pulse-sphere:hover { filter: drop-shadow(0 6px 28px rgba(239, 68, 68, 0.6)); transform: scale(1.03); }
        .pulse-sphere.connected { filter: drop-shadow(0 4px 20px rgba(80, 220, 120, 0.4)); }
        .pulse-sphere.connected:hover { filter: drop-shadow(0 6px 28px rgba(80, 220, 120, 0.6)); }
        .hotline-widget.chat-mode .pulse-sphere { width: 80px; height: 80px; }

        .pulse-atmosphere { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 120%; height: 120%; border-radius: 50%; background: radial-gradient(circle, rgba(239, 68, 68, 0.3) 0%, transparent 70%); filter: blur(8px); animation: atmospherePulse 4s ease-in-out infinite; pointer-events: none; transition: background 0.5s ease, opacity 0.5s ease; }
        .pulse-sphere.connected .pulse-atmosphere { background: radial-gradient(circle, rgba(100, 238, 140, 0.25) 0%, transparent 70%); }
        .pulse-sphere.connecting .pulse-atmosphere, .pulse-sphere.disconnecting .pulse-atmosphere { opacity: 0; }
        @keyframes atmospherePulse { 0%, 100% { opacity: 0.6; transform: translate(-50%, -50%) scale(1); } 50% { opacity: 0.85; transform: translate(-50%, -50%) scale(1.05); } }

        .pulse-ring { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 100%; height: 100%; border: 2.5px solid rgba(239, 68, 68, 0.5); border-radius: 50%; animation: pulseRingExpand 3.5s ease-out infinite; pointer-events: none; transition: opacity 0.5s ease; }
        .pulse-ring:nth-child(2) { animation-delay: 1.2s; }
        .pulse-ring:nth-child(3) { animation-delay: 2.4s; }
        @keyframes pulseRingExpand { 0% { width: 100%; height: 100%; opacity: 0.7; } 100% { width: 200%; height: 200%; opacity: 0; } }
        .pulse-sphere.connected .pulse-ring, .pulse-sphere.connecting .pulse-ring, .pulse-sphere.disconnecting .pulse-ring { opacity: 0 !important; }

        .pulse-core { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 100%; height: 100%; border-radius: 50%; background: linear-gradient(180deg, #ff9988 0%, #ff7766 12%, #ff5544 25%, #ef4444 40%, #dc3333 55%, #cc2222 70%, #bb1111 85%, #991111 100%); box-shadow: 0 0 20px 4px rgba(239, 68, 68, 0.4), 0 8px 30px rgba(0, 0, 0, 0.35), inset 0 -25px 40px rgba(100, 0, 0, 0.5), inset 0 3px 10px rgba(255, 200, 200, 0.3); position: relative; overflow: hidden; }
        .pulse-core::after { content: ''; position: absolute; top: 8%; left: 15%; width: 40%; height: 30%; border-radius: 50%; background: radial-gradient(ellipse at 50% 50%, rgba(255, 255, 255, 0.35) 0%, transparent 70%); pointer-events: none; }
        .pulse-sphere.connected .pulse-core { background: linear-gradient(180deg, #99ffbb 0%, #88ffaa 12%, #77ee99 25%, #66dd88 40%, #55cc77 55%, #44bb66 70%, #33aa55 85%, #229944 100%); box-shadow: 0 0 20px 4px rgba(80, 220, 120, 0.35), 0 8px 30px rgba(0, 0, 0, 0.35), inset 0 -25px 40px rgba(20, 80, 40, 0.5), inset 0 3px 10px rgba(200, 255, 220, 0.25); }
        .pulse-sphere.connecting .pulse-core { animation: pulseLiquidMorph 2.5s cubic-bezier(0.4, 0.0, 0.2, 1) forwards; }
        @keyframes pulseLiquidMorph {
            0% { border-radius: 50%; background: linear-gradient(180deg, #ff9988 0%, #ff7766 12%, #ff5544 25%, #ef4444 40%, #dc3333 55%, #cc2222 70%, #bb1111 85%, #991111 100%); transform: translate(-50%, -50%) rotate(0deg) scale(1); }
            15% { border-radius: 42% 58% 65% 35% / 38% 55% 45% 62%; transform: translate(-50%, -50%) rotate(-5deg) scale(0.92); }
            30% { border-radius: 65% 35% 45% 55% / 55% 35% 65% 45%; transform: translate(-50%, -50%) rotate(8deg) scale(1.08); }
            45% { border-radius: 38% 62% 58% 42% / 62% 48% 52% 38%; transform: translate(-50%, -50%) rotate(-3deg) scale(0.95); }
            60% { border-radius: 58% 42% 35% 65% / 48% 65% 35% 52%; transform: translate(-50%, -50%) rotate(6deg) scale(1.06); background: linear-gradient(180deg, #99ffbb 0%, #88ffaa 12%, #77ee99 25%, #66dd88 40%, #55cc77 55%, #44bb66 70%, #33aa55 85%, #229944 100%); }
            75% { border-radius: 45% 55% 62% 38% / 55% 42% 58% 45%; transform: translate(-50%, -50%) rotate(-2deg) scale(0.97); }
            100% { border-radius: 50%; transform: translate(-50%, -50%) rotate(0deg) scale(1); background: linear-gradient(180deg, #99ffbb 0%, #88ffaa 12%, #77ee99 25%, #66dd88 40%, #55cc77 55%, #44bb66 70%, #33aa55 85%, #229944 100%); }
        }
        .pulse-sphere.disconnecting .pulse-core { animation: pulseLiquidMorphReverse 2.5s cubic-bezier(0.4, 0.0, 0.2, 1) forwards; }
        @keyframes pulseLiquidMorphReverse {
            0% { border-radius: 50%; background: linear-gradient(180deg, #99ffbb 0%, #88ffaa 12%, #77ee99 25%, #66dd88 40%, #55cc77 55%, #44bb66 70%, #33aa55 85%, #229944 100%); transform: translate(-50%, -50%) rotate(0deg) scale(1); }
            100% { border-radius: 50%; background: linear-gradient(180deg, #ff9988 0%, #ff7766 12%, #ff5544 25%, #ef4444 40%, #dc3333 55%, #cc2222 70%, #bb1111 85%, #991111 100%); transform: translate(-50%, -50%) rotate(0deg) scale(1); }
        }

        .pulse-icon { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); display: flex; align-items: center; justify-content: center; gap: 5px; pointer-events: none; transition: opacity 0.3s ease; z-index: 10; }
        .pulse-sphere.connecting .pulse-icon, .pulse-sphere.disconnecting .pulse-icon { opacity: 0; }
        .hotline-widget.chat-mode .pulse-icon { gap: 3px; }
        .voice-bar { width: 6px; background: white; border-radius: 3px; animation: voiceWave 1.2s ease-in-out infinite; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        .voice-bar:nth-child(1) { height: 16px; animation-delay: 0s; }
        .voice-bar:nth-child(2) { height: 32px; animation-delay: 0.1s; }
        .voice-bar:nth-child(3) { height: 48px; animation-delay: 0.2s; }
        .voice-bar:nth-child(4) { height: 32px; animation-delay: 0.3s; }
        .voice-bar:nth-child(5) { height: 16px; animation-delay: 0.4s; }
        .hotline-widget.chat-mode .voice-bar { width: 4px; }
        .hotline-widget.chat-mode .voice-bar:nth-child(1) { height: 10px; }
        .hotline-widget.chat-mode .voice-bar:nth-child(2) { height: 18px; }
        .hotline-widget.chat-mode .voice-bar:nth-child(3) { height: 26px; }
        .hotline-widget.chat-mode .voice-bar:nth-child(4) { height: 18px; }
        .hotline-widget.chat-mode .voice-bar:nth-child(5) { height: 10px; }
        @keyframes voiceWave { 0%, 100% { transform: scaleY(0.5); opacity: 0.7; } 50% { transform: scaleY(1); opacity: 1; } }

        .widget-label { margin-top: 80px; font-size: 18px; font-weight: 600; color: rgba(255,255,255,0.9); text-transform: uppercase; letter-spacing: 2px; transition: all 0.4s ease; }
        .pulse-sphere.connected ~ .widget-label { color: #50dc78; }
        .hotline-widget.chat-mode .widget-label { font-size: 12px; margin-top: 14px; }
        .widget-sublabel { font-size: 13px; color: rgba(255,255,255,0.5); margin-top: 8px; font-weight: 500; transition: all 0.4s ease; }
        .hotline-widget.chat-mode .widget-sublabel { font-size: 10px; margin-top: 4px; }

        .hotline-chat { position: absolute; top: 0; left: 0; right: 0; bottom: 0; display: flex; flex-direction: column; opacity: 0; pointer-events: none; transition: opacity 0.6s ease 0.3s; z-index: 50; }
        .hotline-chat.visible { opacity: 1; pointer-events: auto; }
        .chat-spacer { flex-shrink: 0; height: 280px; transition: height 0.6s ease; }
        .chat-messages-outer { flex: 1; display: flex; justify-content: center; overflow: hidden; padding: 0 16px; -webkit-mask-image: linear-gradient(to bottom, transparent 0%, black 10%, black 100%); mask-image: linear-gradient(to bottom, transparent 0%, black 10%, black 100%); }
        .chat-messages { width: 100%; max-width: 600px; overflow-y: auto; padding: 0 0 100px 0; display: flex; flex-direction: column; gap: 16px; }
        .messages-wrapper { width: 100%; display: flex; flex-direction: column; gap: 16px; padding: 10px 0; }
        .chat-empty { text-align: center; padding: 40px 20px; color: rgba(255,255,255,0.3); font-size: 14px; }

        .hotline-msg { display: flex; flex-direction: column; gap: 6px; max-width: 85%; animation: msgFloat 0.4s ease; }
        @keyframes msgFloat { from { opacity: 0; transform: translateY(16px); } to { opacity: 1; transform: translateY(0); } }
        .hotline-msg.user { align-self: flex-end; align-items: flex-end; }
        .hotline-msg.ai { align-self: flex-start; align-items: flex-start; }
        .msg-label { font-size: 10px; font-weight: 600; text-transform: uppercase; letter-spacing: 1px; padding: 0 8px; color: rgba(255,255,255,0.4); }
        .hotline-msg .msg-bubble { padding: 14px 18px; font-size: 14px; line-height: 1.5; border-radius: 20px; }
        .hotline-msg.ai .msg-bubble { background: rgba(255,255,255,0.06); color: rgba(255,255,255,0.9); border: 1px solid rgba(255,255,255,0.1); border-bottom-left-radius: 6px; }
        .hotline-msg.user .msg-bubble { background: linear-gradient(135deg, #ef4444, #cc2222); color: white; border-bottom-right-radius: 6px; }
        .msg-time { font-size: 10px; padding: 0 8px; color: rgba(255,255,255,0.3); }

        .toggle-chat { position: absolute; bottom: max(24px, env(safe-area-inset-bottom)); left: 50%; transform: translateX(-50%) translateY(100px); display: flex; align-items: center; gap: 10px; padding: 14px 28px; background: rgba(255,255,255,0.08); backdrop-filter: blur(20px); border-radius: 50px; border: 1px solid rgba(255,255,255,0.1); color: rgba(255,255,255,0.9); font-size: 13px; font-weight: 500; cursor: pointer; transition: all 0.4s ease; z-index: 200; opacity: 0; pointer-events: none; }
        .toggle-chat.visible { transform: translateX(-50%) translateY(0); opacity: 1; pointer-events: auto; }
        .toggle-chat:hover { background: rgba(255,255,255,0.12); }
        .toggle-icon { width: 20px; height: 20px; transition: transform 0.3s ease; }
        .toggle-chat.open .toggle-icon { transform: rotate(180deg); }

        /* TOAST */
        .toast { position: fixed; top: max(12px, env(safe-area-inset-top)); left: 50%; transform: translateX(-50%) translateY(-100px); padding: 10px 20px; background: rgba(20,24,32,0.95); border: 1px solid var(--border); border-radius: 8px; font-size: 12px; z-index: 700; transition: transform 0.3s; pointer-events: none; }
        .toast.show { transform: translateX(-50%) translateY(0); pointer-events: auto; }

        @media (max-width: 768px) {
            .pulse-sphere { width: 120px; height: 120px; }
            .voice-bar { width: 5px; }
            .voice-bar:nth-child(1) { height: 12px; }
            .voice-bar:nth-child(2) { height: 24px; }
            .voice-bar:nth-child(3) { height: 36px; }
            .voice-bar:nth-child(4) { height: 24px; }
            .voice-bar:nth-child(5) { height: 12px; }
            .widget-label { font-size: 16px; margin-top: 70px; }
            .hotline-widget.chat-mode .pulse-sphere { width: 60px; height: 60px; }
            .chat-spacer { height: 240px; }
        }

        /* ==================== ONBOARDING ==================== */
        .login-icon-slot { width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; position: relative; flex-shrink: 0; }
        .login-back { width: 32px; height: 32px; border-radius: 50%; background: rgba(255,255,255,0.05); border: none; color: var(--text-dim); cursor: pointer; display: none; align-items: center; justify-content: center; flex-shrink: 0; transition: all 0.2s; }
        .login-back:hover { background: rgba(255,255,255,0.1); color: var(--text); }
        .login-back svg { width: 16px; height: 16px; stroke: currentColor; fill: none; }
        .login-input-container { flex: 1; position: relative; height: 32px; overflow: hidden; }
        .login-input-slider { display: flex; transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1); height: 100%; }
        .login-input-slide { min-width: 100%; display: flex; align-items: center; }
        
        .onboarding-section { display: flex; flex-direction: column; align-items: center; padding: 12px 0 20px 0; }
        .onboarding-section.hidden { display: none; }
        .welcome-section { text-align: center; margin-bottom: 12px; margin-top: 8px; }
        .welcome-text { font-size: 24px; font-weight: 300; }
        .welcome-text strong { font-weight: 700; color: var(--copilot); }
        .welcome-sub { font-size: 13px; color: var(--text-dim); margin-top: 6px; }
        .onboarding-card { background: var(--card); border: 1px solid var(--border); border-radius: 16px; padding: 20px; width: 100%; position: relative; }
        .onboarding-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px; }
        .onboarding-title { font-size: 13px; font-weight: 600; }
        .onboarding-progress { font-size: 11px; color: var(--copilot); }
        .onboarding-steps { display: flex; flex-direction: column; gap: 8px; }
        .onboarding-step { display: flex; align-items: center; gap: 12px; padding: 12px; background: rgba(255,255,255,0.02); border: 1px solid transparent; border-radius: 12px; cursor: pointer; transition: all 0.2s; }
        .onboarding-step:hover { background: rgba(255,255,255,0.05); border-color: var(--border); }
        .onboarding-step.completed { opacity: 0.6; }
        .onboarding-step.completed:hover { opacity: 0.8; }
        .onboarding-step.active { background: rgba(255,107,53,0.08); border-color: rgba(255,107,53,0.2); }
        .onboarding-step.locked { opacity: 0.4; cursor: default; }
        .onboarding-step.locked:hover { background: rgba(255,255,255,0.02); border-color: transparent; }
        .step-check { width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
        .step-check.done { background: var(--assistant); }
        .step-check.done svg { stroke: white; }
        .step-check.pending { background: rgba(255,255,255,0.05); border: 2px solid var(--border); }
        .step-check.current { background: rgba(255,107,53,0.15); border: 2px solid var(--copilot); }
        .step-check svg { width: 12px; height: 12px; stroke: currentColor; fill: none; stroke-width: 2.5; }
        .step-content { flex: 1; display: flex; align-items: center; gap: 10px; }
        .step-title { font-size: 13px; font-weight: 500; }
        .step-divider { width: 1px; height: 16px; background: rgba(255,255,255,0.1); }
        .step-tool { display: flex; align-items: center; gap: 6px; }
        .step-tool-icon { width: 16px; height: 16px; }
        .step-tool-icon.copilot { color: var(--copilot); }
        .step-tool-icon.assistant { color: var(--assistant); }
        .step-tool-name { font-size: 11px; font-weight: 600; }
        .step-tool-name.copilot { color: var(--copilot); }
        .step-tool-name.assistant { color: var(--assistant); }
        .step-arrow { width: 16px; height: 16px; color: rgba(255,255,255,0.3); flex-shrink: 0; }
        .brand-select-inline { display: none; flex-direction: column; gap: 6px; margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border); }
        .brand-select-inline.show { display: flex; }
        .brand-select-option { display: flex; align-items: center; gap: 10px; padding: 10px 12px; background: rgba(255,255,255,0.03); border: 1px solid var(--border); border-radius: 10px; cursor: pointer; transition: all 0.2s; }
        .brand-select-option:hover { background: rgba(255,255,255,0.06); }
        .brand-select-option.selected { background: rgba(34,197,94,0.1); border-color: var(--assistant); }
        .brand-select-name { font-size: 13px; font-weight: 500; flex: 1; }
        .brand-select-dot { width: 8px; height: 8px; border-radius: 50%; background: rgba(255,255,255,0.2); flex-shrink: 0; }
        .brand-select-option.selected .brand-select-dot { background: var(--assistant); box-shadow: 0 0 6px var(--assistant); }
        .congrats-content { display: none; text-align: center; padding: 30px 20px; }
        .onboarding-card.congrats .onboarding-header, .onboarding-card.congrats .onboarding-steps { display: none; }
        .onboarding-card.congrats .congrats-content { display: block; }
        .congrats-close { position: absolute; top: 12px; right: 12px; width: 32px; height: 32px; border-radius: 50%; background: rgba(255,255,255,0.05); border: 1px solid var(--border); color: rgba(255,255,255,0.5); cursor: pointer; display: none; align-items: center; justify-content: center; }
        .congrats-close:hover { background: rgba(255,255,255,0.1); color: var(--text); }
        .congrats-close svg { width: 14px; height: 14px; }
        .onboarding-card.congrats .congrats-close { display: flex; }
        .congrats-icon { font-size: 56px; margin-bottom: 12px; }
        .congrats-title { font-size: 20px; font-weight: 700; margin-bottom: 8px; }
        .congrats-sub { font-size: 13px; color: var(--text-dim); line-height: 1.5; }
        .homepage-content { display: none; }
        .homepage-content.active { display: flex; flex-direction: column; gap: 20px; padding-top: 24px; }
        .homepage-content > * { margin: 0; }
        /* Hide homepage when onboarding is visible - higher specificity */
        .onboarding-section:not(.hidden) ~ .homepage-content.active { display: none !important; }
        .profile-view { position: fixed; inset: 0; display: none; z-index: 200; background: var(--bg); background-image: linear-gradient(var(--grid-color) 1px, transparent 1px), linear-gradient(90deg, var(--grid-color) 1px, transparent 1px); background-size: 32px 32px; flex-direction: column; }
        .profile-view.active { display: flex; }
        .profile-header { display: flex; align-items: center; gap: 12px; padding: 14px 16px; padding-top: max(14px, calc(env(safe-area-inset-top) + 6px)); flex-shrink: 0; border-bottom: 1px solid var(--border); background: var(--bg-secondary); }
        .profile-back { width: 36px; height: 36px; border-radius: 50%; background: var(--card); border: 1px solid var(--border); color: rgba(255,255,255,0.5); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
        .profile-back:hover { background: rgba(255,255,255,0.05); color: rgba(255,255,255,0.8); }
        .profile-back .icon { width: 16px; height: 16px; }
        .profile-info { flex: 1; }
        .profile-title { font-size: 13px; font-weight: 600; color: var(--copilot); }
        .profile-subtitle { font-size: 10px; color: var(--text-dim); }
        .profile-body { flex: 1; overflow-y: auto; padding: 20px 16px; display: flex; flex-direction: column; align-items: center; }
        .profile-form { width: 100%; max-width: var(--content-width); display: flex; flex-direction: column; gap: 16px; }
        .form-group { display: flex; flex-direction: column; gap: 6px; }
        .form-label { font-size: 9px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.3px; color: var(--text-dim); }
        .form-input { padding: 12px 16px; background: var(--card); border: 1px solid var(--border); border-radius: 12px; color: var(--text); font-size: 13px; outline: none; }
        .form-input:focus { border-color: var(--copilot-border); }
        .form-input::placeholder { color: rgba(255,255,255,0.25); }
        .profile-save { width: 100%; padding: 12px; background: linear-gradient(135deg, var(--copilot), #E55A2B); border: none; border-radius: 12px; color: white; font-size: 13px; font-weight: 600; cursor: pointer; margin-top: 8px; }
        .profile-save:hover { box-shadow: 0 4px 14px var(--copilot-glow); }
        
        /* Profile badge - positioned ON the profile icon */
        .nav-profile { position: relative; }
        .nav-profile-badge { position: absolute; top: 2px; left: 50%; transform: translateX(4px); color: #3B82F6; }
        .nav-profile-badge svg { width: 10px; height: 10px; fill: currentColor; stroke: none; }
        
        /* Brand dropdown - ONLY selected has green dot, NO highlight on others */
        .brand-dropdown-item { background: transparent !important; }
        .brand-dropdown-item:hover { background: rgba(255,255,255,0.06) !important; }
        .brand-dropdown-item .brand-dropdown-dot { display: none !important; }
        .brand-dropdown-item .brand-dropdown-check { display: none; }
        .brand-dropdown-item.selected .brand-dropdown-dot { display: block !important; background: var(--assistant) !important; box-shadow: 0 0 6px var(--assistant); }
        .brand-dropdown-item.onboard-selected .brand-dropdown-dot { display: block !important; background: var(--assistant) !important; box-shadow: 0 0 6px var(--assistant); }
        .brand-dropdown-item.active { background: transparent !important; border: none !important; }

        /* ==================== MOBILE-FIRST OPTIMIZATIONS (WAYMO/AIRBNB STYLE) ==================== */
        
        /* Section headers */
        .sec-title { 
            font-size: 13px; 
            font-weight: 600; 
            text-transform: none; 
            letter-spacing: 0; 
            color: var(--text-dim);
        }
        
        /* Larger, more readable cards */
        .toggle-card { 
            padding: 20px 18px; 
            border-radius: 16px;
            min-height: 80px;
        }
        .toggle-card-icon { 
            width: 44px; 
            height: 44px; 
            border-radius: 12px; 
        }
        .toggle-card-icon .icon { width: 22px; height: 22px; }
        .toggle-card-icon .star-icon { width: 24px; height: 24px; }
        .toggle-card-title { font-size: 17px; font-weight: 600; }
        .toggle-card-desc { font-size: 13px; }
        
        /* Project cards - more padding, larger text */
        .proj { 
            padding: 18px 16px; 
            border-radius: 14px;
            gap: 14px;
        }
        .proj-icon { width: 40px; height: 40px; border-radius: 12px; }
        .proj-icon .icon { width: 18px; height: 18px; }
        .proj-icon .star-icon { width: 20px; height: 20px; }
        .proj-title { font-size: 15px; font-weight: 600; margin-bottom: 6px; }
        .proj-meta { font-size: 13px; }
        .proj-time { font-size: 13px; }
        
        /* Brand select row */
        .brand-select-row { 
            padding: 14px 16px; 
            border-radius: 14px;
            gap: 10px;
        }
        .brand-label { font-size: 13px; color: var(--text-dim); font-weight: 500; }
        .brand-chip { 
            padding: 10px 16px; 
            border-radius: 20px; 
            font-size: 14px;
            font-weight: 500;
        }
        
        /* Navigation - larger touch targets but shorter height */
        .nav { padding: 6px 12px; }
        .nav-item { padding: 6px 10px; gap: 3px; }
        .nav-icon { width: 20px; height: 20px; }
        .nav-label { font-size: 10px; font-weight: 600; }
        .nav-hotline { padding: 6px 10px; gap: 3px; }
        .nav-hotline .nav-icon { width: 20px; height: 20px; }
        .nav-hotline-waves { width: 20px; height: 20px; }
        
        /* Activity ring section */
        .activity-value { font-size: 36px; }
        .activity-label { font-size: 10px; letter-spacing: 1.5px; }
        .status-text { font-size: 13px; }
        
        /* Chat messages - larger, more readable */
        .msg-bubble { 
            padding: 14px 18px; 
            border-radius: 18px; 
            font-size: 15px; 
            line-height: 1.6; 
        }
        .msg-head { gap: 8px; margin-bottom: 8px; padding-bottom: 8px; }
        .msg-avatar { width: 22px; height: 22px; }
        .msg-avatar .icon { width: 10px; height: 10px; }
        .msg-name { font-size: 12px; }
        .msg-acts { gap: 6px; margin-top: 8px; }
        .msg-act { 
            padding: 8px 12px; 
            border-radius: 10px; 
            font-size: 11px;
        }
        .msg-act .icon { width: 12px; height: 12px; }
        
        /* Chat input - larger touch targets */
        .input-row { 
            padding: 8px; 
            border-radius: 28px;
            gap: 10px;
        }
        .plus-btn { width: 40px; height: 40px; }
        .plus-btn .icon { width: 18px; height: 18px; }
        .action-btn { width: 40px; height: 40px; }
        .action-btn .icon-wrap { width: 18px; height: 18px; }
        .action-btn .btn-icon { width: 18px; height: 18px; }
        .action-btn .btn-icon svg { width: 18px; height: 18px; }
        .input-text { font-size: 15px; padding: 8px 12px; }
        .input-area { min-height: 40px; }
        
        /* Panel header */
        .panel-header { 
            gap: 10px; 
            padding: 12px 14px; 
        }
        .panel-back { width: 36px; height: 36px; }
        .panel-back .icon { width: 16px; height: 16px; }
        .panel-title { font-size: 15px; }
        .panel-separator { height: 14px; }
        .panel-brand { font-size: 14px; }
        
        /* Mode toggle */
        .mode-toggle { height: 36px; border-radius: 10px; }
        .mode-btn { 
            padding: 0 14px; 
            font-size: 12px;
            gap: 6px;
        }
        .mode-btn .mode-icon { width: 18px; height: 18px; }
        
        /* Header buttons */
        .h-btn { width: 36px; height: 36px; border-radius: 10px; }
        .h-btn .icon { width: 16px; height: 16px; }
        
        /* Header */
        .header-logo-svg { height: 22px; }
        .brand-pill { 
            padding: 8px 14px; 
            border-radius: 20px;
            gap: 8px;
        }
        .brand-pill-dot { width: 10px; height: 10px; }
        .brand-pill-text { font-size: 13px; }
        .brand-pill-arrow { width: 12px; height: 12px; }
        
        /* Brand dropdown */
        .brand-dropdown { 
            min-width: 180px; 
            border-radius: 14px; 
            padding: 8px;
        }
        .brand-dropdown-item { 
            padding: 12px 14px; 
            border-radius: 10px;
            gap: 10px;
        }
        .brand-dropdown-dot { width: 10px; height: 10px; }
        .brand-dropdown-name { font-size: 14px; }
        
        /* Attach menu */
        .attach-menu { 
            border-radius: 14px; 
            padding: 6px;
            min-width: 200px;
        }
        .attach-opt { 
            padding: 12px 14px; 
            border-radius: 10px; 
            font-size: 14px;
            gap: 10px;
        }
        .attach-opt .icon { width: 18px; height: 18px; }
        
        /* Projects page header */
        .projects-page-title { font-size: 22px; font-weight: 700; margin-bottom: 6px; }
        .projects-page-sub { font-size: 14px; }
        
        /* Report sheet */
        .report-sheet { border-radius: 24px 24px 0 0; }
        .report-header { padding: 20px 20px 16px; }
        .report-title { font-size: 18px; }
        .report-close { width: 36px; height: 36px; }
        .report-body { padding: 0 20px 20px; gap: 16px; }
        .report-section { padding: 16px; border-radius: 14px; }
        .report-label { font-size: 12px; margin-bottom: 8px; }
        .report-value { font-size: 15px; }
        .report-actions { gap: 12px; padding: 16px 20px; }
        .report-btn { 
            padding: 16px 24px; 
            border-radius: 14px; 
            font-size: 15px;
            font-weight: 600;
        }
        
        /* Photo modal */
        .photo-preview { border-radius: 16px; }
        .photo-actions { gap: 10px; }
        .photo-btn { 
            padding: 14px 20px; 
            border-radius: 12px; 
            font-size: 14px;
        }
        
        /* Onboarding */
        .onboarding-card { padding: 24px; border-radius: 18px; }
        .onboarding-title { font-size: 15px; }
        .onboarding-progress { font-size: 13px; }
        .onboarding-step { padding: 16px; border-radius: 14px; gap: 14px; }
        .step-number { width: 32px; height: 32px; font-size: 14px; }
        .step-text { font-size: 15px; }
        .step-sub { font-size: 13px; }
        
        /* Toast */
        .toast { 
            padding: 14px 20px; 
            border-radius: 14px; 
            font-size: 14px;
        }
        
        /* Login */
        .login-title { font-size: 26px; }
        .login-sub { font-size: 14px; margin-bottom: 36px; }
        .login-bar { border-radius: 44px; padding: 6px 6px 6px 10px; }
        .login-input { font-size: 15px; padding: 10px; }
        .login-btn { width: 38px; height: 38px; }
        .login-btn .icon { width: 14px; height: 14px; }
        
        /* Spacing adjustments */
        .home, .projects-page { 
            padding: 20px; 
            gap: 24px; 
        }
        .modules-toggle { gap: 14px; }
        .projects { gap: 12px; }
        .projects-list { gap: 12px; }
        .chat-body { padding: 16px; gap: 12px; }
        .chat-input { padding: 14px 16px; }
        
        /* Diagnostic/Assistant specific cards */
        .diag-card { 
            padding: 18px; 
            border-radius: 16px;
        }
        
        /* Better scrolling */
        .app-content { 
            -webkit-overflow-scrolling: touch;
            scroll-behavior: smooth;
        }
        .chat-body {
            -webkit-overflow-scrolling: touch;
            scroll-behavior: smooth;
        }
        .projects-list {
            -webkit-overflow-scrolling: touch;
            scroll-behavior: smooth;
        }

        /* ==================== MOBILE SPECIFIC FIXES ==================== */
        @media (max-width: 767px) {
            /* SAFARI & CHROME FIX */
            html, body { 
                overflow: hidden !important;
                width: 100% !important;
                height: 100% !important;
                min-height: 100% !important;
                max-height: 100% !important;
                position: fixed !important;
                top: 0 !important;
                left: 0 !important;
                right: 0 !important;
                bottom: 0 !important;
                -webkit-text-size-adjust: 100%;
            }
            
            /* App wrapper fills entire viewport */
            .app-wrapper {
                position: fixed !important;
                top: 0 !important;
                left: 0 !important;
                right: 0 !important;
                bottom: 0 !important;
                overflow: hidden !important;
                background: var(--bg) !important;
            }
            
            /* Chat view - FULL SCREEN (nav is hidden) */
            .chat-view {
                position: fixed !important;
                top: 0 !important;
                left: 0 !important;
                right: 0 !important;
                bottom: 0 !important;
                height: 100% !important;
                overflow: hidden !important;
            }
            
            /* Panel - fill available space */
            .panel {
                flex: 1;
                min-height: 0;
                display: flex;
                flex-direction: column;
                overflow: hidden;
            }
            
            /* Chat body - fill remaining space */
            .chat-body {
                flex: 1;
                min-height: 0;
                overflow-y: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            /* Chat input - CRITICAL: Add safe area padding for Safari bottom bar */
            .chat-input {
                flex-shrink: 0;
                padding: 12px 16px;
                padding-bottom: calc(16px + env(safe-area-inset-bottom, 20px));
                background: var(--bg);
            }
            
            /* Split view on mobile - stack vertically */
            .chat-view.split {
                flex-direction: column;
            }
            .chat-view.split .panel {
                flex: 1 1 auto;
                min-height: 20%;
                max-height: 80%;
                overflow: hidden;
            }
            .chat-view.split .chat-input {
                padding-bottom: 8px;
            }
            .chat-view.split .panel:last-child .chat-input {
                padding-bottom: calc(16px + env(safe-area-inset-bottom, 20px));
            }
            .chat-view.split .divider {
                z-index: 10;
            }
            
            /* Hide homepage content during onboarding */
            .onboarding-section:not(.hidden) ~ .homepage-content,
            .onboarding-section:not(.hidden) ~ .homepage-content.active {
                display: none !important;
            }
            
            /* Full width layout - remove max-width constraints */
            .header-inner { max-width: 100%; }
            .home, .projects-page { 
                max-width: 100%; 
                padding: 16px;
                padding-bottom: 0; /* Let projects-list handle the padding */
            }
            
            /* Projects page mobile - full height scroll with fade effect */
            /* Only apply these styles when projects-page is active */
            .projects-page.active {
                height: 100%;
                display: flex;
                flex-direction: column;
                position: relative;
            }
            .projects-page-header {
                background: transparent;
                position: sticky;
                top: 0;
                z-index: 10;
                padding-bottom: 12px;
            }
            .projects-page-header::after {
                content: '';
                position: absolute;
                left: -16px;
                right: -16px;
                bottom: -50px;
                height: 50px;
                background: linear-gradient(to bottom, var(--bg) 0%, var(--bg) 20%, transparent 100%);
                pointer-events: none;
                z-index: 9;
            }
            .projects-list {
                flex: 1;
                overflow-y: auto;
                padding-top: 10px;
                padding-bottom: calc(90px + env(safe-area-inset-bottom, 20px)); /* Space for nav + extra */
                margin-left: -16px;
                margin-right: -16px;
                padding-left: 16px;
                padding-right: 16px;
                /* Hide scrollbar completely */
                scrollbar-width: none;
                -ms-overflow-style: none;
            }
            .projects-list::-webkit-scrollbar {
                display: none;
            }
            
            /* NAV - only visible on home/projects/profile (hidden in chat via CSS selector) */
            .nav {
                position: fixed !important;
                left: 8px !important;
                right: 8px !important;
                bottom: env(safe-area-inset-bottom, 0px) !important;
                transform: none !important;
                width: auto !important;
                max-width: none !important;
                padding-bottom: 10px !important;
                z-index: 99999 !important;
                min-height: 70px;
            }
            .nav-inner { max-width: 100%; }
            
            /* Brand chips - single line, horizontal scroll */
            .brand-select-row { 
                flex-wrap: nowrap !important; 
                overflow-x: auto;
                overflow-y: hidden;
                -webkit-overflow-scrolling: touch;
                scrollbar-width: none;
                -ms-overflow-style: none;
                padding: 12px 14px;
            }
            .brand-select-row::-webkit-scrollbar { display: none; }
            .brand-label { flex-shrink: 0; }
            .brand-chip { flex-shrink: 0; white-space: nowrap; }
            
            /* Chat header - hide title and brand name on mobile */
            .panel-title { display: none !important; }
            .panel-separator { display: none !important; }
            .panel-brand { display: none !important; }
            
            /* Adjust panel-info when its contents are hidden */
            .panel-info { 
                display: none !important;
            }
            
            /* Panel header layout - centered toggle */
            .panel-header {
                gap: 12px;
            }
            
            /* Mode toggle - keep original style, centered */
            .mode-toggle {
                height: 32px;
                flex-shrink: 0;
                margin: 0 auto 0 0;
            }
            .mode-btn {
                padding: 0 10px;
                font-size: 11px;
            }
            .mode-btn .mode-icon { width: 14px; height: 14px; }
            
            /* Toggle cards - horizontal layout within stacked cards on mobile */
            .modules-toggle {
                flex-direction: column;
                gap: 12px;
            }
            .toggle-card {
                flex-direction: row;
                align-items: center;
                text-align: left;
                padding: 20px 16px;
                gap: 14px;
                min-height: auto;
            }
            .toggle-card-icon {
                margin: 0;
                flex-shrink: 0;
            }
            .toggle-card-content {
                display: flex;
                flex-direction: column;
                align-items: flex-start;
                flex: 1;
            }
            .toggle-card-title {
                font-size: 16px;
            }
            .toggle-card-desc {
                font-size: 12px;
            }
            .toggle-card-arrow {
                display: block;
            }
            
            /* Report sheet full width and same padding */
            .report-sheet { 
                max-width: 100% !important; 
                border-radius: 0 !important;
            }
            .report-body { padding: 0 16px 16px; }
            .report-actions { padding: 16px; }
            
            /* Ensure all cards fit within viewport */
            .toggle-card, .proj, .brand-select-row, .onboarding-card {
                max-width: 100%;
                box-sizing: border-box;
            }
            
            /* Chat bubbles - wider on mobile */
            .chat-body {
                width: 100%;
                padding: 14px;
            }
            .msg {
                max-width: 90% !important;
                min-width: 60px;
            }
            .msg.user {
                max-width: 90% !important;
            }
            .msg-bubble { 
                max-width: 100%; 
                word-wrap: break-word;
                overflow-wrap: break-word;
            }
            
            /* Activity section contained */
            .activity-section { 
                max-width: 100%; 
                overflow: hidden;
            }
        }
        
        /* 
           REPORT TEMPLATE V2 - Beautiful Structured Reports
         */
        .rpt { max-width: 100%; margin-top: 8px; }
        .rpt-header { margin-bottom: 16px; padding-bottom: 12px; border-bottom: 1px solid var(--border); }
        .rpt-header-top { display: flex; justify-content: space-between; align-items: flex-start; gap: 12px; margin-bottom: 10px; }
        .rpt-brand { font-size: 10px; font-weight: 600; text-transform: uppercase; letter-spacing: 1.2px; margin-bottom: 4px; }
        .rpt-brand.mitsubishi { color: #E60012; }
        .rpt-brand.daikin { color: #00A0E4; }
        .rpt-brand.carrier { color: #0033A0; }
        .rpt-brand.lg { color: #A50034; }
        .rpt-brand.samsung { color: #1428A0; }
        .rpt-brand.panasonic { color: #0F58A8; }
        .rpt-brand.toshiba { color: #FF0000; }
        .rpt-brand.fujitsu { color: #E60012; }
        .rpt-brand.hitachi { color: #E60012; }
        .rpt-brand.general { color: var(--assistant); }
        .rpt-title { font-size: 18px; font-weight: 600; color: var(--text); letter-spacing: -0.3px; }
        .rpt-status { display: flex; align-items: center; gap: 5px; padding: 5px 10px; border-radius: 6px; white-space: nowrap; flex-shrink: 0; }
        .rpt-status.conforme { background: rgba(34,197,94,0.12); }
        .rpt-status.non-conforme { background: rgba(239,68,68,0.1); }
        .rpt-status.en-cours { background: rgba(245,158,11,0.12); }
        .rpt-status-dot { width: 5px; height: 5px; border-radius: 50%; }
        .rpt-status.conforme .rpt-status-dot { background: #22c55e; }
        .rpt-status.conforme .rpt-status-text { color: #22c55e; }
        .rpt-status.non-conforme .rpt-status-dot { background: #ef4444; }
        .rpt-status.non-conforme .rpt-status-text { color: #ef4444; }
        .rpt-status.en-cours .rpt-status-dot { background: #f59e0b; }
        .rpt-status.en-cours .rpt-status-text { color: #f59e0b; }
        .rpt-status-text { font-size: 10px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.3px; }
        .rpt-meta { display: flex; flex-wrap: wrap; gap: 6px 14px; font-size: 11px; color: var(--text-dim); }
        .rpt-meta .val { color: rgba(255,255,255,0.65); font-weight: 500; }
        
        .rpt-card { background: rgba(255,255,255,0.02); border: 1px solid var(--border); border-radius: 14px; overflow: hidden; }
        .rpt-section { padding: 14px 16px; border-bottom: 1px solid rgba(255,255,255,0.04); }
        .rpt-section:last-child { border-bottom: none; }
        .rpt-label { font-size: 9px; font-weight: 600; color: var(--text-dim); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px; }
        
        .rpt-text { font-size: 13px; color: rgba(255,255,255,0.7); line-height: 1.6; }
        .rpt-text strong { color: #ef4444; font-weight: 600; }
        .rpt-text.success strong { color: #22c55e; }
        
        .rpt-grid { display: grid; grid-template-columns: 1fr; gap: 14px; }
        .rpt-group { display: flex; flex-direction: column; gap: 5px; }
        
        /* Row layout: Label: Value (inline, value immediately after label) */
        .rpt-row { display: flex; align-items: baseline; padding-bottom: 5px; border-bottom: 1px solid rgba(255,255,255,0.04); gap: 0; flex-wrap: wrap; }
        .rpt-row:last-child { border-bottom: none; padding-bottom: 0; }
        .rpt-row-label { font-size: 11px; color: var(--text-dim); flex-shrink: 0; }
        .rpt-row-label::after { content: ' : '; white-space: pre; }
        .rpt-row-value { font-size: 12px; color: var(--text); font-weight: 500; word-break: break-word; }
        .rpt-row-value.mono { font-family: 'SF Mono', Monaco, monospace; font-size: 11px; }
        .rpt-row-value.error { color: #ef4444; }
        .rpt-row-value.success { color: #22c55e; }
        
        /* Checklist styles (travaux effectus) - single icon, aligned */
        .rpt-checklist { list-style: none; margin: 0; padding: 0; display: flex; flex-direction: column; gap: 4px; }
        .rpt-checklist li { display: flex; align-items: flex-start; gap: 10px; font-size: 12px; color: rgba(255,255,255,0.8); line-height: 1.5; padding: 8px 12px; background: rgba(255,255,255,0.03); border-radius: 6px; }
        .rpt-checklist li .check-icon { flex-shrink: 0; width: 18px; height: 18px; display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: 700; border-radius: 50%; }
        .rpt-checklist li.done .check-icon { background: rgba(34,197,94,0.15); color: #22c55e; }
        .rpt-checklist li.error .check-icon { background: rgba(239,68,68,0.15); color: #ef4444; }
        .rpt-checklist li.pending .check-icon { background: rgba(245,158,11,0.15); color: #f59e0b; }
        
        .rpt-measures { display: flex; flex-direction: column; gap: 5px; }
        .rpt-measure { background: rgba(255,255,255,0.03); border-radius: 8px; padding: 10px 12px; display: flex; justify-content: space-between; align-items: center; }
        .rpt-measure .measure-label { font-size: 11px; color: rgba(255,255,255,0.7); }
        .rpt-measure .measure-value { font-size: 12px; font-weight: 600; font-family: 'SF Mono', Monaco, monospace; color: var(--text); }
        .rpt-measure.ok .measure-value { color: #22c55e; }
        .rpt-measure.error .measure-value { color: #ef4444; }
        .rpt-measure-info { display: flex; flex-direction: column; gap: 1px; }
        .rpt-measure-name { font-size: 11px; color: rgba(255,255,255,0.7); font-weight: 500; }
        .rpt-measure-note { font-size: 10px; color: var(--text-dim); }
        .rpt-measure-note.ok { color: #22c55e; }
        .rpt-measure-note.error { color: #ef4444; }
        .rpt-measure-val { font-size: 13px; font-weight: 600; font-family: 'SF Mono', Monaco, monospace; }
        .rpt-measure-val.ok { color: #22c55e; }
        .rpt-measure-val.error { color: #ef4444; }
        .rpt-measure-val.neutral { color: var(--text); }
        
        .rpt-list { display: flex; flex-direction: column; gap: 2px; }
        .rpt-item { display: flex; align-items: flex-start; gap: 10px; padding: 9px 12px; background: rgba(255,255,255,0.03); border-radius: 6px; }
        .rpt-item:first-child { border-radius: 6px 6px 2px 2px; }
        .rpt-item:last-child { border-radius: 2px 2px 6px 6px; }
        .rpt-item:only-child { border-radius: 6px; }
        .rpt-icon { width: 14px; height: 14px; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0; font-size: 8px; font-weight: 700; margin-top: 2px; }
        .rpt-icon.done { background: rgba(34,197,94,0.12); color: #22c55e; }
        .rpt-icon.pending { background: rgba(245,158,11,0.12); color: #f59e0b; }
        .rpt-icon.error { background: rgba(239,68,68,0.1); color: #ef4444; }
        .rpt-icon.num { background: rgba(255,255,255,0.03); color: rgba(255,255,255,0.6); border: 1px solid var(--border); font-size: 9px; }
        .rpt-item-text { font-size: 12px; color: rgba(255,255,255,0.7); line-height: 1.5; }
        
        /* Alert/Reserve styles - left bar only, no background */
        .rpt-alerts { display: flex; flex-direction: column; gap: 14px; margin-top: 8px; }
        .rpt-alert { padding: 0 0 0 12px; border-left: 3px solid #ef4444; }
        .rpt-alert.warning { border-left-color: #f59e0b; }
        .rpt-alert.info { border-left-color: #3b82f6; }
        .rpt-alert.success { border-left-color: #22c55e; }
        .rpt-alert strong { display: block; font-size: 12px; font-weight: 600; color: #ef4444; margin-bottom: 4px; }
        .rpt-alert.warning strong { color: #f59e0b; }
        .rpt-alert.info strong { color: #3b82f6; }
        .rpt-alert.success strong { color: #22c55e; }
        .rpt-alert p { font-size: 12px; color: rgba(255,255,255,0.7); line-height: 1.5; margin: 0; }
        .rpt-alert-title { font-size: 12px; font-weight: 600; color: #ef4444; margin-bottom: 4px; }
        .rpt-alert.warning .rpt-alert-title { color: #f59e0b; }
        .rpt-alert.info .rpt-alert-title { color: #3b82f6; }
        .rpt-alert.success .rpt-alert-title { color: #22c55e; }
        .rpt-alert-text { font-size: 12px; color: rgba(255,255,255,0.7); line-height: 1.5; }
        
        /* Result box */
        .rpt-result { display: flex; align-items: flex-start; gap: 12px; padding: 14px; border-radius: 8px; background: rgba(34,197,94,0.08); }
        .rpt-result.resolved { background: rgba(34,197,94,0.08); }
        .rpt-result.unresolved { background: rgba(239,68,68,0.08); }
        .rpt-result .result-icon { width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 700; background: rgba(34,197,94,0.2); color: #22c55e; flex-shrink: 0; }
        .rpt-result.unresolved .result-icon { background: rgba(239,68,68,0.2); color: #ef4444; }
        .rpt-result .result-label { font-size: 13px; font-weight: 600; color: #22c55e; }
        .rpt-result.unresolved .result-label { color: #ef4444; }
        .rpt-result .result-desc { font-size: 11px; color: rgba(255,255,255,0.6); margin-top: 4px; }
        
        .rpt-table { background: rgba(255,255,255,0.03); border-radius: 8px; overflow: hidden; margin-bottom: 10px; }
        .rpt-table:last-child { margin-bottom: 0; }
        .rpt-table-title { font-size: 10px; font-weight: 600; color: var(--text-dim); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px; }
        .rpt-th { display: grid; padding: 7px 10px; background: rgba(255,255,255,0.02); border-bottom: 1px solid rgba(255,255,255,0.04); justify-content: start; }
        .rpt-th span { font-size: 9px; font-weight: 600; color: var(--text-dim); text-transform: uppercase; letter-spacing: 0.3px; text-align: left; }
        .rpt-tr { display: grid; padding: 7px 10px; border-bottom: 1px solid rgba(255,255,255,0.04); justify-content: start; }
        .rpt-tr:last-child { border-bottom: none; }
        .rpt-tr span { font-size: 11px; color: rgba(255,255,255,0.7); overflow: hidden; text-overflow: ellipsis; text-align: left; }
        .rpt-tr span.mono { font-family: 'SF Mono', Monaco, monospace; font-size: 10px; color: var(--text); }
        .rpt-tr span.ok { color: #22c55e; font-weight: 500; }
        .rpt-tr span.err { color: #ef4444; font-weight: 500; }
        .rpt-tr span.warn { color: #f59e0b; font-weight: 500; }
        /* Table columns - all aligned left together */
        .rpt-cols-3 { grid-template-columns: 50px minmax(150px, auto) 50px; gap: 12px; }
        .rpt-cols-4 { grid-template-columns: 40px minmax(120px, auto) 70px 50px; gap: 12px; }
        .rpt-cols-5 { grid-template-columns: 40px minmax(120px, auto) 80px 50px 50px; gap: 12px; }
        
        .rpt-photos { display: grid; grid-template-columns: repeat(2, 1fr); gap: 6px; }
        .rpt-photo { position: relative; aspect-ratio: 4/3; border-radius: 8px; overflow: hidden; background: rgba(255,255,255,0.03); }
        .rpt-photo img { width: 100%; height: 100%; object-fit: cover; }
        .rpt-photo.full { grid-column: span 2; aspect-ratio: 16/9; }
        .rpt-photo-cap { position: absolute; bottom: 0; left: 0; right: 0; padding: 6px 8px; background: linear-gradient(transparent, rgba(0,0,0,0.8)); font-size: 10px; color: white; }
        
        .rpt-result { margin-bottom: 10px; }
        .rpt-result-status { font-size: 14px; line-height: 1.4; margin-bottom: 4px; }
        .rpt-result-status .err { color: #ef4444; font-weight: 600; }
        .rpt-result-status .ok { color: #22c55e; font-weight: 600; }
        .rpt-result-status .lbl { color: var(--text); font-weight: 500; }
        .rpt-result-desc { font-size: 12px; color: var(--text-dim); line-height: 1.5; }
        
        .rpt-sigs { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .rpt-sig { background: rgba(255,255,255,0.03); border-radius: 8px; padding: 10px; }
        .rpt-sig-label { font-size: 10px; color: var(--text-dim); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px; }
        .rpt-sig-line { height: 36px; border-bottom: 1px dashed var(--border); margin-bottom: 6px; }
        .rpt-sig-name { font-size: 11px; color: rgba(255,255,255,0.65); }
        .rpt-sig-date { font-size: 10px; color: var(--text-dim); }
        
        .rpt-footer { display: flex; justify-content: space-between; align-items: center; padding: 12px 14px; background: rgba(255,255,255,0.03); gap: 10px; flex-wrap: wrap; }
        .rpt-tech { display: flex; align-items: center; gap: 10px; }
        .rpt-avatar { width: 30px; height: 30px; border-radius: 50%; background: linear-gradient(135deg, var(--assistant), #16a34a); display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 10px; color: white; flex-shrink: 0; }
        .rpt-tech-name { font-size: 12px; font-weight: 500; color: var(--text); }
        .rpt-tech-time { font-size: 10px; color: var(--text-dim); }
        .rpt-actions { display: flex; gap: 6px; }
        .rpt-btn { padding: 7px 12px; border-radius: 6px; font-size: 11px; font-weight: 500; cursor: pointer; border: none; transition: all 0.2s; }
        .rpt-btn.primary { background: var(--assistant); color: white; }
        .rpt-btn.secondary { background: transparent; color: rgba(255,255,255,0.6); border: 1px solid var(--border); }
        .rpt-btn:hover { opacity: 0.9; }
        
        @media (min-width: 500px) {
            .rpt-grid { grid-template-columns: 1fr 1fr; }
            .rpt-measures { flex-direction: row; flex-wrap: wrap; }
            .rpt-measure { flex: 1; min-width: 110px; }
            .rpt-photos { grid-template-columns: repeat(3, 1fr); }
            .rpt-photo.full { grid-column: span 3; }
        }
        
        /* Light theme report */
        [data-theme="light"] .rpt-card { background: #f8fafc; border-color: rgba(0,0,0,0.06); }
        [data-theme="light"] .rpt-section { border-color: rgba(0,0,0,0.04); }
        [data-theme="light"] .rpt-text { color: #374151; }
        [data-theme="light"] .rpt-row { border-color: rgba(0,0,0,0.04); }
        [data-theme="light"] .rpt-row-value { color: #1f2937; }
        [data-theme="light"] .rpt-measure { background: rgba(0,0,0,0.02); }
        [data-theme="light"] .rpt-measure-name { color: #374151; }
        [data-theme="light"] .rpt-item { background: rgba(0,0,0,0.02); }
        [data-theme="light"] .rpt-item-text { color: #374151; }
        [data-theme="light"] .rpt-alert-text { color: #4b5563; }
        [data-theme="light"] .rpt-table { background: rgba(0,0,0,0.02); }
        [data-theme="light"] .rpt-tr span { color: #374151; }
        [data-theme="light"] .rpt-photo { background: rgba(0,0,0,0.03); }
        [data-theme="light"] .rpt-sig { background: rgba(0,0,0,0.02); }
        [data-theme="light"] .rpt-footer { background: rgba(0,0,0,0.02); }
        [data-theme="light"] .rpt-tech-name { color: #1f2937; }
        
        /*  */
        /* CELEBRATION ANIMATIONS - CONFETTI & COUNT-UP */
        /*  */
        
        .celebration-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
            z-index: 9999;
            overflow: hidden;
        }
        
        .confetti-particle {
            position: absolute;
            top: -20px;
            border-radius: 2px;
            opacity: 0;
            animation: confetti-fall var(--duration, 3s) ease-in var(--delay, 0s) forwards;
        }
        
        @keyframes confetti-fall {
            0% {
                transform: translateY(0) translateX(0) rotate(0deg);
                opacity: 1;
            }
            70% {
                opacity: 1;
            }
            100% {
                transform: translateY(120vh) translateX(var(--wobble, 0px)) rotate(720deg);
                opacity: 0;
            }
        }
        
        .plus-one-floating {
            position: fixed;
            top: 35%;
            left: 50%;
            transform: translateX(-50%);
            font-size: 64px;
            font-weight: 800;
            color: #22C55E;
            text-shadow: 0 0 40px rgba(34, 197, 94, 0.8), 0 0 80px rgba(34, 197, 94, 0.4);
            z-index: 10000;
            pointer-events: none;
            animation: float-up-fade 1.8s ease-out forwards;
        }
        
        @keyframes float-up-fade {
            0% {
                transform: translateX(-50%) translateY(0) scale(0.3);
                opacity: 0;
            }
            15% {
                transform: translateX(-50%) translateY(-20px) scale(1.2);
                opacity: 1;
            }
            100% {
                transform: translateX(-50%) translateY(-100px) scale(0.9);
                opacity: 0;
            }
        }
        
        .stats-ring-progress.animating {
            filter: drop-shadow(0 0 25px rgba(234, 88, 12, 0.9)) !important;
        }
    </style>
    
    <!-- Supabase Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <!-- jsPDF for PDF export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>
    <!-- App wrapper to contain everything and prevent gaps -->
    <div class="app-wrapper">
    
    <!-- SVG DEFS -->
    <svg style="position:absolute;width:0;height:0;">
        <defs>
            <linearGradient id="coldGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                <stop offset="0%" stop-color="#7D40FF"/>
                <stop offset="100%" stop-color="#02A4FF"/>
            </linearGradient>
            <linearGradient id="warmGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                <stop offset="0%" stop-color="#FF9966"/>
                <stop offset="100%" stop-color="#FF6B35"/>
            </linearGradient>
            <linearGradient id="hotGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                <stop offset="0%" stop-color="#4ade80"/>
                <stop offset="100%" stop-color="#22c55e"/>
            </linearGradient>
            
            <symbol id="icon-air" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9.59 4.59A2 2 0 1 1 11 8H2m10.59 11.41A2 2 0 1 0 14 16H2m15.73-8.27A2.5 2.5 0 1 1 19.5 12H2"/></symbol>
            <symbol id="icon-star" viewBox="0 0 200 200"><path d="M100.2 0C101.792 25.9476 98.6996 63.9402 117.082 82.3225C135.464 100.705 174.052 98.2076 200 99.8V100.2C174.051 101.79 135.763 98.9969 117.38 117.38C98.997 135.763 101.79 174.051 100.2 200H99.8C98.2103 174.051 100.109 136.06 81.7264 117.678C63.3436 99.2949 25.9485 101.79 0 100.2V99.8C25.9476 98.2076 63.6424 100.406 82.0246 82.0242C100.407 63.642 98.2076 25.9476 99.8 0H100.2Z" fill="currentColor"/></symbol>
            <symbol id="icon-home" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12H3l9-9 9 9h-2M5 12v7a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2v-7"/><path d="M9 21v-6a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v6"/></symbol>
            <symbol id="icon-folder" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/></symbol>
            <symbol id="icon-phone" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72c.127.96.361 1.903.7 2.81a2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45c.907.339 1.85.573 2.81.7A2 2 0 0 1 22 16.92z"/></symbol>
            <symbol id="icon-user" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></symbol>
            <symbol id="icon-mic" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/></symbol>
            <symbol id="icon-plus" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></symbol>
            <symbol id="icon-camera" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></symbol>
            <symbol id="icon-image" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></symbol>
            <symbol id="icon-paperclip" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"/></symbol>
            <symbol id="icon-search" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></symbol>
            <symbol id="icon-arrow-left" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></symbol>
            <symbol id="icon-arrow-right" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/></symbol>
            <symbol id="icon-x" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></symbol>
            <symbol id="icon-check" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></symbol>
            <symbol id="icon-copy" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></symbol>
            <symbol id="icon-clipboard" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><rect x="8" y="2" width="8" height="4" rx="1" ry="1"/></symbol>
            <symbol id="icon-columns" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><line x1="12" y1="3" x2="12" y2="21"/></symbol>
            <symbol id="icon-download" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></symbol>
            <symbol id="icon-send" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></symbol>
            <symbol id="icon-share" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/></symbol>
            <symbol id="icon-fixair-logo" viewBox="0 0 235 48"><path d="M35.1986 6.4H17.4706C15.4226 6.4 13.5666 6.912 11.9026 7.936C10.2386 8.96 8.89463 10.3253 7.87063 12.032C6.88929 13.696 6.39863 15.552 6.39863 17.6V48H-0.00137472V16C-0.00137472 13.7387 0.467959 11.648 1.40663 9.728C2.34529 7.76533 3.62529 6.08 5.24663 4.672C6.91063 3.22133 8.78796 2.09067 10.8786 1.28C12.9693 0.426664 15.1666 -3.8147e-06 17.4706 -3.8147e-06H35.1986V6.4ZM48.8306 4.8C48.8306 6.12266 48.3613 7.25333 47.4226 8.192C46.484 9.13066 45.3533 9.6 44.0306 9.6C42.708 9.6 41.5773 9.13066 40.6386 8.192C39.7 7.25333 39.2306 6.12266 39.2306 4.8C39.2306 3.47733 39.7 2.34666 40.6386 1.408C41.5773 0.46933 42.708 -3.8147e-06 44.0306 -3.8147e-06C45.3533 -3.8147e-06 46.484 0.46933 47.4226 1.408C48.3613 2.34666 48.8306 3.47733 48.8306 4.8ZM47.2306 48H40.8306V22.4H9.59863V16H47.2306V48ZM97.7161 48H88.5641L74.8681 34.752L61.4281 48H52.2761L70.4521 30.464L52.2761 12.8H61.4281L97.7161 48ZM97.7161 12.8L82.4841 27.648L77.8761 23.552L88.5641 12.8H97.7161Z" fill="currentColor"/><path d="M154.461 48H148.061V35.2H112.285V28.8H148.061V9.6H125.085C122.183 9.6 119.517 10.3253 117.085 11.776C114.653 13.184 112.711 15.104 111.261 17.536C109.853 19.968 109.149 22.656 109.149 25.6V48H102.749V25.6C102.749 22.528 103.325 19.648 104.477 16.96C105.629 14.2293 107.229 11.84 109.277 9.792C111.325 7.70133 113.693 6.08 116.381 4.928C119.111 3.776 122.013 3.2 125.085 3.2H154.461V48ZM171.604 48H165.204V3.2H171.604V48ZM234.041 48H225.401L211.961 35.2H192.313V28.864H218.041C219.833 28.864 221.454 28.4373 222.905 27.584C224.356 26.688 225.508 25.5147 226.361 24.064C227.214 22.5707 227.641 20.9493 227.641 19.2C227.641 17.408 227.214 15.7867 226.361 14.336C225.508 12.8853 224.356 11.7333 222.905 10.88C221.454 10.0267 219.833 9.6 218.041 9.6H188.729V48H182.329V3.2H218.041C220.985 3.2 223.673 3.92533 226.105 5.376C228.537 6.784 230.457 8.704 231.865 11.136C233.316 13.568 234.041 16.256 234.041 19.2C234.041 21.8453 233.444 24.2987 232.249 26.56C231.097 28.8213 229.497 30.6987 227.449 32.192C225.444 33.6427 223.161 34.5813 220.601 35.008L234.041 48Z" fill="currentColor"/></symbol>
        </defs>
    </svg>

    <!-- LOGIN -->
    <div class="screen login-screen active" id="loginScreen">
        <div class="scan-line"></div>
        <div class="login-container">
            <div class="login-logo"><svg viewBox="0 0 235 48"><use href="#icon-fixair-logo"/></svg></div>
            <h1 class="login-title">Bienvenue</h1>
            <p class="login-sub">Assistant IA pour techniciens HVAC</p>
            <div class="login-bar">
                <div class="login-icon-slot">
                    <div class="login-mini" id="loginSphere"><div class="glass-sphere"><div class="sphere-fog-container"><div class="sphere-fog"></div><div class="sphere-fog-2"></div></div></div></div>
                    <button type="button" class="login-back" id="loginBack" onclick="prevLoginStep()"><svg viewBox="0 0 24 24"><use href="#icon-arrow-left"/></svg></button>
                </div>
                <div class="login-input-container">
                    <div class="login-input-slider" id="loginSlider">
                        <div class="login-input-slide">
                            <input type="email" class="login-input" id="loginEmail" placeholder="Quelle est votre adresse email ?" onkeypress="if(event.key==='Enter')nextLoginStep()">
                        </div>
                        <div class="login-input-slide">
                            <input type="password" class="login-input" id="loginPassword" placeholder="Quel est votre mot de passe ?" onkeypress="if(event.key==='Enter')nextLoginStep()">
                        </div>
                        <div class="login-input-slide">
                            <input type="text" class="login-input" id="loginName" placeholder="Quel est votre prnom ?" onkeypress="if(event.key==='Enter')completeLogin()">
                        </div>
                    </div>
                </div>
                <button type="button" class="login-btn" id="loginBtn" onclick="nextLoginStep()"><span class="icon"><svg><use href="#icon-arrow-right"/></svg></span></button>
            </div>
        </div>
    </div>

    <!-- MAIN APP -->
    <div class="screen main-app" id="mainApp">
        <header class="app-header">
            <div class="header-inner">
                <div class="header-left">
                    <div class="header-logo-svg" onclick="goToHome()" style="cursor:pointer;"><svg viewBox="0 0 235 48"><use href="#icon-fixair-logo"/></svg></div>
                </div>
                <div class="brand-pill" id="brandPill" onclick="toggleBrandDropdown()">
                    <div class="brand-pill-dot" id="brandDot"></div>
                    <span class="brand-pill-text" id="brandText">Mitsubishi</span>
                    <svg class="brand-pill-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
                    <div class="brand-dropdown" id="brandDropdown">
                        <div class="brand-dropdown-item active" data-b="carrier" onclick="event.stopPropagation(); setBrand('carrier')">
                            <div class="brand-dropdown-dot" style="background:#3B82F6;"></div>
                            <span class="brand-dropdown-name">Carrier</span>
                            <svg class="brand-dropdown-check" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="20 6 9 17 4 12"/></svg>
                        </div>
                        <div class="brand-dropdown-item active" data-b="daikin" onclick="event.stopPropagation(); setBrand('daikin')">
                            <div class="brand-dropdown-dot" style="background:#10B981;"></div>
                            <span class="brand-dropdown-name">Daikin</span>
                            <svg class="brand-dropdown-check" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="20 6 9 17 4 12"/></svg>
                        </div>
                        <div class="brand-dropdown-item active selected" data-b="mitsubishi" onclick="event.stopPropagation(); setBrand('mitsubishi')">
                            <div class="brand-dropdown-dot" style="background:#E60012;"></div>
                            <span class="brand-dropdown-name">Mitsubishi</span>
                            <svg class="brand-dropdown-check" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="20 6 9 17 4 12"/></svg>
                        </div>
                        <div class="brand-dropdown-divider"></div>
                        <div class="brand-dropdown-item disabled"><span class="brand-dropdown-name">AAON</span></div>
                        <div class="brand-dropdown-item disabled"><span class="brand-dropdown-name">American Standard</span></div>
                        <div class="brand-dropdown-item disabled"><span class="brand-dropdown-name">Amana</span></div>
                        <div class="brand-dropdown-item disabled"><span class="brand-dropdown-name">Armstrong Air</span></div>
                        <div class="brand-dropdown-item disabled"><span class="brand-dropdown-name">Bosch</span></div>
                        <div class="brand-dropdown-item disabled"><span class="brand-dropdown-name">Bryant</span></div>
                        <div class="brand-dropdown-item disabled"><span class="brand-dropdown-name">Fujitsu</span></div>
                        <div class="brand-dropdown-item disabled"><span class="brand-dropdown-name">Gree</span></div>
                        <div class="brand-dropdown-item disabled"><span class="brand-dropdown-name">Haier</span></div>
                        <div class="brand-dropdown-item disabled"><span class="brand-dropdown-name">Hitachi</span></div>
                        <div class="brand-dropdown-item disabled"><span class="brand-dropdown-name">Lennox</span></div>
                        <div class="brand-dropdown-item disabled"><span class="brand-dropdown-name">LG</span></div>
                        <div class="brand-dropdown-item disabled"><span class="brand-dropdown-name">Panasonic</span></div>
                        <div class="brand-dropdown-item disabled"><span class="brand-dropdown-name">Rheem</span></div>
                        <div class="brand-dropdown-item disabled"><span class="brand-dropdown-name">Samsung</span></div>
                        <div class="brand-dropdown-item disabled"><span class="brand-dropdown-name">Trane</span></div>
                        <div class="brand-dropdown-item disabled"><span class="brand-dropdown-name">York</span></div>
                    </div>
                </div>
            </div>
        </header>
        <div class="app-content">
            <!-- HOME PAGE -->
            <div class="home" id="homePage">
                <!-- ONBOARDING SECTION -->
                <div class="onboarding-section" id="onboardingSection">
                    <div class="welcome-section" id="welcomeSection">
                        <div class="welcome-text">Bienvenue, <strong id="userName">Technicien</strong></div>
                        <div class="welcome-sub">Commenons votre parcours FixAIR</div>
                    </div>
                    <div class="onboarding-card" id="onboardingCard">
                        <button class="congrats-close" onclick="closeCongrats()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><use href="#icon-x"/></svg></button>
                        <div class="onboarding-header">
                            <span class="onboarding-title">Premires tapes</span>
                            <span class="onboarding-progress" id="onboardingProgress">0/4</span>
                        </div>
                        <div class="onboarding-steps" id="onboardingSteps">
                            <div class="onboarding-step active" id="step1" onclick="openProfile()">
                                <div class="step-check current" id="step1Check"></div>
                                <div class="step-content"><span class="step-title">Crer votre compte</span></div>
                                <svg class="step-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg>
                            </div>
                            <div class="onboarding-step locked" id="step2" onclick="toggleBrandSelect()">
                                <div class="step-check pending" id="step2Check"></div>
                                <div class="step-content"><span class="step-title">Slectionner votre marque</span></div>
                                <svg class="step-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg>
                            </div>
                            <div class="brand-select-inline" id="brandSelectInline">
                                <div class="brand-select-option" data-brand="carrier" onclick="selectBrandInline('carrier')"><span class="brand-select-name">Carrier</span><div class="brand-select-dot"></div></div>
                                <div class="brand-select-option" data-brand="daikin" onclick="selectBrandInline('daikin')"><span class="brand-select-name">Daikin</span><div class="brand-select-dot"></div></div>
                                <div class="brand-select-option" data-brand="mitsubishi" onclick="selectBrandInline('mitsubishi')"><span class="brand-select-name">Mitsubishi</span><div class="brand-select-dot"></div></div>
                            </div>
                            <div class="onboarding-step locked" id="step3" onclick="handleStep3Click()">
                                <div class="step-check pending" id="step3Check"></div>
                                <div class="step-content">
                                    <span class="step-title">Premier diagnostic</span>
                                    <div class="step-divider"></div>
                                    <div class="step-tool">
                                        <svg class="step-tool-icon copilot" viewBox="0 0 200 200" fill="currentColor"><use href="#icon-star"/></svg>
                                        <span class="step-tool-name copilot">Copilot</span>
                                    </div>
                                </div>
                                <svg class="step-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg>
                            </div>
                            <div class="onboarding-step locked" id="step4" onclick="handleStep4Click()">
                                <div class="step-check pending" id="step4Check"></div>
                                <div class="step-content">
                                    <span class="step-title">Crer un rapport</span>
                                    <div class="step-divider"></div>
                                    <div class="step-tool">
                                        <svg class="step-tool-icon assistant" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><use href="#icon-clipboard"/></svg>
                                        <span class="step-tool-name assistant">Assistant</span>
                                    </div>
                                </div>
                                <svg class="step-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg>
                            </div>
                        </div>
                        <div class="congrats-content">
                            <div class="congrats-icon"></div>
                            <div class="congrats-title">Flicitations !</div>
                            <div class="congrats-sub">Vous avez termin les premires tapes.<br>Vous tes prt  utiliser FixAIR !</div>
                        </div>
                    </div>
                </div>

                <!-- V13 HOMEPAGE CONTENT (hidden during onboarding) -->
                <div class="homepage-content" id="homepageContent">
                <!-- GAMIFICATION STATS (FIRE GROWTH) -->
                <div class="stats-section" id="statsSection">
                    <!-- Week Label -->
                    <div class="stats-week-label" id="statsWeekLabel">Cette semaine</div>
                    
                    <!-- Ring with tooltip -->
                    <div class="stats-ring-container" id="statsRingContainer">
                        <svg class="stats-ring" viewBox="0 0 120 120">
                            <defs>
                                <!-- Fire Growth Gradient: Braise  Flamme  Or -->
                                <linearGradient id="fireGrowthGradient" x1="0%" y1="100%" x2="100%" y2="0%">
                                    <stop offset="0%" stop-color="#92400E"/>
                                    <stop offset="40%" stop-color="#EA580C"/>
                                    <stop offset="70%" stop-color="#F97316"/>
                                    <stop offset="100%" stop-color="#FCD34D"/>
                                </linearGradient>
                            </defs>
                            <!-- Background circle -->
                            <circle class="stats-ring-bg" cx="60" cy="60" r="54"/>
                            <!-- Progress circle -->
                            <circle id="statsRingProgress" class="stats-ring-progress" cx="60" cy="60" r="54" transform="rotate(-90 60 60)"/>
                        </svg>
                        <div class="stats-ring-content">
                            <span class="stats-ring-percent" id="statsRingPercent">0%</span>
                        </div>
                        <div class="stats-ring-tooltip" id="statsRingTooltip">Votre progression vers l'objectif hebdomadaire. 100% = vous utilisez pleinement FixAIR pour gagner du temps et de l'argent !</div>
                    </div>
                    
                    <!-- Stats Row (inline) with tooltips -->
                    <div class="stats-inline">
                        <div class="stats-item" id="statsTimeItem">
                            <span class="stats-item-icon"></span>
                            <span class="stats-item-value" id="statsTimeValue">0</span><span class="stats-item-unit" id="statsTimeUnit">min</span>
                            <span class="stats-item-label">sauv</span>
                            <div class="stats-tooltip">Temps conomis cette semaine grce  FixAIR, compar au travail manuel : rdaction, recherche, corrections...</div>
                        </div>
                        <div class="stats-separator"></div>
                        <div class="stats-item" id="statsEurosItem">
                            <span class="stats-item-icon"></span>
                            <span class="stats-item-value" id="statsEurosSaved">0</span>
                            <div class="stats-tooltip">Valeur conomique estime, base sur le tarif horaire moyen d'un technicien. Inclut : temps de rdaction, allers-retours avec l'entreprise, stress vit.</div>
                        </div>
                        <div class="stats-separator"></div>
                        <div class="stats-item" id="statsReportsItem">
                            <span class="stats-item-icon"></span>
                            <span class="stats-item-value" id="statsReports">0</span>
                            <span class="stats-item-label">rapports</span>
                            <div class="stats-tooltip">Rapports professionnels gnrs automatiquement, prts  envoyer  vos clients.</div>
                        </div>
                    </div>
                    
                    <!-- Motivation Message -->
                    <div class="stats-message" id="statsMessage">Lance-toi ! </div>
                </div>

                <!-- TOGGLE CARDS -->
                <div class="modules-toggle">
                    <div class="toggle-card copilot" onclick="openChat('copilot')">
                        <div class="toggle-card-icon"><span class="star-icon"><svg viewBox="0 0 200 200"><use href="#icon-star"/></svg></span></div>
                        <div class="toggle-card-content">
                            <div class="toggle-card-title">Diagnostic</div>
                            <div class="toggle-card-desc">avec <span class="highlight-copilot">Copilot</span></div>
                        </div>
                        <svg class="toggle-card-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg>
                    </div>
                    <div class="toggle-card assistant" onclick="openChat('assistant')">
                        <div class="toggle-card-icon"><span class="icon"><svg><use href="#icon-clipboard"/></svg></span></div>
                        <div class="toggle-card-content">
                            <div class="toggle-card-title">Rapport</div>
                            <div class="toggle-card-desc">avec <span class="highlight-assistant">Assistant</span></div>
                        </div>
                        <svg class="toggle-card-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg>
                    </div>
                </div>

                <!-- BRAND BAR -->
                <div class="brand-select-row">
                    <span class="brand-label">Marque:</span>
                    <div class="brand-chip" data-b="carrier" onclick="setBrand('carrier')">Carrier</div>
                    <div class="brand-chip" data-b="daikin" onclick="setBrand('daikin')">Daikin</div>
                    <div class="brand-chip active" data-b="mitsubishi" onclick="setBrand('mitsubishi')">Mitsubishi</div>
                </div>

                <!-- RECENT PROJECTS -->
                <div>
                    <div class="sec-head"><span class="sec-title">Projets rcents</span><div class="sec-line"></div></div>
                    <div class="projects" id="recentProjectsHome">
                        <!-- Dynamic content loaded from Supabase -->
                    </div>
                </div>
                </div><!-- END homepage-content -->
            </div>

            <!-- PROJECTS PAGE -->
            <div class="projects-page" id="projectsPage">
                <div class="projects-page-header">
                    <div class="projects-page-title">Tous les projets</div>
                    <div class="projects-page-sub">Historique de vos interventions</div>
                </div>
                <div class="projects-list" id="projectsList">
                    <!-- Dynamic content loaded from Supabase -->
                </div>
            </div>
            
            <!-- PROJECT CONTEXT MENU -->
            <div class="project-context-menu" id="projectContextMenu" onclick="event.stopPropagation()">
                <div class="context-menu-item" onclick="event.stopPropagation(); renameProject()">
                    <span class="icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg></span>
                    <span>Renommer</span>
                </div>
                <div class="context-menu-item delete" onclick="event.stopPropagation(); deleteProject()">
                    <span class="icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg></span>
                    <span>Supprimer</span>
                </div>
            </div>
        </div>
        <nav class="nav">
            <div class="nav-inner">
                <div class="nav-item active" id="navHome" onclick="goToHome()"><span class="icon nav-icon"><svg><use href="#icon-home"/></svg></span><span class="nav-label">Accueil</span></div>
                <div class="nav-item" id="navProjects" onclick="showPage('projects')"><span class="icon nav-icon"><svg><use href="#icon-folder"/></svg></span><span class="nav-label">Projets</span></div>
                <div class="nav-item nav-hotline" onclick="openHotline()">
                    <div class="nav-hotline-waves">
                        <div class="wave-bar"></div>
                        <div class="wave-bar"></div>
                        <div class="wave-bar"></div>
                        <div class="wave-bar"></div>
                        <div class="wave-bar"></div>
                    </div>
                    <span class="nav-label">Hotline</span>
                </div>
                <div class="nav-item nav-profile" onclick="openProfile()"><span class="icon nav-icon"><svg><use href="#icon-user"/></svg></span><div class="nav-profile-badge"><svg viewBox="0 0 24 24"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg></div><span class="nav-label">Profil</span></div>
            </div>
        </nav>
    </div>

    <!-- PROFILE VIEW -->
    <div class="profile-view" id="profileView">
        <div class="profile-header">
            <button class="profile-back" onclick="closeProfile()"><span class="icon"><svg viewBox="0 0 24 24"><use href="#icon-arrow-left"/></svg></span></button>
            <div class="profile-info">
                <div class="profile-title" data-i18n="profile.title">Votre profil</div>
                <div class="profile-subtitle" data-i18n="profile.subtitle">Informations personnelles</div>
            </div>
        </div>
        <div class="profile-body">
            <div class="profile-form">
                <!-- Personal Info -->
                <div class="settings-section-title" data-i18n="profile.personal">Informations personnelles</div>
                <div class="form-group">
                    <label class="form-label" data-i18n="profile.firstname">Prnom</label>
                    <input type="text" class="form-input" id="profileFirstName" data-placeholder-i18n="profile.firstname_placeholder">
                </div>
                <div class="form-group">
                    <label class="form-label" data-i18n="profile.lastname">Nom</label>
                    <input type="text" class="form-input" id="profileLastName" data-placeholder-i18n="profile.lastname_placeholder">
                </div>
                <div class="form-group">
                    <label class="form-label">Email</label>
                    <input type="email" class="form-input" id="profileEmail" placeholder="Votre email" readonly style="opacity: 0.6;">
                </div>
                <div class="form-group">
                    <label class="form-label" data-i18n="profile.phone">Tlphone</label>
                    <input type="tel" class="form-input" id="profilePhone" data-placeholder-i18n="profile.phone_placeholder">
                </div>
                
                <!-- Settings Section -->
                <div class="settings-divider"></div>
                <div class="settings-section-title" data-i18n="profile.settings">Paramtres</div>
                
                <!-- Language Toggle -->
                <div class="setting-toggle">
                    <div class="setting-toggle-info">
                        <div class="setting-toggle-label" data-i18n="profile.language">Langue</div>
                        <div class="setting-toggle-desc" data-i18n="profile.language_desc">Choisissez votre langue</div>
                    </div>
                    <div class="lang-selector">
                        <button class="lang-btn active" id="langFR" onclick="setLanguage('fr')">FR</button>
                        <button class="lang-btn" id="langEN" onclick="setLanguage('en')">EN</button>
                    </div>
                </div>
                
                <!-- Theme Toggle -->
                <div class="setting-toggle">
                    <div class="setting-toggle-info">
                        <div class="setting-toggle-label" data-i18n="profile.theme">Thme</div>
                        <div class="setting-toggle-desc" data-i18n="profile.theme_desc">Mode sombre ou clair</div>
                    </div>
                    <div class="toggle-switch" id="themeToggle" onclick="toggleTheme()"></div>
                </div>
                
                <div class="settings-divider"></div>
                
                <button class="profile-save" onclick="saveProfile()" data-i18n="profile.save">Enregistrer</button>
                <button class="profile-save" onclick="logout()" style="background: transparent; border: 1px solid rgba(239,68,68,0.3); color: #ef4444; margin-top: 12px;" data-i18n="profile.logout">Dconnexion</button>
            </div>
        </div>
    </div>

    <!-- CHAT VIEW (FULL WIDTH) -->
    <div class="chat-view single" id="chatView">
        <div class="panel copilot" id="panelCopilot" style="flex-basis:50%;">
            <header class="panel-header">
                <button class="panel-back" onclick="closeChat()"><span class="icon"><svg><use href="#icon-arrow-left"/></svg></span></button>
                <div class="panel-info">
                    <div class="panel-title">FixAIR Copilot</div>
                    <div class="panel-separator"></div>
                    <div class="panel-brand-wrapper" id="copilotBrandWrapper">
                        <div class="panel-brand-btn" onclick="toggleChatBrandDropdown('copilot')">
                            <span class="panel-brand-text" id="copilotSub">Mitsubishi</span>
                            <svg class="brand-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
                        </div>
                        <div class="panel-brand-dropdown" id="copilotBrandDropdown">
                            <div class="panel-brand-option" data-brand="mitsubishi" onclick="changeChatBrand('mitsubishi', 'copilot')">
                                <svg class="brand-check" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>
                                <span>Mitsubishi</span>
                            </div>
                            <div class="panel-brand-option" data-brand="daikin" onclick="changeChatBrand('daikin', 'copilot')">
                                <svg class="brand-check" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>
                                <span>Daikin</span>
                            </div>
                            <div class="panel-brand-option" data-brand="carrier" onclick="changeChatBrand('carrier', 'copilot')">
                                <svg class="brand-check" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>
                                <span>Carrier</span>
                            </div>
                            <div class="panel-brand-option" data-brand="lg" onclick="changeChatBrand('lg', 'copilot')">
                                <svg class="brand-check" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>
                                <span>LG</span>
                            </div>
                            <div class="panel-brand-option" data-brand="samsung" onclick="changeChatBrand('samsung', 'copilot')">
                                <svg class="brand-check" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>
                                <span>Samsung</span>
                            </div>
                            <div class="panel-brand-option" data-brand="panasonic" onclick="changeChatBrand('panasonic', 'copilot')">
                                <svg class="brand-check" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>
                                <span>Panasonic</span>
                            </div>
                            <div class="panel-brand-option" data-brand="toshiba" onclick="changeChatBrand('toshiba', 'copilot')">
                                <svg class="brand-check" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>
                                <span>Toshiba</span>
                            </div>
                            <div class="panel-brand-option" data-brand="fujitsu" onclick="changeChatBrand('fujitsu', 'copilot')">
                                <svg class="brand-check" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>
                                <span>Fujitsu</span>
                            </div>
                            <div class="panel-brand-option" data-brand="hitachi" onclick="changeChatBrand('hitachi', 'copilot')">
                                <svg class="brand-check" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>
                                <span>Hitachi</span>
                            </div>
                            <div class="panel-brand-option" data-brand="general" onclick="changeChatBrand('general', 'copilot')">
                                <svg class="brand-check" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>
                                <span>Multi-marques</span>
                            </div>
                        </div>
                    </div>
                    <div class="panel-separator panel-project-sep" id="copilotProjectSep" style="display:none;"></div>
                    <div class="panel-project" id="copilotProjectName" style="display:none;"></div>
                </div>
                <div class="mode-toggle">
                    <div class="mode-btn copilot active" onclick="switchMode('copilot')">
                        <span class="mode-icon star-icon"><svg viewBox="0 0 200 200"><use href="#icon-star"/></svg></span>
                        <span>Copilot</span>
                    </div>
                    <div class="mode-btn assistant" onclick="switchMode('assistant')">
                        <span class="mode-icon clip-icon"><svg><use href="#icon-clipboard"/></svg></span>
                        <span>Assistant</span>
                    </div>
                </div>
                <div class="header-actions">
                    <button class="h-btn new-chat-btn" onclick="startNewProject()" title="Nouveau chat"><span class="icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg></span></button>
                    <button class="h-btn" onclick="toggleSplit()" title="Mode split"><span class="icon"><svg><use href="#icon-columns"/></svg></span></button>
                </div>
            </header>
            <div class="chat-body" id="copilotBody"></div>
            <button class="scroll-bottom-btn" id="scrollBtnCopilot" onclick="scrollToBottom('copilot')">
                <span class="icon"><svg><use href="#icon-arrow-left"/></svg></span>
            </button>
            <div class="chat-input">
                <div class="attach-menu" id="attachCopilot">
                    <div class="attach-opt" onclick="attachAction('camera','copilot')"><span class="icon"><svg><use href="#icon-camera"/></svg></span>Photo / Scan</div>
                    <div class="attach-opt" onclick="attachAction('file','copilot')"><span class="icon"><svg><use href="#icon-paperclip"/></svg></span>Importer</div>
                </div>
                <div class="input-row" id="copilotInputRow">
                    <button class="plus-btn" onclick="toggleAttach('copilot')"><span class="icon"><svg><use href="#icon-plus"/></svg></span></button>
                    <div class="input-area">
                        <textarea class="input-text" id="copilotInput" placeholder="Posez votre question..." rows="1" oninput="handleChatInput('copilot')" onkeydown="handleKeydown(event,'copilot')"></textarea>
                        <div class="voice-waveform copilot" id="copilotWaveform">
                            <div class="wave-bars" id="copilotBars"></div>
                            <div class="voice-timer" id="copilotTimer">0:00</div>
                        </div>
                    </div>
                    <button class="action-btn copilot" id="copilotActionBtn" onclick="handleAction('copilot')">
                        <div class="icon-wrap">
                            <span class="btn-icon mic-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/></svg></span>
                            <span class="btn-icon send-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="19" x2="12" y2="5"/><polyline points="5 12 12 5 19 12"/></svg></span>
                            <span class="btn-icon stop-icon"><svg viewBox="0 0 24 24" fill="currentColor"><rect x="6" y="6" width="12" height="12" rx="2"/></svg></span>
                        </div>
                    </button>
                    <!-- Transcription Sphere -->
                    <div class="transcription-sphere" id="copilotTranscriptionSphere">
                        <div class="sphere-fog-wrap">
                            <div class="sphere-fog-transcribe"></div>
                            <div class="sphere-fog-transcribe-2"></div>
                        </div>
                        <div class="sphere-highlight"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="divider" id="divider" style="display:none;"><div class="divider-grip"><span></span><span></span><span></span></div></div>

        <div class="panel assistant" id="panelAssistant" style="display:none;flex-basis:50%;">
            <header class="panel-header">
                <button class="panel-back" onclick="closeChat()"><span class="icon"><svg><use href="#icon-arrow-left"/></svg></span></button>
                <div class="panel-info">
                    <div class="panel-title">FixAIR Assistant</div>
                    <div class="panel-separator"></div>
                    <div class="panel-brand-wrapper" id="assistantBrandWrapper">
                        <div class="panel-brand-btn" onclick="toggleChatBrandDropdown('assistant')">
                            <span class="panel-brand-text" id="assistantSub">Mitsubishi</span>
                            <svg class="brand-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
                        </div>
                        <div class="panel-brand-dropdown" id="assistantBrandDropdown">
                            <div class="panel-brand-option" data-brand="mitsubishi" onclick="changeChatBrand('mitsubishi', 'assistant')">
                                <svg class="brand-check" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>
                                <span>Mitsubishi</span>
                            </div>
                            <div class="panel-brand-option" data-brand="daikin" onclick="changeChatBrand('daikin', 'assistant')">
                                <svg class="brand-check" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>
                                <span>Daikin</span>
                            </div>
                            <div class="panel-brand-option" data-brand="carrier" onclick="changeChatBrand('carrier', 'assistant')">
                                <svg class="brand-check" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>
                                <span>Carrier</span>
                            </div>
                            <div class="panel-brand-option" data-brand="lg" onclick="changeChatBrand('lg', 'assistant')">
                                <svg class="brand-check" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>
                                <span>LG</span>
                            </div>
                            <div class="panel-brand-option" data-brand="samsung" onclick="changeChatBrand('samsung', 'assistant')">
                                <svg class="brand-check" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>
                                <span>Samsung</span>
                            </div>
                            <div class="panel-brand-option" data-brand="panasonic" onclick="changeChatBrand('panasonic', 'assistant')">
                                <svg class="brand-check" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>
                                <span>Panasonic</span>
                            </div>
                            <div class="panel-brand-option" data-brand="toshiba" onclick="changeChatBrand('toshiba', 'assistant')">
                                <svg class="brand-check" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>
                                <span>Toshiba</span>
                            </div>
                            <div class="panel-brand-option" data-brand="fujitsu" onclick="changeChatBrand('fujitsu', 'assistant')">
                                <svg class="brand-check" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>
                                <span>Fujitsu</span>
                            </div>
                            <div class="panel-brand-option" data-brand="hitachi" onclick="changeChatBrand('hitachi', 'assistant')">
                                <svg class="brand-check" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>
                                <span>Hitachi</span>
                            </div>
                            <div class="panel-brand-option" data-brand="general" onclick="changeChatBrand('general', 'assistant')">
                                <svg class="brand-check" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>
                                <span>Multi-marques</span>
                            </div>
                        </div>
                    </div>
                    <div class="panel-separator panel-project-sep" id="assistantProjectSep" style="display:none;"></div>
                    <div class="panel-project" id="assistantProjectName" style="display:none;"></div>
                </div>
                <div class="mode-toggle">
                    <div class="mode-btn copilot" onclick="switchMode('copilot')">
                        <span class="mode-icon star-icon"><svg viewBox="0 0 200 200"><use href="#icon-star"/></svg></span>
                        <span>Copilot</span>
                    </div>
                    <div class="mode-btn assistant active" onclick="switchMode('assistant')">
                        <span class="mode-icon clip-icon"><svg><use href="#icon-clipboard"/></svg></span>
                        <span>Assistant</span>
                    </div>
                </div>
                <div class="header-actions">
                    <button class="h-btn new-chat-btn" onclick="startNewProject()" title="Nouveau chat"><span class="icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg></span></button>
                    <button class="h-btn report-btn" onclick="openReport()" title="Voir rapport"><span class="icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><rect x="5" y="3" width="14" height="18" rx="2"/><path d="M9 10l2 2 4-4"/><line x1="9" y1="16" x2="15" y2="16"/></svg></span></button>
                    <button class="h-btn" onclick="toggleSplit()" title="Mode split"><span class="icon"><svg><use href="#icon-columns"/></svg></span></button>
                </div>
            </header>
            <div class="chat-body" id="assistantBody"></div>
            <button class="scroll-bottom-btn" id="scrollBtnAssistant" onclick="scrollToBottom('assistant')">
                <span class="icon"><svg><use href="#icon-arrow-left"/></svg></span>
            </button>
            <div class="chat-input">
                <div class="attach-menu" id="attachAssistant">
                    <div class="attach-opt" onclick="attachAction('camera','assistant')"><span class="icon"><svg><use href="#icon-camera"/></svg></span>Photo / Scan</div>
                    <div class="attach-opt" onclick="attachAction('file','assistant')"><span class="icon"><svg><use href="#icon-paperclip"/></svg></span>Importer</div>
                </div>
                <div class="input-row" id="assistantInputRow">
                    <button class="plus-btn" onclick="toggleAttach('assistant')"><span class="icon"><svg><use href="#icon-plus"/></svg></span></button>
                    <div class="input-area">
                        <textarea class="input-text" id="assistantInput" placeholder="Dcrivez l'intervention..." rows="1" oninput="handleChatInput('assistant')" onkeydown="handleKeydown(event,'assistant')"></textarea>
                        <div class="voice-waveform assistant" id="assistantWaveform">
                            <div class="wave-bars" id="assistantBars"></div>
                            <div class="voice-timer" id="assistantTimer">0:00</div>
                        </div>
                    </div>
                    <button class="action-btn assistant" id="assistantActionBtn" onclick="handleAction('assistant')">
                        <div class="icon-wrap">
                            <span class="btn-icon mic-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/></svg></span>
                            <span class="btn-icon send-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="19" x2="12" y2="5"/><polyline points="5 12 12 5 19 12"/></svg></span>
                            <span class="btn-icon stop-icon"><svg viewBox="0 0 24 24" fill="currentColor"><rect x="6" y="6" width="12" height="12" rx="2"/></svg></span>
                        </div>
                    </button>
                    <!-- Transcription Sphere -->
                    <div class="transcription-sphere" id="assistantTranscriptionSphere">
                        <div class="sphere-fog-wrap">
                            <div class="sphere-fog-transcribe"></div>
                            <div class="sphere-fog-transcribe-2"></div>
                        </div>
                        <div class="sphere-highlight"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- REPORT SHEET - Live Preview Drawer -->
    <div class="report-backdrop" id="reportBackdrop" onclick="closeReport()"></div>
    <div class="report-sheet" id="reportSheet">
        <header class="report-header">
            <button class="report-close" onclick="closeReport()"><span class="icon"><svg><use href="#icon-x"/></svg></span></button>
            <div class="report-title">Rapport d'intervention</div>
            <div class="report-progress" id="reportHeaderProgress" style="display: none;">
                <div class="report-progress-bar">
                    <div class="report-progress-fill" id="reportProgressFill"></div>
                </div>
                <span class="report-progress-text" id="reportProgressText">0%</span>
            </div>
        </header>
        <div class="report-body">
            <div class="report-preview-container" id="reportPreviewContainer">
                <!-- Empty state - shown when no report data -->
                <div class="report-preview-empty" id="reportPreviewEmpty">
                    <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                        <polyline points="14 2 14 8 20 8"/>
                        <line x1="16" y1="13" x2="8" y2="13"/>
                        <line x1="16" y1="17" x2="8" y2="17"/>
                        <polyline points="10 9 9 9 8 9"/>
                    </svg>
                    <p>Le rapport se construit automatiquement pendant votre conversation avec l'Assistant.</p>
                    <p style="margin-top:8px;font-size:11px;opacity:0.6">Donnez les informations (client, quipement, problme...) et le rapport se mettra  jour ici.</p>
                </div>
                <!-- Live report preview - populated dynamically -->
                <div id="reportPreviewContent" style="display:none;"></div>
            </div>
        </div>
        <div class="report-footer">
            <button class="r-btn secondary" onclick="shareReport()"><span class="icon"><svg><use href="#icon-share"/></svg></span>Partager</button>
            <button class="r-btn primary" onclick="exportReportPDF()"><span class="icon"><svg><use href="#icon-download"/></svg></span>Exporter PDF</button>
        </div>
    </div>

    <!-- PHOTO MODAL -->
    <!-- HIDDEN FILE INPUTS -->
    <input type="file" id="cameraInput" accept="image/*" capture="environment" style="display:none;" onchange="handleFileSelect(event, 'camera')">
    <input type="file" id="fileInput" accept="image/*,.pdf,.doc,.docx,.xls,.xlsx,.txt" style="display:none;" onchange="handleFileSelect(event, 'file')">
    
    <!-- PHOTO NAME MODAL (for adding to report) -->
    <div class="photo-name-modal" id="photoNameModal" onclick="if(event.target === this) closePhotoNameModal()">
        <div class="photo-name-content">
            <div class="photo-name-header">
                <div class="photo-name-title">Nommer la photo</div>
                <div class="photo-name-sub">Cette lgende apparatra dans le rapport</div>
            </div>
            <div class="photo-name-preview">
                <img id="photoNamePreviewImg" src="" alt="Preview">
            </div>
            <div class="photo-name-input-wrap">
                <input type="text" id="photoNameInput" class="photo-name-input" placeholder="Ex: Plaque signaltique, Code erreur E6..." maxlength="100" onkeydown="if(event.key==='Enter')confirmAddToReport()">
            </div>
            <div class="photo-name-actions">
                <button class="photo-name-cancel" onclick="closePhotoNameModal()">Annuler</button>
                <button class="photo-name-confirm" onclick="confirmAddToReport()">Ajouter au rapport</button>
            </div>
        </div>
    </div>

    <!-- IMAGE VIEWER MODAL -->
    <div class="image-viewer" id="imageViewer" onclick="closeImageViewer()">
        <button class="image-viewer-close" onclick="closeImageViewer()">
            <span class="icon"><svg><use href="#icon-x"/></svg></span>
        </button>
        <img id="imageViewerImg" src="" alt="Full size">
    </div>

    <!-- HOTLINE VIEW -->
    <div class="hotline-view" id="hotlineView">
        <button class="hotline-close" onclick="closeHotline()"><span class="icon"><svg><use href="#icon-x"/></svg></span></button>
        <div class="hotline-widget" id="hotlineWidget">
            <div class="pulse-sphere" id="pulseSphere" onclick="toggleHotline()">
                <div class="pulse-atmosphere"></div>
                <div class="pulse-ring"></div>
                <div class="pulse-ring"></div>
                <div class="pulse-ring"></div>
                <div class="pulse-core"></div>
                <div class="pulse-icon">
                    <div class="voice-bar"></div>
                    <div class="voice-bar"></div>
                    <div class="voice-bar"></div>
                    <div class="voice-bar"></div>
                    <div class="voice-bar"></div>
                </div>
            </div>
            <div class="widget-label" id="widgetLabel">Hotline</div>
            <div class="widget-sublabel" id="widgetSublabel">Appuyez pour parler</div>
        </div>
        <div class="hotline-chat" id="hotlineChat">
            <div class="chat-spacer"></div>
            <div class="chat-messages-outer">
                <div class="chat-messages" id="hotlineChatMessages">
                    <div class="messages-wrapper" id="messagesWrapper">
                        <div class="chat-empty" id="chatEmpty">Commencez  parler pour voir la conversation...</div>
                    </div>
                </div>
            </div>
        </div>
        <button class="toggle-chat" id="toggleChat" onclick="toggleChatView()">
            <span class="toggle-icon"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg></span>
            <span id="toggleText">Afficher</span>
        </button>
    </div>

    <div class="toast" id="toast"></div>

    <script>
        // BROWSER DETECTION & DYNAMIC HEIGHT FIX
        const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
        const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        
        // Get actual visible height (handles Safari toolbar, keyboard, etc.)
        function getVisibleHeight() {
            if (window.visualViewport) {
                return window.visualViewport.height;
            }
            return window.innerHeight;
        }
        
        function setViewportHeight() {
            const vh = window.innerHeight * 0.01;
            const visibleHeight = getVisibleHeight();
            
            document.documentElement.style.setProperty('--vh', `${vh}px`);
            document.documentElement.style.setProperty('--app-height', `${window.innerHeight}px`);
            document.documentElement.style.setProperty('--visible-height', `${visibleHeight}px`);
            
            // CRITICAL: Set explicit heights to prevent gap
            document.documentElement.style.height = '100%';
            document.body.style.height = '100%';
            document.body.style.minHeight = '100%';
            document.body.style.maxHeight = '100%';
            
            // Update chatView if active
            const chatView = document.getElementById('chatView');
            if (chatView && chatView.classList.contains('active')) {
                chatView.style.height = `${visibleHeight}px`;
            }
            
            // Hide any overflow from parent iframe
            document.documentElement.style.overflow = 'hidden';
            document.body.style.overflow = 'hidden';
        }
        
        // Handle keyboard visibility changes (Safari specific)
        function handleKeyboardChange() {
            const chatView = document.getElementById('chatView');
            if (!chatView || !chatView.classList.contains('active')) return;
            
            const visibleHeight = getVisibleHeight();
            chatView.style.height = `${visibleHeight}px`;
            
            // Scroll chat body to bottom when keyboard opens
            setTimeout(() => {
                const activePanel = document.querySelector('.panel[style*="flex"]');
                if (activePanel) {
                    const chatBody = activePanel.querySelector('.chat-body');
                    if (chatBody) {
                        chatBody.scrollTop = chatBody.scrollHeight;
                    }
                }
            }, 100);
        }
        
        setViewportHeight();
        window.addEventListener('resize', setViewportHeight);
        window.addEventListener('load', setViewportHeight);
        window.addEventListener('orientationchange', () => setTimeout(setViewportHeight, 100));
        
        // Safari/iOS specific: handle address bar and keyboard
        if (window.visualViewport) {
            window.visualViewport.addEventListener('resize', handleKeyboardChange);
            window.visualViewport.addEventListener('scroll', setViewportHeight);
        }
        
        // Handle focus/blur on input fields for keyboard detection
        document.addEventListener('focusin', (e) => {
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
                setTimeout(handleKeyboardChange, 300);
            }
        });
        
        document.addEventListener('focusout', (e) => {
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
                setTimeout(setViewportHeight, 300);
            }
        });
        
        let brand = 'mitsubishi';
        let mode = 'copilot';
        let isSplit = false;
        let isConnected = false;
        let isConnecting = false;
        let isDisconnecting = false;
        let chatOpen = false;
        let currentPhotoPanel = 'copilot';
        let currentPage = 'home';
        
        // Theme and Language
        let currentTheme = localStorage.getItem('fixair_theme') || 'dark';
        let currentLang = localStorage.getItem('fixair_lang') || 'fr';
        
        // Translations
        const translations = {
            fr: {
                // Profile
                'profile.title': 'Votre profil',
                'profile.subtitle': 'Informations personnelles',
                'profile.personal': 'Informations personnelles',
                'profile.firstname': 'Prnom',
                'profile.firstname_placeholder': 'Votre prnom',
                'profile.lastname': 'Nom',
                'profile.lastname_placeholder': 'Votre nom',
                'profile.phone': 'Tlphone',
                'profile.phone_placeholder': 'Votre numro',
                'profile.settings': 'Paramtres',
                'profile.language': 'Langue',
                'profile.language_desc': 'Choisissez votre langue',
                'profile.theme': 'Thme',
                'profile.theme_desc': 'Mode sombre ou clair',
                'profile.save': 'Enregistrer',
                'profile.logout': 'Dconnexion',
                // Login
                'login.welcome': 'Bienvenue',
                'login.subtitle': 'Assistant IA pour techniciens HVAC',
                'login.email_placeholder': 'Quelle est votre adresse email ?',
                'login.password_placeholder': 'Votre mot de passe',
                'login.name_placeholder': 'Votre prnom et nom',
                // Nav
                'nav.home': 'Accueil',
                'nav.projects': 'Projets',
                'nav.hotline': 'Hotline',
                'nav.profile': 'Profil',
                // Home
                'home.greeting': 'Bonjour',
                'home.progress': 'Progression du jour',
                'home.choose_assistant': 'Choisissez votre assistant',
                'home.copilot_desc': 'Questions techniques et conseils',
                'home.assistant_desc': 'Diagnostic et rsolution',
                // Onboarding
                'onboarding.step1_title': 'Choisissez votre marque',
                'onboarding.step1_desc': 'Slectionnez la marque principale sur laquelle vous travaillez',
                'onboarding.step2_title': 'Bienvenue sur FixAIR !',
                'onboarding.step2_desc': 'Votre assistant IA pour techniciens HVAC',
                'onboarding.step3_title': 'Posez votre premire question',
                'onboarding.step3_desc': 'Essayez le Copilot avec une question technique',
                'onboarding.step4_title': 'Dcouvrez l\'Assistant',
                'onboarding.step4_desc': 'Pour un diagnostic approfondi',
                'onboarding.complete': 'Termin',
                'onboarding.continue': 'Continuer',
                // Chat
                'chat.input_placeholder': 'Posez votre question...',
                'chat.copilot_title': 'FixAIR Copilot',
                'chat.assistant_title': 'FixAIR Assistant'
            },
            en: {
                // Profile
                'profile.title': 'Your Profile',
                'profile.subtitle': 'Personal Information',
                'profile.personal': 'Personal Information',
                'profile.firstname': 'First Name',
                'profile.firstname_placeholder': 'Your first name',
                'profile.lastname': 'Last Name',
                'profile.lastname_placeholder': 'Your last name',
                'profile.phone': 'Phone',
                'profile.phone_placeholder': 'Your phone number',
                'profile.settings': 'Settings',
                'profile.language': 'Language',
                'profile.language_desc': 'Choose your language',
                'profile.theme': 'Theme',
                'profile.theme_desc': 'Dark or light mode',
                'profile.save': 'Save',
                'profile.logout': 'Logout',
                // Login
                'login.welcome': 'Welcome',
                'login.subtitle': 'AI Assistant for HVAC technicians',
                'login.email_placeholder': 'What is your email address?',
                'login.password_placeholder': 'Your password',
                'login.name_placeholder': 'Your first and last name',
                // Nav
                'nav.home': 'Home',
                'nav.projects': 'Projects',
                'nav.hotline': 'Hotline',
                'nav.profile': 'Profile',
                // Home
                'home.greeting': 'Hello',
                'home.progress': 'Daily Progress',
                'home.choose_assistant': 'Choose your assistant',
                'home.copilot_desc': 'Technical questions and advice',
                'home.assistant_desc': 'Diagnosis and resolution',
                // Onboarding
                'onboarding.step1_title': 'Choose your brand',
                'onboarding.step1_desc': 'Select the main brand you work with',
                'onboarding.step2_title': 'Welcome to FixAIR!',
                'onboarding.step2_desc': 'Your AI assistant for HVAC technicians',
                'onboarding.step3_title': 'Ask your first question',
                'onboarding.step3_desc': 'Try the Copilot with a technical question',
                'onboarding.step4_title': 'Discover the Assistant',
                'onboarding.step4_desc': 'For in-depth diagnostics',
                'onboarding.complete': 'Complete',
                'onboarding.continue': 'Continue',
                // Chat
                'chat.input_placeholder': 'Ask your question...',
                'chat.copilot_title': 'FixAIR Copilot',
                'chat.assistant_title': 'FixAIR Assistant'
            }
        };
        
        // Apply theme on load
        function applyTheme(theme) {
            currentTheme = theme;
            document.documentElement.setAttribute('data-theme', theme);
            localStorage.setItem('fixair_theme', theme);
            
            // Update toggle state
            const toggle = document.getElementById('themeToggle');
            if (toggle) {
                toggle.classList.toggle('active', theme === 'light');
            }
        }
        
        // Toggle theme
        function toggleTheme() {
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            applyTheme(newTheme);
        }
        
        // Set language
        function setLanguage(lang) {
            currentLang = lang;
            localStorage.setItem('fixair_lang', lang);
            
            // Update button states
            document.getElementById('langFR').classList.toggle('active', lang === 'fr');
            document.getElementById('langEN').classList.toggle('active', lang === 'en');
            
            // Apply translations
            applyTranslations();
        }
        
        // Apply translations to all elements with data-i18n attribute
        function applyTranslations() {
            const elements = document.querySelectorAll('[data-i18n]');
            elements.forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (translations[currentLang] && translations[currentLang][key]) {
                    el.textContent = translations[currentLang][key];
                }
            });
            
            // Apply placeholder translations
            const placeholders = document.querySelectorAll('[data-placeholder-i18n]');
            placeholders.forEach(el => {
                const key = el.getAttribute('data-placeholder-i18n');
                if (translations[currentLang] && translations[currentLang][key]) {
                    el.placeholder = translations[currentLang][key];
                }
            });
        }
        
        // Initialize theme and language on load
        function initSettings() {
            applyTheme(currentTheme);
            
            // Set initial language button state
            document.getElementById('langFR').classList.toggle('active', currentLang === 'fr');
            document.getElementById('langEN').classList.toggle('active', currentLang === 'en');
            
            applyTranslations();
        }
        
        // Call initSettings after DOM is ready
        document.addEventListener('DOMContentLoaded', initSettings);
        
        // Onboarding state
        let loginStep = 0;
        let onboardingStep = 1;
        let onboardingComplete = false;
        let step3Done = false;
        let step4Done = false;
        let onboardingBrand = null;
        
        // Auth state
        const API_BASE = 'https://cherhabil.app.n8n.cloud/webhook';
        let isNewUser = false;
        let authToken = localStorage.getItem('fixair_token') || null;
        let currentUser = JSON.parse(localStorage.getItem('fixair_user') || 'null');
        
        const colors = {carrier:'#3B82F6', daikin:'#10B981', mitsubishi:'#E60012'};
        const names = {carrier:'Carrier', daikin:'Daikin', mitsubishi:'Mitsubishi'};

        // Check if already logged in
        if (authToken && currentUser && currentUser.id) {
            console.log(' Auto-login with saved session:', currentUser);
            // Auto-login
            setTimeout(() => {
                document.getElementById('userName').textContent = currentUser.first_name || 'Utilisateur';
                document.getElementById('profileFirstName').value = currentUser.first_name || '';
                if (currentUser.email) document.getElementById('profileEmail').value = currentUser.email;
                console.log(' Profile loaded from localStorage:', currentUser.first_name, currentUser.email);
                
                // Check if onboarding was completed
                const onboardingDone = localStorage.getItem('fixair_onboarding_done');
                if (onboardingDone) {
                    onboardingComplete = true;
                    document.querySelector('.onboarding-section').classList.add('hidden');
                    document.getElementById('homepageContent').classList.add('active');
                } else {
                    // Show onboarding for returning users who haven't completed it
                    onboardingComplete = false;
                    document.querySelector('.onboarding-section').classList.remove('hidden');
                    // Homepage stays hidden (no 'active' class)
                }
                
                document.getElementById('loginScreen').classList.remove('active');
                document.getElementById('mainApp').classList.add('active');
                
                //  SUPABASE: Load projects list 
                loadProjectsList();
                //  GAMIFICATION: Initialize stats 
                initGamification();
                //  END SUPABASE 
            }, 500);
        } else {
            // Clear any partial/invalid auth data
            localStorage.removeItem('fixair_token');
            localStorage.removeItem('fixair_user');
            authToken = null;
            currentUser = null;
        }

        // LOGIN STEPS
        async function nextLoginStep() {
            const btn = document.getElementById('loginBtn');
            console.log(' nextLoginStep called, current step:', loginStep);
            
            if (loginStep === 0) {
                // Step 0: Check email
                const email = document.getElementById('loginEmail').value.trim();
                console.log(' Email entered:', email);
                if (!email.includes('@')) { toast('Email invalide'); return; }
                
                btn.disabled = true;
                btn.innerHTML = '<span class="icon" style="animation: spin 1s linear infinite;"><svg><use href="#icon-arrow-right"/></svg></span>';
                
                try {
                    console.log(' Calling check-email API...');
                    const response = await fetch(`${API_BASE}/auth/check-email`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ email })
                    });
                    console.log(' Response status:', response.status);
                    const data = await response.json();
                    console.log(' Check email response:', data);
                    
                    isNewUser = (data.exists === false);
                    console.log(' Is new user:', isNewUser);
                    
                    // Update password placeholder based on user type
                    const pwdInput = document.getElementById('loginPassword');
                    if (isNewUser) {
                        pwdInput.placeholder = 'Crez votre mot de passe';
                    } else {
                        pwdInput.placeholder = 'Entrez votre mot de passe';
                    }
                    
                    loginStep = 1;
                    updateLoginUI();
                    
                } catch (error) {
                    console.error(' Check email error:', error);
                    toast('Erreur de connexion');
                    
                    // Safari fallback: proceed anyway assuming new user
                    console.log(' Fallback: proceeding as new user');
                    isNewUser = true;
                    loginStep = 1;
                    updateLoginUI();
                } finally {
                    btn.disabled = false;
                    btn.innerHTML = '<span class="icon"><svg><use href="#icon-arrow-right"/></svg></span>';
                }
                
            } else if (loginStep === 1) {
                // Step 1: Password
                const email = document.getElementById('loginEmail').value.trim();
                const password = document.getElementById('loginPassword').value;
                
                if (password.length < 6) { toast('Mot de passe: 6 caractres minimum'); return; }
                
                if (isNewUser) {
                    // New user: go to name step
                    loginStep = 2;
                    document.getElementById('loginBtn').innerHTML = '<span class="icon"><svg><use href="#icon-check"/></svg></span>';
                    document.getElementById('loginBtn').onclick = completeLogin;
                    updateLoginUI();
                } else {
                    // Existing user: try login
                    btn.disabled = true;
                    btn.innerHTML = '<span class="icon" style="animation: spin 1s linear infinite;"><svg><use href="#icon-arrow-right"/></svg></span>';
                    
                    try {
                        const response = await fetch(`${API_BASE}/auth/login`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ email, password })
                        });
                        
                        const data = await response.json();
                        console.log('Login response:', response.status, data);
                        
                        // Check both response status and success flag
                        if (response.ok && data.success === true && data.token) {
                            // Save auth data
                            authToken = data.token;
                            currentUser = data.user;
                            localStorage.setItem('fixair_token', authToken);
                            localStorage.setItem('fixair_user', JSON.stringify(currentUser));
                            
                            // Update UI with user info
                            document.getElementById('userName').textContent = currentUser.first_name;
                            document.getElementById('profileFirstName').value = currentUser.first_name;
                            if (currentUser.email) document.getElementById('profileEmail').value = currentUser.email;
                            
                            // Existing user - skip onboarding, go to main app
                            onboardingComplete = true;
                            document.querySelector('.onboarding-section').classList.add('hidden');
                            document.getElementById('homepageContent').classList.add('active');
                            localStorage.setItem('fixair_onboarding_done', 'true');
                            
                            toast('Bienvenue ' + currentUser.first_name + ' !');
                            doLogin();
                        } else {
                            // Login failed - show error, do NOT proceed
                            toast(data.error || 'Email ou mot de passe incorrect');
                        }
                    } catch (error) {
                        toast('Erreur de connexion au serveur');
                        console.error('Login error:', error);
                    } finally {
                        btn.disabled = false;
                        btn.innerHTML = '<span class="icon"><svg><use href="#icon-arrow-right"/></svg></span>';
                    }
                }
            }
        }
        
        function updateLoginUI() {
            document.getElementById('loginSlider').style.transform = `translateX(-${loginStep * 100}%)`;
            document.getElementById('loginSphere').style.display = loginStep === 0 ? 'flex' : 'none';
            document.getElementById('loginBack').style.display = loginStep === 0 ? 'none' : 'flex';
        }

        function prevLoginStep() {
            if (loginStep > 0) {
                loginStep--;
                updateLoginUI();
                if (loginStep < 2) {
                    document.getElementById('loginBtn').innerHTML = '<span class="icon"><svg><use href="#icon-arrow-right"/></svg></span>';
                    document.getElementById('loginBtn').onclick = nextLoginStep;
                }
            }
        }

        async function completeLogin() {
            const name = document.getElementById('loginName').value.trim();
            if (!name) { toast('Entrez votre prnom'); return; }
            
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value;
            
            const btn = document.getElementById('loginBtn');
            btn.disabled = true;
            btn.innerHTML = '<span class="icon" style="animation: spin 1s linear infinite;"><svg><use href="#icon-check"/></svg></span>';
            
            try {
                const response = await fetch(`${API_BASE}/auth/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password, first_name: name })
                });
                const data = await response.json();
                
                if (data.success) {
                    // Save auth data
                    authToken = data.token;
                    currentUser = data.user;
                    localStorage.setItem('fixair_token', authToken);
                    localStorage.setItem('fixair_user', JSON.stringify(currentUser));
                    
                    // Update UI with user info
                    document.getElementById('userName').textContent = name;
                    document.getElementById('profileFirstName').value = name;
                    document.getElementById('profileEmail').value = email;
                    
                    toast('Compte cr !');
                    
                    // New user - show onboarding
                    document.getElementById('loginScreen').classList.remove('active');
                    document.getElementById('mainApp').classList.add('active');
                    
                    //  LOAD DATA after login 
                    loadProjectsList();
                    initGamification();
                } else {
                    toast(data.error || 'Erreur lors de la cration du compte');
                }
            } catch (error) {
                toast('Erreur de connexion');
                console.error('Register error:', error);
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<span class="icon"><svg><use href="#icon-check"/></svg></span>';
            }
        }

        function doLogin() {
            document.getElementById('loginScreen').classList.remove('active');
            document.getElementById('mainApp').classList.add('active');
            
            // Load projects and initialize gamification
            loadProjectsList();
            initGamification();
        }
        
        function logout() {
            localStorage.removeItem('fixair_token');
            localStorage.removeItem('fixair_user');
            localStorage.removeItem('fixair_onboarding_done');
            authToken = null;
            currentUser = null;
            loginStep = 0;
            isNewUser = false;
            onboardingComplete = false;
            
            // Close profile view first
            document.getElementById('profileView').classList.remove('active');
            
            // Reset onboarding section visibility
            document.querySelector('.onboarding-section').classList.remove('hidden');
            
            // Reset homepage content
            document.getElementById('homepageContent').classList.remove('active');
            
            // Reset UI
            document.getElementById('loginEmail').value = '';
            document.getElementById('loginPassword').value = '';
            document.getElementById('loginName').value = '';
            document.getElementById('loginSlider').style.transform = 'translateX(0)';
            document.getElementById('loginSphere').style.display = 'flex';
            document.getElementById('loginBack').style.display = 'none';
            document.getElementById('loginBtn').innerHTML = '<span class="icon"><svg><use href="#icon-arrow-right"/></svg></span>';
            document.getElementById('loginBtn').onclick = nextLoginStep;
            
            document.getElementById('mainApp').classList.remove('active');
            document.getElementById('loginScreen').classList.add('active');
            
            toast('Dconnect');
        }

        // PROFILE
        function openProfile() {
            document.getElementById('profileView').classList.add('active');
        }

        function closeProfile() {
            document.getElementById('profileView').classList.remove('active');
        }

        async function saveProfile() {
            const firstName = document.getElementById('profileFirstName').value.trim();
            const email = document.getElementById('profileEmail').value.trim();
            
            if (!firstName) { toast('Entrez votre prnom'); return; }
            
            // Update UI immediately
            document.getElementById('userName').textContent = firstName;
            
            //  SAVE TO LOCALSTORAGE (ALWAYS WORKS) 
            const savedUser = JSON.parse(localStorage.getItem('fixair_user') || '{}');
            savedUser.first_name = firstName;
            if (email) savedUser.email = email;
            localStorage.setItem('fixair_user', JSON.stringify(savedUser));
            currentUser = savedUser;
            console.log(' Profile saved to localStorage:', savedUser);
            
            let dbSaveSuccess = false;
            
            //  SAVE TO SUPABASE users table 
            if (savedUser.id && typeof db !== 'undefined') {
                try {
                    console.log(' Updating Supabase users table...', {
                        id: savedUser.id,
                        first_name: firstName,
                        email: email
                    });
                    
                    const { data, error } = await db
                        .from('users')
                        .update({ 
                            first_name: firstName,
                            email: email,
                            updated_at: new Date().toISOString()
                        })
                        .eq('id', savedUser.id)
                        .select();
                    
                    if (error) {
                        console.error(' Supabase update error:', error);
                        
                        // If table doesn't exist or record not found, try insert
                        if (error.code === '42P01' || error.code === 'PGRST116') {
                            console.log(' Table or record not found, trying upsert...');
                            const { error: upsertError } = await db
                                .from('users')
                                .upsert({ 
                                    id: savedUser.id,
                                    first_name: firstName,
                                    email: email,
                                    updated_at: new Date().toISOString()
                                });
                            
                            if (!upsertError) {
                                console.log(' Profile upserted to Supabase');
                                dbSaveSuccess = true;
                            } else {
                                console.error(' Upsert also failed:', upsertError);
                            }
                        }
                    } else {
                        console.log(' Profile updated in Supabase:', data);
                        dbSaveSuccess = true;
                    }
                } catch (e) {
                    console.error(' Supabase exception:', e);
                }
            }
            
            //  ALSO TRY n8n API (if endpoint exists) 
            if (savedUser.id && authToken && !dbSaveSuccess) {
                try {
                    console.log(' Calling n8n update-profile API...');
                    const response = await fetch(`${API_BASE}/auth/update-profile`, {
                        method: 'POST',
                        headers: { 
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${authToken}`
                        },
                        body: JSON.stringify({ 
                            user_id: savedUser.id,
                            first_name: firstName,
                            email: email
                        })
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        console.log(' Profile saved via n8n API:', data);
                        dbSaveSuccess = true;
                    } else {
                        console.log(' n8n API returned:', response.status);
                    }
                } catch (error) {
                    console.log(' n8n API not available:', error.message);
                }
            }
            
            if (dbSaveSuccess) {
                toast('Profil enregistr ');
            } else {
                toast('Profil enregistr localement');
                console.warn(' Profile only saved to localStorage - database update failed');
            }
            
            // Handle onboarding step progression
            if (onboardingStep === 1) {
                completeStep(1);
                document.getElementById('step2').classList.remove('locked');
                document.getElementById('step2').classList.add('active');
                document.getElementById('step2Check').classList.remove('pending');
                document.getElementById('step2Check').classList.add('current');
                onboardingStep = 2;
                updateOnboardingProgress();
            }
            closeProfile();
        }

        // BRAND SELECT (ONBOARDING)
        function toggleBrandSelect() {
            if (onboardingStep < 2) return;
            document.getElementById('brandSelectInline').classList.toggle('show');
        }

        function selectBrandInline(b) {
            onboardingBrand = b;
            brand = b;
            
            document.querySelectorAll('.brand-select-option').forEach(opt => {
                opt.classList.toggle('selected', opt.dataset.brand === b);
            });
            
            // Update header pill with green dot only
            document.getElementById('brandText').textContent = names[b];
            document.getElementById('brandPill').classList.add('has-brand');
            document.getElementById('copilotSub').textContent = names[b];
            document.getElementById('assistantSub').textContent = names[b];
            
            // Update dropdown - only selected shows green dot
            document.querySelectorAll('.brand-dropdown-item[data-b]').forEach(o => {
                o.classList.remove('selected', 'onboard-selected');
                if (o.dataset.b === b) o.classList.add('onboard-selected');
            });
            document.querySelectorAll('.brand-chip').forEach(c => c.classList.toggle('active', c.dataset.b === b));
            
            //  FIX: Update brand context in fresh chat 
            if (!currentProjectId && typeof updateBrandContextInHistory === 'function') {
                updateBrandContextInHistory();
            }
            //  END FIX 
            
            setTimeout(() => completeBrandStep(), 300);
        }

        function completeBrandStep() {
            if (onboardingStep === 2) {
                completeStep(2);
                document.getElementById('brandSelectInline').classList.remove('show');
                // Unlock BOTH step 3 and step 4 - user can do either first
                document.getElementById('step3').classList.remove('locked');
                document.getElementById('step3').classList.add('active');
                document.getElementById('step3Check').classList.remove('pending');
                document.getElementById('step3Check').classList.add('current');
                document.getElementById('step4').classList.remove('locked');
                document.getElementById('step4').classList.add('active');
                document.getElementById('step4Check').classList.remove('pending');
                document.getElementById('step4Check').classList.add('current');
                onboardingStep = 3;
                updateOnboardingProgress();
            }
        }

        // STEP HANDLERS - Allow either order and re-entry
        function handleStep3Click() {
            // Accessible after brand selection (step 2) or if step4 already done
            if (onboardingStep < 3 && !step4Done) return;
            openChat('copilot');
        }

        function handleStep4Click() {
            // Accessible after brand selection (step 2) or if step3 already done
            if (onboardingStep < 3 && !step3Done) return;
            openChat('assistant');
        }

        function completeStep(n) {
            const step = document.getElementById('step' + n);
            const check = document.getElementById('step' + n + 'Check');
            step.classList.remove('active');
            step.classList.add('completed');
            check.classList.remove('current');
            check.classList.add('done');
            check.innerHTML = '<svg viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"/></svg>';
        }

        function updateOnboardingProgress() {
            // Count completed steps: step1 (profile), step2 (brand), step3 (copilot), step4 (assistant)
            let completed = 0;
            if (onboardingStep >= 2) completed = 1; // Profile done
            if (onboardingStep >= 3) completed = 2; // Brand done
            if (step3Done) completed = Math.max(completed, 3);
            if (step4Done) completed = Math.max(completed, step3Done ? 4 : 3);
            if (step3Done && step4Done) completed = 4;
            document.getElementById('onboardingProgress').textContent = completed + '/4';
        }

        function showCongrats() {
            document.getElementById('welcomeSection').style.display = 'none';
            document.getElementById('onboardingCard').classList.add('congrats');
            onboardingComplete = true;
        }

        function closeCongrats() {
            document.getElementById('onboardingSection').classList.add('hidden');
            document.getElementById('homepageContent').classList.add('active');
            // Trigger celebration when onboarding complete
            setTimeout(() => onReturnToHomepage(), 500);
        }

        function goToHome() {
            // Close any open views
            closeChat();
            closeProfile();
            document.getElementById('hotlineView').classList.remove('active');
            // Go to home page
            showPage('home');
            
            //  REFRESH DATA when returning to homepage 
            if (currentUserId) {
                // Reload projects list
                loadProjectsList();
                // Refresh gamification stats with celebration check
                setTimeout(() => onReturnToHomepage(), 300);
            }
        }

        function showPage(page) {
            currentPage = page;
            document.getElementById('homePage').style.display = page === 'home' ? 'flex' : 'none';
            document.getElementById('projectsPage').classList.toggle('active', page === 'projects');
            document.getElementById('navHome').classList.toggle('active', page === 'home');
            document.getElementById('navProjects').classList.toggle('active', page === 'projects');
        }

        function toggleBrandDropdown() {
            const pill = document.getElementById('brandPill');
            const dropdown = document.getElementById('brandDropdown');
            pill.classList.toggle('open');
            dropdown.classList.toggle('show');
        }

        function closeBrandDropdown() {
            document.getElementById('brandPill').classList.remove('open');
            document.getElementById('brandDropdown').classList.remove('show');
        }

        function setBrand(b) {
            brand = b;
            document.getElementById('brandText').textContent = names[b];
            document.getElementById('copilotSub').textContent = names[b];
            document.getElementById('assistantSub').textContent = names[b];
            document.querySelectorAll('.brand-dropdown-item[data-b]').forEach(o => o.classList.toggle('selected', o.dataset.b === b));
            document.querySelectorAll('.brand-chip').forEach(c => c.classList.toggle('active', c.dataset.b === b));
            closeBrandDropdown();
            
            //  FIX: Update brand context in fresh chat if no project created yet 
            if (!currentProjectId) {
                updateBrandContextInHistory();
            }
            //  END FIX 
        }
        
        // Helper function to update brand context in chat history
        function updateBrandContextInHistory() {
            const brandNames = {
                'mitsubishi': 'Mitsubishi Electric',
                'daikin': 'Daikin',
                'carrier': 'Carrier',
                'lg': 'LG',
                'samsung': 'Samsung',
                'panasonic': 'Panasonic',
                'toshiba': 'Toshiba',
                'fujitsu': 'Fujitsu',
                'hitachi': 'Hitachi',
                'general': 'Multi-marques'
            };
            const brandName = brandNames[brand] || brand;
            
            // Update context for both panels
            ['assistant', 'copilot'].forEach(panel => {
                const brandContext = panel === 'assistant' 
                    ? `[CONTEXTE MARQUE] Cette intervention concerne un systme ${brandName}. Tu connais dj la marque = ${brandName}. NE DEMANDE JAMAIS la marque. Premier message: "Salut ! Tu travailles sur un systme ${brandName}. C'est quoi aujourd'hui ? 1. Dpannage 2. Mise en service 3. Maintenance 4. Installation"`
                    : `[CONTEXTE MARQUE] Ce diagnostic concerne un systme ${brandName}. Tu connais dj la marque = ${brandName}. NE DEMANDE JAMAIS la marque. Utilise la base de connaissances ${brandName}. Premier message: "Salut ! Tu travailles sur un systme ${brandName}. Comment puis-je t'aider ?"`;
                
                // Find and update or add system message
                const systemMsgIndex = chatHistory[panel].findIndex(m => m.role === 'system');
                if (systemMsgIndex >= 0) {
                    chatHistory[panel][systemMsgIndex].content = brandContext;
                } else if (chatHistory[panel].length === 0) {
                    chatHistory[panel].push({ role: 'system', content: brandContext });
                }
            });
            
            console.log(' Brand context updated:', brandName);
        }

        // 
        // CHAT HEADER BRAND DROPDOWN (Option B)
        // 
        
        // Toggle brand dropdown in chat header
        function toggleChatBrandDropdown(panel) {
            const wrapper = document.getElementById(panel + 'BrandWrapper');
            const isOpen = wrapper.classList.contains('open');
            
            // Close all dropdowns first
            closeChatBrandDropdowns();
            
            if (!isOpen) {
                wrapper.classList.add('open');
                updateChatBrandDropdownSelection(panel);
                
                // Close when clicking outside
                setTimeout(() => {
                    document.addEventListener('click', closeChatBrandDropdownsOnClick);
                }, 10);
            }
        }
        
        // Close all chat brand dropdowns
        function closeChatBrandDropdowns() {
            document.getElementById('copilotBrandWrapper')?.classList.remove('open');
            document.getElementById('assistantBrandWrapper')?.classList.remove('open');
            document.removeEventListener('click', closeChatBrandDropdownsOnClick);
        }
        
        // Close dropdowns when clicking outside
        function closeChatBrandDropdownsOnClick(e) {
            if (!e.target.closest('.panel-brand-wrapper')) {
                closeChatBrandDropdowns();
            }
        }
        
        // Update dropdown selection indicators
        function updateChatBrandDropdownSelection(panel) {
            const dropdown = document.getElementById(panel + 'BrandDropdown');
            if (!dropdown) return;
            
            dropdown.querySelectorAll('.panel-brand-option').forEach(opt => {
                opt.classList.toggle('selected', opt.dataset.brand === brand);
            });
        }
        
        // Change brand from chat header dropdown
        async function changeChatBrand(newBrand, panel) {
            const oldBrand = brand;
            
            if (newBrand === oldBrand) {
                closeChatBrandDropdowns();
                return;
            }
            
            const brandNames = {
                'mitsubishi': 'Mitsubishi Electric',
                'daikin': 'Daikin',
                'carrier': 'Carrier',
                'lg': 'LG',
                'samsung': 'Samsung',
                'panasonic': 'Panasonic',
                'toshiba': 'Toshiba',
                'fujitsu': 'Fujitsu',
                'hitachi': 'Hitachi',
                'general': 'Multi-marques'
            };
            
            const oldBrandName = brandNames[oldBrand] || oldBrand;
            const newBrandName = brandNames[newBrand] || newBrand;
            
            // Update global brand
            brand = newBrand;
            
            // Update UI everywhere
            document.getElementById('copilotSub').textContent = newBrandName;
            document.getElementById('assistantSub').textContent = newBrandName;
            document.getElementById('brandText').textContent = newBrandName;
            
            // Update home page dropdowns if visible
            document.querySelectorAll('.brand-dropdown-item[data-b]').forEach(o => {
                o.classList.toggle('selected', o.dataset.b === newBrand);
            });
            document.querySelectorAll('.brand-chip').forEach(c => {
                c.classList.toggle('active', c.dataset.b === newBrand);
            });
            
            // Update chat history with new brand context
            updateBrandContextInHistory();
            
            // Update database if project exists
            if (currentProjectId) {
                try {
                    // First, get current project to check if original_brand is set
                    const { data: currentProject } = await db
                        .from('projects')
                        .select('original_brand, brand')
                        .eq('id', currentProjectId)
                        .single();
                    
                    // Build update data
                    const updateData = { brand: newBrand };
                    
                    // Only set original_brand if not already set (first change only)
                    if (!currentProject?.original_brand && currentProject?.brand) {
                        updateData.original_brand = oldBrand;
                    }
                    
                    const { error } = await db
                        .from('projects')
                        .update(updateData)
                        .eq('id', currentProjectId);
                    
                    if (error) {
                        console.error(' Error updating project brand:', error);
                    } else {
                        console.log(' Project brand updated to:', newBrand);
                    }
                } catch (e) {
                    console.error(' Failed to update brand in database:', e);
                }
            }
            
            // Close dropdown
            closeChatBrandDropdowns();
            
            // Add confirmation message in chat
            const confirmMsg = `<p style="color: var(--mode-color);"> Marque change: <strong>${oldBrandName}</strong>  <strong>${newBrandName}</strong></p><p style="font-size: 12px; opacity: 0.7;">On continue avec ${newBrandName}.</p>`;
            addMsg(panel, 'ai', confirmMsg);
            
            console.log(' Brand changed in chat:', oldBrand, '', newBrand);
        }

        // Old updateRing removed - now using gamification refreshWeeklyStats()

        // Track if we're opening from an existing project
        let openingFromProject = false;
        
        function openChat(m) {
            mode = m;
            // Update viewport height for mobile browsers
            if (typeof setViewportHeight === 'function') setViewportHeight();
            
            const cv = document.getElementById('chatView');
            // Use full visible height - nav is hidden via CSS when chat is open
            const visibleHeight = typeof getVisibleHeight === 'function' ? getVisibleHeight() : window.innerHeight;
            cv.style.height = `${visibleHeight}px`;
            
            cv.classList.add('active');
            cv.classList.remove('split');
            cv.classList.add('single');
            isSplit = false;
            document.getElementById('panelCopilot').style.flexBasis = '';
            document.getElementById('panelAssistant').style.flexBasis = '';
            document.getElementById('panelCopilot').style.display = m === 'copilot' ? 'flex' : 'none';
            document.getElementById('panelAssistant').style.display = m === 'assistant' ? 'flex' : 'none';
            document.getElementById('divider').style.display = 'none';
            updateModeToggle(m);
            
            //  FIX: Handle project state based on whether we're opening from an existing project 
            const isFromProject = openingFromProject;
            openingFromProject = false; // Reset flag immediately
            
            if (isFromProject) {
                // Opening existing project - keep the loaded messages
                console.log(' Opening existing project:', currentProjectId);
                // Don't clear body - messages are already loaded
            } else {
                // Starting fresh chat - reset everything
                console.log(' Opening fresh chat - resetting project state');
                currentProjectId = null;
                currentChatId = { assistant: null, copilot: null };
                currentProjectTitle = null;
                projectMessageCount = 0;
                window.reportPhotos = []; // Reset photos for new project
                
                //  FIX: Add brand context as FIRST message in history 
                const brandNames = {
                    'mitsubishi': 'Mitsubishi Electric',
                    'daikin': 'Daikin',
                    'carrier': 'Carrier',
                    'lg': 'LG',
                    'samsung': 'Samsung',
                    'panasonic': 'Panasonic',
                    'toshiba': 'Toshiba',
                    'fujitsu': 'Fujitsu',
                    'hitachi': 'Hitachi',
                    'general': 'Multi-marques'
                };
                const brandName = brandNames[brand] || brand;
                
                // Create brand context message for the AI
                const brandContext = m === 'assistant' 
                    ? `[CONTEXTE - NOUVELLE CONVERSATION]
MARQUE: ${brandName}
MODE: Assistant Rapport
INSTRUCTIONS STRICTES:
- Tu connais DJ la marque = ${brandName}
- NE DEMANDE JAMAIS la marque, elle est confirme
- Demande le type d'intervention: Dpannage, Mise en service, Maintenance, ou Installation
- Ensuite pose les questions ncessaires pour gnrer un rapport professionnel
Premier message suggr: "Salut ! Tu travailles sur un systme ${brandName}. C'est quoi aujourd'hui ? 1. Dpannage 2. Mise en service 3. Maintenance 4. Installation"`
                    : `[CONTEXTE - NOUVELLE CONVERSATION]
MARQUE: ${brandName}
MODE: Copilot Diagnostic
INSTRUCTIONS STRICTES:
- Tu connais DJ la marque = ${brandName}
- NE DEMANDE JAMAIS la marque, elle est confirme
- Utilise la base de connaissances ${brandName} pour les codes erreur
- Aide au diagnostic avec des questions cibles
Premier message suggr: "Salut ! Tu travailles sur un systme ${brandName}. Quel est le problme ou code erreur ?"`;
                
                chatHistory.assistant = [];
                chatHistory.copilot = [];
                
                // Add brand context as first system message
                chatHistory[m].push({ 
                    role: 'system', 
                    content: brandContext 
                });
                
                console.log(' Brand context added to history:', brandName);
                //  END FIX 
                
                updateChatHeader();
                
                // Clear body for fresh start
                document.getElementById('copilotBody').innerHTML = '';
                document.getElementById('assistantBody').innerHTML = '';
                
                // Show welcome message
                const wel = {
                    copilot: `Bonjour ! <strong style="color:var(--copilot)">FixAIR Copilot</strong> prt pour <strong>${brandName}</strong>. Comment puis-je vous aider ?`,
                    assistant: `<strong style="color:var(--assistant)">FixAIR Assistant</strong> prt pour <strong>${brandName}</strong>. Dcrivez l'intervention et je gnre le rapport.`
                };
                addMsg(m, 'ai', wel[m]);
            }
            //  END FIX 
            
            closeAllAttach();
            
            // Scroll to bottom of active chat
            setTimeout(() => {
                scrollToBottom(m);
                initScrollDetection(m);
            }, 100);
        }

        function closeChat() {
            document.getElementById('chatView').classList.remove('active');
            closeReport();
            closeAllAttach();
            
            // Recalculate viewport
            if (typeof setViewportHeight === 'function') setViewportHeight();
            
            // Check onboarding completion - works regardless of order
            if (!onboardingComplete) {
                const copilotHasUserMsg = document.querySelectorAll('#copilotBody .msg.user').length > 0;
                const assistantHasUserMsg = document.querySelectorAll('#assistantBody .msg.user').length > 0;
                
                // Check Copilot step (step 3) if user sent message in Copilot
                if (copilotHasUserMsg && !step3Done) {
                    step3Done = true;
                    completeStep(3);
                    // If step 4 not done, make it active
                    if (!step4Done) {
                        document.getElementById('step4').classList.remove('locked');
                        document.getElementById('step4').classList.add('active');
                        document.getElementById('step4Check').classList.remove('pending');
                        document.getElementById('step4Check').classList.add('current');
                    }
                    updateOnboardingProgress();
                }
                
                // Check Assistant step (step 4) if user sent message in Assistant
                if (assistantHasUserMsg && !step4Done) {
                    step4Done = true;
                    completeStep(4);
                    // If step 3 not done, make it active
                    if (!step3Done) {
                        document.getElementById('step3').classList.remove('locked');
                        document.getElementById('step3').classList.add('active');
                        document.getElementById('step3Check').classList.remove('pending');
                        document.getElementById('step3Check').classList.add('current');
                    }
                    updateOnboardingProgress();
                }
                
                // If both done, show congrats
                if (step3Done && step4Done && !onboardingComplete) {
                    onboardingStep = 5;
                    updateOnboardingProgress();
                    showCongrats();
                }
            }
        }

        function updateModeToggle(activeMode) {
            const copilotPanel = document.getElementById('panelCopilot');
            copilotPanel.querySelectorAll('.mode-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.classList.contains(activeMode)) btn.classList.add('active');
            });
            const assistantPanel = document.getElementById('panelAssistant');
            assistantPanel.querySelectorAll('.mode-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.classList.contains(activeMode)) btn.classList.add('active');
            });
        }

        async function switchMode(m) {
            if(isSplit) return;
            mode = m;
            document.getElementById('panelCopilot').style.display = m === 'copilot' ? 'flex' : 'none';
            document.getElementById('panelAssistant').style.display = m === 'assistant' ? 'flex' : 'none';
            updateModeToggle(m);
            
            //  SUPABASE: Load or create chat for this mode 
            if (currentProjectId && !currentChatId[m]) {
                // Check if chat exists for this mode in current project
                const { data: existingChat } = await db
                    .from('chats')
                    .select()
                    .eq('project_id', currentProjectId)
                    .eq('chat_type', m)
                    .single();
                
                if (existingChat) {
                    currentChatId[m] = existingChat.id;
                    
                    // Load messages for this chat
                    const { data: messages } = await db
                        .from('messages')
                        .select('*')
                        .eq('chat_id', existingChat.id)
                        .order('created_at', { ascending: true });
                    
                    // Clear and reload chat
                    const body = document.getElementById(m + 'Body');
                    if (body) body.innerHTML = '';
                    chatHistory[m] = [];
                    
                    for (const msg of messages || []) {
                        const role = msg.role === 'assistant' ? 'ai' : msg.role;
                        if (role === 'user' || role === 'ai') {
                            // Check if this is an image message
                            if (msg.content_type === 'image' && msg.content.startsWith('data:image')) {
                                // Render as photo
                                const msgId = 'photo-' + Date.now() + '-' + Math.random().toString(36).substr(2, 5);
                                const msgDiv = document.createElement('div');
                                msgDiv.className = 'msg user';
                                msgDiv.id = msgId;
                                
                                // Check if this photo was already added to report
                                const isInReport = window.reportPhotos?.some(p => p.url === msg.content || p.data === msg.content);
                                msgDiv.innerHTML = createPhotoMessageHTML(msgId, m, msg.content, isInReport);
                                msgDiv.dataset.imageData = msg.content;
                                
                                body.appendChild(msgDiv);
                            } else if (msg.content_type === 'ocr') {
                                // Render OCR result message
                                try {
                                    const ocrData = JSON.parse(msg.content);
                                    // Find source image from previous messages
                                    const sourceImg = findSourceImage(messages, ocrData.sourcePhotoId);
                                    renderOCRMessage(m, ocrData, sourceImg);
                                } catch (e) {
                                    console.error('Error parsing OCR message:', e);
                                }
                            } else {
                                // Regular text message
                                const content = role === 'ai' ? parseMarkdown(msg.content) : msg.content;
                                addMsg(m, role, content);
                            }
                            chatHistory[m].push({ role: msg.role, content: msg.content });
                        }
                    }
                    console.log(' Loaded existing chat for', m);
                    return;
                } else {
                    // Create new chat in same project
                    const userId = await getCurrentUserId();
                    if (userId && !userId.startsWith('demo-')) {
                        const { data: newChat } = await db
                            .from('chats')
                            .insert({
                                project_id: currentProjectId,
                                user_id: userId,
                                chat_type: m,
                                is_active: true
                            })
                            .select()
                            .single();
                        
                        if (newChat) {
                            currentChatId[m] = newChat.id;
                            console.log(' Created new chat for', m, 'in project', currentProjectId);
                        }
                    }
                }
            }
            //  END SUPABASE 
            
            const body = document.getElementById(m + 'Body');
            if(!body.innerHTML) {
                const wel = m === 'copilot' 
                    ? `Bonjour ! <strong style="color:var(--copilot)">FixAIR Copilot</strong> prt pour <strong>${names[brand]}</strong>.`
                    : `<strong style="color:var(--assistant)">FixAIR Assistant</strong> prt.`;
                addMsg(m, 'ai', wel);
            }
        }

        function toggleSplit() {
            const cv = document.getElementById('chatView');
            const div = document.getElementById('divider');
            isSplit = !isSplit;
            
            // Update viewport and use full visible height
            if (typeof setViewportHeight === 'function') setViewportHeight();
            const visibleHeight = typeof getVisibleHeight === 'function' ? getVisibleHeight() : window.innerHeight;
            cv.style.height = `${visibleHeight}px`;
            
            if(isSplit) {
                cv.classList.remove('single');
                cv.classList.add('split');
                document.getElementById('panelCopilot').style.flexBasis = '50%';
                document.getElementById('panelAssistant').style.flexBasis = '50%';
                document.getElementById('panelCopilot').style.display = 'flex';
                document.getElementById('panelAssistant').style.display = 'flex';
                div.style.display = 'flex';
                document.querySelectorAll('.h-btn[title="Mode split"]').forEach(b => b.classList.add('active'));
                
                const copilotPanel = document.getElementById('panelCopilot');
                copilotPanel.querySelectorAll('.mode-btn').forEach(btn => {
                    btn.classList.toggle('active', btn.classList.contains('copilot'));
                });
                const assistantPanel = document.getElementById('panelAssistant');
                assistantPanel.querySelectorAll('.mode-btn').forEach(btn => {
                    btn.classList.toggle('active', btn.classList.contains('assistant'));
                });
                
                if(!document.getElementById('assistantBody').innerHTML) 
                    addMsg('assistant', 'ai', `<strong style="color:var(--assistant)">FixAIR Assistant</strong> prt.`);
                if(!document.getElementById('copilotBody').innerHTML) 
                    addMsg('copilot', 'ai', `<strong style="color:var(--copilot)">FixAIR Copilot</strong> prt.`);
            } else {
                cv.classList.remove('split');
                cv.classList.add('single');
                document.getElementById('panelCopilot').style.flexBasis = '';
                document.getElementById('panelAssistant').style.flexBasis = '';
                document.getElementById('panelCopilot').style.display = mode === 'copilot' ? 'flex' : 'none';
                document.getElementById('panelAssistant').style.display = mode === 'assistant' ? 'flex' : 'none';
                div.style.display = 'none';
                document.querySelectorAll('.h-btn[title="Mode split"]').forEach(b => b.classList.remove('active'));
                updateModeToggle(mode);
            }
        }

        function openReport() {
            document.getElementById('reportSheet').classList.add('open');
            document.getElementById('reportBackdrop').classList.add('show');
            
            // Build partial report from conversation if no full report yet
            if (!lastReportData && mode === 'assistant') {
                buildPartialReport();
            } else if (lastReportData) {
                // Update preview with latest data
                updateDrawerPreview(lastReportData);
            }
        }
        
        function closeReport() {
            document.getElementById('reportSheet').classList.remove('open');
            document.getElementById('reportBackdrop').classList.remove('show');
        }

        function addMsg(panel, type, content) {
            const body = document.getElementById(panel + 'Body');
            const msg = document.createElement('div');
            
            // Detect if this is a report message (contains report keywords/headers)
            const isReport = type === 'ai' && (
                content.includes('RAPPORT D') || 
                content.includes('RAPPORT') ||
                (content.includes('<h2>') && content.includes('Client'))
            );
            
            msg.className = 'msg ' + type + (isReport ? ' report' : '');
            const modeName = panel === 'copilot' ? 'Copilot' : 'Assistant';
            const modeIcon = panel === 'copilot' ? '#icon-star' : '#icon-clipboard';
            
            if(type === 'user') {
                msg.innerHTML = `<div class="msg-bubble">${content}</div>`;
            } else {
                msg.innerHTML = `<div class="msg-bubble"><div class="msg-head"><div class="msg-avatar"><span class="icon"><svg><use href="${modeIcon}"/></svg></span></div><span class="msg-name">FixAIR ${modeName}</span></div><span class="msg-act" onclick="copyTxt(this)" title="Copier"><span class="icon"><svg><use href="#icon-copy"/></svg></span></span>${content}</div>`;
            }
            body.appendChild(msg);
            body.scrollTop = body.scrollHeight;
        }

        // ==================== VOICE WAVEFORM SYSTEM ====================
        const MAX_BARS = 400;
        const MIN_HEIGHT = 3;
        const MAX_HEIGHT = 28;
        const SILENCE_THRESHOLD = 0.08;
        
        let recordings = {};
        let audioContexts = {};
        let analysers = {};
        let waveformIntervals = {};
        let voiceTimers = {};
        let simulatedSpeaking = {};
        let simulatedIntensityTarget = {};
        let simulatedIntensityCurrent = {};
        
        // Handle input text changes - auto-resize and switch between mic/send
        function handleChatInput(panel) {
            const input = document.getElementById(panel + 'Input');
            const inputRow = document.getElementById(panel + 'InputRow');
            const btn = document.getElementById(panel + 'ActionBtn');
            const hasText = input.value.trim().length > 0;
            
            // Auto-resize textarea
            const maxHeight = Math.floor(window.innerHeight * 0.25); // 25% of viewport
            input.style.height = 'auto';
            const scrollHeight = input.scrollHeight;
            
            if (scrollHeight <= maxHeight) {
                input.style.height = scrollHeight + 'px';
                input.classList.remove('scrollable');
                input.style.overflowY = 'hidden';
            } else {
                input.style.height = maxHeight + 'px';
                input.classList.add('scrollable');
                input.style.overflowY = 'auto';
            }
            
            // Update border radius based on height
            if (scrollHeight > 50) {
                inputRow.classList.add('expanded');
            } else {
                inputRow.classList.remove('expanded');
            }
            
            // Toggle mic/send icon
            if (hasText) {
                btn.classList.add('has-text');
                btn.classList.remove('recording');
            } else {
                btn.classList.remove('has-text');
            }
        }
        
        // Handle keydown for Enter/Shift+Enter behavior
        function handleKeydown(event, panel) {
            if (event.key === 'Enter') {
                if (event.shiftKey) {
                    // Shift+Enter: allow new line (default behavior)
                    return;
                } else {
                    // Enter alone: send message
                    event.preventDefault();
                    handleSend(panel);
                }
            }
        }
        
        // Reset textarea after sending
        function resetTextarea(panel) {
            const input = document.getElementById(panel + 'Input');
            const inputRow = document.getElementById(panel + 'InputRow');
            input.style.height = '36px';
            input.classList.remove('scrollable');
            input.style.overflowY = 'hidden';
            inputRow.classList.remove('expanded');
        }
        
        // Handle send (Enter key)
        function handleSend(panel) {
            const input = document.getElementById(panel + 'Input');
            if (input.value.trim()) {
                sendMsg(panel);
            }
        }
        
        // Handle action button click (mic/send/stop)
        function handleAction(panel) {
            const input = document.getElementById(panel + 'Input');
            const btn = document.getElementById(panel + 'ActionBtn');
            const hasText = input.value.trim().length > 0;
            
            if (btn.classList.contains('recording')) {
                stopRecording(panel);
            } else if (hasText) {
                sendMsg(panel);
                btn.classList.remove('has-text');
            } else {
                startRecording(panel);
            }
        }
        
        // Send message
        // n8n Webhook URL
        const N8N_WEBHOOK_URL = 'https://cherhabil.app.n8n.cloud/webhook/fixair-assistant';
        
        // Session IDs will be set based on project when a project is opened
        // This ensures memory persists across page reloads for the same project
        let sessionIds = {
            copilot: null,
            assistant: null
        };
        
        // Function to update session IDs when project changes
        function updateSessionIds(projectId) {
            if (projectId) {
                sessionIds.copilot = 'copilot-' + projectId;
                sessionIds.assistant = 'assistant-' + projectId;
            } else {
                // Fallback for no project (should not happen normally)
                const tempId = Date.now().toString();
                sessionIds.copilot = 'copilot-temp-' + tempId;
                sessionIds.assistant = 'assistant-temp-' + tempId;
            }
            console.log(' Session IDs updated:', sessionIds);
        }
        
        // 
        // SUPABASE CONFIGURATION
        // 
        
        const SUPABASE_URL = 'https://fwuhzraxqrvmpqxnzpqm.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZ3dWh6cmF4cXJ2bXBxeG56cHFtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYyNTcyMTksImV4cCI6MjA4MTgzMzIxOX0.8ryQm1tsdx5ox3aFJiiflmwuEGGxxH_PlobGxXMgFuQ';
        
        const db = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        // Current project/chat state
        let currentUserId = null;
        let currentProjectId = null;
        let currentChatId = {
            assistant: null,
            copilot: null
        };
        let projectMessageCount = 0;
        
        // 
        // PROJECT MANAGEMENT FUNCTIONS
        // 
        
        // Get current user ID from existing auth (uses your n8n auth system)
        async function getCurrentUserId() {
            if (currentUserId) return currentUserId;
            
            // Use the existing auth from your login system
            const savedUser = JSON.parse(localStorage.getItem('fixair_user') || 'null');
            if (savedUser && savedUser.id) {
                currentUserId = savedUser.id;
                return savedUser.id;
            }
            
            // Fallback for demo/testing
            let localId = localStorage.getItem('fixair_demo_user_id');
            if (!localId) {
                localId = 'demo-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
                localStorage.setItem('fixair_demo_user_id', localId);
            }
            currentUserId = localId;
            return localId;
        }
        
        // Create or get project for current session
        async function ensureProject(panel) {
            // If we already have a project, return it
            if (currentProjectId && currentChatId[panel]) {
                return { projectId: currentProjectId, chatId: currentChatId[panel] };
            }
            
            const userId = await getCurrentUserId();
            if (!userId || userId.startsWith('demo-')) {
                console.log(' Demo mode - not saving to Supabase');
                return null;
            }
            
            // If no project yet, create one
            if (!currentProjectId) {
                const { data: project, error: projectError } = await db
                    .from('projects')
                    .insert({
                        user_id: userId,
                        title: 'Nouvelle intervention',
                        brand: brand,
                        status: 'active'
                    })
                    .select()
                    .single();
                
                if (projectError) {
                    console.error('Error creating project:', projectError);
                    return null;
                }
                
                currentProjectId = project.id;
                updateSessionIds(project.id); // Update session IDs for n8n memory
                console.log(' Project created:', project.id);
            }
            
            // If no chat for this panel, create one
            if (!currentChatId[panel]) {
                const { data: chat, error: chatError } = await db
                    .from('chats')
                    .insert({
                        project_id: currentProjectId,
                        user_id: userId,
                        chat_type: panel,
                        is_active: true
                    })
                    .select()
                    .single();
                
                if (chatError) {
                    console.error('Error creating chat:', chatError);
                    return null;
                }
                
                currentChatId[panel] = chat.id;
                console.log(' Chat created:', chat.id, 'type:', panel);
            }
            
            return { projectId: currentProjectId, chatId: currentChatId[panel] };
        }
        
        // Save message to Supabase
        async function saveMessage(chatId, role, content, contentType = 'text') {
            if (!chatId) return null;
            
            const { data, error } = await db
                .from('messages')
                .insert({
                    chat_id: chatId,
                    role: role,
                    content: content,
                    content_type: contentType
                })
                .select()
                .single();
            
            if (error) {
                console.error('Error saving message:', error);
                return null;
            }
            
            // Increment message count for auto-naming
            projectMessageCount++;
            
            // Auto-name project after 3 messages
            if (projectMessageCount === 3 && currentProjectId) {
                autoNameProject(content);
            }
            
            return data;
        }
        
        // Auto-generate project name from first messages
        async function autoNameProject(lastMessage) {
            // Get first few messages to generate name
            const { data: messages } = await db
                .from('messages')
                .select('content, role')
                .eq('chat_id', currentChatId.assistant || currentChatId.copilot)
                .order('created_at', { ascending: true })
                .limit(3);
            
            if (!messages || messages.length === 0) return;
            
            // Simple name generation: use first user message
            const firstUserMsg = messages.find(m => m.role === 'user');
            if (firstUserMsg) {
                let title = firstUserMsg.content.substring(0, 50);
                if (firstUserMsg.content.length > 50) title += '...';
                
                await db
                    .from('projects')
                    .update({ title: title })
                    .eq('id', currentProjectId);
                
                // Update current project title and header
                currentProjectTitle = title;
                updateChatHeader();
                
                console.log(' Project auto-named:', title);
                
                // Refresh projects list
                loadProjectsList();
            }
        }
        
        // Load user's projects list
        async function loadProjectsList() {
            console.log(' Loading projects list...');
            
            const userId = await getCurrentUserId();
            if (!userId || userId.startsWith('demo-')) {
                console.log(' Demo mode - not loading from Supabase');
                return;
            }
            
            try {
                const { data: projects, error } = await db
                    .from('projects')
                    .select(`
                        id,
                        title,
                        brand,
                        original_brand,
                        status,
                        created_at,
                        updated_at,
                        chats (
                            id,
                            chat_type,
                            message_count
                        )
                    `)
                    .eq('user_id', userId)
                    .order('updated_at', { ascending: false })
                    .limit(20);
                
                if (error) {
                    console.error(' Error loading projects:', error);
                    return;
                }
                
                console.log(' Projects loaded:', projects?.length || 0);
                
                // Store projects globally for context menu
                window.projectsData = projects || [];
                
                renderProjectsList(projects);
                renderRecentProjects(projects?.slice(0, 2) || []);
                
            } catch (e) {
                console.error(' Unexpected error loading projects:', e);
            }
        }
        
        // Variable to track which project is being edited
        let contextMenuProjectId = null;
        let currentProjectTitle = null;
        
        // Generate project card HTML
        function generateProjectCardHtml(project, includeContextMenu = true) {
            const hasAssistant = project.chats?.some(c => c.chat_type === 'assistant');
            const hasCopilot = project.chats?.some(c => c.chat_type === 'copilot');
            const hasBoth = hasAssistant && hasCopilot;
            
            const timeAgo = formatTimeAgo(new Date(project.updated_at));
            
            let iconHtml = '';
            if (hasBoth) {
                iconHtml = `<div class="proj-icons dual">
                    <div class="proj-icon copilot back"><span class="star-icon"><svg viewBox="0 0 200 200"><use href="#icon-star"/></svg></span></div>
                    <div class="proj-icon assistant front"><span class="icon"><svg><use href="#icon-clipboard"/></svg></span></div>
                </div>`;
            } else if (hasAssistant) {
                iconHtml = `<div class="proj-icon assistant"><span class="icon"><svg><use href="#icon-clipboard"/></svg></span></div>`;
            } else {
                iconHtml = `<div class="proj-icon copilot"><span class="star-icon"><svg viewBox="0 0 200 200"><use href="#icon-star"/></svg></span></div>`;
            }
            
            const brandLabel = project.brand ? project.brand.charAt(0).toUpperCase() + project.brand.slice(1) : '';
            
            // Show brand history if changed (Original  Current)
            let brandDisplay = brandLabel;
            if (project.original_brand && project.original_brand !== project.brand) {
                const originalBrandLabel = project.original_brand.charAt(0).toUpperCase() + project.original_brand.slice(1);
                brandDisplay = `${originalBrandLabel}  ${brandLabel}`;
            }
            
            const modeLabel = hasBoth ? 'Diagnostic + Rapport' : (hasAssistant ? 'Rapport' : 'Diagnostic');
            
            const contextMenuAttr = includeContextMenu ? `oncontextmenu="showProjectContextMenu(event, '${project.id}', '${escapeHtml(project.title || 'Sans titre')}')" ontouchstart="startLongPress(event, '${project.id}', '${escapeHtml(project.title || 'Sans titre')}')" ontouchend="cancelLongPress()" ontouchmove="cancelLongPress()"` : '';
            
            return `
                <div class="proj" onclick="loadProject('${project.id}')" ${contextMenuAttr} data-project-id="${project.id}">
                    ${iconHtml}
                    <div class="proj-info">
                        <div class="proj-title">${escapeHtml(project.title || 'Sans titre')}</div>
                        <div class="proj-meta">${modeLabel}${brandDisplay ? '  ' + brandDisplay : ''}</div>
                    </div>
                    <span class="proj-time">${timeAgo}</span>
                </div>
            `;
        }
        
        // Render projects in the projects page
        function renderProjectsList(projects) {
            const container = document.getElementById('projectsList');
            if (!container) return;
            
            if (!projects || projects.length === 0) {
                container.innerHTML = `
                    <div class="empty-projects" style="text-align: center; padding: 40px 20px; color: var(--text-dim);">
                        <p style="margin-bottom: 8px;">Aucun projet</p>
                        <p style="font-size: 12px;">Commencez une nouvelle conversation</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = projects.map(project => generateProjectCardHtml(project, true)).join('');
        }
        
        // Render recent projects on home page
        function renderRecentProjects(projects) {
            const container = document.getElementById('recentProjectsHome');
            if (!container) return;
            
            if (!projects || projects.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: var(--text-dim); font-size: 13px;">
                        Aucun projet rcent
                    </div>
                `;
                return;
            }
            
            container.innerHTML = projects.map(project => generateProjectCardHtml(project, true)).join('');
        }
        
        // Show context menu for project
        function showProjectContextMenu(event, projectId, projectTitle) {
            event.preventDefault();
            event.stopPropagation();
            
            contextMenuProjectId = projectId;
            currentProjectTitle = projectTitle;
            
            const menu = document.getElementById('projectContextMenu');
            
            // Position menu - use touch point if available, otherwise mouse
            let x = event.clientX || (event.touches && event.touches[0]?.clientX) || 100;
            let y = event.clientY || (event.touches && event.touches[0]?.clientY) || 100;
            
            // Keep menu within viewport
            const menuWidth = 160;
            const menuHeight = 90;
            if (x + menuWidth > window.innerWidth) x = window.innerWidth - menuWidth - 10;
            if (y + menuHeight > window.innerHeight) y = window.innerHeight - menuHeight - 10;
            
            menu.style.left = x + 'px';
            menu.style.top = y + 'px';
            menu.classList.add('show');
            
            // Haptic feedback on mobile
            if (navigator.vibrate) navigator.vibrate(50);
            
            // Close menu when clicking elsewhere
            setTimeout(() => {
                document.addEventListener('click', closeContextMenu, { once: true });
                document.addEventListener('touchstart', closeContextMenu, { once: true });
            }, 10);
        }
        
        // Long-press handling for mobile
        let longPressTimer = null;
        let longPressTriggered = false;
        
        function startLongPress(event, projectId, projectTitle) {
            longPressTriggered = false;
            longPressTimer = setTimeout(() => {
                longPressTriggered = true;
                event.preventDefault();
                // Haptic feedback immediately when long press triggers
                if (navigator.vibrate) navigator.vibrate(30);
                showProjectContextMenu(event, projectId, projectTitle);
            }, 500); // 500ms for long press
        }
        
        function cancelLongPress() {
            if (longPressTimer) {
                clearTimeout(longPressTimer);
                longPressTimer = null;
            }
        }
        
        // Prevent click if long-press was triggered
        document.addEventListener('click', (e) => {
            if (longPressTriggered && e.target.closest('.proj')) {
                e.preventDefault();
                e.stopPropagation();
                longPressTriggered = false;
            }
        }, true);
        
        function closeContextMenu(event) {
            // Don't close if clicking inside the menu
            if (event && event.target.closest('.project-context-menu')) {
                return;
            }
            const menu = document.getElementById('projectContextMenu');
            menu.classList.remove('show');
        }
        
        // Rename project
        function renameProject() {
            closeContextMenu();
            const modal = document.getElementById('renameModal');
            const input = document.getElementById('renameInput');
            input.value = currentProjectTitle || '';
            modal.classList.add('show');
            setTimeout(() => input.focus(), 100);
        }
        
        function closeRenameModal() {
            document.getElementById('renameModal').classList.remove('show');
        }
        
        async function saveProjectRename() {
            const newTitle = document.getElementById('renameInput').value.trim();
            if (!newTitle || !contextMenuProjectId) return;
            
            const { error } = await db
                .from('projects')
                .update({ title: newTitle })
                .eq('id', contextMenuProjectId);
            
            if (error) {
                console.error('Error renaming project:', error);
                alert('Erreur lors du renommage');
                return;
            }
            
            closeRenameModal();
            loadProjectsList(); // Refresh list
            
            // Update header if this project is currently open
            if (currentProjectId === contextMenuProjectId) {
                currentProjectTitle = newTitle;
                updateChatHeader();
            }
            
            console.log(' Project renamed:', newTitle);
        }
        
        // Delete project
        async function deleteProject() {
            closeContextMenu();
            
            if (!confirm('Supprimer ce projet et toutes ses conversations ?')) return;
            
            // Delete messages first (foreign key constraint)
            const { data: chats } = await db
                .from('chats')
                .select('id')
                .eq('project_id', contextMenuProjectId);
            
            for (const chat of chats || []) {
                await db.from('messages').delete().eq('chat_id', chat.id);
            }
            
            // Delete chats
            await db.from('chats').delete().eq('project_id', contextMenuProjectId);
            
            // Delete project
            const { error } = await db
                .from('projects')
                .delete()
                .eq('id', contextMenuProjectId);
            
            if (error) {
                console.error('Error deleting project:', error);
                alert('Erreur lors de la suppression');
                return;
            }
            
            loadProjectsList(); // Refresh list
            
            // If this project was open, close chat
            if (currentProjectId === contextMenuProjectId) {
                closeChat();
                startNewProject();
            }
            
            console.log(' Project deleted');
        }
        
        // Format time ago
        function formatTimeAgo(date) {
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);
            
            if (diffMins < 1) return ' l\'instant';
            if (diffMins < 60) return `${diffMins} min`;
            if (diffHours < 24) return `${diffHours}h`;
            if (diffDays === 1) return 'Hier';
            if (diffDays < 7) return ['Dim', 'Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam'][date.getDay()];
            return `${date.getDate()} ${['Jan', 'Fv', 'Mar', 'Avr', 'Mai', 'Juin', 'Juil', 'Aot', 'Sep', 'Oct', 'Nov', 'Dc'][date.getMonth()]}`;
        }
        
        // Escape HTML for safety
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // Load a specific project (FIXED: uses separate queries for reliability)
        async function loadProject(projectId) {
            console.log(' Loading project:', projectId);
            
            //  INSTANT OPEN: Open chat immediately 
            openingFromProject = true;
            currentProjectId = projectId;
            updateSessionIds(projectId); // Update session IDs for n8n memory
            currentChatId = { assistant: null, copilot: null };
            projectMessageCount = 0;
            
            // Open chat view immediately (show loading state)
            const lastMode = mode || 'assistant';
            openChat(lastMode);
            
            // Show loading indicator in chat
            const body = document.getElementById(lastMode + 'Body');
            if (body) {
                body.innerHTML = '<div style="text-align:center;padding:40px;color:var(--text-dim);"><div style="margin-bottom:10px;"></div>Chargement...</div>';
            }
            
            try {
                // Step 1: Get project details
                const { data: project, error: projectError } = await db
                    .from('projects')
                    .select('id, title, brand, original_brand, status, created_at, updated_at')
                    .eq('id', projectId)
                    .single();
                
                if (projectError || !project) {
                    console.error(' Error loading project:', projectError);
                    if (body) body.innerHTML = '<div style="text-align:center;padding:40px;color:var(--hotline);">Erreur de chargement</div>';
                    return;
                }
                
                console.log(' Project loaded:', project.title, 'brand:', project.brand);
                
                // Try to load photos separately (column might not exist yet)
                try {
                    const { data: projectWithPhotos } = await db
                        .from('projects')
                        .select('photos')
                        .eq('id', projectId)
                        .single();
                    window.reportPhotos = projectWithPhotos?.photos || [];
                    console.log(' Loaded', window.reportPhotos.length, 'photos for project');
                } catch (e) {
                    console.log(' Photos column not available yet');
                    window.reportPhotos = [];
                }
                
                // Store project title for header
                currentProjectTitle = project.title || 'Sans titre';
                currentProjectTitle = project.title || 'Sans titre';
                
                //  FIX: Detect if user selected different brand on main page 
                const projectOriginalBrand = project.brand;
                const userSelectedBrand = brand; // Current global brand from main page selection
                let brandWasChanged = false;
                
                const brandNames = {
                    'mitsubishi': 'Mitsubishi Electric',
                    'daikin': 'Daikin',
                    'carrier': 'Carrier',
                    'lg': 'LG',
                    'samsung': 'Samsung',
                    'panasonic': 'Panasonic',
                    'toshiba': 'Toshiba',
                    'fujitsu': 'Fujitsu',
                    'hitachi': 'Hitachi',
                    'general': 'Multi-marques'
                };
                
                // Check if user selected a different brand on main page
                if (userSelectedBrand && projectOriginalBrand && userSelectedBrand !== projectOriginalBrand) {
                    console.log(' Brand changed from main page:', projectOriginalBrand, '', userSelectedBrand);
                    brandWasChanged = true;
                    
                    // Update project with new brand and store original
                    try {
                        const updateData = { brand: userSelectedBrand };
                        // Only set original_brand if not already set
                        if (!project.original_brand) {
                            updateData.original_brand = projectOriginalBrand;
                        }
                        
                        await db
                            .from('projects')
                            .update(updateData)
                            .eq('id', projectId);
                        
                        console.log(' Project brand updated in database');
                    } catch (e) {
                        console.error(' Failed to update brand:', e);
                    }
                    
                    // Keep the user's selected brand (don't override from project)
                    updateBrandUI();
                } else {
                    // Use project's brand as normal
                    if (project.brand) {
                        brand = project.brand;
                        updateBrandUI();
                    }
                }
                //  END FIX 
                
                // Step 2: Get chats for this project (SEPARATE QUERY - fixes nested query issue)
                const { data: chats, error: chatsError } = await db
                    .from('chats')
                    .select('id, chat_type, project_id, started_at')
                    .eq('project_id', projectId);
                
                if (chatsError) {
                    console.error(' Error loading chats:', chatsError);
                }
                
                console.log(' Chats found:', chats?.length || 0);
                
                // Step 3: Load messages for each chat
                for (const chat of chats || []) {
                    console.log(` Loading messages for ${chat.chat_type} chat:`, chat.id);
                    
                    currentChatId[chat.chat_type] = chat.id;
                    
                    // Load messages for this chat
                    const { data: messages, error: msgError } = await db
                        .from('messages')
                        .select('*')
                        .eq('chat_id', chat.id)
                        .order('created_at', { ascending: true });
                    
                    if (msgError) {
                        console.error(' Error loading messages:', msgError);
                        continue;
                    }
                    
                    console.log(` Found ${messages?.length || 0} messages for ${chat.chat_type}`);
                    
                    // Clear existing chat UI
                    chatHistory[chat.chat_type] = [];
                    const body = document.getElementById(chat.chat_type + 'Body');
                    if (body) {
                        body.innerHTML = '';
                    }
                    
                    // Add messages to UI
                    for (const msg of messages || []) {
                        const role = msg.role === 'assistant' ? 'ai' : msg.role;
                        if (role === 'user' || role === 'ai') {
                            // Check if this is an image message
                            if (msg.content_type === 'image' && msg.content.startsWith('data:image')) {
                                // Render as photo
                                const msgId = 'photo-' + Date.now() + '-' + Math.random().toString(36).substr(2, 5);
                                const msgDiv = document.createElement('div');
                                msgDiv.className = 'msg user';
                                msgDiv.id = msgId;
                                
                                // Check if this photo was already added to report
                                const isInReport = window.reportPhotos?.some(p => p.url === msg.content || p.data === msg.content);
                                msgDiv.innerHTML = createPhotoMessageHTML(msgId, chat.chat_type, msg.content, isInReport);
                                msgDiv.dataset.imageData = msg.content;
                                
                                body.appendChild(msgDiv);
                            } else if (msg.content_type === 'ocr') {
                                // Render OCR result message
                                try {
                                    const ocrData = JSON.parse(msg.content);
                                    const sourceImg = findSourceImage(messages, ocrData.sourcePhotoId);
                                    renderOCRMessage(chat.chat_type, ocrData, sourceImg);
                                } catch (e) {
                                    console.error('Error parsing OCR message:', e);
                                }
                            } else {
                                // Regular text message
                                const content = role === 'ai' ? parseMarkdown(msg.content) : msg.content;
                                addMsg(chat.chat_type, role, content);
                            }
                            chatHistory[chat.chat_type].push({ role: msg.role, content: msg.content });
                            projectMessageCount++;
                        }
                    }
                }
                
                // Update chat header with project name
                updateChatHeader();
                
                //  FIX: Add comprehensive context for existing projects 
                // This ensures the AI knows the brand AND conversation context
                const projectBrandName = brandNames[brand] || brand;
                
                // Build conversation summary from loaded messages
                ['assistant', 'copilot'].forEach(panel => {
                    const history = chatHistory[panel];
                    const userMessages = history.filter(m => m.role === 'user');
                    const aiMessages = history.filter(m => m.role === 'assistant');
                    
                    // Create comprehensive context summary
                    let contextSummary = `[CONTEXTE PROJET EXISTANT]
MARQUE: ${projectBrandName}
PROJET: ${currentProjectTitle || 'Sans titre'}
MESSAGES PRCDENTS: ${history.length} messages (${userMessages.length} utilisateur, ${aiMessages.length} IA)
`;

                    // Add summary of recent conversation topics
                    if (userMessages.length > 0) {
                        contextSummary += `
HISTORIQUE CONVERSATION:
`;
                        // Add last 5 user messages as context
                        const recentUserMsgs = userMessages.slice(-5);
                        recentUserMsgs.forEach((msg, i) => {
                            const truncated = msg.content.length > 100 ? msg.content.substring(0, 100) + '...' : msg.content;
                            contextSummary += `- Utilisateur: "${truncated}"\n`;
                        });
                    }
                    
                    contextSummary += `
INSTRUCTIONS:
- Tu connais DJ la marque: ${projectBrandName}
- Tu connais DJ l'historique ci-dessus
- NE REDEMANDE PAS ces informations
- Continue la conversation naturellement
- Si c'est un rapport (assistant), tu as dj les infos pour le gnrer`;

                    // Insert comprehensive context as FIRST message
                    const existingSystemIndex = history.findIndex(m => m.role === 'system');
                    if (existingSystemIndex >= 0) {
                        history[existingSystemIndex].content = contextSummary;
                    } else {
                        history.unshift({ role: 'system', content: contextSummary });
                    }
                });
                
                console.log(' Comprehensive context added for existing project:', projectBrandName);
                console.log(' Chat history lengths:', {
                    assistant: chatHistory.assistant.length,
                    copilot: chatHistory.copilot.length
                });
                //  END FIX 
                
                // Open chat with the appropriate mode
                const hasAssistant = currentChatId.assistant;
                const defaultMode = hasAssistant ? 'assistant' : 'copilot';
                
                //  FIX: Set flag so openChat knows we're opening an existing project 
                openingFromProject = true;
                //  END FIX 
                
                openChat(defaultMode);
                
                //  FIX: Show brand change message if brand was changed from main page 
                if (brandWasChanged) {
                    const oldBrandName = brandNames[projectOriginalBrand] || projectOriginalBrand;
                    const newBrandName = brandNames[userSelectedBrand] || userSelectedBrand;
                    
                    setTimeout(() => {
                        const confirmMsg = `<p style="color: var(--mode-color);"> Tu as slectionn <strong>${newBrandName}</strong> sur la page d'accueil.</p><p style="font-size: 12px; opacity: 0.8;">Marque du projet: <strong>${oldBrandName}</strong>  <strong>${newBrandName}</strong></p><p style="font-size: 12px; opacity: 0.7;">On continue avec ${newBrandName}.</p>`;
                        addMsg(defaultMode, 'ai', confirmMsg);
                    }, 100);
                }
                //  END FIX 
                
                console.log(' Project fully loaded:', currentProjectTitle);
                
            } catch (e) {
                console.error(' Unexpected error loading project:', e);
            }
        }
        
        // Update chat header to show project name
        function updateChatHeader() {
            const panels = ['copilot', 'assistant'];
            
            for (const panel of panels) {
                const projectNameEl = document.getElementById(panel + 'ProjectName');
                const projectSepEl = document.getElementById(panel + 'ProjectSep');
                
                if (currentProjectTitle && currentProjectId) {
                    if (projectNameEl) {
                        projectNameEl.textContent = currentProjectTitle;
                        projectNameEl.style.display = 'block';
                    }
                    if (projectSepEl) {
                        projectSepEl.style.display = 'block';
                    }
                } else {
                    if (projectNameEl) projectNameEl.style.display = 'none';
                    if (projectSepEl) projectSepEl.style.display = 'none';
                }
            }
        }
        
        // Start new project (clear current)
        function startNewProject() {
            currentProjectId = null;
            currentChatId = { assistant: null, copilot: null };
            currentProjectTitle = null;
            projectMessageCount = 0;
            
            // Reset session IDs (will be set when project is created)
            sessionIds = { copilot: null, assistant: null };
            
            // Clear chats
            chatHistory.assistant = [];
            chatHistory.copilot = [];
            
            //  RESET REPORT DATA 
            lastReportData = null;
            window.reportPhotos = [];
            
            // Reset report button and drawer
            const reportBtn = document.querySelector('.h-btn.report-btn');
            if (reportBtn) reportBtn.classList.remove('has-data');
            
            const emptyState = document.getElementById('reportPreviewEmpty');
            const previewContent = document.getElementById('reportPreviewContent');
            if (emptyState) emptyState.style.display = '';
            if (previewContent) {
                previewContent.style.display = 'none';
                previewContent.innerHTML = '';
            }
            //  END RESET 
            
            const assistantBody = document.getElementById('assistantBody');
            const copilotBody = document.getElementById('copilotBody');
            
            if (assistantBody) assistantBody.innerHTML = '';
            if (copilotBody) copilotBody.innerHTML = '';
            
            // Clear project name from header
            updateChatHeader();
            
            // Show welcome message
            setTimeout(() => {
                addMsg(mode, 'ai', '<p>Bonjour ! Comment puis-je vous aider ?</p>');
            }, 300);
            
            console.log(' New project started');
        }
        
        // Update brand in UI
        function updateBrandUI() {
            const brandBtn = document.querySelector('.brand-btn .brand-btn-text');
            if (brandBtn) {
                const brandNames = {
                    'mitsubishi': 'Mitsubishi',
                    'daikin': 'Daikin',
                    'carrier': 'Carrier',
                    'lg': 'LG',
                    'samsung': 'Samsung',
                    'panasonic': 'Panasonic',
                    'general': 'Multi-marques'
                };
                brandBtn.textContent = brandNames[brand] || brand;
            }
        }
        
        // 
        // END SUPABASE FUNCTIONS
        // 
        
        // Debug function - run debugFixAIR() in browser console to diagnose issues
        async function debugFixAIR() {
            console.log(' ');
            console.log(' FIXAIR DEBUG REPORT');
            console.log(' ');
            
            const userId = await getCurrentUserId();
            console.log(' User ID:', userId);
            console.log(' Current Brand:', brand);
            console.log(' Current Project ID:', currentProjectId);
            console.log(' Current Chat IDs:', currentChatId);
            
            if (!userId || userId.startsWith('demo-')) {
                console.log(' Demo mode - no Supabase data');
                return;
            }
            
            // Check projects
            const { data: projects, error: pe } = await db
                .from('projects')
                .select('*')
                .eq('user_id', userId)
                .limit(5);
            console.log(' Projects:', projects?.length || 0, pe ? 'ERROR: ' + pe.message : '');
            if (projects?.[0]) console.log('   Sample:', projects[0].title, '| Brand:', projects[0].brand);
            
            // Check chats for first project
            if (projects?.[0]) {
                const { data: chats, error: ce } = await db
                    .from('chats')
                    .select('*')
                    .eq('project_id', projects[0].id);
                console.log(' Chats for project:', chats?.length || 0, ce ? 'ERROR: ' + ce.message : '');
                
                // Check messages for first chat
                if (chats?.[0]) {
                    const { data: messages, error: me } = await db
                        .from('messages')
                        .select('*')
                        .eq('chat_id', chats[0].id)
                        .limit(5);
                    console.log(' Messages for chat:', messages?.length || 0, me ? 'ERROR: ' + me.message : '');
                    if (messages?.[0]) console.log('   Sample:', messages[0].role, ':', messages[0].content?.substring(0, 50) + '...');
                }
            }
            
            console.log(' ');
            console.log(' Run loadProject("project-id") to test loading');
            console.log(' ');
        }
        
        
        // 
        // RENDER STRUCTURED REPORT - Beautiful Template
        // 
        function renderReport(data) {
            //  STORE FOR PDF EXPORT 
            lastReportData = data;
            console.log(' Report data stored for PDF export:', data);
            
            //  UPDATE DRAWER PREVIEW 
            updateDrawerPreview(data);
            
            // Helper: only show section if it has content
            const has = (val) => val && (Array.isArray(val) ? val.length > 0 : true);
            const esc = (str) => str ? String(str).replace(/</g, '&lt;').replace(/>/g, '&gt;') : '';
            
            // Brand class
            const brandClass = data.brand_key || 'general';
            
            // Status class
            let statusClass = 'en-cours';
            let statusText = 'En cours';
            if (data.status) {
                const s = data.status.toLowerCase();
                if (s.includes('conforme') && !s.includes('non')) {
                    statusClass = 'conforme';
                    statusText = 'Conforme';
                } else if (s.includes('non') || s.includes('refus')) {
                    statusClass = 'non-conforme';
                    statusText = 'Non conforme';
                } else {
                    statusText = data.status;
                }
            }
            
            // Technician initials
            const getInitials = (name) => {
                if (!name) return '??';
                return name.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);
            };
            
            let html = `<div class="rpt">`;
            
            //  HEADER 
            html += `
            <div class="rpt-header">
                <div class="rpt-header-top">
                    <div>
                        <div class="rpt-brand ${brandClass}">${esc(data.brand || 'FixAIR')}</div>
                        <h1 class="rpt-title">Rapport d'intervention</h1>
                    </div>
                    <div class="rpt-status ${statusClass}">
                        <span class="rpt-status-dot"></span>
                        <span class="rpt-status-text">${esc(statusText)}</span>
                    </div>
                </div>
                <div class="rpt-meta">
                    ${data.reference ? `<span>Rf <span class="val">${esc(data.reference)}</span></span>` : ''}
                    ${data.type_intervention ? `<span>Type <span class="val">${esc(data.type_intervention)}</span></span>` : ''}
                    ${data.date ? `<span>Date <span class="val">${esc(data.date)}</span></span>` : ''}
                    ${data.bon_livraison ? `<span>BL <span class="val">${esc(data.bon_livraison)}</span></span>` : ''}
                </div>
            </div>`;
            
            //  MAIN CARD 
            html += `<div class="rpt-card">`;
            
            // 1. RSUM
            if (has(data.resume)) {
                const resumeText = data.resume.replace(/NON CONFORME/gi, '<strong>NON CONFORME</strong>')
                                              .replace(/CONFORME/gi, '<strong>CONFORME</strong>');
                html += `
                <div class="rpt-section">
                    <div class="rpt-label">Rsum</div>
                    <p class="rpt-text">${resumeText}</p>
                </div>`;
            }
            
            // 2. CLIENT + SITE (2 cols)
            if (has(data.client) || has(data.site)) {
                html += `<div class="rpt-section"><div class="rpt-grid">`;
                
                if (has(data.client)) {
                    html += `<div class="rpt-group"><div class="rpt-label">Client</div>`;
                    if (data.client.societe) html += `<div class="rpt-row"><span class="rpt-row-label">Socit</span><span class="rpt-row-value">${esc(data.client.societe)}</span></div>`;
                    if (data.client.contact) html += `<div class="rpt-row"><span class="rpt-row-label">Contact</span><span class="rpt-row-value">${esc(data.client.contact)}</span></div>`;
                    if (data.client.telephone) html += `<div class="rpt-row"><span class="rpt-row-label">Tlphone</span><span class="rpt-row-value">${esc(data.client.telephone)}</span></div>`;
                    if (data.client.dossier) html += `<div class="rpt-row"><span class="rpt-row-label">N Dossier</span><span class="rpt-row-value mono">${esc(data.client.dossier)}</span></div>`;
                    html += `</div>`;
                }
                
                if (has(data.site)) {
                    html += `<div class="rpt-group"><div class="rpt-label">Site d'intervention</div>`;
                    if (data.site.adresse) html += `<div class="rpt-row"><span class="rpt-row-label">Adresse</span><span class="rpt-row-value">${esc(data.site.adresse)}</span></div>`;
                    if (data.site.ville) html += `<div class="rpt-row"><span class="rpt-row-label">Ville</span><span class="rpt-row-value">${esc(data.site.ville)}</span></div>`;
                    if (data.site.batiment) html += `<div class="rpt-row"><span class="rpt-row-label">Btiment</span><span class="rpt-row-value">${esc(data.site.batiment)}</span></div>`;
                    if (data.site.acces) html += `<div class="rpt-row"><span class="rpt-row-label">Accs</span><span class="rpt-row-value">${esc(data.site.acces)}</span></div>`;
                    html += `</div>`;
                }
                
                html += `</div></div>`;
            }
            
            // 3. SYSTME + INTERVENTION (2 cols)
            if (has(data.systeme) || has(data.intervention)) {
                html += `<div class="rpt-section"><div class="rpt-grid">`;
                
                if (has(data.systeme)) {
                    html += `<div class="rpt-group"><div class="rpt-label">Systme</div>`;
                    if (data.systeme.type) html += `<div class="rpt-row"><span class="rpt-row-label">Type</span><span class="rpt-row-value">${esc(data.systeme.type)}</span></div>`;
                    if (data.systeme.modele) html += `<div class="rpt-row"><span class="rpt-row-label">Modle UE</span><span class="rpt-row-value mono">${esc(data.systeme.modele)}</span></div>`;
                    if (data.systeme.serie) html += `<div class="rpt-row"><span class="rpt-row-label">N Srie</span><span class="rpt-row-value mono">${esc(data.systeme.serie)}</span></div>`;
                    if (data.systeme.fluide) html += `<div class="rpt-row"><span class="rpt-row-label">Fluide</span><span class="rpt-row-value">${esc(data.systeme.fluide)}</span></div>`;
                    html += `</div>`;
                }
                
                if (has(data.intervention)) {
                    html += `<div class="rpt-group"><div class="rpt-label">Intervention</div>`;
                    if (data.intervention.type) html += `<div class="rpt-row"><span class="rpt-row-label">Type</span><span class="rpt-row-value">${esc(data.intervention.type)}</span></div>`;
                    if (data.intervention.statut) {
                        const statClass = data.intervention.statut.toLowerCase().includes('refus') ? 'error' : '';
                        html += `<div class="rpt-row"><span class="rpt-row-label">Statut</span><span class="rpt-row-value ${statClass}">${esc(data.intervention.statut)}</span></div>`;
                    }
                    if (data.intervention.diagnostic) html += `<div class="rpt-row"><span class="rpt-row-label">Diagnostic</span><span class="rpt-row-value">${esc(data.intervention.diagnostic)}</span></div>`;
                    if (data.intervention.probleme) html += `<div class="rpt-row"><span class="rpt-row-label">Problme</span><span class="rpt-row-value">${esc(data.intervention.probleme)}</span></div>`;
                    html += `</div>`;
                }
                
                html += `</div></div>`;
            }
            
            // 4. ADRESSAGE - Units Intrieures (full width table)
            if (has(data.unites_interieures)) {
                html += `
                <div class="rpt-section">
                    <div class="rpt-label">Adressage - Units Intrieures</div>
                    <div class="rpt-table">
                        <div class="rpt-th rpt-cols-5">
                            <span>Adr</span><span>Modle</span><span>Zone</span><span>kW</span><span>tat</span>
                        </div>`;
                data.unites_interieures.forEach(ui => {
                    const statusCls = ui.etat === 'OK' ? 'ok' : (ui.etat && ui.etat !== 'N/A' ? 'err' : 'warn');
                    html += `
                        <div class="rpt-tr rpt-cols-5">
                            <span class="mono">${esc(ui.adresse || '')}</span>
                            <span>${esc(ui.modele || '')}</span>
                            <span>${esc(ui.zone || '')}</span>
                            <span>${esc(ui.puissance || '')}</span>
                            <span class="${statusCls}">${esc(ui.etat || '')}</span>
                        </div>`;
                });
                html += `</div></div>`;
            }
            
            // 4b. CODES DFAUT (separate table)
            if (has(data.codes_defaut)) {
                html += `
                <div class="rpt-section">
                    <div class="rpt-label">Codes Dfaut</div>
                    <div class="rpt-table">
                        <div class="rpt-th rpt-cols-3">
                            <span>Code</span><span>Description</span><span>UI</span>
                        </div>`;
                data.codes_defaut.forEach(cd => {
                    html += `
                        <div class="rpt-tr rpt-cols-3">
                            <span class="mono">${esc(cd.code || '')}</span>
                            <span>${esc(cd.description || '')}</span>
                            <span>${esc(cd.ui || '')}</span>
                        </div>`;
                });
                html += `</div></div>`;
            }
            
            // 5. TRAVAUX EFFECTUS
            if (has(data.travaux_effectues)) {
                html += `
                <div class="rpt-section">
                    <div class="rpt-label">Travaux effectus</div>
                    <div class="rpt-list">`;
                data.travaux_effectues.forEach(t => {
                    const iconClass = t.status === 'done' ? 'done' : (t.status === 'error' ? 'error' : 'pending');
                    const iconChar = t.status === 'done' ? '' : (t.status === 'error' ? '' : '');
                    html += `
                        <div class="rpt-item">
                            <span class="rpt-icon ${iconClass}">${iconChar}</span>
                            <span class="rpt-item-text">${esc(t.texte || t.text || t)}</span>
                        </div>`;
                });
                html += `</div></div>`;
            }
            
            // 6. MESURES (only if we have data)
            if (has(data.mesures)) {
                html += `
                <div class="rpt-section">
                    <div class="rpt-label">Mesures</div>
                    <div class="rpt-measures">`;
                data.mesures.forEach(m => {
                    const valClass = m.status === 'ok' ? 'ok' : (m.status === 'error' ? 'error' : 'neutral');
                    const noteClass = m.status === 'ok' ? 'ok' : (m.status === 'error' ? 'error' : '');
                    html += `
                        <div class="rpt-measure">
                            <div class="rpt-measure-info">
                                <div class="rpt-measure-name">${esc(m.label || m.nom)}</div>
                                ${m.note ? `<div class="rpt-measure-note ${noteClass}">${esc(m.note)}</div>` : ''}
                            </div>
                            <div class="rpt-measure-val ${valClass}">${esc(m.valeur || m.value)}</div>
                        </div>`;
                });
                html += `</div></div>`;
            }
            
            // 7. PHOTOS (only if we have them - merge AI photos + manually added)
            const aiPhotos = data.photos || [];
            const manualPhotos = window.reportPhotos || [];
            const allPhotos = [...aiPhotos, ...manualPhotos];
            
            if (allPhotos.length > 0) {
                html += `
                <div class="rpt-section">
                    <div class="rpt-label">Photos & Documents</div>
                    <div class="rpt-photos">`;
                allPhotos.forEach((p, i) => {
                    const fullClass = p.full ? 'full' : '';
                    const photoUrl = p.url || p.data; // Support both url and base64 data
                    if (photoUrl) {
                        html += `
                            <div class="rpt-photo ${fullClass}">
                                <img src="${esc(photoUrl)}" alt="${esc(p.caption || '')}">
                                ${p.caption ? `<div class="rpt-photo-cap">${esc(p.caption)}</div>` : ''}
                            </div>`;
                    } else {
                        html += `
                            <div class="rpt-photo ${fullClass}" style="display:flex;align-items:center;justify-content:center;color:var(--text-dim);font-size:11px;">
                                Photo ${i + 1}${p.caption ? ': ' + esc(p.caption) : ''}
                            </div>`;
                    }
                });
                html += `</div></div>`;
            }
            
            // 8. RSULTAT + RSERVES
            if (has(data.resultat)) {
                const r = data.resultat;
                const resClass = r.status === 'resolu' ? 'ok' : 'err';
                const resText = r.status === 'resolu' ? 'Rsolu' : 'Non rsolu';
                
                html += `
                <div class="rpt-section">
                    <div class="rpt-label">Rsultat</div>
                    <div class="rpt-result">
                        <div class="rpt-result-status">
                            <span class="${resClass}">${resText}</span>
                            ${r.label ? `<span class="lbl">  ${esc(r.label)}</span>` : ''}
                        </div>
                        ${r.description ? `<div class="rpt-result-desc">${esc(r.description)}</div>` : ''}
                    </div>`;
                
                // Alerts/Rserves
                if (has(data.reserves) || has(data.alerts)) {
                    const alerts = data.reserves || data.alerts;
                    html += `<div class="rpt-alerts">`;
                    alerts.forEach(a => {
                        const alertClass = a.type === 'warning' ? 'warning' : (a.type === 'info' ? 'info' : (a.type === 'success' ? 'success' : ''));
                        html += `
                            <div class="rpt-alert ${alertClass}">
                                <div class="rpt-alert-title">${esc(a.titre || a.title)}</div>
                                <div class="rpt-alert-text">${esc(a.texte || a.text)}</div>
                            </div>`;
                    });
                    html += `</div>`;
                }
                
                html += `</div>`;
            }
            
            // 9. TRAVAUX  PRVOIR
            if (has(data.travaux_prevoir)) {
                html += `
                <div class="rpt-section">
                    <div class="rpt-label">Travaux  prvoir</div>
                    <div class="rpt-list">`;
                data.travaux_prevoir.forEach((t, i) => {
                    html += `
                        <div class="rpt-item">
                            <span class="rpt-icon num">${i + 1}</span>
                            <span class="rpt-item-text">${esc(t.texte || t.text || t)}</span>
                        </div>`;
                });
                html += `</div></div>`;
            }
            
            // 10. SIGNATURES
            if (has(data.signatures) || has(data.technicien)) {
                html += `
                <div class="rpt-section">
                    <div class="rpt-label">Signatures</div>
                    <div class="rpt-sigs">
                        <div class="rpt-sig">
                            <div class="rpt-sig-label">Technicien</div>
                            <div class="rpt-sig-line"></div>
                            <div class="rpt-sig-name">${esc(data.technicien?.nom || '')}</div>
                            <div class="rpt-sig-date">${esc(data.date || '')} ${data.technicien?.heure_depart ? ' ' + data.technicien.heure_depart : ''}</div>
                        </div>
                        <div class="rpt-sig">
                            <div class="rpt-sig-label">Client</div>
                            <div class="rpt-sig-line"></div>
                            <div class="rpt-sig-name">${esc(data.client?.contact || '')}</div>
                            <div class="rpt-sig-date">${esc(data.date || '')}</div>
                        </div>
                    </div>
                </div>`;
            }
            
            // 11. FOOTER
            if (has(data.technicien)) {
                const tech = data.technicien;
                html += `
                <div class="rpt-footer">
                    <div class="rpt-tech">
                        <div class="rpt-avatar">${getInitials(tech.nom)}</div>
                        <div>
                            <div class="rpt-tech-name">${esc(tech.nom)}</div>
                            <div class="rpt-tech-time">${tech.heure_arrivee ? 'Arrive ' + tech.heure_arrivee : ''} ${tech.heure_depart ? ' Dpart ' + tech.heure_depart : ''}</div>
                        </div>
                    </div>
                    <div class="rpt-actions">
                        <button class="rpt-btn secondary" onclick="shareReport()">Partager</button>
                        <button class="rpt-btn primary" onclick="exportReportPDF()">Export PDF</button>
                    </div>
                </div>`;
            }
            
            html += `</div></div>`; // Close rpt-card and rpt
            
            return html;
        }
        
        // 
        // PDF EXPORT - Professional Report Generation
        // 
        
        // Store last report data for PDF export
        let lastReportData = null;
        
        // Brand colors for PDF
        const brandColorsPDF = {
            mitsubishi: { primary: '#E60012', secondary: '#1a1a2e' },
            daikin: { primary: '#10B981', secondary: '#1a1a2e' },
            carrier: { primary: '#3B82F6', secondary: '#1a1a2e' },
            lg: { primary: '#A50034', secondary: '#1a1a2e' },
            samsung: { primary: '#1428A0', secondary: '#1a1a2e' },
            panasonic: { primary: '#0F4C81', secondary: '#1a1a2e' },
            toshiba: { primary: '#FF0000', secondary: '#1a1a2e' },
            fujitsu: { primary: '#E4002B', secondary: '#1a1a2e' },
            hitachi: { primary: '#E60012', secondary: '#1a1a2e' },
            general: { primary: '#EA580C', secondary: '#1a1a2e' }
        };
        
        // Share report function
        function shareReport() {
            if (!lastReportData) {
                toast('Aucun rapport  partager');
                return;
            }
            
            // Try native share API
            if (navigator.share) {
                const text = generateReportText(lastReportData);
                navigator.share({
                    title: 'Rapport d\'intervention FixAIR',
                    text: text
                }).catch(err => console.log('Share cancelled'));
            } else {
                // Fallback: copy to clipboard
                const text = generateReportText(lastReportData);
                navigator.clipboard.writeText(text).then(() => {
                    toast('Rapport copi dans le presse-papier !');
                });
            }
        }
        
        // Generate plain text version of report
        function generateReportText(data) {
            let text = `RAPPORT D'INTERVENTION ${data.brand || 'FixAIR'}\n`;
            text += `\n\n`;
            
            if (data.reference) text += `Rf: ${data.reference}\n`;
            if (data.date) text += `Date: ${data.date}\n`;
            if (data.type_intervention) text += `Type: ${data.type_intervention}\n`;
            text += `\n`;
            
            if (data.resume) text += `RSUM:\n${data.resume}\n\n`;
            
            if (data.client) {
                text += `CLIENT:\n`;
                if (data.client.societe) text += `  Socit: ${data.client.societe}\n`;
                if (data.client.contact) text += `  Contact: ${data.client.contact}\n`;
                if (data.client.telephone) text += `  Tl: ${data.client.telephone}\n`;
                text += `\n`;
            }
            
            if (data.site) {
                text += `SITE:\n`;
                if (data.site.adresse) text += `  ${data.site.adresse}\n`;
                if (data.site.ville) text += `  ${data.site.ville}\n`;
                text += `\n`;
            }
            
            if (data.systeme) {
                text += `SYSTME:\n`;
                if (data.systeme.type) text += `  Type: ${data.systeme.type}\n`;
                if (data.systeme.modele) text += `  Modle: ${data.systeme.modele}\n`;
                if (data.systeme.serie) text += `  N Srie: ${data.systeme.serie}\n`;
                if (data.systeme.fluide) text += `  Fluide: ${data.systeme.fluide}\n`;
                text += `\n`;
            }
            
            if (data.travaux_effectues && data.travaux_effectues.length > 0) {
                text += `TRAVAUX EFFECTUS:\n`;
                data.travaux_effectues.forEach(t => {
                    const icon = t.status === 'done' ? '' : (t.status === 'error' ? '' : '');
                    text += `  ${icon} ${t.texte}\n`;
                });
                text += `\n`;
            }
            
            if (data.resultat) {
                text += `RSULTAT: ${data.resultat.label || (data.resultat.status === 'resolu' ? 'Rsolu' : 'Non rsolu')}\n`;
            }
            
            text += `\n\n`;
            text += `Gnr par FixAIR - ${new Date().toLocaleDateString('fr-FR')}\n`;
            
            return text;
        }
        
        // Main PDF export function
        function exportReportPDF() {
            if (!lastReportData) {
                // Try to extract from last AI message
                const assistantBody = document.getElementById('assistantBody');
                if (assistantBody) {
                    const reportDiv = assistantBody.querySelector('.rpt');
                    if (!reportDiv) {
                        toast('Aucun rapport  exporter');
                        return;
                    }
                }
                toast('Aucun rapport  exporter');
                return;
            }
            
            generatePDF(lastReportData);
        }
        
        // Generate professional PDF
        async function generatePDF(data) {
            try {
                toast('Gnration du PDF...');
                
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF('p', 'mm', 'a4');
                const pageWidth = 210;
                const pageHeight = 297;
                const margin = 15;
                const contentWidth = pageWidth - (margin * 2);
                
                // Get brand colors
                const brandKey = data.brand_key || 'general';
                const colors = brandColorsPDF[brandKey] || brandColorsPDF.general;
                
                // Helper to convert hex to RGB
                const hexToRgb = (hex) => {
                    const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
                    return result ? {
                        r: parseInt(result[1], 16),
                        g: parseInt(result[2], 16),
                        b: parseInt(result[3], 16)
                    } : { r: 0, g: 0, b: 0 };
                };
                
                const primaryRgb = hexToRgb(colors.primary);
                let y = margin;
                
                //  HEADER 
                // Brand color bar
                doc.setFillColor(primaryRgb.r, primaryRgb.g, primaryRgb.b);
                doc.rect(0, 0, pageWidth, 25, 'F');
                
                // FixAIR Logo text (white)
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(18);
                doc.setFont('helvetica', 'bold');
                doc.text('FixAIR', margin, 12);
                
                // Brand name
                doc.setFontSize(12);
                doc.setFont('helvetica', 'normal');
                doc.text(data.brand || 'Multi-marques', margin, 20);
                
                // Report title (right side)
                doc.setFontSize(10);
                doc.text("RAPPORT D'INTERVENTION", pageWidth - margin, 12, { align: 'right' });
                
                // Reference
                if (data.reference) {
                    doc.setFontSize(9);
                    doc.text(data.reference, pageWidth - margin, 18, { align: 'right' });
                }
                
                // Date
                if (data.date) {
                    doc.text(data.date, pageWidth - margin, 23, { align: 'right' });
                }
                
                y = 35;
                
                //  STATUS BADGE 
                if (data.status) {
                    const statusColors = {
                        'conforme': { r: 34, g: 197, b: 94 },
                        'non_conforme': { r: 239, g: 68, b: 68 },
                        'en_cours': { r: 234, g: 179, b: 8 }
                    };
                    const statusLabels = {
                        'conforme': 'CONFORME',
                        'non_conforme': 'NON CONFORME',
                        'en_cours': 'EN COURS'
                    };
                    const sc = statusColors[data.status] || statusColors.en_cours;
                    const sl = statusLabels[data.status] || data.status.toUpperCase();
                    
                    doc.setFillColor(sc.r, sc.g, sc.b);
                    doc.roundedRect(margin, y, 35, 7, 2, 2, 'F');
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(8);
                    doc.setFont('helvetica', 'bold');
                    doc.text(sl, margin + 17.5, y + 5, { align: 'center' });
                    
                    y += 12;
                }
                
                //  RSUM 
                if (data.resume) {
                    doc.setTextColor(30, 30, 30);
                    doc.setFontSize(11);
                    doc.setFont('helvetica', 'bold');
                    doc.text('Rsum', margin, y);
                    y += 6;
                    
                    doc.setFont('helvetica', 'normal');
                    doc.setFontSize(10);
                    doc.setTextColor(60, 60, 60);
                    const resumeLines = doc.splitTextToSize(data.resume, contentWidth);
                    doc.text(resumeLines, margin, y);
                    y += resumeLines.length * 5 + 8;
                }
                
                //  SECTION HELPER 
                const addSection = (title, items, startY) => {
                    if (!items || items.length === 0) return startY;
                    
                    doc.setTextColor(primaryRgb.r, primaryRgb.g, primaryRgb.b);
                    doc.setFontSize(10);
                    doc.setFont('helvetica', 'bold');
                    doc.text(title, margin, startY);
                    startY += 5;
                    
                    // Section line
                    doc.setDrawColor(primaryRgb.r, primaryRgb.g, primaryRgb.b);
                    doc.setLineWidth(0.5);
                    doc.line(margin, startY, margin + 40, startY);
                    startY += 4;
                    
                    doc.setTextColor(30, 30, 30);
                    doc.setFont('helvetica', 'normal');
                    doc.setFontSize(9);
                    
                    items.forEach(item => {
                        if (item.label && item.value) {
                            doc.setFont('helvetica', 'bold');
                            doc.text(item.label + ':', margin, startY);
                            doc.setFont('helvetica', 'normal');
                            const valueLines = doc.splitTextToSize(String(item.value), contentWidth - 35);
                            doc.text(valueLines, margin + 35, startY);
                            startY += valueLines.length * 4 + 2;
                        }
                    });
                    
                    return startY + 5;
                };
                
                //  CLIENT & SITE (2 columns) 
                const col1X = margin;
                const col2X = margin + contentWidth / 2 + 5;
                const colWidth = contentWidth / 2 - 5;
                let col1Y = y;
                let col2Y = y;
                
                // Client info
                if (data.client) {
                    const clientItems = [];
                    if (data.client.societe) clientItems.push({ label: 'Socit', value: data.client.societe });
                    if (data.client.contact) clientItems.push({ label: 'Contact', value: data.client.contact });
                    if (data.client.telephone) clientItems.push({ label: 'Tlphone', value: data.client.telephone });
                    if (data.client.dossier) clientItems.push({ label: 'N Dossier', value: data.client.dossier });
                    
                    if (clientItems.length > 0) {
                        doc.setTextColor(primaryRgb.r, primaryRgb.g, primaryRgb.b);
                        doc.setFontSize(10);
                        doc.setFont('helvetica', 'bold');
                        doc.text('Client', col1X, col1Y);
                        col1Y += 5;
                        doc.setDrawColor(primaryRgb.r, primaryRgb.g, primaryRgb.b);
                        doc.line(col1X, col1Y, col1X + 30, col1Y);
                        col1Y += 4;
                        
                        doc.setTextColor(30, 30, 30);
                        doc.setFontSize(9);
                        clientItems.forEach(item => {
                            doc.setFont('helvetica', 'bold');
                            doc.text(item.label + ':', col1X, col1Y);
                            doc.setFont('helvetica', 'normal');
                            doc.text(String(item.value), col1X + 25, col1Y);
                            col1Y += 5;
                        });
                        col1Y += 3;
                    }
                }
                
                // Site info
                if (data.site) {
                    const siteItems = [];
                    if (data.site.adresse) siteItems.push({ label: 'Adresse', value: data.site.adresse });
                    if (data.site.ville) siteItems.push({ label: 'Ville', value: data.site.ville });
                    if (data.site.batiment) siteItems.push({ label: 'Btiment', value: data.site.batiment });
                    if (data.site.acces) siteItems.push({ label: 'Accs', value: data.site.acces });
                    
                    if (siteItems.length > 0) {
                        doc.setTextColor(primaryRgb.r, primaryRgb.g, primaryRgb.b);
                        doc.setFontSize(10);
                        doc.setFont('helvetica', 'bold');
                        doc.text('Site', col2X, col2Y);
                        col2Y += 5;
                        doc.line(col2X, col2Y, col2X + 30, col2Y);
                        col2Y += 4;
                        
                        doc.setTextColor(30, 30, 30);
                        doc.setFontSize(9);
                        siteItems.forEach(item => {
                            doc.setFont('helvetica', 'bold');
                            doc.text(item.label + ':', col2X, col2Y);
                            doc.setFont('helvetica', 'normal');
                            const lines = doc.splitTextToSize(String(item.value), colWidth - 25);
                            doc.text(lines, col2X + 25, col2Y);
                            col2Y += lines.length * 4 + 1;
                        });
                        col2Y += 3;
                    }
                }
                
                y = Math.max(col1Y, col2Y) + 5;
                
                //  SYSTME & INTERVENTION (2 columns) 
                col1Y = y;
                col2Y = y;
                
                // Systme
                if (data.systeme) {
                    const sysItems = [];
                    if (data.systeme.type) sysItems.push({ label: 'Type', value: data.systeme.type });
                    if (data.systeme.modele) sysItems.push({ label: 'Modle', value: data.systeme.modele });
                    if (data.systeme.serie) sysItems.push({ label: 'N Srie', value: data.systeme.serie });
                    if (data.systeme.fluide) sysItems.push({ label: 'Fluide', value: data.systeme.fluide });
                    
                    if (sysItems.length > 0) {
                        doc.setTextColor(primaryRgb.r, primaryRgb.g, primaryRgb.b);
                        doc.setFontSize(10);
                        doc.setFont('helvetica', 'bold');
                        doc.text('Systme', col1X, col1Y);
                        col1Y += 5;
                        doc.line(col1X, col1Y, col1X + 30, col1Y);
                        col1Y += 4;
                        
                        doc.setTextColor(30, 30, 30);
                        doc.setFontSize(9);
                        sysItems.forEach(item => {
                            doc.setFont('helvetica', 'bold');
                            doc.text(item.label + ':', col1X, col1Y);
                            doc.setFont('helvetica', 'normal');
                            doc.text(String(item.value), col1X + 25, col1Y);
                            col1Y += 5;
                        });
                        col1Y += 3;
                    }
                }
                
                // Intervention
                if (data.intervention) {
                    const intItems = [];
                    if (data.intervention.type) intItems.push({ label: 'Type', value: data.intervention.type });
                    if (data.intervention.statut) intItems.push({ label: 'Statut', value: data.intervention.statut });
                    if (data.intervention.probleme) intItems.push({ label: 'Problme', value: data.intervention.probleme });
                    if (data.intervention.diagnostic) intItems.push({ label: 'Diagnostic', value: data.intervention.diagnostic });
                    
                    if (intItems.length > 0) {
                        doc.setTextColor(primaryRgb.r, primaryRgb.g, primaryRgb.b);
                        doc.setFontSize(10);
                        doc.setFont('helvetica', 'bold');
                        doc.text('Intervention', col2X, col2Y);
                        col2Y += 5;
                        doc.line(col2X, col2Y, col2X + 30, col2Y);
                        col2Y += 4;
                        
                        doc.setTextColor(30, 30, 30);
                        doc.setFontSize(9);
                        intItems.forEach(item => {
                            doc.setFont('helvetica', 'bold');
                            doc.text(item.label + ':', col2X, col2Y);
                            doc.setFont('helvetica', 'normal');
                            const lines = doc.splitTextToSize(String(item.value), colWidth - 25);
                            doc.text(lines, col2X + 25, col2Y);
                            col2Y += lines.length * 4 + 1;
                        });
                        col2Y += 3;
                    }
                }
                
                y = Math.max(col1Y, col2Y) + 5;
                
                // Check for page break
                if (y > pageHeight - 60) {
                    doc.addPage();
                    y = margin;
                }
                
                //  TRAVAUX EFFECTUS 
                if (data.travaux_effectues && data.travaux_effectues.length > 0) {
                    doc.setTextColor(primaryRgb.r, primaryRgb.g, primaryRgb.b);
                    doc.setFontSize(10);
                    doc.setFont('helvetica', 'bold');
                    doc.text('Travaux effectus', margin, y);
                    y += 5;
                    doc.line(margin, y, margin + 40, y);
                    y += 5;
                    
                    doc.setFontSize(9);
                    data.travaux_effectues.forEach(t => {
                        // Status icon
                        if (t.status === 'done') {
                            doc.setTextColor(34, 197, 94);
                            doc.text('', margin, y);
                        } else if (t.status === 'error') {
                            doc.setTextColor(239, 68, 68);
                            doc.text('', margin, y);
                        } else {
                            doc.setTextColor(234, 179, 8);
                            doc.text('', margin, y);
                        }
                        
                        doc.setTextColor(30, 30, 30);
                        doc.setFont('helvetica', 'normal');
                        const lines = doc.splitTextToSize(t.texte, contentWidth - 10);
                        doc.text(lines, margin + 6, y);
                        y += lines.length * 4 + 2;
                    });
                    y += 5;
                }
                
                //  MESURES 
                if (data.mesures && data.mesures.length > 0) {
                    if (y > pageHeight - 40) {
                        doc.addPage();
                        y = margin;
                    }
                    
                    doc.setTextColor(primaryRgb.r, primaryRgb.g, primaryRgb.b);
                    doc.setFontSize(10);
                    doc.setFont('helvetica', 'bold');
                    doc.text('Mesures', margin, y);
                    y += 5;
                    doc.line(margin, y, margin + 30, y);
                    y += 5;
                    
                    doc.setFontSize(9);
                    data.mesures.forEach(m => {
                        doc.setFont('helvetica', 'bold');
                        doc.setTextColor(30, 30, 30);
                        doc.text(m.label + ':', margin, y);
                        
                        // Value with status color
                        if (m.status === 'ok') {
                            doc.setTextColor(34, 197, 94);
                        } else if (m.status === 'error') {
                            doc.setTextColor(239, 68, 68);
                        } else {
                            doc.setTextColor(60, 60, 60);
                        }
                        doc.setFont('helvetica', 'normal');
                        doc.text(String(m.valeur), margin + 40, y);
                        
                        if (m.note) {
                            doc.setTextColor(120, 120, 120);
                            doc.text(`(${m.note})`, margin + 70, y);
                        }
                        y += 5;
                    });
                    y += 5;
                }
                
                //  RSULTAT 
                if (data.resultat) {
                    if (y > pageHeight - 30) {
                        doc.addPage();
                        y = margin;
                    }
                    
                    const resColor = data.resultat.status === 'resolu' 
                        ? { r: 34, g: 197, b: 94 } 
                        : { r: 239, g: 68, b: 68 };
                    
                    doc.setFillColor(resColor.r, resColor.g, resColor.b, 0.1);
                    doc.roundedRect(margin, y, contentWidth, 15, 3, 3, 'F');
                    
                    doc.setTextColor(resColor.r, resColor.g, resColor.b);
                    doc.setFontSize(11);
                    doc.setFont('helvetica', 'bold');
                    const resLabel = data.resultat.label || (data.resultat.status === 'resolu' ? 'Problme rsolu' : 'Non rsolu');
                    doc.text(resLabel, margin + 5, y + 6);
                    
                    if (data.resultat.description) {
                        doc.setFontSize(9);
                        doc.setFont('helvetica', 'normal');
                        doc.text(data.resultat.description, margin + 5, y + 11);
                    }
                    y += 20;
                }
                
                //  RSERVES 
                if (data.reserves && data.reserves.length > 0) {
                    if (y > pageHeight - 30) {
                        doc.addPage();
                        y = margin;
                    }
                    
                    doc.setTextColor(primaryRgb.r, primaryRgb.g, primaryRgb.b);
                    doc.setFontSize(10);
                    doc.setFont('helvetica', 'bold');
                    doc.text('Rserves / Alertes', margin, y);
                    y += 6;
                    
                    data.reserves.forEach(r => {
                        const rColor = r.type === 'danger' 
                            ? { r: 239, g: 68, b: 68 }
                            : { r: 234, g: 179, b: 8 };
                        
                        doc.setFillColor(rColor.r, rColor.g, rColor.b, 0.1);
                        doc.roundedRect(margin, y, contentWidth, 12, 2, 2, 'F');
                        
                        doc.setTextColor(rColor.r, rColor.g, rColor.b);
                        doc.setFontSize(9);
                        doc.setFont('helvetica', 'bold');
                        doc.text(r.type === 'danger' ? '' : '!', margin + 3, y + 5);
                        doc.text(r.titre || 'Attention', margin + 8, y + 5);
                        
                        doc.setFont('helvetica', 'normal');
                        doc.setTextColor(60, 60, 60);
                        const rLines = doc.splitTextToSize(r.texte, contentWidth - 15);
                        doc.text(rLines[0], margin + 8, y + 9);
                        y += 14;
                    });
                    y += 3;
                }
                
                //  PHOTOS 
                const photos = window.reportPhotos || [];
                if (photos.length > 0) {
                    doc.addPage();
                    y = margin;
                    
                    doc.setTextColor(primaryRgb.r, primaryRgb.g, primaryRgb.b);
                    doc.setFontSize(12);
                    doc.setFont('helvetica', 'bold');
                    doc.text('Photos de l\'intervention', margin, y);
                    y += 10;
                    
                    const photoWidth = 85;
                    const photoHeight = 60;
                    let photoX = margin;
                    
                    for (let i = 0; i < photos.length; i++) {
                        const photo = photos[i];
                        
                        try {
                            const imgData = photo.data || photo.url;
                            if (imgData && imgData.startsWith('data:image')) {
                                doc.addImage(imgData, 'JPEG', photoX, y, photoWidth, photoHeight);
                                
                                // Caption
                                if (photo.caption) {
                                    doc.setTextColor(60, 60, 60);
                                    doc.setFontSize(8);
                                    doc.setFont('helvetica', 'italic');
                                    doc.text(photo.caption, photoX, y + photoHeight + 4);
                                }
                                
                                // Move to next position
                                if (i % 2 === 0) {
                                    photoX = margin + photoWidth + 10;
                                } else {
                                    photoX = margin;
                                    y += photoHeight + 15;
                                    
                                    // Check page break
                                    if (y > pageHeight - photoHeight - 20) {
                                        doc.addPage();
                                        y = margin;
                                    }
                                }
                            }
                        } catch (e) {
                            console.error('Error adding photo to PDF:', e);
                        }
                    }
                }
                
                //  FOOTER 
                const totalPages = doc.internal.getNumberOfPages();
                for (let i = 1; i <= totalPages; i++) {
                    doc.setPage(i);
                    
                    // Footer line
                    doc.setDrawColor(200, 200, 200);
                    doc.setLineWidth(0.3);
                    doc.line(margin, pageHeight - 15, pageWidth - margin, pageHeight - 15);
                    
                    // Footer text
                    doc.setTextColor(120, 120, 120);
                    doc.setFontSize(8);
                    doc.setFont('helvetica', 'normal');
                    doc.text(`Gnr par FixAIR - ${new Date().toLocaleDateString('fr-FR')}`, margin, pageHeight - 10);
                    doc.text(`Page ${i}/${totalPages}`, pageWidth - margin, pageHeight - 10, { align: 'right' });
                    
                    // Technicien
                    if (data.technicien && data.technicien.nom) {
                        doc.text(`Technicien: ${data.technicien.nom}`, pageWidth / 2, pageHeight - 10, { align: 'center' });
                    }
                }
                
                //  SAVE PDF 
                const filename = `Rapport_${data.brand || 'FixAIR'}_${data.reference || new Date().toISOString().split('T')[0]}.pdf`;
                doc.save(filename);
                
                // Mark report as completed (for manager visibility)
                if (lastReportData) {
                    lastReportData.status = 'complet';
                    lastReportData.exported_at = new Date().toISOString();
                    updateDrawerPreview(lastReportData);
                    console.log(' Report exported and marked as complete');
                }
                
                // Track gamification
                trackAction('report');
                
                toast('PDF tlcharg !');
                
            } catch (error) {
                console.error('Error generating PDF:', error);
                toast('Erreur gnration PDF');
            }
        }
        
        // 
        // DRAWER PREVIEW - Live Report Updates
        // 
        
        // Update the drawer preview with report data
        function updateDrawerPreview(data) {
            const emptyState = document.getElementById('reportPreviewEmpty');
            const previewContent = document.getElementById('reportPreviewContent');
            const reportBtn = document.querySelector('.h-btn.report-btn');
            const headerProgress = document.getElementById('reportHeaderProgress');
            const progressFill = document.getElementById('reportProgressFill');
            const progressText = document.getElementById('reportProgressText');
            
            if (!previewContent) return;
            
            // Check if we have any meaningful data beyond just brand/date
            const hasData = data && (
                data.type_intervention ||
                data.client ||
                data.site ||
                data.systeme ||
                data.codes_defaut ||
                data.travaux_effectues ||
                data.mesures ||
                data.resultat ||
                data.resume
            );
            
            if (!hasData) {
                // Show empty state
                if (emptyState) emptyState.style.display = '';
                previewContent.style.display = 'none';
                if (reportBtn) reportBtn.classList.remove('has-data');
                // Hide progress bar
                if (headerProgress) headerProgress.style.display = 'none';
                return;
            }
            
            // Hide empty state, show preview
            if (emptyState) emptyState.style.display = 'none';
            previewContent.style.display = 'block';
            
            // Add has-data class to button to show pulse
            if (reportBtn) reportBtn.classList.add('has-data');
            
            // Calculate completion percentage for manager visibility
            const completionStatus = calculateReportCompletion(data);
            
            // Update header progress bar
            if (headerProgress && progressFill && progressText) {
                headerProgress.style.display = 'flex';
                progressFill.style.width = completionStatus.percentage + '%';
                progressText.textContent = completionStatus.percentage + '%';
            }
            
            // Generate preview HTML (only filled sections)
            const previewHtml = renderReportPreview(data, completionStatus);
            previewContent.innerHTML = previewHtml;
            
            console.log(' Drawer preview updated - Completion:', completionStatus.percentage + '%');
        }
        
        // Calculate report completion for manager visibility
        function calculateReportCompletion(data) {
            // All trackable fields with weights (more important = higher weight)
            const fieldChecks = {
                // Essential fields (weight: 2)
                type_intervention: { filled: !!data.type_intervention, weight: 2 },
                client_societe: { filled: !!(data.client && data.client.societe), weight: 2 },
                systeme_modele: { filled: !!(data.systeme && data.systeme.modele), weight: 2 },
                resultat: { filled: !!data.resultat, weight: 2 },
                
                // Important fields (weight: 1.5)
                site_adresse: { filled: !!(data.site && data.site.adresse), weight: 1.5 },
                site_ville: { filled: !!(data.site && data.site.ville), weight: 1.5 },
                systeme_type: { filled: !!(data.systeme && data.systeme.type), weight: 1.5 },
                travaux_effectues: { filled: !!(data.travaux_effectues && data.travaux_effectues.length > 0), weight: 1.5 },
                
                // Optional but valuable (weight: 1)
                reference: { filled: !!data.reference, weight: 1 },
                resume: { filled: !!data.resume, weight: 1 },
                client_contact: { filled: !!(data.client && data.client.contact), weight: 1 },
                client_telephone: { filled: !!(data.client && data.client.telephone), weight: 1 },
                systeme_serie: { filled: !!(data.systeme && data.systeme.serie), weight: 1 },
                systeme_fluide: { filled: !!(data.systeme && data.systeme.fluide), weight: 1 },
                codes_defaut: { filled: !!(data.codes_defaut && data.codes_defaut.length > 0), weight: 1 },
                mesures: { filled: !!(data.mesures && data.mesures.length > 0), weight: 1 },
                
                // Bonus (weight: 0.5)
                technicien: { filled: !!(data.technicien && data.technicien.nom), weight: 0.5 },
                reserves: { filled: !!(data.reserves && data.reserves.length > 0), weight: 0.5 },
                photos: { filled: !!(window.reportPhotos && window.reportPhotos.length > 0), weight: 0.5 }
            };
            
            // Calculate weighted percentage
            let totalWeight = 0;
            let filledWeight = 0;
            const filledFields = [];
            const missingFields = [];
            
            for (const [key, check] of Object.entries(fieldChecks)) {
                totalWeight += check.weight;
                if (check.filled) {
                    filledWeight += check.weight;
                    filledFields.push(key);
                } else {
                    missingFields.push(key);
                }
            }
            
            const percentage = Math.round((filledWeight / totalWeight) * 100);
            
            // If exported, ensure at least 70%
            const finalPercentage = data.exported_at ? Math.max(percentage, 70) : percentage;
            
            return {
                fields: fieldChecks,
                filledFields,
                missingFields,
                filled: filledFields.length,
                total: Object.keys(fieldChecks).length,
                percentage: finalPercentage,
                isComplete: finalPercentage >= 85,
                status: finalPercentage >= 85 ? 'complet' : (finalPercentage >= 50 ? 'en_cours' : 'debut')
            };
        }
        
        // Build partial report from conversation
        // Called when we detect report-relevant info in the chat
        function buildPartialReport() {
            // Get info from chatHistory
            const history = chatHistory.assistant || [];
            const userMessages = history.filter(m => m.role === 'user').map(m => m.content);
            const allText = userMessages.join(' ').toLowerCase();
            const allTextOriginal = userMessages.join(' ');
            
            // If no messages yet, don't show anything
            if (userMessages.length === 0) {
                return;
            }
            
            // Get brand display name
            const brandNames = {
                'mitsubishi': 'Mitsubishi Electric',
                'daikin': 'Daikin',
                'carrier': 'Carrier',
                'lg': 'LG',
                'samsung': 'Samsung',
                'panasonic': 'Panasonic',
                'toshiba': 'Toshiba',
                'fujitsu': 'Fujitsu',
                'hitachi': 'Hitachi',
                'general': 'Multi-marques'
            };
            
            // Start with base data (keep existing if any)
            const partialData = lastReportData ? { ...lastReportData } : {
                brand: brandNames[brand] || brand,
                brand_key: brand,
                status: 'en_cours',
                date: new Date().toLocaleDateString('fr-FR')
            };
            
            // Detect type
            if (allText.includes('dpannage') || allText.includes('sav') || allText.includes('panne') || allText.includes('problme') || allText.includes('marche pas') || allText.includes('fonctionne pas')) {
                partialData.type_intervention = 'SAV / Dpannage';
            } else if (allText.includes('mise en service') || allText.match(/\bmes\b/) || allText.includes('nouvelle installation')) {
                partialData.type_intervention = 'Mise en service';
            } else if (allText.includes('maintenance') || allText.includes('entretien') || allText.includes('contrle')) {
                partialData.type_intervention = 'Maintenance';
            } else if (allText.includes('installation') || allText.includes('installer')) {
                partialData.type_intervention = 'Installation';
            }
            
            // Detect client (multiple patterns)
            const clientPatterns = [
                /(?:chez|client|socit|societe|pour)\s+([A-Z-][a-z-\s]{1,30})/,
                /(?:chez|client)\s+([a-z-\s]{2,30})/i
            ];
            for (const pattern of clientPatterns) {
                const match = allTextOriginal.match(pattern);
                if (match) {
                    partialData.client = { societe: match[1].trim() };
                    break;
                }
            }
            
            // Detect address patterns
            const addressMatch = allTextOriginal.match(/(\d{1,4}[\s,]+(?:rue|avenue|boulevard|bd|av|alle|place|chemin)[\s\w\-']+)/i);
            if (addressMatch) {
                partialData.site = partialData.site || {};
                partialData.site.adresse = addressMatch[1].trim();
            }
            
            // Detect city (postal code pattern)
            const cityMatch = allTextOriginal.match(/(\d{5})\s*([A-Z-a-z-\s\-]+)/);
            if (cityMatch) {
                partialData.site = partialData.site || {};
                partialData.site.ville = cityMatch[1] + ' ' + cityMatch[2].trim();
            }
            
            // Detect code erreur (multiple patterns)
            const codePatterns = [
                /(?:code|erreur|dfaut|fault)\s*:?\s*([A-Z]?\d{1,4})/i,
                /\b([EAUFPH]\d{1,3})\b/i,
                /\b(7[HSL]|U\d{1,2})\b/i
            ];
            for (const pattern of codePatterns) {
                const match = allText.match(pattern);
                if (match) {
                    partialData.codes_defaut = [{ code: match[1].toUpperCase(), description: 'Code dtect dans la conversation' }];
                    break;
                }
            }
            
            // Detect model
            const modelPatterns = [
                /(PUHY|PURY|PUMY|PEFY|PLFY|PKFY|MSZ|MUZ|FDC|FDCA)[\s\-]?([A-Z0-9\-]{3,20})/i,
                /(VRV|VRF|DVM|MULTI[\s\-]?V)[\s\-]?([A-Z0-9\-]{0,15})/i,
                /(FXMQ|FXAQ|FXZQ|FDXM|RXM)[\s\-]?([A-Z0-9]{2,10})/i
            ];
            for (const pattern of modelPatterns) {
                const match = allTextOriginal.match(pattern);
                if (match) {
                    partialData.systeme = partialData.systeme || {};
                    partialData.systeme.modele = match[0].toUpperCase();
                    partialData.systeme.type = match[1].toUpperCase().includes('VR') ? 'VRF' : 
                                               match[1].toUpperCase().includes('PU') ? 'VRF Mitsubishi' : 'Split';
                    break;
                }
            }
            
            // Detect fluide
            const fluideMatch = allText.match(/(r410a|r32|r134a|r407c|r290)/i);
            if (fluideMatch) {
                partialData.systeme = partialData.systeme || {};
                partialData.systeme.fluide = fluideMatch[1].toUpperCase();
            }
            
            // Detect problem description
            const problemPatterns = [
                /(?:problme|souci|dfaut|panne)\s*:?\s*(.{10,100})/i,
                /(?:ne\s+(?:chauffe|refroidit|dmarre|marche)\s+(?:pas|plus))/i
            ];
            for (const pattern of problemPatterns) {
                const match = allTextOriginal.match(pattern);
                if (match) {
                    partialData.intervention = partialData.intervention || {};
                    partialData.intervention.probleme = match[1] ? match[1].trim() : match[0];
                    break;
                }
            }
            
            // Update the stored data and refresh preview
            lastReportData = partialData;
            updateDrawerPreview(partialData);
        }
        
        // Render simplified report preview for drawer (only shows filled sections)
        function renderReportPreview(data, completionStatus) {
            if (!data) return '';
            
            const brandNames = {
                'mitsubishi': 'Mitsubishi Electric',
                'daikin': 'Daikin',
                'carrier': 'Carrier',
                'lg': 'LG',
                'samsung': 'Samsung',
                'panasonic': 'Panasonic',
                'toshiba': 'Toshiba',
                'fujitsu': 'Fujitsu',
                'hitachi': 'Hitachi',
                'general': 'Multi-marques'
            };
            
            const brandClass = data.brand_key || 'general';
            const brandName = brandNames[brandClass] || data.brand || 'FixAIR';
            
            // Status
            let statusClass = 'en-cours';
            let statusText = 'En cours';
            if (data.status) {
                const s = data.status.toLowerCase();
                if (s.includes('conforme') && !s.includes('non')) {
                    statusClass = 'conforme';
                    statusText = 'Conforme';
                } else if (s.includes('non') || s.includes('refus')) {
                    statusClass = 'non-conforme';
                    statusText = 'Non conforme';
                }
            }
            
            // Completion info
            const completion = completionStatus || { percentage: 0, status: 'debut' };
            
            let html = `<div class="rpt" style="margin:0;">`;
            
            // Header (progress bar now in fixed drawer header)
            html += `
            <div class="rpt-header">
                <div class="rpt-header-top">
                    <div>
                        <div class="rpt-brand ${brandClass}">${brandName}</div>
                        <h1 class="rpt-title">Rapport d'intervention</h1>
                    </div>
                    <div class="rpt-status ${statusClass}">
                        <span class="rpt-status-dot"></span>
                        <span class="rpt-status-text">${statusText}</span>
                    </div>
                </div>
                <div class="rpt-meta">
                    ${data.reference ? `<span>Rf <span class="val">${data.reference}</span></span>` : ''}
                    ${data.type_intervention ? `<span>Type <span class="val">${data.type_intervention}</span></span>` : ''}
                    ${data.date ? `<span>Date <span class="val">${data.date}</span></span>` : ''}
                </div>
            </div>`;
            
            html += `<div class="rpt-card">`;
            
            // Rsum
            if (data.resume) {
                html += `
                <div class="rpt-section">
                    <div class="rpt-label">Rsum</div>
                    <p class="rpt-text">${data.resume}</p>
                </div>`;
            }
            
            // Client & Site
            if (data.client || data.site) {
                html += `<div class="rpt-section"><div class="rpt-grid">`;
                if (data.client) {
                    html += `<div class="rpt-group"><div class="rpt-label">Client</div>`;
                    if (data.client.societe) html += `<div class="rpt-row"><span class="rpt-row-label">Socit</span><span class="rpt-row-value">${data.client.societe}</span></div>`;
                    if (data.client.contact) html += `<div class="rpt-row"><span class="rpt-row-label">Contact</span><span class="rpt-row-value">${data.client.contact}</span></div>`;
                    if (data.client.telephone) html += `<div class="rpt-row"><span class="rpt-row-label">Tlphone</span><span class="rpt-row-value">${data.client.telephone}</span></div>`;
                    html += `</div>`;
                }
                if (data.site) {
                    html += `<div class="rpt-group"><div class="rpt-label">Site</div>`;
                    if (data.site.adresse) html += `<div class="rpt-row"><span class="rpt-row-label">Adresse</span><span class="rpt-row-value">${data.site.adresse}</span></div>`;
                    if (data.site.ville) html += `<div class="rpt-row"><span class="rpt-row-label">Ville</span><span class="rpt-row-value">${data.site.ville}</span></div>`;
                    html += `</div>`;
                }
                html += `</div></div>`;
            }
            
            // Systme
            if (data.systeme) {
                html += `<div class="rpt-section"><div class="rpt-label">Systme</div>`;
                if (data.systeme.type) html += `<div class="rpt-row"><span class="rpt-row-label">Type</span><span class="rpt-row-value">${data.systeme.type}</span></div>`;
                if (data.systeme.modele) html += `<div class="rpt-row"><span class="rpt-row-label">Modle</span><span class="rpt-row-value mono">${data.systeme.modele}</span></div>`;
                if (data.systeme.serie) html += `<div class="rpt-row"><span class="rpt-row-label">N Srie</span><span class="rpt-row-value mono">${data.systeme.serie}</span></div>`;
                if (data.systeme.fluide) html += `<div class="rpt-row"><span class="rpt-row-label">Fluide</span><span class="rpt-row-value">${data.systeme.fluide}</span></div>`;
                html += `</div>`;
            }
            
            // Codes dfaut
            if (data.codes_defaut && data.codes_defaut.length > 0) {
                html += `<div class="rpt-section"><div class="rpt-label">Codes dfaut</div>`;
                data.codes_defaut.forEach(c => {
                    html += `<div class="rpt-row"><span class="rpt-row-label code-badge">${c.code}</span><span class="rpt-row-value">${c.description || ''}</span></div>`;
                });
                html += `</div>`;
            }
            
            // Travaux effectus
            if (data.travaux_effectues && data.travaux_effectues.length > 0) {
                html += `<div class="rpt-section"><div class="rpt-label">Travaux effectus</div><ul class="rpt-checklist">`;
                data.travaux_effectues.forEach(t => {
                    const icon = t.status === 'done' ? '' : (t.status === 'error' ? '' : '');
                    const cls = t.status || 'pending';
                    html += `<li class="${cls}"><span class="check-icon">${icon}</span>${t.texte}</li>`;
                });
                html += `</ul></div>`;
            }
            
            // Mesures
            if (data.mesures && data.mesures.length > 0) {
                html += `<div class="rpt-section"><div class="rpt-label">Mesures</div><div class="rpt-measures">`;
                data.mesures.forEach(m => {
                    const cls = m.status || '';
                    html += `<div class="rpt-measure ${cls}"><span class="measure-label">${m.label}</span><span class="measure-value">${m.valeur}</span></div>`;
                });
                html += `</div></div>`;
            }
            
            // Rsultat
            if (data.resultat) {
                const resClass = data.resultat.status === 'resolu' ? 'resolved' : 'unresolved';
                html += `
                <div class="rpt-section">
                    <div class="rpt-result ${resClass}">
                        <div class="result-icon">${data.resultat.status === 'resolu' ? '' : '!'}</div>
                        <div>
                            <div class="result-label">${data.resultat.label || (data.resultat.status === 'resolu' ? 'Rsolu' : 'Non rsolu')}</div>
                            ${data.resultat.description ? `<div class="result-desc">${data.resultat.description}</div>` : ''}
                        </div>
                    </div>
                </div>`;
            }
            
            // Rserves - each in its own block with gap
            if (data.reserves && data.reserves.length > 0) {
                html += `<div class="rpt-section"><div class="rpt-label">Rserves</div><div class="rpt-alerts">`;
                data.reserves.forEach(r => {
                    const cls = r.type === 'danger' ? 'danger' : 'warning';
                    html += `<div class="rpt-alert ${cls}"><strong>${r.titre || 'Attention'}</strong><p>${r.texte}</p></div>`;
                });
                html += `</div></div>`;
            }
            
            // Technicien
            if (data.technicien && data.technicien.nom) {
                html += `
                <div class="rpt-footer-info">
                    <span>Technicien: ${data.technicien.nom}</span>
                    ${data.technicien.heure_arrivee ? `<span>Arrive: ${data.technicien.heure_arrivee}</span>` : ''}
                    ${data.technicien.heure_depart ? `<span>Dpart: ${data.technicien.heure_depart}</span>` : ''}
                </div>`;
            }
            
            // Photos count
            const photos = window.reportPhotos || [];
            if (photos.length > 0) {
                html += `<div class="rpt-section"><div class="rpt-label">Photos (${photos.length})</div>
                    <div style="display:flex;gap:8px;flex-wrap:wrap;">`;
                photos.slice(0, 4).forEach(p => {
                    html += `<img src="${p.data || p.url}" style="width:60px;height:45px;object-fit:cover;border-radius:6px;border:1px solid var(--border);">`;
                });
                if (photos.length > 4) {
                    html += `<div style="width:60px;height:45px;border-radius:6px;background:var(--card);display:flex;align-items:center;justify-content:center;font-size:12px;color:var(--text-dim);">+${photos.length - 4}</div>`;
                }
                html += `</div></div>`;
            }
            
            html += `</div></div>`;
            
            return html;
        }
        
        // Simple markdown parser
        function parseMarkdown(text) {
            if (!text) return '';
            
            //  CHECK FOR JSON REPORT 
            // If the AI returns structured JSON, use the beautiful template
            let trimmed = text.trim();
            
            // Check if JSON is wrapped in markdown code block
            // Pattern handles: ```json, ``` json, ```\njson, ``` \n json, etc.
            const codeBlockMatch = trimmed.match(/```\s*(?:json)?\s*([\s\S]*?)\s*```/);
            if (codeBlockMatch) {
                const jsonContent = codeBlockMatch[1].trim();
                if (jsonContent.startsWith('{')) {
                    try {
                        const jsonData = JSON.parse(jsonContent);
                        if (jsonData.type === 'report' || jsonData.resume || jsonData.travaux_effectues || jsonData.resultat) {
                            console.log(' Detected JSON report in code block, rendering with template');
                            // Extract intro text before the code block
                            const introMatch = trimmed.match(/^([\s\S]*?)```/);
                            const introText = introMatch ? introMatch[1].trim() : '';
                            const reportHtml = renderReport(jsonData.data || jsonData);
                            return introText ? `<p>${introText.replace(/\n/g, '<br>')}</p>${reportHtml}` : reportHtml;
                        }
                    } catch (e) {
                        console.log('Code block is not valid JSON report:', e.message);
                    }
                }
            }
            
            // Check for raw JSON (starts with { and ends with })
            if (trimmed.startsWith('{') && trimmed.endsWith('}')) {
                try {
                    const jsonData = JSON.parse(trimmed);
                    if (jsonData.type === 'report' || jsonData.resume || jsonData.travaux_effectues || jsonData.resultat) {
                        console.log(' Detected raw JSON report, rendering with template');
                        return renderReport(jsonData.data || jsonData);
                    }
                } catch (e) {
                    console.log('Not valid JSON, parsing as markdown');
                }
            }
            
            // Check for JSON embedded in text (intro text + JSON)
            const embeddedJsonMatch = trimmed.match(/^([\s\S]*?)\s*(\{[\s\S]*"type"\s*:\s*"report"[\s\S]*\})\s*$/);
            if (embeddedJsonMatch) {
                try {
                    const jsonData = JSON.parse(embeddedJsonMatch[2]);
                    console.log(' Detected embedded JSON report, rendering with template');
                    const introText = embeddedJsonMatch[1].trim();
                    const reportHtml = renderReport(jsonData.data || jsonData);
                    return introText ? `<p>${introText.replace(/\n/g, '<br>')}</p>${reportHtml}` : reportHtml;
                } catch (e) {
                    console.log('Embedded JSON parse failed:', e.message);
                }
            }
            
            // Strip ALL HTML tags the AI might output (inline styles, divs, etc.)
            // This is necessary because sometimes AI generates HTML instead of markdown
            text = text.replace(/<[^>]*style="[^"]*"[^>]*>/gi, ''); // Remove tags with style attributes
            text = text.replace(/<div[^>]*>/gi, '');
            text = text.replace(/<\/div>/gi, '');
            text = text.replace(/<span[^>]*>/gi, '');
            text = text.replace(/<\/span>/gi, '');
            text = text.replace(/<table[^>]*>/gi, '');
            text = text.replace(/<\/table>/gi, '');
            text = text.replace(/<tr[^>]*>/gi, '');
            text = text.replace(/<\/tr>/gi, '');
            text = text.replace(/<td[^>]*>/gi, ' ');
            text = text.replace(/<\/td>/gi, '');
            text = text.replace(/<th[^>]*>/gi, ' ');
            text = text.replace(/<\/th>/gi, '');
            text = text.replace(/<thead[^>]*>/gi, '');
            text = text.replace(/<\/thead>/gi, '');
            text = text.replace(/<tbody[^>]*>/gi, '');
            text = text.replace(/<\/tbody>/gi, '');
            text = text.replace(/<h[1-6][^>]*>/gi, '\n');
            text = text.replace(/<\/h[1-6]>/gi, '\n');
            text = text.replace(/<p[^>]*>/gi, '\n');
            text = text.replace(/<\/p>/gi, '\n');
            text = text.replace(/<br\s*\/?>/gi, '\n');
            text = text.replace(/<ul[^>]*>/gi, '');
            text = text.replace(/<\/ul>/gi, '');
            text = text.replace(/<li[^>]*>/gi, ' ');
            text = text.replace(/<\/li>/gi, '\n');
            text = text.replace(/<strong[^>]*>/gi, '**');
            text = text.replace(/<\/strong>/gi, '**');
            text = text.replace(/<em[^>]*>/gi, '*');
            text = text.replace(/<\/em>/gi, '*');
            text = text.replace(/<b[^>]*>/gi, '**');
            text = text.replace(/<\/b>/gi, '**');
            text = text.replace(/<i[^>]*>/gi, '*');
            text = text.replace(/<\/i>/gi, '*');
            // Remove any remaining HTML tags
            text = text.replace(/<[^>]+>/g, '');
            // Clean up multiple newlines
            text = text.replace(/\n{3,}/g, '\n\n');
            // Remove leading/trailing whitespace from lines
            text = text.split('\n').map(line => line.trim()).join('\n');
            
            // Check if this contains a report
            const reportMarker = 'RAPPORT D\'INTERVENTION';
            const hasReport = text.includes(reportMarker);
            let introText = '';
            let reportContent = '';
            
            if (hasReport) {
                const reportIndex = text.indexOf(reportMarker);
                introText = text.substring(0, reportIndex).trim();
                reportContent = text.substring(reportIndex).trim();
            }
            
            function parseTable(tableText) {
                const lines = tableText.trim().split('\n');
                if (lines.length < 2) return tableText;
                
                let html = '<table><thead><tr>';
                // Header row
                const headers = lines[0].split('|').map(h => h.trim()).filter(h => h);
                headers.forEach(h => {
                    html += `<th>${h}</th>`;
                });
                html += '</tr></thead><tbody>';
                
                // Skip separator line (index 1), process data rows
                for (let i = 2; i < lines.length; i++) {
                    const cells = lines[i].split('|').map(c => c.trim()).filter(c => c);
                    if (cells.length > 0 && !cells.every(c => c === '...' || c === '')) {
                        html += '<tr>';
                        cells.forEach(c => {
                            html += `<td>${c}</td>`;
                        });
                        html += '</tr>';
                    }
                }
                html += '</tbody></table>';
                return html;
            }
            
            function processMarkdown(txt) {
                // First, extract and process tables
                const tableRegex = /\|[^\n]+\|\n\|[-:\s|]+\|\n(\|[^\n]+\|\n?)*/g;
                let tables = [];
                txt = txt.replace(tableRegex, (match) => {
                    const placeholder = `__TABLE_${tables.length}__`;
                    tables.push(parseTable(match));
                    return placeholder;
                });
                
                // Escape HTML
                let html = txt
                    .replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;');
                
                // Restore tables
                tables.forEach((table, i) => {
                    html = html.replace(`__TABLE_${i}__`, table);
                });
                
                // Headers
                html = html.replace(/^### (.*$)/gm, '<h3>$1</h3>');
                html = html.replace(/^## (.*$)/gm, '<h2>$1</h2>');
                html = html.replace(/^# (.*$)/gm, '<h1>$1</h1>');
                
                // Bold and italic
                html = html.replace(/\*\*\*(.*?)\*\*\*/g, '<strong><em>$1</em></strong>');
                html = html.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                html = html.replace(/\*(.*?)\*/g, '<em>$1</em>');
                html = html.replace(/__(.*?)__/g, '<strong>$1</strong>');
                html = html.replace(/_(.*?)_/g, '<em>$1</em>');
                
                // Code blocks
                html = html.replace(/```([\s\S]*?)```/g, '<pre><code>$1</code></pre>');
                html = html.replace(/`(.*?)`/g, '<code>$1</code>');
                
                // Blockquotes
                html = html.replace(/^> (.*$)/gm, '<blockquote>$1</blockquote>');
                
                // Horizontal rule
                html = html.replace(/^---$/gm, '<hr>');
                
                // Unordered lists
                html = html.replace(/^\s*[-*]\s+(.*$)/gm, '<li>$1</li>');
                html = html.replace(/(<li>.*<\/li>\n?)+/g, '<ul>$&</ul>');
                
                // Ordered lists
                html = html.replace(/^\s*\d+\.\s+(.*$)/gm, '<li>$1</li>');
                
                // Paragraphs (double newlines)
                html = html.replace(/\n\n+/g, '</p><p>');
                
                // Single newlines to <br>
                html = html.replace(/\n/g, '<br>');
                
                // Wrap in paragraph if not already wrapped
                if (!html.startsWith('<h') && !html.startsWith('<ul') && !html.startsWith('<ol') && !html.startsWith('<pre') && !html.startsWith('<blockquote') && !html.startsWith('<table')) {
                    html = '<p>' + html + '</p>';
                }
                
                // Clean up empty paragraphs
                html = html.replace(/<p><\/p>/g, '');
                html = html.replace(/<p><br><\/p>/g, '');
                
                return html;
            }
            
            if (hasReport) {
                // Process intro text normally
                let result = introText ? processMarkdown(introText) : '';
                
                // Process report content and wrap in card
                let reportHtml = processMarkdown(reportContent);
                
                // Style the report title
                reportHtml = reportHtml.replace(
                    /RAPPORT D(&amp;#39;|&#39;|')INTERVENTION/g, 
                    '<span class="report-title">RAPPORT D\'INTERVENTION</span>'
                );
                
                // Add menu to report card
                const menuHtml = `<div class="report-menu">
                    <button class="report-menu-btn" onclick="toggleReportMenu(event, this)">
                        <span class="icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="1"/><circle cx="12" cy="5" r="1"/><circle cx="12" cy="19" r="1"/></svg></span>
                    </button>
                    <div class="report-menu-dropdown">
                        <div class="report-menu-item" onclick="copyReportContent(event, this)">
                            <span class="icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg></span>
                            <span>Copier</span>
                        </div>
                        <div class="report-menu-item" onclick="shareReportMenu(event, this)">
                            <span class="icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/></svg></span>
                            <span>Partager</span>
                        </div>
                        <div class="report-menu-item" onclick="exportReportPDFMenu(event, this)">
                            <span class="icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="12" y1="18" x2="12" y2="12"/><line x1="9" y1="15" x2="15" y2="15"/></svg></span>
                            <span>Export PDF</span>
                        </div>
                    </div>
                </div>`;
                
                result += '<div class="report-card">' + menuHtml + reportHtml + '</div>';
                return result;
            }
            
            return processMarkdown(text);
        }
        
        // Add loading message
        function addLoadingMsg(panel) {
            const body = document.getElementById(panel + 'Body');
            const msg = document.createElement('div');
            msg.className = 'msg ai';
            msg.id = 'loading-' + panel;
            const modeName = panel === 'copilot' ? 'Copilot' : 'Assistant';
            const modeIcon = panel === 'copilot' ? '#icon-star' : '#icon-clipboard';
            msg.innerHTML = `<div class="msg-bubble"><div class="msg-head"><div class="msg-avatar"><span class="icon"><svg><use href="${modeIcon}"/></svg></span></div><span class="msg-name">FixAIR ${modeName}</span></div><div class="msg-loading"><span></span><span></span><span></span></div></div>`;
            body.appendChild(msg);
            body.scrollTop = body.scrollHeight;
            return msg;
        }
        
        // Remove loading message
        function removeLoadingMsg(panel) {
            const loading = document.getElementById('loading-' + panel);
            if (loading) loading.remove();
        }
        
        // Conversation history per panel
        const chatHistory = {
            copilot: [],
            assistant: []
        };
        
        // Send message to n8n
        async function sendMsg(panel) {
            const input = document.getElementById(panel + 'Input');
            const btn = document.getElementById(panel + 'ActionBtn');
            const text = input.value.trim();
            if(!text) return;
            
            // Add user message to UI
            addMsg(panel, 'user', text);
            input.value = '';
            btn.classList.remove('has-text');
            resetTextarea(panel); // Reset textarea height
            
            // Add to history
            chatHistory[panel].push({ role: 'user', content: text });
            
            //  UPDATE DRAWER PREVIEW (Assistant mode) 
            if (panel === 'assistant') {
                buildPartialReport();
            }
            
            // NOTE: Messages are NOT tracked for gamification
            // Only real-value actions count: reports, OCR, photos, voice notes
            
            //  SUPABASE: Ensure project exists and save user message 
            try {
                const projectData = await ensureProject(panel);
                if (projectData && projectData.chatId) {
                    await saveMessage(projectData.chatId, 'user', text);
                }
            } catch (e) {
                console.warn('Supabase save failed (continuing anyway):', e);
            }
            //  END SUPABASE 
            
            // Show loading
            addLoadingMsg(panel);
            
            try {
                // Get brand name for display
                const brandNames = {
                    'mitsubishi': 'Mitsubishi Electric',
                    'daikin': 'Daikin',
                    'carrier': 'Carrier',
                    'lg': 'LG',
                    'samsung': 'Samsung',
                    'panasonic': 'Panasonic',
                    'toshiba': 'Toshiba',
                    'fujitsu': 'Fujitsu',
                    'hitachi': 'Hitachi',
                    'general': 'Multi-marques'
                };
                
                // Build payload with comprehensive context
                const currentSessionId = sessionIds[panel] || (panel + '-' + (currentProjectId || Date.now()));
                const currentBrandName = brandNames[brand] || brand || 'general';
                
                // IMPORTANT: Include system message + last 20 messages
                // Make sure system message is always first
                const systemMsg = chatHistory[panel].find(m => m.role === 'system');
                const nonSystemMessages = chatHistory[panel].filter(m => m.role !== 'system').slice(-19);
                const recentHistory = systemMsg 
                    ? [systemMsg, ...nonSystemMessages]
                    : nonSystemMessages.slice(-20);
                
                // Count previous interactions
                const previousUserMessages = chatHistory[panel].filter(m => m.role === 'user').length;
                const previousAiMessages = chatHistory[panel].filter(m => m.role === 'assistant').length;
                const isExistingConversation = previousUserMessages > 1;
                
                //  BUILD DETAILED CONVERSATION SUMMARY for n8n 
                let conversationSummary = '';
                if (isExistingConversation) {
                    // Build COMPLETE summary including AI responses
                    const userMsgs = chatHistory[panel].filter(m => m.role === 'user');
                    const aiMsgs = chatHistory[panel].filter(m => m.role === 'assistant');
                    
                    conversationSummary = `
 CONVERSATION EXISTANTE - TU DOIS UTILISER CE CONTEXTE 

Tu reprends une conversation avec ${previousUserMessages} messages du technicien et ${previousAiMessages} de tes rponses.

 HISTORIQUE COMPLET (lis attentivement) 
`;
                    
                    // Add ALL exchanges (interleaved user/AI) - up to last 20 messages
                    const allMsgs = chatHistory[panel].filter(m => m.role === 'user' || m.role === 'assistant');
                    const recentMsgs = allMsgs.slice(-20);
                    
                    recentMsgs.forEach((msg, i) => {
                        const role = msg.role === 'user' ? ' TECHNICIEN' : ' TOI';
                        let content = msg.content;
                        // Clean up JSON reports
                        if (content.includes('"type":"report"') || content.includes('"type": "report"')) {
                            content = '[RAPPORT JSON GNR]';
                        } else if (content.length > 250) {
                            content = content.substring(0, 250) + '...';
                        }
                        conversationSummary += `${role}: ${content}\n\n`;
                    });
                    
                    // Analyze what info was collected
                    const allUserText = userMsgs.map(m => m.content).join(' ').toLowerCase();
                    const collectedInfo = [];
                    
                    if (allUserText.includes('dpannage') || allUserText.includes('sav')) collectedInfo.push(' Type: Dpannage/SAV');
                    if (allUserText.includes('mise en service') || allUserText.includes('mes ')) collectedInfo.push(' Type: Mise en service');
                    if (allUserText.includes('maintenance')) collectedInfo.push(' Type: Maintenance');
                    if (allUserText.match(/chez\s+\w+/i)) collectedInfo.push(' Client mentionn');
                    if (allUserText.match(/code\s*[a-z]?\d+/i) || allUserText.match(/erreur\s*[a-z]?\d+/i)) collectedInfo.push(' Code erreur donn');
                    if (allUserText.match(/puhy|pury|pumy|vrv|vrf|split/i)) collectedInfo.push(' Type systme mentionn');
                    
                    const hasReport = aiMsgs.some(m => m.content && (m.content.includes('RAPPORT') || m.content.includes('"type":"report"')));
                    if (hasReport) collectedInfo.push(' RAPPORT DJ GNR');
                    
                    if (collectedInfo.length > 0) {
                        conversationSummary += ` CE QUI A T COLLECT \n${collectedInfo.join('\n')}\n\n`;
                    }
                    
                    conversationSummary += ` COMPORTEMENT OBLIGATOIRE 
- MARQUE: ${currentBrandName} (JAMAIS redemander)
- Tu as lu l'historique ci-dessus = tu CONNAIS la conversation
- Si "hey/salut"  rsume ce qui a t fait et demande comment continuer
- NE REDEMANDE JAMAIS une info dj donne dans l'historique
- Continue NATURELLEMENT comme si tu te souvenais de tout
`;
                }
                
                const payload = {
                    brand: brand || 'general',
                    brand_name: currentBrandName,
                    panel: panel,
                    message: text,
                    history: recentHistory,
                    chat_history: recentHistory, // Duplicate for compatibility
                    session_id: currentSessionId,
                    project_id: currentProjectId || null,
                    chat_id: currentChatId[panel] || null,
                    timestamp: new Date().toISOString(),
                    is_first_message: previousUserMessages === 1,
                    is_existing_conversation: isExistingConversation,
                    message_count: previousUserMessages,
                    conversation_summary: conversationSummary,
                    //  CRITICAL: brand_instruction is used in n8n systemMessage 
                    brand_instruction: isExistingConversation 
                        ? `${conversationSummary}`
                        : `MARQUE CONFIRME: ${currentBrandName}. NE DEMANDE JAMAIS LA MARQUE. NOUVELLE CONVERSATION.`,
                    system_context: isExistingConversation 
                        ? `${conversationSummary}`
                        : `NOUVELLE CONVERSATION. MARQUE: ${currentBrandName}. ${panel === 'assistant' ? 'Mode Rapport - pose les questions pour gnrer un rapport d\'intervention.' : 'Mode Diagnostic - aide au dpannage.'}`
                };
                
                console.log(' Sending to n8n:', N8N_WEBHOOK_URL);
                console.log(' Session ID:', currentSessionId);
                console.log(' Is existing conversation:', isExistingConversation, '(', previousUserMessages, 'user msgs,', previousAiMessages, 'AI msgs)');
                console.log(' History length:', recentHistory.length, '(system msg:', systemMsg ? 'yes' : 'no', ')');
                console.log(' Brand:', currentBrandName);
                if (isExistingConversation) {
                    console.log(' Full conversation summary being sent in brand_instruction');
                    console.log(' Summary preview:', conversationSummary.substring(0, 500) + '...');
                }
                
                // Call n8n webhook
                const response = await fetch(N8N_WEBHOOK_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });
                
                console.log(' Response status:', response.status);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error(' n8n Error:', response.status, errorText);
                    throw new Error('Erreur serveur: ' + response.status);
                }
                
                const data = await response.json();
                console.log(' Response data:', data);
                
                // Remove loading
                removeLoadingMsg(panel);
                
                // Parse markdown and add AI response
                const aiResponse = data.response || data.message || data.output || 'Dsol, une erreur est survenue.';
                const parsedResponse = parseMarkdown(aiResponse);
                addMsg(panel, 'ai', parsedResponse);
                
                // Add to history
                chatHistory[panel].push({ role: 'assistant', content: aiResponse });
                
                //  SUPABASE: Save AI response 
                try {
                    if (currentChatId[panel]) {
                        await saveMessage(currentChatId[panel], 'assistant', aiResponse);
                        
                        // If this is a report, save it to reports table
                        if (aiResponse.includes('RAPPORT D\'INTERVENTION')) {
                            await saveReport(aiResponse);
                            //  GAMIFICATION: Track report generated 
                            trackAction('report');
                        }
                    }
                } catch (e) {
                    console.warn('Supabase save AI response failed:', e);
                }
                //  END SUPABASE 
                
                // If assistant generated a report, update the report panel
                if (panel === 'assistant' && data.report) {
                    if (data.report.client) document.getElementById('rClient').textContent = data.report.client;
                    if (data.report.problem) document.getElementById('rProblem').textContent = data.report.problem;
                }
                
            } catch (error) {
                console.error(' Error sending message:', error);
                removeLoadingMsg(panel);
                addMsg(panel, 'ai', '<p><strong>Erreur</strong></p><p>' + error.message + '</p><p style="color:var(--text-dim);font-size:12px;">Vrifiez la console pour plus de dtails.</p>');
            }
        }
        
        // Save report to Supabase
        async function saveReport(reportContent) {
            if (!currentProjectId || !currentUserId) return;
            
            try {
                const { data, error } = await db
                    .from('reports')
                    .insert({
                        project_id: currentProjectId,
                        user_id: currentUserId,
                        report_type: reportContent.includes('[SAV') ? 'SAV' : (reportContent.includes('[MES') ? 'MES' : 'MAINT'),
                        title: 'Rapport d\'intervention',
                        status: 'completed',
                        solution_description: reportContent
                    })
                    .select()
                    .single();
                
                if (error) throw error;
                
                console.log(' Report saved:', data.id);
                
                // Update project status
                await db
                    .from('projects')
                    .update({ status: 'completed' })
                    .eq('id', currentProjectId);
                
            } catch (e) {
                console.error('Error saving report:', e);
            }
        }
        
        // Get voice intensity from analyser
        function getVoiceIntensity(panel) {
            const analyser = analysers[panel];
            if (!analyser) return 0;
            
            const dataArray = new Uint8Array(analyser.frequencyBinCount);
            analyser.getByteFrequencyData(dataArray);
            
            let sum = 0;
            for (let i = 0; i < dataArray.length; i++) {
                sum += dataArray[i];
            }
            const average = sum / dataArray.length / 255;
            
            if (average < SILENCE_THRESHOLD) return 0;
            return Math.min(1, (average - SILENCE_THRESHOLD) / (1 - SILENCE_THRESHOLD) * 2.0);
        }
        
        // Simulated intensity when no mic
        function getSimulatedIntensity(panel) {
            if (simulatedIntensityCurrent[panel] === undefined) {
                simulatedIntensityCurrent[panel] = 0;
                simulatedIntensityTarget[panel] = 0;
                simulatedSpeaking[panel] = false;
            }
            
            const diff = simulatedIntensityTarget[panel] - simulatedIntensityCurrent[panel];
            simulatedIntensityCurrent[panel] += diff * 0.3;
            
            if (simulatedSpeaking[panel] && simulatedIntensityCurrent[panel] > 0.1) {
                return simulatedIntensityCurrent[panel] + (Math.random() - 0.5) * 0.3;
            }
            return Math.max(0, simulatedIntensityCurrent[panel]);
        }
        
        // Update waveform - add bar and scroll left
        function updateWaveform(panel) {
            const barsContainer = document.getElementById(panel + 'Bars');
            if (!barsContainer) return;
            
            const intensity = recordings[panel]?.simulated 
                ? getSimulatedIntensity(panel) 
                : getVoiceIntensity(panel);
            
            const height = MIN_HEIGHT + (intensity * (MAX_HEIGHT - MIN_HEIGHT));
            
            const bar = document.createElement('div');
            bar.className = 'wave-bar';
            bar.style.height = height + 'px';
            barsContainer.appendChild(bar);
            
            while (barsContainer.children.length > MAX_BARS) {
                barsContainer.removeChild(barsContainer.firstChild);
            }
        }
        
        // Start recording
        async function startRecording(panel) {
            const inputRow = document.getElementById(panel + 'InputRow');
            const btn = document.getElementById(panel + 'ActionBtn');
            const barsContainer = document.getElementById(panel + 'Bars');
            const input = document.getElementById(panel + 'Input');
            
            barsContainer.innerHTML = '';
            simulatedIntensityCurrent[panel] = 0;
            simulatedIntensityTarget[panel] = 0;
            simulatedSpeaking[panel] = false;
            
            // Clear input and show listening state
            input.value = '';
            input.placeholder = ' En coute...';
            
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const source = audioContext.createMediaStreamSource(stream);
                const analyser = audioContext.createAnalyser();
                analyser.fftSize = 256;
                analyser.smoothingTimeConstant = 0.4;
                source.connect(analyser);
                
                audioContexts[panel] = audioContext;
                analysers[panel] = analyser;
                
                //  ELEVENLABS: Setup MediaRecorder for actual audio capture 
                const mediaRecorder = new MediaRecorder(stream, { mimeType: 'audio/webm' });
                const audioChunks = [];
                
                mediaRecorder.ondataavailable = (event) => {
                    if (event.data.size > 0) {
                        audioChunks.push(event.data);
                    }
                };
                
                mediaRecorder.onstop = async () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                    await transcribeWithElevenLabs(panel, audioBlob);
                };
                
                mediaRecorder.start();
                //  END ELEVENLABS SETUP 
                
                recordings[panel] = { stream, startTime: Date.now(), mediaRecorder };
                
            } catch (err) {
                console.log('Mic access denied, using simulation');
                recordings[panel] = { startTime: Date.now(), simulated: true };
                
                // Simulate speaking patterns
                const simInterval = setInterval(() => {
                    if (!recordings[panel]) { clearInterval(simInterval); return; }
                    if (Math.random() < 0.15) {
                        simulatedSpeaking[panel] = !simulatedSpeaking[panel];
                    }
                    simulatedIntensityTarget[panel] = simulatedSpeaking[panel] ? 0.4 + Math.random() * 0.6 : 0;
                }, 250);
            }
            
            inputRow.classList.add('recording');
            btn.classList.add('recording');
            btn.classList.remove('has-text');
            
            waveformIntervals[panel] = setInterval(() => updateWaveform(panel), 80);
            
            updateVoiceTimer(panel);
            voiceTimers[panel] = setInterval(() => updateVoiceTimer(panel), 100);
        }
        
        // 
        // ELEVENLABS SPEECH-TO-TEXT
        // 
        const ELEVENLABS_API_KEY = 'sk_22d550a1aecd2627750e50b5cf337ef5372bbbbcd35c8b71';
        
        async function transcribeWithElevenLabs(panel, audioBlob) {
            const input = document.getElementById(panel + 'Input');
            const btn = document.getElementById(panel + 'ActionBtn');
            const sphere = document.getElementById(panel + 'TranscriptionSphere');
            
            // Show glass sphere, hide button
            btn.style.display = 'none';
            sphere.classList.add('active');
            input.placeholder = '';
            
            try {
                const formData = new FormData();
                formData.append('file', audioBlob, 'recording.webm');
                formData.append('model_id', 'scribe_v1');
                formData.append('language_code', 'fra');
                
                const response = await fetch('https://api.elevenlabs.io/v1/speech-to-text', {
                    method: 'POST',
                    headers: {
                        'xi-api-key': ELEVENLABS_API_KEY
                    },
                    body: formData
                });
                
                if (!response.ok) {
                    throw new Error(`ElevenLabs API error: ${response.status}`);
                }
                
                const result = await response.json();
                const transcription = result.text || '';
                
                // Hide sphere, show button
                sphere.classList.remove('active');
                btn.style.display = 'flex';
                
                if (transcription.trim()) {
                    input.value = transcription.trim();
                    input.placeholder = panel === 'assistant' ? 'Dcrivez l\'intervention...' : 'Posez votre question...';
                    handleChatInput(panel);
                    toast(' Transcription termine');
                    console.log(' ElevenLabs transcription:', transcription);
                    
                    //  TRACK VOICE NOTE FOR GAMIFICATION 
                    trackAction('voice');
                } else {
                    input.placeholder = panel === 'assistant' ? 'Dcrivez l\'intervention...' : 'Posez votre question...';
                    toast(' Aucune parole dtecte');
                }
                
            } catch (error) {
                console.error(' ElevenLabs STT error:', error);
                
                // Hide sphere, show button
                sphere.classList.remove('active');
                btn.style.display = 'flex';
                
                input.placeholder = panel === 'assistant' ? 'Dcrivez l\'intervention...' : 'Posez votre question...';
                toast(' Erreur transcription');
                
                // Fallback to simulation for demo
                const transcriptions = [
                    "Erreur E6 sur groupe extrieur",
                    "Le compresseur ne dmarre pas",
                    "Code dfaut F3"
                ];
                input.value = transcriptions[Math.floor(Math.random() * transcriptions.length)];
                handleChatInput(panel);
            }
        }
        
        // Update timer
        function updateVoiceTimer(panel) {
            const timerEl = document.getElementById(panel + 'Timer');
            const recording = recordings[panel];
            if (!recording || !timerEl) return;
            
            const elapsed = (Date.now() - recording.startTime) / 1000;
            const minutes = Math.floor(elapsed / 60);
            const seconds = Math.floor(elapsed % 60);
            timerEl.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
        }
        
        // Stop recording
        function stopRecording(panel) {
            const inputRow = document.getElementById(panel + 'InputRow');
            const btn = document.getElementById(panel + 'ActionBtn');
            const barsContainer = document.getElementById(panel + 'Bars');
            const input = document.getElementById(panel + 'Input');
            const sphere = document.getElementById(panel + 'TranscriptionSphere');
            
            const isSimulated = recordings[panel]?.simulated;
            const hasRealRecording = recordings[panel]?.mediaRecorder;
            
            //  Show sphere immediately when stopping (for real recordings) 
            if (hasRealRecording) {
                btn.style.display = 'none';
                sphere.classList.add('active');
            }
            
            //  ELEVENLABS: Stop MediaRecorder (triggers ondataavailable and onstop) 
            if (recordings[panel]?.mediaRecorder && recordings[panel].mediaRecorder.state === 'recording') {
                recordings[panel].mediaRecorder.stop();
            }
            //  END ELEVENLABS 
            
            if (recordings[panel]?.stream) {
                recordings[panel].stream.getTracks().forEach(track => track.stop());
            }
            if (audioContexts[panel]) {
                audioContexts[panel].close();
            }
            if (waveformIntervals[panel]) {
                clearInterval(waveformIntervals[panel]);
            }
            if (voiceTimers[panel]) {
                clearInterval(voiceTimers[panel]);
            }
            
            if (barsContainer) barsContainer.innerHTML = '';
            
            inputRow.classList.remove('recording');
            btn.classList.remove('recording');
            
            // Handle simulated mode (fallback)
            if (isSimulated) {
                // Show sphere for simulated mode too
                btn.style.display = 'none';
                sphere.classList.add('active');
                
                setTimeout(() => {
                    // Hide sphere, show button
                    sphere.classList.remove('active');
                    btn.style.display = 'flex';
                    
                    const transcriptions = [
                        "Erreur E6 sur groupe extrieur Mitsubishi",
                        "Le compresseur ne dmarre pas correctement",
                        "Code dfaut F3 sur l'unit intrieure"
                    ];
                    input.value = transcriptions[Math.floor(Math.random() * transcriptions.length)];
                    handleChatInput(panel);
                    toast(' Transcription (simulation)');
                }, 1500); // Slightly longer delay to see the sphere
            }
            
            delete recordings[panel];
            delete audioContexts[panel];
            delete analysers[panel];
            
            const timerEl = document.getElementById(panel + 'Timer');
            if (timerEl) timerEl.textContent = '0:00';
        }

        function voiceInput(panel) {
            // Legacy function - now handled by handleAction
            handleAction(panel);
        }

        function copyTxt(el) {
            navigator.clipboard.writeText(el.closest('.msg-bubble').innerText);
            toast('Copi !');
        }
        
        // Report menu functions
        function toggleReportMenu(event, btn) {
            event.stopPropagation();
            const dropdown = btn.nextElementSibling;
            const wasOpen = dropdown.classList.contains('show');
            
            // Close all other report menus
            document.querySelectorAll('.report-menu-dropdown').forEach(d => d.classList.remove('show'));
            
            if (!wasOpen) {
                dropdown.classList.add('show');
            }
        }
        
        function copyReportContent(event, el) {
            event.stopPropagation();
            const card = el.closest('.report-card');
            const content = card.innerText;
            navigator.clipboard.writeText(content);
            toast('Rapport copi !');
            el.closest('.report-menu-dropdown').classList.remove('show');
        }
        
        // Share from report card menu (different from main shareReport)
        function shareReportCard(event, el) {
            event.stopPropagation();
            const card = el.closest('.report-card');
            const content = card.innerText;
            
            if (navigator.share) {
                navigator.share({
                    title: 'Rapport d\'intervention FixAIR',
                    text: content
                }).catch(() => {});
            } else {
                navigator.clipboard.writeText(content);
                toast('Rapport copi pour partage !');
            }
            el.closest('.report-menu-dropdown').classList.remove('show');
        }
        
        // Menu version of export PDF (called from dropdown)
        function exportReportPDFMenu(event, el) {
            event.stopPropagation();
            el.closest('.report-menu-dropdown').classList.remove('show');
            exportReportPDF();
        }
        
        // Menu version of share (called from dropdown in chat)
        function shareReportMenu(event, el) {
            event.stopPropagation();
            el.closest('.report-menu-dropdown').classList.remove('show');
            // Use lastReportData if available, otherwise use shareReport
            if (lastReportData) {
                shareReport();
            } else {
                // Fallback: try to get content from card
                const card = el.closest('.report-card');
                if (card) {
                    const content = card.innerText;
                    if (navigator.share) {
                        navigator.share({
                            title: 'Rapport d\'intervention FixAIR',
                            text: content
                        }).catch(() => {});
                    } else {
                        navigator.clipboard.writeText(content);
                        toast('Rapport copi pour partage !');
                    }
                }
            }
        }
        
        // Close report menu when clicking outside
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.report-menu')) {
                document.querySelectorAll('.report-menu-dropdown').forEach(d => d.classList.remove('show'));
            }
        });

        function toggleAttach(panel) {
            closeAllAttach();
            const menuId = 'attach' + panel.charAt(0).toUpperCase() + panel.slice(1);
            document.getElementById(menuId).classList.toggle('show');
        }

        function closeAllAttach() {
            document.querySelectorAll('.attach-menu').forEach(m => m.classList.remove('show'));
        }

        // 
        // PHOTO CAPTURE - V48 SIMPLIFIED (1-click flow)
        // 
        
        function attachAction(type, panel) {
            closeAllAttach();
            currentPhotoPanel = panel;
            console.log(' attachAction:', type, 'panel:', panel);
            
            if (type === 'camera') {
                document.getElementById('cameraInput').click();
            } else if (type === 'file') {
                document.getElementById('fileInput').click();
            }
        }
        
        function handleFileSelect(event, source) {
            const file = event.target.files[0];
            console.log(' handleFileSelect:', source, 'file:', file?.name, 'panel:', currentPhotoPanel);
            
            if (!file) {
                console.log(' No file selected');
                return;
            }
            
            // Check if it's an image
            if (file.type.startsWith('image/')) {
                if (file.size > 10 * 1024 * 1024) {
                    toast('Image trop volumineuse (max 10MB)');
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    console.log(' Image loaded, adding to chat...');
                    addPhotoToChat(currentPhotoPanel, e.target.result);
                };
                reader.onerror = function(e) {
                    console.error(' Error reading file:', e);
                    toast('Erreur lecture fichier');
                };
                reader.readAsDataURL(file);
            } else {
                // Non-image file (PDF, etc.)
                toast('Fichier: ' + file.name);
                addFileToChat(currentPhotoPanel, file);
            }
            
            event.target.value = '';
        }
        
        // Add non-image file to chat
        function addFileToChat(panel, file) {
            const container = document.getElementById(panel + 'Body');
            if (!container) return;
            
            const msgDiv = document.createElement('div');
            msgDiv.className = 'msg user';
            
            const ext = file.name.split('.').pop().toUpperCase();
            msgDiv.innerHTML = `
                <div class="msg-text">
                    <div class="file-attachment">
                        <span class="file-icon">${ext}</span>
                        <span class="file-name">${file.name}</span>
                    </div>
                </div>
            `;
            
            container.appendChild(msgDiv);
            scrollToBottom(panel);
        }
        
        // Scroll to bottom of chat
        function scrollToBottom(panel) {
            const container = document.getElementById(panel + 'Body');
            if (container) {
                setTimeout(() => {
                    container.scrollTop = container.scrollHeight;
                    updateScrollButton(panel);
                }, 50);
            }
        }
        
        // Initialize scroll detection for a panel
        function initScrollDetection(panel) {
            const container = document.getElementById(panel + 'Body');
            if (container) {
                container.addEventListener('scroll', () => {
                    updateScrollButton(panel);
                });
            }
        }
        
        // Update scroll button visibility
        function updateScrollButton(panel) {
            const container = document.getElementById(panel + 'Body');
            const btn = document.getElementById('scrollBtn' + panel.charAt(0).toUpperCase() + panel.slice(1));
            
            if (!container || !btn) return;
            
            // Show button if not at bottom (with 100px threshold)
            const isAtBottom = container.scrollHeight - container.scrollTop - container.clientHeight < 100;
            btn.classList.toggle('visible', !isAtBottom);
        }
        
        // Add photo directly to chat with action buttons
        async function addPhotoToChat(panel, imageData) {
            console.log(' addPhotoToChat called, panel:', panel);
            
            const container = document.getElementById(panel + 'Body');
            if (!container) {
                console.error(' Chat container not found:', panel + 'Body');
                toast('Erreur: chat non trouv');
                return;
            }
            
            const msgId = 'photo-' + Date.now();
            console.log(' Creating message:', msgId);
            
            const msgDiv = document.createElement('div');
            msgDiv.className = 'msg user';
            msgDiv.id = msgId;
            
            msgDiv.innerHTML = createPhotoMessageHTML(msgId, panel, imageData);
            
            // Store image data for later use
            msgDiv.dataset.imageData = imageData;
            
            container.appendChild(msgDiv);
            scrollToBottom(panel);
            
            projectMessageCount++;
            console.log(' Photo added to chat:', panel);
            toast('Photo ajoute');
            
            //  GAMIFICATION: Track photo upload 
            trackAction('photo');
            
            //  Save photo to database 
            if (currentProjectId && currentChatId[panel]) {
                try {
                    await saveMessage(currentChatId[panel], 'user', imageData, 'image');
                    console.log(' Photo saved to database');
                } catch (e) {
                    console.error(' Error saving photo:', e);
                }
            }
        }
        
        // Create HTML for photo message (reusable)
        function createPhotoMessageHTML(msgId, panel, imageData, reportState = null) {
            const reportBtnContent = reportState 
                ? '<span class="icon"><svg><use href="#icon-check"/></svg></span> Ajout'
                : '<span class="icon"><svg><use href="#icon-clipboard"/></svg></span> Rapport';
            const reportBtnClass = reportState ? 'photo-action-btn success' : 'photo-action-btn';
            const reportBtnDisabled = reportState ? 'disabled' : '';
            
            return `
                <div class="msg-text">
                    <div class="photo-container">
                        <img src="${imageData}" class="msg-image" onclick="openImageViewer(this.src)">
                        <button class="photo-delete" onclick="deletePhotoMsg('${msgId}')">
                            <span class="icon"><svg><use href="#icon-x"/></svg></span>
                        </button>
                    </div>
                    <div class="photo-actions-inline">
                        <button class="photo-action-btn" onclick="extractFromPhoto('${msgId}', '${panel}')">
                            <span class="icon"><svg><use href="#icon-search"/></svg></span>
                            Extraire
                        </button>
                        <button class="${reportBtnClass}" onclick="addPhotoToReport('${msgId}', '${panel}')" ${reportBtnDisabled}>
                            ${reportBtnContent}
                        </button>
                    </div>
                </div>
            `;
        }
        
        // Delete photo message
        function deletePhotoMsg(msgId) {
            const msg = document.getElementById(msgId);
            if (msg) {
                msg.remove();
                toast('Photo supprime');
            }
        }
        
        // 
        // EXTRACTION OCR - Claude Vision (principal) + Tesseract.js (fallback)
        // 
        const OCR_WEBHOOK_URL = 'https://cherhabil.app.n8n.cloud/webhook/fixair-ocr';
        
        async function extractFromPhoto(msgId, panel) {
            const msg = document.getElementById(msgId);
            if (!msg) return;
            
            const imageData = msg.dataset.imageData;
            if (!imageData) {
                toast('Erreur: image non trouve');
                return;
            }
            
            // Disable button
            const extractBtn = msg.querySelector('.photo-action-btn:first-child');
            if (extractBtn) {
                extractBtn.disabled = true;
                extractBtn.innerHTML = '<span class="icon"><svg><use href="#icon-search"/></svg></span> Analyse...';
            }
            
            toast('Analyse de l\'image...');
            
            // Add linked photo quote in chat
            const quoteId = 'ocr-' + Date.now();
            addOCRQuoteMessage(panel, msgId, imageData, quoteId);
            
            let extractedText = '';
            let ocrMethod = '';
            
            try {
                // 
                // MTHODE 1: CLAUDE VISION (haute qualit)
                // 
                console.log(' Tentative Claude Vision...');
                
                try {
                    const visionResponse = await fetch(OCR_WEBHOOK_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            image: imageData,
                            brand: brand || 'general'
                        })
                    });
                    
                    if (visionResponse.ok) {
                        const visionResult = await visionResponse.json();
                        const visionText = visionResult.output || visionResult.response || visionResult.text || '';
                        
                        // Vrifier que c'est une vraie extraction (pas une erreur)
                        if (visionText && 
                            visionText.length > 30 &&
                            !visionText.includes('Je suis prt') &&
                            !visionText.includes('Envoie-moi')) {
                            extractedText = visionText;
                            ocrMethod = 'vision';
                            console.log(' Claude Vision russi:', extractedText.length, 'caractres');
                        }
                    }
                } catch (visionErr) {
                    console.log(' Claude Vision non disponible:', visionErr.message);
                }
                
                // 
                // MTHODE 2: TESSERACT.JS (fallback)
                // 
                if (!extractedText && typeof Tesseract !== 'undefined') {
                    console.log(' Fallback Tesseract.js...');
                    
                    if (extractBtn) {
                        extractBtn.innerHTML = '<span class="icon"><svg><use href="#icon-search"/></svg></span> OCR...';
                    }
                    
                    const worker = await Tesseract.createWorker('fra+eng', 1, {
                        logger: m => {
                            if (m.status === 'recognizing text' && extractBtn) {
                                const progress = Math.round(m.progress * 100);
                                extractBtn.innerHTML = `<span class="icon"><svg><use href="#icon-search"/></svg></span> ${progress}%`;
                            }
                        }
                    });
                    
                    const { data } = await worker.recognize(imageData);
                    await worker.terminate();
                    
                    if (data.text && data.text.trim().length > 5) {
                        extractedText = data.text.trim();
                        ocrMethod = 'tesseract';
                        console.log(' Tesseract russi:', extractedText.length, 'caractres');
                    }
                }
                
                // 
                // SI AUCUN TEXTE EXTRAIT
                // 
                if (!extractedText || extractedText.length < 10) {
                    updateOCRQuoteWithResults(quoteId, `
                        <div class="ocr-no-text">
                            <div style="font-size:24px;margin-bottom:8px;"></div>
                            <div>Aucun texte dtect sur cette image.</div>
                            <small style="color:var(--text-dim);">Essayez avec une photo plus nette.</small>
                        </div>
                    `);
                    
                    if (extractBtn) {
                        extractBtn.disabled = false;
                        extractBtn.innerHTML = '<span class="icon"><svg><use href="#icon-search"/></svg></span> Extraire';
                    }
                    toast('Aucun texte dtect');
                    return;
                }
                
                // 
                // CONSTRUIRE L'AFFICHAGE (Card UI)
                // 
                console.log(' Construction de l\'affichage...');
                
                // Parser le texte pour infos structures (si Tesseract)
                const structuredInfo = parseOCRForStructuredInfo(extractedText);
                const rawTextId = 'raw-' + quoteId;
                
                let finalHtml = `<div class="ocr-card">`;
                
                //  HEADER 
                finalHtml += `
                    <div class="ocr-card-header">
                        <span class="icon"><svg><use href="#icon-camera"/></svg></span>
                        <span class="ocr-card-header-title">Extraction d'image</span>
                        <span class="ocr-card-header-method">${ocrMethod === 'vision' ? ' IA Vision' : ' OCR'}</span>
                    </div>
                `;
                
                //  AI SUMMARY (contenu principal) 
                finalHtml += `<div class="ocr-ai-summary">`;
                if (ocrMethod === 'vision') {
                    // Claude Vision retourne du texte format - afficher directement
                    finalHtml += parseMarkdown(extractedText);
                } else {
                    // Tesseract - afficher rsum simple
                    const wordCount = extractedText.split(/\\s+/).filter(w => w.length > 0).length;
                    finalHtml += `<p><strong>${wordCount} mots</strong> extraits de l'image.</p>`;
                    if (structuredInfo.hasData) {
                        if (structuredInfo.brand) finalHtml += `<p><strong>Marque:</strong> ${structuredInfo.brand}</p>`;
                        if (structuredInfo.model) finalHtml += `<p><strong>Modle:</strong> ${structuredInfo.model}</p>`;
                        if (structuredInfo.errorCodes.length > 0) finalHtml += `<p><strong>Code erreur:</strong> <span style="color:var(--hotline)">${structuredInfo.errorCodes.join(', ')}</span></p>`;
                    }
                }
                finalHtml += `</div>`;
                
                //  RAW TEXT (collapsible, scrollable) 
                if (ocrMethod !== 'vision') {
                    finalHtml += `
                        <div class="ocr-raw-section">
                            <button class="ocr-raw-toggle" onclick="toggleRawText('${rawTextId}', this)">
                                <span> Voir le texte brut</span>
                                <span class="chevron"></span>
                            </button>
                            <div id="${rawTextId}" class="ocr-raw-content">${escapeHtml(extractedText)}</div>
                        </div>
                    `;
                }
                
                //  ACTION BUTTONS 
                finalHtml += `<div class="ocr-card-actions">`;
                
                if (structuredInfo.errorCodes.length > 0) {
                    finalHtml += `
                        <button class="ocr-action-btn error-btn" onclick="explainErrorCode('${structuredInfo.errorCodes[0]}', '${panel}')">
                            <span class="icon"><svg><use href="#icon-zap"/></svg></span>
                            Expliquer ${structuredInfo.errorCodes[0]}
                        </button>
                    `;
                }
                
                if (ocrMethod !== 'vision') {
                    finalHtml += `
                        <button class="ocr-action-btn" onclick="analyzeTextWithAI('${quoteId}', '${panel}')">
                            <span class="icon"><svg><use href="#icon-cpu"/></svg></span>
                            Analyser
                        </button>
                    `;
                }
                
                finalHtml += `
                    <button class="ocr-action-btn" onclick="copyOCRText('${quoteId}')">
                        <span class="icon"><svg><use href="#icon-copy"/></svg></span>
                        Copier
                    </button>
                </div>`;
                
                finalHtml += `</div>`; // Close ocr-card
                
                // Afficher
                updateOCRQuoteWithResults(quoteId, finalHtml);
                
                // 
                // SAUVEGARDER EN BASE DE DONNES
                // 
                
                // Ajouter au contexte IA
                chatHistory[panel].push({ 
                    role: 'assistant', 
                    content: `[EXTRACTION PHOTO]\n${extractedText}`
                });
                
                // Sauvegarder en base avec HTML pour rechargement
                if (currentProjectId && currentChatId[panel]) {
                    await saveMessage(currentChatId[panel], 'assistant', JSON.stringify({
                        type: 'ocr_result',
                        method: ocrMethod,
                        text: extractedText,
                        structuredInfo: structuredInfo,
                        htmlContent: finalHtml,
                        sourcePhotoId: msgId
                    }), 'ocr');
                    console.log(' OCR sauvegard en base');
                }
                
                // Succs
                if (extractBtn) {
                    extractBtn.disabled = false;
                    extractBtn.innerHTML = '<span class="icon"><svg><use href="#icon-check"/></svg></span> Extrait';
                    extractBtn.classList.add('success');
                }
                
                //  GAMIFICATION: Track OCR extraction 
                trackAction('ocr');
                
                toast('Extraction termine');
                scrollToBottom(panel);
                
            } catch (error) {
                console.error(' Erreur OCR:', error);
                
                updateOCRQuoteWithResults(quoteId, `
                    <div style="color:var(--hotline);padding:12px;">
                        Erreur: ${error.message}
                    </div>
                `);
                
                if (extractBtn) {
                    extractBtn.disabled = false;
                    extractBtn.innerHTML = '<span class="icon"><svg><use href="#icon-search"/></svg></span> Extraire';
                }
                
                toast('Erreur extraction');
            }
        }
        
        // Add OCR quote message with linked thumbnail
        function addOCRQuoteMessage(panel, originalMsgId, imageData, quoteId) {
            const container = document.getElementById(panel + 'Body');
            if (!container) return;
            
            const msgDiv = document.createElement('div');
            msgDiv.className = 'msg ai';
            msgDiv.id = quoteId;
            msgDiv.dataset.sourcePhotoId = originalMsgId;
            msgDiv.dataset.contentType = 'ocr';
            
            // Use thumbnail version of image for quote
            const thumbSrc = imageData;
            
            msgDiv.innerHTML = `
                <div class="msg-text">
                    <div class="ocr-quote" onclick="scrollToMessage('${originalMsgId}')">
                        <img src="${thumbSrc}" class="ocr-quote-thumb" alt="Photo analyse">
                        <div class="ocr-quote-label"> Analyse de cette photo</div>
                    </div>
                    <div class="ocr-result">
                        <div class="ocr-loading">
                            <span class="ocr-spinner"></span>
                            Extraction du texte en cours...
                        </div>
                    </div>
                </div>
            `;
            
            container.appendChild(msgDiv);
            scrollToBottom(panel);
        }
        
        // Update OCR quote with results
        function updateOCRQuoteWithResults(quoteId, htmlContent) {
            const quoteMsg = document.getElementById(quoteId);
            if (!quoteMsg) return;
            
            const resultDiv = quoteMsg.querySelector('.ocr-result');
            if (!resultDiv) return;
            
            resultDiv.innerHTML = htmlContent;
        }
        
        // Format OCR response text into HTML (fallback when htmlContent not saved)
        function formatOCRResponse(text) {
            if (!text) return '<span style="color:var(--text-dim);">Aucun texte extrait</span>';
            
            // Parse for structured info
            const structuredInfo = parseOCRForStructuredInfo(text);
            const rawTextId = 'raw-loaded-' + Date.now();
            const wordCount = text.split(/\s+/).filter(w => w.length > 0).length;
            
            let html = `<div class="ocr-card">`;
            
            // Header
            html += `
                <div class="ocr-card-header">
                    <span class="icon"><svg><use href="#icon-camera"/></svg></span>
                    <span class="ocr-card-header-title">Extraction d'image</span>
                    <span class="ocr-card-header-method"> OCR</span>
                </div>
            `;
            
            // Summary
            html += `<div class="ocr-ai-summary">`;
            html += `<p><strong>${wordCount} mots</strong> extraits.</p>`;
            if (structuredInfo.hasData) {
                if (structuredInfo.brand) html += `<p><strong>Marque:</strong> ${structuredInfo.brand}</p>`;
                if (structuredInfo.model) html += `<p><strong>Modle:</strong> ${structuredInfo.model}</p>`;
                if (structuredInfo.errorCodes.length > 0) html += `<p><strong>Code erreur:</strong> <span style="color:var(--hotline)">${structuredInfo.errorCodes.join(', ')}</span></p>`;
            }
            html += `</div>`;
            
            // Collapsible raw text
            html += `
                <div class="ocr-raw-section">
                    <button class="ocr-raw-toggle" onclick="toggleRawText('${rawTextId}', this)">
                        <span> Voir le texte brut</span>
                        <span class="chevron"></span>
                    </button>
                    <div id="${rawTextId}" class="ocr-raw-content">${escapeHtml(text)}</div>
                </div>
            `;
            
            html += `</div>`; // Close card
            
            return html;
        }
        
        // Render saved OCR message from database
        function renderOCRMessage(panel, ocrData, sourceImageData) {
            const container = document.getElementById(panel + 'Body');
            if (!container) return;
            
            const quoteId = 'ocr-saved-' + Date.now() + '-' + Math.random().toString(36).substr(2, 5);
            const msgDiv = document.createElement('div');
            msgDiv.className = 'msg ai';
            msgDiv.id = quoteId;
            msgDiv.dataset.contentType = 'ocr';
            
            // Find the source photo for linking
            const sourcePhotoId = ocrData.sourcePhotoId || '';
            
            msgDiv.innerHTML = `
                <div class="msg-text">
                    ${sourceImageData ? `
                    <div class="ocr-quote" onclick="scrollToMessage('${sourcePhotoId}')">
                        <img src="${sourceImageData}" class="ocr-quote-thumb" alt="Photo analyse">
                        <div class="ocr-quote-label"> Analyse de cette photo</div>
                    </div>
                    ` : ''}
                    <div class="ocr-result">
                        ${ocrData.htmlContent || formatOCRResponse(ocrData.result)}
                    </div>
                </div>
            `;
            
            container.appendChild(msgDiv);
        }
        
        // Analyze OCR text for HVAC-relevant patterns
        // Find source image data from messages array
        function findSourceImage(messages, sourcePhotoId) {
            // Look for the most recent image message that could be the source
            for (let i = messages.length - 1; i >= 0; i--) {
                const msg = messages[i];
                if (msg.content_type === 'image' && msg.content.startsWith('data:image')) {
                    return msg.content;
                }
            }
            return null;
        }
        
        // Parse OCR text for structured information
        // Nettoyer le texte OCR brut
        function cleanOCRText(text) {
            if (!text) return '';
            
            return text
                // Supprimer les caractres de contrle
                .replace(/[\x00-\x08\x0B\x0C\x0E-\x1F]/g, '')
                // Normaliser les espaces
                .replace(/[ \t]+/g, ' ')
                // Supprimer les lignes vides multiples
                .replace(/\n\s*\n\s*\n/g, '\n\n')
                // Supprimer les espaces en dbut/fin de ligne
                .split('\n').map(l => l.trim()).join('\n')
                // Trim global
                .trim();
        }
        
        function parseOCRForStructuredInfo(text) {
            const upperText = text.toUpperCase();
            const result = {
                brand: null,
                model: null,
                serial: null,
                errorCodes: [],
                power: null,
                voltage: null,
                refrigerant: null,
                hasData: false
            };
            
            // Known brands
            const brands = {
                'MITSUBISHI': 'Mitsubishi Electric',
                'DAIKIN': 'Daikin',
                'CARRIER': 'Carrier',
                'TRANE': 'Trane',
                'LENNOX': 'Lennox',
                'YORK': 'York',
                'LG': 'LG',
                'SAMSUNG': 'Samsung',
                'PANASONIC': 'Panasonic',
                'TOSHIBA': 'Toshiba',
                'FUJITSU': 'Fujitsu',
                'HITACHI': 'Hitachi',
                'MIDEA': 'Midea',
                'GREE': 'Gree',
                'ATLANTIC': 'Atlantic',
                'BOSCH': 'Bosch',
                'VIESSMANN': 'Viessmann'
            };
            
            for (const [key, value] of Object.entries(brands)) {
                if (upperText.includes(key)) {
                    result.brand = value;
                    result.hasData = true;
                    break;
                }
            }
            
            // Model patterns
            const modelPatterns = [
                /MOD[E]LE\s*[:#]?\s*([A-Z0-9\-\/]+)/i,
                /MODEL\s*[:#]?\s*([A-Z0-9\-\/]+)/i,
                /TYPE\s*[:#]?\s*([A-Z0-9\-\/]+)/i,
                /(PUHY|PURY|PEFY|PLFY|PKFY|PEAD|FDUM|RXS|FTX|FAA|FBA|FTXM|RXM)[A-Z0-9\-\/]+/i
            ];
            
            for (const pattern of modelPatterns) {
                const match = text.match(pattern);
                if (match && match[1] && match[1].length > 3) {
                    result.model = match[1].toUpperCase();
                    result.hasData = true;
                    break;
                }
            }
            
            // Serial number
            const serialPatterns = [
                /S[E]RIE\s*[:#]?\s*([A-Z0-9]+)/i,
                /SERIAL\s*[:#]?\s*([A-Z0-9]+)/i,
                /S\/?N\s*[:#]?\s*([A-Z0-9]+)/i,
                /N[]?\s*[:#]?\s*([A-Z][0-9]{6,12})/i
            ];
            
            for (const pattern of serialPatterns) {
                const match = text.match(pattern);
                if (match && match[1] && match[1].length >= 6) {
                    result.serial = match[1].toUpperCase();
                    result.hasData = true;
                    break;
                }
            }
            
            // Error codes (very important)
            const errorPatterns = [
                /(?:ERREUR|ERROR|CODE|FAULT|D[E]FAUT|ALARME)\s*[:#]?\s*([A-Z]?[0-9]{1,4})/gi,
                /\b([EUFPLAH][0-9]{1,3})\b/g,
                /\b(E[0-9]{1,2})\b/g,
                /\b(F[0-9]{1,2})\b/g,
                /\b(A[0-9]{1,3})\b/g
            ];
            
            const errorSet = new Set();
            for (const pattern of errorPatterns) {
                let match;
                while ((match = pattern.exec(upperText)) !== null) {
                    if (match[1] && match[1].length >= 2 && match[1].length <= 5) {
                        errorSet.add(match[1]);
                    }
                }
            }
            result.errorCodes = Array.from(errorSet);
            if (result.errorCodes.length > 0) result.hasData = true;
            
            // Power
            const powerMatch = text.match(/(\d+(?:[.,]\d+)?)\s*(?:kW|KW|BTU|CV)/i);
            if (powerMatch) {
                result.power = powerMatch[0];
                result.hasData = true;
            }
            
            // Voltage
            const voltageMatch = text.match(/(\d{2,3})\s*V(?:olts?)?/i);
            if (voltageMatch) {
                result.voltage = voltageMatch[0];
                result.hasData = true;
            }
            
            // Refrigerant
            const refrigerantMatch = text.match(/R[- ]?(410A|32|134a|407C|404A|22)/i);
            if (refrigerantMatch) {
                result.refrigerant = 'R' + refrigerantMatch[1].toUpperCase();
                result.hasData = true;
            }
            
            return result;
        }
        
        // Explain error code - sends to AI
        async function explainErrorCode(code, panel) {
            const message = `Explique-moi le code erreur ${code}. Quelles sont les causes possibles et comment le rsoudre ?`;
            
            // Add to input and send
            const input = document.getElementById(panel + 'Input');
            if (input) {
                input.value = message;
                sendMsg(panel);
            }
        }
        
        // Analyser le texte extrait avec l'IA
        async function analyzeTextWithAI(quoteId, panel) {
            const quoteMsg = document.getElementById(quoteId);
            if (!quoteMsg) return;
            
            // Trouver le texte (essayer plusieurs classes)
            const textDiv = quoteMsg.querySelector('.ocr-raw-content') || 
                            quoteMsg.querySelector('.ocr-raw-text') ||
                            quoteMsg.querySelector('.ocr-ai-summary') ||
                            quoteMsg.querySelector('.ocr-structured-content');
            
            if (!textDiv) {
                toast('Texte non trouv');
                return;
            }
            
            const rawText = textDiv.innerText || textDiv.textContent;
            
            if (!rawText || rawText.length < 10) {
                toast('Pas assez de texte  analyser');
                return;
            }
            
            // Envoyer le texte  l'IA pour analyse
            const message = `Voici du texte que j'ai extrait d'une photo. Peux-tu l'analyser et me donner les informations importantes ?\n\n${rawText}`;
            
            const input = document.getElementById(panel + 'Input');
            if (input) {
                input.value = message;
                sendMsg(panel);
            }
        }
        
        // Toggle raw text visibility in OCR card
        function toggleRawText(rawTextId, button) {
            const rawContent = document.getElementById(rawTextId);
            if (!rawContent) return;
            
            rawContent.classList.toggle('show');
            button.classList.toggle('open');
            
            // Update button text
            const span = button.querySelector('span:first-child');
            if (span) {
                span.textContent = rawContent.classList.contains('show') ? ' Masquer le texte brut' : ' Voir le texte brut';
            }
        }
        
        // Copier le texte OCR dans le presse-papier
        function copyOCRText(quoteId) {
            const quoteMsg = document.getElementById(quoteId);
            if (!quoteMsg) {
                toast('Message non trouv');
                return;
            }
            
            // Trouver le texte (essayer plusieurs classes)
            const rawTextDiv = quoteMsg.querySelector('.ocr-raw-content') || 
                               quoteMsg.querySelector('.ocr-raw-text') ||
                               quoteMsg.querySelector('.ocr-ai-summary');
            if (!rawTextDiv) {
                toast('Texte non trouv');
                return;
            }
            
            const text = rawTextDiv.innerText || rawTextDiv.textContent;
            
            // Copier dans le presse-papier
            navigator.clipboard.writeText(text).then(() => {
                toast('Texte copi !');
            }).catch(err => {
                console.error('Copy error:', err);
                toast('Erreur de copie');
            });
        }
        
        function scrollToMessage(msgId) {
            const msg = document.getElementById(msgId);
            if (msg) {
                msg.scrollIntoView({ behavior: 'smooth', block: 'center' });
                // Highlight briefly
                msg.style.transition = 'background 0.3s';
                msg.style.background = 'rgba(255,107,53,0.15)';
                setTimeout(() => {
                    msg.style.background = '';
                }, 1500);
            }
        }
        
        // Add photo to report - opens naming modal
        let pendingReportPhoto = null;
        
        function addPhotoToReport(msgId, panel) {
            const msg = document.getElementById(msgId);
            if (!msg) return;
            
            const imageData = msg.dataset.imageData;
            
            // Check if this photo was already added to report
            const existingIndex = window.reportPhotos?.findIndex(p => 
                p.url === imageData || p.data === imageData || p.originalData === imageData
            );
            const existingPhoto = existingIndex >= 0 ? window.reportPhotos[existingIndex] : null;
            
            // Store pending data
            pendingReportPhoto = {
                msgId: msgId,
                panel: panel,
                imageData: imageData,
                existingIndex: existingIndex,
                existingPhoto: existingPhoto
            };
            
            // Show naming modal
            const modal = document.getElementById('photoNameModal');
            const previewImg = document.getElementById('photoNamePreviewImg');
            const input = document.getElementById('photoNameInput');
            const confirmBtn = modal.querySelector('.photo-name-confirm');
            
            previewImg.src = imageData;
            
            // If already added, prefill with existing caption
            if (existingPhoto) {
                input.value = existingPhoto.caption || '';
                confirmBtn.textContent = 'Modifier';
            } else {
                input.value = '';
                confirmBtn.textContent = 'Ajouter au rapport';
            }
            
            modal.classList.add('active');
            
            // Focus input after animation
            setTimeout(() => input.focus(), 100);
        }
        
        function closePhotoNameModal() {
            document.getElementById('photoNameModal').classList.remove('active');
            pendingReportPhoto = null;
        }
        
        async function confirmAddToReport() {
            if (!pendingReportPhoto) return;
            
            const caption = document.getElementById('photoNameInput').value.trim() || 'Photo';
            const { msgId, panel, imageData, existingIndex, existingPhoto } = pendingReportPhoto;
            const isUpdate = existingIndex >= 0;
            
            closePhotoNameModal();
            toast(isUpdate ? 'Mise  jour...' : 'Sauvegarde en cours...');
            
            try {
                let photoUrl = imageData; // Fallback to base64
                
                // Upload to Supabase Storage if we have a project and not already uploaded
                if (currentProjectId && !existingPhoto?.url?.startsWith('http')) {
                    const uploadResult = await uploadPhotoToStorage(imageData, currentProjectId);
                    if (uploadResult) {
                        photoUrl = uploadResult;
                    }
                } else if (existingPhoto?.url) {
                    photoUrl = existingPhoto.url;
                }
                
                // Update or add to report
                if (!window.reportPhotos) window.reportPhotos = [];
                
                const photoEntry = {
                    url: photoUrl,
                    originalData: imageData, // Keep original for matching
                    caption: caption,
                    timestamp: new Date().toISOString(),
                    panel: panel
                };
                
                if (isUpdate) {
                    window.reportPhotos[existingIndex] = photoEntry;
                } else {
                    window.reportPhotos.push(photoEntry);
                }
                
                // Also save to project in database
                if (currentProjectId) {
                    await savePhotoToProject(currentProjectId, photoUrl, caption);
                }
                
                // Visual feedback - but don't disable button (allow re-editing)
                const msg = document.getElementById(msgId);
                if (msg) {
                    const reportBtn = msg.querySelector('.photo-action-btn:last-child');
                    if (reportBtn) {
                        reportBtn.innerHTML = '<span class="icon"><svg><use href="#icon-check"/></svg></span> Ajout';
                        reportBtn.classList.add('success');
                        // Don't disable - allow clicking again to edit caption
                    }
                }
                
                toast(isUpdate ? 'Photo modifie: "' + caption + '"' : 'Photo "' + caption + '" ajoute au rapport');
                
            } catch (error) {
                console.error('Error saving photo:', error);
                toast('Erreur sauvegarde photo');
            }
        }
        
        // Upload photo to Supabase Storage
        async function uploadPhotoToStorage(base64Data, projectId) {
            try {
                // Convert base64 to blob
                const base64Response = await fetch(base64Data);
                const blob = await base64Response.blob();
                
                // Generate unique filename
                const timestamp = Date.now();
                const filename = `${projectId}/${timestamp}.jpg`;
                
                // Upload to Supabase Storage
                const { data, error } = await db.storage
                    .from('project-photos')
                    .upload(filename, blob, {
                        contentType: 'image/jpeg',
                        upsert: false
                    });
                
                if (error) {
                    console.error('Storage upload error:', error);
                    return null;
                }
                
                // Get public URL
                const { data: urlData } = db.storage
                    .from('project-photos')
                    .getPublicUrl(filename);
                
                console.log('Photo uploaded:', urlData.publicUrl);
                return urlData.publicUrl;
                
            } catch (error) {
                console.error('Upload error:', error);
                return null;
            }
        }
        
        // Save photo reference to project
        async function savePhotoToProject(projectId, photoUrl, caption) {
            try {
                // Get current photos from project
                const { data: project } = await db
                    .from('projects')
                    .select('photos')
                    .eq('id', projectId)
                    .single();
                
                const existingPhotos = project?.photos || [];
                
                // Add new photo
                const updatedPhotos = [...existingPhotos, {
                    url: photoUrl,
                    caption: caption,
                    timestamp: new Date().toISOString()
                }];
                
                // Update project
                await db
                    .from('projects')
                    .update({ photos: updatedPhotos })
                    .eq('id', projectId);
                
                console.log('Photo saved to project:', projectId);
                
            } catch (error) {
                console.error('Error saving photo to project:', error);
            }
        }
        
        // Mock OCR function (will be replaced with real OCR)
        // Image viewer
        function openImageViewer(imageSrc) {
            const viewer = document.getElementById('imageViewer');
            const img = document.getElementById('imageViewerImg');
            img.src = imageSrc;
            viewer.classList.add('active');
        }
        
        function closeImageViewer() {
            document.getElementById('imageViewer').classList.remove('active');
        }
        function handlePhotoOption() {}
        // 
        // END PHOTO CAPTURE
        // 

        function openHotline() {
            document.getElementById('hotlineView').classList.add('active');
            resetHotline();
        }

        function closeHotline() {
            document.getElementById('hotlineView').classList.remove('active');
            if(isConnected) disconnectHotline();
            resetHotline();
        }

        function resetHotline() {
            isConnected = false;
            isConnecting = false;
            isDisconnecting = false;
            chatOpen = false;
            document.getElementById('pulseSphere').classList.remove('connected','connecting','disconnecting');
            document.getElementById('hotlineWidget').classList.remove('chat-mode');
            document.getElementById('hotlineChat').classList.remove('visible');
            document.getElementById('toggleChat').classList.remove('visible','open');
            document.getElementById('widgetLabel').textContent = 'Hotline';
            document.getElementById('widgetSublabel').textContent = 'Appuyez pour parler';
            document.getElementById('toggleText').textContent = 'Afficher';
        }

        function toggleHotline() {
            if(isConnecting || isDisconnecting) return;
            if(isConnected) disconnectHotline();
            else connectHotline();
        }

        function connectHotline() {
            if(isConnecting || isConnected) return;
            isConnecting = true;
            document.getElementById('pulseSphere').classList.add('connecting');
            document.getElementById('widgetSublabel').textContent = 'Connexion...';
            if(navigator.vibrate) navigator.vibrate(200);

            setTimeout(() => {
                isConnecting = false;
                isConnected = true;
                document.getElementById('pulseSphere').classList.remove('connecting');
                document.getElementById('pulseSphere').classList.add('connected');
                document.getElementById('widgetSublabel').textContent = 'Appuyez pour terminer';
                document.getElementById('toggleChat').classList.add('visible');

                setTimeout(() => {
                    if(!chatOpen) toggleChatView();
                    setTimeout(() => {
                        addHotlineMessage('Bonjour ! Je suis l\'assistant ' + names[brand] + '. Comment puis-je vous aider ?', 'ai');
                    }, 500);
                }, 800);
            }, 2500);
        }

        function disconnectHotline() {
            if(!isConnected || isDisconnecting) return;
            isDisconnecting = true;
            isConnected = false;
            document.getElementById('pulseSphere').classList.remove('connected');
            document.getElementById('pulseSphere').classList.add('disconnecting');
            document.getElementById('widgetSublabel').textContent = 'Fin...';

            setTimeout(() => {
                isDisconnecting = false;
                document.getElementById('pulseSphere').classList.remove('disconnecting');
                document.getElementById('widgetSublabel').textContent = 'Appuyez pour parler';
                if(chatOpen) {
                    document.getElementById('hotlineChat').classList.remove('visible');
                    document.getElementById('toggleChat').classList.remove('open');
                    document.getElementById('toggleText').textContent = 'Afficher';
                    chatOpen = false;
                }
                document.getElementById('hotlineWidget').classList.remove('chat-mode');
            }, 2500);
        }

        function toggleChatView() {
            chatOpen = !chatOpen;
            if(chatOpen) {
                document.getElementById('hotlineChat').classList.add('visible');
                document.getElementById('toggleChat').classList.add('open');
                document.getElementById('toggleText').textContent = 'Masquer';
                document.getElementById('hotlineWidget').classList.add('chat-mode');
            } else {
                document.getElementById('hotlineChat').classList.remove('visible');
                document.getElementById('toggleChat').classList.remove('open');
                document.getElementById('toggleText').textContent = 'Afficher';
                document.getElementById('hotlineWidget').classList.remove('chat-mode');
            }
        }

        function addHotlineMessage(text, sender) {
            const empty = document.getElementById('chatEmpty');
            if(empty) empty.style.display = 'none';
            
            const wrapper = document.getElementById('messagesWrapper');
            const msg = document.createElement('div');
            msg.className = 'hotline-msg ' + sender;
            const now = new Date();
            const time = now.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
            const label = sender === 'user' ? 'Vous' : names[brand];
            msg.innerHTML = `<span class="msg-label">${label}</span><div class="msg-bubble">${text}</div><span class="msg-time">${time}</span>`;
            wrapper.appendChild(msg);
            document.getElementById('hotlineChatMessages').scrollTop = document.getElementById('hotlineChatMessages').scrollHeight;
        }

        let toastTimeout = null;
        function toast(m) {
            const t = document.getElementById('toast');
            t.textContent = m;
            t.classList.add('show');
            if (toastTimeout) clearTimeout(toastTimeout);
            toastTimeout = setTimeout(() => {
                t.classList.remove('show');
                toastTimeout = null;
            }, 2000);
        }

        const divider = document.getElementById('divider');
        const pC = document.getElementById('panelCopilot');
        const pA = document.getElementById('panelAssistant');
        let isDrag = false;

        divider.addEventListener('mousedown', startDrag);
        divider.addEventListener('touchstart', startDrag, {passive: false});

        function startDrag(e) {
            if(!isSplit) return;
            isDrag = true;
            divider.classList.add('dragging');
            document.body.style.cursor = window.innerWidth > 767 ? 'col-resize' : 'row-resize';
            document.body.style.userSelect = 'none';
            e.preventDefault();
        }

        document.addEventListener('mousemove', drag);
        document.addEventListener('touchmove', drag, {passive: false});

        function drag(e) {
            if(!isDrag) return;
            e.preventDefault();
            const cv = document.getElementById('chatView');
            const rect = cv.getBoundingClientRect();
            const isHorizontal = window.innerWidth > 767;
            
            let pos, size, offset, pct;
            
            if (isHorizontal) {
                // Desktop: horizontal split
                pos = e.touches ? e.touches[0].clientX : e.clientX;
                size = rect.width;
                offset = pos - rect.left;
            } else {
                // Mobile: vertical split
                pos = e.touches ? e.touches[0].clientY : e.clientY;
                size = rect.height;
                offset = pos - rect.top;
            }
            
            pct = Math.max(25, Math.min(75, (offset / size) * 100));
            pC.style.flexBasis = pct + '%';
            pA.style.flexBasis = (100 - pct) + '%';
        }

        document.addEventListener('mouseup', stopDrag);
        document.addEventListener('touchend', stopDrag);

        function stopDrag() {
            if(!isDrag) return;
            isDrag = false;
            divider.classList.remove('dragging');
            document.body.style.cursor = '';
            document.body.style.userSelect = '';
        }

        let touchX = 0;
        document.addEventListener('touchstart', e => { touchX = e.touches[0].clientX; });
        document.addEventListener('touchend', e => {
            if(!document.getElementById('chatView').classList.contains('active') || isSplit || isDrag) return;
            const diff = e.changedTouches[0].clientX - touchX;
            if(Math.abs(diff) > 80) {
                if(diff > 0 && mode === 'assistant') switchMode('copilot');
                else if(diff < 0 && mode === 'copilot') switchMode('assistant');
            }
        });

        document.addEventListener('click', e => {
            if(!e.target.closest('.plus-btn') && !e.target.closest('.attach-menu')) {
                closeAllAttach();
            }
            if(!e.target.closest('.brand-pill')) {
                closeBrandDropdown();
            }
        });

        // Reset split view on resize to prevent layout issues
        window.addEventListener('resize', () => {
            if (isSplit) {
                document.getElementById('panelCopilot').style.flexBasis = '50%';
                document.getElementById('panelAssistant').style.flexBasis = '50%';
            }
        });

        // Safari keyboard fix - scroll input into view on focus
        function handleInputFocus(e) {
            const input = e.target;
            setTimeout(() => {
                input.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }, 300);
        }
        
        // Apply to all login inputs
        document.querySelectorAll('.login-input').forEach(input => {
            input.addEventListener('focus', handleInputFocus);
        });
        
        // Apply to chat inputs
        document.querySelectorAll('.input-text').forEach(input => {
            input.addEventListener('focus', handleInputFocus);
        });

        // Additional viewport listeners for orientation and visualViewport
        window.addEventListener('orientationchange', () => {
            setTimeout(setViewportHeight, 100);
        });
        if (window.visualViewport) {
            window.visualViewport.addEventListener('resize', setViewportHeight);
        }
        
        // 
        // GAMIFICATION - REALISTIC ECONOMIC MODEL
        // 
        // Base: Technician hourly rate = 100/h (400/half-day  4h)
        // Report traditional cost: 45min direct + 15min corrections + stress = ~120
        // 
        
        const GAMIFICATION_CONFIG = {
            hourlyRate: 100, // /hour base rate
            actions: {
                // Report: Saves ~1h of work (writing + corrections + back-and-forth)
                report: { minutes: 60, euros: 100.00, description: "Rapport professionnel gnr" },
                // OCR: Saves ~10min of manual data entry
                ocr: { minutes: 10, euros: 15.00, description: "Analyse photo/plaque" },
                // Photo: Quick capture vs manual notes
                photo: { minutes: 5, euros: 8.00, description: "Photo documente" },
                // Voice note: Saves typing time
                voice: { minutes: 4, euros: 6.00, description: "Note vocale transcrite" },
                // Copilot active usage (per 10 min session)
                copilot_session: { minutes: 15, euros: 25.00, description: "Session diagnostic Copilot" }
                // NOTE: Messages are NOT tracked - only real value actions
            },
            messages: [
                { threshold: 0, text: "Lance-toi", emoji: "" },
                { threshold: 30, text: "Bien jou, continue", emoji: "" },
                { threshold: 80, text: "Tu progresses bien", emoji: "" },
                { threshold: 150, text: "Efficace", emoji: "", greenEmoji: true },
                { threshold: 250, text: "Impressionnant", emoji: "" },
                { threshold: 400, text: "Machine de guerre", emoji: "" },
                { threshold: 600, text: "Expert FixAIR", emoji: "" }
            ],
            weeklyGoal: 300, //  realistic weekly goal (3 reports + usage)
            tooltips: {
                euros: "Estimation base sur votre tarif horaire (~100/h) et le temps conomis vs mthodes traditionnelles (rdaction manuelle, corrections, stress...)",
                time: "Temps total conomis cette semaine grce  FixAIR vs travail manuel",
                reports: "Rapports professionnels gnrs automatiquement, prts  envoyer"
            }
        };
        
        // Track action to database
        async function trackAction(actionType, projectId = null) {
            // Ensure we have user ID
            const userId = await getCurrentUserId();
            if (!userId || userId.startsWith('demo-')) {
                console.log(' No valid user ID, skipping track');
                return;
            }
            
            const config = GAMIFICATION_CONFIG.actions[actionType];
            if (!config) {
                console.warn('Action type inconnu:', actionType);
                return;
            }
            
            // NOTE: Don't update lastKnownStats here - let the homepage comparison work
            
            try {
                const { error } = await db.from('user_actions').insert({
                    user_id: userId,
                    action_type: actionType,
                    minutes_saved: config.minutes,
                    euros_saved: config.euros,
                    project_id: projectId || currentProjectId
                });
                
                if (error) {
                    // Si table n'existe pas encore, ignorer silencieusement
                    if (error.code === '42P01') {
                        console.log(' Table user_actions pas encore cre');
                        return;
                    }
                    throw error;
                }
                
                console.log(` Action tracke: ${actionType} (+${config.minutes}min, +${config.euros})`);
                
                // Don't refresh stats here - let homepage celebration handle it
                
            } catch (err) {
                console.error('Erreur tracking action:', err);
            }
        }
        
        // Get Monday of current week
        function getWeekStart() {
            const now = new Date();
            const dayOfWeek = now.getDay();
            const mondayOffset = dayOfWeek === 0 ? -6 : 1 - dayOfWeek;
            const monday = new Date(now);
            monday.setDate(now.getDate() + mondayOffset);
            monday.setHours(0, 0, 0, 0);
            return monday;
        }
        
        // Get weekly stats from database
        async function getWeeklyStats() {
            // Ensure we have user ID
            const userId = await getCurrentUserId();
            if (!userId || userId.startsWith('demo-')) {
                console.log(' No valid user ID for stats');
                return null;
            }
            
            try {
                const monday = getWeekStart();
                
                const { data, error } = await db
                    .from('user_actions')
                    .select('action_type, minutes_saved, euros_saved')
                    .eq('user_id', userId)
                    .gte('created_at', monday.toISOString());
                
                if (error) {
                    if (error.code === '42P01') {
                        console.log(' Table user_actions pas encore cre');
                        return null;
                    }
                    throw error;
                }
                
                const stats = {
                    reports: 0,
                    ocr: 0,
                    photos: 0,
                    messages: 0,
                    totalMinutes: 0,
                    totalEuros: 0
                };
                
                (data || []).forEach(action => {
                    stats.totalMinutes += action.minutes_saved || 0;
                    stats.totalEuros += parseFloat(action.euros_saved) || 0;
                    
                    switch(action.action_type) {
                        case 'report': stats.reports++; break;
                        case 'ocr': stats.ocr++; break;
                        case 'photo': stats.photos++; break;
                        case 'message': stats.messages++; break;
                    }
                });
                
                return stats;
                
            } catch (err) {
                console.error('Erreur rcupration stats:', err);
                return null;
            }
        }
        
        // Format time saved - returns {value, unit, extra} for proper display
        function formatTimeSaved(minutes) {
            if (minutes < 60) {
                return { value: minutes, unit: 'min', extra: null };
            }
            const hours = Math.floor(minutes / 60);
            const mins = minutes % 60;
            if (mins === 0) {
                return { value: hours, unit: 'h', extra: null };
            }
            return { value: hours, unit: 'h', extra: mins };
        }
        
        // Get motivational message
        // Get user's first name for personalization
        function getUserFirstName() {
            const user = JSON.parse(localStorage.getItem('fixair_user') || 'null');
            // Return actual name or null (not a fallback)
            return user?.first_name || null;
        }
        
        // Get motivational message with user's name (if available)
        function getMotivationalMessage(euros) {
            const messages = GAMIFICATION_CONFIG.messages;
            const name = getUserFirstName();
            let selected = messages[0];
            
            for (const msg of messages) {
                if (euros >= msg.threshold) selected = msg;
            }
            
            // Build text: "Lance-toi Sam !" or "Lance-toi !" if no name
            const textWithName = name ? `${selected.text} ${name} !` : `${selected.text} !`;
            
            // Return object with text and emoji info for special styling
            if (selected.greenEmoji) {
                return { 
                    text: textWithName, 
                    emoji: selected.emoji,
                    isGreen: true 
                };
            }
            return { 
                text: textWithName, 
                emoji: selected.emoji,
                isGreen: false 
            };
        }
        
        // Format message for display (handles green emoji)
        function formatMotivationalMessage(msgObj) {
            if (msgObj.isGreen) {
                return `${msgObj.text} <span class="green-emoji">${msgObj.emoji}</span>`;
            }
            return `${msgObj.text} ${msgObj.emoji}`;
        }
        
        // Calculate ring percentage
        function calculateRingPercentage(euros) {
            const percentage = Math.min((euros / GAMIFICATION_CONFIG.weeklyGoal) * 100, 100);
            return Math.round(percentage);
        }
        
        // Update ring SVG
        function updateStatsRing(percentage) {
            const ring = document.getElementById('statsRingProgress');
            if (!ring) return;
            
            const circumference = 2 * Math.PI * 54; // r = 54
            const offset = circumference - (percentage / 100) * circumference;
            
            ring.style.strokeDasharray = circumference;
            ring.style.strokeDashoffset = offset;
            
            const percentText = document.getElementById('statsRingPercent');
            if (percentText) percentText.textContent = `${percentage}%`;
        }
        
        // Get week label
        function getWeekLabel() {
            const monday = getWeekStart();
            const sunday = new Date(monday);
            sunday.setDate(monday.getDate() + 6);
            
            const options = { day: 'numeric', month: 'short' };
            const mondayStr = monday.toLocaleDateString('fr-FR', options);
            const sundayStr = sunday.toLocaleDateString('fr-FR', options);
            
            return `Semaine du ${mondayStr} au ${sundayStr}`;
        }
        
        // Refresh weekly stats display
        async function refreshWeeklyStats() {
            const stats = await getWeeklyStats();
            
            // Si pas de stats (table pas cre ou pas de donnes), afficher valeurs par dfaut
            const displayStats = stats || { totalMinutes: 0, totalEuros: 0, reports: 0 };
            
            const percentage = calculateRingPercentage(displayStats.totalEuros);
            const message = getMotivationalMessage(displayStats.totalEuros);
            const timeData = formatTimeSaved(displayStats.totalMinutes);
            
            // Mettre  jour le Ring
            updateStatsRing(percentage);
            
            // Mettre  jour les textes
            const timeValueEl = document.getElementById('statsTimeValue');
            const timeUnitEl = document.getElementById('statsTimeUnit');
            const eurosEl = document.getElementById('statsEurosSaved');
            const reportsEl = document.getElementById('statsReports');
            const messageEl = document.getElementById('statsMessage');
            const weekLabelEl = document.getElementById('statsWeekLabel');
            
            // Format time with separate value and unit
            if (timeValueEl) {
                if (timeData.extra) {
                    timeValueEl.textContent = timeData.value;
                    timeUnitEl.innerHTML = `${timeData.unit}<span class="stats-item-value" style="margin-left:1px">${timeData.extra}</span><span class="stats-item-unit">min</span>`;
                } else {
                    timeValueEl.textContent = timeData.value;
                    timeUnitEl.textContent = timeData.unit;
                }
            }
            
            if (eurosEl) eurosEl.textContent = `${Math.round(displayStats.totalEuros)}`;
            if (reportsEl) reportsEl.textContent = displayStats.reports;
            if (messageEl) messageEl.innerHTML = formatMotivationalMessage(message);
            if (weekLabelEl) weekLabelEl.textContent = getWeekLabel();
            
            console.log(' Stats hebdo:', {
                temps: `${timeData.value}${timeData.unit}${timeData.extra ? timeData.extra + 'min' : ''}`,
                euros: displayStats.totalEuros + '',
                rapports: displayStats.reports,
                ring: percentage + '%'
            });
        }
        
        // 
        // CELEBRATION ANIMATION - CONFETTI + COUNT-UP
        // 
        
        // Load last known stats from localStorage (persists across page reloads)
        let lastKnownStats = JSON.parse(localStorage.getItem('fixair_lastStats') || '{"totalMinutes":0,"totalEuros":0,"reports":0}');
        let celebrationInProgress = false;
        
        // Save stats to localStorage
        function saveLastKnownStats(stats) {
            lastKnownStats = { ...stats };
            localStorage.setItem('fixair_lastStats', JSON.stringify(stats));
        }
        
        // Create confetti particles
        function createConfetti() {
            const overlay = document.createElement('div');
            overlay.className = 'celebration-overlay';
            overlay.id = 'celebrationOverlay';
            document.body.appendChild(overlay);
            
            const colors = ['#FFD700', '#FF6B35', '#22C55E', '#3B82F6', '#A78BFA', '#F472B6', '#FCD34D', '#EF4444'];
            
            for (let i = 0; i < 80; i++) {
                const particle = document.createElement('div');
                particle.className = 'confetti-particle';
                
                const size = 8 + Math.random() * 8;
                const x = Math.random() * 100;
                const wobble = (Math.random() - 0.5) * 120;
                const delay = Math.random() * 0.8;
                const duration = 2.5 + Math.random() * 1.5;
                const color = colors[i % colors.length];
                
                particle.style.cssText = `
                    left: ${x}%;
                    width: ${size}px;
                    height: ${size * 0.6}px;
                    background: ${color};
                    --wobble: ${wobble}px;
                    --delay: ${delay}s;
                    --duration: ${duration}s;
                `;
                
                overlay.appendChild(particle);
            }
            
            // Remove after animation completes (max duration 4s + max delay 0.8s + buffer)
            setTimeout(() => {
                overlay.remove();
            }, 5500);
        }
        
        // Show floating +1 (or +X%)
        function showPlusOne(text = '+1') {
            const plusOne = document.createElement('div');
            plusOne.className = 'plus-one-floating';
            plusOne.textContent = text;
            document.body.appendChild(plusOne);
            
            setTimeout(() => {
                plusOne.remove();
            }, 2000);
        }
        
        // Animate stats count-up
        function animateStatsCountUp(fromStats, toStats, duration = 1500) {
            const startTime = Date.now();
            
            const ring = document.getElementById('statsRingProgress');
            if (ring) ring.classList.add('animating');
            
            const animate = () => {
                const elapsed = Date.now() - startTime;
                const progress = Math.min(elapsed / duration, 1);
                const eased = 1 - Math.pow(1 - progress, 3); // ease-out cubic
                
                // Interpolate values
                const currentMinutes = Math.round(fromStats.totalMinutes + (toStats.totalMinutes - fromStats.totalMinutes) * eased);
                const currentEuros = Math.round(fromStats.totalEuros + (toStats.totalEuros - fromStats.totalEuros) * eased);
                const currentReports = Math.round(fromStats.reports + (toStats.reports - fromStats.reports) * eased);
                
                // Update display
                const percentage = calculateRingPercentage(currentEuros);
                updateStatsRing(percentage);
                
                const percentEl = document.getElementById('statsRingPercent');
                if (percentEl) percentEl.textContent = percentage + '%';
                
                const timeData = formatTimeSaved(currentMinutes);
                const timeValueEl = document.getElementById('statsTimeValue');
                const timeUnitEl = document.getElementById('statsTimeUnit');
                if (timeValueEl) {
                    timeValueEl.textContent = timeData.value;
                    if (timeData.extra) {
                        timeUnitEl.innerHTML = `${timeData.unit}<span class="stats-item-value" style="margin-left:1px">${timeData.extra}</span><span class="stats-item-unit">min</span>`;
                    } else {
                        timeUnitEl.textContent = timeData.unit;
                    }
                }
                
                const eurosEl = document.getElementById('statsEurosSaved');
                if (eurosEl) eurosEl.textContent = `${currentEuros}`;
                
                const reportsEl = document.getElementById('statsReports');
                if (reportsEl) reportsEl.textContent = currentReports;
                
                if (progress < 1) {
                    requestAnimationFrame(animate);
                } else {
                    if (ring) ring.classList.remove('animating');
                    
                    // Update message
                    const message = getMotivationalMessage(toStats.totalEuros);
                    const messageEl = document.getElementById('statsMessage');
                    if (messageEl) messageEl.innerHTML = formatMotivationalMessage(message);
                }
            };
            
            requestAnimationFrame(animate);
        }
        
        // Full celebration sequence
        function triggerCelebration(newStats, oldStats) {
            if (celebrationInProgress) return;
            celebrationInProgress = true;
            
            console.log(' Clbration dclenche!');
            
            // Calculate difference for +X display
            const eurosDiff = Math.round(newStats.totalEuros - oldStats.totalEuros);
            const percentDiff = calculateRingPercentage(newStats.totalEuros) - calculateRingPercentage(oldStats.totalEuros);
            
            // Start confetti
            createConfetti();
            
            // Show +X after a small delay
            setTimeout(() => {
                if (percentDiff > 0) {
                    showPlusOne(`+${percentDiff}%`);
                } else if (eurosDiff > 0) {
                    showPlusOne(`+${eurosDiff}`);
                }
            }, 300);
            
            // Animate count-up
            animateStatsCountUp(oldStats, newStats, 1800);
            
            setTimeout(() => {
                celebrationInProgress = false;
            }, 3000);
        }
        
        // Check if celebration should trigger
        function shouldCelebrate(newStats, oldStats) {
            // Celebrate if there's any increase
            return newStats.totalEuros > oldStats.totalEuros || 
                   newStats.reports > oldStats.reports ||
                   newStats.totalMinutes > oldStats.totalMinutes;
        }
        
        // Initialize gamification on login with celebration check
        async function initGamification(forceCheck = false) {
            console.log(' initGamification called, forceCheck:', forceCheck);
            
            // Ensure we have the user ID
            const userId = await getCurrentUserId();
            if (!userId || userId.startsWith('demo-')) {
                console.log(' No valid user ID for gamification');
                return;
            }
            
            const stats = await getWeeklyStats();
            const newStats = stats || { totalMinutes: 0, totalEuros: 0, reports: 0 };
            
            console.log(' Current DB stats:', newStats);
            console.log(' Last known stats:', lastKnownStats);
            
            // First login ever (no previous stats saved) - just display without animation
            if (!forceCheck && lastKnownStats.totalEuros === 0 && lastKnownStats.totalMinutes === 0 && lastKnownStats.reports === 0) {
                // But if DB has stats, it means user was already active - show celebration!
                if (newStats.totalEuros > 0 || newStats.totalMinutes > 0 || newStats.reports > 0) {
                    console.log(' First load but has stats - celebrating!');
                    triggerCelebration(newStats, { totalMinutes: 0, totalEuros: 0, reports: 0 });
                    saveLastKnownStats(newStats);
                    return;
                }
                await refreshWeeklyStats();
                saveLastKnownStats(newStats);
                console.log(' First init - no celebration');
                return;
            }
            
            // Check if we should celebrate (any increase in stats)
            const hasIncrease = 
                newStats.totalEuros > lastKnownStats.totalEuros || 
                newStats.totalMinutes > lastKnownStats.totalMinutes ||
                newStats.reports > lastKnownStats.reports;
            
            console.log(' Should celebrate?', hasIncrease);
            
            if (hasIncrease || forceCheck) {
                console.log(' Triggering celebration!');
                triggerCelebration(newStats, forceCheck ? { totalMinutes: 0, totalEuros: 0, reports: 0 } : lastKnownStats);
            } else {
                await refreshWeeklyStats();
            }
            
            saveLastKnownStats(newStats);
        }
        
        // Call celebration when returning to homepage
        function onReturnToHomepage() {
            console.log(' onReturnToHomepage called');
            console.log(' currentUserId:', currentUserId);
            console.log(' homepage active:', document.getElementById('homepageContent')?.classList.contains('active'));
            
            if (currentUserId) {
                initGamification(false);
            }
        }
        
        // TEST FUNCTION - Call from console: testCelebration()
        window.testCelebration = function() {
            console.log(' Test celebration triggered');
            const fakeOld = { totalMinutes: 0, totalEuros: 0, reports: 0 };
            const fakeNew = { totalMinutes: 5, totalEuros: 4, reports: 0 };
            triggerCelebration(fakeNew, fakeOld);
        };
        
        // TEST: Force celebration with real stats
        window.forceCelebration = async function() {
            console.log(' Force celebration with real stats');
            initGamification(true);
        };
        
        // DEBUG: Check current gamification state
        window.debugGamification = async function() {
            console.log('');
            console.log(' GAMIFICATION DEBUG');
            console.log('');
            console.log('Current User ID:', currentUserId);
            console.log('Last Known Stats (localStorage):', lastKnownStats);
            
            const dbStats = await getWeeklyStats();
            console.log('Current DB Stats:', dbStats);
            
            if (dbStats) {
                const hasIncrease = 
                    dbStats.totalEuros > lastKnownStats.totalEuros || 
                    dbStats.totalMinutes > lastKnownStats.totalMinutes ||
                    dbStats.reports > lastKnownStats.reports;
                console.log('Has increase (should celebrate):', hasIncrease);
            }
            console.log('');
            return { lastKnownStats, dbStats };
        };
        
        // RESET: Clear saved stats to test first-time animation
        window.resetGamificationStats = function() {
            localStorage.removeItem('fixair_lastStats');
            lastKnownStats = { totalMinutes: 0, totalEuros: 0, reports: 0 };
            console.log(' Stats reset! Reload page to test celebration');
        };
    </script>
    
    </div><!-- End app-wrapper -->
    
    <!-- Gap cover: This covers any gap that might appear from iframe/embed issues -->
    <div id="gapCover" style="
        position: fixed;
        bottom: -100px;
        left: 0;
        right: 0;
        height: 200px;
        background: var(--bg, #0f1217);
        z-index: -1;
        pointer-events: none;
    "></div>
    
    <!-- RENAME PROJECT MODAL -->
    <div class="rename-modal" id="renameModal">
        <div class="rename-modal-content">
            <div class="rename-modal-title">Renommer le projet</div>
            <input type="text" class="rename-modal-input" id="renameInput" placeholder="Nom du projet">
            <div class="rename-modal-buttons">
                <button class="rename-modal-btn cancel" onclick="closeRenameModal()">Annuler</button>
                <button class="rename-modal-btn save" onclick="saveProjectRename()">Enregistrer</button>
            </div>
        </div>
    </div>
</body>
</html>
