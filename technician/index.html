<!DOCTYPE html>
<html lang="fr">
<head>
    <link rel="icon" type="image/svg+xml" href="../favicon.svg">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>FixAIR Technician</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --copilot: #FF6B35;
            --copilot-glow: rgba(255, 107, 53, 0.4);
            --copilot-bg: rgba(255, 107, 53, 0.08);
            --copilot-border: rgba(255, 107, 53, 0.2);
            --assistant: #22c55e;
            --assistant-glow: rgba(34, 197, 94, 0.4);
            --assistant-bg: rgba(34, 197, 94, 0.08);
            --assistant-border: rgba(34, 197, 94, 0.2);
            --hotline: #ef4444;
            --hotline-glow: rgba(239, 68, 68, 0.4);
            --connect: #3b82f6;
            --connect-glow: rgba(59, 130, 246, 0.4);
            --connect-bg: rgba(59, 130, 246, 0.08);
            --connect-border: rgba(59, 130, 246, 0.2);
            --bg: #0D1117;
            --bg-secondary: #161b22;
            --card: rgba(255, 255, 255, 0.03);
            --border: rgba(255, 255, 255, 0.06);
            --text: rgba(255, 255, 255, 0.9);
            --text-dim: rgba(255, 255, 255, 0.35);
            --content-width: 520px;
            --app-height: 100%;
            --grid-color: rgba(255,255,255,0.015);
            --input-bg: rgba(255,255,255,0.03);
            --msg-user-bg: rgba(255,255,255,0.06);
            --msg-ai-bg: transparent;
            --shadow-color: rgba(0,0,0,0.3);
            --scrollbar-thumb: rgba(255, 255, 255, 0.15);
            --scrollbar-thumb-hover: rgba(255, 255, 255, 0.25);
            --scrollbar-track: transparent;
            /* Thought Process UI */
            --thought-border: rgba(255, 255, 255, 0.1);
            --thought-line: rgba(255, 255, 255, 0.15);
            --thought-text: rgba(255, 255, 255, 0.65);
            --thought-text-muted: rgba(255, 255, 255, 0.4);
            --thought-bullet: rgba(255, 255, 255, 0.25);
            --thought-hover: rgba(255, 255, 255, 0.03);
        }

        /* LIGHT THEME */
        [data-theme="light"] {
            --bg: #F8FAFC;
            --bg-secondary: #FFFFFF;
            --card: #FFFFFF;
            --border: rgba(0, 0, 0, 0.08);
            --text: #1E293B;
            --text-dim: #64748B;
            --grid-color: rgba(0,0,0,0.03);
            --input-bg: #FFFFFF;
            --msg-user-bg: rgba(0,0,0,0.04);
            --msg-ai-bg: transparent;
            --shadow-color: rgba(0,0,0,0.08);
            --copilot-bg: rgba(255, 107, 53, 0.1);
            --copilot-border: rgba(255, 107, 53, 0.25);
            --assistant-bg: rgba(34, 197, 94, 0.1);
            --assistant-border: rgba(34, 197, 94, 0.25);
            --assistant: #16a34a;
            --hotline: #dc2626;
            --scrollbar-thumb: rgba(0, 0, 0, 0.15);
            --scrollbar-thumb-hover: rgba(0, 0, 0, 0.25);
            --scrollbar-track: transparent;
            /* Thought Process UI */
            --thought-border: rgba(0, 0, 0, 0.08);
            --thought-line: rgba(0, 0, 0, 0.12);
            --thought-text: rgba(0, 0, 0, 0.6);
            --thought-text-muted: rgba(0, 0, 0, 0.4);
            --thought-bullet: rgba(0, 0, 0, 0.2);
            --thought-hover: rgba(0, 0, 0, 0.02);
        }

        /* ==================== SCROLLBAR STYLING ==================== */
        /* Firefox scrollbar */
        * {
            scrollbar-width: thin;
            scrollbar-color: var(--scrollbar-thumb) var(--scrollbar-track);
        }
        
        /* Webkit scrollbar (Chrome, Safari, Edge) */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        ::-webkit-scrollbar-track {
            background: var(--scrollbar-track);
        }
        ::-webkit-scrollbar-thumb {
            background: var(--scrollbar-thumb);
            border-radius: 3px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: var(--scrollbar-thumb-hover);
        }
        ::-webkit-scrollbar-corner {
            background: transparent;
        }
        
        /* Hide scrollbar for specific elements while keeping scroll functionality */
        .brand-select-row::-webkit-scrollbar,
        .brand-dropdown::-webkit-scrollbar {
            display: none;
        }
        .brand-select-row,
        .brand-dropdown {
            scrollbar-width: none;
            -ms-overflow-style: none;
        }
        
        /* ==================== LIGHT THEME COMPONENT OVERRIDES ==================== */
        [data-theme="light"] .nav {
            background: rgba(255,255,255,0.98) !important;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.08);
        }
        [data-theme="light"] .app-header {
            background: linear-gradient(180deg, rgba(248,250,252,0.98), rgba(248,250,252,0.8), transparent) !important;
        }
        [data-theme="light"] .login-bar,
        [data-theme="light"] .brand-pill,
        [data-theme="light"] .proj,
        [data-theme="light"] .form-input,
        [data-theme="light"] .brand-select-row {
            box-shadow: 0 1px 3px rgba(0,0,0,0.04);
        }
        [data-theme="light"] .proj:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }
        [data-theme="light"] .brand-dropdown {
            background: rgba(255,255,255,0.98);
            box-shadow: 0 8px 24px rgba(0,0,0,0.15);
        }
        [data-theme="light"] .panel-brand-dropdown {
            background: rgba(255,255,255,0.98);
            border-color: rgba(0,0,0,0.1);
            box-shadow: 0 8px 24px rgba(0,0,0,0.15);
        }
        [data-theme="light"] .panel-brand-option {
            color: rgba(0,0,0,0.6);
        }
        [data-theme="light"] .panel-brand-option:hover {
            background: rgba(0,0,0,0.04);
            color: #000;
        }
        [data-theme="light"] .panel-brand-btn .panel-brand-text {
            color: rgba(0,0,0,0.5);
        }
        [data-theme="light"] .panel-brand-btn:hover .panel-brand-text {
            color: #000;
        }
        [data-theme="light"] .panel-brand-btn .brand-arrow {
            color: rgba(0,0,0,0.4);
        }
        [data-theme="light"] .panel-brand-btn:hover .brand-arrow {
            color: #000;
        }
        [data-theme="light"] .brand-chip:hover,
        [data-theme="light"] .brand-dropdown-item:hover {
            background: rgba(0,0,0,0.04);
        }
        [data-theme="light"] .login-input::placeholder,
        [data-theme="light"] .input-text::placeholder,
        [data-theme="light"] .form-input::placeholder {
            color: #94A3B8;
        }
        [data-theme="light"] .panel-header,
        [data-theme="light"] .profile-header {
            background: rgba(255,255,255,0.95) !important;
        }
        [data-theme="light"] .input-row {
            background: var(--card);
            border-color: rgba(0,0,0,0.08);
        }
        [data-theme="light"] .input-row:focus-within {
            border-color: var(--copilot);
            box-shadow: 0 0 0 3px rgba(255,107,53,0.1);
        }
        [data-theme="light"] .report-sheet {
            background: rgba(255,255,255,0.98) !important;
        }
        [data-theme="light"] .photo-modal-content {
            background: rgba(255,255,255,0.98);
        }
        [data-theme="light"] .attach-menu {
            background: rgba(255,255,255,0.98);
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        }
        [data-theme="light"] .attach-opt:hover {
            background: rgba(0,0,0,0.04);
        }
        [data-theme="light"] .toast {
            background: rgba(255,255,255,0.98);
        }
        [data-theme="light"] .toggle-chat {
            background: rgba(255,255,255,0.95);
            border-color: rgba(0,0,0,0.08);
        }
        [data-theme="light"] .toggle-chat:hover {
            background: rgba(255,255,255,0.98);
        }
        [data-theme="light"] .h-btn {
            background: var(--card);
            border-color: rgba(0,0,0,0.08);
        }
        [data-theme="light"] .h-btn:hover {
            background: rgba(0,0,0,0.04);
        }
        [data-theme="light"] .msg-act:hover {
            background: rgba(0,0,0,0.04);
        }
        [data-theme="light"] .divider:hover,
        [data-theme="light"] .divider.dragging {
            background: rgba(0,0,0,0.12);
        }
        [data-theme="light"] .ring-bg {
            stroke: rgba(0,0,0,0.06);
        }
        [data-theme="light"] .panel-back:hover,
        [data-theme="light"] .profile-back:hover {
            background: rgba(0,0,0,0.06);
        }
        [data-theme="light"] .hotline-close {
            background: var(--card);
            border-color: var(--border);
        }
        [data-theme="light"] .hotline-close:hover {
            background: rgba(0,0,0,0.04);
        }
        [data-theme="light"] .onboarding-step {
            background: rgba(255,255,255,0.98);
        }
        [data-theme="light"] .onboarding-step:hover {
            background: rgba(0,0,0,0.02);
        }
        [data-theme="light"] .step-check.pending {
            background: rgba(0,0,0,0.03);
            border-color: rgba(0,0,0,0.12);
        }
        [data-theme="light"] .brand-select-option {
            background: rgba(0,0,0,0.02);
            border-color: rgba(0,0,0,0.06);
        }
        [data-theme="light"] .brand-select-option:hover {
            background: rgba(0,0,0,0.04);
        }
        [data-theme="light"] .congrats-close {
            background: rgba(0,0,0,0.03);
            border-color: rgba(0,0,0,0.08);
        }
        [data-theme="light"] .congrats-close:hover {
            background: rgba(0,0,0,0.06);
        }
        [data-theme="light"] .photo-option {
            background: rgba(0,0,0,0.02);
            border-color: rgba(0,0,0,0.06);
        }
        [data-theme="light"] .photo-option:hover {
            background: rgba(0,0,0,0.04);
        }
        [data-theme="light"] .login-back {
            background: rgba(0,0,0,0.04);
        }
        [data-theme="light"] .login-back:hover {
            background: rgba(0,0,0,0.08);
        }
        [data-theme="light"] .sphere-fog-container {
            background: rgba(255,255,255,0.3);
        }
        [data-theme="light"] .form-input:focus {
            border-color: var(--copilot);
            box-shadow: 0 0 0 3px rgba(255,107,53,0.1);
        }
        [data-theme="light"] .login-bar {
            background: var(--card);
        }
        [data-theme="light"] .login-input:-webkit-autofill,
        [data-theme="light"] .login-input:-webkit-autofill:hover,
        [data-theme="light"] .login-input:-webkit-autofill:focus,
        [data-theme="light"] .login-input:-webkit-autofill:active {
            -webkit-box-shadow: 0 0 0 1000px var(--card) inset !important;
            -webkit-text-fill-color: var(--text) !important;
        }
        
        /* ==================== LIGHT THEME - NAVIGATION & ICONS ==================== */
        [data-theme="light"] .nav-item {
            color: #64748B;
        }
        [data-theme="light"] .nav-item:hover {
            color: #1E293B;
        }
        [data-theme="light"] .nav-item.active {
            color: var(--copilot);
        }
        
        /* ==================== LIGHT THEME - BACK BUTTONS & ARROWS ==================== */
        [data-theme="light"] .panel-back,
        [data-theme="light"] .profile-back,
        [data-theme="light"] .hotline-back,
        [data-theme="light"] .report-close {
            color: #64748B;
            background: rgba(0,0,0,0.04);
            border-color: rgba(0,0,0,0.08);
        }
        [data-theme="light"] .panel-back .icon,
        [data-theme="light"] .profile-back .icon,
        [data-theme="light"] .hotline-back .icon,
        [data-theme="light"] .report-close .icon {
            color: #64748B;
        }
        [data-theme="light"] .panel-back:hover .icon,
        [data-theme="light"] .profile-back:hover .icon {
            color: #1E293B;
        }
        
        /* ==================== LIGHT THEME - BRAND CHIPS & DROPDOWN ==================== */
        [data-theme="light"] .brand-chip {
            color: #64748B;
            border-color: rgba(0,0,0,0.12);
        }
        [data-theme="light"] .brand-chip.active {
            color: var(--copilot);
        }
        [data-theme="light"] .brand-pill-text {
            color: #1E293B;
        }
        [data-theme="light"] .brand-dropdown-name {
            color: #1E293B;
        }
        [data-theme="light"] .brand-dropdown-item.disabled .brand-dropdown-name {
            color: #78909C;
        }
        
        /* ==================== LIGHT THEME - TOGGLE CARDS (Copilot/Assistant) ==================== */
        [data-theme="light"] .toggle-card {
            background: #FFFFFF !important;
            border: 1px solid rgba(0,0,0,0.1);
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        }
        [data-theme="light"] .toggle-card:hover {
            background: #F1F5F9 !important;
            border-color: rgba(0,0,0,0.15);
            box-shadow: 0 4px 16px rgba(0,0,0,0.1);
        }
        [data-theme="light"] .toggle-card:active {
            background: #E2E8F0 !important;
        }
        [data-theme="light"] .toggle-card-title {
            color: #1E293B !important;
        }
        [data-theme="light"] .toggle-card:hover .toggle-card-title,
        [data-theme="light"] .toggle-card:active .toggle-card-title {
            color: #1E293B !important;
        }
        [data-theme="light"] .toggle-card-desc {
            color: #64748B;
        }
        [data-theme="light"] .toggle-card-arrow {
            color: #94A3B8;
        }
        [data-theme="light"] .toggle-card:hover .toggle-card-arrow {
            color: #64748B;
        }
        /* Icon backgrounds matching proj-icon style */
        [data-theme="light"] .toggle-card.copilot .toggle-card-icon {
            background: var(--copilot-bg);
            color: var(--copilot);
        }
        [data-theme="light"] .toggle-card.assistant .toggle-card-icon {
            background: var(--assistant-bg);
            color: var(--assistant);
        }
        
        /* ==================== LIGHT THEME - MODE TOGGLE ==================== */
        [data-theme="light"] .mode-btn {
            color: #64748B;
            background: rgba(0,0,0,0.04);
        }
        [data-theme="light"] .mode-btn .mode-icon {
            color: #94A3B8;
        }
        [data-theme="light"] .mode-btn.copilot.active {
            background: var(--copilot-bg);
            color: var(--copilot);
        }
        [data-theme="light"] .mode-btn.copilot.active .mode-icon {
            color: var(--copilot);
        }
        [data-theme="light"] .mode-btn.assistant.active {
            background: var(--assistant-bg);
            color: var(--assistant);
        }
        [data-theme="light"] .mode-btn.assistant.active .mode-icon {
            color: var(--assistant);
        }
        
        /* ==================== LIGHT THEME - PLUS BUTTON & ACTIONS ==================== */
        [data-theme="light"] .plus-btn {
            color: #64748B;
            background: #F8FAFC;
            border-color: rgba(0,0,0,0.1);
        }
        [data-theme="light"] .panel.copilot .plus-btn .icon {
            color: var(--copilot);
        }
        [data-theme="light"] .panel.assistant .plus-btn .icon {
            color: var(--assistant);
        }
        [data-theme="light"] .plus-btn:hover {
            background: #F1F5F9;
        }
        
        /* ==================== LIGHT THEME - MESSAGE ACTIONS (Copy, etc) ==================== */
        [data-theme="light"] .msg-act {
            color: rgba(0,0,0,0.25);
            background: transparent;
        }
        [data-theme="light"] .msg-act .icon {
            color: rgba(0,0,0,0.25);
        }
        [data-theme="light"] .msg-act:hover {
            color: rgba(0,0,0,0.6);
            background: rgba(0,0,0,0.05);
        }
        [data-theme="light"] .msg-act:hover .icon {
            color: rgba(0,0,0,0.6);
        }
        
        /* ==================== LIGHT THEME - HEADER BUTTONS ==================== */
        [data-theme="light"] .h-btn {
            color: #64748B;
            background: rgba(0,0,0,0.02);
            border-color: rgba(0,0,0,0.08);
        }
        [data-theme="light"] .h-btn .icon {
            color: #64748B;
        }
        [data-theme="light"] .h-btn:hover {
            color: #1E293B;
            background: rgba(0,0,0,0.05);
        }
        [data-theme="light"] .h-btn:hover .icon {
            color: #1E293B;
        }
        
        /* ==================== LIGHT THEME - REPORT SHEET ==================== */
        [data-theme="light"] .report-close {
            color: #64748B;
        }
        [data-theme="light"] .report-close .icon {
            color: #64748B;
        }
        [data-theme="light"] .r-btn.secondary {
            color: #64748B;
            background: rgba(0,0,0,0.02);
            border-color: rgba(0,0,0,0.08);
        }
        [data-theme="light"] .r-btn.secondary .icon {
            color: #64748B;
        }
        [data-theme="light"] .r-label {
            color: #64748B;
        }
        [data-theme="light"] .r-value {
            color: #1E293B;
        }
        [data-theme="light"] .r-section-title {
            color: #1E293B;
        }
        
        /* ==================== LIGHT THEME - PHOTO OPTIONS ==================== */
        [data-theme="light"] .photo-option-title {
            color: #1E293B;
        }
        [data-theme="light"] .photo-option-desc {
            color: #64748B;
        }
        
        /* ==================== LIGHT THEME - ATTACH MENU ==================== */
        [data-theme="light"] .attach-opt {
            color: #1E293B;
        }
        [data-theme="light"] .attach-opt .icon {
            color: var(--mode-color);
        }
        
        /* ==================== LIGHT THEME - HOTLINE ==================== */
        [data-theme="light"] .hotline-close {
            color: #64748B;
            background: #FFFFFF;
            border-color: rgba(0,0,0,0.08);
        }
        [data-theme="light"] .hotline-close .icon {
            color: #64748B;
        }
        [data-theme="light"] .hotline-close:hover {
            color: #1E293B;
        }
        
        /* ==================== LIGHT THEME - PROJECT CARDS ==================== */
        [data-theme="light"] .proj {
            background: #FFFFFF !important;
            border-color: rgba(0,0,0,0.08);
        }
        [data-theme="light"] .proj:hover {
            background: #F8FAFC !important;
            border-color: rgba(0,0,0,0.12);
        }
        [data-theme="light"] .proj:active {
            background: #F1F5F9 !important;
        }
        [data-theme="light"] .proj-title {
            color: #1E293B;
        }
        [data-theme="light"] .proj-meta,
        [data-theme="light"] .proj-time {
            color: #64748B;
        }
        
        /* ==================== LIGHT THEME - PROJECTS PAGE ==================== */
        [data-theme="light"] .projects-page-header::after {
            background: linear-gradient(to bottom, #F8FAFC 0%, #F8FAFC 20%, transparent 100%);
        }
        
        /* Toggle Switch Styles */
        .setting-toggle { 
            display: flex; 
            align-items: center; 
            justify-content: space-between; 
            padding: 14px 16px; 
            background: var(--card); 
            border: 1px solid var(--border); 
            border-radius: 12px; 
            margin-bottom: 12px;
        }
        .setting-toggle-info { display: flex; flex-direction: column; gap: 2px; }
        .setting-toggle-label { font-size: 13px; font-weight: 500; color: var(--text); }
        .setting-toggle-desc { font-size: 11px; color: var(--text-dim); }
        .toggle-switch { 
            position: relative; 
            width: 50px; 
            height: 28px; 
            background: var(--border); 
            border-radius: 14px; 
            cursor: pointer; 
            transition: all 0.3s ease;
            flex-shrink: 0;
        }
        .toggle-switch.active { background: var(--copilot); }
        .toggle-switch::after { 
            content: ''; 
            position: absolute; 
            top: 3px; 
            left: 3px; 
            width: 22px; 
            height: 22px; 
            background: white; 
            border-radius: 50%; 
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .toggle-switch.active::after { transform: translateX(22px); }
        
        /* Language Selector */
        .lang-selector {
            display: flex;
            gap: 8px;
        }
        .lang-btn {
            padding: 8px 16px;
            border-radius: 8px;
            border: 1px solid var(--border);
            background: var(--card);
            color: var(--text-dim);
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .lang-btn.active {
            background: var(--copilot-bg);
            border-color: var(--copilot-border);
            color: var(--copilot);
        }
        .lang-btn:hover:not(.active) {
            background: var(--border);
        }
        
        /* Settings Section Divider */
        .settings-divider {
            height: 1px;
            background: var(--border);
            margin: 20px 0;
        }
        .settings-section-title {
            font-size: 11px;
            font-weight: 600;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 12px;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        /* CRITICAL: Prevent any gap or overflow */
        html { 
            width: 100%; 
            height: 100%;
            height: -webkit-fill-available;
            margin: 0;
            padding: 0;
            background: var(--bg); 
            background-image: linear-gradient(var(--grid-color) 1px, transparent 1px), linear-gradient(90deg, var(--grid-color) 1px, transparent 1px); 
            background-size: 32px 32px;
            background-attachment: fixed;
            overflow: hidden !important;
            overscroll-behavior: none;
            -webkit-text-size-adjust: 100%;
            /* Prevent any content from showing outside */
            position: relative;
        }
        body { 
            width: 100%; 
            height: 100%;
            height: -webkit-fill-available;
            min-height: 100%;
            max-height: 100%;
            margin: 0;
            padding: 0;
            padding-bottom: env(safe-area-inset-bottom, 0px);
            font-family: 'Inter', -apple-system, sans-serif; 
            background: var(--bg); 
            background-image: linear-gradient(var(--grid-color) 1px, transparent 1px), linear-gradient(90deg, var(--grid-color) 1px, transparent 1px); 
            background-size: 32px 32px;
            background-attachment: fixed;
            color: var(--text); 
            overflow: hidden !important;
            position: fixed; 
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            overscroll-behavior: none;
            -webkit-text-size-adjust: 100%;
            display: flex;
            flex-direction: column;
        }
        
        /* App wrapper to contain everything */
        .app-wrapper {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            overflow: hidden;
            background: var(--bg);
        }
        input, textarea, select { font-size: 16px !important; }
        .icon { display: inline-flex; align-items: center; justify-content: center; }
        .icon svg { width: 100%; height: 100%; stroke: currentColor; stroke-width: 1.5; fill: none; stroke-linecap: round; stroke-linejoin: round; }
        .screen { position: fixed; top: 0; left: 0; right: 0; bottom: 0; display: none; flex-direction: column; background: var(--bg); background-image: linear-gradient(var(--grid-color) 1px, transparent 1px), linear-gradient(90deg, var(--grid-color) 1px, transparent 1px); background-size: 32px 32px; z-index: 1; }
        .screen.active { display: flex; }

        /* ==================== LOGIN ==================== */
        .login-screen { justify-content: center; align-items: center; padding: 24px; }
        .login-container { width: 100%; max-width: 380px; display: flex; flex-direction: column; align-items: center; }
        .scan-line { position: fixed; top: 0; left: 0; width: 100%; height: 2px; background: linear-gradient(90deg, transparent, var(--copilot), transparent); box-shadow: 0 0 20px var(--copilot-glow); animation: scanDown 2s ease-out forwards; }
        @keyframes scanDown { to { top: 50%; opacity: 0; } }
        .login-title { font-size: 22px; font-weight: 300; margin-bottom: 4px; color: rgba(255,255,255,0.9); }
        .login-sub { font-size: 12px; color: var(--text-dim); margin-bottom: 32px; }
        .login-logo { width: 160px; height: auto; margin-bottom: 24px; color: var(--copilot); }
        .login-logo svg { width: 100%; height: auto; }
        .login-bar { display: flex; align-items: center; gap: 8px; padding: 5px 5px 5px 8px; background: var(--card); border: 1px solid var(--border); border-radius: 40px; width: 100%; opacity: 0; animation: fadeUp 0.5s ease 1.5s forwards; }
        @keyframes fadeUp { to { opacity: 1; } }
        @keyframes spin { to { transform: rotate(360deg); } }
        .login-mini { width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; position: relative; }
        .glass-sphere { width: 26px; height: 26px; border-radius: 50%; position: relative; overflow: hidden; animation: glowPulse 8s ease-in-out infinite; }
        @keyframes glowPulse { 
            0%, 100% { box-shadow: 0 0 14px rgba(255,107,53,0.7), 0 0 28px rgba(255,107,53,0.3); } 
            25% { box-shadow: 0 0 14px rgba(239,68,68,0.7), 0 0 28px rgba(239,68,68,0.3); } 
            50% { box-shadow: 0 0 14px rgba(59,130,246,0.7), 0 0 28px rgba(59,130,246,0.3); } 
            75% { box-shadow: 0 0 14px rgba(234,179,8,0.7), 0 0 28px rgba(234,179,8,0.3); } 
        }
        .glass-sphere::before { content: ''; position: absolute; top: 2px; left: 4px; width: 5px; height: 4px; border-radius: 50%; background: radial-gradient(circle, rgba(255,255,255,0.5), transparent 70%); z-index: 10; }
        .sphere-fog-container { position: absolute; inset: 0; border-radius: 50%; overflow: hidden; background: rgba(20,24,32,0.3); }
        .sphere-fog { position: absolute; inset: -50%; border-radius: 50%; background: radial-gradient(circle at 30% 40%, currentColor, transparent 50%), radial-gradient(circle at 70% 60%, currentColor, transparent 40%); filter: blur(2px); animation: fogSwirl 6s ease-in-out infinite, fogColor 8s ease-in-out infinite; opacity: 0.9; }
        @keyframes fogSwirl { 0% { transform: rotate(0deg) translate(0, 0); } 25% { transform: rotate(90deg) translate(2px, -2px); } 50% { transform: rotate(180deg) translate(0, 0); } 75% { transform: rotate(270deg) translate(-2px, 2px); } 100% { transform: rotate(360deg) translate(0, 0); } }
        @keyframes fogColor { 0%, 100% { color: #FF6B35; } 25% { color: #ef4444; } 50% { color: #3B82F6; } 75% { color: #eab308; } }
        .sphere-fog-2 { position: absolute; inset: -30%; border-radius: 50%; background: radial-gradient(circle at 60% 30%, currentColor, transparent 45%); filter: blur(2px); animation: fogSwirl2 5s ease-in-out infinite reverse, fogColor2 8s ease-in-out infinite; opacity: 0.7; }
        @keyframes fogSwirl2 { 0% { transform: rotate(0deg) scale(0.9); } 50% { transform: rotate(180deg) scale(1.1); } 100% { transform: rotate(360deg) scale(0.9); } }
        @keyframes fogColor2 { 0%, 100% { color: #3B82F6; } 25% { color: #eab308; } 50% { color: #FF6B35; } 75% { color: #ef4444; } }
        .login-input { flex: 1; padding: 8px; background: transparent; border: none; color: white; font-size: 13px; outline: none; caret-color: white; }
        .login-input::placeholder { color: rgba(255,255,255,0.25); }
        .login-input:-webkit-autofill,
        .login-input:-webkit-autofill:hover,
        .login-input:-webkit-autofill:focus,
        .login-input:-webkit-autofill:active {
            -webkit-box-shadow: 0 0 0 1000px transparent inset !important;
            -webkit-text-fill-color: white !important;
            background-color: transparent !important;
            background: transparent !important;
            transition: background-color 9999s ease-out 9999s !important;
            caret-color: white !important;
        }
        .login-btn { width: 32px; height: 32px; border-radius: 50%; background: linear-gradient(135deg, #FF6B35, #E55A2B); border: none; color: white; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .login-btn .icon { width: 12px; height: 12px; }

        /* ==================== LOGIN STATUS MESSAGES ==================== */
        .login-status { 
            min-height: 24px; 
            margin-top: 16px; 
            text-align: center; 
            font-size: 13px; 
            font-weight: 500;
            transition: all 0.3s ease;
        }
        .login-status:empty { display: none; }
        .login-status.success { color: #22c55e; }
        .login-status.error { color: #ef4444; }
        .login-status.info { color: rgba(255,255,255,0.7); }
        .login-status a { 
            color: inherit; 
            text-decoration: underline; 
            cursor: pointer;
            margin-left: 8px;
        }
        .login-status a:hover { opacity: 0.8; }

        /* ==================== PENDING & CONFIRMATION SCREENS ==================== */
        .pending-screen { display: none; }
        .pending-screen.active { display: flex; }
        .pending-container { display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 24px; padding: 40px; text-align: center; }
        .pending-logo { margin-bottom: 8px; }
        .pending-logo svg { height: 40px; width: auto; }
        .pending-icon { width: 80px; height: 80px; border-radius: 50%; background: linear-gradient(135deg, rgba(255,107,53,0.2), rgba(255,107,53,0.05)); display: flex; align-items: center; justify-content: center; animation: pendingPulse 2s ease-in-out infinite; }
        .pending-icon svg { width: 40px; height: 40px; color: var(--copilot); }
        @keyframes pendingPulse { 0%, 100% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.05); opacity: 0.8; } }
        .pending-title { font-size: 24px; font-weight: 700; color: var(--text); }
        .pending-subtitle { font-size: 14px; color: var(--text-dim); max-width: 300px; line-height: 1.5; }
        .pending-email { font-size: 13px; color: var(--copilot); font-weight: 500; padding: 8px 16px; background: rgba(255,107,53,0.1); border-radius: 8px; }
        .pending-logout { margin-top: 16px; padding: 10px 24px; background: transparent; border: 1px solid var(--border); border-radius: 8px; color: var(--text-dim); font-size: 13px; cursor: pointer; transition: all 0.2s; }
        .pending-logout:hover { background: rgba(255,255,255,0.05); color: var(--text); }

        /* ==================== MAIN APP ==================== */
        .main-app { height: 100%; }
        .app-header { position: fixed; top: 0; left: 0; right: 0; display: flex; align-items: center; justify-content: center; padding: 12px 16px; padding-top: max(12px, env(safe-area-inset-top)); z-index: 100; background: linear-gradient(180deg, rgba(13,17,23,0.95), transparent); }
        .header-inner { width: 100%; max-width: var(--content-width); display: flex; align-items: center; justify-content: space-between; }
        .header-left { display: flex; align-items: center; }
        .header-logo-svg { height: 20px; color: var(--copilot); }
        .header-logo-svg svg { height: 100%; width: auto; }
        /* BRAND DROPDOWN */
        .brand-pill { display: flex; align-items: center; gap: 6px; padding: 6px 12px; background: var(--card); border: 1px solid var(--border); border-radius: 16px; cursor: pointer; position: relative; }
        .brand-pill-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--assistant); box-shadow: 0 0 6px var(--assistant); }
        .brand-pill.has-brand .brand-pill-dot { display: block; }
        .brand-pill-text { font-size: 11px; font-weight: 500; color: rgba(255,255,255,0.6); }
        .brand-pill-arrow { width: 10px; height: 10px; color: rgba(255,255,255,0.3); transition: transform 0.2s; }
        .brand-pill.open .brand-pill-arrow { transform: rotate(180deg); }
        
        .brand-dropdown { position: absolute; top: calc(100% + 6px); right: 0; min-width: 160px; max-height: 280px; overflow-y: auto; background: rgba(20,24,32,0.98); border: 1px solid var(--border); border-radius: 12px; padding: 6px; display: none; flex-direction: column; gap: 2px; z-index: 200; box-shadow: 0 8px 24px rgba(0,0,0,0.4); backdrop-filter: blur(20px); }
        .brand-dropdown.show { display: flex; }
        .brand-dropdown-item { display: flex; align-items: center; gap: 8px; padding: 8px 12px; border-radius: 8px; cursor: pointer; transition: all 0.2s; }
        .brand-dropdown-item:hover { background: rgba(255,255,255,0.06); }
        .brand-dropdown-item.active { background: rgba(34,197,94,0.15); border: 1px solid rgba(34,197,94,0.3); }
        .brand-dropdown-item.disabled { cursor: default; opacity: 0.35; padding: 6px 12px; }
        .brand-dropdown-item.disabled:hover { background: transparent; }
        .brand-dropdown-dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }
        .brand-dropdown-item.active .brand-dropdown-dot { box-shadow: 0 0 6px currentColor; }
        .brand-dropdown-name { font-size: 12px; font-weight: 500; color: rgba(255,255,255,0.8); flex: 1; }
        .brand-dropdown-item.disabled .brand-dropdown-name { font-size: 11px; color: rgba(255,255,255,0.3); }
        .brand-dropdown-check { width: 14px; height: 14px; color: #22c55e; opacity: 0; }
        .brand-dropdown-item.selected .brand-dropdown-check { opacity: 1; }
        .brand-dropdown-divider { height: 1px; background: var(--border); margin: 4px 0; position: sticky; top: 0; z-index: 1; }

        .app-content { height: 100%; padding-top: calc(56px + env(safe-area-inset-top)); padding-bottom: calc(70px + env(safe-area-inset-bottom)); overflow-y: auto; overflow-x: hidden; display: flex; flex-direction: column; align-items: center; }
        
        /* CENTERED CONTENT CONTAINER */
        .home, .projects-page { 
            width: 100%; 
            max-width: var(--content-width); 
            padding: 16px; 
            display: flex; 
            flex-direction: column; 
            gap: 20px; 
        }

        /* ==================== IMPROVED PROGRESS RING (BIGGER) ==================== */
        .activity-section { text-align: center; margin-bottom: 8px; }
        .activity-ring-container { position: relative; width: 180px; height: 180px; margin: 0 auto 12px; }
        .activity-ring-svg { width: 100%; height: 100%; transform: rotate(-90deg); }
        .ring-bg { fill: none; stroke: rgba(255,255,255,0.04); stroke-width: 11; }
        .ring-progress { fill: none; stroke-width: 11; stroke-linecap: round; stroke-dasharray: 440; stroke-dashoffset: 119; filter: drop-shadow(0 0 8px rgba(34, 197, 94, 0.5)); transition: stroke-dashoffset 1s ease, stroke 0.5s ease; }
        .ring-progress.cold { stroke: url(#coldGradient); filter: drop-shadow(0 0 8px rgba(125, 64, 255, 0.5)); }
        .ring-progress.warm { stroke: url(#warmGradient); filter: drop-shadow(0 0 8px rgba(255, 107, 53, 0.5)); }
        .ring-progress.hot { stroke: url(#hotGradient); filter: drop-shadow(0 0 8px rgba(34, 197, 94, 0.5)); }
        .activity-ring-inner { position: absolute; inset: 28px; border-radius: 50%; background: radial-gradient(circle at 30% 30%, rgba(34,197,94,0.08), transparent 60%); display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .activity-value { font-size: 32px; font-weight: 800; background: linear-gradient(135deg, #22c55e, #4ade80); -webkit-background-clip: text; -webkit-text-fill-color: transparent; line-height: 1; }
        .activity-label { font-size: 9px; font-weight: 600; color: var(--text-dim); text-transform: uppercase; letter-spacing: 1px; margin-top: 2px; }
        
        /* STATUS - NO BACKGROUND, JUST TEXT */
        .activity-status { display: inline-flex; align-items: center; justify-content: center; gap: 6px; }
        .status-fire { font-size: 16px; animation: fireWiggle 0.5s ease-in-out infinite; }
        @keyframes fireWiggle { 0%, 100% { transform: rotate(-5deg); } 50% { transform: rotate(5deg); } }
        .status-text { font-size: 12px; font-weight: 600; color: var(--copilot); text-transform: uppercase; letter-spacing: 1px; }

        /* ==================== GAMIFICATION STATS - FIRE GROWTH ==================== */
        .stats-section {
            text-align: center;
            margin-bottom: 10px !important; /* 10px + 20px gap = 30px total to cards */
        }
        
        .stats-week-label {
            font-size: 11px;
            color: var(--text-dim);
            margin-bottom: 24px;
            text-transform: uppercase;
            letter-spacing: 1.5px;
        }
        
        .stats-ring-container {
            position: relative;
            width: 160px;
            height: 160px;
            margin: 0 auto 28px;
        }
        
        .stats-ring {
            width: 100%;
            height: 100%;
            overflow: visible;
            filter: none;
        }
        
        .stats-ring-bg {
            fill: none;
            stroke: rgba(255,255,255,0.06);
            stroke-width: 10;
        }
        
        .stats-ring-progress {
            fill: none;
            stroke: url(#fireGrowthGradient);
            stroke-width: 10;
            stroke-linecap: round;
            stroke-dasharray: 339.292;
            stroke-dashoffset: 339.292;
            transition: stroke-dashoffset 1s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .stats-ring-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
        }
        
        .stats-ring-percent {
            font-size: 36px;
            font-weight: 800;
            background: linear-gradient(135deg, #EA580C, #FCD34D);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        /* Ring Tooltip */
        .stats-ring-tooltip {
            position: absolute;
            top: calc(100% + 15px);
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.95);
            color: #fff;
            padding: 10px 14px;
            border-radius: 10px;
            font-size: 11px;
            line-height: 1.5;
            width: 240px;
            text-align: center;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.2s, visibility 0.2s;
            z-index: 1000;
            pointer-events: none;
            box-shadow: 0 4px 20px rgba(0,0,0,0.4);
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        .stats-ring-tooltip::before {
            content: '';
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 6px solid transparent;
            border-bottom-color: rgba(0, 0, 0, 0.95);
        }
        
        .stats-ring-container:hover .stats-ring-tooltip {
            opacity: 1;
            visibility: visible;
        }
        
        /* Stats Inline Row */
        .stats-inline {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 16px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }
        
        .stats-item {
            display: flex;
            align-items: baseline;
            gap: 3px;
            position: relative;
            cursor: default;
        }
        
        .stats-item-icon {
            font-size: 16px;
            align-self: center;
        }
        
        .stats-item-value {
            font-size: 15px;
            font-weight: 700;
            color: var(--text);
        }
        
        .stats-item-unit {
            font-size: 12px;
            font-weight: 500;
            color: #FFFFFF;
        }
        
        .stats-item-label {
            font-size: 11px;
            font-weight: 400;
            color: var(--text-dim);
            margin-left: 2px;
        }
        
        .stats-separator {
            width: 1px;
            height: 16px;
            background: rgba(255, 255, 255, 0.1);
            align-self: center;
        }
        
        .stats-message {
            font-size: 13px;
            font-weight: 600;
            color: #22C55E;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        /* Green/neon emoji for "Efficace" level */
        .green-emoji {
            display: inline-block;
            filter: hue-rotate(80deg) saturate(2) brightness(1.3);
            text-shadow: 0 0 10px rgba(34, 197, 94, 0.8), 0 0 20px rgba(34, 197, 94, 0.5);
        }
        
        /* Tooltip for stats explanation */
        .stats-tooltip {
            position: absolute;
            bottom: calc(100% + 10px);
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.95);
            color: #fff;
            padding: 10px 14px;
            border-radius: 10px;
            font-size: 11px;
            line-height: 1.5;
            width: 220px;
            text-align: center;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.2s, visibility 0.2s;
            z-index: 1000;
            pointer-events: none;
            box-shadow: 0 4px 20px rgba(0,0,0,0.4);
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        .stats-tooltip::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 6px solid transparent;
            border-top-color: rgba(0, 0, 0, 0.95);
        }
        
        .stats-item:hover .stats-tooltip {
            opacity: 1;
            visibility: visible;
        }
        
        /* Light theme overrides */
        [data-theme="light"] .stats-ring-bg {
            stroke: rgba(0, 0, 0, 0.08);
        }
        
        [data-theme="light"] .stats-separator {
            background: rgba(0, 0, 0, 0.1);
        }
        
        [data-theme="light"] .stats-tooltip {
            background: rgba(30, 30, 30, 0.98);
        }
        
        [data-theme="light"] .stats-tooltip::after {
            border-top-color: rgba(30, 30, 30, 0.98);
        }

        /* ==================== HOMEPAGE TOGGLE CARDS (V2 STYLE) ==================== */
        .modules-toggle { display: flex; gap: 12px; }
        
        .toggle-card { 
            flex: 1; 
            display: flex; 
            align-items: center; 
            gap: 12px; 
            padding: 18px 16px; 
            border-radius: 14px; 
            cursor: pointer; 
            transition: all 0.3s ease;
            text-decoration: none;
        }
        
        .toggle-card.copilot { 
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .toggle-card.assistant { 
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .toggle-card.copilot:hover { 
            background: rgba(255, 255, 255, 0.12);
            border-color: rgba(255, 255, 255, 0.15);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.25);
            transform: translateY(-2px);
        }
        .toggle-card.assistant:hover { 
            background: rgba(255, 255, 255, 0.12);
            border-color: rgba(255, 255, 255, 0.15);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.25);
            transform: translateY(-2px);
        }
        
        .toggle-card-icon { 
            width: 40px; 
            height: 40px; 
            border-radius: 10px; 
            display: flex; 
            align-items: center; 
            justify-content: center;
            transition: all 0.3s;
            flex-shrink: 0;
        }
        .toggle-card.copilot .toggle-card-icon { background: rgba(255, 255, 255, 0.1); color: var(--copilot); }
        .toggle-card.assistant .toggle-card-icon { background: rgba(255, 255, 255, 0.1); color: var(--assistant); }
        
        .toggle-card-icon .icon { width: 22px; height: 22px; }
        .toggle-card-icon .star-icon { width: 22px; height: 22px; }
        .toggle-card-icon .star-icon svg { fill: currentColor; stroke: none; }
        
        .toggle-card-content { flex: 1; }
        .toggle-card-title { 
            font-size: 16px; 
            font-weight: 600; 
            margin-bottom: 4px;
            transition: color 0.3s;
            color: rgba(255, 255, 255, 0.9);
        }
        .toggle-card.copilot:hover .toggle-card-title { color: white; }
        .toggle-card.assistant:hover .toggle-card-title { color: white; }
        
        .toggle-card-desc { font-size: 11px; color: var(--text-dim); white-space: nowrap; }
        .toggle-card-desc .highlight-copilot { color: rgba(255, 107, 53, 0.7); }
        .toggle-card-desc .highlight-assistant { color: rgba(34, 197, 94, 0.7); }

        .toggle-card-arrow { 
            width: 18px; 
            height: 18px; 
            transition: all 0.3s;
            flex-shrink: 0;
            color: rgba(255, 255, 255, 0.25);
        }
        .toggle-card:hover .toggle-card-arrow { color: rgba(255, 255, 255, 0.5); transform: translateX(4px); }

        /* BRAND CHIPS - Horizontal scrollable single line */
        .brand-select-row { 
            display: flex; 
            align-items: center; 
            gap: 8px; 
            padding: 12px; 
            background: var(--card); 
            border: 1px solid var(--border); 
            border-radius: 12px; 
            flex-wrap: nowrap;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }
        .brand-select-row::-webkit-scrollbar { display: none; }
        .brand-label { font-size: 11px; color: var(--text-dim); flex-shrink: 0; }
        .brand-chip { padding: 6px 12px; background: transparent; border: 1px solid var(--border); border-radius: 14px; font-size: 11px; color: rgba(255,255,255,0.5); cursor: pointer; transition: all 0.2s; flex-shrink: 0; white-space: nowrap; }
        .brand-chip:hover { background: rgba(255,255,255,0.03); }
        .brand-chip.active { background: var(--copilot-bg); border-color: var(--copilot-border); color: var(--copilot); }

        /* SECTION HEADERS */
        .sec-head { display: flex; align-items: center; gap: 8px; margin-bottom: 10px; }
        .sec-title { font-size: 10px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-dim); }
        .sec-line { flex: 1; height: 1px; background: var(--border); }

        /* PROJECTS LIST */
        .projects { display: flex; flex-direction: column; gap: 10px; }
        .proj { display: flex; align-items: center; gap: 12px; padding: 14px 14px 14px 18px; background: var(--card); border: 1px solid var(--border); border-radius: 12px; cursor: pointer; transition: all 0.2s; -webkit-user-select: none; user-select: none; -webkit-touch-callout: none; position: relative; overflow: hidden; min-height: 64px; }
        .proj::before { content: ''; position: absolute; left: 0; top: 12px; bottom: 12px; width: 3px; border-radius: 0 2px 2px 0; }
        .proj.copilot-bar::before { background: var(--copilot); }
        .proj.assistant-bar::before { background: var(--assistant); }
        .proj.both-bar::before { background: linear-gradient(180deg, var(--copilot) 0%, var(--assistant) 100%); }
        .proj:hover { background: rgba(255,255,255,0.04); border-color: rgba(255,255,255,0.15); }
        .proj-icons { display: flex; align-items: center; position: relative; width: 36px; height: 36px; flex-shrink: 0; }
        .proj-icons.dual { width: 44px; height: 40px; }
        .proj-icon { width: 36px; height: 36px; border-radius: 10px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
        .proj-icon.copilot { background: var(--copilot-bg); color: var(--copilot); }
        .proj-icon.assistant { background: var(--assistant-bg); color: var(--assistant); }
        .proj-icon .icon { width: 16px; height: 16px; }
        .proj-icon .star-icon { width: 18px; height: 18px; }
        .proj-icon .star-icon svg { fill: currentColor; stroke: none; }
        .proj-icons .proj-icon.back { position: absolute; top: 0; left: 0; width: 32px; height: 32px; border-radius: 8px; }
        .proj-icons .proj-icon.back .icon { width: 14px; height: 14px; }
        .proj-icons .proj-icon.back .star-icon { width: 16px; height: 16px; }
        .proj-icons .proj-icon.front { position: absolute; bottom: 0; right: 0; width: 32px; height: 32px; border-radius: 8px; box-shadow: -2px -2px 8px rgba(0,0,0,0.3); }
        .proj-icons .proj-icon.front .icon { width: 14px; height: 14px; }
        .proj-info { flex: 1; min-width: 0; }
        .proj-title { font-size: 13px; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-bottom: 4px; }
        .proj-meta { font-size: 11px; color: var(--text-dim); }
        .proj-time { font-size: 11px; color: rgba(255,255,255,0.25); }
        
        /* PROJECT CONTEXT MENU */
        .project-context-menu {
            position: fixed;
            background: rgba(30,35,44,0.98);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 6px;
            min-width: 160px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.4);
            z-index: 10000;
            display: none;
        }
        .project-context-menu.show { display: block; }
        .context-menu-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            color: rgba(255,255,255,0.85);
            transition: all 0.15s;
        }
        .context-menu-item:hover { background: rgba(255,255,255,0.08); }
        .context-menu-item .icon { width: 16px; height: 16px; color: rgba(255,255,255,0.5); }
        .context-menu-item:hover .icon { color: rgba(255,255,255,0.8); }
        .context-menu-item.delete { color: #ef4444; }
        .context-menu-item.delete .icon { color: #ef4444; }
        .context-menu-item.delete:hover { background: rgba(239,68,68,0.15); }
        [data-theme="light"] .project-context-menu { background: rgba(255,255,255,0.98); border-color: rgba(0,0,0,0.08); }
        [data-theme="light"] .context-menu-item { color: #374151; }
        [data-theme="light"] .context-menu-item:hover { background: rgba(0,0,0,0.05); }
        [data-theme="light"] .context-menu-item .icon { color: rgba(0,0,0,0.4); }
        
        /* RENAME MODAL */
        .rename-modal {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.6);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10001;
        }
        .rename-modal.show { display: flex; }
        .rename-modal-content {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 24px;
            width: 90%;
            max-width: 360px;
        }
        .rename-modal-title { font-size: 16px; font-weight: 600; margin-bottom: 16px; }
        .rename-modal-input {
            width: 100%;
            padding: 12px;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text);
            font-size: 14px;
            margin-bottom: 16px;
        }
        .rename-modal-input:focus { outline: none; border-color: var(--assistant); }
        .rename-modal-buttons { display: flex; gap: 10px; justify-content: flex-end; }
        .rename-modal-btn {
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            border: none;
        }
        .rename-modal-btn.cancel { background: var(--bg); color: var(--text-dim); }
        .rename-modal-btn.save { background: var(--assistant); color: white; }

        /* 
           CONNECT VIEW STYLES
            */
        .connect-view {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: var(--bg);
            z-index: 200;
            display: none;
            flex-direction: row;
        }
        .connect-view.active { display: flex; }
        .connect-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transition: all 0.3s;
        }
        .connect-view.drawer-open .connect-content { flex: 0 0 50%; max-width: 50%; }
        @media (max-width: 700px) { .connect-view.drawer-open .connect-content { flex: 0 0 100%; max-width: 100%; opacity: 0.3; pointer-events: none; } }
        .connect-content-inner { max-width: 520px; margin: 0 auto; padding: 0 16px; }
        .connect-header { display: flex; align-items: center; gap: 12px; padding: 14px 16px; padding-top: max(14px, calc(env(safe-area-inset-top) + 6px)); flex-shrink: 0; border-bottom: 1px solid var(--border); background: var(--bg-secondary); }
        .connect-header-back { width: 32px; height: 32px; border-radius: 50%; background: var(--card); border: 1px solid var(--border); display: flex; align-items: center; justify-content: center; cursor: pointer; color: var(--text-dim); }
        .connect-header-back svg { width: 16px; height: 16px; }
        .connect-header-info { flex: 1; }
        .connect-header-title { font-size: 16px; font-weight: 600; display: flex; align-items: center; gap: 8px; }
        .connect-header-sub { font-size: 11px; color: var(--text-dim); margin-top: 2px; }
        .connect-online-dot { width: 8px; height: 8px; background: var(--assistant); border-radius: 50%; animation: pulse 2s infinite; }
        .connect-body { flex: 1; overflow-y: auto; padding: 16px 0; }

        /* Connect Drawer */
        .connect-drawer { position: fixed; top: 0; right: 0; width: 50%; height: 100%; background: var(--bg-secondary); border-left: 1px solid var(--border); display: flex; flex-direction: column; transform: translateX(100%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); z-index: 210; }
        .connect-view.drawer-open .connect-drawer { transform: translateX(0); }
        @media (max-width: 700px) { .connect-drawer { width: 100%; } }
        .connect-drawer-header { display: flex; align-items: center; gap: 12px; padding: 14px 16px; padding-top: max(14px, calc(env(safe-area-inset-top) + 6px)); border-bottom: 1px solid var(--border); flex-shrink: 0; }
        .connect-drawer-close { width: 32px; height: 32px; border-radius: 50%; background: var(--card); border: 1px solid var(--border); display: flex; align-items: center; justify-content: center; cursor: pointer; color: var(--text-dim); transition: all 0.2s; }
        .connect-drawer-close:hover { background: rgba(255,255,255,0.05); color: var(--text); }
        .connect-drawer-close svg { width: 16px; height: 16px; }
        .connect-drawer-info { flex: 1; }
        .connect-drawer-title { font-size: 14px; font-weight: 600; }
        .connect-drawer-subtitle { font-size: 11px; color: var(--text-dim); margin-top: 2px; }
        .connect-drawer-body { flex: 1; overflow-y: auto; padding: 16px; }
        .connect-drawer-footer { display: flex; gap: 10px; padding: 16px; border-top: 1px solid var(--border); }
        .connect-drawer-btn { flex: 1; padding: 12px; border-radius: 10px; font-size: 12px; font-weight: 600; cursor: pointer; transition: all 0.2s; border: none; }
        .connect-drawer-btn.secondary { background: var(--card); color: var(--text); border: 1px solid var(--border); }
        .connect-drawer-btn.primary { background: var(--connect); color: white; }
        .connect-drawer-btn.danger { background: rgba(239, 68, 68, 0.1); color: #ef4444; border: 1px solid rgba(239, 68, 68, 0.2); }

        /* Connect Promo */
        .connect-promo { max-width: 380px; margin: 40px auto 0; text-align: center; }
        .connect-promo-icon { width: 64px; height: 64px; margin: 0 auto 16px; background: var(--connect-bg); border: 1px solid var(--connect-border); border-radius: 16px; display: flex; align-items: center; justify-content: center; }
        .connect-promo-icon svg { width: 32px; height: 32px; color: var(--connect); }
        .connect-promo-title { font-size: 18px; font-weight: 700; margin-bottom: 8px; }
        .connect-promo-desc { font-size: 12px; color: var(--text-dim); line-height: 1.5; margin-bottom: 20px; }
        .connect-promo-features { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; text-align: left; margin-bottom: 20px; }
        .connect-promo-feat { display: flex; align-items: center; gap: 8px; padding: 10px; background: var(--card); border: 1px solid var(--border); border-radius: 8px; font-size: 11px; }
        .connect-promo-feat svg { width: 14px; height: 14px; color: var(--connect); flex-shrink: 0; }
        .connect-btn-activate { width: 100%; padding: 12px 20px; background: var(--connect); color: white; border: none; border-radius: 10px; font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .connect-btn-activate:hover { filter: brightness(1.1); }
        .connect-btn-badge { font-size: 9px; padding: 2px 6px; background: rgba(255,255,255,0.2); border-radius: 3px; }
        .connect-promo-note { font-size: 10px; color: var(--text-dim); margin-top: 10px; }

        /* Connect Stats Bar */
        .connect-stats-bar { display: flex; gap: 8px; margin-bottom: 16px; }
        .connect-stat-pill { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 4px; padding: 14px 8px; background: var(--card); border: 1px solid var(--border); border-radius: 12px; }
        .connect-stat-pill.highlight { background: var(--connect-bg); border-color: var(--connect-border); }
        .connect-stat-val { font-size: 15px; font-weight: 700; }
        .connect-stat-pill.highlight .connect-stat-val { color: var(--connect); }
        .connect-stat-lbl { font-size: 9px; color: var(--text-dim); }

        /* Connect Section Headers */
        .connect-sec { margin-bottom: 16px; }
        .connect-sec-head { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; }
        .connect-sec-title { font-size: 10px; font-weight: 600; color: var(--text-dim); text-transform: uppercase; letter-spacing: 0.5px; }
        .connect-sec-line { flex: 1; height: 1px; background: var(--border); }
        .connect-sec-badge { font-size: 9px; padding: 3px 8px; background: var(--connect-bg); color: var(--connect); border-radius: 8px; font-weight: 500; }

        /* Job Cards */
        .connect-jobs-list { display: flex; flex-direction: column; gap: 10px; }
        .connect-job-card { display: flex; align-items: center; gap: 12px; padding: 14px 14px 14px 18px; background: var(--card); border: 1px solid var(--border); border-radius: 12px; cursor: pointer; transition: all 0.2s; position: relative; overflow: hidden; min-height: 64px; }
        .connect-job-card::before { content: ''; position: absolute; left: 0; top: 12px; bottom: 12px; width: 3px; border-radius: 0 2px 2px 0; }
        .connect-job-card.urgent::before { background: #ef4444; }
        .connect-job-card.new::before { background: var(--connect); }
        .connect-job-card.scheduled::before { background: var(--assistant); }
        .connect-job-card.progress::before { background: var(--copilot); }
        .connect-job-card:hover { background: rgba(255,255,255,0.04); border-color: rgba(255,255,255,0.15); }
        .connect-job-tag { font-size: 9px; font-weight: 600; padding: 4px 8px; border-radius: 4px; text-transform: uppercase; letter-spacing: 0.3px; flex-shrink: 0; }
        .connect-job-tag.urgent { background: rgba(239, 68, 68, 0.12); color: #ef4444; }
        .connect-job-tag.new { background: var(--connect-bg); color: var(--connect); }
        .connect-job-tag.scheduled { background: var(--assistant-bg); color: var(--assistant); }
        .connect-job-tag.progress { background: var(--copilot-bg); color: var(--copilot); }
        .connect-job-body { flex: 1; min-width: 0; }
        .connect-job-name { font-size: 13px; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-bottom: 4px; }
        .connect-job-detail { font-size: 11px; color: var(--text-dim); display: flex; align-items: center; gap: 8px; }
        .connect-job-price { font-size: 13px; font-weight: 600; color: var(--assistant); flex-shrink: 0; }
        .connect-job-arrow { color: var(--text-dim); flex-shrink: 0; }
        .connect-job-arrow svg { width: 14px; height: 14px; }

        /* Connect Drawer Detail Sections */
        .connect-detail-section { margin-bottom: 20px; }
        .connect-detail-label { font-size: 10px; font-weight: 600; color: var(--text-dim); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px; }
        .connect-detail-card { background: var(--card); border: 1px solid var(--border); border-radius: 10px; padding: 12px; }
        .connect-detail-row { display: flex; align-items: center; gap: 10px; padding: 8px 0; }
        .connect-detail-row:not(:last-child) { border-bottom: 1px solid var(--border); }
        .connect-detail-row svg { width: 16px; height: 16px; color: var(--text-dim); flex-shrink: 0; }
        .connect-detail-text { flex: 1; font-size: 13px; }
        .connect-detail-text small { display: block; font-size: 11px; color: var(--text-dim); margin-top: 2px; }
        .connect-detail-desc { font-size: 13px; line-height: 1.5; color: var(--text-dim); }
        .connect-price-big { font-size: 24px; font-weight: 700; color: var(--assistant); }
        .connect-price-note { font-size: 11px; color: var(--text-dim); margin-top: 4px; }

        /* 
           CALENDAR STYLES
            */
        .calendar-card { background: var(--card); border: 1px solid var(--border); border-radius: 16px; padding: 14px; }
        .calendar-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; }
        .calendar-title-row { display: flex; align-items: center; gap: 8px; }
        .calendar-title { font-size: 14px; font-weight: 600; }
        .calendar-tabs { display: flex; gap: 4px; }
        .calendar-tab { padding: 5px 10px; border-radius: 6px; font-size: 10px; font-weight: 500; cursor: pointer; color: var(--text-dim); background: transparent; border: none; transition: all 0.2s; }
        .calendar-tab:hover { color: var(--text); }
        .calendar-tab.active { background: var(--copilot-bg); color: var(--copilot); }
        .calendar-nav { display: flex; gap: 4px; }
        .calendar-nav-btn { width: 28px; height: 28px; border-radius: 6px; background: rgba(255,255,255,0.04); border: 1px solid var(--border); display: flex; align-items: center; justify-content: center; cursor: pointer; color: var(--text-dim); }
        .calendar-nav-btn:hover { background: rgba(255,255,255,0.08); color: var(--text); }
        .calendar-nav-btn svg { width: 14px; height: 14px; }

        /* Calendar Grid (Month View) */
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; min-height: 280px; }
        .calendar-day-header { font-size: 9px; font-weight: 600; color: var(--text-dim); text-align: center; padding: 6px 0; }
        .calendar-day { aspect-ratio: 1; display: flex; align-items: center; justify-content: center; font-size: 11px; border-radius: 6px; cursor: pointer; position: relative; color: var(--text-dim); }
        .calendar-day:hover { background: rgba(255,255,255,0.06); }
        .calendar-day.today { background: var(--copilot-bg); color: var(--copilot); font-weight: 600; }
        .calendar-day.other-month { opacity: 0.3; }
        .calendar-day.has-events::after { content: ''; position: absolute; bottom: 3px; left: 50%; transform: translateX(-50%); width: 4px; height: 4px; background: var(--copilot); border-radius: 50%; }
        .calendar-day.connect-avail { border: 1px dashed var(--connect); }

        /* Calendar Daily View */
        .calendar-daily { display: flex; flex-direction: column; gap: 2px; min-height: 280px; max-height: 280px; overflow-y: auto; }
        .daily-slot { display: flex; gap: 8px; min-height: 36px; }
        .daily-time { width: 40px; font-size: 10px; color: var(--text-dim); padding-top: 4px; flex-shrink: 0; }
        .daily-content { flex: 1; border-radius: 0 6px 6px 0; padding: 4px 8px; cursor: pointer; min-height: 28px; border: 1px solid transparent; border-left: none; -webkit-user-select: none; user-select: none; -webkit-touch-callout: none; }
        .daily-content:hover { background: rgba(255,255,255,0.04); }
        .daily-content.has-event { border-left: 3px solid var(--copilot); background: var(--copilot-bg); border-radius: 0 6px 6px 0; }
        .daily-content.has-event.assistant { border-left-color: var(--assistant); background: var(--assistant-bg); }
        .daily-content.has-event.connect { border-left-color: var(--connect); background: var(--connect-bg); }
        .daily-content.has-event.personal { border-left-color: #8b5cf6; background: rgba(139,92,246,0.08); }
        .daily-content.has-event.pending { border-left-color: var(--text-dim); background: rgba(255,255,255,0.04); }
        .daily-event-title { font-size: 11px; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .daily-event-meta { font-size: 9px; color: var(--text-dim); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* Calendar Week View */
        .calendar-week-wrapper { overflow-x: auto; min-height: 280px; }
        .calendar-week { display: grid; grid-template-columns: 35px repeat(7, 1fr); gap: 2px; min-width: 320px; }
        .week-header-cell { text-align: center; padding: 6px 2px; cursor: pointer; border-radius: 6px; }
        .week-header-cell:hover { background: rgba(255,255,255,0.04); }
        .week-header-cell.today { background: var(--copilot-bg); }
        .week-header-cell .day-num { font-size: 14px; font-weight: 600; }
        .week-header-cell.today .day-num { color: var(--copilot); }
        .week-header-cell > div:last-child { font-size: 9px; color: var(--text-dim); }
        .week-time-label { font-size: 9px; color: var(--text-dim); display: flex; align-items: center; justify-content: center; }
        .week-slot { min-height: 115px; background: rgba(255,255,255,0.02); border-radius: 4px; padding: 3px; display: flex; flex-direction: column; gap: 2px; cursor: pointer; }
        .week-slot:hover { background: rgba(255,255,255,0.04); }
        .week-slot-event { font-size: 9px; padding: 3px 5px; border-radius: 0 3px 3px 0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; cursor: pointer; -webkit-user-select: none; user-select: none; -webkit-touch-callout: none; }
        .week-slot-event.copilot { background: var(--copilot-bg); color: var(--copilot); border-left: 2px solid var(--copilot); }
        .week-slot-event.assistant { background: var(--assistant-bg); color: var(--assistant); border-left: 2px solid var(--assistant); }
        .week-slot-event.connect { background: var(--connect-bg); color: var(--connect); border-left: 2px solid var(--connect); }
        .week-slot-event.pending { background: rgba(255,255,255,0.04); color: var(--text-dim); border-left: 2px solid var(--text-dim); }
        .week-slot-event.personal { background: rgba(139,92,246,0.1); color: #8b5cf6; border-left: 2px solid #8b5cf6; }

        /* 
           EVENT DRAWER STYLES
            */
        .event-drawer-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 10001;
            display: none;
        }
        .event-drawer-overlay.show { display: block; }
        
        .event-drawer {
            position: fixed;
            top: 0; right: 0;
            width: 50%;
            height: 100%;
            background: var(--bg-secondary);
            border-left: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            transform: translateX(100%);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 10002;
        }
        .event-drawer.show { transform: translateX(0); }
        @media (max-width: 700px) { .event-drawer { width: 100%; } }
        
        .event-drawer-header {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 16px;
            padding-top: max(14px, calc(env(safe-area-inset-top) + 6px));
            border-bottom: 1px solid var(--border);
            flex-shrink: 0;
        }
        .event-drawer-close {
            width: 32px; height: 32px;
            border-radius: 50%;
            background: var(--card);
            border: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: var(--text-dim);
            transition: all 0.2s;
        }
        .event-drawer-close:hover { background: rgba(255,255,255,0.05); color: var(--text); }
        .event-drawer-close svg { width: 16px; height: 16px; }
        .event-drawer-info { flex: 1; }
        .event-drawer-title { font-size: 14px; font-weight: 600; }
        .event-drawer-subtitle { font-size: 11px; color: var(--text-dim); margin-top: 2px; }
        
        .event-drawer-body { flex: 1; overflow-y: auto; padding: 16px; }
        
        .event-drawer-footer {
            display: flex;
            gap: 10px;
            padding: 16px;
            border-top: 1px solid var(--border);
        }
        .event-drawer-btn {
            flex: 1;
            padding: 12px;
            border-radius: 10px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
        }
        .event-drawer-btn.secondary { background: var(--card); color: var(--text); border: 1px solid var(--border); }
        .event-drawer-btn.primary { background: var(--copilot); color: white; }
        
        /* Event Form Fields */
        .event-section { margin-bottom: 20px; }
        .event-section-title { 
            font-size: 10px; 
            font-weight: 600; 
            color: var(--text-dim); 
            text-transform: uppercase; 
            letter-spacing: 0.5px; 
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .event-section-line { flex: 1; height: 1px; background: var(--border); }
        
        .event-field { margin-bottom: 12px; }
        .event-field-label { font-size: 11px; font-weight: 500; color: var(--text-dim); margin-bottom: 6px; }
        .event-field-input {
            width: 100%;
            padding: 10px 12px;
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text);
            font-size: 13px;
        }
        .event-field-input:focus { outline: none; border-color: var(--copilot); }
        .event-field-input::placeholder { color: var(--text-dim); }
        
        .event-field-textarea {
            width: 100%;
            padding: 10px 12px;
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text);
            font-size: 13px;
            min-height: 60px;
            resize: vertical;
            font-family: inherit;
        }
        .event-field-textarea:focus { outline: none; border-color: var(--copilot); }
        
        .event-field-row { display: flex; gap: 10px; }
        .event-field-row .event-field { flex: 1; margin-bottom: 0; }
        
        .event-field-select {
            width: 100%;
            padding: 10px 12px;
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text);
            font-size: 13px;
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%23999' stroke-width='2'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 10px center;
        }
        .event-field-select:focus { outline: none; border-color: var(--copilot); }
        
        /* All Day Toggle Row */
        .event-toggle-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 12px;
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 8px;
            margin-bottom: 12px;
        }
        .event-toggle-label { font-size: 13px; }
        .event-toggle {
            width: 40px; height: 22px;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 11px;
            position: relative;
            cursor: pointer;
            transition: all 0.2s;
        }
        .event-toggle.active { background: var(--copilot); border-color: var(--copilot); }
        .event-toggle::after {
            content: '';
            position: absolute;
            top: 2px; left: 2px;
            width: 16px; height: 16px;
            background: white;
            border-radius: 50%;
            transition: transform 0.2s;
        }
        .event-toggle.active::after { transform: translateX(18px); }
        
        /* Type Pills - Same style as Connect job tags */
        .event-type-pills { display: flex; gap: 8px; flex-wrap: wrap; }
        .event-type-pill {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 10px;
            border-radius: 6px;
            font-size: 10px;
            font-weight: 600;
            cursor: pointer;
            background: var(--card);
            border: 1px solid var(--border);
            color: var(--text-dim);
            transition: all 0.2s;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }
        .event-type-pill .pill-icon { width: 14px; height: 14px; display: flex; align-items: center; justify-content: center; }
        .event-type-pill .pill-icon svg { width: 12px; height: 12px; }
        .event-type-pill:hover { border-color: rgba(255,255,255,0.2); }
        .event-type-pill.active.copilot { background: var(--copilot-bg); border-color: var(--copilot); color: var(--copilot); }
        .event-type-pill.active.assistant { background: var(--assistant-bg); border-color: var(--assistant); color: var(--assistant); }
        .event-type-pill.active.connect { background: var(--connect-bg); border-color: var(--connect); color: var(--connect); }
        .event-type-pill.active.personal { background: rgba(139,92,246,0.1); border-color: #8b5cf6; color: #8b5cf6; }
        
        /* More Options */
        .event-more-toggle {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            padding: 10px;
            color: var(--text-dim);
            font-size: 11px;
            cursor: pointer;
            transition: color 0.2s;
            margin-top: 8px;
        }
        .event-more-toggle:hover { color: var(--text); }
        .event-more-toggle svg { width: 12px; height: 12px; transition: transform 0.2s; }
        .event-more-toggle.expanded svg { transform: rotate(180deg); }
        .event-more-options { display: none; margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border); }
        .event-more-options.show { display: block; }

        /*  EVENT CONTEXT MENU (Right-click)  */
        .event-context-menu {
            position: fixed;
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 6px;
            min-width: 140px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.3);
            z-index: 10003;
            display: none;
        }
        .event-context-menu.show { display: block; }
        .event-context-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            border-radius: 6px;
            font-size: 13px;
            cursor: pointer;
            color: var(--text);
            transition: background 0.15s;
        }
        .event-context-item:hover { background: rgba(255,255,255,0.06); }
        .event-context-item svg { width: 16px; height: 16px; color: var(--text-dim); }
        .event-context-item.delete { color: #ef4444; }
        .event-context-item.delete svg { color: #ef4444; }
        .event-context-item.delete:hover { background: rgba(239,68,68,0.1); }

        /* NAV WITH CENTERED HOTLINE SPHERE */
        .nav { 
            position: fixed; 
            bottom: 0; 
            bottom: env(safe-area-inset-bottom, 0px);
            left: 50%; 
            transform: translateX(-50%); 
            width: calc(100% - 16px); 
            max-width: 580px; 
            display: flex; 
            justify-content: center; 
            padding: 6px 16px; 
            padding-bottom: max(10px, env(safe-area-inset-bottom, 10px)); 
            background: rgba(30,35,44,0.98); 
            backdrop-filter: blur(20px); 
            -webkit-backdrop-filter: blur(20px);
            z-index: 99999; 
            border-top: 1px solid var(--border); 
            border-left: 1px solid var(--border); 
            border-right: 1px solid var(--border); 
            border-radius: 14px 14px 0 0;
        }
        /* HIDE nav when chat is open */
        .chat-view.active ~ .nav { display: none !important; }
        .nav-inner { width: 100%; display: flex; justify-content: space-around; align-items: flex-end; }
        .nav-item { display: flex; flex-direction: column; align-items: center; gap: 2px; padding: 5px 16px; color: rgba(255,255,255,0.3); cursor: pointer; transition: color 0.2s; }
        .nav-item:hover { color: rgba(255,255,255,0.5); }
        .nav-item.active { color: var(--copilot); }
        .nav-icon { width: 20px; height: 20px; }
        .nav-label { font-size: 10px; font-weight: 500; }

        .nav-hotline { display: flex; flex-direction: column; align-items: center; gap: 2px; padding: 5px 16px; color: rgba(255,255,255,0.3); cursor: pointer; transition: color 0.2s; }
        .nav-hotline:hover { color: rgba(255,255,255,0.5); }
        .nav-hotline .nav-icon { width: 20px; height: 20px; }
        .nav-hotline-waves { display: flex; align-items: center; justify-content: center; gap: 2px; width: 20px; height: 20px; }
        .nav-hotline-waves .wave-bar { width: 3px; background: currentColor; border-radius: 2px; animation: navWave 1s ease-in-out infinite; }
        .nav-hotline-waves .wave-bar:nth-child(1) { height: 6px; animation-delay: 0s; }
        .nav-hotline-waves .wave-bar:nth-child(2) { height: 12px; animation-delay: 0.1s; }
        .nav-hotline-waves .wave-bar:nth-child(3) { height: 18px; animation-delay: 0.2s; }
        .nav-hotline-waves .wave-bar:nth-child(4) { height: 12px; animation-delay: 0.3s; }
        .nav-hotline-waves .wave-bar:nth-child(5) { height: 6px; animation-delay: 0.4s; }
        @keyframes navWave { 0%, 100% { transform: scaleY(0.6); } 50% { transform: scaleY(1); } }

        /* ==================== PROJECTS PAGE ==================== */
        .projects-page { display: none; flex-direction: column; height: 100%; position: relative; }
        .projects-page.active { display: flex; }
        .projects-page-header { 
            margin-bottom: 0; 
            position: sticky; 
            top: 0; 
            background: transparent;
            padding-top: 8px; 
            padding-bottom: 16px; 
            z-index: 10; 
        }
        /* Gradient fade effect below header */
        .projects-page-header::after {
            content: '';
            position: absolute;
            left: -20px;
            right: -20px;
            bottom: -50px;
            height: 50px;
            background: linear-gradient(to bottom, var(--bg) 0%, var(--bg) 20%, transparent 100%);
            pointer-events: none;
            z-index: 9;
        }
        .projects-page-title { font-size: 18px; font-weight: 600; margin-bottom: 4px; }
        .projects-page-sub { font-size: 12px; color: var(--text-dim); }
        .projects-list { 
            display: flex; 
            flex-direction: column; 
            gap: 10px; 
            flex: 1; 
            overflow-y: auto; 
            padding-top: 10px;
            padding-bottom: calc(90px + env(safe-area-inset-bottom));
            /* Hide scrollbar completely */
            scrollbar-width: none;
            -ms-overflow-style: none;
        }
        .projects-list::-webkit-scrollbar {
            display: none;
        }

        /* ==================== CHAT VIEW (FULL WIDTH) ==================== */
        .chat-view { 
            position: fixed; 
            top: 0;
            left: 0;
            right: 0;
            bottom: 0; /* Full screen - nav is hidden when chat is open */
            display: none; 
            z-index: 200; 
            background: var(--bg); 
            background-image: linear-gradient(var(--grid-color) 1px, transparent 1px), linear-gradient(90deg, var(--grid-color) 1px, transparent 1px); 
            background-size: 32px 32px;
            overflow: hidden;
        }
        .chat-view.active { display: flex; }
        .chat-view.single { flex-direction: column; }
        .chat-view.split { flex-direction: row; }
        @media (max-width: 767px) { 
            .chat-view.split { flex-direction: column; }
        }

        .panel { 
            display: flex; 
            flex-direction: column; 
            flex: 1; 
            min-width: 0; 
            min-height: 0; 
            overflow: hidden;
            position: relative;
        }
        .panel.copilot { --mode-color: var(--copilot); --mode-glow: var(--copilot-glow); --mode-bg: var(--copilot-bg); --mode-border: var(--copilot-border); }
        .panel.assistant { --mode-color: var(--assistant); --mode-glow: var(--assistant-glow); --mode-bg: var(--assistant-bg); --mode-border: var(--assistant-border); }

        .panel-header { display: flex; align-items: center; gap: 8px; padding: 10px 12px; padding-top: max(10px, env(safe-area-inset-top)); flex-shrink: 0; border-bottom: 1px solid var(--border); background: var(--bg-secondary); }
        .chat-view.split .panel-header { padding-top: 10px; }
        .panel-back { width: 32px; height: 32px; border-radius: 50%; background: var(--card); border: 1px solid var(--border); color: rgba(255,255,255,0.5); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; flex-shrink: 0; }
        .panel-back:hover { background: rgba(255,255,255,0.05); color: rgba(255,255,255,0.8); }
        .panel-back .icon { width: 14px; height: 14px; }
        .panel-info { flex: 1; min-width: 0; display: flex; align-items: center; gap: 8px; }
        .panel-title { font-size: 13px; font-weight: 600; color: var(--mode-color); }
        .panel-separator { width: 1px; height: 12px; background: rgba(255,255,255,0.15); }
        .panel-brand { font-size: 12px; color: var(--text-dim); }
        .panel-project { font-size: 11px; color: var(--text-dim); opacity: 0.7; max-width: 120px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* CLICKABLE BRAND TAG IN CHAT HEADER - No chip, original style */
        .panel-brand-wrapper { position: relative; display: flex; align-items: center; }
        .panel-brand-btn {
            display: flex;
            align-items: center;
            gap: 4px;
            cursor: pointer;
            transition: all 0.2s;
            background: none;
            border: none;
            padding: 0;
        }
        .panel-brand-btn .panel-brand-text {
            font-size: 12px;
            color: var(--text-dim);
            transition: color 0.2s;
        }
        .panel-brand-btn:hover .panel-brand-text {
            color: #fff;
        }
        .panel-brand-btn .brand-arrow {
            width: 10px;
            height: 10px;
            color: var(--text-dim);
            opacity: 0.6;
            transition: all 0.2s;
        }
        .panel-brand-btn:hover .brand-arrow {
            color: #fff;
            opacity: 1;
        }
        .panel-brand-wrapper.open .brand-arrow {
            transform: rotate(180deg);
        }
        .panel-brand-dropdown {
            position: absolute;
            top: calc(100% + 8px);
            left: 0;
            min-width: 180px;
            background: rgba(30, 32, 38, 0.95);
            border: 1px solid rgba(255,255,255,0.15);
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.5);
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-8px);
            transition: all 0.2s;
            max-height: 320px;
            overflow-y: auto;
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
        }
        .panel-brand-wrapper.open .panel-brand-dropdown {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }
        .panel-brand-option {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 11px 14px;
            cursor: pointer;
            transition: background 0.15s;
            font-size: 13px;
            color: rgba(255,255,255,0.7);
        }
        .panel-brand-option:first-child { border-radius: 11px 11px 0 0; }
        .panel-brand-option:last-child { border-radius: 0 0 11px 11px; }
        .panel-brand-option:hover {
            background: rgba(255,255,255,0.08);
            color: #fff;
        }
        .panel-brand-option.selected {
            background: var(--mode-bg);
            color: var(--mode-color);
        }
        .panel-brand-option .brand-check {
            width: 14px;
            height: 14px;
            opacity: 0;
            color: var(--mode-color);
            flex-shrink: 0;
        }
        .panel-brand-option.selected .brand-check {
            opacity: 1;
        }

        /* MODE TOGGLE */
        .mode-toggle { display: flex; background: var(--card); border: 1px solid var(--border); border-radius: 8px; overflow: hidden; flex-shrink: 0; height: 32px; }
        .mode-btn { display: flex; align-items: center; justify-content: center; gap: 5px; padding: 0 10px; font-size: 10px; font-weight: 500; color: rgba(255,255,255,0.35); cursor: pointer; transition: all 0.2s; border-right: 1px solid var(--border); }
        .mode-btn:last-child { border-right: none; }
        .mode-btn .mode-icon { width: 16px; height: 16px; opacity: 0.5; display: flex; align-items: center; justify-content: center; }
        .mode-btn .mode-icon svg { width: 100%; height: 100%; }
        .mode-btn .mode-icon.star-icon svg { fill: currentColor; stroke: none; }
        .mode-btn .mode-icon.clip-icon svg { fill: none; stroke: currentColor; stroke-width: 1.5; }
        
        .mode-btn.copilot.active { background: var(--copilot-bg); color: var(--copilot); }
        .mode-btn.copilot.active .mode-icon { opacity: 1; color: var(--copilot); }
        .mode-btn.assistant.active { background: var(--assistant-bg); color: var(--assistant); }
        .mode-btn.assistant.active .mode-icon { opacity: 1; color: var(--assistant); }

        .header-actions { display: flex; gap: 6px; flex-shrink: 0; }
        .h-btn { width: 32px; height: 32px; border-radius: 8px; background: var(--card); border: 1px solid var(--border); color: rgba(255,255,255,0.5); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
        .h-btn:hover { background: rgba(255,255,255,0.05); color: rgba(255,255,255,0.8); }
        .h-btn.active { background: var(--mode-bg); border-color: var(--mode-border); color: var(--mode-color); }
        .h-btn .icon { width: 14px; height: 14px; display: flex; align-items: center; justify-content: center; }
        .h-btn .icon svg { width: 100%; height: 100%; stroke: currentColor; }
        
        /* Report button in header - same style as other buttons */
        .header-actions .h-btn.report-btn { display: none; } /* Hidden by default (Copilot) */
        .panel.assistant .header-actions .h-btn.report-btn { display: flex; } /* Visible in Assistant */

        .chat-body { 
            flex: 1; 
            overflow-y: auto; 
            overflow-x: hidden;
            padding: 14px; 
            display: flex; 
            flex-direction: column; 
            gap: 10px; 
            min-height: 0;
            -webkit-overflow-scrolling: touch;
        }
        .msg { max-width: 90%; animation: msgIn 0.3s ease; }
        @keyframes msgIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
        .msg.user { align-self: flex-end; max-width: 80%; }
        .msg.ai { align-self: flex-start; }
        
        /* Report messages - normal bubble with card inside */
        .msg.ai.report { max-width: 98%; width: 98%; }
        
        /* Report card inside the bubble */
        .report-card {
            background: #1E1E2E;
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: 16px;
            padding: 16px 24px 20px 24px;
            margin-top: 12px;
            line-height: 1.5;
            position: relative;
        }
        /* Report card menu */
        .report-menu {
            position: absolute;
            top: 12px;
            right: 12px;
            z-index: 10;
        }
        .report-menu-btn {
            width: 28px;
            height: 28px;
            border-radius: 8px;
            background: transparent;
            border: none;
            color: rgba(255,255,255,0.4);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        .report-menu-btn:hover {
            background: rgba(255,255,255,0.08);
            color: rgba(255,255,255,0.8);
        }
        .report-menu-btn .icon {
            width: 16px;
            height: 16px;
        }
        .report-menu-dropdown {
            position: absolute;
            top: calc(100% + 4px);
            right: 0;
            min-width: 150px;
            background: rgba(20,24,32,0.98);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 6px;
            display: none;
            flex-direction: column;
            gap: 2px;
            z-index: 200;
            box-shadow: 0 8px 24px rgba(0,0,0,0.4);
            backdrop-filter: blur(20px);
        }
        .report-menu-dropdown.show {
            display: flex;
        }
        .report-menu-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            color: rgba(255,255,255,0.8);
            font-size: 13px;
            font-weight: 500;
        }
        .report-menu-item:hover {
            background: rgba(255,255,255,0.06);
        }
        .report-menu-item .icon {
            width: 16px;
            height: 16px;
            color: rgba(255,255,255,0.5);
        }
        .report-menu-item:hover .icon {
            color: rgba(255,255,255,0.8);
        }
        /* Light theme report menu */
        [data-theme="light"] .report-menu-btn {
            color: rgba(0,0,0,0.3);
        }
        [data-theme="light"] .report-menu-btn:hover {
            background: rgba(0,0,0,0.05);
            color: rgba(0,0,0,0.7);
        }
        [data-theme="light"] .report-menu-dropdown {
            background: rgba(255,255,255,0.98);
            border-color: rgba(0,0,0,0.08);
            box-shadow: 0 8px 24px rgba(0,0,0,0.15);
        }
        [data-theme="light"] .report-menu-item {
            color: #374151;
        }
        [data-theme="light"] .report-menu-item:hover {
            background: rgba(0,0,0,0.04);
        }
        [data-theme="light"] .report-menu-item .icon {
            color: rgba(0,0,0,0.4);
        }
        [data-theme="light"] .report-menu-item:hover .icon {
            color: rgba(0,0,0,0.7);
        }
        
        /* Report main title */
        .report-card .report-title {
            display: block;
            font-size: 17px; 
            font-weight: 700;
            color: var(--assistant);
            margin-bottom: 4px;
            padding-right: 36px;
        }
        .report-card h1 { 
            font-size: 17px; 
            font-weight: 700;
            color: var(--assistant);
            margin: 0 0 4px 0;
            border: none;
            padding-right: 36px;
        }
        /* Report section titles - green */
        .report-card h2 { 
            font-size: 14px; 
            font-weight: 600;
            color: var(--assistant);
            text-transform: uppercase;
            letter-spacing: 0.3px;
            border: none;
            margin: 18px 0 8px 0;
        }
        .report-card h2:first-of-type { margin-top: 10px; }
        /* Report subsection titles */
        .report-card h3 { 
            font-size: 13px; 
            font-weight: 600;
            color: rgba(255,255,255,0.7);
            margin: 12px 0 4px 0;
            border: none;
        }
        /* Report paragraphs */
        .report-card p { 
            margin: 4px 0; 
            font-size: 14px;
            color: rgba(255,255,255,0.9);
        }
        /* Report first paragraph (reference line) */
        .report-card > p:first-of-type {
            color: rgba(255,255,255,0.5);
            font-size: 12px;
            margin-bottom: 8px;
        }
        /* Report lists - tighter spacing */
        .report-card ul, 
        .report-card ol { 
            margin: 2px 0 6px 0; 
            padding-left: 18px; 
        }
        .report-card li { 
            margin: 1px 0; 
            font-size: 14px;
            color: rgba(255,255,255,0.9);
            line-height: 1.4;
        }
        /* Report horizontal rules - fewer and subtle */
        .report-card hr {
            margin: 16px 0;
            border: none;
            border-top: 1px solid rgba(255,255,255,0.06);
            height: 0;
        }
        /* Report bold text - labels are slightly gray */
        .report-card strong {
            color: rgba(255,255,255,0.55);
            font-weight: 600;
        }
        /* Report tables */
        .report-card table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
            font-size: 13px;
        }
        .report-card th {
            background: rgba(255,255,255,0.06);
            color: var(--assistant);
            font-weight: 600;
            text-align: left;
            padding: 8px 10px;
            border: 1px solid rgba(255,255,255,0.08);
        }
        .report-card td {
            padding: 6px 10px;
            border: 1px solid rgba(255,255,255,0.06);
            color: rgba(255,255,255,0.8);
        }
        .report-card tbody tr:hover {
            background: rgba(255,255,255,0.02);
        }
        /* Report footer */
        .report-card .report-footer,
        .report-card em:last-child {
            display: block;
            margin-top: 16px;
            padding-top: 10px;
            border-top: 1px solid rgba(255,255,255,0.06);
            font-size: 11px;
            color: rgba(255,255,255,0.35);
            font-style: italic;
        }
        
        /* Light theme report card */
        [data-theme="light"] .report-card {
            background: #f1f5f9;
            border: 1px solid rgba(0,0,0,0.06);
        }
        [data-theme="light"] .report-card .report-title,
        [data-theme="light"] .report-card h1 { 
            color: var(--assistant);
        }
        [data-theme="light"] .report-card h2 {
            color: var(--assistant);
        }
        [data-theme="light"] .report-card h3 { 
            color: rgba(0,0,0,0.6);
        }
        [data-theme="light"] .report-card p,
        [data-theme="light"] .report-card li { 
            color: #1a1a1a;
        }
        [data-theme="light"] .report-card > p:first-of-type {
            color: rgba(0,0,0,0.45);
        }
        [data-theme="light"] .report-card strong {
            color: rgba(0,0,0,0.5);
        }
        [data-theme="light"] .report-card hr {
            border-top: 1px solid rgba(0,0,0,0.06);
        }
        [data-theme="light"] .report-card th {
            background: rgba(0,0,0,0.04);
            color: var(--assistant);
            border-color: rgba(0,0,0,0.08);
        }
        [data-theme="light"] .report-card td {
            border-color: rgba(0,0,0,0.06);
            color: #374151;
        }
        [data-theme="light"] .report-card .report-footer,
        [data-theme="light"] .report-card em:last-child {
            color: rgba(0,0,0,0.35);
            border-top: 1px solid rgba(0,0,0,0.06);
        }
        
        .msg-bubble { padding: 12px 16px; border-radius: 16px; font-size: 13px; line-height: 1.5; position: relative; }
        .msg.user .msg-bubble { background: linear-gradient(135deg, var(--mode-color), color-mix(in srgb, var(--mode-color) 80%, black)); color: white; border-bottom-right-radius: 4px; }
        .msg.ai .msg-bubble { background: var(--card); border: 1px solid var(--border); border-bottom-left-radius: 4px; }
        
        /* Markdown styling in AI messages */
        .msg.ai .msg-bubble h1, .msg.ai .msg-bubble h2, .msg.ai .msg-bubble h3 { 
            color: var(--mode-color); 
            font-weight: 700; 
            margin: 16px 0 8px 0;
            line-height: 1.3;
        }
        .msg.ai .msg-bubble h1:first-child, .msg.ai .msg-bubble h2:first-child, .msg.ai .msg-bubble h3:first-child { margin-top: 0; }
        .msg.ai .msg-bubble h1 { font-size: 18px; }
        .msg.ai .msg-bubble h2 { font-size: 16px; }
        .msg.ai .msg-bubble h3 { font-size: 14px; }
        .msg.ai .msg-bubble p { margin: 8px 0; }
        .msg.ai .msg-bubble ul, .msg.ai .msg-bubble ol { margin: 8px 0; padding-left: 20px; }
        .msg.ai .msg-bubble li { margin: 4px 0; }
        .msg.ai .msg-bubble strong { font-weight: 600; color: var(--text); }
        .msg.ai .msg-bubble em { font-style: italic; }
        .msg.ai .msg-bubble code { 
            background: rgba(255,255,255,0.1); 
            padding: 2px 6px; 
            border-radius: 4px; 
            font-family: monospace; 
            font-size: 12px; 
        }
        .msg.ai .msg-bubble pre { 
            background: rgba(0,0,0,0.3); 
            padding: 12px; 
            border-radius: 8px; 
            overflow-x: auto; 
            margin: 8px 0;
        }
        .msg.ai .msg-bubble pre code { background: transparent; padding: 0; }
        .msg.ai .msg-bubble hr { border: none; border-top: 1px solid rgba(255,255,255,0.1); margin: 12px 0; height: 0; }
        .msg.ai .msg-bubble blockquote { 
            border-left: 3px solid var(--mode-color); 
            padding-left: 12px; 
            margin: 8px 0; 
            color: var(--text-dim); 
        }
        .msg.ai .msg-bubble table { width: 100%; border-collapse: collapse; margin: 8px 0; font-size: 12px; }
        .msg.ai .msg-bubble th, .msg.ai .msg-bubble td { border: 1px solid var(--border); padding: 8px; text-align: left; }
        .msg.ai .msg-bubble th { background: rgba(255,255,255,0.05); font-weight: 600; }

        /* DISABLED - CSS overrides JS styling
        /* Mermaid Diagrams */
        /* Clean Mermaid Diagrams */
        .mermaid-placeholder {
            background: #1e1e1e;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 20px;
            margin: 12px 0;
            overflow-x: auto;
            min-height: 60px;
        }
        .mermaid-loading {
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-dim);
            font-size: 12px;
            padding: 20px;
        }
        .mermaid-rendered {
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .mermaid-rendered svg {
            max-width: 100%;
            height: auto;
            min-height: 200px;
        }
        /* Override Mermaid default styles for clarity */
        .mermaid-rendered .node rect,
        .mermaid-rendered .node circle,
        .mermaid-rendered .node ellipse,
        .mermaid-rendered .node polygon,
        .mermaid-rendered .node path {
            fill: #2d2d2d !important;
            stroke: #888 !important;
            stroke-width: 2px !important;
        }
        .mermaid-rendered .node .label {
            fill: #fff !important;
            font-size: 13px !important;
            font-weight: 500 !important;
        }
        .mermaid-rendered .edgeLabel {
            background-color: #1e1e1e !important;
            fill: #ccc !important;
            font-size: 12px !important;
        }
        .mermaid-rendered .edgePath .path {
            stroke: #888 !important;
            stroke-width: 2px !important;
        }
        .mermaid-rendered .arrowheadPath {
            fill: #888 !important;
        }
        /* Subgraph styling */
        .mermaid-rendered .cluster rect {
            fill: #252525 !important;
            stroke: #555 !important;
            stroke-width: 1px !important;
        }
        .mermaid-rendered .cluster .label {
            fill: #aaa !important;
            font-size: 12px !important;
        }
        .mermaid-error {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            border-radius: 8px;
            padding: 12px;
        }
        .mermaid-error-title {
            color: #ef4444;
            font-weight: bold;
            margin-bottom: 8px;
            font-size: 12px;
        }
        .mermaid-error pre {
            background: rgba(0,0,0,0.2);
            padding: 12px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 11px;
            font-family: monospace;
            white-space: pre-wrap;
            color: var(--text-dim);
            margin: 0;
        }
        .mermaid-error-container {
            border-color: rgba(239, 68, 68, 0.3);
        }
        [data-theme="light"] .mermaid-placeholder {
            background: #f5f5f5;
            border-color: #ddd;
        }
        [data-theme="light"] .mermaid-rendered .node rect,
        [data-theme="light"] .mermaid-rendered .node circle,
        [data-theme="light"] .mermaid-rendered .node ellipse,
        [data-theme="light"] .mermaid-rendered .node polygon,
        [data-theme="light"] .mermaid-rendered .node path {
            fill: #e8e8e8 !important;
            stroke: #666 !important;
        }
        [data-theme="light"] .mermaid-rendered .node .label {
            fill: #333 !important;
        }
        [data-theme="light"] .mermaid-rendered .edgeLabel {
            background-color: #f5f5f5 !important;
            fill: #555 !important;
        }
        [data-theme="light"] .mermaid-rendered .edgePath .path {
            stroke: #666 !important;
        }
        [data-theme="light"] .mermaid-rendered .arrowheadPath {
            fill: #666 !important;
        }
        [data-theme="light"] .mermaid-rendered .cluster rect {
            fill: #f0f0f0 !important;
            stroke: #ccc !important;
        }
        [data-theme="light"] .mermaid-rendered .cluster .label {
            fill: #666 !important;
        }
        END DISABLED */

        /* Light theme markdown overrides */
        [data-theme="light"] .msg.ai .msg-bubble h1,
        [data-theme="light"] .msg.ai .msg-bubble h2,
        [data-theme="light"] .msg.ai .msg-bubble h3 {
            color: var(--mode-color);
        }
        [data-theme="light"] .msg.ai .msg-bubble strong { color: #1E293B; }
        [data-theme="light"] .msg.ai .msg-bubble code { background: rgba(0,0,0,0.06); }
        [data-theme="light"] .msg.ai .msg-bubble pre { background: #F1F5F9; }
        
        /* Loading indicator for messages */
        .msg-loading { display: flex; gap: 4px; padding: 8px 0; }
        .msg-loading span { 
            width: 8px; 
            height: 8px; 
            background: var(--mode-color, #10B981); 
            border-radius: 50%; 
            animation: msgBounce 1.4s ease-in-out infinite both;
        }
        .msg-loading span:nth-child(1) { animation-delay: -0.32s; }
        .msg-loading span:nth-child(2) { animation-delay: -0.16s; }
        @keyframes msgBounce {
            0%, 80%, 100% { transform: scale(0.6); opacity: 0.4; }
            40% { transform: scale(1); opacity: 1; }
        }
        
        .msg-head { display: flex; align-items: center; gap: 6px; margin-bottom: 6px; padding-bottom: 6px; border-bottom: 1px solid var(--border); }
        .msg-avatar { width: 18px; height: 18px; border-radius: 50%; background: linear-gradient(135deg, color-mix(in srgb, var(--mode-color) 70%, white), var(--mode-color)); display: flex; align-items: center; justify-content: center; }
        .msg-avatar .icon { width: 8px; height: 8px; color: white; }
        .msg-name { font-size: 10px; font-weight: 600; color: var(--mode-color); }
        .msg-acts { display: none; }
        .msg-act { position: absolute; top: 12px; right: 12px; padding: 6px; background: transparent; border: none; border-radius: 6px; font-size: 9px; color: rgba(255,255,255,0.3); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; opacity: 0; }
        .msg-bubble:hover .msg-act { opacity: 1; }
        .msg-act:hover { background: rgba(255,255,255,0.08); color: rgba(255,255,255,0.7); }
        .msg-act .icon { width: 14px; height: 14px; }

        .chat-input { 
            padding: 12px 14px; 
            padding-bottom: max(12px, env(safe-area-inset-bottom)); 
            flex-shrink: 0; 
            background: var(--bg); 
            position: relative;
            z-index: 10;
        }
        .chat-view.split .chat-input { padding-bottom: 12px; }
        .input-row:focus-within { border-color: var(--mode-border); }
        .input-row.recording { border-color: var(--mode-border); }
        
        .plus-btn { width: 36px; height: 36px; border-radius: 50%; background: rgba(255,255,255,0.06); border: 1px solid var(--border); color: rgba(255,255,255,0.5); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; flex-shrink: 0; z-index: 2; }
        .plus-btn:hover { background: rgba(255,255,255,0.1); color: rgba(255,255,255,0.8); }
        .plus-btn .icon { width: 16px; height: 16px; }
        /* Plus icon color matches mode */
        .panel.copilot .plus-btn .icon { color: var(--copilot); }
        .panel.assistant .plus-btn .icon { color: var(--assistant); }
        
        /* Attach menu - positioned above input row */
        .attach-menu { position: absolute; bottom: 100%; left: 14px; margin-bottom: 4px; background: rgba(20,24,32,0.98); border: 1px solid var(--border); border-radius: 10px; padding: 4px; display: none; flex-direction: column; gap: 2px; min-width: 180px; z-index: 10; box-shadow: 0 4px 20px rgba(0,0,0,0.4); }
        .attach-menu.show { display: flex; }
        .attach-opt { display: flex; align-items: center; gap: 8px; padding: 8px 10px; border-radius: 6px; font-size: 11px; color: rgba(255,255,255,0.7); cursor: pointer; transition: background 0.2s; }
        .attach-opt:hover { background: rgba(255,255,255,0.05); }
        .attach-opt .icon { width: 14px; height: 14px; color: var(--mode-color); }
        
        /* Input area wrapper */
        .input-area { flex: 1; position: relative; min-height: 36px; display: flex; align-items: flex-end; }
        .input-text { width: 100%; background: transparent; border: none; color: white; font-family: inherit; font-size: 13px; line-height: 1.5; outline: none; padding: 8px 10px; position: relative; z-index: 1; resize: none; overflow-y: hidden; min-height: 36px; max-height: 25vh; }
        .input-text::placeholder { color: rgba(255,255,255,0.25); }
        .input-text.scrollable { overflow-y: auto; }
        .input-row.recording .input-text { opacity: 0; pointer-events: none; }
        .input-row.expanded { border-radius: 16px; }
        .input-row { display: flex; align-items: flex-end; gap: 8px; padding: 6px; background: var(--card); border: 1px solid var(--border); border-radius: 24px; transition: border-color 0.2s, border-radius 0.2s; position: relative; }
        
        /* Voice waveform */
        .voice-waveform { position: absolute; left: 0; right: 0; top: 0; bottom: 0; display: flex; align-items: center; justify-content: space-between; padding: 0; opacity: 0; pointer-events: none; transition: opacity 0.3s ease; }
        .input-row.recording .voice-waveform { opacity: 1; }
        .wave-bars { flex: 1; display: flex; align-items: center; justify-content: flex-end; gap: 2px; height: 100%; padding: 0; overflow: hidden; }
        .wave-bar { width: 3px; min-width: 3px; height: 3px; border-radius: 2px; flex-shrink: 0; }
        .voice-waveform.copilot .wave-bar { background: var(--copilot); }
        .voice-waveform.assistant .wave-bar { background: var(--assistant); }
        .voice-timer { font-size: 11px; font-weight: 600; font-variant-numeric: tabular-nums; color: var(--text); min-width: 36px; text-align: right; opacity: 0.7; padding-right: 4px; background: linear-gradient(to right, transparent, var(--card) 20%); padding-left: 12px; }
        
        /* Dynamic action button (mic/send/stop) */
        .action-btn { width: 36px; height: 36px; border-radius: 50%; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: transform 0.2s; flex-shrink: 0; z-index: 2; position: relative; }
        .action-btn.copilot { background: linear-gradient(135deg, var(--copilot), #E55A2B); color: white; }
        .action-btn.assistant { background: linear-gradient(135deg, var(--assistant), #16a34a); color: white; }
        .action-btn:hover { transform: scale(1.05); }
        .action-btn:active { transform: scale(0.95); }
        .action-btn .icon-wrap { position: relative; width: 16px; height: 16px; }
        .action-btn .btn-icon { position: absolute; top: 0; left: 0; width: 16px; height: 16px; transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1); }
        .action-btn .btn-icon svg { width: 16px; height: 16px; }
        .action-btn .mic-icon { opacity: 1; transform: scale(1); }
        .action-btn .send-icon { opacity: 0; transform: scale(0.5) translateY(6px); }
        .action-btn .stop-icon { opacity: 0; transform: scale(0); }
        .action-btn.has-text .mic-icon { opacity: 0; transform: scale(0.5) translateY(-6px); }
        .action-btn.has-text .send-icon { opacity: 1; transform: scale(1) translateY(0); }
        .action-btn.recording .mic-icon { opacity: 0; transform: scale(0); }
        .action-btn.recording .stop-icon { opacity: 1; transform: scale(1); }
        /* Red stop button during recording */
        .action-btn.recording { background: rgb(174, 62, 50) !important; }
        
        /*  TRANSCRIPTION GLASS SPHERE  */
        .action-btn.transcribing { display: none; }
        .transcription-sphere {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            position: relative;
            overflow: hidden;
            flex-shrink: 0;
            z-index: 2;
            display: none;
            animation: sphereGlow 3s ease-in-out infinite;
        }
        .transcription-sphere.active { display: block; }
        @keyframes sphereGlow {
            0%, 100% { box-shadow: 0 0 14px rgba(255,107,53,0.7), 0 0 28px rgba(255,107,53,0.3); }
            25% { box-shadow: 0 0 14px rgba(239,68,68,0.7), 0 0 28px rgba(239,68,68,0.3); }
            50% { box-shadow: 0 0 14px rgba(59,130,246,0.7), 0 0 28px rgba(59,130,246,0.3); }
            75% { box-shadow: 0 0 14px rgba(234,179,8,0.7), 0 0 28px rgba(234,179,8,0.3); }
        }
        .sphere-fog-wrap {
            position: absolute;
            inset: 0;
            border-radius: 50%;
            overflow: hidden;
            background: rgba(20,24,32,0.3);
        }
        .sphere-fog-transcribe {
            position: absolute;
            inset: -50%;
            border-radius: 50%;
            background: radial-gradient(circle at 30% 40%, currentColor, transparent 50%), radial-gradient(circle at 70% 60%, currentColor, transparent 40%);
            filter: blur(3px);
            animation: fogSwirlT 4s ease-in-out infinite, fogColorT 3s ease-in-out infinite;
            opacity: 0.9;
        }
        .sphere-fog-transcribe-2 {
            position: absolute;
            inset: -30%;
            border-radius: 50%;
            background: radial-gradient(circle at 60% 30%, currentColor, transparent 45%);
            filter: blur(3px);
            animation: fogSwirlT2 3s ease-in-out infinite reverse, fogColorT2 3s ease-in-out infinite;
            opacity: 0.7;
        }
        .sphere-highlight {
            position: absolute;
            top: 4px;
            left: 8px;
            width: 8px;
            height: 6px;
            border-radius: 50%;
            background: radial-gradient(circle, rgba(255,255,255,0.5), transparent 70%);
            z-index: 10;
        }
        @keyframes fogSwirlT {
            0% { transform: rotate(0deg) translate(0, 0); }
            25% { transform: rotate(90deg) translate(2px, -2px); }
            50% { transform: rotate(180deg) translate(0, 0); }
            75% { transform: rotate(270deg) translate(-2px, 2px); }
            100% { transform: rotate(360deg) translate(0, 0); }
        }
        @keyframes fogColorT {
            0%, 100% { color: #FF6B35; }
            25% { color: #ef4444; }
            50% { color: #3B82F6; }
            75% { color: #eab308; }
        }
        @keyframes fogSwirlT2 {
            0% { transform: rotate(0deg) scale(0.9); }
            50% { transform: rotate(180deg) scale(1.1); }
            100% { transform: rotate(360deg) scale(0.9); }
        }
        @keyframes fogColorT2 {
            0%, 100% { color: #3B82F6; }
            25% { color: #eab308; }
            50% { color: #FF6B35; }
            75% { color: #ef4444; }
        }
        /*  END TRANSCRIPTION SPHERE  */

        /* DIVIDER */
        .divider { width: 8px; background: var(--border); cursor: col-resize; position: relative; flex-shrink: 0; transition: background 0.2s; display: flex; align-items: center; justify-content: center; touch-action: none; -webkit-user-select: none; user-select: none; }
        .divider:hover, .divider.dragging { background: rgba(255,255,255,0.1); }
        .divider-grip { display: flex; flex-direction: column; gap: 3px; }
        .divider-grip span { width: 3px; height: 3px; background: rgba(255,255,255,0.3); border-radius: 50%; }
        .divider:hover .divider-grip span, .divider.dragging .divider-grip span { background: rgba(255,255,255,0.6); }
        @media (max-width: 767px) { .divider { width: 100%; height: 8px; cursor: row-resize; } .divider-grip { flex-direction: row; } }

        /* PHOTO MODAL */
        .photo-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.7); backdrop-filter: blur(8px); z-index: 600; display: none; align-items: center; justify-content: center; padding: 20px; }
        .photo-modal.active { display: flex; }
        .photo-modal-content { width: 100%; max-width: 300px; background: rgba(20,24,32,0.98); border: 1px solid var(--border); border-radius: 14px; overflow: hidden; }
        .photo-modal-header { padding: 14px; border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 10px; }
        .photo-modal-preview { width: 40px; height: 40px; border-radius: 8px; background: rgba(255,255,255,0.1); display: flex; align-items: center; justify-content: center; }
        .photo-modal-preview .icon { width: 20px; height: 20px; color: var(--copilot); }
        .photo-modal-title { font-size: 13px; font-weight: 600; }
        .photo-modal-sub { font-size: 10px; color: var(--text-dim); margin-top: 2px; }
        .photo-modal-body { padding: 10px; }
        .photo-option { display: flex; align-items: center; gap: 10px; padding: 12px; background: var(--card); border: 1px solid var(--border); border-radius: 10px; cursor: pointer; margin-bottom: 6px; transition: all 0.2s; }
        .photo-option:hover { background: rgba(255,255,255,0.05); }
        .photo-option:last-child { margin-bottom: 0; }
        .photo-option-icon { width: 36px; height: 36px; border-radius: 8px; display: flex; align-items: center; justify-content: center; }
        .photo-option-icon.extract { background: var(--copilot-bg); color: var(--copilot); }
        .photo-option-icon.report { background: var(--assistant-bg); color: var(--assistant); }
        .photo-option-icon .icon { width: 16px; height: 16px; }
        .photo-option-text { flex: 1; }
        .photo-option-title { font-size: 12px; font-weight: 600; margin-bottom: 2px; }
        .photo-option-desc { font-size: 10px; color: var(--text-dim); }
        .photo-modal-footer { padding: 10px 14px 14px; }
        
        /* Photo full preview */
        .photo-full-preview { 
            padding: 0 14px; 
            margin-bottom: 10px;
            display: none;
        }
        .photo-full-preview.has-image { display: block; }
        .photo-full-preview img { 
            width: 100%; 
            max-height: 200px; 
            object-fit: cover; 
            border-radius: 10px; 
            border: 1px solid var(--border);
        }
        .photo-modal-preview.has-image { 
            background: transparent; 
            overflow: hidden;
        }
        .photo-modal-preview.has-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 8px;
        }
        .photo-modal-preview.has-image .icon { display: none; }
        
        /* Send option icon */
        .photo-option-icon.send { background: var(--copilot-bg); }
        .photo-option-icon.send .icon { color: var(--copilot); }
        
        /* Chat images */
        .msg-image { 
            max-width: 100%; 
            border-radius: 12px; 
            cursor: pointer;
            transition: transform 0.2s;
            display: block;
        }
        .msg-image:hover { transform: scale(1.02); }
        
        /* Photo container with delete button */
        .photo-container {
            position: relative;
            display: inline-block;
            max-width: 240px;
        }
        .photo-container .msg-image {
            max-width: 100%;
        }
        .photo-delete {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: rgba(0,0,0,0.6);
            border: none;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.2s;
        }
        .photo-container:hover .photo-delete { opacity: 1; }
        .photo-delete .icon { width: 14px; height: 14px; }
        .photo-delete:hover { background: var(--hotline); }
        
        /* Inline action buttons below photo */
        .photo-actions-inline {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }
        .photo-action-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 12px;
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text);
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }
        .photo-action-btn:hover {
            background: rgba(255,255,255,0.08);
            border-color: rgba(255,255,255,0.15);
        }
        .photo-action-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .photo-action-btn.success {
            background: var(--assistant-bg);
            border-color: var(--assistant-border);
            color: var(--assistant);
        }
        .photo-action-btn .icon { width: 14px; height: 14px; }
        
        /* OCR Quote (linked photo) */
        .ocr-quote {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 10px;
            background: rgba(255,107,53,0.08);
            border-left: 3px solid var(--copilot);
            border-radius: 0 8px 8px 0;
            margin-bottom: 12px;
            cursor: pointer;
            transition: background 0.2s;
        }
        .ocr-quote:hover {
            background: rgba(255,107,53,0.15);
        }
        .ocr-quote-thumb {
            width: 40px;
            height: 40px;
            object-fit: cover;
            border-radius: 6px;
        }
        .ocr-quote-label {
            font-size: 11px;
            color: var(--copilot);
            font-weight: 500;
        }
        .ocr-result {
            font-size: 13px;
            line-height: 1.6;
        }
        .ocr-loading {
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--text-dim);
            font-size: 12px;
        }
        .ocr-spinner {
            width: 16px;
            height: 16px;
            border: 2px solid var(--border);
            border-top-color: var(--copilot);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* 
           OCR EXTRACTION CARD - Compact UI
            */
        
        /* Main OCR card container */
        .ocr-card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 12px;
            overflow: hidden;
            margin-top: 10px;
        }
        
        /* Card header with icon */
        .ocr-card-header {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 14px;
            background: rgba(34, 197, 94, 0.08);
            border-bottom: 1px solid var(--border);
        }
        .ocr-card-header .icon {
            width: 20px;
            height: 20px;
            color: var(--assistant);
        }
        .ocr-card-header-title {
            font-weight: 600;
            font-size: 13px;
            color: var(--text);
        }
        .ocr-card-header-method {
            margin-left: auto;
            font-size: 11px;
            color: var(--text-dim);
            background: var(--bg);
            padding: 3px 8px;
            border-radius: 10px;
        }
        
        /* AI Summary section - prominent */
        .ocr-ai-summary {
            padding: 14px;
            font-size: 13px;
            line-height: 1.6;
            border-bottom: 1px solid var(--border);
        }
        .ocr-ai-summary p {
            margin: 0 0 8px 0;
        }
        .ocr-ai-summary p:last-child {
            margin-bottom: 0;
        }
        .ocr-ai-summary strong {
            color: var(--copilot);
        }
        .ocr-ai-summary ul, .ocr-ai-summary ol {
            margin: 8px 0;
            padding-left: 20px;
        }
        .ocr-ai-summary li {
            margin: 4px 0;
        }
        
        /* Extracted text - scrollable */
        .ocr-raw-section {
            border-top: 1px solid var(--border);
        }
        .ocr-raw-toggle {
            width: 100%;
            padding: 10px 14px;
            background: transparent;
            border: none;
            color: var(--text-dim);
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: all 0.2s;
        }
        .ocr-raw-toggle:hover {
            background: rgba(255,255,255,0.03);
            color: var(--text);
        }
        .ocr-raw-toggle .chevron {
            transition: transform 0.2s;
        }
        .ocr-raw-toggle.open .chevron {
            transform: rotate(180deg);
        }
        .ocr-raw-content {
            display: none;
            max-height: 150px;
            overflow-y: auto;
            padding: 12px 14px;
            background: var(--bg);
            font-family: monospace;
            font-size: 11px;
            line-height: 1.5;
            white-space: pre-wrap;
            word-break: break-word;
            color: var(--text-dim);
        }
        .ocr-raw-content.show {
            display: block;
        }
        
        /* Action buttons in card footer */
        .ocr-card-actions {
            display: flex;
            gap: 8px;
            padding: 10px 14px;
            border-top: 1px solid var(--border);
            background: rgba(0,0,0,0.1);
        }
        
        /* Legacy classes for backward compatibility */
        .ocr-raw-text {
            font-family: monospace;
            font-size: 12px;
            background: var(--card);
            padding: 14px;
            border-radius: 10px;
            margin-top: 10px;
            white-space: pre-wrap;
            word-break: break-word;
            border: 1px solid var(--border);
            line-height: 1.6;
            max-height: 150px;
            overflow-y: auto;
        }
        
        /* OCR section titles */
        .ocr-section-title {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-dim);
            margin: 14px 0 8px 0;
        }
        
        /* OCR structured content from AI */
        .ocr-structured {
            margin-top: 12px;
        }
        .ocr-structured-content {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 14px;
            font-size: 13px;
            line-height: 1.6;
        }
        .ocr-structured-content strong {
            color: var(--copilot);
        }
        
        /* Collapsible raw text */
        .ocr-raw-details {
            margin-top: 12px;
        }
        .ocr-raw-details summary {
            cursor: pointer;
            color: var(--text-dim);
            font-size: 12px;
            padding: 8px 0;
            user-select: none;
        }
        .ocr-raw-details summary:hover {
            color: var(--text);
        }
        .ocr-raw-details[open] summary {
            color: var(--copilot);
        }
        
        /* No text detected */
        .ocr-no-text {
            padding: 16px;
            text-align: center;
            color: var(--text-dim);
        }
        
        /* OCR structured summary */
        .ocr-summary {
            background: rgba(34, 197, 94, 0.08);
            border: 1px solid rgba(34, 197, 94, 0.2);
            border-radius: 10px;
            padding: 14px;
            margin-top: 12px;
        }
        .ocr-summary-title {
            font-size: 12px;
            font-weight: 600;
            color: var(--assistant);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .ocr-summary-grid {
            display: grid;
            grid-template-columns: auto 1fr;
            gap: 6px 12px;
            font-size: 12px;
        }
        .ocr-summary-label {
            color: var(--text-dim);
        }
        .ocr-summary-value {
            font-weight: 500;
            font-family: monospace;
        }
        .ocr-summary-value.error {
            color: var(--hotline);
            font-weight: 700;
        }
        .ocr-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }
        .ocr-action-btn {
            padding: 8px 14px;
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 12px;
            color: var(--text);
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .ocr-action-btn:hover {
            background: rgba(255,255,255,0.08);
        }
        .ocr-action-btn .icon {
            width: 14px;
            height: 14px;
        }
        .ocr-action-btn.error-btn {
            background: rgba(239, 68, 68, 0.15);
            border-color: rgba(239, 68, 68, 0.3);
            color: var(--hotline);
        }
        .ocr-action-btn.error-btn:hover {
            background: rgba(239, 68, 68, 0.25);
        }
        
        /* File attachment style */
        .file-attachment {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 14px;
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 10px;
        }
        .file-icon {
            padding: 6px 8px;
            background: var(--copilot-bg);
            border-radius: 6px;
            font-size: 10px;
            font-weight: 700;
            color: var(--copilot);
        }
        .file-name {
            font-size: 13px;
            color: var(--text);
        }
        
        /* Scroll to bottom button */
        .scroll-bottom-btn {
            position: absolute;
            bottom: 90px;
            left: 50%;
            transform: translateX(-50%);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(30, 35, 44, 0.7);
            backdrop-filter: blur(8px);
            border: 1px solid rgba(255,255,255,0.1);
            color: rgba(255,255,255,0.6);
            cursor: pointer;
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10;
            transition: all 0.2s;
        }
        .scroll-bottom-btn.visible { display: flex; }
        .scroll-bottom-btn:hover { 
            background: rgba(30, 35, 44, 0.9);
            color: var(--text);
            border-color: rgba(255,255,255,0.2);
        }
        .scroll-bottom-btn .icon { 
            width: 18px; 
            height: 18px; 
            transform: rotate(-90deg);
        }
        
        /* Photo name modal (for report) */
        .photo-name-modal {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.8);
            backdrop-filter: blur(8px);
            z-index: 650;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .photo-name-modal.active { display: flex; }
        .photo-name-content {
            width: 100%;
            max-width: 320px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 16px;
            overflow: hidden;
        }
        .photo-name-header {
            padding: 16px;
            border-bottom: 1px solid var(--border);
        }
        .photo-name-title {
            font-size: 15px;
            font-weight: 600;
            margin-bottom: 4px;
        }
        .photo-name-sub {
            font-size: 11px;
            color: var(--text-dim);
        }
        .photo-name-preview {
            padding: 12px;
        }
        .photo-name-preview img {
            width: 100%;
            max-height: 180px;
            object-fit: cover;
            border-radius: 10px;
            border: 1px solid var(--border);
        }
        .photo-name-input-wrap {
            padding: 0 16px 16px;
        }
        .photo-name-input {
            width: 100%;
            padding: 12px 14px;
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 10px;
            color: var(--text);
            font-size: 14px;
            outline: none;
            transition: border-color 0.2s;
        }
        .photo-name-input:focus {
            border-color: var(--assistant);
        }
        .photo-name-input::placeholder {
            color: var(--text-dim);
        }
        .photo-name-actions {
            display: flex;
            gap: 10px;
            padding: 0 16px 16px;
        }
        .photo-name-cancel {
            flex: 1;
            padding: 12px;
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 10px;
            color: var(--text-dim);
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }
        .photo-name-cancel:hover {
            background: rgba(255,255,255,0.05);
        }
        .photo-name-confirm {
            flex: 1.5;
            padding: 12px;
            background: var(--assistant);
            border: none;
            border-radius: 10px;
            color: white;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .photo-name-confirm:hover {
            filter: brightness(1.1);
        }
        
        /* Image loading state */
        .msg-image-loading {
            width: 200px;
            height: 150px;
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-dim);
            font-size: 12px;
        }
        
        /* Image viewer modal */
        .image-viewer {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.95);
            z-index: 700;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .image-viewer.active { display: flex; }
        .image-viewer img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            border-radius: 8px;
        }
        .image-viewer-close {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(255,255,255,0.1);
            border: none;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .image-viewer-close .icon { width: 20px; height: 20px; }
        .photo-cancel { width: 100%; padding: 10px; background: transparent; border: 1px solid var(--border); border-radius: 8px; color: rgba(255,255,255,0.6); font-size: 12px; font-weight: 500; cursor: pointer; transition: all 0.2s; }
        .photo-cancel:hover { background: rgba(255,255,255,0.05); }

        /* REPORT SHEET - Live Preview Drawer */
        .report-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,0.4); z-index: 299; opacity: 0; pointer-events: none; transition: opacity 0.3s; }
        .report-backdrop.show { opacity: 1; pointer-events: auto; }
        .report-sheet { position: fixed; top: 0; right: 0; width: 100%; max-width: 55%; height: 100%; background: var(--bg-secondary); border-left: 1px solid var(--assistant-border); z-index: 300; display: flex; flex-direction: column; transform: translateX(100%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .report-sheet.open { transform: translateX(0); }
        @media (max-width: 900px) { .report-sheet { max-width: 70%; } }
        @media (max-width: 600px) { .report-sheet { max-width: 100%; border-left: none; } }
        .report-header { display: flex; align-items: center; gap: 10px; padding: 12px 14px; padding-top: max(12px, env(safe-area-inset-top)); border-bottom: 1px solid var(--border); flex-shrink: 0; }
        .report-close { width: 28px; height: 28px; border-radius: 50%; background: transparent; border: 1px solid var(--border); color: rgba(255,255,255,0.5); cursor: pointer; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
        .report-close .icon { width: 12px; height: 12px; }
        .report-title { font-size: 14px; font-weight: 600; color: var(--assistant); white-space: nowrap; }
        .report-progress { flex: 1; display: flex; align-items: center; gap: 8px; min-width: 60px; }
        .report-progress-bar { flex: 1; height: 3px; background: rgba(255,255,255,0.1); border-radius: 2px; overflow: hidden; }
        .report-progress-fill { height: 100%; width: 0%; background: #3B82F6; border-radius: 2px; transition: width 0.4s ease; }
        .report-progress-text { font-size: 11px; font-weight: 600; color: #3B82F6; white-space: nowrap; }
        
        /* Styled Select - looks like text field */
        .styled-select-wrapper {
            position: relative;
            display: inline-flex;
            align-items: center;
            min-width: 80px;
        }
        .styled-select-display {
            padding: 2px 6px;
            border-radius: 4px;
            border: 1px solid transparent;
            cursor: pointer;
            transition: all 0.2s;
        }
        .styled-select-wrapper:hover .styled-select-display {
            background: rgba(255,255,255,0.03);
            border-color: var(--border);
        }
        .styled-select-wrapper.empty .styled-select-display {
            color: var(--text-dim);
            font-style: italic;
        }
        .styled-select-hidden {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
        }
        .rpt-status-wrapper {
            display: flex;
            align-items: center;
        }
        .rpt-status-wrapper .styled-select-display {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            background: rgba(34, 197, 94, 0.15);
            color: #22c55e;
        }
        .rpt-status-wrapper .styled-select-wrapper[data-status="en_cours"] .styled-select-display,
        .rpt-status-wrapper .styled-select-wrapper.empty .styled-select-display {
            background: rgba(59, 130, 246, 0.15);
            color: #3B82F6;
        }
        .rpt-status-wrapper .styled-select-wrapper[data-status="non_conforme"] .styled-select-display {
            background: rgba(239, 68, 68, 0.15);
            color: #ef4444;
        }
        
        /* Section dividers */
        .rpt-section-divider {
            height: 1px;
            background: linear-gradient(90deg, transparent, var(--border), transparent);
            margin: 16px 0;
        }
        
        /* Section headers */
        .section-header {
            font-size: 13px !important;
            font-weight: 600 !important;
            color: var(--text) !important;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border);
            margin-bottom: 12px !important;
        }
        
        /* Table styles for adressage */
        .rpt-table-wrapper {
            overflow-x: auto;
            margin: 8px 0;
        }
        .rpt-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 11px;
        }
        .rpt-table th {
            background: var(--card);
            padding: 6px 8px;
            text-align: left;
            font-weight: 600;
            color: var(--text-dim);
            border-bottom: 1px solid var(--border);
            white-space: nowrap;
        }
        .rpt-table td {
            padding: 4px 8px;
            border-bottom: 1px solid rgba(255,255,255,0.03);
        }
        .rpt-table tr:hover {
            background: rgba(255,255,255,0.02);
        }
        .rpt-table .editable-field {
            min-width: 40px;
        }
        
        /* Check-list grid for boolean items */
        .rpt-checklist-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 6px;
            margin-top: 8px;
        }
        .checklist-item {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            background: rgba(255,255,255,0.03);
        }
        .checklist-item .check-icon {
            font-weight: bold;
            width: 16px;
            text-align: center;
        }
        .checklist-item.check-ok {
            color: #4ade80;
        }
        .checklist-item.check-ok .check-icon {
            color: #22c55e;
        }
        .checklist-item.check-nok {
            color: #f87171;
        }
        .checklist-item.check-nok .check-icon {
            color: #ef4444;
        }
        .rpt-row-value.check-ok {
            color: #22c55e;
        }
        .rpt-row-value.check-nok {
            color: #ef4444;
        }
        @media (max-width: 500px) {
            .rpt-checklist-grid {
                grid-template-columns: 1fr;
            }
        }
        
        /* Code defaut item */
        .rpt-code-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 10px;
            background: var(--card);
            border-radius: 6px;
            margin-bottom: 6px;
        }
        .rpt-code-item .code-badge {
            background: rgba(239, 68, 68, 0.15);
            color: #ef4444;
            padding: 2px 8px;
            border-radius: 4px;
            font-family: monospace;
            font-weight: 600;
            font-size: 12px;
        }
        .rpt-code-item .code-desc {
            flex: 1;
            color: var(--text);
        }
        
        /* Measures grid */
        .rpt-measures-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 8px;
        }
        .rpt-measure-card {
            background: var(--card);
            border-radius: 8px;
            padding: 10px;
            display: flex;
            flex-direction: column;
            gap: 4px;
            position: relative;
        }
        .rpt-measure-card .measure-label {
            font-size: 10px;
            color: var(--text-dim);
            text-transform: uppercase;
        }
        .rpt-measure-card .measure-value {
            font-size: 16px;
            font-weight: 600;
            color: var(--text);
        }
        .rpt-measure-card .measure-unit {
            font-size: 10px;
            color: var(--text-dim);
        }
        .rpt-measure-card .remove-item-btn {
            position: absolute;
            top: 4px;
            right: 4px;
        }
        
        /* Pending list */
        .pending-list li.pending {
            opacity: 0.8;
        }
        .pending-list li.pending .check-icon {
            color: var(--accent);
        }
        
        /* Piece quantity */
        .piece-qty {
            min-width: 40px;
            text-align: center;
            font-weight: 600;
        }
        
        /* Result box */
        .rpt-result-box {
            background: var(--card);
            border-radius: 8px;
            padding: 12px;
        }
        .result-status-row, .result-desc-row {
            display: flex;
            flex-direction: column;
            gap: 6px;
            margin-bottom: 10px;
        }
        .result-label {
            font-size: 10px;
            color: var(--text-dim);
            text-transform: uppercase;
        }
        .rpt-result-box .styled-select-display {
            font-size: 14px;
            font-weight: 600;
        }
        
        /* Photos grid */
        .photos-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 10px;
        }
        .photo-item {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        .photo-item img {
            width: 100%;
            aspect-ratio: 4/3;
            object-fit: cover;
            border-radius: 6px;
            border: 1px solid var(--border);
        }
        .photo-caption {
            font-size: 10px;
            color: var(--text-dim);
            text-align: center;
        }
        .photos-placeholder {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 30px;
            border: 1px dashed var(--border);
            border-radius: 8px;
            color: var(--text-dim);
            font-size: 12px;
        }
        .photos-placeholder svg {
            opacity: 0.5;
        }
        
        /* Photo drag-drop styles */
        .photo-item {
            position: relative;
        }
        .photo-drag-handle {
            position: absolute;
            top: 4px;
            left: 4px;
            width: 20px;
            height: 20px;
            background: rgba(0,0,0,0.5);
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 10px;
            cursor: grab;
            opacity: 0;
            transition: opacity 0.2s;
        }
        .photo-item:hover .photo-drag-handle {
            opacity: 1;
        }
        .photo-remove-btn {
            position: absolute;
            top: 4px;
            right: 4px;
            width: 20px;
            height: 20px;
            background: rgba(239, 68, 68, 0.9);
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 14px;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .photo-item:hover .photo-remove-btn {
            opacity: 1;
        }
        .photo-item.dragging {
            opacity: 0.5;
            transform: scale(0.95);
        }
        .photo-item.drag-over {
            border: 2px dashed var(--accent);
        }
        .photo-drop-zone {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 20px;
            border: 2px dashed var(--border);
            border-radius: 8px;
            color: var(--text-dim);
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
            margin-top: 8px;
        }
        .photo-drop-zone:hover {
            border-color: var(--accent);
            background: rgba(255,255,255,0.02);
        }
        .photo-drop-zone.drag-active {
            border-color: var(--accent);
            background: rgba(var(--accent-rgb), 0.1);
        }
        .photo-drop-zone svg {
            opacity: 0.5;
        }
        
        /* Signatures */
        .signatures-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }
        .signature-box {
            background: var(--card);
            border-radius: 8px;
            padding: 12px;
        }
        .signature-label {
            font-size: 10px;
            color: var(--text-dim);
            text-transform: uppercase;
            margin-bottom: 8px;
        }
        .signature-area {
            height: 60px;
            border: 1px dashed var(--border);
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .signature-area:hover {
            border-color: var(--accent);
            background: rgba(255,255,255,0.02);
        }
        .signature-area img {
            max-width: 100%;
            max-height: 100%;
        }
        .signature-area.signed {
            border-style: solid;
            background: rgba(34, 197, 94, 0.05);
            border-color: #22c55e;
        }
        .signature-placeholder {
            font-size: 11px;
            color: var(--text-dim);
            font-style: italic;
        }
        .signature-name {
            font-size: 11px;
            text-align: center;
        }
        
        /* Signature Modal */
        .signature-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            z-index: 10000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .signature-modal.active {
            display: flex;
        }
        .signature-modal-content {
            background: var(--card);
            border-radius: 16px;
            padding: 20px;
            width: 100%;
            max-width: 340px;
        }
        .signature-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        .signature-modal-title {
            font-weight: 600;
            font-size: 16px;
        }
        .signature-modal-close {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: none;
            background: var(--bg);
            color: var(--text);
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .signature-canvas-wrap {
            background: #fff;
            border-radius: 8px;
            overflow: hidden;
            margin-bottom: 16px;
        }
        #signatureCanvas {
            display: block;
            width: 100%;
            touch-action: none;
        }
        .signature-modal-actions {
            display: flex;
            gap: 12px;
        }
        .signature-clear-btn, .signature-save-btn {
            flex: 1;
            padding: 12px;
            border-radius: 8px;
            border: none;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
        }
        .signature-clear-btn {
            background: var(--bg);
            color: var(--text);
        }
        .signature-save-btn {
            background: var(--accent);
            color: white;
        }
        
        /* Editable report styles */
        .editable-report .editable-field {
            display: inline-block;
            min-width: 80px;
            padding: 2px 6px;
            border-radius: 4px;
            border: 1px solid transparent;
            transition: all 0.2s;
            cursor: text;
        }
        .editable-report .editable-field:hover {
            background: rgba(255,255,255,0.03);
            border-color: var(--border);
        }
        .editable-report .editable-field:focus {
            outline: none;
            background: rgba(59, 130, 246, 0.1);
            border-color: #3B82F6;
        }
        .editable-report .editable-field.empty {
            color: var(--text-dim);
            font-style: italic;
        }
        .editable-report .editable-field.empty::before {
            content: attr(data-placeholder);
        }
        .editable-report .editable-field:focus.empty::before {
            content: '';
        }
        .editable-report .editable-field:not(:empty).empty::before {
            content: '';
        }
        
        /* Meta editable */
        .rpt-meta-editable {
            display: flex;
            gap: 16px;
            flex-wrap: wrap;
            margin-top: 8px;
        }
        .rpt-meta-editable .meta-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .rpt-meta-editable .meta-label {
            font-size: 10px;
            color: var(--text-dim);
            text-transform: uppercase;
        }
        
        /* Dropdowns */
        .status-dropdown, .type-dropdown, .result-status-dropdown {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text);
            padding: 4px 8px;
            font-size: 11px;
            cursor: pointer;
        }
        .status-dropdown:focus, .type-dropdown:focus, .result-status-dropdown:focus {
            outline: none;
            border-color: #3B82F6;
        }
        .rpt-status-select { display: flex; align-items: center; }
        
        /* Result editable */
        .rpt-result-editable {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 12px;
        }
        .rpt-result-editable .result-status-dropdown {
            width: 100%;
            padding: 8px 12px;
            font-size: 13px;
            margin-bottom: 8px;
        }
        .rpt-result-editable .result-description .editable-field {
            display: block;
            width: 100%;
            min-height: 40px;
        }
        
        /* Add item button */
        .add-item-btn {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: rgba(59, 130, 246, 0.2);
            border: 1px solid rgba(59, 130, 246, 0.3);
            color: #3B82F6;
            font-size: 14px;
            line-height: 1;
            cursor: pointer;
            margin-left: 8px;
            transition: all 0.2s;
        }
        .add-item-btn:hover {
            background: rgba(59, 130, 246, 0.3);
        }
        
        /* Add item placeholder */
        .add-item-placeholder {
            padding: 8px 12px;
            border: 1px dashed var(--border);
            border-radius: 6px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            margin-top: 8px;
        }
        .add-item-placeholder:hover {
            border-color: #3B82F6;
            background: rgba(59, 130, 246, 0.05);
        }
        .add-item-placeholder .placeholder-text {
            font-size: 12px;
            color: var(--text-dim);
        }
        
        /* Remove item button */
        .remove-item-btn {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: transparent;
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: #ef4444;
            font-size: 12px;
            line-height: 1;
            cursor: pointer;
            opacity: 0;
            transition: all 0.2s;
            flex-shrink: 0;
        }
        .list-item:hover .remove-item-btn {
            opacity: 1;
        }
        .remove-item-btn:hover {
            background: rgba(239, 68, 68, 0.2);
        }
        
        /* List items */
        .editable-report .list-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .editable-report .rpt-checklist .list-item .editable-field {
            flex: 1;
        }
        
        /* Photos placeholder */
        .photos-placeholder {
            padding: 20px;
            text-align: center;
            border: 1px dashed var(--border);
            border-radius: 8px;
            color: var(--text-dim);
            font-size: 12px;
        }
        
        /* Tech grid */
        .tech-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }
        @media (max-width: 500px) {
            .tech-grid { grid-template-columns: 1fr; }
        }
        
        .report-body { flex: 1; overflow-y: auto; padding: 14px; }
        
        /* Live preview container */
        .report-preview-container { min-height: 100%; }
        .report-preview-empty { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 300px; text-align: center; color: var(--text-dim); }
        .report-preview-empty .icon { width: 48px; height: 48px; margin-bottom: 16px; opacity: 0.3; }
        .report-preview-empty p { font-size: 13px; max-width: 250px; line-height: 1.5; }
        
        /* Report preview styles - same as chat report but adapted for drawer */
        .report-body .rpt { font-size: 12px; }
        .report-body .rpt-header { padding: 12px; }
        .report-body .rpt-title { font-size: 14px; }
        .report-body .rpt-section { padding: 12px; }
        .report-body .rpt-label { font-size: 10px; }
        .report-body .rpt-text { font-size: 12px; }
        .report-body .rpt-row { font-size: 11px; }
        
        .r-field { margin-bottom: 12px; }
        .r-label { font-size: 9px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.3px; color: var(--text-dim); margin-bottom: 4px; }
        .r-value { font-size: 13px; padding: 9px 11px; background: var(--card); border: 1px solid var(--border); border-radius: 8px; min-height: 40px; }
        .report-footer { display: flex; gap: 8px; padding: 12px 14px; padding-bottom: max(12px, env(safe-area-inset-bottom)); border-top: 1px solid var(--border); flex-shrink: 0; }
        .r-btn { flex: 1; display: flex; align-items: center; justify-content: center; gap: 6px; padding: 11px; border-radius: 10px; font-size: 12px; font-weight: 600; cursor: pointer; border: none; transition: all 0.2s; }
        .r-btn.primary { background: linear-gradient(135deg, #22c55e, #16a34a); color: white; }
        .r-btn.primary:hover { box-shadow: 0 4px 14px var(--assistant-glow); }
        .r-btn.secondary { background: var(--card); border: 1px solid var(--border); color: rgba(255,255,255,0.6); }
        .r-btn .icon { width: 14px; height: 14px; }

        /*  DRAWER v12.5 EDITABLE REPORT STYLES - EXACT FROM STANDALONE  */
        .rpt-doc { outline: none; min-height: 100%; padding: 0 8px; }
        
        /* BLOCKS - exact from standalone */
        .b { position: relative; margin-bottom: 2px; padding: 2px 4px 2px 32px; border-radius: 2px; }
        .b:hover { background: rgba(255,255,255,0.04); }
        .b:focus-within { background: rgba(0,212,170,0.06); }
        .b-content { outline: none; min-height: 20px; color: var(--text); }
        .b-content:empty::before { content: attr(data-ph); color: var(--text-dim); font-style: italic; }
        .b-content:focus { outline: none; }
        
        .b-h1 .b-content { font-size: 22px; font-weight: 600; line-height: 1.3; margin-bottom: 16px; color: var(--text); }
        .b-h2 .b-content { font-size: 16px; font-weight: 600; line-height: 1.4; margin-top: 24px; margin-bottom: 10px; padding-bottom: 6px; border-bottom: 0.5px solid rgba(138,146,160,0.3); color: var(--text); }
        .b-h3 .b-content { font-size: 14px; font-weight: 600; line-height: 1.4; margin-top: 14px; margin-bottom: 6px; color: var(--text); }
        .b-p .b-content { font-size: 13px; line-height: 1.7; color: var(--text); }
        .b-p .b-content, .b-bullet .b-content, .b-arrow .b-content { text-align: justify; }
        
        .b .lbl { color: var(--text-dim); font-size: 12px; }
        .b .val { color: var(--text); font-weight: 500; }
        
        /* BULLETS - exact spacing from standalone */
        .b-bullet { padding-left: 52px; }
        .b-bullet::before { content: ""; position: absolute; left: 32px; color: var(--assistant); font-weight: bold; font-size: 14px; }
        .b-bullet .b-content { font-size: 13px; line-height: 1.6; }
        
        .b-num { padding-left: 52px; }
        .b-num::before { content: attr(data-num) "."; position: absolute; left: 32px; color: var(--assistant); font-size: 13px; }
        
        /* ARROWS - with proper spacing (space after arrow) */
        .b-arrow { padding-left: 52px; }
        .b-arrow::before { content: "  "; position: absolute; left: 32px; color: var(--assistant); font-size: 14px; white-space: pre; }
        .b-arrow .b-content { font-size: 13px; line-height: 1.6; }
        
        /* DRAG HANDLE - 6 dots */
        .drag-handle {
          position: absolute; left: 6px; top: 50%; transform: translateY(-50%);
          width: 16px; height: 20px; cursor: grab; opacity: 0; transition: opacity 0.15s;
          display: grid; grid-template-columns: repeat(2, 5px); grid-template-rows: repeat(3, 5px);
          gap: 2px; align-content: center;
        }
        .drag-handle span { width: 4px; height: 4px; background: var(--text-dim); border-radius: 50%; }
        .b:hover .drag-handle { opacity: 0.8; }
        .drag-handle:active { cursor: grabbing; }
        .b.dragging { opacity: 0.5; background: var(--bg-secondary); }
        .b.drag-over { border-top: 2px solid var(--assistant); }
        
        /* TABLES - exact from standalone */
        .b-table { margin: 16px 0; padding-left: 4px; }
        .rpt-tbl { width: 100%; border-collapse: collapse; font-size: 12px; background: transparent; border-radius: 8px; overflow: hidden; }
        .rpt-tbl th, .rpt-tbl td { border: 1px solid var(--border); padding: 8px 12px; text-align: left; outline: none; background: transparent; }
        .rpt-tbl th { background: rgba(255,255,255,0.04); font-weight: 500; color: var(--text-dim); text-transform: uppercase; font-size: 10px; letter-spacing: 0.5px; }
        .rpt-tbl td { color: var(--text); font-size: 12px; }
        .rpt-tbl td:focus, .rpt-tbl th:focus { background: rgba(34,197,94,0.1); outline: none; }
        .rpt-tbl tbody tr:hover { background: rgba(255,255,255,0.03); }
        /* Table actions - ALWAYS visible */
        .tbl-actions { margin-top: 8px; display: flex; gap: 8px; flex-wrap: wrap; }
        .tbl-btn { font-size: 11px; padding: 6px 10px; background: transparent; border: 1px solid var(--border); border-radius: 4px; cursor: pointer; color: var(--text-dim); transition: all 0.2s; }
        .tbl-btn:hover { background: rgba(255,255,255,0.05); color: var(--text); }
        .tbl-btn-danger { color: #ef4444; border-color: rgba(239,68,68,0.3); }
        .tbl-btn-danger:hover { background: rgba(239,68,68,0.1); }
        
        /* FLOATING FONT TOOLBAR */
        .font-toolbar {
          position: fixed; display: none; background: #ffffff; border-radius: 10px;
          box-shadow: 0 4px 20px rgba(0,0,0,0.25); padding: 6px 10px; gap: 2px; z-index: 1000; align-items: center;
        }
        .font-toolbar.visible { display: flex; }
        .ft-btn { width: 32px; height: 32px; border: none; background: transparent; color: #333; font-size: 13px; cursor: pointer; border-radius: 6px; display: flex; align-items: center; justify-content: center; }
        .ft-btn:hover { background: #f0f0f0; }
        .ft-btn.active { background: #e0e0e0; }
        .ft-sep { width: 1px; height: 20px; background: #ddd; margin: 0 4px; }
        .ft-dropdown { position: relative; }
        .ft-dropdown-btn { padding: 4px 10px; background: transparent; border: none; color: #333; font-size: 13px; cursor: pointer; border-radius: 6px; display: flex; align-items: center; gap: 4px; }
        .ft-dropdown-btn:hover { background: #f0f0f0; }
        .ft-dropdown-menu { position: absolute; top: 100%; left: 0; background: #fff; border-radius: 8px; box-shadow: 0 4px 16px rgba(0,0,0,0.15); padding: 4px; min-width: 150px; display: none; z-index: 1001; }
        .ft-dropdown:hover .ft-dropdown-menu { display: block; }
        .ft-dropdown-item { padding: 8px 12px; border-radius: 4px; cursor: pointer; font-size: 13px; color: #333; }
        .ft-dropdown-item:hover { background: #f0f0f0; }
        .ft-dropdown-item.h1 { font-size: 18px; font-weight: 600; }
        .ft-dropdown-item.h2 { font-size: 16px; font-weight: 600; }
        .ft-dropdown-item.h3 { font-size: 14px; font-weight: 600; }
        
        /* SIGNATURE SECTION */
        .rpt-signature-section { margin-top: 32px; padding-top: 20px; border-top: 1px solid var(--border); }
        .rpt-signature-title { font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 1px; color: var(--text-dim); margin-bottom: 16px; }
        .rpt-signature-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        @media (max-width: 500px) { .rpt-signature-grid { grid-template-columns: 1fr; } }
        .rpt-signature-box { background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 6px; padding: 14px; }
        .rpt-signature-box-title { font-size: 11px; font-weight: 500; color: var(--text-dim); margin-bottom: 10px; text-transform: uppercase; letter-spacing: 0.5px; }
        .rpt-signature-area { height: 90px; border: 2px dashed var(--border); border-radius: 4px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: border-color 0.2s; }
        .rpt-signature-area:hover { border-color: var(--assistant); }
        .rpt-signature-area img { max-height: 100%; max-width: 100%; object-fit: contain; }
        .rpt-signature-placeholder { color: var(--text-dim); font-size: 12px; font-style: italic; }
        .rpt-signature-name-input { margin-top: 10px; width: 100%; text-align: center; background: transparent; border: none; border-bottom: 1px solid var(--border); color: var(--text); font-size: 12px; padding: 6px 8px; outline: none; }
        .rpt-signature-name-input:focus { border-bottom-color: var(--assistant); }
        .rpt-signature-name-input::placeholder { color: var(--text-dim); font-style: italic; }
        
        /* AUTO-SAVE INDICATOR */
        .autosave-indicator { position: fixed; bottom: 80px; right: 20px; padding: 8px 12px; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 6px; font-size: 11px; color: var(--text-dim); opacity: 0; transition: opacity 0.3s; z-index: 100; }
        .autosave-indicator.show { opacity: 1; }
        .autosave-indicator.success { color: var(--assistant); }

        /* PHOTOS SECTION - v12.5 - Simple grid */
        .photos-grid-v12 { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 12px; margin: 12px 0 12px 32px; }
        .photo-item-v12 { position: relative; border-radius: 6px; overflow: hidden; background: var(--bg-secondary); border: 1px solid var(--border); cursor: grab; }
        .photo-item-v12.dragging { opacity: 0.5; cursor: grabbing; }
        .photo-item-v12 img { width: 100%; height: 90px; object-fit: cover; cursor: pointer; transition: transform 0.2s; }
        .photo-item-v12 img:hover { transform: scale(1.02); }
        .photo-caption-input { width: 100%; padding: 5px 6px; background: transparent; border: none; border-top: 1px solid var(--border); color: var(--text); font-size: 10px; text-align: center; outline: none; }
        .photo-caption-input::placeholder { color: var(--text-dim); font-style: italic; }
        .photo-caption-input:focus { background: rgba(34,197,94,0.05); }
        .photo-remove-btn-v12 { position: absolute; top: 4px; right: 4px; width: 18px; height: 18px; border-radius: 50%; background: rgba(239,68,68,0.9); color: white; border: none; font-size: 11px; cursor: pointer; display: flex; align-items: center; justify-content: center; opacity: 0; transition: opacity 0.2s; }
        .photo-item-v12:hover .photo-remove-btn-v12 { opacity: 1; }
        .photo-drop-zone-v12 { margin: 12px 0 12px 32px; padding: 20px; border: 2px dashed var(--border); border-radius: 6px; text-align: center; color: var(--text-dim); cursor: pointer; transition: all 0.2s; display: flex; flex-direction: column; align-items: center; gap: 6px; }
        .photo-drop-zone-v12:hover { border-color: var(--assistant); color: var(--text); background: rgba(34,197,94,0.05); }
        .photo-drop-zone-v12.drag-active { border-color: var(--assistant); background: rgba(34,197,94,0.1); }
        .photo-drop-zone-v12 svg { width: 24px; height: 24px; opacity: 0.5; }
        .photo-drop-zone-v12 span { font-size: 11px; }

        /* ==================== HOTLINE VIEW ==================== */
        .hotline-view { position: fixed; inset: 0; display: none; z-index: 200; background: var(--bg); background-image: linear-gradient(var(--grid-color) 1px, transparent 1px), linear-gradient(90deg, var(--grid-color) 1px, transparent 1px); background-size: 32px 32px; }
        .hotline-view.active { display: block; }
        .hotline-close { position: absolute; top: max(16px, env(safe-area-inset-top)); right: 16px; width: 40px; height: 40px; border-radius: 50%; background: var(--card); border: 1px solid var(--border); color: rgba(255,255,255,0.5); cursor: pointer; display: flex; align-items: center; justify-content: center; z-index: 300; transition: all 0.2s; }
        .hotline-close:hover { background: rgba(255,255,255,0.08); color: rgba(255,255,255,0.8); }
        .hotline-close .icon { width: 18px; height: 18px; }

        .hotline-widget { width: 100%; padding: 40px 20px; position: absolute; top: 50%; left: 0; right: 0; transform: translateY(-50%); z-index: 100; text-align: center; transition: all 0.8s cubic-bezier(0.4, 0, 0.2, 1); }
        .hotline-widget.chat-mode { top: 10px; transform: translateY(0); padding-top: max(80px, calc(40px + env(safe-area-inset-top))); padding-bottom: 20px; }

        .pulse-sphere { position: relative; width: 140px; height: 140px; margin: 0 auto; cursor: pointer; transition: filter 0.3s ease, width 0.6s ease, height 0.6s ease; filter: drop-shadow(0 4px 20px rgba(239, 68, 68, 0.4)); }
        .pulse-sphere:hover { filter: drop-shadow(0 6px 28px rgba(239, 68, 68, 0.6)); transform: scale(1.03); }
        .pulse-sphere.connected { filter: drop-shadow(0 4px 20px rgba(80, 220, 120, 0.4)); }
        .pulse-sphere.connected:hover { filter: drop-shadow(0 6px 28px rgba(80, 220, 120, 0.6)); }
        .pulse-sphere.ai-speaking { animation: aiSpeakingPulse 0.8s ease-in-out infinite; }
        @keyframes aiSpeakingPulse {
            0%, 100% { transform: scale(1); filter: drop-shadow(0 4px 20px rgba(80, 220, 120, 0.4)); }
            50% { transform: scale(1.08); filter: drop-shadow(0 8px 30px rgba(80, 220, 120, 0.7)); }
        }
        
        /* Speaking bars animation */
        @keyframes speakPulse {
            0%, 100% { transform: scaleY(0.5); opacity: 0.6; }
            50% { transform: scaleY(1); opacity: 1; }
        }
        
        .hotline-widget.chat-mode .pulse-sphere { width: 80px; height: 80px; }

        .pulse-atmosphere { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 120%; height: 120%; border-radius: 50%; background: radial-gradient(circle, rgba(239, 68, 68, 0.3) 0%, transparent 70%); filter: blur(8px); animation: atmospherePulse 4s ease-in-out infinite; pointer-events: none; transition: background 0.5s ease, opacity 0.5s ease; }
        .pulse-sphere.connected .pulse-atmosphere { background: radial-gradient(circle, rgba(100, 238, 140, 0.25) 0%, transparent 70%); }
        .pulse-sphere.connecting .pulse-atmosphere, .pulse-sphere.disconnecting .pulse-atmosphere { opacity: 0; }
        @keyframes atmospherePulse { 0%, 100% { opacity: 0.6; transform: translate(-50%, -50%) scale(1); } 50% { opacity: 0.85; transform: translate(-50%, -50%) scale(1.05); } }

        .pulse-ring { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 100%; height: 100%; border: 2.5px solid rgba(239, 68, 68, 0.5); border-radius: 50%; animation: pulseRingExpand 3.5s ease-out infinite; pointer-events: none; transition: opacity 0.5s ease; }
        .pulse-ring:nth-child(2) { animation-delay: 1.2s; }
        .pulse-ring:nth-child(3) { animation-delay: 2.4s; }
        @keyframes pulseRingExpand { 0% { width: 100%; height: 100%; opacity: 0.7; } 100% { width: 200%; height: 200%; opacity: 0; } }
        .pulse-sphere.connected .pulse-ring, .pulse-sphere.connecting .pulse-ring, .pulse-sphere.disconnecting .pulse-ring { opacity: 0 !important; }

        .pulse-core { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 100%; height: 100%; border-radius: 50%; background: linear-gradient(180deg, #ff9988 0%, #ff7766 12%, #ff5544 25%, #ef4444 40%, #dc3333 55%, #cc2222 70%, #bb1111 85%, #991111 100%); box-shadow: 0 0 20px 4px rgba(239, 68, 68, 0.4), 0 8px 30px rgba(0, 0, 0, 0.35), inset 0 -25px 40px rgba(100, 0, 0, 0.5), inset 0 3px 10px rgba(255, 200, 200, 0.3); position: relative; overflow: hidden; }
        .pulse-core::after { content: ''; position: absolute; top: 8%; left: 15%; width: 40%; height: 30%; border-radius: 50%; background: radial-gradient(ellipse at 50% 50%, rgba(255, 255, 255, 0.35) 0%, transparent 70%); pointer-events: none; }
        .pulse-sphere.connected .pulse-core { background: linear-gradient(180deg, #99ffbb 0%, #88ffaa 12%, #77ee99 25%, #66dd88 40%, #55cc77 55%, #44bb66 70%, #33aa55 85%, #229944 100%); box-shadow: 0 0 20px 4px rgba(80, 220, 120, 0.35), 0 8px 30px rgba(0, 0, 0, 0.35), inset 0 -25px 40px rgba(20, 80, 40, 0.5), inset 0 3px 10px rgba(200, 255, 220, 0.25); }
        .pulse-sphere.connecting .pulse-core { animation: pulseLiquidMorph 2.5s cubic-bezier(0.4, 0.0, 0.2, 1) forwards; }
        @keyframes pulseLiquidMorph {
            0% { border-radius: 50%; background: linear-gradient(180deg, #ff9988 0%, #ff7766 12%, #ff5544 25%, #ef4444 40%, #dc3333 55%, #cc2222 70%, #bb1111 85%, #991111 100%); transform: translate(-50%, -50%) rotate(0deg) scale(1); }
            15% { border-radius: 42% 58% 65% 35% / 38% 55% 45% 62%; transform: translate(-50%, -50%) rotate(-5deg) scale(0.92); }
            30% { border-radius: 65% 35% 45% 55% / 55% 35% 65% 45%; transform: translate(-50%, -50%) rotate(8deg) scale(1.08); }
            45% { border-radius: 38% 62% 58% 42% / 62% 48% 52% 38%; transform: translate(-50%, -50%) rotate(-3deg) scale(0.95); }
            60% { border-radius: 58% 42% 35% 65% / 48% 65% 35% 52%; transform: translate(-50%, -50%) rotate(6deg) scale(1.06); background: linear-gradient(180deg, #99ffbb 0%, #88ffaa 12%, #77ee99 25%, #66dd88 40%, #55cc77 55%, #44bb66 70%, #33aa55 85%, #229944 100%); }
            75% { border-radius: 45% 55% 62% 38% / 55% 42% 58% 45%; transform: translate(-50%, -50%) rotate(-2deg) scale(0.97); }
            100% { border-radius: 50%; transform: translate(-50%, -50%) rotate(0deg) scale(1); background: linear-gradient(180deg, #99ffbb 0%, #88ffaa 12%, #77ee99 25%, #66dd88 40%, #55cc77 55%, #44bb66 70%, #33aa55 85%, #229944 100%); }
        }
        .pulse-sphere.disconnecting .pulse-core { animation: pulseLiquidMorphReverse 2.5s cubic-bezier(0.4, 0.0, 0.2, 1) forwards; }
        @keyframes pulseLiquidMorphReverse {
            0% { border-radius: 50%; background: linear-gradient(180deg, #99ffbb 0%, #88ffaa 12%, #77ee99 25%, #66dd88 40%, #55cc77 55%, #44bb66 70%, #33aa55 85%, #229944 100%); transform: translate(-50%, -50%) rotate(0deg) scale(1); }
            100% { border-radius: 50%; background: linear-gradient(180deg, #ff9988 0%, #ff7766 12%, #ff5544 25%, #ef4444 40%, #dc3333 55%, #cc2222 70%, #bb1111 85%, #991111 100%); transform: translate(-50%, -50%) rotate(0deg) scale(1); }
        }

        .pulse-icon { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); display: flex; align-items: center; justify-content: center; gap: 5px; pointer-events: none; transition: opacity 0.3s ease; z-index: 10; }
        .pulse-sphere.connecting .pulse-icon, .pulse-sphere.disconnecting .pulse-icon { opacity: 0; }
        .hotline-widget.chat-mode .pulse-icon { gap: 3px; }
        .voice-bar { width: 6px; background: white; border-radius: 3px; animation: voiceWave 1.2s ease-in-out infinite; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        .voice-bar:nth-child(1) { height: 16px; animation-delay: 0s; }
        .voice-bar:nth-child(2) { height: 32px; animation-delay: 0.1s; }
        .voice-bar:nth-child(3) { height: 48px; animation-delay: 0.2s; }
        .voice-bar:nth-child(4) { height: 32px; animation-delay: 0.3s; }
        .voice-bar:nth-child(5) { height: 16px; animation-delay: 0.4s; }
        .hotline-widget.chat-mode .voice-bar { width: 4px; }
        .hotline-widget.chat-mode .voice-bar:nth-child(1) { height: 10px; }
        .hotline-widget.chat-mode .voice-bar:nth-child(2) { height: 18px; }
        .hotline-widget.chat-mode .voice-bar:nth-child(3) { height: 26px; }
        .hotline-widget.chat-mode .voice-bar:nth-child(4) { height: 18px; }
        .hotline-widget.chat-mode .voice-bar:nth-child(5) { height: 10px; }
        @keyframes voiceWave { 0%, 100% { transform: scaleY(0.5); opacity: 0.7; } 50% { transform: scaleY(1); opacity: 1; } }

        .widget-label { margin-top: 80px; font-size: 18px; font-weight: 600; color: rgba(255,255,255,0.9); text-transform: uppercase; letter-spacing: 2px; transition: all 0.4s ease; }
        .pulse-sphere.connected ~ .widget-label { color: #50dc78; }
        .hotline-widget.chat-mode .widget-label { font-size: 12px; margin-top: 14px; }
        .widget-sublabel { font-size: 13px; color: rgba(255,255,255,0.5); margin-top: 8px; font-weight: 500; transition: all 0.4s ease; }
        .hotline-widget.chat-mode .widget-sublabel { font-size: 10px; margin-top: 4px; }

        .hotline-chat { position: absolute; top: 0; left: 0; right: 0; bottom: 0; display: flex; flex-direction: column; opacity: 0; pointer-events: none; transition: opacity 0.6s ease 0.3s; z-index: 50; }
        .hotline-chat.visible { opacity: 1; pointer-events: auto; }
        .chat-spacer { flex-shrink: 0; height: 280px; transition: height 0.6s ease; }
        .chat-messages-outer { flex: 1; display: flex; justify-content: center; overflow: hidden; padding: 0 16px; -webkit-mask-image: linear-gradient(to bottom, transparent 0%, black 10%, black 100%); mask-image: linear-gradient(to bottom, transparent 0%, black 10%, black 100%); }
        .chat-messages { width: 100%; max-width: 600px; overflow-y: auto; padding: 0 0 100px 0; display: flex; flex-direction: column; gap: 16px; }
        .messages-wrapper { width: 100%; display: flex; flex-direction: column; gap: 16px; padding: 10px 0; }
        .chat-empty { text-align: center; padding: 40px 20px; color: rgba(255,255,255,0.3); font-size: 14px; }

        .hotline-msg { display: flex; flex-direction: column; gap: 6px; max-width: 85%; animation: msgFloat 0.4s ease; }
        @keyframes msgFloat { from { opacity: 0; transform: translateY(16px); } to { opacity: 1; transform: translateY(0); } }
        .hotline-msg.user { align-self: flex-end; align-items: flex-end; }
        .hotline-msg.ai { align-self: flex-start; align-items: flex-start; }
        .msg-label { font-size: 10px; font-weight: 600; text-transform: uppercase; letter-spacing: 1px; padding: 0 8px; color: rgba(255,255,255,0.4); }
        .hotline-msg .msg-bubble { padding: 14px 18px; font-size: 14px; line-height: 1.5; border-radius: 20px; }
        .hotline-msg.ai .msg-bubble { background: rgba(255,255,255,0.06); color: rgba(255,255,255,0.9); border: 1px solid rgba(255,255,255,0.1); border-bottom-left-radius: 6px; }
        .hotline-msg.user .msg-bubble { background: linear-gradient(135deg, #ef4444, #cc2222); color: white; border-bottom-right-radius: 6px; }
        .msg-time { font-size: 10px; padding: 0 8px; color: rgba(255,255,255,0.3); }

        .toggle-chat { position: absolute; bottom: max(24px, env(safe-area-inset-bottom)); left: 50%; transform: translateX(-50%) translateY(100px); display: flex; align-items: center; gap: 10px; padding: 14px 28px; background: rgba(255,255,255,0.08); backdrop-filter: blur(20px); border-radius: 50px; border: 1px solid rgba(255,255,255,0.1); color: rgba(255,255,255,0.9); font-size: 13px; font-weight: 500; cursor: pointer; transition: all 0.4s ease; z-index: 200; opacity: 0; pointer-events: none; }
        .toggle-chat.visible { transform: translateX(-50%) translateY(0); opacity: 1; pointer-events: auto; }
        .toggle-chat:hover { background: rgba(255,255,255,0.12); }
        .toggle-icon { width: 20px; height: 20px; transition: transform 0.3s ease; }
        .toggle-chat.open .toggle-icon { transform: rotate(180deg); }

        /* TOAST */
        .toast { position: fixed; top: max(12px, env(safe-area-inset-top)); left: 50%; transform: translateX(-50%) translateY(-100px); padding: 10px 20px; background: rgba(20,24,32,0.95); border: 1px solid var(--border); border-radius: 8px; font-size: 12px; z-index: 700; transition: transform 0.3s; pointer-events: none; }
        .toast.show { transform: translateX(-50%) translateY(0); pointer-events: auto; }

        @media (max-width: 768px) {
            .pulse-sphere { width: 120px; height: 120px; }
            .voice-bar { width: 5px; }
            .voice-bar:nth-child(1) { height: 12px; }
            .voice-bar:nth-child(2) { height: 24px; }
            .voice-bar:nth-child(3) { height: 36px; }
            .voice-bar:nth-child(4) { height: 24px; }
            .voice-bar:nth-child(5) { height: 12px; }
            .widget-label { font-size: 16px; margin-top: 70px; }
            .hotline-widget.chat-mode .pulse-sphere { width: 60px; height: 60px; }
            .chat-spacer { height: 240px; }
        }

        /* ==================== ONBOARDING ==================== */
        .login-icon-slot { width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; position: relative; flex-shrink: 0; }
        .login-back { width: 32px; height: 32px; border-radius: 50%; background: rgba(255,255,255,0.05); border: none; color: var(--text-dim); cursor: pointer; display: none; align-items: center; justify-content: center; flex-shrink: 0; transition: all 0.2s; }
        .login-back:hover { background: rgba(255,255,255,0.1); color: var(--text); }
        .login-back svg { width: 16px; height: 16px; stroke: currentColor; fill: none; }
        .login-input-container { flex: 1; position: relative; height: 32px; overflow: hidden; }
        .login-input-slider { display: flex; transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1); height: 100%; }
        .login-input-slide { min-width: 100%; display: flex; align-items: center; }
        
        .onboarding-section { display: flex; flex-direction: column; align-items: center; padding: 12px 0 20px 0; }
        .onboarding-section.hidden { display: none; }
        .welcome-section { text-align: center; margin-bottom: 12px; margin-top: 8px; }
        .welcome-text { font-size: 24px; font-weight: 300; }
        .welcome-text strong { font-weight: 700; color: var(--copilot); }
        .welcome-sub { font-size: 13px; color: var(--text-dim); margin-top: 6px; }
        .onboarding-card { background: var(--card); border: 1px solid var(--border); border-radius: 16px; padding: 20px; width: 100%; position: relative; }
        .onboarding-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px; }
        .onboarding-title { font-size: 13px; font-weight: 600; }
        .onboarding-progress { font-size: 11px; color: var(--copilot); }
        .onboarding-steps { display: flex; flex-direction: column; gap: 8px; }
        .onboarding-step { display: flex; align-items: center; gap: 12px; padding: 12px; background: rgba(255,255,255,0.02); border: 1px solid transparent; border-radius: 12px; cursor: pointer; transition: all 0.2s; }
        .onboarding-step:hover { background: rgba(255,255,255,0.05); border-color: var(--border); }
        .onboarding-step.completed { opacity: 0.6; }
        .onboarding-step.completed:hover { opacity: 0.8; }
        .onboarding-step.active { background: rgba(255,107,53,0.08); border-color: rgba(255,107,53,0.2); }
        .onboarding-step.locked { opacity: 0.4; cursor: default; }
        .onboarding-step.locked:hover { background: rgba(255,255,255,0.02); border-color: transparent; }
        .step-check { width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
        .step-check.done { background: var(--assistant); }
        .step-check.done svg { stroke: white; }
        .step-check.pending { background: rgba(255,255,255,0.05); border: 2px solid var(--border); }
        .step-check.current { background: rgba(255,107,53,0.15); border: 2px solid var(--copilot); }
        .step-check svg { width: 12px; height: 12px; stroke: currentColor; fill: none; stroke-width: 2.5; }
        .step-content { flex: 1; display: flex; align-items: center; gap: 10px; }
        .step-title { font-size: 13px; font-weight: 500; }
        .step-divider { width: 1px; height: 16px; background: rgba(255,255,255,0.1); }
        .step-tool { display: flex; align-items: center; gap: 6px; }
        .step-tool-icon { width: 16px; height: 16px; }
        .step-tool-icon.copilot { color: var(--copilot); }
        .step-tool-icon.assistant { color: var(--assistant); }
        .step-tool-name { font-size: 11px; font-weight: 600; }
        .step-tool-name.copilot { color: var(--copilot); }
        .step-tool-name.assistant { color: var(--assistant); }
        .step-arrow { width: 16px; height: 16px; color: rgba(255,255,255,0.3); flex-shrink: 0; }
        .brand-select-inline { display: none; flex-direction: column; gap: 6px; margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border); }
        .brand-select-inline.show { display: flex; }
        .brand-select-option { display: flex; align-items: center; gap: 10px; padding: 10px 12px; background: rgba(255,255,255,0.03); border: 1px solid var(--border); border-radius: 10px; cursor: pointer; transition: all 0.2s; }
        .brand-select-option:hover { background: rgba(255,255,255,0.06); }
        .brand-select-option.selected { background: rgba(34,197,94,0.1); border-color: var(--assistant); }
        .brand-select-name { font-size: 13px; font-weight: 500; flex: 1; }
        .brand-select-dot { width: 8px; height: 8px; border-radius: 50%; background: rgba(255,255,255,0.2); flex-shrink: 0; }
        .brand-select-option.selected .brand-select-dot { background: var(--assistant); box-shadow: 0 0 6px var(--assistant); }
        .congrats-content { display: none; text-align: center; padding: 30px 20px; }
        .onboarding-card.congrats .onboarding-header, .onboarding-card.congrats .onboarding-steps { display: none; }
        .onboarding-card.congrats .congrats-content { display: block; }
        .congrats-close { position: absolute; top: 12px; right: 12px; width: 32px; height: 32px; border-radius: 50%; background: rgba(255,255,255,0.05); border: 1px solid var(--border); color: rgba(255,255,255,0.5); cursor: pointer; display: none; align-items: center; justify-content: center; }
        .congrats-close:hover { background: rgba(255,255,255,0.1); color: var(--text); }
        .congrats-close svg { width: 14px; height: 14px; }
        .onboarding-card.congrats .congrats-close { display: flex; }
        .congrats-icon { font-size: 56px; margin-bottom: 12px; }
        .congrats-title { font-size: 20px; font-weight: 700; margin-bottom: 8px; }
        .congrats-sub { font-size: 13px; color: var(--text-dim); line-height: 1.5; }

        /* Onboarding highlight for input fields */
        .onboarding-highlight-input {
            animation: pulse-input 2s ease-in-out infinite;
        }
        @keyframes pulse-input {
            0%, 100% {
                box-shadow: 0 0 0 0 rgba(255, 107, 53, 0.4);
                border-color: rgba(255, 107, 53, 0.5);
            }
            50% {
                box-shadow: 0 0 0 6px rgba(255, 107, 53, 0);
                border-color: #FF6B35;
            }
        }

        .homepage-content { display: none; }
        .homepage-content.active { display: flex; flex-direction: column; gap: 20px; padding-top: 24px; }
        .homepage-content > * { margin: 0; }
        /* Hide homepage when onboarding is visible - higher specificity */
        .onboarding-section:not(.hidden) ~ .homepage-content.active { display: none !important; }
        .profile-view { position: fixed; inset: 0; display: none; z-index: 200; background: var(--bg); background-image: linear-gradient(var(--grid-color) 1px, transparent 1px), linear-gradient(90deg, var(--grid-color) 1px, transparent 1px); background-size: 32px 32px; flex-direction: column; }
        .profile-view.active { display: flex; }
        .profile-header { display: flex; align-items: center; gap: 12px; padding: 14px 16px; padding-top: max(14px, calc(env(safe-area-inset-top) + 6px)); flex-shrink: 0; border-bottom: 1px solid var(--border); background: var(--bg-secondary); }
        .profile-back { width: 36px; height: 36px; border-radius: 50%; background: var(--card); border: 1px solid var(--border); color: rgba(255,255,255,0.5); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
        .profile-back:hover { background: rgba(255,255,255,0.05); color: rgba(255,255,255,0.8); }
        .profile-back .icon { width: 16px; height: 16px; }
        .profile-info { flex: 1; }
        .profile-title { font-size: 13px; font-weight: 600; color: var(--copilot); }
        .profile-subtitle { font-size: 10px; color: var(--text-dim); }
        .profile-body { flex: 1; overflow-y: auto; padding: 20px 16px; display: flex; flex-direction: column; align-items: center; }
        .profile-form { width: 100%; max-width: var(--content-width); display: flex; flex-direction: column; gap: 16px; }
        .form-group { display: flex; flex-direction: column; gap: 6px; }
        .form-label { font-size: 9px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.3px; color: var(--text-dim); }
        .form-input { padding: 12px 16px; background: var(--card); border: 1px solid var(--border); border-radius: 12px; color: var(--text); font-size: 13px; outline: none; }
        .form-input:focus { border-color: var(--copilot-border); }
        .form-input::placeholder { color: rgba(255,255,255,0.25); }
        .profile-save { width: 100%; padding: 12px; background: linear-gradient(135deg, var(--copilot), #E55A2B); border: none; border-radius: 12px; color: white; font-size: 13px; font-weight: 600; cursor: pointer; margin-top: 8px; }
        .profile-save:hover { box-shadow: 0 4px 14px var(--copilot-glow); }
        
        /* Profile badge - positioned ON the profile icon */
        .nav-profile { position: relative; }
        .nav-profile-badge { position: absolute; top: 2px; left: 50%; transform: translateX(4px); color: #3B82F6; }
        .nav-profile-badge svg { width: 10px; height: 10px; fill: currentColor; stroke: none; }
        
        /* Brand dropdown - ONLY selected has green dot, NO highlight on others */
        .brand-dropdown-item { background: transparent !important; }
        .brand-dropdown-item:hover { background: rgba(255,255,255,0.06) !important; }
        .brand-dropdown-item .brand-dropdown-dot { display: none !important; }
        .brand-dropdown-item .brand-dropdown-check { display: none; }
        .brand-dropdown-item.selected .brand-dropdown-dot { display: block !important; background: var(--assistant) !important; box-shadow: 0 0 6px var(--assistant); }
        .brand-dropdown-item.onboard-selected .brand-dropdown-dot { display: block !important; background: var(--assistant) !important; box-shadow: 0 0 6px var(--assistant); }
        .brand-dropdown-item.active { background: transparent !important; border: none !important; }

        /* ==================== MOBILE-FIRST OPTIMIZATIONS (WAYMO/AIRBNB STYLE) ==================== */
        
        /* Section headers */
        .sec-title { 
            font-size: 13px; 
            font-weight: 600; 
            text-transform: none; 
            letter-spacing: 0; 
            color: var(--text-dim);
        }
        
        /* Larger, more readable cards */
        .toggle-card { 
            padding: 20px 18px; 
            border-radius: 16px;
            min-height: 80px;
        }
        .toggle-card-icon { 
            width: 44px; 
            height: 44px; 
            border-radius: 12px; 
        }
        .toggle-card-icon .icon { width: 24px; height: 24px; }
        .toggle-card-icon .star-icon { width: 24px; height: 24px; }
        .toggle-card-title { font-size: 17px; font-weight: 600; }
        .toggle-card-desc { font-size: 13px; }
        
        /* Project cards - more padding, larger text */
        .proj { 
            padding: 18px 16px 18px 20px; 
            border-radius: 14px;
            gap: 14px;
            min-height: 72px;
        }
        .proj-icon { width: 40px; height: 40px; border-radius: 12px; }
        .proj-icon .icon { width: 18px; height: 18px; }
        .proj-icon .star-icon { width: 20px; height: 20px; }
        .proj-title { font-size: 15px; font-weight: 600; margin-bottom: 6px; }
        .proj-meta { font-size: 13px; }
        .proj-time { font-size: 13px; }
        
        /* Brand select row */
        .brand-select-row { 
            padding: 14px 16px; 
            border-radius: 14px;
            gap: 10px;
        }
        .brand-label { font-size: 13px; color: var(--text-dim); font-weight: 500; }
        .brand-chip { 
            padding: 10px 16px; 
            border-radius: 20px; 
            font-size: 14px;
            font-weight: 500;
        }
        
        /* Navigation - larger touch targets but shorter height */
        .nav { padding: 6px 12px; }
        .nav-item { padding: 6px 10px; gap: 3px; }
        .nav-icon { width: 20px; height: 20px; }
        .nav-label { font-size: 10px; font-weight: 600; }
        .nav-hotline { padding: 6px 10px; gap: 3px; }
        .nav-hotline .nav-icon { width: 20px; height: 20px; }
        .nav-hotline-waves { width: 20px; height: 20px; }
        
        /* Activity ring section */
        .activity-value { font-size: 36px; }
        .activity-label { font-size: 10px; letter-spacing: 1.5px; }
        .status-text { font-size: 13px; }
        
        /* Chat messages - larger, more readable */
        .msg-bubble { 
            padding: 14px 18px; 
            border-radius: 18px; 
            font-size: 15px; 
            line-height: 1.6; 
        }
        .msg-head { gap: 8px; margin-bottom: 8px; padding-bottom: 8px; }
        .msg-avatar { width: 22px; height: 22px; }
        .msg-avatar .icon { width: 10px; height: 10px; }
        .msg-name { font-size: 12px; }
        .msg-acts { gap: 6px; margin-top: 8px; }
        .msg-act { 
            padding: 8px 12px; 
            border-radius: 10px; 
            font-size: 11px;
        }
        .msg-act .icon { width: 12px; height: 12px; }
        
        /* Chat input - larger touch targets */
        .input-row { 
            padding: 8px; 
            border-radius: 28px;
            gap: 10px;
        }
        .plus-btn { width: 40px; height: 40px; }
        .plus-btn .icon { width: 18px; height: 18px; }
        .action-btn { width: 40px; height: 40px; }
        .action-btn .icon-wrap { width: 18px; height: 18px; }
        .action-btn .btn-icon { width: 18px; height: 18px; }
        .action-btn .btn-icon svg { width: 18px; height: 18px; }
        .input-text { font-size: 15px; padding: 8px 12px; }
        .input-area { min-height: 40px; }
        
        /* Panel header */
        .panel-header { 
            gap: 10px; 
            padding: 12px 14px; 
        }
        .panel-back { width: 36px; height: 36px; }
        .panel-back .icon { width: 16px; height: 16px; }
        .panel-title { font-size: 15px; }
        .panel-separator { height: 14px; }
        .panel-brand { font-size: 14px; }
        
        /* Mode toggle */
        .mode-toggle { height: 36px; border-radius: 10px; }
        .mode-btn { 
            padding: 0 14px; 
            font-size: 12px;
            gap: 6px;
        }
        .mode-btn .mode-icon { width: 18px; height: 18px; }
        
        /* Header buttons */
        .h-btn { width: 36px; height: 36px; border-radius: 10px; }
        .h-btn .icon { width: 16px; height: 16px; }
        
        /* Header */
        .header-logo-svg { height: 22px; }
        .brand-pill { 
            padding: 8px 14px; 
            border-radius: 20px;
            gap: 8px;
        }
        .brand-pill-dot { width: 10px; height: 10px; }
        .brand-pill-text { font-size: 13px; }
        .brand-pill-arrow { width: 12px; height: 12px; }
        
        /* Brand dropdown */
        .brand-dropdown { 
            min-width: 180px; 
            border-radius: 14px; 
            padding: 8px;
        }
        .brand-dropdown-item { 
            padding: 12px 14px; 
            border-radius: 10px;
            gap: 10px;
        }
        .brand-dropdown-dot { width: 10px; height: 10px; }
        .brand-dropdown-name { font-size: 14px; }
        
        /* Attach menu */
        .attach-menu { 
            border-radius: 14px; 
            padding: 6px;
            min-width: 200px;
        }
        .attach-opt { 
            padding: 12px 14px; 
            border-radius: 10px; 
            font-size: 14px;
            gap: 10px;
        }
        .attach-opt .icon { width: 18px; height: 18px; }
        
        /* Projects page header */
        .projects-page-title { font-size: 22px; font-weight: 700; margin-bottom: 6px; }
        .projects-page-sub { font-size: 14px; }
        
        /* Report sheet */
        .report-sheet { border-radius: 24px 24px 0 0; }
        .report-header { padding: 20px 20px 16px; }
        .report-title { font-size: 18px; }
        .report-close { width: 36px; height: 36px; }
        .report-body { padding: 0 20px 20px; gap: 16px; }
        .report-section { padding: 16px; border-radius: 14px; }
        .report-label { font-size: 12px; margin-bottom: 8px; }
        .report-value { font-size: 15px; }
        .report-actions { gap: 12px; padding: 16px 20px; }
        .report-footer .report-btn { 
            padding: 16px 24px; 
            border-radius: 14px; 
            font-size: 15px;
            font-weight: 600;
        }
        
        /* Photo modal */
        .photo-preview { border-radius: 16px; }
        .photo-actions { gap: 10px; }
        .photo-btn { 
            padding: 14px 20px; 
            border-radius: 12px; 
            font-size: 14px;
        }
        
        /* Onboarding */
        .onboarding-card { padding: 24px; border-radius: 18px; }
        .onboarding-title { font-size: 15px; }
        .onboarding-progress { font-size: 13px; }
        .onboarding-step { padding: 16px; border-radius: 14px; gap: 14px; }
        .step-number { width: 32px; height: 32px; font-size: 14px; }
        .step-text { font-size: 15px; }
        .step-sub { font-size: 13px; }
        
        /* Toast */
        .toast { 
            padding: 14px 20px; 
            border-radius: 14px; 
            font-size: 14px;
        }
        
        /* Login */
        .login-title { font-size: 26px; }
        .login-sub { font-size: 14px; margin-bottom: 36px; }
        .login-bar { border-radius: 44px; padding: 6px 6px 6px 10px; }
        .login-input { font-size: 15px; padding: 10px; }
        .login-btn { width: 38px; height: 38px; }
        .login-btn .icon { width: 14px; height: 14px; }
        
        /* Spacing adjustments */
        .home, .projects-page { 
            padding: 20px; 
            gap: 24px; 
        }
        .modules-toggle { gap: 14px; }
        .projects { gap: 12px; }
        .projects-list { gap: 12px; }
        .chat-body { padding: 16px; gap: 12px; }
        .chat-input { padding: 14px 16px; }
        
        /* Diagnostic/Assistant specific cards */
        .diag-card { 
            padding: 18px; 
            border-radius: 16px;
        }
        
        /* Better scrolling */
        .app-content { 
            -webkit-overflow-scrolling: touch;
            scroll-behavior: smooth;
        }
        .chat-body {
            -webkit-overflow-scrolling: touch;
            scroll-behavior: smooth;
        }
        .projects-list {
            -webkit-overflow-scrolling: touch;
            scroll-behavior: smooth;
        }

        /* ==================== MOBILE SPECIFIC FIXES ==================== */
        @media (max-width: 767px) {
            /* SAFARI & CHROME FIX */
            html, body { 
                overflow: hidden !important;
                width: 100% !important;
                height: 100% !important;
                min-height: 100% !important;
                max-height: 100% !important;
                position: fixed !important;
                top: 0 !important;
                left: 0 !important;
                right: 0 !important;
                bottom: 0 !important;
                -webkit-text-size-adjust: 100%;
            }
            
            /* App wrapper fills entire viewport */
            .app-wrapper {
                position: fixed !important;
                top: 0 !important;
                left: 0 !important;
                right: 0 !important;
                bottom: 0 !important;
                overflow: hidden !important;
                background: var(--bg) !important;
            }
            
            /* Chat view - FULL SCREEN (nav is hidden) */
            .chat-view {
                position: fixed !important;
                top: 0 !important;
                left: 0 !important;
                right: 0 !important;
                bottom: 0 !important;
                height: 100% !important;
                overflow: hidden !important;
            }
            
            /* Panel - fill available space */
            .panel {
                flex: 1;
                min-height: 0;
                display: flex;
                flex-direction: column;
                overflow: hidden;
            }
            
            /* Chat body - fill remaining space */
            .chat-body {
                flex: 1;
                min-height: 0;
                overflow-y: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            /* Chat input - CRITICAL: Add safe area padding for Safari bottom bar */
            .chat-input {
                flex-shrink: 0;
                padding: 12px 16px;
                padding-bottom: calc(16px + env(safe-area-inset-bottom, 20px));
                background: var(--bg);
            }
            
            /* Split view on mobile - stack vertically */
            .chat-view.split {
                flex-direction: column;
            }
            .chat-view.split .panel {
                flex: 1 1 auto;
                min-height: 20%;
                max-height: 80%;
                overflow: hidden;
            }
            .chat-view.split .chat-input {
                padding-bottom: 8px;
            }
            .chat-view.split .panel:last-child .chat-input {
                padding-bottom: calc(16px + env(safe-area-inset-bottom, 20px));
            }
            .chat-view.split .divider {
                z-index: 10;
            }
            
            /* Hide homepage content during onboarding */
            .onboarding-section:not(.hidden) ~ .homepage-content,
            .onboarding-section:not(.hidden) ~ .homepage-content.active {
                display: none !important;
            }
            
            /* Full width layout - remove max-width constraints */
            .header-inner { max-width: 100%; }
            .home, .projects-page { 
                max-width: 100%; 
                padding: 16px;
                padding-bottom: 0; /* Let projects-list handle the padding */
            }
            
            /* Projects page mobile - full height scroll with fade effect */
            /* Only apply these styles when projects-page is active */
            .projects-page.active {
                height: 100%;
                display: flex;
                flex-direction: column;
                position: relative;
            }
            .projects-page-header {
                background: transparent;
                position: sticky;
                top: 0;
                z-index: 10;
                padding-bottom: 12px;
            }
            .projects-page-header::after {
                content: '';
                position: absolute;
                left: -16px;
                right: -16px;
                bottom: -50px;
                height: 50px;
                background: linear-gradient(to bottom, var(--bg) 0%, var(--bg) 20%, transparent 100%);
                pointer-events: none;
                z-index: 9;
            }
            .projects-list {
                flex: 1;
                overflow-y: auto;
                padding-top: 10px;
                padding-bottom: calc(90px + env(safe-area-inset-bottom, 20px)); /* Space for nav + extra */
                margin-left: -16px;
                margin-right: -16px;
                padding-left: 16px;
                padding-right: 16px;
                /* Hide scrollbar completely */
                scrollbar-width: none;
                -ms-overflow-style: none;
            }
            .projects-list::-webkit-scrollbar {
                display: none;
            }
            
            /* NAV - only visible on home/projects/profile (hidden in chat via CSS selector) */
            .nav {
                position: fixed !important;
                left: 8px !important;
                right: 8px !important;
                bottom: env(safe-area-inset-bottom, 0px) !important;
                transform: none !important;
                width: auto !important;
                max-width: none !important;
                padding-bottom: 10px !important;
                z-index: 99999 !important;
                min-height: 70px;
            }
            .nav-inner { max-width: 100%; }
            
            /* Brand chips - single line, horizontal scroll */
            .brand-select-row { 
                flex-wrap: nowrap !important; 
                overflow-x: auto;
                overflow-y: hidden;
                -webkit-overflow-scrolling: touch;
                scrollbar-width: none;
                -ms-overflow-style: none;
                padding: 12px 14px;
            }
            .brand-select-row::-webkit-scrollbar { display: none; }
            .brand-label { flex-shrink: 0; }
            .brand-chip { flex-shrink: 0; white-space: nowrap; }
            
            /* Chat header - hide title and brand name on mobile */
            .panel-title { display: none !important; }
            .panel-separator { display: none !important; }
            .panel-brand { display: none !important; }
            
            /* Adjust panel-info when its contents are hidden */
            .panel-info { 
                display: none !important;
            }
            
            /* Panel header layout - centered toggle */
            .panel-header {
                gap: 12px;
            }
            
            /* Mode toggle - keep original style, centered */
            .mode-toggle {
                height: 32px;
                flex-shrink: 0;
                margin: 0 auto 0 0;
            }
            .mode-btn {
                padding: 0 10px;
                font-size: 11px;
            }
            .mode-btn .mode-icon { width: 14px; height: 14px; }
            
            /* Toggle cards - horizontal layout within stacked cards on mobile */
            .modules-toggle {
                flex-direction: column;
                gap: 12px;
            }
            .toggle-card {
                flex-direction: row;
                align-items: center;
                text-align: left;
                padding: 20px 16px;
                gap: 14px;
                min-height: auto;
            }
            .toggle-card-icon {
                margin: 0;
                flex-shrink: 0;
            }
            .toggle-card-content {
                display: flex;
                flex-direction: column;
                align-items: flex-start;
                flex: 1;
            }
            .toggle-card-title {
                font-size: 16px;
            }
            .toggle-card-desc {
                font-size: 12px;
            }
            .toggle-card-arrow {
                display: block;
            }
            
            /* Report sheet full width and same padding */
            .report-sheet { 
                max-width: 100% !important; 
                border-radius: 0 !important;
            }
            .report-body { padding: 0 16px 16px; }
            .report-actions { padding: 16px; }
            
            /* Ensure all cards fit within viewport */
            .toggle-card, .proj, .brand-select-row, .onboarding-card {
                max-width: 100%;
                box-sizing: border-box;
            }
            
            /* Chat bubbles - wider on mobile */
            .chat-body {
                width: 100%;
                padding: 14px;
            }
            .msg {
                max-width: 90% !important;
                min-width: 60px;
            }
            .msg.user {
                max-width: 90% !important;
            }
            .msg-bubble { 
                max-width: 100%; 
                word-wrap: break-word;
                overflow-wrap: break-word;
            }
            
            /* Activity section contained */
            .activity-section { 
                max-width: 100%; 
                overflow: hidden;
            }
        }
        
        /* 
           REPORT TEMPLATE V2 - Beautiful Structured Reports
         */
        .rpt { max-width: 100%; margin-top: 8px; }
        .rpt-header { margin-bottom: 16px; padding-bottom: 12px; border-bottom: 1px solid var(--border); }
        .rpt-header-top { display: flex; justify-content: space-between; align-items: flex-start; gap: 12px; margin-bottom: 10px; }
        .rpt-brand { font-size: 10px; font-weight: 600; text-transform: uppercase; letter-spacing: 1.2px; margin-bottom: 4px; }
        .rpt-brand.mitsubishi { color: #E60012; }
        .rpt-brand.daikin { color: #00A0E4; }
        .rpt-brand.carrier { color: #0033A0; }
        .rpt-brand.lg { color: #A50034; }
        .rpt-brand.samsung { color: #1428A0; }
        .rpt-brand.panasonic { color: #0F58A8; }
        .rpt-brand.toshiba { color: #FF0000; }
        .rpt-brand.fujitsu { color: #E60012; }
        .rpt-brand.hitachi { color: #E60012; }
        .rpt-brand.general { color: var(--assistant); }
        .rpt-title { font-size: 18px; font-weight: 600; color: var(--text); letter-spacing: -0.3px; }
        .rpt-status { display: flex; align-items: center; gap: 5px; padding: 5px 10px; border-radius: 6px; white-space: nowrap; flex-shrink: 0; }
        .rpt-status.conforme { background: rgba(34,197,94,0.12); }
        .rpt-status.non-conforme { background: rgba(239,68,68,0.1); }
        .rpt-status.en-cours { background: rgba(245,158,11,0.12); }
        .rpt-status-dot { width: 5px; height: 5px; border-radius: 50%; }
        .rpt-status.conforme .rpt-status-dot { background: #22c55e; }
        .rpt-status.conforme .rpt-status-text { color: #22c55e; }
        .rpt-status.non-conforme .rpt-status-dot { background: #ef4444; }
        .rpt-status.non-conforme .rpt-status-text { color: #ef4444; }
        .rpt-status.en-cours .rpt-status-dot { background: #f59e0b; }
        .rpt-status.en-cours .rpt-status-text { color: #f59e0b; }
        .rpt-status-text { font-size: 10px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.3px; }
        .rpt-meta { display: flex; flex-wrap: wrap; gap: 6px 14px; font-size: 11px; color: var(--text-dim); }
        .rpt-meta .val { color: rgba(255,255,255,0.65); font-weight: 500; }
        
        .rpt-card { background: rgba(255,255,255,0.02); border: 1px solid var(--border); border-radius: 14px; overflow: hidden; }
        .rpt-section { padding: 14px 16px; border-bottom: 1px solid rgba(255,255,255,0.04); }
        .rpt-section:last-child { border-bottom: none; }
        .rpt-label { font-size: 9px; font-weight: 600; color: var(--text-dim); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px; }
        
        .rpt-text { font-size: 13px; color: rgba(255,255,255,0.7); line-height: 1.6; }
        .rpt-text strong { color: #ef4444; font-weight: 600; }
        .rpt-text.success strong { color: #22c55e; }
        
        .rpt-grid { display: grid; grid-template-columns: 1fr; gap: 14px; }
        .rpt-group { display: flex; flex-direction: column; gap: 5px; }
        
        /* Row layout: Label: Value (inline, value immediately after label) */
        .rpt-row { display: flex; align-items: baseline; padding-bottom: 5px; border-bottom: 1px solid rgba(255,255,255,0.04); gap: 0; flex-wrap: wrap; }
        .rpt-row:last-child { border-bottom: none; padding-bottom: 0; }
        .rpt-row-label { font-size: 11px; color: var(--text-dim); flex-shrink: 0; }
        .rpt-row-label::after { content: ' : '; white-space: pre; }
        .rpt-row-value { font-size: 12px; color: var(--text); font-weight: 500; word-break: break-word; }
        .rpt-row-value.mono { font-family: 'SF Mono', Monaco, monospace; font-size: 11px; }
        .rpt-row-value.error { color: #ef4444; }
        .rpt-row-value.success { color: #22c55e; }
        
        /* Checklist styles (travaux effectus) - single icon, aligned */
        .rpt-checklist { list-style: none; margin: 0; padding: 0; display: flex; flex-direction: column; gap: 4px; }
        .rpt-checklist li { display: flex; align-items: flex-start; gap: 10px; font-size: 12px; color: rgba(255,255,255,0.8); line-height: 1.5; padding: 8px 12px; background: rgba(255,255,255,0.03); border-radius: 6px; }
        .rpt-checklist li .check-icon { flex-shrink: 0; width: 18px; height: 18px; display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: 700; border-radius: 50%; }
        .rpt-checklist li.done .check-icon { background: rgba(34,197,94,0.15); color: #22c55e; }
        .rpt-checklist li.error .check-icon { background: rgba(239,68,68,0.15); color: #ef4444; }
        .rpt-checklist li.pending .check-icon { background: rgba(245,158,11,0.15); color: #f59e0b; }
        
        .rpt-measures { display: flex; flex-direction: column; gap: 5px; }
        .rpt-measure { background: rgba(255,255,255,0.03); border-radius: 8px; padding: 10px 12px; display: flex; justify-content: space-between; align-items: center; }
        .rpt-measure .measure-label { font-size: 11px; color: rgba(255,255,255,0.7); }
        .rpt-measure .measure-value { font-size: 12px; font-weight: 600; font-family: 'SF Mono', Monaco, monospace; color: var(--text); }
        .rpt-measure.ok .measure-value { color: #22c55e; }
        .rpt-measure.error .measure-value { color: #ef4444; }
        .rpt-measure-info { display: flex; flex-direction: column; gap: 1px; }
        .rpt-measure-name { font-size: 11px; color: rgba(255,255,255,0.7); font-weight: 500; }
        .rpt-measure-note { font-size: 10px; color: var(--text-dim); }
        .rpt-measure-note.ok { color: #22c55e; }
        .rpt-measure-note.error { color: #ef4444; }
        .rpt-measure-val { font-size: 13px; font-weight: 600; font-family: 'SF Mono', Monaco, monospace; }
        .rpt-measure-val.ok { color: #22c55e; }
        .rpt-measure-val.error { color: #ef4444; }
        .rpt-measure-val.neutral { color: var(--text); }
        
        .rpt-list { display: flex; flex-direction: column; gap: 2px; }
        .rpt-item { display: flex; align-items: flex-start; gap: 10px; padding: 9px 12px; background: rgba(255,255,255,0.03); border-radius: 6px; }
        .rpt-item:first-child { border-radius: 6px 6px 2px 2px; }
        .rpt-item:last-child { border-radius: 2px 2px 6px 6px; }
        .rpt-item:only-child { border-radius: 6px; }
        .rpt-icon { width: 14px; height: 14px; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0; font-size: 8px; font-weight: 700; margin-top: 2px; }
        .rpt-icon.done { background: rgba(34,197,94,0.12); color: #22c55e; }
        .rpt-icon.pending { background: rgba(245,158,11,0.12); color: #f59e0b; }
        .rpt-icon.error { background: rgba(239,68,68,0.1); color: #ef4444; }
        .rpt-icon.num { background: rgba(255,255,255,0.03); color: rgba(255,255,255,0.6); border: 1px solid var(--border); font-size: 9px; }
        .rpt-item-text { font-size: 12px; color: rgba(255,255,255,0.7); line-height: 1.5; }
        
        /* Alert/Reserve styles - left bar only, no background */
        .rpt-alerts { display: flex; flex-direction: column; gap: 14px; margin-top: 8px; }
        .rpt-alert { padding: 0 0 0 12px; border-left: 3px solid #ef4444; }
        .rpt-alert.warning { border-left-color: #f59e0b; }
        .rpt-alert.info { border-left-color: #3b82f6; }
        .rpt-alert.success { border-left-color: #22c55e; }
        .rpt-alert strong { display: block; font-size: 12px; font-weight: 600; color: #ef4444; margin-bottom: 4px; }
        .rpt-alert.warning strong { color: #f59e0b; }
        .rpt-alert.info strong { color: #3b82f6; }
        .rpt-alert.success strong { color: #22c55e; }
        .rpt-alert p { font-size: 12px; color: rgba(255,255,255,0.7); line-height: 1.5; margin: 0; }
        .rpt-alert-title { font-size: 12px; font-weight: 600; color: #ef4444; margin-bottom: 4px; }
        .rpt-alert.warning .rpt-alert-title { color: #f59e0b; }
        .rpt-alert.info .rpt-alert-title { color: #3b82f6; }
        .rpt-alert.success .rpt-alert-title { color: #22c55e; }
        .rpt-alert-text { font-size: 12px; color: rgba(255,255,255,0.7); line-height: 1.5; }
        
        /* Result box */
        .rpt-result { display: flex; align-items: flex-start; gap: 12px; padding: 14px; border-radius: 8px; background: rgba(34,197,94,0.08); }
        .rpt-result.resolved { background: rgba(34,197,94,0.08); }
        .rpt-result.unresolved { background: rgba(239,68,68,0.08); }
        .rpt-result .result-icon { width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 700; background: rgba(34,197,94,0.2); color: #22c55e; flex-shrink: 0; }
        .rpt-result.unresolved .result-icon { background: rgba(239,68,68,0.2); color: #ef4444; }
        .rpt-result .result-label { font-size: 13px; font-weight: 600; color: #22c55e; }
        .rpt-result.unresolved .result-label { color: #ef4444; }
        .rpt-result .result-desc { font-size: 11px; color: rgba(255,255,255,0.6); margin-top: 4px; }
        
        .rpt-table { background: rgba(255,255,255,0.03); border-radius: 8px; overflow: hidden; margin-bottom: 10px; }
        .rpt-table:last-child { margin-bottom: 0; }
        .rpt-table-title { font-size: 10px; font-weight: 600; color: var(--text-dim); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px; }
        .rpt-th { display: grid; padding: 7px 10px; background: rgba(255,255,255,0.02); border-bottom: 1px solid rgba(255,255,255,0.04); justify-content: start; }
        .rpt-th span { font-size: 9px; font-weight: 600; color: var(--text-dim); text-transform: uppercase; letter-spacing: 0.3px; text-align: left; }
        .rpt-tr { display: grid; padding: 7px 10px; border-bottom: 1px solid rgba(255,255,255,0.04); justify-content: start; }
        .rpt-tr:last-child { border-bottom: none; }
        .rpt-tr span { font-size: 11px; color: rgba(255,255,255,0.7); overflow: hidden; text-overflow: ellipsis; text-align: left; }
        .rpt-tr span.mono { font-family: 'SF Mono', Monaco, monospace; font-size: 10px; color: var(--text); }
        .rpt-tr span.ok { color: #22c55e; font-weight: 500; }
        .rpt-tr span.err { color: #ef4444; font-weight: 500; }
        .rpt-tr span.warn { color: #f59e0b; font-weight: 500; }
        /* Table columns - all aligned left together */
        .rpt-cols-3 { grid-template-columns: 50px minmax(150px, auto) 50px; gap: 12px; }
        .rpt-cols-4 { grid-template-columns: 40px minmax(120px, auto) 70px 50px; gap: 12px; }
        .rpt-cols-5 { grid-template-columns: 40px minmax(120px, auto) 80px 50px 50px; gap: 12px; }
        
        .rpt-photos { display: grid; grid-template-columns: repeat(2, 1fr); gap: 6px; }
        .rpt-photo { position: relative; aspect-ratio: 4/3; border-radius: 8px; overflow: hidden; background: rgba(255,255,255,0.03); }
        .rpt-photo img { width: 100%; height: 100%; object-fit: cover; }
        .rpt-photo.full { grid-column: span 2; aspect-ratio: 16/9; }
        .rpt-photo-cap { position: absolute; bottom: 0; left: 0; right: 0; padding: 6px 8px; background: linear-gradient(transparent, rgba(0,0,0,0.8)); font-size: 10px; color: white; }
        
        .rpt-result { margin-bottom: 10px; }
        .rpt-result-status { font-size: 14px; line-height: 1.4; margin-bottom: 4px; }
        .rpt-result-status .err { color: #ef4444; font-weight: 600; }
        .rpt-result-status .ok { color: #22c55e; font-weight: 600; }
        .rpt-result-status .lbl { color: var(--text); font-weight: 500; }
        .rpt-result-desc { font-size: 12px; color: var(--text-dim); line-height: 1.5; }
        
        .rpt-sigs { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .rpt-sig { background: rgba(255,255,255,0.03); border-radius: 8px; padding: 10px; }
        .rpt-sig-label { font-size: 10px; color: var(--text-dim); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px; }
        .rpt-sig-line { height: 36px; border-bottom: 1px dashed var(--border); margin-bottom: 6px; }
        .rpt-sig-name { font-size: 11px; color: rgba(255,255,255,0.65); }
        .rpt-sig-date { font-size: 10px; color: var(--text-dim); }
        
        .rpt-footer { display: flex; justify-content: space-between; align-items: center; padding: 12px 14px; background: rgba(255,255,255,0.03); gap: 10px; flex-wrap: wrap; }
        .rpt-tech { display: flex; align-items: center; gap: 10px; }
        .rpt-avatar { width: 30px; height: 30px; border-radius: 50%; background: linear-gradient(135deg, var(--assistant), #16a34a); display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 10px; color: white; flex-shrink: 0; }
        .rpt-tech-name { font-size: 12px; font-weight: 500; color: var(--text); }
        .rpt-tech-time { font-size: 10px; color: var(--text-dim); }
        .rpt-actions { display: flex; gap: 6px; }
        .rpt-btn { padding: 7px 12px; border-radius: 6px; font-size: 11px; font-weight: 500; cursor: pointer; border: none; transition: all 0.2s; }
        .rpt-btn.primary { background: var(--assistant); color: white; }
        .rpt-btn.secondary { background: transparent; color: rgba(255,255,255,0.6); border: 1px solid var(--border); }
        .rpt-btn:hover { opacity: 0.9; }
        
        @media (min-width: 500px) {
            .rpt-grid { grid-template-columns: 1fr 1fr; }
            .rpt-measures { flex-direction: row; flex-wrap: wrap; }
            .rpt-measure { flex: 1; min-width: 110px; }
            .rpt-photos { grid-template-columns: repeat(3, 1fr); }
            .rpt-photo.full { grid-column: span 3; }
        }
        
        /* Light theme report */
        [data-theme="light"] .rpt-card { background: #f8fafc; border-color: rgba(0,0,0,0.06); }
        [data-theme="light"] .rpt-section { border-color: rgba(0,0,0,0.04); }
        [data-theme="light"] .rpt-text { color: #374151; }
        [data-theme="light"] .rpt-row { border-color: rgba(0,0,0,0.04); }
        [data-theme="light"] .rpt-row-value { color: #1f2937; }
        [data-theme="light"] .rpt-measure { background: rgba(0,0,0,0.02); }
        [data-theme="light"] .rpt-measure-name { color: #374151; }
        [data-theme="light"] .rpt-item { background: rgba(0,0,0,0.02); }
        [data-theme="light"] .rpt-item-text { color: #374151; }
        [data-theme="light"] .rpt-alert-text { color: #4b5563; }
        [data-theme="light"] .rpt-table { background: rgba(0,0,0,0.02); }
        [data-theme="light"] .rpt-tr span { color: #374151; }
        [data-theme="light"] .rpt-photo { background: rgba(0,0,0,0.03); }
        [data-theme="light"] .rpt-sig { background: rgba(0,0,0,0.02); }
        [data-theme="light"] .rpt-footer { background: rgba(0,0,0,0.02); }
        [data-theme="light"] .rpt-tech-name { color: #1f2937; }
        
        /*  */
        /* CELEBRATION ANIMATIONS - CONFETTI & COUNT-UP */
        /*  */
        
        .celebration-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
            z-index: 9999;
            overflow: hidden;
        }
        
        .confetti-particle {
            position: absolute;
            top: -20px;
            border-radius: 2px;
            opacity: 0;
            animation: confetti-fall var(--duration, 3s) ease-in var(--delay, 0s) forwards;
        }
        
        @keyframes confetti-fall {
            0% {
                transform: translateY(0) translateX(0) rotate(0deg);
                opacity: 1;
            }
            70% {
                opacity: 1;
            }
            100% {
                transform: translateY(120vh) translateX(var(--wobble, 0px)) rotate(720deg);
                opacity: 0;
            }
        }
        
        .plus-one-floating {
            position: fixed;
            top: 35%;
            left: 50%;
            transform: translateX(-50%);
            font-size: 64px;
            font-weight: 800;
            color: #22C55E;
            text-shadow: 0 0 40px rgba(34, 197, 94, 0.8), 0 0 80px rgba(34, 197, 94, 0.4);
            z-index: 10000;
            pointer-events: none;
            animation: float-up-fade 1.8s ease-out forwards;
        }
        
        @keyframes float-up-fade {
            0% {
                transform: translateX(-50%) translateY(0) scale(0.3);
                opacity: 0;
            }
            15% {
                transform: translateX(-50%) translateY(-20px) scale(1.2);
                opacity: 1;
            }
            100% {
                transform: translateX(-50%) translateY(-100px) scale(0.9);
                opacity: 0;
            }
        }
        
        .stats-ring-progress.animating {
        /* Glow effect via stroke opacity instead of filter */
        stroke-width: 12;
        }

/* ===== THOUGHT PROCESS V2 - SAFE ===== */
.tp-card{border:1px solid rgba(255,255,255,0.2);border-radius:8px;display:flex;flex-direction:column;overflow:hidden;margin:12px 0;background:rgba(30,30,30,0.95);min-height:60px}
.tp-card.tp-hidden{display:none}
.tp-collapsed{display:flex;align-items:center;justify-content:space-between;padding:10px 14px;gap:16px;cursor:pointer;min-height:42px}
.tp-collapsed:hover{background:rgba(255,255,255,0.03)}
.tp-collapsed-text{flex:1;color:rgba(255,255,255,0.85);font-size:14px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.tp-collapsed-chevron{color:rgba(255,255,255,0.65);flex-shrink:0;transition:transform 0.3s ease;width:20px;height:20px}
.tp-card.tp-expanded .tp-collapsed-chevron{transform:rotate(180deg)}
.tp-header-row{display:flex;min-height:34px;width:100%;cursor:pointer}
.tp-header-row:hover{background:rgba(255,255,255,0.03)}
.tp-header-left{display:flex;flex-direction:column;align-items:center;padding-left:12px}
.tp-line{width:1px;background:rgba(255,255,255,0.15);flex-grow:1;min-height:9px}
.tp-line.tp-invisible{background:transparent}
.tp-header-icon{display:flex;align-items:center;justify-content:center;width:16px;height:16px;margin:2px 0;flex-shrink:0}
.tp-header-chevron{color:rgba(255,255,255,0.4);transition:transform 0.3s ease;width:16px;height:16px}
.tp-card.tp-expanded .tp-header-chevron{transform:rotate(180deg)}
.tp-header-content{display:flex;align-items:center;padding:8px 12px;flex:1;font-size:14px;color:rgba(255,255,255,0.7)}
.tp-step-row{display:flex;min-height:34px;flex-shrink:0}
.tp-step-row:hover{background:rgba(255,255,255,0.03)}
.tp-step-left{display:flex;flex-direction:column;align-items:center;justify-content:center;padding-left:12px}
.tp-step-icon{display:flex;align-items:center;justify-content:center;width:16px;height:16px;margin:4px 0;flex-shrink:0}
.tp-step-icon svg{width:16px;height:16px;color:rgba(255,255,255,0.65)}
.tp-bullet{width:6px;height:6px;border-radius:50%;background:rgba(255,255,255,0.25)}
.tp-step-content{display:flex;flex:1;width:100%;min-width:0}
.tp-step-button{display:flex;flex:1;align-items:center;justify-content:space-between;gap:16px;padding:8px 12px;min-width:0;background:none;border:none;cursor:pointer;text-align:left}
.tp-step-text{font-size:14px;color:rgba(255,255,255,0.85);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.tp-step-right{display:flex;align-items:center;gap:6px;flex-shrink:0}
.tp-results-badge{font-size:13px;color:rgba(255,255,255,0.4);padding-left:4px;white-space:nowrap}
.tp-step-chevron{color:rgba(255,255,255,0.65)}
.tp-step-chevron svg{width:16px;height:16px}
.tp-expanded-content{display:none;min-height:50px}
.tp-card.tp-expanded .tp-expanded-content{display:block}
.tp-loading-bullet{animation:tpPulse 1.2s ease infinite}
@keyframes tpPulse{0%,100%{opacity:1}50%{opacity:0.4}}
.tp-loading-step{opacity:0;transform:translateY(4px);transition:all 0.25s ease}
.tp-loading-step.tp-visible{opacity:1;transform:translateY(0)}
/* ===== END THOUGHT PROCESS CSS ===== */

/* ===== REPORT COMPLETION STATE CSS ===== */
@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

.completion-overlay {
    animation: fadeIn 0.2s ease;
}

/* ===== EXPORT MODAL CSS ===== */
.export-modal {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10000;
    animation: fadeIn 0.2s ease;
}

.export-modal-content {
    background: var(--bg-primary, #1a1a2e);
    border-radius: 16px;
    padding: 24px;
    min-width: 300px;
    max-width: 90vw;
    box-shadow: 0 20px 60px rgba(0,0,0,0.4);
}

.export-modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
}

.export-modal-header h3 {
    margin: 0;
    font-size: 18px;
    color: var(--text-primary, #fff);
}

.export-modal-close {
    background: none;
    border: none;
    font-size: 24px;
    color: var(--text-secondary, #888);
    cursor: pointer;
    padding: 0;
    line-height: 1;
}

.export-modal-close:hover {
    color: var(--text-primary, #fff);
}

.export-options {
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.export-option {
    display: flex;
    align-items: center;
    gap: 16px;
    padding: 16px;
    background: var(--bg-secondary, #252542);
    border: 2px solid transparent;
    border-radius: 12px;
    cursor: pointer;
    transition: all 0.2s ease;
    text-align: left;
}

.export-option:hover {
    border-color: var(--accent, #F97316);
    background: var(--bg-tertiary, #2d2d4a);
}

.export-option.primary {
    border-color: var(--accent, #F97316);
    background: rgba(249, 115, 22, 0.1);
}

.export-option.enterprise {
    border-color: #1B4D4D;
    background: rgba(27, 77, 77, 0.1);
}

.export-option.enterprise:hover {
    background: rgba(27, 77, 77, 0.2);
    border-color: #1B4D4D;
}

.export-option.locked {
    border-color: var(--border, rgba(255,255,255,0.1));
    background: var(--bg-secondary, #1a1a2e);
    opacity: 0.7;
}

.export-option.locked:hover {
    opacity: 1;
    border-color: var(--assistant, #22c55e);
}

.export-option.secondary {
    border-color: var(--border, rgba(255,255,255,0.1));
    background: transparent;
}

.export-icon {
    font-size: 28px;
}

.export-label {
    display: flex;
    flex-direction: column;
    gap: 2px;
}

.export-label strong {
    font-size: 16px;
    color: var(--text-primary, #fff);
}

.export-label small {
    font-size: 12px;
    color: var(--text-secondary, #888);
}
/* ===== END EXPORT MODAL CSS ===== */

/* ===== END REPORT COMPLETION STATE CSS ===== */

/* 
   FREEMIUM PAYWALL SYSTEM - Soft Upgrade Prompts
    */

/* Upgrade Modal Overlay */
.upgrade-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.8);
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10000;
    opacity: 0;
    visibility: hidden;
    transition: all 0.3s ease;
    padding: 20px;
}
.upgrade-overlay.show {
    opacity: 1;
    visibility: visible;
}

/* Upgrade Modal Card */
.upgrade-modal {
    background: var(--bg-secondary);
    border: 1px solid var(--border);
    border-radius: 20px;
    max-width: 400px;
    width: 100%;
    padding: 32px 28px;
    transform: translateY(20px) scale(0.95);
    transition: transform 0.3s ease;
    text-align: center;
}
.upgrade-overlay.show .upgrade-modal {
    transform: translateY(0) scale(1);
}

/* Upgrade Icon */
.upgrade-icon {
    width: 72px;
    height: 72px;
    margin: 0 auto 20px;
    background: linear-gradient(135deg, var(--copilot) 0%, #FF8F5C 100%);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 8px 32px rgba(255, 107, 53, 0.3);
}
.upgrade-icon svg {
    width: 36px;
    height: 36px;
    color: white;
}

/* Upgrade Title & Text */
.upgrade-title {
    font-size: 22px;
    font-weight: 700;
    color: var(--text);
    margin-bottom: 12px;
}
.upgrade-subtitle {
    font-size: 15px;
    color: var(--text-dim);
    line-height: 1.5;
    margin-bottom: 24px;
}

/* Usage Counter Badge */
.usage-badge {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    background: rgba(255, 107, 53, 0.1);
    border: 1px solid rgba(255, 107, 53, 0.2);
    padding: 10px 16px;
    border-radius: 12px;
    margin-bottom: 24px;
    font-size: 13px;
    color: var(--copilot);
    font-weight: 600;
}
.usage-badge .usage-count {
    background: var(--copilot);
    color: white;
    padding: 2px 8px;
    border-radius: 6px;
    font-size: 12px;
}

/* Benefits List */
.upgrade-benefits {
    text-align: left;
    margin-bottom: 24px;
    padding: 16px;
    background: var(--card);
    border-radius: 12px;
    border: 1px solid var(--border);
}
.upgrade-benefit {
    display: flex;
    align-items: flex-start;
    gap: 12px;
    padding: 8px 0;
}
.upgrade-benefit:not(:last-child) {
    border-bottom: 1px solid var(--border);
}
.upgrade-benefit-icon {
    width: 20px;
    height: 20px;
    background: rgba(34, 197, 94, 0.15);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    margin-top: 2px;
}
.upgrade-benefit-icon svg {
    width: 12px;
    height: 12px;
    color: #22c55e;
}
.upgrade-benefit-text {
    font-size: 13px;
    color: var(--text);
    line-height: 1.4;
}

/* Upgrade Buttons */
.upgrade-buttons {
    display: flex;
    flex-direction: column;
    gap: 10px;
}
.upgrade-btn {
    padding: 14px 24px;
    border-radius: 12px;
    font-size: 15px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    border: none;
}
.upgrade-btn.primary {
    background: linear-gradient(135deg, var(--copilot) 0%, #FF8F5C 100%);
    color: white;
    box-shadow: 0 4px 16px rgba(255, 107, 53, 0.3);
}
.upgrade-btn.primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 24px rgba(255, 107, 53, 0.4);
}
.upgrade-btn.secondary {
    background: transparent;
    color: var(--text-dim);
    border: 1px solid var(--border);
}
.upgrade-btn.secondary:hover {
    background: var(--card);
    color: var(--text);
}

/* Soft Banner (in-chat) */
.upgrade-banner {
    background: linear-gradient(135deg, rgba(255, 107, 53, 0.1) 0%, rgba(255, 143, 92, 0.08) 100%);
    border: 1px solid rgba(255, 107, 53, 0.2);
    border-radius: 12px;
    padding: 16px;
    margin: 12px 0;
    display: flex;
    align-items: center;
    gap: 12px;
}
.upgrade-banner-icon {
    width: 40px;
    height: 40px;
    background: var(--copilot);
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
}
.upgrade-banner-icon svg {
    width: 20px;
    height: 20px;
    color: white;
}
.upgrade-banner-content {
    flex: 1;
}
.upgrade-banner-title {
    font-size: 13px;
    font-weight: 600;
    color: var(--text);
    margin-bottom: 2px;
}
.upgrade-banner-text {
    font-size: 12px;
    color: var(--text-dim);
}
.upgrade-banner-btn {
    padding: 8px 14px;
    background: var(--copilot);
    color: white;
    border: none;
    border-radius: 8px;
    font-size: 12px;
    font-weight: 600;
    cursor: pointer;
    white-space: nowrap;
}

/* Light theme overrides */
[data-theme="light"] .upgrade-modal {
    background: #FFFFFF;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
}
[data-theme="light"] .upgrade-benefits {
    background: #F8FAFC;
}

/*  */

        /* 
           REFERRAL PROGRAM STYLES
            */
        
        .referral-section {
            width: 100%;
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.08), rgba(255, 107, 53, 0.08));
            border: 1px solid rgba(139, 92, 246, 0.2);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 16px;
        }
        
        .referral-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
        }
        
        .referral-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            background: linear-gradient(135deg, #8b5cf6, #FF6B35);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }
        
        .referral-title {
            font-size: 16px;
            font-weight: 700;
            color: var(--text);
        }
        
        .referral-subtitle {
            font-size: 12px;
            color: var(--text-dim);
        }
        
        .referral-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 16px;
        }
        
        .referral-stat {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 12px;
            text-align: center;
        }
        
        .referral-stat-value {
            font-size: 24px;
            font-weight: 700;
            color: #8b5cf6;
        }
        
        .referral-stat-label {
            font-size: 11px;
            color: var(--text-dim);
        }
        
        .referral-code-box {
            background: var(--bg-secondary);
            border: 1px dashed rgba(139, 92, 246, 0.3);
            border-radius: 10px;
            padding: 12px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
        }
        
        .referral-code {
            font-family: monospace;
            font-size: 14px;
            font-weight: 600;
            color: #8b5cf6;
            letter-spacing: 1px;
        }
        
        .referral-copy-btn {
            background: transparent;
            border: none;
            color: var(--text-dim);
            cursor: pointer;
            padding: 6px;
            border-radius: 6px;
            transition: all 0.2s;
        }
        
        .referral-copy-btn:hover {
            background: rgba(139, 92, 246, 0.1);
            color: #8b5cf6;
        }
        
        .referral-share-btns {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        
        .referral-share-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 12px 16px;
            border-radius: 10px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            border: none;
            transition: all 0.2s;
        }
        
        .referral-share-btn.whatsapp {
            background: #25D366;
            color: white;
        }
        
        .referral-share-btn.whatsapp:hover {
            background: #1da851;
            transform: translateY(-1px);
        }
        
        .referral-share-btn.copy {
            background: var(--card);
            border: 1px solid var(--border);
            color: var(--text);
        }
        
        .referral-share-btn.copy:hover {
            background: rgba(255, 255, 255, 0.05);
        }
        
        /* Referral Modal (friction point) */
        .referral-modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.75);
            z-index: 9999;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .referral-modal-overlay.active {
            display: flex;
        }
        
        .referral-modal {
            background: var(--bg-secondary);
            border-radius: 20px;
            padding: 32px 24px;
            max-width: 400px;
            width: 100%;
            text-align: center;
            border: 1px solid var(--border);
            animation: modalSlideIn 0.3s ease;
        }
        
        @keyframes modalSlideIn {
            from { opacity: 0; transform: translateY(20px) scale(0.95); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }
        
        .referral-modal-icon {
            font-size: 56px;
            margin-bottom: 16px;
        }
        
        .referral-modal-title {
            font-size: 20px;
            font-weight: 700;
            color: var(--text);
            margin-bottom: 8px;
        }
        
        .referral-modal-text {
            font-size: 14px;
            color: var(--text-dim);
            margin-bottom: 24px;
            line-height: 1.5;
        }
        
        .referral-modal-bonus {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.1), rgba(255, 107, 53, 0.1));
            border: 1px solid rgba(139, 92, 246, 0.2);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 24px;
        }
        
        .referral-modal-bonus-title {
            font-size: 14px;
            font-weight: 600;
            color: #8b5cf6;
            margin-bottom: 4px;
        }
        
        .referral-modal-bonus-value {
            font-size: 28px;
            font-weight: 700;
            background: linear-gradient(135deg, #8b5cf6, #FF6B35);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .referral-modal-btn {
            width: 100%;
            padding: 14px;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            border: none;
            margin-bottom: 10px;
            transition: all 0.2s;
        }
        
        .referral-modal-btn.primary {
            background: #25D366;
            color: white;
        }
        
        .referral-modal-btn.primary:hover {
            background: #1da851;
        }
        
        .referral-modal-btn.secondary {
            background: linear-gradient(135deg, #FF6B35, #E55A2B);
            color: white;
        }
        
        .referral-modal-btn.secondary:hover {
            opacity: 0.9;
        }
        
        .referral-modal-btn.tertiary {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-dim);
        }
        
        .referral-modal-btn.tertiary:hover {
            background: rgba(255, 255, 255, 0.05);
        }
        
        /* Light theme */
        [data-theme="light"] .referral-section {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.06), rgba(255, 107, 53, 0.06));
        }
        
        [data-theme="light"] .referral-stat {
            background: rgba(0, 0, 0, 0.02);
        }
        
        [data-theme="light"] .referral-modal {
            background: #FFFFFF;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
        }
        
        /* Ambassador badge */
        .ambassador-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            background: linear-gradient(135deg, #8b5cf6, #a78bfa);
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
            color: white;
            margin-left: 8px;
        }
        
        /* END REFERRAL PROGRAM STYLES */

    </style>
    
    <!-- Supabase Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <!-- jsPDF for PDF export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- docx.js for Word export -->
    <script src="https://unpkg.com/docx@8.5.0/build/index.umd.js"></script>
    <!-- FileSaver for download -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <!-- Mermaid.js for diagrams -->
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <!-- FixAIR Diagram System -->
    <link rel="stylesheet" href="/assets/css/fixair-diagrams.css">

    <!-- ElevenLabs Conversational AI - ES Module (same as working Mitsubishi page) -->
    <script type="module">
        import { Conversation } from 'https://esm.run/@elevenlabs/client';
        window.ElevenLabsConversation = Conversation;
        window.dispatchEvent(new Event('elevenlabs-ready'));
    </script>
</head>
<body>
    <!-- App wrapper to contain everything and prevent gaps -->
    <div class="app-wrapper">
    
    <!-- 
         FREEMIUM PAYWALL - UPGRADE MODAL
          -->
    <div id="upgradeOverlay" class="upgrade-overlay" onclick="closeUpgradeModal(event)">
        <div class="upgrade-modal" onclick="event.stopPropagation()">
            <div class="upgrade-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 2L2 7l10 5 10-5-10-5z"/>
                    <path d="M2 17l10 5 10-5"/>
                    <path d="M2 12l10 5 10-5"/>
                </svg>
            </div>
            
            <h2 class="upgrade-title" id="upgradeTitle">Passez  FixAIR Pro</h2>
            <p class="upgrade-subtitle" id="upgradeSubtitle">
                Dbloquez le plein potentiel de votre assistant HVAC
            </p>
            
            <div class="usage-badge" id="usageBadge">
                <span>Utilisations gratuites</span>
                <span class="usage-count" id="usageCount">5/5</span>
            </div>
            
            <div class="upgrade-benefits">
                <div class="upgrade-benefit">
                    <div class="upgrade-benefit-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                            <polyline points="20 6 9 17 4 12"/>
                        </svg>
                    </div>
                    <span class="upgrade-benefit-text">Diagnostic Copilot <strong>illimit</strong></span>
                </div>
                <div class="upgrade-benefit">
                    <div class="upgrade-benefit-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                            <polyline points="20 6 9 17 4 12"/>
                        </svg>
                    </div>
                    <span class="upgrade-benefit-text">Export PDF & Word professionnel des rapports</span>
                </div>
                <div class="upgrade-benefit">
                    <div class="upgrade-benefit-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                            <polyline points="20 6 9 17 4 12"/>
                        </svg>
                    </div>
                    <span class="upgrade-benefit-text">Schmas techniques interactifs</span>
                </div>
                <div class="upgrade-benefit">
                    <div class="upgrade-benefit-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                            <polyline points="20 6 9 17 4 12"/>
                        </svg>
                    </div>
                    <span class="upgrade-benefit-text">Support prioritaire 24/7</span>
                </div>
            </div>
            
            <div class="upgrade-buttons">
                <button class="upgrade-btn primary" onclick="handleUpgradeClick()">
                    Passer  Pro  29/mois
                </button>
                <button class="upgrade-btn secondary" onclick="closeUpgradeModal()">
                    Plus tard
                </button>
            </div>
        </div>
    </div>
    <!-- END FREEMIUM PAYWALL -->
    
    <!-- 
         REFERRAL FRICTION MODAL
          -->
    <div id="referralModalOverlay" class="referral-modal-overlay" onclick="closeReferralModal(event)">
        <div class="referral-modal" onclick="event.stopPropagation()">
            <div class="referral-modal-icon"></div>
            <h2 class="referral-modal-title" id="referralModalTitle">Vous avez atteint votre limite</h2>
            <p class="referral-modal-text" id="referralModalText">
                Vous avez utilis vos requtes gratuites cette semaine. Dbloquez plus de requtes en invitant un collgue !
            </p>
            
            <div class="referral-modal-bonus">
                <div class="referral-modal-bonus-title">Bonus parrainage</div>
                <div class="referral-modal-bonus-value">+30 requtes IA</div>
            </div>
            
            <button class="referral-modal-btn primary" onclick="shareOnWhatsAppFromModal()">
                 Partager sur WhatsApp
            </button>
            <button class="referral-modal-btn secondary" onclick="handleUpgradeClick(); closeReferralModal();">
                 Passer  Pro  29/mois
            </button>
            <button class="referral-modal-btn tertiary" onclick="closeReferralModal()">
                Plus tard
            </button>
        </div>
    </div>
    <!-- END REFERRAL FRICTION MODAL -->
    
    <!-- SVG DEFS -->
    <svg style="position:absolute;width:0;height:0;">
        <defs>
            <linearGradient id="coldGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                <stop offset="0%" stop-color="#7D40FF"/>
                <stop offset="100%" stop-color="#02A4FF"/>
            </linearGradient>
            <linearGradient id="warmGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                <stop offset="0%" stop-color="#FF9966"/>
                <stop offset="100%" stop-color="#FF6B35"/>
            </linearGradient>
            <linearGradient id="hotGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                <stop offset="0%" stop-color="#4ade80"/>
                <stop offset="100%" stop-color="#22c55e"/>
            </linearGradient>
            
            <symbol id="icon-air" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9.59 4.59A2 2 0 1 1 11 8H2m10.59 11.41A2 2 0 1 0 14 16H2m15.73-8.27A2.5 2.5 0 1 1 19.5 12H2"/></symbol>
            <symbol id="icon-star" viewBox="0 0 200 200"><path d="M100.2 0C101.792 25.9476 98.6996 63.9402 117.082 82.3225C135.464 100.705 174.052 98.2076 200 99.8V100.2C174.051 101.79 135.763 98.9969 117.38 117.38C98.997 135.763 101.79 174.051 100.2 200H99.8C98.2103 174.051 100.109 136.06 81.7264 117.678C63.3436 99.2949 25.9485 101.79 0 100.2V99.8C25.9476 98.2076 63.6424 100.406 82.0246 82.0242C100.407 63.642 98.2076 25.9476 99.8 0H100.2Z" fill="currentColor"/></symbol>
            <symbol id="icon-home" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12H3l9-9 9 9h-2M5 12v7a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2v-7"/><path d="M9 21v-6a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v6"/></symbol>
            <symbol id="icon-folder" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/></symbol>
            <symbol id="icon-phone" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72c.127.96.361 1.903.7 2.81a2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45c.907.339 1.85.573 2.81.7A2 2 0 0 1 22 16.92z"/></symbol>
            <symbol id="icon-user" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></symbol>
            <symbol id="icon-connect" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="2"/><path d="M16.24 7.76a6 6 0 0 1 0 8.49m-8.48-.01a6 6 0 0 1 0-8.49m11.31-2.82a10 10 0 0 1 0 14.14m-14.14 0a10 10 0 0 1 0-14.14"/></symbol>
            <symbol id="icon-briefcase" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="7" width="20" height="14" rx="2" ry="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/></symbol>
            <symbol id="icon-dollar" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></symbol>
            <symbol id="icon-map-pin" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></symbol>
            <symbol id="icon-calendar" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></symbol>
            <symbol id="icon-clock" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></symbol>
            <symbol id="icon-edit" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></symbol>
            <symbol id="icon-trash" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></symbol>
            <symbol id="icon-mic" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/></symbol>
            <symbol id="icon-plus" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></symbol>
            <symbol id="icon-camera" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></symbol>
            <symbol id="icon-image" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></symbol>
            <symbol id="icon-paperclip" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"/></symbol>
            <symbol id="icon-search" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></symbol>
            <symbol id="icon-arrow-left" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></symbol>
            <symbol id="icon-arrow-right" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/></symbol>
            <symbol id="icon-x" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></symbol>
            <symbol id="icon-check" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></symbol>
            <symbol id="icon-copy" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></symbol>
            <symbol id="icon-clipboard" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><rect x="8" y="2" width="8" height="4" rx="1" ry="1"/></symbol>
            <symbol id="icon-checklist" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="5" y="3" width="14" height="18" rx="2"/><path d="M9 10l2 2 4-4"/><line x1="9" y1="16" x2="15" y2="16"/></symbol>
            <symbol id="icon-columns" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><line x1="12" y1="3" x2="12" y2="21"/></symbol>
            <symbol id="icon-download" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></symbol>
            <symbol id="icon-send" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></symbol>
            <symbol id="icon-share" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/></symbol>
            <symbol id="icon-fixair-logo" viewBox="0 0 235 48"><path d="M35.1986 6.4H17.4706C15.4226 6.4 13.5666 6.912 11.9026 7.936C10.2386 8.96 8.89463 10.3253 7.87063 12.032C6.88929 13.696 6.39863 15.552 6.39863 17.6V48H-0.00137472V16C-0.00137472 13.7387 0.467959 11.648 1.40663 9.728C2.34529 7.76533 3.62529 6.08 5.24663 4.672C6.91063 3.22133 8.78796 2.09067 10.8786 1.28C12.9693 0.426664 15.1666 -3.8147e-06 17.4706 -3.8147e-06H35.1986V6.4ZM48.8306 4.8C48.8306 6.12266 48.3613 7.25333 47.4226 8.192C46.484 9.13066 45.3533 9.6 44.0306 9.6C42.708 9.6 41.5773 9.13066 40.6386 8.192C39.7 7.25333 39.2306 6.12266 39.2306 4.8C39.2306 3.47733 39.7 2.34666 40.6386 1.408C41.5773 0.46933 42.708 -3.8147e-06 44.0306 -3.8147e-06C45.3533 -3.8147e-06 46.484 0.46933 47.4226 1.408C48.3613 2.34666 48.8306 3.47733 48.8306 4.8ZM47.2306 48H40.8306V22.4H9.59863V16H47.2306V48ZM97.7161 48H88.5641L74.8681 34.752L61.4281 48H52.2761L70.4521 30.464L52.2761 12.8H61.4281L97.7161 48ZM97.7161 12.8L82.4841 27.648L77.8761 23.552L88.5641 12.8H97.7161Z" fill="currentColor"/><path d="M154.461 48H148.061V35.2H112.285V28.8H148.061V9.6H125.085C122.183 9.6 119.517 10.3253 117.085 11.776C114.653 13.184 112.711 15.104 111.261 17.536C109.853 19.968 109.149 22.656 109.149 25.6V48H102.749V25.6C102.749 22.528 103.325 19.648 104.477 16.96C105.629 14.2293 107.229 11.84 109.277 9.792C111.325 7.70133 113.693 6.08 116.381 4.928C119.111 3.776 122.013 3.2 125.085 3.2H154.461V48ZM171.604 48H165.204V3.2H171.604V48ZM234.041 48H225.401L211.961 35.2H192.313V28.864H218.041C219.833 28.864 221.454 28.4373 222.905 27.584C224.356 26.688 225.508 25.5147 226.361 24.064C227.214 22.5707 227.641 20.9493 227.641 19.2C227.641 17.408 227.214 15.7867 226.361 14.336C225.508 12.8853 224.356 11.7333 222.905 10.88C221.454 10.0267 219.833 9.6 218.041 9.6H188.729V48H182.329V3.2H218.041C220.985 3.2 223.673 3.92533 226.105 5.376C228.537 6.784 230.457 8.704 231.865 11.136C233.316 13.568 234.041 16.256 234.041 19.2C234.041 21.8453 233.444 24.2987 232.249 26.56C231.097 28.8213 229.497 30.6987 227.449 32.192C225.444 33.6427 223.161 34.5813 220.601 35.008L234.041 48Z" fill="currentColor"/></symbol>
        </defs>
    </svg>

    <!-- LOGIN SCREEN -->
    <div class="screen login-screen active" id="loginScreen">
        <div class="scan-line"></div>
        <div class="login-container">
            <div class="login-logo"><svg viewBox="0 0 235 48"><use href="#icon-fixair-logo"/></svg></div>
            <h1 class="login-title" data-i18n="login.welcome">Bienvenue</h1>
            <p class="login-sub" data-i18n="login.subtitle">Portail Technicien FixAIR</p>
            <div class="login-bar">
                <div class="login-icon-slot">
                    <div class="login-mini" id="loginSphere"><div class="glass-sphere"><div class="sphere-fog-container"><div class="sphere-fog"></div><div class="sphere-fog-2"></div></div></div></div>
                    <button type="button" class="login-back" id="loginBack" onclick="prevLoginStep()"><svg viewBox="0 0 24 24"><use href="#icon-arrow-left"/></svg></button>
                </div>
                <div class="login-input-container">
                    <div class="login-input-slider" id="loginSlider">
                        <div class="login-input-slide">
                            <input type="email" class="login-input" id="loginEmail" data-placeholder-i18n="login.email_placeholder" placeholder="Quelle est votre adresse email ?" onkeypress="if(event.key==='Enter')nextLoginStep()">
                        </div>
                        <div class="login-input-slide">
                            <input type="password" class="login-input" id="loginPassword" data-placeholder-i18n="login.password_placeholder" placeholder="Entrez votre mot de passe" onkeypress="if(event.key==='Enter')nextLoginStep()">
                        </div>
                    </div>
                </div>
                <button type="button" class="login-btn" id="loginBtn" onclick="nextLoginStep()"><span class="icon"><svg><use href="#icon-arrow-right"/></svg></span></button>
            </div>
            <div class="login-status" id="loginStatus"></div>
        </div>
    </div>

    <!-- MAIN APP -->
    <div class="screen main-app" id="mainApp">
        <header class="app-header">
            <div class="header-inner">
                <div class="header-left">
                    <div class="header-logo-svg" onclick="goToHome()" style="cursor:pointer;"><svg viewBox="0 0 235 48"><use href="#icon-fixair-logo"/></svg></div>
                </div>
                <div class="brand-pill" id="brandPill" onclick="toggleBrandDropdown()">
                    <div class="brand-pill-dot" id="brandDot"></div>
                    <span class="brand-pill-text" id="brandText">Mitsubishi</span>
                    <svg class="brand-pill-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
                    <div class="brand-dropdown" id="brandDropdown">
                        <div class="brand-dropdown-item active" data-b="carrier" onclick="event.stopPropagation(); setBrand('carrier')">
                            <div class="brand-dropdown-dot" style="background:#3B82F6;"></div>
                            <span class="brand-dropdown-name">Carrier</span>
                            <svg class="brand-dropdown-check" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="20 6 9 17 4 12"/></svg>
                        </div>
                        <div class="brand-dropdown-item active" data-b="daikin" onclick="event.stopPropagation(); setBrand('daikin')">
                            <div class="brand-dropdown-dot" style="background:#10B981;"></div>
                            <span class="brand-dropdown-name">Daikin</span>
                            <svg class="brand-dropdown-check" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="20 6 9 17 4 12"/></svg>
                        </div>
                        <div class="brand-dropdown-item active selected" data-b="mitsubishi" onclick="event.stopPropagation(); setBrand('mitsubishi')">
                            <div class="brand-dropdown-dot" style="background:#E60012;"></div>
                            <span class="brand-dropdown-name">Mitsubishi</span>
                            <svg class="brand-dropdown-check" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="20 6 9 17 4 12"/></svg>
                        </div>
                        <div class="brand-dropdown-divider"></div>
                        <div class="brand-dropdown-item disabled"><span class="brand-dropdown-name">AAON</span></div>
                        <div class="brand-dropdown-item disabled"><span class="brand-dropdown-name">American Standard</span></div>
                        <div class="brand-dropdown-item disabled"><span class="brand-dropdown-name">Amana</span></div>
                        <div class="brand-dropdown-item disabled"><span class="brand-dropdown-name">Armstrong Air</span></div>
                        <div class="brand-dropdown-item disabled"><span class="brand-dropdown-name">Bosch</span></div>
                        <div class="brand-dropdown-item disabled"><span class="brand-dropdown-name">Bryant</span></div>
                        <div class="brand-dropdown-item disabled"><span class="brand-dropdown-name">Fujitsu</span></div>
                        <div class="brand-dropdown-item disabled"><span class="brand-dropdown-name">Gree</span></div>
                        <div class="brand-dropdown-item disabled"><span class="brand-dropdown-name">Haier</span></div>
                        <div class="brand-dropdown-item disabled"><span class="brand-dropdown-name">Hitachi</span></div>
                        <div class="brand-dropdown-item disabled"><span class="brand-dropdown-name">Lennox</span></div>
                        <div class="brand-dropdown-item disabled"><span class="brand-dropdown-name">LG</span></div>
                        <div class="brand-dropdown-item disabled"><span class="brand-dropdown-name">Panasonic</span></div>
                        <div class="brand-dropdown-item disabled"><span class="brand-dropdown-name">Rheem</span></div>
                        <div class="brand-dropdown-item disabled"><span class="brand-dropdown-name">Samsung</span></div>
                        <div class="brand-dropdown-item disabled"><span class="brand-dropdown-name">Trane</span></div>
                        <div class="brand-dropdown-item disabled"><span class="brand-dropdown-name">York</span></div>
                    </div>
                </div>
            </div>
        </header>
        <div class="app-content">
            <!-- HOME PAGE -->
            <div class="home" id="homePage">
                <!-- ONBOARDING SECTION -->
                <div class="onboarding-section" id="onboardingSection">
                    <div class="welcome-section" id="welcomeSection">
                        <div class="welcome-text">Bienvenue, <strong id="userName">Technicien</strong></div>
                        <div class="welcome-sub">Commenons votre parcours FixAIR</div>
                    </div>
                    <div class="onboarding-card" id="onboardingCard">
                        <button class="congrats-close" onclick="closeCongrats()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><use href="#icon-x"/></svg></button>
                        <div class="onboarding-header">
                            <span class="onboarding-title">Premires tapes</span>
                            <span class="onboarding-progress" id="onboardingProgress">0/4</span>
                        </div>
                        <div class="onboarding-steps" id="onboardingSteps">
                            <div class="onboarding-step active" id="step1" onclick="handleStep1Click()">
                                <div class="step-check current" id="step1Check"></div>
                                <div class="step-content"><span class="step-title">Valider vos informations</span></div>
                                <svg class="step-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg>
                            </div>
                            <div class="onboarding-step locked" id="step2" onclick="toggleBrandSelect()">
                                <div class="step-check pending" id="step2Check"></div>
                                <div class="step-content"><span class="step-title">Slectionner votre marque</span></div>
                                <svg class="step-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg>
                            </div>
                            <div class="brand-select-inline" id="brandSelectInline">
                                <div class="brand-select-option" data-brand="carrier" onclick="selectBrandInline('carrier')"><span class="brand-select-name">Carrier</span><div class="brand-select-dot"></div></div>
                                <div class="brand-select-option" data-brand="daikin" onclick="selectBrandInline('daikin')"><span class="brand-select-name">Daikin</span><div class="brand-select-dot"></div></div>
                                <div class="brand-select-option" data-brand="mitsubishi" onclick="selectBrandInline('mitsubishi')"><span class="brand-select-name">Mitsubishi</span><div class="brand-select-dot"></div></div>
                            </div>
                            <div class="onboarding-step locked" id="step3" onclick="handleStep3Click()">
                                <div class="step-check pending" id="step3Check"></div>
                                <div class="step-content">
                                    <span class="step-title">Essayer le Copilot</span>
                                    <div class="step-divider"></div>
                                    <div class="step-tool">
                                        <svg class="step-tool-icon copilot" viewBox="0 0 200 200" fill="currentColor"><use href="#icon-star"/></svg>
                                        <span class="step-tool-name copilot">Copilot</span>
                                    </div>
                                </div>
                                <svg class="step-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg>
                            </div>
                            <div class="onboarding-step locked" id="step4" onclick="handleStep4Click()">
                                <div class="step-check pending" id="step4Check"></div>
                                <div class="step-content">
                                    <span class="step-title">Dcouvrir l'Assistant</span>
                                    <div class="step-divider"></div>
                                    <div class="step-tool">
                                        <svg class="step-tool-icon assistant" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><use href="#icon-clipboard"/></svg>
                                        <span class="step-tool-name assistant">Assistant</span>
                                    </div>
                                </div>
                                <svg class="step-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg>
                            </div>
                        </div>
                        <div class="congrats-content">
                            <div class="congrats-icon"></div>
                            <div class="congrats-title">Flicitations !</div>
                            <div class="congrats-sub">Vous avez termin les premires tapes.<br>Vous tes prt  utiliser FixAIR !</div>
                        </div>
                    </div>
                </div>

                <!-- V13 HOMEPAGE CONTENT (hidden during onboarding) -->
                <div class="homepage-content" id="homepageContent">
                <!-- GAMIFICATION STATS (FIRE GROWTH) -->
                <div class="stats-section" id="statsSection">
                    <!-- Week Label -->
                    <div class="stats-week-label" id="statsWeekLabel">Cette semaine</div>
                    
                    <!-- Ring with tooltip -->
                    <div class="stats-ring-container" id="statsRingContainer">
                        <svg class="stats-ring" viewBox="0 0 120 120">
                            <defs>
                                <!-- Fire Growth Gradient: Braise  Flamme  Or -->
                                <linearGradient id="fireGrowthGradient" x1="0%" y1="100%" x2="100%" y2="0%">
                                    <stop offset="0%" stop-color="#92400E"/>
                                    <stop offset="40%" stop-color="#EA580C"/>
                                    <stop offset="70%" stop-color="#F97316"/>
                                    <stop offset="100%" stop-color="#FCD34D"/>
                                </linearGradient>
                            </defs>
                            <!-- Background circle -->
                            <circle class="stats-ring-bg" cx="60" cy="60" r="54"/>
                            <!-- Progress circle -->
                            <circle id="statsRingProgress" class="stats-ring-progress" cx="60" cy="60" r="54" transform="rotate(-90 60 60)"/>
                        </svg>
                        <div class="stats-ring-content">
                            <span class="stats-ring-percent" id="statsRingPercent">0%</span>
                        </div>
                        <div class="stats-ring-tooltip" id="statsRingTooltip">Votre progression vers l'objectif hebdomadaire. 100% = vous utilisez pleinement FixAIR pour gagner du temps et de l'argent !</div>
                    </div>
                    
                    <!-- Stats Row (inline) with tooltips -->
                    <div class="stats-inline">
                        <div class="stats-item" id="statsTimeItem">
                            <span class="stats-item-icon"></span>
                            <span class="stats-item-value" id="statsTimeValue">0</span><span class="stats-item-unit" id="statsTimeUnit">min</span>
                            <span class="stats-item-label">sauv</span>
                            <div class="stats-tooltip">Temps conomis cette semaine grce  FixAIR, compar au travail manuel : rdaction, recherche, corrections...</div>
                        </div>
                        <div class="stats-separator"></div>
                        <div class="stats-item" id="statsEurosItem">
                            <span class="stats-item-icon"></span>
                            <span class="stats-item-value" id="statsEurosSaved">0</span>
                            <div class="stats-tooltip">Valeur conomique estime, base sur le tarif horaire moyen d'un technicien. Inclut : temps de rdaction, allers-retours avec l'entreprise, stress vit.</div>
                        </div>
                        <div class="stats-separator"></div>
                        <div class="stats-item" id="statsReportsItem">
                            <span class="stats-item-icon"></span>
                            <span class="stats-item-value" id="statsReports">0</span>
                            <span class="stats-item-label">rapports</span>
                            <div class="stats-tooltip">Rapports professionnels gnrs automatiquement, prts  envoyer  vos clients.</div>
                        </div>
                    </div>
                    
                    <!-- Motivation Message -->
                    <div class="stats-message" id="statsMessage">Lance-toi ! </div>
                </div>

                <!-- TOGGLE CARDS -->
                <div class="modules-toggle">
                    <div class="toggle-card copilot" onclick="openChat('copilot')">
                        <div class="toggle-card-icon"><span class="star-icon"><svg viewBox="0 0 200 200"><use href="#icon-star"/></svg></span></div>
                        <div class="toggle-card-content">
                            <div class="toggle-card-title">Diagnostic</div>
                            <div class="toggle-card-desc">avec <span class="highlight-copilot">Copilot</span></div>
                        </div>
                        <svg class="toggle-card-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg>
                    </div>
                    <div class="toggle-card assistant" onclick="openChat('assistant')">
                        <div class="toggle-card-icon"><span class="icon"><svg><use href="#icon-clipboard"/></svg></span></div>
                        <div class="toggle-card-content">
                            <div class="toggle-card-title">Rapport</div>
                            <div class="toggle-card-desc">avec <span class="highlight-assistant">Assistant</span></div>
                        </div>
                        <svg class="toggle-card-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg>
                    </div>
                </div>

                <!-- BRAND BAR -->
                <div class="brand-select-row">
                    <span class="brand-label">Marque:</span>
                    <div class="brand-chip" data-b="carrier" onclick="setBrand('carrier')">Carrier</div>
                    <div class="brand-chip" data-b="daikin" onclick="setBrand('daikin')">Daikin</div>
                    <div class="brand-chip active" data-b="mitsubishi" onclick="setBrand('mitsubishi')">Mitsubishi</div>
                </div>

                <!-- RECENT PROJECTS -->
                <!-- CALENDAR CARD -->
                <div class="calendar-card" id="techCalendar">
                    <div class="calendar-header">
                        <div class="calendar-title-row">
                            <span class="calendar-title" id="techCalTitle">Dcembre 2024</span>
                            <div class="calendar-tabs">
                                <button class="calendar-tab active" onclick="setTechCalView('day', this)">Jour</button>
                                <button class="calendar-tab" onclick="setTechCalView('week', this)">Semaine</button>
                                <button class="calendar-tab" onclick="setTechCalView('month', this)">Mois</button>
                            </div>
                        </div>
                        <div class="calendar-nav">
                            <button class="calendar-nav-btn" onclick="navTechCal(-1)"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15 18 9 12 15 6"/></svg></button>
                            <button class="calendar-nav-btn" onclick="navTechCal(1)"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg></button>
                            <button class="calendar-nav-btn" onclick="openEventDrawer(formatDateKey(new Date()), '09:00')" style="margin-left: 4px;"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg></button>
                        </div>
                    </div>
                    <div id="techCalContent"></div>
                </div>

                <div>
                    <div class="sec-head"><span class="sec-title">Projets rcents</span><div class="sec-line"></div></div>
                    <div class="projects" id="recentProjectsHome">
                        <!-- Dynamic content loaded from Supabase -->
                    </div>
                </div>
                </div><!-- END homepage-content -->
            </div>

            <!-- PROJECTS PAGE -->
            <div class="projects-page" id="projectsPage">
                <div class="projects-page-header">
                    <div class="projects-page-title">Tous les projets</div>
                    <div class="projects-page-sub">Historique de vos interventions</div>
                </div>
                <div class="projects-list" id="projectsList">
                    <!-- Dynamic content loaded from Supabase -->
                </div>
            </div>
            
            <!-- PROJECT CONTEXT MENU -->
            <div class="project-context-menu" id="projectContextMenu" onclick="event.stopPropagation()">
                <div class="context-menu-item" onclick="event.stopPropagation(); renameProject()">
                    <span class="icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg></span>
                    <span>Renommer</span>
                </div>
                <div class="context-menu-item delete" onclick="event.stopPropagation(); deleteProject()">
                    <span class="icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg></span>
                    <span>Supprimer</span>
                </div>
            </div>
        </div>
        <nav class="nav">
            <div class="nav-inner">
                <div class="nav-item active" id="navHome" onclick="goToHome()"><span class="icon nav-icon"><svg><use href="#icon-home"/></svg></span><span class="nav-label">Accueil</span></div>
                <div class="nav-item" id="navProjects" onclick="Router.navigate({page:'projects'})"><span class="icon nav-icon"><svg><use href="#icon-folder"/></svg></span><span class="nav-label">Projets</span></div>
                <div class="nav-item" id="navConnect" onclick="openConnect()"><span class="icon nav-icon"><svg><use href="#icon-connect"/></svg></span><span class="nav-label">Connect</span></div>
                <div class="nav-item nav-hotline" onclick="openHotline()">
                    <div class="nav-hotline-waves">
                        <div class="wave-bar"></div>
                        <div class="wave-bar"></div>
                        <div class="wave-bar"></div>
                        <div class="wave-bar"></div>
                        <div class="wave-bar"></div>
                    </div>
                    <span class="nav-label">Hotline</span>
                </div>
                <div class="nav-item nav-profile" onclick="openProfile()"><span class="icon nav-icon"><svg><use href="#icon-user"/></svg></span><div class="nav-profile-badge"><svg viewBox="0 0 24 24"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg></div><span class="nav-label">Profil</span></div>
            </div>
        </nav>
    </div>

    <!-- PROFILE VIEW -->
    <div class="profile-view" id="profileView">
        <div class="profile-header">
            <button class="profile-back" onclick="goToHome()"><span class="icon"><svg viewBox="0 0 24 24"><use href="#icon-arrow-left"/></svg></span></button>
            <div class="profile-info">
                <div class="profile-title" data-i18n="profile.title">Votre profil</div>
                <div class="profile-subtitle" data-i18n="profile.subtitle">Informations personnelles</div>
            </div>
        </div>
        <div class="profile-body">
            <div class="profile-form">
                <!-- Personal Info -->
                <div class="settings-section-title" data-i18n="profile.personal">Informations personnelles</div>
                <div class="form-group">
                    <label class="form-label" data-i18n="profile.firstname">Prnom</label>
                    <input type="text" class="form-input" id="profileFirstName" data-placeholder-i18n="profile.firstname_placeholder">
                </div>
                <div class="form-group">
                    <label class="form-label" data-i18n="profile.lastname">Nom</label>
                    <input type="text" class="form-input" id="profileLastName" data-placeholder-i18n="profile.lastname_placeholder">
                </div>
                <div class="form-group">
                    <label class="form-label">Email</label>
                    <input type="email" class="form-input" id="profileEmail" placeholder="Votre email" readonly style="opacity: 0.6;">
                </div>
                <div class="form-group">
                    <label class="form-label" data-i18n="profile.phone">Tlphone</label>
                    <input type="tel" class="form-input" id="profilePhone" data-placeholder-i18n="profile.phone_placeholder">
                </div>
                
                <!-- Settings Section -->
                <div class="settings-divider"></div>
                <div class="settings-section-title" data-i18n="profile.settings">Paramtres</div>
                
                <!-- Language Toggle -->
                <div class="setting-toggle">
                    <div class="setting-toggle-info">
                        <div class="setting-toggle-label" data-i18n="profile.language">Langue</div>
                        <div class="setting-toggle-desc" data-i18n="profile.language_desc">Choisissez votre langue</div>
                    </div>
                    <div class="lang-selector">
                        <button class="lang-btn active" id="langFR" onclick="setLanguage('fr')">FR</button>
                        <button class="lang-btn" id="langEN" onclick="setLanguage('en')">EN</button>
                    </div>
                </div>
                
                <!-- Theme Toggle -->
                <div class="setting-toggle">
                    <div class="setting-toggle-info">
                        <div class="setting-toggle-label" data-i18n="profile.theme">Thme</div>
                        <div class="setting-toggle-desc" data-i18n="profile.theme_desc">Mode sombre ou clair</div>
                    </div>
                    <div class="toggle-switch" id="themeToggle" onclick="toggleTheme()"></div>
                </div>
                
                <div class="settings-divider"></div>
                
                <button class="profile-save" onclick="saveProfile()" data-i18n="profile.save">Enregistrer</button>
                
                <!-- REFERRAL PROGRAM SECTION -->
                <div class="settings-divider"></div>
                <div class="settings-section-title"> <span data-i18n="referral.title">Parrainage</span></div>
                
                <div class="referral-section" id="referralSection">
                    <div class="referral-header">
                        <div class="referral-icon"></div>
                        <div>
                            <div class="referral-title" data-i18n="referral.header">Invitez vos collgues</div>
                            <div class="referral-subtitle" data-i18n="referral.subheader">Gagnez 30 requtes IA bonus chacun !</div>
                        </div>
                    </div>
                    
                    <div class="referral-stats">
                        <div class="referral-stat">
                            <div class="referral-stat-value" id="referralCount">0</div>
                            <div class="referral-stat-label" data-i18n="referral.invited">Collgues invits</div>
                        </div>
                        <div class="referral-stat">
                            <div class="referral-stat-value" id="bonusQueries">0</div>
                            <div class="referral-stat-label" data-i18n="referral.bonus">Requtes bonus</div>
                        </div>
                    </div>
                    
                    <div class="referral-code-box">
                        <span class="referral-code" id="myReferralCode">...</span>
                        <button class="referral-copy-btn" onclick="copyReferralCode()" title="Copier le code">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"/>
                                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/>
                            </svg>
                        </button>
                    </div>
                    
                    <div class="referral-share-btns">
                        <button class="referral-share-btn whatsapp" onclick="shareOnWhatsApp()">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/>
                            </svg>
                            WhatsApp
                        </button>
                        <button class="referral-share-btn copy" onclick="copyReferralLink()">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/>
                                <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/>
                            </svg>
                            <span data-i18n="referral.copyLink">Copier le lien</span>
                        </button>
                    </div>
                </div>
                <!-- END REFERRAL PROGRAM SECTION -->
                
                <button class="profile-save" onclick="logout()" style="background: transparent; border: 1px solid rgba(239,68,68,0.3); color: #ef4444; margin-top: 12px;" data-i18n="profile.logout">Dconnexion</button>
            </div>
        </div>
    </div>

    <!-- CHAT VIEW (FULL WIDTH) -->
    <div class="chat-view single" id="chatView">
        <div class="panel copilot" id="panelCopilot" style="flex-basis:50%;">
            <header class="panel-header">
                <button class="panel-back" onclick="closeChat(); goToHome()"><span class="icon"><svg><use href="#icon-arrow-left"/></svg></span></button>
                <div class="panel-info">
                    <div class="panel-title">FixAIR Copilot</div>
                    <div class="panel-separator"></div>
                    <div class="panel-brand-wrapper" id="copilotBrandWrapper">
                        <div class="panel-brand-btn" onclick="toggleChatBrandDropdown('copilot')">
                            <span class="panel-brand-text" id="copilotSub">Mitsubishi</span>
                            <svg class="brand-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
                        </div>
                        <div class="panel-brand-dropdown" id="copilotBrandDropdown">
                            <div class="panel-brand-option" data-brand="mitsubishi" onclick="changeChatBrand('mitsubishi', 'copilot')">
                                <svg class="brand-check" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>
                                <span>Mitsubishi</span>
                            </div>
                            <div class="panel-brand-option" data-brand="daikin" onclick="changeChatBrand('daikin', 'copilot')">
                                <svg class="brand-check" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>
                                <span>Daikin</span>
                            </div>
                            <div class="panel-brand-option" data-brand="carrier" onclick="changeChatBrand('carrier', 'copilot')">
                                <svg class="brand-check" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>
                                <span>Carrier</span>
                            </div>
                            <div class="panel-brand-option" data-brand="lg" onclick="changeChatBrand('lg', 'copilot')">
                                <svg class="brand-check" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>
                                <span>LG</span>
                            </div>
                            <div class="panel-brand-option" data-brand="samsung" onclick="changeChatBrand('samsung', 'copilot')">
                                <svg class="brand-check" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>
                                <span>Samsung</span>
                            </div>
                            <div class="panel-brand-option" data-brand="panasonic" onclick="changeChatBrand('panasonic', 'copilot')">
                                <svg class="brand-check" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>
                                <span>Panasonic</span>
                            </div>
                            <div class="panel-brand-option" data-brand="toshiba" onclick="changeChatBrand('toshiba', 'copilot')">
                                <svg class="brand-check" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>
                                <span>Toshiba</span>
                            </div>
                            <div class="panel-brand-option" data-brand="fujitsu" onclick="changeChatBrand('fujitsu', 'copilot')">
                                <svg class="brand-check" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>
                                <span>Fujitsu</span>
                            </div>
                            <div class="panel-brand-option" data-brand="hitachi" onclick="changeChatBrand('hitachi', 'copilot')">
                                <svg class="brand-check" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>
                                <span>Hitachi</span>
                            </div>
                            <div class="panel-brand-option" data-brand="general" onclick="changeChatBrand('general', 'copilot')">
                                <svg class="brand-check" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>
                                <span>Multi-marques</span>
                            </div>
                        </div>
                    </div>
                    <div class="panel-separator panel-project-sep" id="copilotProjectSep" style="display:none;"></div>
                    <div class="panel-project" id="copilotProjectName" style="display:none;"></div>
                </div>
                <div class="mode-toggle">
                    <div class="mode-btn copilot active" onclick="switchMode('copilot')">
                        <span class="mode-icon star-icon"><svg viewBox="0 0 200 200"><use href="#icon-star"/></svg></span>
                        <span>Copilot</span>
                    </div>
                    <div class="mode-btn assistant" onclick="switchMode('assistant')">
                        <span class="mode-icon clip-icon"><svg><use href="#icon-clipboard"/></svg></span>
                        <span>Assistant</span>
                    </div>
                </div>
                <div class="header-actions">
                    <button class="h-btn new-chat-btn" onclick="startNewProject()" title="Nouveau chat"><span class="icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg></span></button>
                    <button class="h-btn" onclick="toggleSplit()" title="Mode split"><span class="icon"><svg><use href="#icon-columns"/></svg></span></button>
                </div>
            </header>
            <div class="chat-body" id="copilotBody"></div>
            <button class="scroll-bottom-btn" id="scrollBtnCopilot" onclick="scrollToBottom('copilot')">
                <span class="icon"><svg><use href="#icon-arrow-left"/></svg></span>
            </button>
            <div class="chat-input">
                <div class="attach-menu" id="attachCopilot">
                    <div class="attach-opt" onclick="attachAction('camera','copilot')"><span class="icon"><svg><use href="#icon-camera"/></svg></span>Photo / Scan</div>
                    <div class="attach-opt" onclick="attachAction('file','copilot')"><span class="icon"><svg><use href="#icon-paperclip"/></svg></span>Importer</div>
                </div>
                <div class="input-row" id="copilotInputRow">
                    <button class="plus-btn" onclick="toggleAttach('copilot')"><span class="icon"><svg><use href="#icon-plus"/></svg></span></button>
                    <div class="input-area">
                        <textarea class="input-text" id="copilotInput" placeholder="Posez votre question..." rows="1" oninput="handleChatInput('copilot')" onkeydown="handleKeydown(event,'copilot')"></textarea>
                        <div class="voice-waveform copilot" id="copilotWaveform">
                            <div class="wave-bars" id="copilotBars"></div>
                            <div class="voice-timer" id="copilotTimer">0:00</div>
                        </div>
                    </div>
                    <button class="action-btn copilot" id="copilotActionBtn" onclick="handleAction('copilot')">
                        <div class="icon-wrap">
                            <span class="btn-icon mic-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/></svg></span>
                            <span class="btn-icon send-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="19" x2="12" y2="5"/><polyline points="5 12 12 5 19 12"/></svg></span>
                            <span class="btn-icon stop-icon"><svg viewBox="0 0 24 24" fill="currentColor"><rect x="6" y="6" width="12" height="12" rx="2"/></svg></span>
                        </div>
                    </button>
                    <!-- Transcription Sphere -->
                    <div class="transcription-sphere" id="copilotTranscriptionSphere">
                        <div class="sphere-fog-wrap">
                            <div class="sphere-fog-transcribe"></div>
                            <div class="sphere-fog-transcribe-2"></div>
                        </div>
                        <div class="sphere-highlight"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="divider" id="divider" style="display:none;"><div class="divider-grip"><span></span><span></span><span></span></div></div>

        <div class="panel assistant" id="panelAssistant" style="display:none;flex-basis:50%;">
            <header class="panel-header">
                <button class="panel-back" onclick="closeChat(); goToHome()"><span class="icon"><svg><use href="#icon-arrow-left"/></svg></span></button>
                <div class="panel-info">
                    <div class="panel-title">FixAIR Assistant</div>
                    <div class="panel-separator"></div>
                    <div class="panel-brand-wrapper" id="assistantBrandWrapper">
                        <div class="panel-brand-btn" onclick="toggleChatBrandDropdown('assistant')">
                            <span class="panel-brand-text" id="assistantSub">Mitsubishi</span>
                            <svg class="brand-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
                        </div>
                        <div class="panel-brand-dropdown" id="assistantBrandDropdown">
                            <div class="panel-brand-option" data-brand="mitsubishi" onclick="changeChatBrand('mitsubishi', 'assistant')">
                                <svg class="brand-check" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>
                                <span>Mitsubishi</span>
                            </div>
                            <div class="panel-brand-option" data-brand="daikin" onclick="changeChatBrand('daikin', 'assistant')">
                                <svg class="brand-check" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>
                                <span>Daikin</span>
                            </div>
                            <div class="panel-brand-option" data-brand="carrier" onclick="changeChatBrand('carrier', 'assistant')">
                                <svg class="brand-check" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>
                                <span>Carrier</span>
                            </div>
                            <div class="panel-brand-option" data-brand="lg" onclick="changeChatBrand('lg', 'assistant')">
                                <svg class="brand-check" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>
                                <span>LG</span>
                            </div>
                            <div class="panel-brand-option" data-brand="samsung" onclick="changeChatBrand('samsung', 'assistant')">
                                <svg class="brand-check" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>
                                <span>Samsung</span>
                            </div>
                            <div class="panel-brand-option" data-brand="panasonic" onclick="changeChatBrand('panasonic', 'assistant')">
                                <svg class="brand-check" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>
                                <span>Panasonic</span>
                            </div>
                            <div class="panel-brand-option" data-brand="toshiba" onclick="changeChatBrand('toshiba', 'assistant')">
                                <svg class="brand-check" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>
                                <span>Toshiba</span>
                            </div>
                            <div class="panel-brand-option" data-brand="fujitsu" onclick="changeChatBrand('fujitsu', 'assistant')">
                                <svg class="brand-check" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>
                                <span>Fujitsu</span>
                            </div>
                            <div class="panel-brand-option" data-brand="hitachi" onclick="changeChatBrand('hitachi', 'assistant')">
                                <svg class="brand-check" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>
                                <span>Hitachi</span>
                            </div>
                            <div class="panel-brand-option" data-brand="general" onclick="changeChatBrand('general', 'assistant')">
                                <svg class="brand-check" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>
                                <span>Multi-marques</span>
                            </div>
                        </div>
                    </div>
                    <div class="panel-separator panel-project-sep" id="assistantProjectSep" style="display:none;"></div>
                    <div class="panel-project" id="assistantProjectName" style="display:none;"></div>
                </div>
                <div class="mode-toggle">
                    <div class="mode-btn copilot" onclick="switchMode('copilot')">
                        <span class="mode-icon star-icon"><svg viewBox="0 0 200 200"><use href="#icon-star"/></svg></span>
                        <span>Copilot</span>
                    </div>
                    <div class="mode-btn assistant active" onclick="switchMode('assistant')">
                        <span class="mode-icon clip-icon"><svg><use href="#icon-clipboard"/></svg></span>
                        <span>Assistant</span>
                    </div>
                </div>
                <div class="header-actions">
                    <button class="h-btn new-chat-btn" onclick="startNewProject()" title="Nouveau chat"><span class="icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg></span></button>
                    <button class="h-btn report-btn" onclick="openReport()" title="Voir rapport"><span class="icon"><svg><use href="#icon-checklist"/></svg></span></button>
                    <button class="h-btn" onclick="toggleSplit()" title="Mode split"><span class="icon"><svg><use href="#icon-columns"/></svg></span></button>
                </div>
            </header>
            <div class="chat-body" id="assistantBody"></div>
            <button class="scroll-bottom-btn" id="scrollBtnAssistant" onclick="scrollToBottom('assistant')">
                <span class="icon"><svg><use href="#icon-arrow-left"/></svg></span>
            </button>
            <div class="chat-input">
                <div class="attach-menu" id="attachAssistant">
                    <div class="attach-opt" onclick="attachAction('camera','assistant')"><span class="icon"><svg><use href="#icon-camera"/></svg></span>Photo / Scan</div>
                    <div class="attach-opt" onclick="attachAction('file','assistant')"><span class="icon"><svg><use href="#icon-paperclip"/></svg></span>Importer</div>
                </div>
                <div class="input-row" id="assistantInputRow">
                    <button class="plus-btn" onclick="toggleAttach('assistant')"><span class="icon"><svg><use href="#icon-plus"/></svg></span></button>
                    <div class="input-area">
                        <textarea class="input-text" id="assistantInput" placeholder="Dcrivez l'intervention..." rows="1" oninput="handleChatInput('assistant')" onkeydown="handleKeydown(event,'assistant')"></textarea>
                        <div class="voice-waveform assistant" id="assistantWaveform">
                            <div class="wave-bars" id="assistantBars"></div>
                            <div class="voice-timer" id="assistantTimer">0:00</div>
                        </div>
                    </div>
                    <button class="action-btn assistant" id="assistantActionBtn" onclick="handleAction('assistant')">
                        <div class="icon-wrap">
                            <span class="btn-icon mic-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/></svg></span>
                            <span class="btn-icon send-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="19" x2="12" y2="5"/><polyline points="5 12 12 5 19 12"/></svg></span>
                            <span class="btn-icon stop-icon"><svg viewBox="0 0 24 24" fill="currentColor"><rect x="6" y="6" width="12" height="12" rx="2"/></svg></span>
                        </div>
                    </button>
                    <!-- Transcription Sphere -->
                    <div class="transcription-sphere" id="assistantTranscriptionSphere">
                        <div class="sphere-fog-wrap">
                            <div class="sphere-fog-transcribe"></div>
                            <div class="sphere-fog-transcribe-2"></div>
                        </div>
                        <div class="sphere-highlight"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- REPORT SHEET - Live Preview Drawer -->
    <div class="report-backdrop" id="reportBackdrop" onclick="closeReport()"></div>
    <div class="report-sheet" id="reportSheet">
        <header class="report-header">
            <button class="report-close" onclick="closeReport()"><span class="icon"><svg><use href="#icon-x"/></svg></span></button>
            <div class="report-title">Rapport d'intervention</div>
            <div class="report-progress" id="reportHeaderProgress" style="display: none;">
                <div class="report-progress-bar">
                    <div class="report-progress-fill" id="reportProgressFill"></div>
                </div>
                <span class="report-progress-text" id="reportProgressText">0%</span>
            </div>
        </header>
        <div class="report-body">
            <div class="report-preview-container" id="reportPreviewContainer">
                <!-- Empty state - shown when no report data -->
                <div class="report-preview-empty" id="reportPreviewEmpty">
                    <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                        <polyline points="14 2 14 8 20 8"/>
                        <line x1="16" y1="13" x2="8" y2="13"/>
                        <line x1="16" y1="17" x2="8" y2="17"/>
                        <polyline points="10 9 9 9 8 9"/>
                    </svg>
                    <p>Le rapport se construit automatiquement pendant votre conversation avec l'Assistant.</p>
                    <p style="margin-top:8px;font-size:11px;opacity:0.6">Donnez les informations (client, quipement, problme...) et le rapport se mettra  jour ici.</p>
                </div>
                <!-- Live report preview - populated dynamically -->
                <div id="reportPreviewContent" style="display:none;"></div>
            </div>
        </div>
        <div class="report-footer" id="reportFooter">
            <button class="r-btn primary" onclick="completeReportV12()" style="flex: 1;"> Complter le rapport</button>
        </div>
    </div>

    <!-- FLOATING FONT TOOLBAR for v12.5 -->
    <div class="font-toolbar" id="fontToolbar">
        <div class="ft-dropdown">
            <button class="ft-dropdown-btn">
                <span id="ftBlockType">Paragraphe</span>
                <span></span>
            </button>
            <div class="ft-dropdown-menu">
                <div class="ft-dropdown-item h1" data-type="h1">Titre 1</div>
                <div class="ft-dropdown-item h2" data-type="h2">Titre 2</div>
                <div class="ft-dropdown-item h3" data-type="h3">Titre 3</div>
                <div class="ft-dropdown-item" data-type="p">Paragraphe</div>
                <div class="ft-dropdown-item" data-type="bullet"> Liste  puces</div>
                <div class="ft-dropdown-item" data-type="arrow"> Flche</div>
            </div>
        </div>
        <div class="ft-sep"></div>
        <button class="ft-btn" id="ftBold" title="Gras"><b>B</b></button>
        <button class="ft-btn" id="ftItalic" title="Italique"><i>I</i></button>
        <button class="ft-btn" id="ftUnderline" title="Soulign"><u>U</u></button>
        <div class="ft-sep"></div>
        <button class="ft-btn" id="ftAlignLeft" title="Gauche"></button>
        <button class="ft-btn" id="ftAlignCenter" title="Centre"></button>
        <button class="ft-btn" id="ftJustify" title="Justifier"></button>
    </div>
    <div class="autosave-indicator" id="autosaveIndicator">Enregistr </div>

    <!-- PHOTO MODAL -->
    <!-- HIDDEN FILE INPUTS -->
    <input type="file" id="cameraInput" accept="image/*" capture="environment" style="display:none;" onchange="handleFileSelect(event, 'camera')">
    <input type="file" id="fileInput" accept="image/*,.pdf,.doc,.docx,.xls,.xlsx,.txt" style="display:none;" onchange="handleFileSelect(event, 'file')">
    
    <!-- PHOTO NAME MODAL (for adding to report) -->
    <div class="photo-name-modal" id="photoNameModal" onclick="if(event.target === this) closePhotoNameModal()">
        <div class="photo-name-content">
            <div class="photo-name-header">
                <div class="photo-name-title">Nommer la photo</div>
                <div class="photo-name-sub">Cette lgende apparatra dans le rapport</div>
            </div>
            <div class="photo-name-preview">
                <img id="photoNamePreviewImg" src="" alt="Preview">
            </div>
            <div class="photo-name-input-wrap">
                <input type="text" id="photoNameInput" class="photo-name-input" placeholder="Ex: Plaque signaltique, Code erreur E6..." maxlength="100" onkeydown="if(event.key==='Enter')confirmAddToReport()">
            </div>
            <div class="photo-name-actions">
                <button class="photo-name-cancel" onclick="closePhotoNameModal()">Annuler</button>
                <button class="photo-name-confirm" onclick="confirmAddToReport()">Ajouter au rapport</button>
            </div>
        </div>
    </div>

    <!-- SIGNATURE MODAL -->
    <div class="signature-modal" id="signatureModal">
        <div class="signature-modal-content">
            <div class="signature-modal-header">
                <div class="signature-modal-title" id="signatureModalTitle">Signature</div>
                <button class="signature-modal-close" onclick="closeSignatureModal()"></button>
            </div>
            <div class="signature-canvas-wrap">
                <canvas id="signatureCanvas" width="300" height="150"></canvas>
            </div>
            <div class="signature-modal-actions">
                <button class="signature-clear-btn" onclick="clearSignature()">Effacer</button>
                <button class="signature-save-btn" onclick="saveSignature()">Valider</button>
            </div>
        </div>
    </div>

    <!-- IMAGE VIEWER MODAL -->
    <div class="image-viewer" id="imageViewer" onclick="closeImageViewer()">
        <button class="image-viewer-close" onclick="closeImageViewer()">
            <span class="icon"><svg><use href="#icon-x"/></svg></span>
        </button>
        <img id="imageViewerImg" src="" alt="Full size">
    </div>

    <!-- HOTLINE VIEW -->
    <div class="hotline-view" id="hotlineView">
        <button class="hotline-close" onclick="closeHotline(); goToHome()"><span class="icon"><svg><use href="#icon-x"/></svg></span></button>
        <div class="hotline-widget" id="hotlineWidget">
            <div class="pulse-sphere" id="pulseSphere" onclick="toggleHotline()">
                <div class="pulse-atmosphere"></div>
                <div class="pulse-ring"></div>
                <div class="pulse-ring"></div>
                <div class="pulse-ring"></div>
                <div class="pulse-core"></div>
                <div class="pulse-icon">
                    <div class="voice-bar"></div>
                    <div class="voice-bar"></div>
                    <div class="voice-bar"></div>
                    <div class="voice-bar"></div>
                    <div class="voice-bar"></div>
                </div>
            </div>
            <div class="widget-label" id="widgetLabel">Hotline</div>
            <div class="widget-sublabel" id="widgetSublabel">Appuyez pour parler</div>
        </div>
        <div class="hotline-chat" id="hotlineChat">
            <div class="chat-spacer"></div>
            <div class="chat-messages-outer">
                <div class="chat-messages" id="hotlineChatMessages">
                    <div class="messages-wrapper" id="messagesWrapper">
                        <div class="chat-empty" id="chatEmpty">Commencez  parler pour voir la conversation...</div>
                    </div>
                </div>
            </div>
        </div>
        <button class="toggle-chat" id="toggleChat" onclick="toggleChatView()">
            <span class="toggle-icon"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg></span>
            <span id="toggleText">Afficher</span>
        </button>
    </div>

    <div class="toast" id="toast"></div>

    <script>
        // 
        // PRODUCTION MODE - Set to false for debugging
        // 
        const PRODUCTION_MODE = true;
        
        // Suppress debug logs in production (keeps errors visible)
        if (PRODUCTION_MODE) {
            const originalLog = console.log;
            console.log = function(...args) {
                // Only show critical errors, hide debug messages
                const msg = args[0]?.toString() || '';
                if (msg.includes('Error') || msg.includes('error') || msg.includes('')) {
                    originalLog.apply(console, args);
                }
                // All other logs are suppressed in production
            };
        }
        
        // BROWSER DETECTION & DYNAMIC HEIGHT FIX
        const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
        const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        
        // Get actual visible height (handles Safari toolbar, keyboard, etc.)
        function getVisibleHeight() {
            if (window.visualViewport) {
                return window.visualViewport.height;
            }
            return window.innerHeight;
        }
        
        function setViewportHeight() {
            const vh = window.innerHeight * 0.01;
            const visibleHeight = getVisibleHeight();
            
            document.documentElement.style.setProperty('--vh', `${vh}px`);
            document.documentElement.style.setProperty('--app-height', `${window.innerHeight}px`);
            document.documentElement.style.setProperty('--visible-height', `${visibleHeight}px`);
            
            // CRITICAL: Set explicit heights to prevent gap
            document.documentElement.style.height = '100%';
            document.body.style.height = '100%';
            document.body.style.minHeight = '100%';
            document.body.style.maxHeight = '100%';
            
            // Update chatView if active
            const chatView = document.getElementById('chatView');
            if (chatView && chatView.classList.contains('active')) {
                chatView.style.height = `${visibleHeight}px`;
            }
            
            // Hide any overflow from parent iframe
            document.documentElement.style.overflow = 'hidden';
            document.body.style.overflow = 'hidden';
        }
        
        // Handle keyboard visibility changes (Safari specific)
        function handleKeyboardChange() {
            const chatView = document.getElementById('chatView');
            if (!chatView || !chatView.classList.contains('active')) return;
            
            const visibleHeight = getVisibleHeight();
            chatView.style.height = `${visibleHeight}px`;
            
            // Scroll chat body to bottom when keyboard opens
            setTimeout(() => {
                const activePanel = document.querySelector('.panel[style*="flex"]');
                if (activePanel) {
                    const chatBody = activePanel.querySelector('.chat-body');
                    if (chatBody) {
                        chatBody.scrollTop = chatBody.scrollHeight;
                    }
                }
            }, 100);
        }
        
        setViewportHeight();
        window.addEventListener('resize', setViewportHeight);
        window.addEventListener('load', setViewportHeight);
        window.addEventListener('orientationchange', () => setTimeout(setViewportHeight, 100));
        
        // Safari/iOS specific: handle address bar and keyboard
        if (window.visualViewport) {
            window.visualViewport.addEventListener('resize', handleKeyboardChange);
            window.visualViewport.addEventListener('scroll', setViewportHeight, { passive: true });
        }
        
        // Handle focus/blur on input fields for keyboard detection
        document.addEventListener('focusin', (e) => {
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
                setTimeout(handleKeyboardChange, 300);
            }
        });
        
        document.addEventListener('focusout', (e) => {
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
                setTimeout(setViewportHeight, 300);
            }
        });
        
        let brand = 'mitsubishi';
        let mode = 'copilot';
        let isSplit = false;
        let isConnected = false;
        let isConnecting = false;
        let isDisconnecting = false;
        let chatOpen = false;
        let currentPhotoPanel = 'copilot';
        let currentPage = 'home';
        
        // Theme and Language
        let currentTheme = localStorage.getItem('fixair_theme') || 'dark';
        let currentLang = localStorage.getItem('fixair_language') || localStorage.getItem('fixair_lang') || 'fr';
        
        // Translations
        const translations = {
            fr: {
                // Profile
                'profile.title': 'Votre profil',
                'profile.subtitle': 'Informations personnelles',
                'profile.personal': 'Informations personnelles',
                'profile.firstname': 'Prnom',
                'profile.firstname_placeholder': 'Votre prnom',
                'profile.lastname': 'Nom',
                'profile.lastname_placeholder': 'Votre nom',
                'profile.phone': 'Tlphone',
                'profile.phone_placeholder': 'Votre numro',
                'profile.settings': 'Paramtres',
                'profile.language': 'Langue',
                'profile.language_desc': 'Choisissez votre langue',
                'profile.theme': 'Thme',
                'profile.theme_desc': 'Mode sombre ou clair',
                'profile.save': 'Enregistrer',
                'profile.logout': 'Dconnexion',
                // Referral
                'referral.title': 'Parrainage',
                'referral.header': 'Invitez vos collgues',
                'referral.subheader': 'Gagnez 30 requtes IA bonus chacun !',
                'referral.invited': 'Collgues invits',
                'referral.bonus': 'Requtes bonus',
                'referral.copyLink': 'Copier le lien',
                // Login
                'login.welcome': 'Bienvenue',
                'login.subtitle': 'Assistant IA pour techniciens HVAC',
                'login.email_placeholder': 'Quelle est votre adresse email ?',
                'login.password_placeholder': 'Votre mot de passe',
                'login.name_placeholder': 'Votre prnom et nom',
                // Nav
                'nav.home': 'Accueil',
                'nav.projects': 'Projets',
                'nav.hotline': 'Hotline',
                'nav.profile': 'Profil',
                // Home
                'home.greeting': 'Bonjour',
                'home.progress': 'Progression du jour',
                'home.choose_assistant': 'Choisissez votre assistant',
                'home.copilot_desc': 'Questions techniques et conseils',
                'home.assistant_desc': 'Diagnostic et rsolution',
                // Onboarding
                'onboarding.step1_title': 'Choisissez votre marque',
                'onboarding.step1_desc': 'Slectionnez la marque principale sur laquelle vous travaillez',
                'onboarding.step2_title': 'Bienvenue sur FixAIR !',
                'onboarding.step2_desc': 'Votre assistant IA pour techniciens HVAC',
                'onboarding.step3_title': 'Posez votre premire question',
                'onboarding.step3_desc': 'Essayez le Copilot avec une question technique',
                'onboarding.step4_title': 'Dcouvrez l\'Assistant',
                'onboarding.step4_desc': 'Pour un diagnostic approfondi',
                'onboarding.complete': 'Termin',
                'onboarding.continue': 'Continuer',
                // Chat
                'chat.input_placeholder': 'Posez votre question...',
                'chat.copilot_title': 'FixAIR Copilot',
                'chat.assistant_title': 'FixAIR Assistant',
                // Auth - Errors
                'errors.invalidEmail': 'Veuillez entrer un email valide',
                'errors.enterPassword': 'Veuillez entrer votre mot de passe',
                'errors.wrongPassword': 'Mot de passe incorrect',
                'errors.connectionError': 'Erreur de connexion. Ressayez.',
                'errors.profileNotFound': 'Erreur: profil non trouv',
                'errors.serverError': 'Erreur de connexion au serveur',
                'errors.supabaseNotLoaded': 'Erreur: Supabase non charg. Veuillez rafrachir la page.',
                'errors.passwordTooShort': 'Mot de passe: 6 caractres minimum',
                'errors.accountNotFound': 'Compte non trouv. Redirection vers inscription...',
                'errors.wrongPortal': 'Ce portail est rserv aux techniciens. Utilisez le portail',
                'errors.confirmEmail': ' Veuillez confirmer votre email en cliquant sur le lien envoy.',
                'errors.confirmationResent': ' Email de confirmation renvoy ! Vrifiez votre bote mail.',
                'errors.sendError': 'Erreur lors de l\'envoi',
                'errors.enterEmailFirst': 'Entrez votre email d\'abord',
                'errors.resetSent': 'Email de rinitialisation envoy !',
                // Auth - Pending
                'pending.awaitingValidation': ' Votre compte est en attente de validation par un administrateur.',
                'pending.resendConfirmation': 'Renvoyer l\'email de confirmation',
                // Auth - Access Denied
                'accessDenied.accountDisabled': ' Votre compte a t dsactiv. Contactez le support.',
                // Auth - Common
                'common.connecting': 'Connexion...',
                'common.welcomeName': 'Bienvenue',
                'common.welcomeBack': 'Bienvenue !',
                'common.loginSuccess': 'Connexion russie !'
            },
            en: {
                // Profile
                'profile.title': 'Your Profile',
                'profile.subtitle': 'Personal Information',
                'profile.personal': 'Personal Information',
                'profile.firstname': 'First Name',
                'profile.firstname_placeholder': 'Your first name',
                'profile.lastname': 'Last Name',
                'profile.lastname_placeholder': 'Your last name',
                'profile.phone': 'Phone',
                'profile.phone_placeholder': 'Your phone number',
                'profile.settings': 'Settings',
                'profile.language': 'Language',
                'profile.language_desc': 'Choose your language',
                'profile.theme': 'Theme',
                'profile.theme_desc': 'Dark or light mode',
                'profile.save': 'Save',
                'profile.logout': 'Logout',
                // Referral
                'referral.title': 'Referral',
                'referral.header': 'Invite your colleagues',
                'referral.subheader': 'Earn 30 AI queries bonus each!',
                'referral.invited': 'Colleagues invited',
                'referral.bonus': 'Bonus queries',
                'referral.copyLink': 'Copy link',
                // Login
                'login.welcome': 'Welcome',
                'login.subtitle': 'AI Assistant for HVAC technicians',
                'login.email_placeholder': 'What is your email address?',
                'login.password_placeholder': 'Your password',
                'login.name_placeholder': 'Your first and last name',
                // Nav
                'nav.home': 'Home',
                'nav.projects': 'Projects',
                'nav.hotline': 'Hotline',
                'nav.profile': 'Profile',
                // Home
                'home.greeting': 'Hello',
                'home.progress': 'Daily Progress',
                'home.choose_assistant': 'Choose your assistant',
                'home.copilot_desc': 'Technical questions and advice',
                'home.assistant_desc': 'Diagnosis and resolution',
                // Onboarding
                'onboarding.step1_title': 'Choose your brand',
                'onboarding.step1_desc': 'Select the main brand you work with',
                'onboarding.step2_title': 'Welcome to FixAIR!',
                'onboarding.step2_desc': 'Your AI assistant for HVAC technicians',
                'onboarding.step3_title': 'Ask your first question',
                'onboarding.step3_desc': 'Try the Copilot with a technical question',
                'onboarding.step4_title': 'Discover the Assistant',
                'onboarding.step4_desc': 'For in-depth diagnostics',
                'onboarding.complete': 'Complete',
                'onboarding.continue': 'Continue',
                // Chat
                'chat.input_placeholder': 'Ask your question...',
                'chat.copilot_title': 'FixAIR Copilot',
                'chat.assistant_title': 'FixAIR Assistant',
                // Auth - Errors
                'errors.invalidEmail': 'Please enter a valid email',
                'errors.enterPassword': 'Please enter your password',
                'errors.wrongPassword': 'Incorrect password',
                'errors.connectionError': 'Connection error. Please try again.',
                'errors.profileNotFound': 'Error: profile not found',
                'errors.serverError': 'Server connection error',
                'errors.supabaseNotLoaded': 'Error: Supabase not loaded. Please refresh the page.',
                'errors.passwordTooShort': 'Password: 6 characters minimum',
                'errors.accountNotFound': 'Account not found. Redirecting to signup...',
                'errors.wrongPortal': 'This portal is for technicians only. Use the',
                'errors.confirmEmail': ' Please confirm your email by clicking the link sent.',
                'errors.confirmationResent': ' Confirmation email resent! Check your inbox.',
                'errors.sendError': 'Error sending',
                'errors.enterEmailFirst': 'Enter your email first',
                'errors.resetSent': 'Reset email sent!',
                // Auth - Pending
                'pending.awaitingValidation': ' Your account is awaiting admin validation.',
                'pending.resendConfirmation': 'Resend confirmation email',
                // Auth - Access Denied
                'accessDenied.accountDisabled': ' Your account has been disabled. Contact support.',
                // Auth - Common
                'common.connecting': 'Connecting...',
                'common.welcomeName': 'Welcome',
                'common.welcomeBack': 'Welcome!',
                'common.loginSuccess': 'Login successful!'
            }
        };
        
        // Apply theme on load
        function applyTheme(theme) {
            currentTheme = theme;
            document.documentElement.setAttribute('data-theme', theme);
            localStorage.setItem('fixair_theme', theme);
            
            // Update toggle state
            const toggle = document.getElementById('themeToggle');
            if (toggle) {
                toggle.classList.toggle('active', theme === 'light');
            }
        }
        
        // Toggle theme
        function toggleTheme() {
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            applyTheme(newTheme);
        }
        
        // Set language
        function setLanguage(lang) {
            currentLang = lang;
            localStorage.setItem('fixair_language', lang);
            localStorage.setItem('fixair_lang', lang); // Keep legacy key for compatibility

            // Update button states
            const langFR = document.getElementById('langFR');
            const langEN = document.getElementById('langEN');
            if (langFR) langFR.classList.toggle('active', lang === 'fr');
            if (langEN) langEN.classList.toggle('active', lang === 'en');

            // Apply translations
            applyTranslations();
        }

        // Get translation for key
        function t(key) {
            if (translations[currentLang] && translations[currentLang][key]) {
                return translations[currentLang][key];
            }
            if (translations['fr'] && translations['fr'][key]) {
                return translations['fr'][key];
            }
            return key;
        }
        
        // Apply translations to all elements with data-i18n attribute
        function applyTranslations() {
            const elements = document.querySelectorAll('[data-i18n]');
            elements.forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (translations[currentLang] && translations[currentLang][key]) {
                    el.textContent = translations[currentLang][key];
                }
            });
            
            // Apply placeholder translations
            const placeholders = document.querySelectorAll('[data-placeholder-i18n]');
            placeholders.forEach(el => {
                const key = el.getAttribute('data-placeholder-i18n');
                if (translations[currentLang] && translations[currentLang][key]) {
                    el.placeholder = translations[currentLang][key];
                }
            });
        }
        
        // Initialize theme and language on load
        function initSettings() {
            applyTheme(currentTheme);

            // Check if language was previously saved
            let savedLang = localStorage.getItem('fixair_language') || localStorage.getItem('fixair_lang');

            // If no saved preference, detect from browser
            if (!savedLang) {
                const browserLang = navigator.language || navigator.userLanguage;
                savedLang = browserLang.startsWith('en') ? 'en' : 'fr';
                localStorage.setItem('fixair_language', savedLang);
            }

            currentLang = savedLang;

            // Set initial language button state
            const langFR = document.getElementById('langFR');
            const langEN = document.getElementById('langEN');
            if (langFR) langFR.classList.toggle('active', currentLang === 'fr');
            if (langEN) langEN.classList.toggle('active', currentLang === 'en');

            applyTranslations();
        }
        
        // Call initSettings after DOM is ready
        document.addEventListener('DOMContentLoaded', initSettings);
        
        // Onboarding state
        let onboardingStep = 1;
        let onboardingComplete = false;
        let step3Done = false;
        let step4Done = false;
        let onboardingBrand = null;

        //  BRAND ERROR EXAMPLES - Visual requesting questions (FR/EN) 
        const BRAND_ERROR_EXAMPLES = {
            'mitsubishi': {
                fr: {
                    code: '1302',
                    input: 'J\'ai une erreur 1302 sur un PURY-P200YNW-A1. Donne-moi :\n1. Le tableau de diagnostic complet avec les tapes, actions, outils et rsultats attendus\n2. Un flowchart de la procdure de test capteur HP et cblage\n3. Les valeurs de rsistance/tension  mesurer sur le capteur 63HS1',
                    placeholder: 'Ex: Erreur 1302 Mitsubishi - diagnostic capteur HP'
                },
                en: {
                    code: '1302',
                    input: 'I have error 1302 on a PURY-P200YNW-A1. Give me:\n1. Complete diagnostic table with steps, actions, tools and expected results\n2. A flowchart for HP sensor and wiring test procedure\n3. Resistance/voltage values to measure on sensor 63HS1',
                    placeholder: 'Ex: Error 1302 Mitsubishi - HP sensor diagnostic'
                }
            },
            'carrier': {
                fr: {
                    code: 'XCT7',
                    input: 'Je suis en mise en service sur un VRF Carrier XCT7. Donne-moi :\n1. La procdure complte avec tous les switchs (SW1, SW2, SW3) dans un tableau\n2. Un flowchart des tapes de mise en service\n3. Les codes switchs pour forcer le mode chaud et froid',
                    placeholder: 'Ex: Mise en service VRF Carrier XCT7'
                },
                en: {
                    code: 'XCT7',
                    input: 'I\'m commissioning a Carrier XCT7 VRF system. Give me:\n1. The complete procedure with all switches (SW1, SW2, SW3) in a table\n2. A flowchart of commissioning steps\n3. Switch codes to force heating and cooling modes',
                    placeholder: 'Ex: Carrier XCT7 VRF commissioning'
                }
            },
            'daikin': {
                fr: {
                    code: 'Altherma',
                    input: 'Je dois faire un diagnostic complet sur une PAC Daikin Altherma. Donne-moi :\n1. Le tableau des codes erreur les plus frquents avec causes et solutions\n2. La procdure de lecture des pressions HP/BP via le menu technicien\n3. Un flowchart de diagnostic pour un dfaut de chauffage',
                    placeholder: 'Ex: Diagnostic PAC Daikin Altherma'
                },
                en: {
                    code: 'Altherma',
                    input: 'I need to do a complete diagnostic on a Daikin Altherma heat pump. Give me:\n1. A table of the most common error codes with causes and solutions\n2. The procedure to read HP/LP pressures via the technician menu\n3. A diagnostic flowchart for a heating fault',
                    placeholder: 'Ex: Daikin Altherma heat pump diagnostic'
                }
            }
        };

        // Get error example for brand (defaults to Mitsubishi) with language support
        function getErrorExample(brandKey) {
            const key = brandKey?.toLowerCase() || 'mitsubishi';
            const lang = currentLang || 'fr';
            const brandExamples = BRAND_ERROR_EXAMPLES[key] || BRAND_ERROR_EXAMPLES['mitsubishi'];
            return brandExamples[lang] || brandExamples['fr'];
        }

        // Track when user types their own question
        function setupChatInputTracking() {
            const chatInput = document.getElementById('copilotInput');
            if (chatInput) {
                chatInput.addEventListener('input', function(e) {
                    if (e.inputType) {
                        this.dataset.userTyped = 'true';
                        // Remove highlight when user starts typing
                        this.classList.remove('onboarding-highlight-input');
                    }
                });
                chatInput.addEventListener('change', function() {
                    if (this.value.trim() === '') {
                        this.dataset.userTyped = 'false';
                    }
                });
                chatInput.addEventListener('focus', function() {
                    // Remove highlight on focus
                    this.classList.remove('onboarding-highlight-input');
                });
            }
        }

        // Update example when brand changes (if user hasn't typed)
        function onBrandChangeUpdateExample(newBrand) {
            const chatInput = document.getElementById('copilotInput');
            if (!chatInput) return;

            const userHasTyped = chatInput.dataset.userTyped === 'true';

            if (!userHasTyped) {
                const example = getErrorExample(newBrand);
                chatInput.value = example.input;
                chatInput.placeholder = example.placeholder;
                chatInput.style.height = 'auto';
                chatInput.style.height = chatInput.scrollHeight + 'px';

                // Visual feedback
                chatInput.style.transition = 'background 0.3s';
                chatInput.style.background = 'rgba(255, 107, 53, 0.1)';
                setTimeout(() => {
                    chatInput.style.background = '';
                }, 500);
            }
        }

        //  SUPABASE CLIENT INITIALIZATION (must be before auth code) 
        const SUPABASE_URL = 'https://fwuhzraxqrvmpqxnzpqm.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZ3dWh6cmF4cXJ2bXBxeG56cHFtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYyNTcyMTksImV4cCI6MjA4MTgzMzIxOX0.8ryQm1tsdx5ox3aFJiiflmwuEGGxxH_PlobGxXMgFuQ';

        let db;
        let supabaseReady = false;

        //  MERMAID INITIALIZATION 
        let mermaidReady = false;
        function initMermaid() {
            if (typeof mermaid !== 'undefined') {
                mermaid.initialize({
                    startOnLoad: false,
                    theme: 'base',
                    securityLevel: 'loose',
                    flowchart: {
                        useMaxWidth: true,
                        htmlLabels: true,
                        curve: 'basis',
                        nodeSpacing: 50,
                        rankSpacing: 50,
                        padding: 15
                    },
                    themeVariables: {
                        primaryColor: '#2d2d2d',
                        primaryTextColor: '#ffffff',
                        primaryBorderColor: '#666666',
                        lineColor: '#888888',
                        secondaryColor: '#3d3d3d',
                        tertiaryColor: '#4d4d4d',
                        background: '#1a1a1a',
                        mainBkg: '#2d2d2d',
                        nodeBorder: '#888888',
                        clusterBkg: '#252525',
                        clusterBorder: '#666666',
                        titleColor: '#ffffff',
                        edgeLabelBackground: 'transparent',
                        fontFamily: 'system-ui, -apple-system, sans-serif',
                        fontSize: '14px'
                    }
                });
                mermaidReady = true;
            } else {
                setTimeout(initMermaid, 100);
            }
        }
        initMermaid();

        //  RENDER MERMAID DIAGRAMS 
        async function renderMermaidDiagrams(container) {
            if (!mermaidReady || typeof mermaid === 'undefined') return;

            const placeholders = container.querySelectorAll('.mermaid-placeholder');
            for (const placeholder of placeholders) {
                if (placeholder.classList.contains('mermaid-rendered')) continue;

                let code = placeholder.dataset.mermaidCode;
                if (!code) continue;

                // Decode HTML entities
                code = code
                    .replace(/&quot;/g, '"')
                    .replace(/&lt;/g, '<')
                    .replace(/&gt;/g, '>')
                    .replace(/&amp;/g, '&');

                //  SANITIZE MERMAID CODE 

                // Helper: check if text needs quotes (contains special chars)
                const needsQuotes = (text) => /[()\/']/.test(text) && !text.startsWith('"');

                // Helper: add quotes around text, escaping internal quotes
                const addQuotes = (text) => {
                    if (needsQuotes(text)) {
                        return '"' + text.replace(/"/g, "'") + '"';
                    }
                    return text;
                };

                // Fix node labels: [text]  ["text"] if contains special chars
                code = code.replace(/\[([^\]]+)\]/g, (match, content) => {
                    if (needsQuotes(content)) {
                        return '[' + addQuotes(content) + ']';
                    }
                    return match;
                });

                // Fix edge labels: |text|  |"text"| if contains special chars
                code = code.replace(/\|([^|]+)\|/g, (match, content) => {
                    // Skip if already quoted
                    if (content.startsWith('"') && content.endsWith('"')) {
                        return match;
                    }
                    if (needsQuotes(content)) {
                        return '|' + addQuotes(content) + '|';
                    }
                    return match;
                });

                // Clean up double quotes
                // Clean up double quotes
                code = code.replace(/""/g, '"');                  
                
                // Fix missing closing pipe in edge labels: |"label" NODE  |"label"| NODE                 
                code = code.replace(/\|"([^"]+)"\s+(\w+)/g, '|"$1"| $2');

                // Remove AI-generated style commands (CSS handles styling)
                code = code.replace(/^\s*style\s+\w+\s+.+$/gm, '');
                code = code.replace(/^\s*classDef\s+.+$/gm, '');

                try {
                    const id = 'mermaid-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
                    const { svg } = await mermaid.render(id, code);
                    placeholder.innerHTML = svg;

                    // Apply FixAIR premium styling to rendered diagram
                    placeholder.querySelectorAll('rect').forEach(rect => {
                        if (!rect.closest('.edgeLabel')) {
                            rect.setAttribute('fill', '#18181b');
                            rect.setAttribute('stroke', 'rgba(255, 255, 255, 0.12)');
                            rect.style.fill = '#18181b';
                            rect.style.stroke = 'rgba(255, 255, 255, 0.12)';
                            rect.style.filter = 'drop-shadow(0 4px 12px rgba(0,0,0,0.5))';
                            rect.setAttribute('rx', '12');
                            rect.setAttribute('ry', '12');
                        }
                    });
                    placeholder.querySelectorAll('polygon').forEach(p => {
                        p.setAttribute('fill', '#18181b');
                        p.setAttribute('stroke', 'rgba(255, 255, 255, 0.15)');
                        p.style.fill = '#18181b';
                        p.style.stroke = 'rgba(255, 255, 255, 0.15)';
                        p.style.filter = 'drop-shadow(0 4px 12px rgba(0,0,0,0.5))';
                    });
                    placeholder.querySelectorAll('text, .nodeLabel, foreignObject .nodeLabel').forEach(t => {
                        t.setAttribute('fill', '#fafafa');
                        t.style.fill = '#fafafa';
                        if (t.style) t.style.color = '#fafafa';
                    });
                    placeholder.querySelectorAll('.edgePath path').forEach(path => {
                        path.setAttribute('stroke', '#52525b');
                        path.style.stroke = '#52525b';
                        path.style.strokeWidth = '2px';
                    });

                    placeholder.classList.add('mermaid-rendered');
                } catch (error) {
                    console.error('Mermaid render error:', error);
                    console.error('Code that failed:', code);
                    placeholder.innerHTML = '<div class="mermaid-error"><div class="mermaid-error-title">Erreur de rendu diagramme</div><pre>' + code.replace(/</g, '&lt;').replace(/>/g, '&gt;') + '</pre></div>';
                    placeholder.classList.add('mermaid-error-container');
                }
            }
        }

        //  SUPABASE CLIENT INITIALIZATION 
        if (window.supabase && window.supabase.createClient) {
            db = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
                auth: {
                    persistSession: true,
                    autoRefreshToken: true,
                    detectSessionInUrl: false,
                    storageKey: 'fixair-tech-auth',
                    flowType: 'implicit',
                    lock: false  // CRITICAL: Prevents AbortError
                }
            });
            supabaseReady = true;
        } else {
            console.error('Supabase library not loaded!');
            alert('Erreur: Supabase non charg. Veuillez rafrachir la page.');
        }

        //  MAGIC LINK CALLBACK HANDLER 
        // Parse URL hash for auth tokens (magic link, recovery, signup confirmation)
        function parseHashParams(hash) {
            if (!hash || hash.length < 2) return {};
            const params = {};
            const hashContent = hash.substring(1); // Remove #
            const pairs = hashContent.split('&');
            for (const pair of pairs) {
                const [key, value] = pair.split('=');
                if (key && value) {
                    params[decodeURIComponent(key)] = decodeURIComponent(value);
                }
            }
            return params;
        }

        async function handleMagicLinkCallback() {
            const hash = window.location.hash;
            if (!hash) return false;

            const hashParams = parseHashParams(hash);
            const hasAccessToken = !!hashParams.access_token;
            const hasRefreshToken = !!hashParams.refresh_token;
            const tokenType = hashParams.type; // 'recovery', 'signup', 'magiclink', etc.

            if (!hasAccessToken) return false;

            console.log('=== MAGIC LINK CALLBACK ===');
            console.log('Token type:', tokenType);

            // Clean URL hash BEFORE setting session (prevents Supabase from processing it again)
            window.history.replaceState(null, '', window.location.pathname + window.location.search);

            try {
                // Set the session using the tokens from the URL
                const { data, error } = await db.auth.setSession({
                    access_token: hashParams.access_token,
                    refresh_token: hashParams.refresh_token || hashParams.access_token
                });

                if (error) {
                    console.error('Magic link session error:', error);
                    return false;
                }

                if (data.session && data.session.user) {
                    console.log('Magic link auth successful, user:', data.session.user.id);

                    // Persist session to localStorage for reliability
                    localStorage.setItem('fixair-tech-auth', JSON.stringify({
                        currentSession: data.session,
                        expiresAt: data.session.expires_at
                    }));

                    // Handle recovery links - redirect to /auth for password reset
                    if (tokenType === 'recovery') {
                        console.log('Recovery link - redirecting to /auth');
                        window.location.href = '/auth#' + hash.substring(1);
                        return true;
                    }

                    // For magic link or signup confirmation, redirect to dashboard with user ID
                    const userId = data.session.user.id;
                    const newUrl = '/technician/?user=' + userId;
                    console.log('Redirecting to:', newUrl);
                    window.location.href = newUrl;
                    return true;
                }
            } catch (err) {
                console.error('Magic link callback error:', err);
            }

            return false;
        }

        // Helper to wait for Supabase to be ready
        async function waitForSupabase() {
            if (supabaseReady && db) return db;
            let attempts = 0;
            while ((!supabaseReady || !db) && attempts < 20) {
                await new Promise(r => setTimeout(r, 100));
                attempts++;
            }
            return db;
        }

        //  TOAST UTILITY 
        let toastTimeout = null;
        function toast(m) {
            const t = document.getElementById('toast');
            if (!t) { return; }
            t.textContent = m;
            t.classList.add('show');
            if (toastTimeout) clearTimeout(toastTimeout);
            toastTimeout = setTimeout(() => {
                t.classList.remove('show');
                toastTimeout = null;
            }, 2000);
        }

        // ============================================
        // REPORT COMPLETION STATE MANAGEMENT
        // ============================================
        const REPORT_STATUS = {
            IN_PROGRESS: 'in_progress',
            COMPLETED: 'completed'
        };

        let reportCompletionState = {
            status: REPORT_STATUS.IN_PROGRESS,
            isLocked: false
        };

        // ============================================
        // FIELD LOCKING (no visual icons)
        // ============================================
        function lockReportFields() {
            reportCompletionState.isLocked = true;

            // Lock all editable fields by removing contenteditable
            document.querySelectorAll('.editable-field').forEach(field => {
                field.setAttribute('data-was-editable', 'true');
                field.setAttribute('contenteditable', 'false');
                field.style.cursor = 'default';
                field.addEventListener('click', onLockedFieldClick);
            });

            // Also lock any input/textarea/select
            document.querySelectorAll('#report-content input, #report-content textarea, #report-content select').forEach(field => {
                field.disabled = true;
                field.addEventListener('click', onLockedFieldClick);
            });
        }

        function unlockReportFields() {
            reportCompletionState.isLocked = false;

            // Restore contenteditable
            document.querySelectorAll('[data-was-editable="true"]').forEach(field => {
                field.setAttribute('contenteditable', 'true');
                field.style.cursor = '';
                field.removeEventListener('click', onLockedFieldClick);
            });

            // Unlock inputs
            document.querySelectorAll('#report-content input, #report-content textarea, #report-content select').forEach(field => {
                field.disabled = false;
                field.removeEventListener('click', onLockedFieldClick);
            });
        }

        function onLockedFieldClick(e) {
            if (reportCompletionState.isLocked) {
                e.preventDefault();
                e.stopPropagation();
                showSubtleToast('Pour modifier, cliquez sur "Modifier le rapport"');
            }
        }

        // Subtle toast (different from existing toast - appears at bottom, more discreet)
        function showSubtleToast(message) {
            const existing = document.querySelector('.subtle-toast');
            if (existing) existing.remove();

            const toastEl = document.createElement('div');
            toastEl.className = 'subtle-toast';
            toastEl.innerHTML = ' ' + message;
            toastEl.style.cssText = `
                position: fixed;
                bottom: 100px;
                left: 50%;
                transform: translateX(-50%) translateY(20px);
                background: rgba(20, 20, 30, 0.95);
                color: rgba(255, 255, 255, 0.8);
                padding: 12px 20px;
                border-radius: 10px;
                font-size: 13px;
                opacity: 0;
                transition: all 0.3s ease;
                z-index: 10001;
                backdrop-filter: blur(10px);
                border: 1px solid rgba(255, 255, 255, 0.1);
                pointer-events: none;
            `;
            document.body.appendChild(toastEl);

            requestAnimationFrame(() => {
                toastEl.style.opacity = '1';
                toastEl.style.transform = 'translateX(-50%) translateY(0)';
            });

            setTimeout(() => {
                toastEl.style.opacity = '0';
                toastEl.style.transform = 'translateX(-50%) translateY(20px)';
                setTimeout(() => toastEl.remove(), 300);
            }, 3000);
        }

        // ============================================
        // COMPLETION POPUP & ACTIONS
        // ============================================
        function showCompletionPopup() {
            const completion = calculateReportCompletion(lastReportData || {});
            const progress = completion.percentage || 0;

            const overlay = document.createElement('div');
            overlay.className = 'completion-overlay';
            overlay.style.cssText = `
                position: fixed;
                inset: 0;
                background: rgba(0, 0, 0, 0.85);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10002;
                animation: fadeIn 0.2s ease;
            `;

            overlay.innerHTML = `
                <div style="
                    background: linear-gradient(145deg, rgba(30,30,45,0.98), rgba(20,20,35,0.98));
                    border-radius: 20px;
                    padding: 36px;
                    max-width: 380px;
                    text-align: center;
                    border: 1px solid rgba(255,255,255,0.1);
                    box-shadow: 0 25px 50px rgba(0,0,0,0.5);
                ">
                    <h3 style="margin: 0 0 24px; color: #fff; font-size: 18px; font-weight: 600;">
                         Finaliser le rapport ?
                    </h3>

                    <div style="
                        width: 110px;
                        height: 110px;
                        border-radius: 50%;
                        background: rgba(245, 166, 35, 0.1);
                        border: 4px solid #f5a623;
                        display: flex;
                        flex-direction: column;
                        align-items: center;
                        justify-content: center;
                        margin: 0 auto 24px;
                    ">
                        <span style="font-size: 32px; font-weight: 700; color: #f5a623;">${progress}%</span>
                        <span style="font-size: 11px; color: rgba(255,255,255,0.5); margin-top: 2px;">Complt</span>
                    </div>

                    <p style="
                        color: rgba(255, 255, 255, 0.6);
                        font-size: 13px;
                        margin-bottom: 28px;
                        line-height: 1.6;
                    ">
                        Une fois termin, le rapport sera verrouill.<br>
                        Vous pourrez le modifier plus tard si ncessaire.
                    </p>

                    <div style="display: flex; gap: 12px;">
                        <button onclick="closeCompletionPopup()" style="
                            flex: 1;
                            padding: 14px;
                            border-radius: 10px;
                            background: rgba(255, 255, 255, 0.08);
                            color: rgba(255, 255, 255, 0.7);
                            border: 1px solid rgba(255, 255, 255, 0.1);
                            cursor: pointer;
                            font-size: 14px;
                            font-weight: 500;
                            transition: all 0.2s;
                        " onmouseover="this.style.background='rgba(255,255,255,0.12)'"
                          onmouseout="this.style.background='rgba(255,255,255,0.08)'">
                            Annuler
                        </button>
                        <button onclick="confirmReportCompletion()" style="
                            flex: 1;
                            padding: 14px;
                            border-radius: 10px;
                            background: linear-gradient(135deg, #f5a623, #e6951c);
                            color: white;
                            border: none;
                            cursor: pointer;
                            font-size: 14px;
                            font-weight: 600;
                            transition: all 0.2s;
                            box-shadow: 0 4px 15px rgba(245, 166, 35, 0.3);
                        " onmouseover="this.style.transform='translateY(-1px)';this.style.boxShadow='0 6px 20px rgba(245,166,35,0.4)'"
                          onmouseout="this.style.transform='';this.style.boxShadow='0 4px 15px rgba(245,166,35,0.3)'">
                             Terminer
                        </button>
                    </div>
                </div>
            `;

            document.body.appendChild(overlay);

            // Close on backdrop click
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) closeCompletionPopup();
            });
        }

        function closeCompletionPopup() {
            document.querySelector('.completion-overlay')?.remove();
        }

        async function confirmReportCompletion() {
            closeCompletionPopup();

            reportCompletionState.status = REPORT_STATUS.COMPLETED;
            reportCompletionState.isLocked = true;

            // Save to Supabase
            try {
                await db
                    .from('projects')
                    .update({
                        completion_status: 'completed',
                        progress: 100,
                        completed_at: new Date().toISOString()
                    })
                    .eq('id', currentProjectId);

                lockReportFields();
                updateReportFooterButtons();

                toast(' Rapport termin');
            } catch (err) {
                console.error('Error completing report:', err);
                toast('Erreur lors de la finalisation');
            }
        }

        async function modifyReport() {
            reportCompletionState.status = REPORT_STATUS.IN_PROGRESS;
            reportCompletionState.isLocked = false;

            // Recalculate progress
            const completion = calculateReportCompletion(lastReportData || {});

            try {
                await db
                    .from('projects')
                    .update({
                        completion_status: 'in_progress',
                        progress: completion.percentage
                    })
                    .eq('id', currentProjectId);

                unlockReportFields();
                updateReportFooterButtons();

                toast(' Rapport dverrouill');
            } catch (err) {
                console.error('Error unlocking report:', err);
                toast('Erreur lors du dverrouillage');
            }
        }

        // ============================================
        // FOOTER BUTTONS UPDATE
        // ============================================
        function updateReportFooterButtons() {
            const footer = document.querySelector('.report-footer');
            if (!footer) return;

            if (reportCompletionState.status === REPORT_STATUS.COMPLETED) {
                // TERMIN state: Modifier (secondary) + Exporter (primary)
                footer.innerHTML = `
                    <button class="r-btn secondary" onclick="modifyReport()">Modifier le rapport</button>
                    <button class="r-btn primary" onclick="exportReportPDF()"> Exporter</button>
                `;
            } else {
                // EN COURS state: Complter (primary full width)
                footer.innerHTML = `
                    <button class="r-btn primary" onclick="showCompletionPopup()" style="flex: 1;"> Complter le rapport</button>
                `;
            }
        }

        // ============================================
        // NEW INFO NOTIFICATION (subtle, non-blocking)
        // ============================================
        let pendingNewFields = [];

        function showNewInfoNotification(newFields) {
            if (!newFields || newFields.length === 0) return;

            // Only show if report is completed
            if (reportCompletionState.status !== REPORT_STATUS.COMPLETED) return;

            pendingNewFields = newFields;

            const existing = document.querySelector('.new-info-notification');
            if (existing) existing.remove();

            const preview = newFields.map(f => f.label || f.path).join(', ');
            const truncated = preview.length > 35 ? preview.substring(0, 35) + '...' : preview;

            const bar = document.createElement('div');
            bar.className = 'new-info-notification';
            bar.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                background: rgba(20, 20, 30, 0.95);
                padding: 14px 20px;
                display: flex;
                justify-content: space-between;
                align-items: center;
                transform: translateY(-100%);
                transition: transform 0.3s ease;
                z-index: 10003;
                backdrop-filter: blur(10px);
                border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            `;

            bar.innerHTML = `
                <span style="color: rgba(255,255,255,0.9); font-size: 13px;">
                     Nouvelle info dtecte: <strong>${truncated}</strong>
                </span>
                <div style="display: flex; gap: 10px;">
                    <button onclick="dismissNewInfoNotification()" style="
                        padding: 8px 14px;
                        background: transparent;
                        color: rgba(255,255,255,0.5);
                        border: none;
                        cursor: pointer;
                        font-size: 12px;
                    ">Ignorer</button>
                    <button onclick="acceptNewInfo()" style="
                        padding: 8px 16px;
                        background: #f5a623;
                        color: white;
                        border: none;
                        border-radius: 6px;
                        cursor: pointer;
                        font-size: 12px;
                        font-weight: 500;
                    ">Ajouter</button>
                </div>
            `;

            document.body.appendChild(bar);

            // Slide in
            requestAnimationFrame(() => {
                bar.style.transform = 'translateY(0)';
            });
        }

        function dismissNewInfoNotification() {
            const bar = document.querySelector('.new-info-notification');
            if (bar) {
                bar.style.transform = 'translateY(-100%)';
                setTimeout(() => bar.remove(), 300);
            }
            pendingNewFields = [];
        }

        async function acceptNewInfo() {
            dismissNewInfoNotification();

            if (pendingNewFields.length === 0) return;

            // Merge new fields into report data
            pendingNewFields.forEach(field => {
                if (field.path && field.value !== undefined) {
                    setNestedValue(lastReportData, field.path, field.value);
                }
            });

            pendingNewFields = [];

            // Switch to in_progress and unlock
            await modifyReport();

            // Trigger save
            triggerAutoSave();

            showSubtleToast('Info ajoute au rapport');
        }

        // Helper: Set nested value in object
        function setNestedValue(obj, path, value) {
            const keys = path.split('.');
            let current = obj;
            for (let i = 0; i < keys.length - 1; i++) {
                if (!current[keys[i]]) current[keys[i]] = {};
                current = current[keys[i]];
            }
            current[keys[keys.length - 1]] = value;
        }

        // Helper: Get nested value from object
        function getNestedValue(obj, path) {
            return path.split('.').reduce((o, k) => (o || {})[k], obj);
        }

        // Helper: Detect new fields in extraction
        function detectNewFieldsFromExtraction(extracted, existing) {
            const newFields = [];

            const pathsToCheck = [
                { path: 'travaux_effectues', label: 'Travaux effectus' },
                { path: 'pieces_utilisees', label: 'Pices utilises' },
                { path: 'fluide.quantite_ajoutee', label: 'Fluide ajout' },
                { path: 'remarques', label: 'Remarques' },
                { path: 'mesures', label: 'Mesures' },
                { path: 'recommandations', label: 'Recommandations' }
            ];

            pathsToCheck.forEach(({ path, label }) => {
                const newVal = getNestedValue(extracted, path);
                const oldVal = getNestedValue(existing, path);

                // Check if new value exists and is different
                if (newVal !== undefined && newVal !== null && newVal !== '') {
                    const newStr = JSON.stringify(newVal);
                    const oldStr = JSON.stringify(oldVal);

                    if (newStr !== oldStr) {
                        newFields.push({ path, label, value: newVal });
                    }
                }
            });

            return newFields;
        }

        // App state
        const API_BASE = 'https://cherhabil.app.n8n.cloud/webhook';
        let currentUser = null;
        let supabaseUser = null;

        const colors = {carrier:'#3B82F6', daikin:'#10B981', mitsubishi:'#E60012'};
        const names = {carrier:'Carrier', daikin:'Daikin', mitsubishi:'Mitsubishi'};

        //  SECURE API KEY STORAGE 
        let cachedApiKeys = {};
        
        async function getApiKey(keyName) {
            if (cachedApiKeys[keyName]) {
                return cachedApiKeys[keyName];
            }
            try {
                const { data, error } = await db
                    .from('app_settings')
                    .select('value')
                    .eq('key', keyName)
                    .single();
                if (error) {
                    console.error('Failed to fetch API key:', keyName, error);
                    return null;
                }
                cachedApiKeys[keyName] = data.value;
                return data.value;
            } catch (err) {
                console.error('Error fetching API key:', err);
                return null;
            }
        }
        
        async function prefetchApiKeys() {
            await getApiKey('elevenlabs_api_key');
        }

        // 
        // URL ROUTER - Full path routing with query strings
        // 
        // URL Structure:
        // /technician                                     Login prompt
        // /technician/?user=[userId]                      Dashboard (home)
        // /technician/?user=[userId]&page=copilot         Copilot AI
        // /technician/?user=[userId]&page=assistant       Assistant/Reports
        // /technician/?user=[userId]&page=hotline         Hotline voice
        // /technician/?user=[userId]&page=profile         User profile
        // /technician/?user=[userId]&page=settings        Settings
        // /technician/?user=[userId]&page=projects        Projects list
        // /technician/?user=[userId]&page=project&id=[projectId]  Project detail
        // /technician/?user=[userId]&page=calendar        Calendar
        // /technician/?user=[userId]&page=connect         Connect jobs

        const Router = {
            // Parse current URL and return route object
            getRoute() {
                const params = new URLSearchParams(window.location.search);
                return {
                    user: params.get('user') || params.get('id'),
                    page: params.get('page') || 'home',
                    projectId: params.get('project') || params.get('id'),
                    chatId: params.get('chat'),
                    mode: params.get('mode') // copilot or assistant
                };
            },

            // Navigate to a new route (updates URL and shows page)
            navigate(options = {}) {
                const current = this.getRoute();
                const userId = options.user || current.user;

                if (!userId) {
                    console.warn('Router.navigate: No user ID');
                    return;
                }

                // Build new URL
                const params = new URLSearchParams();
                params.set('user', userId);

                if (options.page && options.page !== 'home') {
                    params.set('page', options.page);
                }
                if (options.projectId) {
                    params.set('project', options.projectId);
                }
                if (options.chatId) {
                    params.set('chat', options.chatId);
                }
                if (options.mode) {
                    params.set('mode', options.mode);
                }

                const newUrl = '/technician/?' + params.toString();

                // Only push if URL actually changed
                if (newUrl !== window.location.pathname + window.location.search) {
                    history.pushState({ route: options }, '', newUrl);
                }

                // Handle the route change
                this.handleRouteChange(options.page || 'home', options);
            },

            // Handle route changes (show correct page/panel)
            handleRouteChange(page, options = {}) {
                console.log('Router: handleRouteChange', page, options);

                // Close all overlays first
                closeChat();
                closeProfile();
                document.getElementById('hotlineView')?.classList.remove('active');
                document.getElementById('connectView')?.classList.remove('active');

                switch(page) {
                    case 'home':
                    case 'dashboard':
                        showPage('home');
                        break;

                    case 'projects':
                        showPage('projects');
                        break;

                    case 'project':
                        // Open specific project (from URL bookmark/refresh)
                        if (options.projectId && typeof loadProject === 'function') {
                            loadProject(options.projectId);
                        } else {
                            showPage('projects');
                        }
                        break;

                    case 'copilot':
                        showPage('home');
                        // Start fresh copilot chat
                        if (typeof switchMode === 'function') {
                            switchMode('copilot');
                        }
                        break;

                    case 'assistant':
                        showPage('home');
                        if (typeof switchMode === 'function') {
                            switchMode('assistant');
                        }
                        break;

                    case 'hotline':
                        showPage('home');
                        document.getElementById('hotlineView')?.classList.add('active');
                        break;

                    case 'profile':
                        showPage('home');
                        document.getElementById('profileView')?.classList.add('active');
                        break;

                    case 'settings':
                        showPage('home');
                        document.getElementById('profileView')?.classList.add('active');
                        // TODO: scroll to settings section
                        break;

                    case 'calendar':
                        showPage('home');
                        // Show calendar if it exists
                        if (typeof showTechCalendar === 'function') {
                            showTechCalendar();
                        }
                        break;

                    case 'connect':
                        showPage('connect');
                        break;

                    default:
                        showPage('home');
                }
            },

            // Initialize router (call once on page load)
            init() {
                // Handle browser back/forward
                window.addEventListener('popstate', (e) => {
                    console.log('Router: popstate', e.state);
                    const route = this.getRoute();
                    if (route.user) {
                        this.handleRouteChange(route.page, route);
                    }
                });
            }
        };

        //  APP INITIALIZATION 
        async function init() {
            console.log('=== TECHNICIAN APP INIT ===');

            // Handle magic link callback first (auth tokens in URL hash)
            const handledMagicLink = await handleMagicLinkCallback();
            if (handledMagicLink) {
                // Magic link is being processed, page will redirect
                return;
            }

            // Initialize router for back/forward support
            Router.init();

            // Get route from URL
            const route = Router.getRoute();
            console.log('Initial route:', route);

            // Check for user ID (query string is primary method)
            let userId = route.user;

            // Fallback: Path-based /technician/[uuid] (for old URLs)
            if (!userId) {
                const pathParts = window.location.pathname.split('/').filter(Boolean);
                if (pathParts.length >= 2 && pathParts[0] === 'technician') {
                    userId = pathParts[1];
                    console.log('User ID from path (legacy):', userId);
                }
            }

            // Fallback: Hash /technician/#[uuid]
            if (!userId && window.location.hash) {
                userId = window.location.hash.replace('#', '').replace('/', '');
                if (userId) console.log('User ID from hash (legacy):', userId);
            }

            // Check if we have a valid userId (UUIDs are 36 chars, but accept 10+ to be safe)
            if (userId && userId.length > 10) {
                await loadUserDashboard(userId);

                // After loading dashboard, handle the requested page
                if (route.page && route.page !== 'home') {
                    // Small delay to ensure UI is ready
                    setTimeout(() => {
                        Router.handleRouteChange(route.page, route);
                    }, 100);
                }
            } else {
                showLoginScreen();
            }
        }

        // 
        // LOGIN SCREEN MANAGEMENT
        // 
        let loginStep = 0;
        let existingUserData = null;

        function showLoginScreen() {
            document.getElementById('loginScreen').classList.add('active');
            document.getElementById('mainApp').classList.remove('active');
            // Reset login state
            loginStep = 0;
            existingUserData = null;
            updateLoginUI();
            clearLoginStatus();
        }

        // showMainApp is defined below at main app section

        function setLoginStatus(message, type = 'info', showReset = false) {
            const statusEl = document.getElementById('loginStatus');
            if (!statusEl) return;
            statusEl.className = 'login-status ' + type;
            if (showReset) {
                statusEl.innerHTML = message + ' <a onclick="resetPassword()">Rinitialiser</a>';
            } else {
                statusEl.textContent = message;
            }
        }

        function clearLoginStatus() {
            const statusEl = document.getElementById('loginStatus');
            if (statusEl) {
                statusEl.textContent = '';
                statusEl.className = 'login-status';
            }
        }

        function updateLoginUI() {
            document.getElementById('loginSlider').style.transform = `translateX(-${loginStep * 100}%)`;
            document.getElementById('loginSphere').style.display = loginStep === 0 ? 'flex' : 'none';
            document.getElementById('loginBack').style.display = loginStep === 0 ? 'none' : 'flex';
        }

        function prevLoginStep() {
            if (loginStep > 0) {
                loginStep--;
                clearLoginStatus();
                updateLoginUI();
            }
        }

        async function nextLoginStep() {
            const btn = document.getElementById('loginBtn');

            if (loginStep === 0) {
                // Step 0: Check email
                const email = document.getElementById('loginEmail').value.trim().toLowerCase();

                if (!email.includes('@')) {
                    setLoginStatus(t('errors.invalidEmail'), 'error');
                    return;
                }

                clearLoginStatus();
                btn.disabled = true;
                btn.innerHTML = '<span class="icon" style="animation: spin 1s linear infinite;"><svg><use href="#icon-arrow-right"/></svg></span>';

                try {
                    // Check if user exists in users table
                    const { data: user, error } = await db
                        .from('users')
                        .select('id, email, first_name, status, role')
                        .eq('email', email)
                        .maybeSingle();

                    console.log('User lookup:', { user, error });

                    if (error || !user) {
                        // User not found - redirect to /auth for signup
                        setLoginStatus(t('errors.accountNotFound'), 'info');
                        setTimeout(() => {
                            window.location.href = '/auth?email=' + encodeURIComponent(email) + '&from=technician';
                        }, 1000);
                        return;
                    }

                    // Check if user is a technician
                    if (user.role !== 'technician') {
                        setLoginStatus(t('errors.wrongPortal') + ' ' + user.role + '.', 'error');
                        btn.disabled = false;
                        btn.innerHTML = '<span class="icon"><svg><use href="#icon-arrow-right"/></svg></span>';
                        return;
                    }

                    // Check status
                    if (user.status === 'pending') {
                        setLoginStatus(t('pending.awaitingValidation'), 'error');
                        btn.disabled = false;
                        btn.innerHTML = '<span class="icon"><svg><use href="#icon-arrow-right"/></svg></span>';
                        return;
                    }

                    if (user.status === 'rejected' || user.status === 'suspended') {
                        setLoginStatus(t('accessDenied.accountDisabled'), 'error');
                        btn.disabled = false;
                        btn.innerHTML = '<span class="icon"><svg><use href="#icon-arrow-right"/></svg></span>';
                        return;
                    }

                    // User approved - save data and show password step
                    existingUserData = user;
                    if (user.first_name) {
                        setLoginStatus(t('common.welcomeName') + ' ' + user.first_name + ' !', 'info');
                    } else {
                        setLoginStatus(t('common.welcomeBack'), 'info');
                    }
                    loginStep = 1;
                    updateLoginUI();

                } catch (err) {
                    console.error('Email check error:', err);
                    setLoginStatus(t('errors.connectionError'), 'error');
                } finally {
                    btn.disabled = false;
                    btn.innerHTML = '<span class="icon"><svg><use href="#icon-arrow-right"/></svg></span>';
                }

            } else if (loginStep === 1) {
                // Step 1: Password login
                const email = document.getElementById('loginEmail').value.trim().toLowerCase();
                const password = document.getElementById('loginPassword').value;

                if (password.length < 6) {
                    setLoginStatus(t('errors.passwordTooShort'), 'error');
                    return;
                }

                btn.disabled = true;
                btn.innerHTML = '<span class="icon" style="animation: spin 1s linear infinite;"><svg><use href="#icon-arrow-right"/></svg></span>';

                try {
                    const { data, error } = await db.auth.signInWithPassword({
                        email: email,
                        password: password
                    });

                    if (error) {
                        console.error('Login error:', error);

                        // Handle specific error types
                        if (error.message.includes('Email not confirmed')) {
                            setLoginStatusWithResend(email, t('errors.confirmEmail'));
                        } else if (error.message.includes('Invalid login credentials')) {
                            setLoginStatus(t('errors.wrongPassword'), 'error', true);
                        } else {
                            setLoginStatus('Error: ' + error.message, 'error');
                        }

                        btn.disabled = false;
                        btn.innerHTML = '<span class="icon"><svg><use href="#icon-arrow-right"/></svg></span>';
                        return;
                    }

                    // Login successful - redirect to user dashboard
                    clearLoginStatus();
                    setLoginStatus(t('common.loginSuccess'), 'success');

                    // Get user ID from our users table
                    const userId = existingUserData?.id;
                    if (userId) {
                        setTimeout(() => {
                            window.location.href = '/technician/?user=' + userId;
                        }, 500);
                    } else {
                        // Fallback: get user from session
                        const { data: profile } = await db
                            .from('users')
                            .select('id')
                            .eq('email', email)
                            .single();
                        if (profile) {
                            window.location.href = '/technician/?user=' + profile.id;
                        } else {
                            setLoginStatus(t('errors.profileNotFound'), 'error');
                        }
                    }

                } catch (err) {
                    console.error('Login exception:', err);
                    setLoginStatus(t('errors.serverError'), 'error');
                    btn.disabled = false;
                    btn.innerHTML = '<span class="icon"><svg><use href="#icon-arrow-right"/></svg></span>';
                }
            }
        }

        async function resetPassword() {
            const email = document.getElementById('loginEmail').value.trim();
            if (!email.includes('@')) {
                setLoginStatus(t('errors.enterEmailFirst'), 'error');
                return;
            }

            try {
                const { error } = await db.auth.resetPasswordForEmail(email, {
                    redirectTo: window.location.origin + '/auth'
                });
                if (error) {
                    setLoginStatus('Error: ' + error.message, 'error');
                } else {
                    setLoginStatus(t('errors.resetSent'), 'success');
                }
            } catch (err) {
                setLoginStatus(t('errors.sendError'), 'error');
            }
        }

        function setLoginStatusWithResend(email, message) {
            const statusEl = document.getElementById('loginStatus');
            if (!statusEl) return;
            statusEl.className = 'login-status error';
            statusEl.innerHTML = `
                ${message}
                <br><br>
                <a onclick="resendConfirmation('${email}')" style="color: var(--copilot); cursor: pointer; text-decoration: underline;">
                    ${t('pending.resendConfirmation')}
                </a>
            `;
        }

        async function resendConfirmation(email) {
            try {
                const { error } = await db.auth.resend({
                    type: 'signup',
                    email: email
                });
                if (error) {
                    setLoginStatus('Error: ' + error.message, 'error');
                } else {
                    setLoginStatus(t('errors.confirmationResent'), 'success');
                }
            } catch (err) {
                setLoginStatus(t('errors.sendError'), 'error');
            }
        }

        async function loadUserDashboard(userSlug) {
            console.log('Loading dashboard for:', userSlug);

            try {
                // Load user profile by ID
                const { data: user, error } = await db
                    .from('users')
                    .select('*')
                    .eq('id', userSlug)
                    .single();

                if (error || !user) {
                    console.error('User not found:', error);
                    document.body.innerHTML = `
                        <div style="display:flex;flex-direction:column;align-items:center;justify-content:center;height:100vh;background:#0a0a0a;color:white;font-family:system-ui;">
                            <h1 style="color:#FF6B35;">Utilisateur non trouv</h1>
                            <p style="color:#888;margin:20px 0;">L'ID utilisateur n'existe pas.</p>
                            <a href="/technician" style="color:#FF6B35;margin-top:20px;"> Retour  la connexion</a>
                        </div>
                    `;
                    return;
                }

                console.log('User loaded:', user.email);

                // Set global user variables
                currentUser = user;
                supabaseUser = user;

                // Populate UI
                document.getElementById('userName').textContent = user.first_name || 'Utilisateur';
                document.getElementById('profileFirstName').value = user.first_name || '';
                document.getElementById('profileLastName').value = user.last_name || '';
                if (user.email) document.getElementById('profileEmail').value = user.email;
                if (user.phone) document.getElementById('profilePhone').value = user.phone;

                // Load language preference
                if (user.language && (user.language === 'fr' || user.language === 'en')) {
                    setLanguage(user.language);
                }

                // Check onboarding status
                const onboardingDoneLocal = localStorage.getItem('fixair_onboarding_done');
                const onboardingDoneDB = user.onboarding_done;
                if (onboardingDoneLocal || onboardingDoneDB) {
                    onboardingComplete = true;
                    document.querySelector('.onboarding-section')?.classList.add('hidden');
                    document.getElementById('homepageContent')?.classList.add('active');
                }

                // Show main app
                showMainApp();

            } catch (err) {
                console.error('Dashboard load error:', err);
                document.body.innerHTML = `
                    <div style="display:flex;flex-direction:column;align-items:center;justify-content:center;height:100vh;background:#0a0a0a;color:white;font-family:system-ui;">
                        <h1 style="color:#FF6B35;">Erreur</h1>
                        <p style="color:#888;margin:20px 0;">${err.message}</p>
                        <button onclick="location.reload()" style="margin-top:20px;padding:10px 20px;background:#FF6B35;color:white;border:none;border-radius:5px;cursor:pointer;">Ressayer</button>
                    </div>
                `;
            }
        }

        //  SHOW MAIN APP 
        function showMainApp() {
            document.getElementById('loginScreen').classList.remove('active');
            document.getElementById('mainApp').classList.add('active');

            // Load app data
            loadProjectsListAndCheckOnboarding();
            initGamification();
            initFreemium(); // Initialize freemium paywall system
            initReferral(); // Initialize referral program
            prefetchApiKeys();
            initLiveStatusTracking();

            console.log('App loaded successfully');
        }

        //  LOGOUT 
        async function logout() {
            await stopLiveStatusTracking();
            await db.auth.signOut();
            localStorage.removeItem('fixair-tech-auth');
            supabaseUser = null;
            currentUser = null;
            onboardingComplete = false;
            localStorage.removeItem('fixair_onboarding_done');
            // Go back to login prompt (not /auth)
            window.location.href = '/technician';
        }

        //  INITIALIZE APP ON PAGE LOAD 
        document.addEventListener('DOMContentLoaded', init);

        //  LIVE STATUS TRACKING 
        const IDLE_TIMEOUT = 5 * 60 * 1000; // 5 minutes
        let idleTimer = null;
        let currentLiveStatus = 'offline';

        async function updateLiveStatus(status) {
            if (!currentUser?.id || currentLiveStatus === status) return;

            try {
                await db
                    .from('users')
                    .update({
                        live_status: status,
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', currentUser.id);

                currentLiveStatus = status;
            } catch (err) {
                console.error('Error updating live status:', err);
            }
        }

        function resetIdleTimer() {
            if (idleTimer) clearTimeout(idleTimer);

            // Only track if user is logged in
            if (!currentUser?.id) return;

            // If was idle, set back to online
            if (currentLiveStatus === 'idle') {
                updateLiveStatus('online');
            }

            // Set idle after timeout
            idleTimer = setTimeout(() => {
                updateLiveStatus('idle');
            }, IDLE_TIMEOUT);
        }

        function initLiveStatusTracking() {
            // Set online when app starts
            updateLiveStatus('online');

            // Track user activity
            const activityEvents = ['mousedown', 'keydown', 'touchstart', 'scroll'];
            activityEvents.forEach(event => {
                document.addEventListener(event, resetIdleTimer, { passive: true });
            });

            // Handle visibility change (tab switch)
            document.addEventListener('visibilitychange', () => {
                if (document.hidden) {
                    updateLiveStatus('idle');
                } else {
                    updateLiveStatus('online');
                    resetIdleTimer();
                }
            });

            // Handle page close
            window.addEventListener('beforeunload', () => {
                // Use fetch with keepalive for reliable delivery on page close
                if (currentUser?.id) {
                    fetch(`${SUPABASE_URL}/rest/v1/users?id=eq.${currentUser.id}`, {
                        method: 'PATCH',
                        headers: {
                            'Content-Type': 'application/json',
                            'apikey': SUPABASE_ANON_KEY,
                            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                            'Prefer': 'return=minimal'
                        },
                        body: JSON.stringify({ live_status: 'offline', updated_at: new Date().toISOString() }),
                        keepalive: true
                    }).catch(() => {});
                }
            });

            // Start idle timer
            resetIdleTimer();
        }

        function stopLiveStatusTracking() {
            if (idleTimer) {
                clearTimeout(idleTimer);
                idleTimer = null;
            }
            updateLiveStatus('offline');
        }

        // PROFILE
        function openProfile() {
            Router.navigate({ page: 'profile' });
        }

        function closeProfile() {
            document.getElementById('profileView').classList.remove('active');

            // Check if we should complete step 1 on returning from profile
            // (Profile might have been pre-filled or saved earlier)
            const firstName = currentUser?.first_name || '';
            if (firstName && firstName.trim() && onboardingStep === 1 && !onboardingComplete) {
                completeStep(1);
                document.getElementById('step2').classList.remove('locked');
                document.getElementById('step2').classList.add('active');
                document.getElementById('step2Check').classList.remove('pending');
                document.getElementById('step2Check').classList.add('current');
                onboardingStep = 2;
                updateOnboardingProgress();
                toast('Informations valides ');
            }
        }

        async function saveProfile() {
            console.log('=== SAVING PROFILE ===');

            const firstName = document.getElementById('profileFirstName').value.trim();
            const lastName = document.getElementById('profileLastName').value.trim();
            const email = document.getElementById('profileEmail').value.trim();
            const phone = document.getElementById('profilePhone')?.value.trim() || '';
            const language = currentLang || 'fr';

            console.log('Form data:', { firstName, lastName, email, phone, language });

            if (!firstName) { toast('Entrez votre prnom'); return; }

            // Update UI immediately
            document.getElementById('userName').textContent = firstName;

            //  GET USER ID (priority: currentUser > session > localStorage) 
            let userId = currentUser?.id;
            if (!userId && typeof db !== 'undefined') {
                try {
                    const { data: { session } } = await db.auth.getSession();
                    userId = session?.user?.id;
                } catch (e) { }
            }
            if (!userId) {
                const savedUser = JSON.parse(localStorage.getItem('fixair_user') || '{}');
                userId = savedUser.id;
            }

            console.log('User ID for save:', userId);

            if (!userId) {
                console.error('=== NO USER ID AVAILABLE ===');
                toast('Erreur: utilisateur non identifi');
                return;
            }

            //  SAVE TO LOCALSTORAGE (ALWAYS WORKS) 
            const savedUser = JSON.parse(localStorage.getItem('fixair_user') || '{}');
            savedUser.id = userId;
            savedUser.first_name = firstName;
            savedUser.last_name = lastName;
            if (email) savedUser.email = email;
            if (phone) savedUser.phone = phone;
            savedUser.language = language;
            localStorage.setItem('fixair_user', JSON.stringify(savedUser));
            currentUser = savedUser;

            let dbSaveSuccess = false;

            //  SAVE TO SUPABASE users table 
            if (userId && typeof db !== 'undefined') {
                try {
                    // Build update data - only include non-empty values
                    const updateData = {
                        first_name: firstName,
                        updated_at: new Date().toISOString()
                    };

                    // Only add optional fields if they have values
                    if (lastName) updateData.last_name = lastName;
                    if (phone) updateData.phone = phone;
                    if (language) updateData.language = language;
                    // Don't update email - it's managed by auth

                    console.log('=== SUPABASE UPDATE ===');
                    console.log('Table: users');
                    console.log('User ID:', userId);
                    console.log('Update data:', JSON.stringify(updateData, null, 2));

                    const { data, error } = await db
                        .from('users')
                        .update(updateData)
                        .eq('id', userId)
                        .select();

                    if (error) {
                        console.error('=== PROFILE UPDATE ERROR ===');
                        console.error('Error code:', error.code);
                        console.error('Error message:', error.message);
                        console.error('Error details:', error.details);
                        console.error('Error hint:', error.hint);
                        console.error('Full error:', JSON.stringify(error, null, 2));

                        // Don't try upsert - it will fail on constraints
                        // Just report the error
                        toast('Erreur: ' + (error.message || 'Sauvegarde impossible'));
                    } else {
                        dbSaveSuccess = true;
                        console.log('=== PROFILE SAVED SUCCESSFULLY ===');
                        console.log('Result:', data);

                        // Update local profile with returned data
                        if (data && data[0]) {
                            currentUser = { ...currentUser, ...data[0] };
                            localStorage.setItem('fixair_user', JSON.stringify(currentUser));
                        }
                    }
                } catch (e) {
                    console.error('=== PROFILE SAVE EXCEPTION ===');
                    console.error('Exception type:', e.constructor.name);
                    console.error('Exception message:', e.message);
                    console.error('Stack:', e.stack);
                    toast('Erreur inattendue');
                }
            } else {
                console.log('Cannot save to Supabase - no userId or db not available');
            }

            console.log('=== SAVE COMPLETE ===');
            console.log('DB save success:', dbSaveSuccess);

            if (dbSaveSuccess) {
                toast('Profil enregistr ');
            } else {
                toast('Profil enregistr localement');
            }
            
            // Handle onboarding step progression
            if (onboardingStep === 1) {
                completeStep(1);
                document.getElementById('step2').classList.remove('locked');
                document.getElementById('step2').classList.add('active');
                document.getElementById('step2Check').classList.remove('pending');
                document.getElementById('step2Check').classList.add('current');
                onboardingStep = 2;
                updateOnboardingProgress();
            }
            closeProfile();
        }

        // BRAND SELECT (ONBOARDING)
        function toggleBrandSelect() {
            if (onboardingStep < 2) return;
            document.getElementById('brandSelectInline').classList.toggle('show');
        }

        function selectBrandInline(b) {
            onboardingBrand = b;
            brand = b;
            
            document.querySelectorAll('.brand-select-option').forEach(opt => {
                opt.classList.toggle('selected', opt.dataset.brand === b);
            });
            
            // Update header pill with green dot only
            document.getElementById('brandText').textContent = names[b];
            document.getElementById('brandPill').classList.add('has-brand');
            document.getElementById('copilotSub').textContent = names[b];
            document.getElementById('assistantSub').textContent = names[b];
            
            // Update dropdown - only selected shows green dot
            document.querySelectorAll('.brand-dropdown-item[data-b]').forEach(o => {
                o.classList.remove('selected', 'onboard-selected');
                if (o.dataset.b === b) o.classList.add('onboard-selected');
            });
            document.querySelectorAll('.brand-chip').forEach(c => c.classList.toggle('active', c.dataset.b === b));
            
            //  FIX: Update brand context in fresh chat 
            if (!currentProjectId && typeof updateBrandContextInHistory === 'function') {
                updateBrandContextInHistory();
            }
            //  END FIX 

            //  Update Copilot example when brand changes 
            onBrandChangeUpdateExample(b);

            setTimeout(() => completeBrandStep(), 300);
        }

        function completeBrandStep() {
            if (onboardingStep === 2) {
                completeStep(2);
                document.getElementById('brandSelectInline').classList.remove('show');
                // Unlock BOTH step 3 and step 4 - user can do either first
                document.getElementById('step3').classList.remove('locked');
                document.getElementById('step3').classList.add('active');
                document.getElementById('step3Check').classList.remove('pending');
                document.getElementById('step3Check').classList.add('current');
                document.getElementById('step4').classList.remove('locked');
                document.getElementById('step4').classList.add('active');
                document.getElementById('step4Check').classList.remove('pending');
                document.getElementById('step4Check').classList.add('current');
                onboardingStep = 3;
                updateOnboardingProgress();
            }
        }

        // STEP HANDLERS - Allow either order and re-entry
        function handleStep1Click() {
            // Check if profile already has first_name (from currentUser or localStorage)
            const firstName = currentUser?.first_name || '';

            if (firstName && firstName.trim()) {
                // Profile is valid - auto-complete step 1 and unlock step 2
                if (onboardingStep === 1) {
                    completeStep(1);
                    document.getElementById('step2').classList.remove('locked');
                    document.getElementById('step2').classList.add('active');
                    document.getElementById('step2Check').classList.remove('pending');
                    document.getElementById('step2Check').classList.add('current');
                    onboardingStep = 2;
                    updateOnboardingProgress();
                    toast('Informations valides ');
                }
            } else {
                // Profile needs completion - open profile modal
                openProfile();
            }
        }

        function handleStep3Click() {
            // Accessible after brand selection (step 2) or if step4 already done
            if (onboardingStep < 3 && !step4Done) return;

            console.log('Onboarding: Starting Copilot experience');

            // Open Copilot with prefilled example question
            openChat('copilot');

            // Get user's selected brand
            const selectedBrand = onboardingBrand || brand || 'mitsubishi';
            const example = getErrorExample(selectedBrand);

            // Prefill with brand-specific visual-requesting question
            setTimeout(() => {
                const input = document.getElementById('copilotInput');
                if (input) {
                    input.value = example.input;
                    input.placeholder = example.placeholder;
                    input.style.height = 'auto';
                    input.style.height = input.scrollHeight + 'px';
                    input.dataset.userTyped = 'false';
                    input.focus();

                    // Add pulsing border to draw attention
                    input.classList.add('onboarding-highlight-input');

                    // Setup tracking for user input
                    setupChatInputTracking();
                }
            }, 100);
        }

        function handleStep4Click() {
            // Accessible after brand selection (step 2) or if step3 already done
            if (onboardingStep < 3 && !step3Done) return;

            console.log('Onboarding: Starting Assistant experience');

            // Open Assistant
            openChat('assistant');

            // Show photo question flow after UI is ready
            setTimeout(() => {
                showAssistantOnboardingFlow();
            }, 300);
        }

        //  ASSISTANT ONBOARDING FLOW 
        function showAssistantOnboardingFlow() {
            const chatContainer = document.getElementById('assistantBody');
            if (!chatContainer) {
                console.warn('Assistant chat container not found');
                return;
            }

            // Get brand for context
            const selectedBrand = onboardingBrand || brand || 'mitsubishi';
            const brandNames = {
                'mitsubishi': 'Mitsubishi Electric',
                'daikin': 'Daikin',
                'carrier': 'Carrier'
            };
            const brandName = brandNames[selectedBrand] || selectedBrand;

            // Create demo conversation
            const demoConversation = `
                <div class="msg ai">
                    <div class="msg-bubble">
                        <div class="msg-head">
                            <div class="msg-avatar"><span class="icon"><svg><use href="#icon-clipboard"/></svg></span></div>
                            <span class="msg-name">FixAIR Assistant</span>
                        </div>
                        <p>Bienvenue dans l'Assistant FixAIR !</p>
                        <p style="margin-top: 8px;">Je vais vous montrer comment gnrer un rapport d'intervention en quelques secondes.</p>
                    </div>
                </div>

                <div class="msg ai">
                    <div class="msg-bubble">
                        <div class="msg-head">
                            <div class="msg-avatar"><span class="icon"><svg><use href="#icon-clipboard"/></svg></span></div>
                            <span class="msg-name">FixAIR Assistant</span>
                        </div>
                        <p><strong>Rapport en cours de cration...</strong></p>
                        <p style="margin-top: 8px; opacity: 0.7;">Client: <em>Jean Dupont</em></p>
                        <p style="opacity: 0.7;">quipement: <em>${brandName} - Climatisation split</em></p>
                        <p style="opacity: 0.7;">Problme: <em>Code erreur diagnostiqu</em></p>
                    </div>
                </div>

                <div class="msg ai photo-question-msg">
                    <div class="msg-bubble">
                        <div class="msg-head">
                            <div class="msg-avatar"><span class="icon"><svg><use href="#icon-clipboard"/></svg></span></div>
                            <span class="msg-name">FixAIR Assistant</span>
                        </div>
                        <p><strong>Avez-vous des photos  ajouter au rapport ?</strong></p>
                        <p style="margin-top: 8px; opacity: 0.7;">Les photos de l'quipement, des codes erreur ou des rparations seront automatiquement intgres.</p>
                        <div class="photo-actions" style="margin-top: 16px; display: flex; gap: 12px; flex-wrap: wrap;">
                            <button onclick="handleOnboardingAddPhotos()" style="
                                background: var(--assistant);
                                color: white;
                                border: none;
                                padding: 12px 20px;
                                border-radius: 10px;
                                cursor: pointer;
                                font-weight: 600;
                                font-size: 13px;
                                display: flex;
                                align-items: center;
                                gap: 8px;
                            ">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><path d="m21 15-5-5L5 21"/></svg>
                                Ajouter des photos
                            </button>
                            <button onclick="handleOnboardingSkipPhotos()" style="
                                background: transparent;
                                color: var(--text-dim);
                                border: 1px solid var(--border);
                                padding: 12px 20px;
                                border-radius: 10px;
                                cursor: pointer;
                                font-size: 13px;
                            ">
                                Passer cette tape
                            </button>
                        </div>
                    </div>
                </div>
            `;

            chatContainer.innerHTML = demoConversation;
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        // Handle "Add Photos" button click in onboarding
        function handleOnboardingAddPhotos() {
            console.log('Onboarding: User wants to add photos');

            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.multiple = true;

            input.onchange = async (e) => {
                const files = Array.from(e.target.files);
                if (files.length > 0) {
                    console.log('Photos selected:', files.length);
                    showOnboardingPhotosPreview(files);
                    setTimeout(() => {
                        generateOnboardingReportPreview(true, files);
                    }, 800);
                }
            };

            input.click();
        }

        // Handle "Skip" button click in onboarding
        function handleOnboardingSkipPhotos() {
            console.log('Onboarding: User skipped photos');

            const photoQuestion = document.querySelector('.photo-question-msg');
            if (photoQuestion) {
                photoQuestion.innerHTML = `
                    <div class="msg-bubble">
                        <div class="msg-head">
                            <div class="msg-avatar"><span class="icon"><svg><use href="#icon-clipboard"/></svg></span></div>
                            <span class="msg-name">FixAIR Assistant</span>
                        </div>
                        <p style="color: var(--assistant);"> D'accord, je gnre le rapport sans photos.</p>
                    </div>
                `;
            }

            setTimeout(() => {
                generateOnboardingReportPreview(false, []);
            }, 400);
        }

        function showOnboardingPhotosPreview(files) {
            const chatContainer = document.getElementById('assistantBody');
            if (!chatContainer) return;

            const photosHtml = files.slice(0, 4).map(file => {
                const url = URL.createObjectURL(file);
                return `<img src="${url}" style="width: 60px; height: 60px; object-fit: cover; border-radius: 8px; border: 1px solid var(--border);">`;
            }).join('');

            const previewMessage = document.createElement('div');
            previewMessage.className = 'msg user';
            previewMessage.innerHTML = `
                <div class="msg-bubble">
                    <p style="margin-bottom: 8px;">Photos ajoutes:</p>
                    <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                        ${photosHtml}
                    </div>
                </div>
            `;

            chatContainer.appendChild(previewMessage);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function generateOnboardingReportPreview(hasPhotos, photos = []) {
            const chatContainer = document.getElementById('assistantBody');
            if (!chatContainer) return;

            const selectedBrand = onboardingBrand || brand || 'mitsubishi';
            const brandNames = {
                'mitsubishi': 'Mitsubishi Electric',
                'daikin': 'Daikin',
                'carrier': 'Carrier'
            };
            const brandName = brandNames[selectedBrand] || selectedBrand;

            const today = new Date().toLocaleDateString('fr-FR');

            const reportMessage = document.createElement('div');
            reportMessage.className = 'msg ai';
            reportMessage.innerHTML = `
                <div class="msg-bubble">
                    <div class="msg-head">
                        <div class="msg-avatar"><span class="icon"><svg><use href="#icon-clipboard"/></svg></span></div>
                        <span class="msg-name">FixAIR Assistant</span>
                    </div>
                    <p style="color: var(--assistant);"><strong> Rapport gnr !</strong></p>

                    <div class="onboarding-report-preview" style="
                        background: rgba(34, 197, 94, 0.08);
                        border: 1px solid rgba(34, 197, 94, 0.2);
                        border-radius: 12px;
                        padding: 16px;
                        margin-top: 12px;
                    ">
                        <h4 style="color: var(--assistant); margin: 0 0 12px; font-size: 14px; display: flex; align-items: center; gap: 8px;">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><path d="M14 2v6h6"/><path d="M16 13H8M16 17H8M10 9H8"/></svg>
                            Rapport d'intervention
                        </h4>

                        <div style="display: grid; gap: 6px; font-size: 12px; color: var(--text-dim);">
                            <div><strong style="color: var(--text);">Client:</strong> Jean Dupont</div>
                            <div><strong style="color: var(--text);">Date:</strong> ${today}</div>
                            <div><strong style="color: var(--text);">quipement:</strong> ${brandName} - Split System</div>
                            <div><strong style="color: var(--text);">Diagnostic:</strong> Code erreur rsolu</div>
                            <div><strong style="color: var(--text);">Actions:</strong> Vrification cblage, rinitialisation</div>
                            ${hasPhotos ? `<div><strong style="color: var(--text);">Photos:</strong> ${photos.length} photo(s) jointe(s)</div>` : ''}
                        </div>

                        <button onclick="viewOnboardingFullReport()" style="
                            background: var(--assistant);
                            color: white;
                            border: none;
                            padding: 10px 16px;
                            border-radius: 8px;
                            cursor: pointer;
                            margin-top: 12px;
                            font-weight: 600;
                            font-size: 12px;
                            width: 100%;
                        ">
                            Voir le rapport complet 
                        </button>
                    </div>
                </div>
            `;

            chatContainer.appendChild(reportMessage);
            chatContainer.scrollTop = chatContainer.scrollHeight;

            // Mark onboarding step complete
            if (!step4Done) {
                step4Done = true;
                completeStep(4);
                updateOnboardingProgress();
                checkOnboardingComplete();
            }
        }

        function viewOnboardingFullReport() {
            console.log('Onboarding: Opening full report view');
            toast('Dans la vraie app, le rapport complet s\'ouvrirait ici!');
            // In production, this would call openReport() or similar
        }

        function completeStep(n) {
            const step = document.getElementById('step' + n);
            const check = document.getElementById('step' + n + 'Check');
            step.classList.remove('active');
            step.classList.add('completed');
            check.classList.remove('current');
            check.classList.add('done');
            check.innerHTML = '<svg viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"/></svg>';
        }

        function updateOnboardingProgress() {
            // Count completed steps: step1 (profile), step2 (brand), step3 (copilot), step4 (assistant)
            let completed = 0;
            if (onboardingStep >= 2) completed = 1; // Profile done
            if (onboardingStep >= 3) completed = 2; // Brand done
            if (step3Done) completed = Math.max(completed, 3);
            if (step4Done) completed = Math.max(completed, step3Done ? 4 : 3);
            if (step3Done && step4Done) completed = 4;
            document.getElementById('onboardingProgress').textContent = completed + '/4';
        }

        async function showCongrats() {
            document.getElementById('welcomeSection').style.display = 'none';
            document.getElementById('onboardingCard').classList.add('congrats');
            onboardingComplete = true;
            // Persist onboarding completion so it's remembered on page reload
            localStorage.setItem('fixair_onboarding_done', 'true');

            // Also save to database so it persists across devices/browsers
            const userId = await getCurrentUserId();
            if (userId && typeof db !== 'undefined') {
                try {
                    await db
                        .from('users')
                        .update({ onboarding_done: true, updated_at: new Date().toISOString() })
                        .eq('id', userId);
                } catch (e) {
                    // Silently fail - localStorage is the backup
                }
            }
        }

        function closeCongrats() {
            document.getElementById('onboardingSection').classList.add('hidden');
            document.getElementById('homepageContent').classList.add('active');
            // Trigger celebration when onboarding complete
            setTimeout(() => onReturnToHomepage(), 500);
        }

        function goToHome() {
            // Update URL and show home page (Router handles closing overlays)
            Router.navigate({ page: 'home' });

            //  REFRESH DATA when returning to homepage 
            if (currentUserId) {
                // Reload projects list
                loadProjectsList();
                // Refresh gamification stats with celebration check
                setTimeout(() => onReturnToHomepage(), 300);
            }
        }

        function showPage(page) {
            currentPage = page;
            document.getElementById('homePage').style.display = page === 'home' ? 'flex' : 'none';
            document.getElementById('projectsPage').classList.toggle('active', page === 'projects');
            document.getElementById('navHome').classList.toggle('active', page === 'home');
            document.getElementById('navProjects').classList.toggle('active', page === 'projects');
            document.getElementById('navConnect').classList.toggle('active', page === 'connect');
            document.getElementById('connectView').classList.toggle('active', page === 'connect');
        }

        function toggleBrandDropdown() {
            const pill = document.getElementById('brandPill');
            const dropdown = document.getElementById('brandDropdown');
            pill.classList.toggle('open');
            dropdown.classList.toggle('show');
        }

        function closeBrandDropdown() {
            const pill = document.getElementById('brandPill');
            const dropdown = document.getElementById('brandDropdown');
            if (pill) pill.classList.remove('open');
            if (dropdown) dropdown.classList.remove('show');
        }

        function setBrand(b) {
            brand = b;
            document.getElementById('brandText').textContent = names[b];
            document.getElementById('copilotSub').textContent = names[b];
            document.getElementById('assistantSub').textContent = names[b];
            document.querySelectorAll('.brand-dropdown-item[data-b]').forEach(o => o.classList.toggle('selected', o.dataset.b === b));
            document.querySelectorAll('.brand-chip').forEach(c => c.classList.toggle('active', c.dataset.b === b));
            closeBrandDropdown();
            
            //  FIX: Update brand context in fresh chat if no project created yet 
            if (!currentProjectId) {
                updateBrandContextInHistory();
            }
            //  END FIX 
        }
        
        // Helper function to update brand context in chat history
        function updateBrandContextInHistory() {
            const brandNames = {
                'mitsubishi': 'Mitsubishi Electric',
                'daikin': 'Daikin',
                'carrier': 'Carrier',
                'lg': 'LG',
                'samsung': 'Samsung',
                'panasonic': 'Panasonic',
                'toshiba': 'Toshiba',
                'fujitsu': 'Fujitsu',
                'hitachi': 'Hitachi',
                'general': 'Multi-marques'
            };
            const brandName = brandNames[brand] || brand;
            
            // Update context for both panels
            ['assistant', 'copilot'].forEach(panel => {
                const brandContext = panel === 'assistant' 
                    ? `[CONTEXTE MARQUE] Cette intervention concerne un systme ${brandName}. Tu connais dj la marque = ${brandName}. NE DEMANDE JAMAIS la marque. Premier message: "Salut ! Tu travailles sur un systme ${brandName}. C'est quoi aujourd'hui ? 1. Dpannage 2. Mise en service 3. Maintenance 4. Installation"`
                    : `[CONTEXTE MARQUE] Ce diagnostic concerne un systme ${brandName}. Tu connais dj la marque = ${brandName}. NE DEMANDE JAMAIS la marque. Utilise la base de connaissances ${brandName}. Premier message: "Salut ! Tu travailles sur un systme ${brandName}. Comment puis-je t'aider ?"`;
                
                // Find and update or add system message
                const systemMsgIndex = chatHistory[panel].findIndex(m => m.role === 'system');
                if (systemMsgIndex >= 0) {
                    chatHistory[panel][systemMsgIndex].content = brandContext;
                } else if (chatHistory[panel].length === 0) {
                    chatHistory[panel].push({ role: 'system', content: brandContext });
                }
            });
        }

        // 
        // CHAT HEADER BRAND DROPDOWN (Option B)
        // 
        
        // Toggle brand dropdown in chat header
        function toggleChatBrandDropdown(panel) {
            const wrapper = document.getElementById(panel + 'BrandWrapper');
            const isOpen = wrapper.classList.contains('open');
            
            // Close all dropdowns first
            closeChatBrandDropdowns();
            
            if (!isOpen) {
                wrapper.classList.add('open');
                updateChatBrandDropdownSelection(panel);
                
                // Close when clicking outside
                setTimeout(() => {
                    document.addEventListener('click', closeChatBrandDropdownsOnClick);
                }, 10);
            }
        }
        
        // Close all chat brand dropdowns
        function closeChatBrandDropdowns() {
            document.getElementById('copilotBrandWrapper')?.classList.remove('open');
            document.getElementById('assistantBrandWrapper')?.classList.remove('open');
            document.removeEventListener('click', closeChatBrandDropdownsOnClick);
        }
        
        // Close dropdowns when clicking outside
        function closeChatBrandDropdownsOnClick(e) {
            if (!e.target.closest('.panel-brand-wrapper')) {
                closeChatBrandDropdowns();
            }
        }
        
        // Update dropdown selection indicators
        function updateChatBrandDropdownSelection(panel) {
            const dropdown = document.getElementById(panel + 'BrandDropdown');
            if (!dropdown) return;
            
            dropdown.querySelectorAll('.panel-brand-option').forEach(opt => {
                opt.classList.toggle('selected', opt.dataset.brand === brand);
            });
        }
        
        // Change brand from chat header dropdown
        async function changeChatBrand(newBrand, panel) {
            const oldBrand = brand;
            
            if (newBrand === oldBrand) {
                closeChatBrandDropdowns();
                return;
            }
            
            const brandNames = {
                'mitsubishi': 'Mitsubishi Electric',
                'daikin': 'Daikin',
                'carrier': 'Carrier',
                'lg': 'LG',
                'samsung': 'Samsung',
                'panasonic': 'Panasonic',
                'toshiba': 'Toshiba',
                'fujitsu': 'Fujitsu',
                'hitachi': 'Hitachi',
                'general': 'Multi-marques'
            };
            
            const oldBrandName = brandNames[oldBrand] || oldBrand;
            const newBrandName = brandNames[newBrand] || newBrand;
            
            // Update global brand
            brand = newBrand;
            
            // Update UI everywhere
            document.getElementById('copilotSub').textContent = newBrandName;
            document.getElementById('assistantSub').textContent = newBrandName;
            document.getElementById('brandText').textContent = newBrandName;
            
            // Update home page dropdowns if visible
            document.querySelectorAll('.brand-dropdown-item[data-b]').forEach(o => {
                o.classList.toggle('selected', o.dataset.b === newBrand);
            });
            document.querySelectorAll('.brand-chip').forEach(c => {
                c.classList.toggle('active', c.dataset.b === newBrand);
            });
            
            // Update chat history with new brand context
            updateBrandContextInHistory();

            // Update Copilot example if on copilot panel
            if (panel === 'copilot') {
                onBrandChangeUpdateExample(newBrand);
            }

            // Update database if project exists
            if (currentProjectId) {
                try {
                    // First, get current project to check if original_brand is set
                    const { data: currentProject } = await db
                        .from('projects')
                        .select('original_brand, brand')
                        .eq('id', currentProjectId)
                        .single();
                    
                    // Build update data
                    const updateData = { brand: newBrand };
                    
                    // Only set original_brand if not already set (first change only)
                    if (!currentProject?.original_brand && currentProject?.brand) {
                        updateData.original_brand = oldBrand;
                    }
                    
                    const { error } = await db
                        .from('projects')
                        .update(updateData)
                        .eq('id', currentProjectId);
                    
                } catch (e) {
                    // Failed to update brand in database
                }
            }

            // Close dropdown
            closeChatBrandDropdowns();

            // Add confirmation message in chat
            const confirmMsg = `<p style="color: var(--mode-color);"> Marque change: <strong>${oldBrandName}</strong>  <strong>${newBrandName}</strong></p><p style="font-size: 12px; opacity: 0.7;">On continue avec ${newBrandName}.</p>`;
            addMsg(panel, 'ai', confirmMsg);
        }

        // Old updateRing removed - now using gamification refreshWeeklyStats()

        // Track if we're opening from an existing project
        let openingFromProject = false;
        
        function openChat(m) {
            mode = m;
            // Update viewport height for mobile browsers
            if (typeof setViewportHeight === 'function') setViewportHeight();
            
            const cv = document.getElementById('chatView');
            // Use full visible height - nav is hidden via CSS when chat is open
            const visibleHeight = typeof getVisibleHeight === 'function' ? getVisibleHeight() : window.innerHeight;
            cv.style.height = `${visibleHeight}px`;
            
            cv.classList.add('active');
            cv.classList.remove('split');
            cv.classList.add('single');
            isSplit = false;
            document.getElementById('panelCopilot').style.flexBasis = '';
            document.getElementById('panelAssistant').style.flexBasis = '';
            document.getElementById('panelCopilot').style.display = m === 'copilot' ? 'flex' : 'none';
            document.getElementById('panelAssistant').style.display = m === 'assistant' ? 'flex' : 'none';
            document.getElementById('divider').style.display = 'none';
            updateModeToggle(m);
            
            //  FIX: Handle project state based on whether we're opening from an existing project 
            const isFromProject = openingFromProject;
            openingFromProject = false; // Reset flag immediately
            
            if (isFromProject) {
                // Opening existing project - keep the loaded messages
                // Don't clear body - messages are already loaded
            } else {
                // Starting fresh chat - reset everything
                currentProjectId = null;
                currentChatId = { assistant: null, copilot: null };
                currentProjectTitle = null;
                projectMessageCount = 0;
                lastReportData = null;  // FIX-D: Reset report data for new project
                window.reportPhotos = []; // Reset photos for new project
                
                //  FIX: Add brand context as FIRST message in history 
                const brandNames = {
                    'mitsubishi': 'Mitsubishi Electric',
                    'daikin': 'Daikin',
                    'carrier': 'Carrier',
                    'lg': 'LG',
                    'samsung': 'Samsung',
                    'panasonic': 'Panasonic',
                    'toshiba': 'Toshiba',
                    'fujitsu': 'Fujitsu',
                    'hitachi': 'Hitachi',
                    'general': 'Multi-marques'
                };
                const brandName = brandNames[brand] || brand;
                
                // Create brand context message for the AI
                const brandContext = m === 'assistant' 
                    ? `[CONTEXTE - NOUVELLE CONVERSATION]
MARQUE: ${brandName}
MODE: Assistant Rapport
INSTRUCTIONS STRICTES:
- Tu connais DJ la marque = ${brandName}
- NE DEMANDE JAMAIS la marque, elle est confirme
- Demande le type d'intervention: Dpannage, Mise en service, Maintenance, ou Installation
- Ensuite pose les questions ncessaires pour gnrer un rapport professionnel
Premier message suggr: "Salut ! Tu travailles sur un systme ${brandName}. C'est quoi aujourd'hui ? 1. Dpannage 2. Mise en service 3. Maintenance 4. Installation"`
                    : `[CONTEXTE - NOUVELLE CONVERSATION]
MARQUE: ${brandName}
MODE: Copilot Diagnostic
INSTRUCTIONS STRICTES:
- Tu connais DJ la marque = ${brandName}
- NE DEMANDE JAMAIS la marque, elle est confirme
- Utilise la base de connaissances ${brandName} pour les codes erreur
- Aide au diagnostic avec des questions cibles
Premier message suggr: "Salut ! Tu travailles sur un systme ${brandName}. Quel est le problme ou code erreur ?"`;
                
                chatHistory.assistant = [];
                chatHistory.copilot = [];
                
                // Add brand context as first system message
                chatHistory[m].push({ 
                    role: 'system',
                    content: brandContext
                });
                //  END FIX 
                
                updateChatHeader();
                
                // Clear body for fresh start (preserve TP containers)
                clearChatBody('copilot');
                clearChatBody('assistant');
                
                // Show welcome message
                const wel = {
                    copilot: `Bonjour ! <strong style="color:var(--copilot)">FixAIR Copilot</strong> prt pour <strong>${brandName}</strong>. Comment puis-je vous aider ?`,
                    assistant: `<strong style="color:var(--assistant)">FixAIR Assistant</strong> prt pour <strong>${brandName}</strong>. Dcrivez l'intervention et je gnre le rapport.`
                };
                addMsg(m, 'ai', wel[m]);
            }
            //  END FIX 
            
            closeAllAttach();
            
            // Scroll to bottom of active chat
            setTimeout(() => {
                scrollToBottom(m);
                initScrollDetection(m);
            }, 100);
        }

        function closeChat() {
            document.getElementById('chatView').classList.remove('active');
            closeReport();
            closeAllAttach();
            
            // Recalculate viewport
            if (typeof setViewportHeight === 'function') setViewportHeight();
            
            // Check onboarding completion - works regardless of order
            if (!onboardingComplete) {
                const copilotHasUserMsg = document.querySelectorAll('#copilotBody .msg.user').length > 0;
                const assistantHasUserMsg = document.querySelectorAll('#assistantBody .msg.user').length > 0;
                
                // Check Copilot step (step 3) if user sent message in Copilot
                if (copilotHasUserMsg && !step3Done) {
                    step3Done = true;
                    completeStep(3);
                    // If step 4 not done, make it active
                    if (!step4Done) {
                        document.getElementById('step4').classList.remove('locked');
                        document.getElementById('step4').classList.add('active');
                        document.getElementById('step4Check').classList.remove('pending');
                        document.getElementById('step4Check').classList.add('current');
                    }
                    updateOnboardingProgress();
                }
                
                // Check Assistant step (step 4) if user sent message in Assistant
                if (assistantHasUserMsg && !step4Done) {
                    step4Done = true;
                    completeStep(4);
                    // If step 3 not done, make it active
                    if (!step3Done) {
                        document.getElementById('step3').classList.remove('locked');
                        document.getElementById('step3').classList.add('active');
                        document.getElementById('step3Check').classList.remove('pending');
                        document.getElementById('step3Check').classList.add('current');
                    }
                    updateOnboardingProgress();
                }
                
                // If both done, show congrats
                if (step3Done && step4Done && !onboardingComplete) {
                    onboardingStep = 5;
                    updateOnboardingProgress();
                    showCongrats();
                }
            }
        }

        function updateModeToggle(activeMode) {
            const copilotPanel = document.getElementById('panelCopilot');
            copilotPanel.querySelectorAll('.mode-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.classList.contains(activeMode)) btn.classList.add('active');
            });
            const assistantPanel = document.getElementById('panelAssistant');
            assistantPanel.querySelectorAll('.mode-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.classList.contains(activeMode)) btn.classList.add('active');
            });
        }

        async function switchMode(m) {
            if(isSplit) return;
            mode = m;
            document.getElementById('panelCopilot').style.display = m === 'copilot' ? 'flex' : 'none';
            document.getElementById('panelAssistant').style.display = m === 'assistant' ? 'flex' : 'none';
            updateModeToggle(m);
            
            //  SUPABASE: Load or create chat for this mode 
            if (currentProjectId && !currentChatId[m]) {
                // Check if chat exists for this mode in current project
                const { data: existingChat } = await db
                    .from('chats')
                    .select()
                    .eq('project_id', currentProjectId)
                    .eq('chat_type', m)
                    .maybeSingle();
                
                if (existingChat) {
                    currentChatId[m] = existingChat.id;
                    
                    // Load messages for this chat
                    const { data: messages } = await db
                        .from('messages')
                        .select('*')
                        .eq('chat_id', existingChat.id)
                        .order('created_at', { ascending: true });
                    
                    // Clear and reload chat (preserve TP containers)
                    clearChatBody(m);
                    chatHistory[m] = [];
                    
                    for (const msg of messages || []) {
                        const role = msg.role === 'assistant' ? 'ai' : msg.role;
                        if (role === 'user' || role === 'ai') {
                            // Check if this is an image message
                            if (msg.content_type === 'image' && msg.content.startsWith('data:image')) {
                                // Render as photo
                                const msgId = 'photo-' + Date.now() + '-' + Math.random().toString(36).substr(2, 5);
                                const msgDiv = document.createElement('div');
                                msgDiv.className = 'msg user';
                                msgDiv.id = msgId;
                                
                                // Check if this photo was already added to report
                                const isInReport = window.reportPhotos?.some(p => p.url === msg.content || p.data === msg.content);
                                msgDiv.innerHTML = createPhotoMessageHTML(msgId, m, msg.content, isInReport);
                                msgDiv.dataset.imageData = msg.content;
                                
                                body.appendChild(msgDiv);
                            } else if (msg.content_type === 'ocr') {
                                // Render OCR result message
                                try {
                                    const ocrData = JSON.parse(msg.content);
                                    // Find source image from previous messages
                                    const sourceImg = findSourceImage(messages, ocrData.sourcePhotoId);
                                    renderOCRMessage(m, ocrData, sourceImg);
                                } catch (e) {
                                    // Error parsing OCR message
                                }
                            
                                } else {
                                
                                // Regular text message
                                const content = role === 'ai' ? parseMarkdown(msg.content) : msg.content;
                                addMsg(m, role, content);
                                
                                //  FIX: Extract REPORT_DATA from loaded AI messages to update drawer 
                                if (role === 'ai' && msg.content.includes('[REPORT_DATA]')) {
                                    try {
                                        const reportDataMatch = msg.content.match(/\[REPORT_DATA\]([\s\S]*?)\[\/REPORT_DATA\]/);
                                        if (reportDataMatch) {
                                            let reportData = JSON.parse(reportDataMatch[1].trim());
                                            reportData = normalizeReportData(reportData);
                                            if (!lastReportData) {
                                                lastReportData = { brand: brand, brand_key: brand, status: 'en_cours', date: new Date().toLocaleDateString('fr-FR') };
                                            }
                                            lastReportData = unifiedMerge(lastReportData, reportData);
                                            updateDrawerPreview(lastReportData);
                                        }
                                    } catch (e) {
                                        // Could not parse saved REPORT_DATA
                                    }
                                }
                            }
                            chatHistory[m].push({ role: msg.role, content: msg.content });
                        }
                    }

                    //  REFRESH DRAWER ON ASSISTANT MODE 
                    if (m === 'assistant') {
                        if (!lastReportData || Object.keys(lastReportData).length === 0) {
                            buildPartialReport();
                        }
                        if (lastReportData && Object.keys(lastReportData).length > 0) {
                            setTimeout(() => {
                                updateDrawerPreview(lastReportData);
                                console.log('[Mode]  Drawer refreshed on assistant mode');
                            }, 150);
                        }
                    }
                    return;
                } else {
                    
                    // Create new chat in same project
                    const userId = await getCurrentUserId();
                    if (userId && !userId.startsWith('demo-')) {
                        const { data: newChat } = await db
                            .from('chats')
                            .insert({
                                project_id: currentProjectId,
                                user_id: userId,
                                chat_type: m,
                                is_active: true
                            })
                            .select()
                            .single();
                        
                        if (newChat) {
                            currentChatId[m] = newChat.id;
                        }
                    }
                }
            }
           
            //  END SUPABASE 
            
            const body = document.getElementById(m + 'Body');
            if(!body.innerHTML) {
                const wel = m === 'copilot' 
                    ? `Bonjour ! <strong style="color:var(--copilot)">FixAIR Copilot</strong> prt pour <strong>${names[brand]}</strong>.`
                    : `<strong style="color:var(--assistant)">FixAIR Assistant</strong> prt.`;
                addMsg(m, 'ai', wel);
            }
        }

        function toggleSplit() {
            const cv = document.getElementById('chatView');
            const div = document.getElementById('divider');
            isSplit = !isSplit;
            
            // Update viewport and use full visible height
            if (typeof setViewportHeight === 'function') setViewportHeight();
            const visibleHeight = typeof getVisibleHeight === 'function' ? getVisibleHeight() : window.innerHeight;
            cv.style.height = `${visibleHeight}px`;
            
            if(isSplit) {
                cv.classList.remove('single');
                cv.classList.add('split');
                document.getElementById('panelCopilot').style.flexBasis = '50%';
                document.getElementById('panelAssistant').style.flexBasis = '50%';
                document.getElementById('panelCopilot').style.display = 'flex';
                document.getElementById('panelAssistant').style.display = 'flex';
                div.style.display = 'flex';
                document.querySelectorAll('.h-btn[title="Mode split"]').forEach(b => b.classList.add('active'));
                
                const copilotPanel = document.getElementById('panelCopilot');
                copilotPanel.querySelectorAll('.mode-btn').forEach(btn => {
                    btn.classList.toggle('active', btn.classList.contains('copilot'));
                });
                const assistantPanel = document.getElementById('panelAssistant');
                assistantPanel.querySelectorAll('.mode-btn').forEach(btn => {
                    btn.classList.toggle('active', btn.classList.contains('assistant'));
                });
                
                if(!document.getElementById('assistantBody').innerHTML) 
                    addMsg('assistant', 'ai', `<strong style="color:var(--assistant)">FixAIR Assistant</strong> prt.`);
                if(!document.getElementById('copilotBody').innerHTML) 
                    addMsg('copilot', 'ai', `<strong style="color:var(--copilot)">FixAIR Copilot</strong> prt.`);
            } else {
                cv.classList.remove('split');
                cv.classList.add('single');
                document.getElementById('panelCopilot').style.flexBasis = '';
                document.getElementById('panelAssistant').style.flexBasis = '';
                document.getElementById('panelCopilot').style.display = mode === 'copilot' ? 'flex' : 'none';
                document.getElementById('panelAssistant').style.display = mode === 'assistant' ? 'flex' : 'none';
                div.style.display = 'none';
                document.querySelectorAll('.h-btn[title="Mode split"]').forEach(b => b.classList.remove('active'));
                updateModeToggle(mode);
            }
        }

        function openReport() {
            document.getElementById('reportSheet').classList.add('open');
            document.getElementById('reportBackdrop').classList.add('show');

            // Always rebuild report data from chat history (not just when empty)
            buildPartialReport();

            // Always show editable template with current data (or empty)
            updateDrawerPreview(lastReportData || {});
        }
        
        function closeReport() {
            document.getElementById('reportSheet').classList.remove('open');
            document.getElementById('reportBackdrop').classList.remove('show');
        }

        //  FIX-C: Strip [REPORT_DATA] blocks from displayed AI messages 
        function stripReportDataFromDisplay(text) {
            if (!text || typeof text !== 'string') return text;
            // Remove [REPORT_DATA]...[/REPORT_DATA] blocks
            text = text.replace(/\[REPORT_DATA\][\s\S]*?\[\/REPORT_DATA\]/g, '').trim();
            // Remove legacy embedded JSON with type:report
            text = text.replace(/\s*\{"type"\s*:\s*"report"[\s\S]*\}\s*$/, '').trim();
            return text;
        }

      function addMsg(panel, type, content) {
            const body = document.getElementById(panel + 'Body');
            const msg = document.createElement('div');

            // FIX-C: Strip any remaining [REPORT_DATA] blocks from AI messages
            if (type === 'ai') {
                content = stripReportDataFromDisplay(content);
            }

            // Detect if this is a report message (contains report keywords/headers)
            const isReport = type === 'ai' && (
                content.includes('RAPPORT D') || 
                content.includes('RAPPORT') ||
                (content.includes('<h2>') && content.includes('Client'))
            );
            
            msg.className = 'msg ' + type + (isReport ? ' report' : '');
            const modeName = panel === 'copilot' ? 'Copilot' : 'Assistant';
            const modeIcon = panel === 'copilot' ? '#icon-star' : '#icon-clipboard';
            
            if(type === 'user') {
                msg.innerHTML = `<div class="msg-bubble">${content}</div>`;
            } else {
                msg.innerHTML = `<div class="msg-bubble"><div class="msg-head"><div class="msg-avatar"><span class="icon"><svg><use href="${modeIcon}"/></svg></span></div><span class="msg-name">FixAIR ${modeName}</span></div><span class="msg-act" onclick="copyTxt(this)" title="Copier"><span class="icon"><svg><use href="#icon-copy"/></svg></span></span>${content}</div>`;
            }
            body.appendChild(msg);
            body.scrollTop = body.scrollHeight;
            
            // Render any Mermaid diagrams in the message
            if (type === 'ai') {
                renderMermaidDiagrams(msg);
            }
        }

        // ==================== VOICE WAVEFORM SYSTEM ====================
        const MAX_BARS = 400;
        const MIN_HEIGHT = 3;
        const MAX_HEIGHT = 28;
        const SILENCE_THRESHOLD = 0.08;
        
        let recordings = {};
        let audioContexts = {};
        let analysers = {};
        let waveformIntervals = {};
        let voiceTimers = {};
        let simulatedSpeaking = {};
        let simulatedIntensityTarget = {};
        let simulatedIntensityCurrent = {};
        
        // Handle input text changes - auto-resize and switch between mic/send
        function handleChatInput(panel) {
            const input = document.getElementById(panel + 'Input');
            const inputRow = document.getElementById(panel + 'InputRow');
            const btn = document.getElementById(panel + 'ActionBtn');
            const hasText = input.value.trim().length > 0;
            
            // Auto-resize textarea
            const maxHeight = Math.floor(window.innerHeight * 0.25); // 25% of viewport
            input.style.height = 'auto';
            const scrollHeight = input.scrollHeight;
            
            if (scrollHeight <= maxHeight) {
                input.style.height = scrollHeight + 'px';
                input.classList.remove('scrollable');
                input.style.overflowY = 'hidden';
            } else {
                input.style.height = maxHeight + 'px';
                input.classList.add('scrollable');
                input.style.overflowY = 'auto';
            }
            
            // Update border radius based on height
            if (scrollHeight > 50) {
                inputRow.classList.add('expanded');
            } else {
                inputRow.classList.remove('expanded');
            }
            
            // Toggle mic/send icon
            if (hasText) {
                btn.classList.add('has-text');
                btn.classList.remove('recording');
            } else {
                btn.classList.remove('has-text');
            }
        }
        
        // Handle keydown for Enter/Shift+Enter behavior
        function handleKeydown(event, panel) {
            if (event.key === 'Enter') {
                if (event.shiftKey) {
                    // Shift+Enter: allow new line (default behavior)
                    return;
                } else {
                    // Enter alone: send message
                    event.preventDefault();
                    handleSend(panel);
                }
            }
        }
        
        // Reset textarea after sending
        function resetTextarea(panel) {
            const input = document.getElementById(panel + 'Input');
            const inputRow = document.getElementById(panel + 'InputRow');
            input.style.height = '36px';
            input.classList.remove('scrollable');
            input.style.overflowY = 'hidden';
            inputRow.classList.remove('expanded');
        }
        
        // Handle send (Enter key)
        function handleSend(panel) {
            const input = document.getElementById(panel + 'Input');
            if (input.value.trim()) {
                sendMsg(panel);
            }
        }
        
        // Handle action button click (mic/send/stop)
        function handleAction(panel) {
            const input = document.getElementById(panel + 'Input');
            const btn = document.getElementById(panel + 'ActionBtn');
            const hasText = input.value.trim().length > 0;
            
            if (btn.classList.contains('recording')) {
                stopRecording(panel);
            } else if (hasText) {
                sendMsg(panel);
                btn.classList.remove('has-text');
            } else {
                startRecording(panel);
            }
        }
        
        // Send message
        // n8n Webhook URL
        // n8n Webhook URL - DEV VERSION
        const WEBHOOKS = {
            'copilot': 'https://cherhabil.app.n8n.cloud/webhook/fixair-copilot',
            'assistant': 'https://cherhabil.app.n8n.cloud/webhook/fixair-assistant-dev'  // DEV
        };
        const EXTRACTION_WEBHOOK = 'https://cherhabil.app.n8n.cloud/webhook/fixair-extraction-dev';  // DEV
        
        function getWebhookUrl(panel) {
            return WEBHOOKS[panel] || WEBHOOKS['assistant'];
        }
        
        // Session IDs will be set based on project when a project is opened
        // This ensures memory persists across page reloads for the same project
        let sessionIds = {
            copilot: null,
            assistant: null
        };
        
        // Function to update session IDs when project changes
        function updateSessionIds(projectId) {
            if (projectId) {
                sessionIds.copilot = 'copilot-' + projectId;
                sessionIds.assistant = 'assistant-' + projectId;
            } else {
                // Fallback for no project (should not happen normally)
                const tempId = Date.now().toString();
                sessionIds.copilot = 'copilot-temp-' + tempId;
                sessionIds.assistant = 'assistant-temp-' + tempId;
            }
        }
        
        // 
        // SUPABASE PROJECT MANAGEMENT
        // 
        
        // Current project/chat state
        let currentUserId = null;
        let currentProjectId = null;
        let currentChatId = {
            assistant: null,
            copilot: null
        };
        let projectMessageCount = 0;
        
        // 
        // PROJECT MANAGEMENT FUNCTIONS
        // 
        
        // Get current user ID from existing auth (uses your n8n auth system)
        async function getCurrentUserId() {
            // First try to get from currentUser
            if (currentUser && currentUser.id) {
                currentUserId = currentUser.id;
                return currentUser.id;
            }
            
            // Wait for Supabase to be ready
            await waitForSupabase();
            
            // Fallback: get from Supabase Auth session
            try {
                const { data: { session } } = await db.auth.getSession();
                if (session && session.user) {
                    const profile = await loadUserProfile(session.user.id);
                    if (profile) {
                        currentUser = profile;
                        currentUserId = profile.id;
                        return profile.id;
                    }
                }
            } catch (err) {
                console.error('Error getting user ID:', err);
            }
            
            // Demo fallback
            let localId = localStorage.getItem('fixair_demo_user_id');
            if (!localId) {
                localId = 'demo-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
                localStorage.setItem('fixair_demo_user_id', localId);
            }
            currentUserId = localId;
            return localId;
        }
        
        // Create or get project for current session
        async function ensureProject(panel) {
            // If we already have a project, return it
            if (currentProjectId && currentChatId[panel]) {
                return { projectId: currentProjectId, chatId: currentChatId[panel] };
            }
            
            const userId = await getCurrentUserId();
            if (!userId || userId.startsWith('demo-')) {
                return null;
            }
            
            // If no project yet, create one
            if (!currentProjectId) {
                const { data: project, error: projectError } = await db
                    .from('projects')
                    .insert({
                        user_id: userId,
                        title: 'Nouvelle intervention',
                        brand: brand,
                        status: 'active'
                    })
                    .select()
                    .single();
                
                if (projectError) {
                    return null;
                }

                currentProjectId = project.id;
                updateSessionIds(project.id); // Update session IDs for n8n memory
            }
            
            // If no chat for this panel, create one
            if (!currentChatId[panel]) {
                const { data: chat, error: chatError } = await db
                    .from('chats')
                    .insert({
                        project_id: currentProjectId,
                        user_id: userId,
                        chat_type: panel,
                        is_active: true
                    })
                    .select()
                    .single();
                
                if (chatError) {
                    return null;
                }

                currentChatId[panel] = chat.id;
            }
            
            return { projectId: currentProjectId, chatId: currentChatId[panel] };
        }
        
        // Save message to Supabase
        async function saveMessage(chatId, role, content, contentType = 'text', thoughtProcess = null, thoughtSummary = null) {
            if (!chatId) return null;
            
            const { data, error } = await db
                .from('messages')
                .insert({
                    chat_id: chatId,
                    role: role,
                    content: content,
                    content_type: contentType,
                    thought_process: thoughtProcess,
                    thought_summary: thoughtSummary
                })
                .select()
                .single();
            
            if (error) {
                return null;
            }
            
            // Increment message count for auto-naming
            projectMessageCount++;
            
            // Auto-name project after 3 messages
            if (projectMessageCount === 3 && currentProjectId) {
                autoNameProject(content);
            }
            
            return data;
        }
        
        // Auto-generate project name from first messages
        async function autoNameProject(lastMessage) {
            // Get first few messages to generate name
            const { data: messages } = await db
                .from('messages')
                .select('content, role')
                .eq('chat_id', currentChatId.assistant || currentChatId.copilot)
                .order('created_at', { ascending: true })
                .limit(3);
            
            if (!messages || messages.length === 0) return;
            
            // Simple name generation: use first user message
            const firstUserMsg = messages.find(m => m.role === 'user');
            if (firstUserMsg) {
                // Clean the title: remove problematic characters
                let title = firstUserMsg.content
                    .replace(/[\n\r\t]/g, ' ')    // Remove newlines, tabs
                    .replace(/\s+/g, ' ')          // Collapse multiple spaces
                    .trim()
                    .substring(0, 50);
                if (firstUserMsg.content.length > 50) title += '...';
                
                await db
                    .from('projects')
                    .update({ title: title })
                    .eq('id', currentProjectId);
                
                // Update current project title and header
                currentProjectTitle = title;
                updateChatHeader();

                // Refresh projects list
                loadProjectsList();
            }
        }
        
        // Load projects and check if user should skip onboarding (has existing projects)
        async function loadProjectsListAndCheckOnboarding() {
            await loadProjectsList();

            // If user has projects but hasn't completed onboarding, they're an existing user
            // Skip onboarding for them and mark as done
            if (!onboardingComplete && window.projectsData && window.projectsData.length > 0) {
                onboardingComplete = true;
                document.querySelector('.onboarding-section').classList.add('hidden');
                document.getElementById('homepageContent').classList.add('active');
                localStorage.setItem('fixair_onboarding_done', 'true');

                // Also update database
                const userId = await getCurrentUserId();
                if (userId && typeof db !== 'undefined') {
                    try {
                        await db
                            .from('users')
                            .update({ onboarding_done: true, updated_at: new Date().toISOString() })
                            .eq('id', userId);
                    } catch (e) {
                        // Silently fail - localStorage is the backup
                    }
                }
            }
        }

        // Load user's projects list
        async function loadProjectsList() {
            const userId = await getCurrentUserId();
            if (!userId || userId.startsWith('demo-')) {
                return;
            }

            try {
                const { data: projects, error } = await db
                    .from('projects')
                    .select(`
                        id,
                        title,
                        brand,
                        original_brand,
                        status,
                        created_at,
                        updated_at,
                        chats (
                            id,
                            chat_type,
                            message_count
                        )
                    `)
                    .eq('user_id', userId)
                    .order('updated_at', { ascending: false })
                    .limit(20);
                
                if (error) {
                    return;
                }

                // Store projects globally for context menu
                window.projectsData = projects || [];
                
                renderProjectsList(projects);
                renderRecentProjects(projects?.slice(0, 2) || []);
                
            } catch (e) {
                // Unexpected error loading projects
            }
        }
        
        // Variable to track which project is being edited
        let contextMenuProjectId = null;
        let currentProjectTitle = null;
        
        // Generate project card HTML
        function generateProjectCardHtml(project, includeContextMenu = true) {
            const hasAssistant = project.chats?.some(c => c.chat_type === 'assistant');
            const hasCopilot = project.chats?.some(c => c.chat_type === 'copilot');
            const hasBoth = hasAssistant && hasCopilot;
            
            const timeAgo = formatTimeAgo(new Date(project.updated_at));
            
            // Status bar class
            let barClass = 'copilot-bar';
            if (hasBoth) barClass = 'both-bar';
            else if (hasAssistant) barClass = 'assistant-bar';
            
            let iconHtml = '';
            if (hasBoth) {
                iconHtml = `<div class="proj-icons dual">
                    <div class="proj-icon copilot back"><span class="star-icon"><svg viewBox="0 0 200 200"><use href="#icon-star"/></svg></span></div>
                    <div class="proj-icon assistant front"><span class="icon"><svg><use href="#icon-clipboard"/></svg></span></div>
                </div>`;
            } else if (hasAssistant) {
                iconHtml = `<div class="proj-icon assistant"><span class="icon"><svg><use href="#icon-clipboard"/></svg></span></div>`;
            } else {
                iconHtml = `<div class="proj-icon copilot"><span class="star-icon"><svg viewBox="0 0 200 200"><use href="#icon-star"/></svg></span></div>`;
            }
            
            const brandLabel = project.brand ? project.brand.charAt(0).toUpperCase() + project.brand.slice(1) : '';
            
            // Show brand history if changed (Original  Current)
            let brandDisplay = brandLabel;
            if (project.original_brand && project.original_brand !== project.brand) {
                const originalBrandLabel = project.original_brand.charAt(0).toUpperCase() + project.original_brand.slice(1);
                brandDisplay = `${originalBrandLabel}  ${brandLabel}`;
            }
            
            const modeLabel = hasBoth ? 'Diagnostic + Rapport' : (hasAssistant ? 'Rapport' : 'Diagnostic');
            
            const safeTitle = escapeForJs(project.title || 'Sans titre');
const contextMenuAttr = includeContextMenu ? `oncontextmenu="showProjectContextMenu(event, '${project.id}', '${safeTitle}')" ontouchstart="startLongPress(event, '${project.id}', '${safeTitle}')" ontouchend="cancelLongPress()" ontouchmove="cancelLongPress()"` : '';            
            return `
                <div class="proj ${barClass}" onclick="loadProject('${project.id}')" ${contextMenuAttr} data-project-id="${project.id}">
                    ${iconHtml}
                    <div class="proj-info">
                        <div class="proj-title">${escapeHtml(project.title || 'Sans titre')}</div>
                        <div class="proj-meta">${modeLabel}${brandDisplay ? '  ' + brandDisplay : ''}</div>
                    </div>
                    <span class="proj-time">${timeAgo}</span>
                </div>
            `;
        }
        
        // Render projects in the projects page
        function renderProjectsList(projects) {
            const container = document.getElementById('projectsList');
            if (!container) return;
            
            if (!projects || projects.length === 0) {
                container.innerHTML = `
                    <div class="empty-projects" style="text-align: center; padding: 40px 20px; color: var(--text-dim);">
                        <p style="margin-bottom: 8px;">Aucun projet</p>
                        <p style="font-size: 12px;">Commencez une nouvelle conversation</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = projects.map(project => generateProjectCardHtml(project, true)).join('');
        }
        
        // Render recent projects on home page
        function renderRecentProjects(projects) {
            const container = document.getElementById('recentProjectsHome');
            if (!container) return;
            
            if (!projects || projects.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: var(--text-dim); font-size: 13px;">
                        Aucun projet rcent
                    </div>
                `;
                return;
            }
            
            container.innerHTML = projects.map(project => generateProjectCardHtml(project, true)).join('');
        }
        
        // Show context menu for project
        function showProjectContextMenu(event, projectId, projectTitle) {
            event.preventDefault();
            event.stopPropagation();
            
            contextMenuProjectId = projectId;
            currentProjectTitle = projectTitle;
            
            const menu = document.getElementById('projectContextMenu');
            
            // Position menu - use touch point if available, otherwise mouse
            let x = event.clientX || (event.touches && event.touches[0]?.clientX) || 100;
            let y = event.clientY || (event.touches && event.touches[0]?.clientY) || 100;
            
            // Keep menu within viewport
            const menuWidth = 160;
            const menuHeight = 90;
            if (x + menuWidth > window.innerWidth) x = window.innerWidth - menuWidth - 10;
            if (y + menuHeight > window.innerHeight) y = window.innerHeight - menuHeight - 10;
            
            menu.style.left = x + 'px';
            menu.style.top = y + 'px';
            menu.classList.add('show');
            
            // Haptic feedback on mobile
            if (navigator.vibrate) navigator.vibrate(50);
            
            // Close menu when clicking elsewhere
            setTimeout(() => {
                document.addEventListener('click', closeContextMenu, { once: true });
                document.addEventListener('touchstart', closeContextMenu, { once: true });
            }, 10);
        }
        
        // Long-press handling for mobile
        let longPressTimer = null;
        let longPressTriggered = false;
        
        function startLongPress(event, projectId, projectTitle) {
            longPressTriggered = false;
            longPressTimer = setTimeout(() => {
                longPressTriggered = true;
                event.preventDefault();
                // Haptic feedback immediately when long press triggers
                if (navigator.vibrate) navigator.vibrate(30);
                showProjectContextMenu(event, projectId, projectTitle);
            }, 500); // 500ms for long press
        }
        
        function cancelLongPress() {
            if (longPressTimer) {
                clearTimeout(longPressTimer);
                longPressTimer = null;
            }
        }
        
        // Prevent click if long-press was triggered
        document.addEventListener('click', (e) => {
            if (longPressTriggered && e.target.closest('.proj')) {
                e.preventDefault();
                e.stopPropagation();
                longPressTriggered = false;
            }
        }, true);
        
        function closeContextMenu(event) {
            // Don't close if clicking inside the menu
            if (event && event.target.closest('.project-context-menu')) {
                return;
            }
            const menu = document.getElementById('projectContextMenu');
            menu.classList.remove('show');
        }
        
        // Rename project
        function renameProject() {
            closeContextMenu();
            const modal = document.getElementById('renameModal');
            const input = document.getElementById('renameInput');
            input.value = currentProjectTitle || '';
            modal.classList.add('show');
            setTimeout(() => input.focus(), 100);
        }
        
        function closeRenameModal() {
            document.getElementById('renameModal').classList.remove('show');
        }
        
        async function saveProjectRename() {
            let newTitle = document.getElementById('renameInput').value.trim();
            if (!newTitle || !contextMenuProjectId) return;
            
            // Clean the title
            newTitle = newTitle
                .replace(/[\n\r\t]/g, ' ')
                .replace(/\s+/g, ' ')
                .trim();
            
            const { error } = await db
                .from('projects')
                .update({ title: newTitle })
                .eq('id', contextMenuProjectId);
            
            if (error) {
                console.error('Error renaming project:', error);
                alert('Erreur lors du renommage');
                return;
            }
            
            closeRenameModal();
            loadProjectsList(); // Refresh list
            
            // Update header if this project is currently open
            if (currentProjectId === contextMenuProjectId) {
                currentProjectTitle = newTitle;
                updateChatHeader();
            }
        }
        
        // Delete project
        async function deleteProject() {
            closeContextMenu();
            
            if (!confirm('Supprimer ce projet et toutes ses conversations ?')) return;
            
            // Delete messages first (foreign key constraint)
            const { data: chats } = await db
                .from('chats')
                .select('id')
                .eq('project_id', contextMenuProjectId);
            
            for (const chat of chats || []) {
                await db.from('messages').delete().eq('chat_id', chat.id);
            }
            
            // Delete chats
            await db.from('chats').delete().eq('project_id', contextMenuProjectId);
            
            // Delete project
            const { error } = await db
                .from('projects')
                .delete()
                .eq('id', contextMenuProjectId);
            
            if (error) {
                alert('Erreur lors de la suppression');
                return;
            }

            loadProjectsList(); // Refresh list

            // If this project was open, close chat
            if (currentProjectId === contextMenuProjectId) {
                closeChat();
                startNewProject();
            }
        }
        
        // Format time ago
        function formatTimeAgo(date) {
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);
            
            if (diffMins < 1) return ' l\'instant';
            if (diffMins < 60) return `${diffMins} min`;
            if (diffHours < 24) return `${diffHours}h`;
            if (diffDays === 1) return 'Hier';
            if (diffDays < 7) return ['Dim', 'Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam'][date.getDay()];
            return `${date.getDate()} ${['Jan', 'Fv', 'Mar', 'Avr', 'Mai', 'Juin', 'Juil', 'Aot', 'Sep', 'Oct', 'Nov', 'Dc'][date.getMonth()]}`;
        }
        
        // Escape HTML for safety
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        // Escape for JavaScript string attributes (handles single quotes)
        function escapeForJs(text) {
            if (!text) return '';
            return text
                .replace(/\\/g, '\\\\')      // Backslashes first
                .replace(/'/g, "\\'")         // Single quotes
                .replace(/"/g, '\\"')         // Double quotes
                .replace(/`/g, '\\`')         // Backticks
                .replace(/\n/g, ' ')          // Newlines  space
                .replace(/\r/g, '')           // Carriage returns  remove
                .replace(/\t/g, ' ')          // Tabs  space
                .replace(/</g, '&lt;')        // Less than (prevent HTML injection)
                .replace(/>/g, '&gt;');       // Greater than
        }
        // Load a specific project (FIXED: uses separate queries for reliability)
        async function loadProject(projectId) {
            //  INSTANT OPEN: Open chat immediately 
            openingFromProject = true;
            currentProjectId = projectId;
            updateSessionIds(projectId); // Update session IDs for n8n memory
            currentChatId = { assistant: null, copilot: null };
            projectMessageCount = 0;

            // Update URL with project ID (only if not already on this project URL)
            const route = Router.getRoute();
            if (route.user && route.projectId !== projectId) {
                const params = new URLSearchParams();
                params.set('user', route.user);
                params.set('page', 'project');
                params.set('project', projectId);
                history.pushState({ page: 'project', projectId }, '', '/technician/?' + params.toString());
            }
            
            // First, check what chats exist for this project to determine mode
            let initialMode = mode || 'copilot';
            try {
                const { data: projectChats } = await db
                    .from('chats')
                    .select('chat_type')
                    .eq('project_id', projectId);
                
                if (projectChats && projectChats.length > 0) {
                    const chatTypes = projectChats.map(c => c.chat_type);

                    // If project only has assistant, switch to assistant
                    if (chatTypes.includes('assistant') && !chatTypes.includes('copilot')) {
                        initialMode = 'assistant';
                    }
                    // If project only has copilot, switch to copilot
                    else if (chatTypes.includes('copilot') && !chatTypes.includes('assistant')) {
                        initialMode = 'copilot';
                    }
                    // If both, use current mode
                }
            } catch (e) {
                // Could not pre-check chat types
            }
            
            // Open chat view with correct mode
            openChat(initialMode);
            
            // Show loading indicator in chat (preserve TP containers)
            const body = document.getElementById(initialMode + 'Body');
            if (body) {
                clearChatBody(initialMode);
                body.insertAdjacentHTML('beforeend', '<div class="msg" style="text-align:center;padding:40px;color:var(--text-dim);"><div style="margin-bottom:10px;"></div>Chargement...</div>');
            }
            
            try {
                // Step 1: Get project details
                const { data: project, error: projectError } = await db
                    .from('projects')
                    .select('id, title, brand, original_brand, status, created_at, updated_at, extracted_data, completion_status')
                    .eq('id', projectId)
                    .single();
                
                if (projectError || !project) {
                    if (body) { clearChatBody(initialMode); body.insertAdjacentHTML('beforeend', '<div class="msg" style="text-align:center;padding:40px;color:var(--hotline);">Erreur de chargement</div>'); }
                    return;
                }
                
                // Try to load photos separately (column might not exist yet)
                try {
                    const { data: projectWithPhotos } = await db
                        .from('projects')
                        .select('photos')
                        .eq('id', projectId)
                        .single();
                    window.reportPhotos = projectWithPhotos?.photos || [];
                } catch (e) {
                    window.reportPhotos = [];
                }
                
                // Store project title for header
                currentProjectTitle = project.title || 'Sans titre';
                currentProjectTitle = project.title || 'Sans titre';

                //  LOAD extracted_data from project 
                if (project.extracted_data && Object.keys(project.extracted_data).length > 0) {
                    lastReportData = normalizeReportData(project.extracted_data);  // FIX-1: Normalize on load
                    updateDrawerPreview(lastReportData);
                    console.log('[Project]  Loaded extracted_data:', Object.keys(lastReportData).length, 'fields');
                }

                //  INITIALIZE REPORT COMPLETION STATE 
                if (project.completion_status === 'completed') {
                    reportCompletionState.status = REPORT_STATUS.COMPLETED;
                    reportCompletionState.isLocked = true;
                    // Defer locking until DOM is ready
                    setTimeout(() => {
                        lockReportFields();
                        updateReportFooterButtons();
                    }, 500);
                } else {
                    reportCompletionState.status = REPORT_STATUS.IN_PROGRESS;
                    reportCompletionState.isLocked = false;
                    setTimeout(() => {
                        updateReportFooterButtons();
                    }, 500);
                }

                //  FIX: Detect if user selected different brand on main page 
                const projectOriginalBrand = project.brand;
                const userSelectedBrand = brand; // Current global brand from main page selection
                let brandWasChanged = false;
                
                const brandNames = {
                    'mitsubishi': 'Mitsubishi Electric',
                    'daikin': 'Daikin',
                    'carrier': 'Carrier',
                    'lg': 'LG',
                    'samsung': 'Samsung',
                    'panasonic': 'Panasonic',
                    'toshiba': 'Toshiba',
                    'fujitsu': 'Fujitsu',
                    'hitachi': 'Hitachi',
                    'general': 'Multi-marques'
                };
                
                // Check if user selected a different brand on main page
                if (userSelectedBrand && projectOriginalBrand && userSelectedBrand !== projectOriginalBrand) {
                    brandWasChanged = true;

                    // Update project with new brand and store original
                    try {
                        const updateData = { brand: userSelectedBrand };
                        // Only set original_brand if not already set
                        if (!project.original_brand) {
                            updateData.original_brand = projectOriginalBrand;
                        }

                        await db
                            .from('projects')
                            .update(updateData)
                            .eq('id', projectId);
                    } catch (e) {
                        // Failed to update brand
                    }
                    
                    // Keep the user's selected brand (don't override from project)
                    updateBrandUI();
                } else {
                    // Use project's brand as normal
                    if (project.brand) {
                        brand = project.brand;
                        updateBrandUI();
                    }
                }
                //  END FIX 
                
                // Step 2: Get chats for this project (SEPARATE QUERY - fixes nested query issue)
                const { data: chats, error: chatsError } = await db
                    .from('chats')
                    .select('id, chat_type, project_id, started_at')
                    .eq('project_id', projectId);
                
                // Step 3: Load messages for each chat
                for (const chat of chats || []) {
                    
                    currentChatId[chat.chat_type] = chat.id;
                    
                    // Load messages for this chat
                    const { data: messages, error: msgError } = await db
                        .from('messages')
                        .select('*')
                        .eq('chat_id', chat.id)
                        .order('created_at', { ascending: true });
                    
                    if (msgError) {
                        continue;
                    }
                    
                    // Clear existing chat UI (preserve TP containers)
                    chatHistory[chat.chat_type] = [];
                    clearChatBody(chat.chat_type);
                    
                    // Add messages to UI
                    for (const msg of messages || []) {
                        const role = msg.role === 'assistant' ? 'ai' : msg.role;
                        if (role === 'user' || role === 'ai') {
                            // Check if this is an image message
                            if (msg.content_type === 'image' && msg.content.startsWith('data:image')) {
                                // Render as photo
                                const msgId = 'photo-' + Date.now() + '-' + Math.random().toString(36).substr(2, 5);
                                const msgDiv = document.createElement('div');
                                msgDiv.className = 'msg user';
                                msgDiv.id = msgId;
                                
                                // Check if this photo was already added to report
                                const isInReport = window.reportPhotos?.some(p => p.url === msg.content || p.data === msg.content);
                                msgDiv.innerHTML = createPhotoMessageHTML(msgId, chat.chat_type, msg.content, isInReport);
                                msgDiv.dataset.imageData = msg.content;
                                
                                body.appendChild(msgDiv);
                            } else if (msg.content_type === 'ocr') {
                                // Render OCR result message
                                try {
                                    const ocrData = JSON.parse(msg.content);
                                    const sourceImg = findSourceImage(messages, ocrData.sourcePhotoId);
                                    renderOCRMessage(chat.chat_type, ocrData, sourceImg);
                                } catch (e) {
                                    // Error parsing OCR message
                                }
                            } else {
                                // Regular text message
                                // Render persisted thought process for AI messages (collapsed)
                                if (role === 'ai' && msg.thought_process) {
                                    try {
                                        const steps = JSON.parse(msg.thought_process);
                                        if (steps && steps.length > 0) {
                                            renderPersistedThoughtProcess(chat.chat_type, steps, msg.thought_summary);
                                        }
                                    } catch (e) { /* ignore parse errors */ }
                                }
                                const content = role === 'ai' ? parseMarkdown(msg.content) : msg.content;
                                addMsg(chat.chat_type, role, content);
                                
                                //  FIX: Extract REPORT_DATA from loaded AI messages to update drawer 
                                if (role === 'ai' && msg.content.includes('[REPORT_DATA]')) {
                                    try {
                                        const reportDataMatch = msg.content.match(/\[REPORT_DATA\]([\s\S]*?)\[\/REPORT_DATA\]/);
                                        if (reportDataMatch) {
                                            let reportData = JSON.parse(reportDataMatch[1].trim());
                                            reportData = normalizeReportData(reportData);
                                            if (!lastReportData) {
                                                lastReportData = { brand: brand, brand_key: brand, status: 'en_cours', date: new Date().toLocaleDateString('fr-FR') };
                                            }
                                            lastReportData = unifiedMerge(lastReportData, reportData);
                                            updateDrawerPreview(lastReportData);
                                        }
                                    } catch (e) {
                                        // Could not parse saved REPORT_DATA
                                    }
                                }
                            }
                            chatHistory[chat.chat_type].push({ role: msg.role, content: msg.content });
                            projectMessageCount++;
                        }
                    }
                }

                //  ENSURE DRAWER POPULATED AFTER MESSAGES LOAD 
                // Build partial report from chat history if no report data found
                if (!lastReportData || Object.keys(lastReportData).length === 0) {
                    buildPartialReport();
                }
                setTimeout(() => {
                    if (lastReportData && Object.keys(lastReportData).length > 0) {
                        updateDrawerPreview(lastReportData);
                        console.log('[Project]  Drawer refreshed after messages load');
                    }
                }, 150);

                // Update chat header with project name
                updateChatHeader();
                
                //  FIX: Add comprehensive context for existing projects 
                // This ensures the AI knows the brand AND conversation context
                const projectBrandName = brandNames[brand] || brand;
                
                // Build conversation summary from loaded messages
                ['assistant', 'copilot'].forEach(panel => {
                    const history = chatHistory[panel];
                    const userMessages = history.filter(m => m.role === 'user');
                    const aiMessages = history.filter(m => m.role === 'assistant');
                    
                    // Create comprehensive context summary
                    let contextSummary = `[CONTEXTE PROJET EXISTANT]
MARQUE: ${projectBrandName}
PROJET: ${currentProjectTitle || 'Sans titre'}
MESSAGES PRCDENTS: ${history.length} messages (${userMessages.length} utilisateur, ${aiMessages.length} IA)
`;

                    // Add summary of recent conversation topics
                    if (userMessages.length > 0) {
                        contextSummary += `
HISTORIQUE CONVERSATION:
`;
                        // Add last 5 user messages as context
                        const recentUserMsgs = userMessages.slice(-5);
                        recentUserMsgs.forEach((msg, i) => {
                            const truncated = msg.content.length > 100 ? msg.content.substring(0, 100) + '...' : msg.content;
                            contextSummary += `- Utilisateur: "${truncated}"\n`;
                        });
                    }
                    
                    contextSummary += `
INSTRUCTIONS:
- Tu connais DJ la marque: ${projectBrandName}
- Tu connais DJ l'historique ci-dessus
- NE REDEMANDE PAS ces informations
- Continue la conversation naturellement
- Si c'est un rapport (assistant), tu as dj les infos pour le gnrer`;

                    // Insert comprehensive context as FIRST message
                    const existingSystemIndex = history.findIndex(m => m.role === 'system');
                    if (existingSystemIndex >= 0) {
                        history[existingSystemIndex].content = contextSummary;
                    } else {
                        history.unshift({ role: 'system', content: contextSummary });
                    }
                });
                //  END FIX 
                
                // Open chat with the appropriate mode
                const hasAssistant = currentChatId.assistant;
                const defaultMode = hasAssistant ? 'assistant' : 'copilot';
                
                //  FIX: Set flag so openChat knows we're opening an existing project 
                openingFromProject = true;
                //  END FIX 
                
                openChat(defaultMode);
                
                //  FIX: Show brand change message if brand was changed from main page 
                if (brandWasChanged) {
                    const oldBrandName = brandNames[projectOriginalBrand] || projectOriginalBrand;
                    const newBrandName = brandNames[userSelectedBrand] || userSelectedBrand;
                    
                    setTimeout(() => {
                        const confirmMsg = `<p style="color: var(--mode-color);"> Tu as slectionn <strong>${newBrandName}</strong> sur la page d'accueil.</p><p style="font-size: 12px; opacity: 0.8;">Marque du projet: <strong>${oldBrandName}</strong>  <strong>${newBrandName}</strong></p><p style="font-size: 12px; opacity: 0.7;">On continue avec ${newBrandName}.</p>`;
                        addMsg(defaultMode, 'ai', confirmMsg);
                    }, 100);
                }
                //  END FIX 

            } catch (e) {
                // Unexpected error loading project
            }
        }
        
        // Update chat header to show project name
        function updateChatHeader() {
            const panels = ['copilot', 'assistant'];
            
            for (const panel of panels) {
                const projectNameEl = document.getElementById(panel + 'ProjectName');
                const projectSepEl = document.getElementById(panel + 'ProjectSep');
                
                if (currentProjectTitle && currentProjectId) {
                    if (projectNameEl) {
                        projectNameEl.textContent = currentProjectTitle;
                        projectNameEl.style.display = 'block';
                    }
                    if (projectSepEl) {
                        projectSepEl.style.display = 'block';
                    }
                } else {
                    if (projectNameEl) projectNameEl.style.display = 'none';
                    if (projectSepEl) projectSepEl.style.display = 'none';
                }
            }
        }
        
        // Start new project (clear current)
        function startNewProject() {
            currentProjectId = null;
            currentChatId = { assistant: null, copilot: null };
            currentProjectTitle = null;
            projectMessageCount = 0;
            
            // Reset session IDs (will be set when project is created)
            sessionIds = { copilot: null, assistant: null };
            
            // Clear chats
            chatHistory.assistant = [];
            chatHistory.copilot = [];
            
            //  RESET REPORT DATA 
            lastReportData = null;
            window.reportPhotos = [];
            
            // Reset report drawer
            const emptyState = document.getElementById('reportPreviewEmpty');
            const previewContent = document.getElementById('reportPreviewContent');
            const headerProgress = document.getElementById('reportHeaderProgress');
            if (emptyState) emptyState.style.display = '';
            if (previewContent) {
                previewContent.style.display = 'none';
                previewContent.innerHTML = '';
            }
            if (headerProgress) headerProgress.style.display = 'none';
            //  END RESET 
            
            const assistantBody = document.getElementById('assistantBody');
            const copilotBody = document.getElementById('copilotBody');
            
            // Clear bodies (preserve TP containers)
            clearChatBody('assistant');
            clearChatBody('copilot');

            // Reset TP state for new project
            TP.cardCounter = 0;
            TP.currentCardId = { copilot: null, assistant: null };
            TP.expandedState = {};
            TP.s = { copilot: [], assistant: [] };
            TP.isSimpleMode = { copilot: false, assistant: false };

            // Clear project name from header
            updateChatHeader();
            
            // Show welcome message
            setTimeout(() => {
                addMsg(mode, 'ai', '<p>Bonjour ! Comment puis-je vous aider ?</p>');
            }, 300);
        }
        
        // Update brand in UI
        function updateBrandUI() {
            const brandBtn = document.querySelector('.brand-btn .brand-btn-text');
            if (brandBtn) {
                const brandNames = {
                    'mitsubishi': 'Mitsubishi',
                    'daikin': 'Daikin',
                    'carrier': 'Carrier',
                    'lg': 'LG',
                    'samsung': 'Samsung',
                    'panasonic': 'Panasonic',
                    'general': 'Multi-marques'
                };
                brandBtn.textContent = brandNames[brand] || brand;
            }
        }
        
        // 
        // END SUPABASE FUNCTIONS
        // 


        // 
        // RENDER STRUCTURED REPORT - Beautiful Template
        // 
        function renderReport(data) {
            //  STORE FOR PDF EXPORT 
            lastReportData = data;
            
            //  UPDATE DRAWER PREVIEW 
            updateDrawerPreview(data);
            
            // Helper: only show section if it has content
            const has = (val) => val && (Array.isArray(val) ? val.length > 0 : true);
            const esc = (str) => str ? String(str).replace(/</g, '&lt;').replace(/>/g, '&gt;') : '';
            
            // Brand class
            const brandClass = data.brand_key || 'general';
            
            // Status class
            let statusClass = 'en-cours';
            let statusText = 'En cours';
            if (data.status) {
                const s = data.status.toLowerCase();
                if (s.includes('conforme') && !s.includes('non')) {
                    statusClass = 'conforme';
                    statusText = 'Conforme';
                } else if (s.includes('non') || s.includes('refus')) {
                    statusClass = 'non-conforme';
                    statusText = 'Non conforme';
                } else {
                    statusText = data.status;
                }
            }
            
            // Technician initials
            const getInitials = (name) => {
                if (!name) return '??';
                return name.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);
            };
            
            let html = `<div class="rpt">`;
            
            //  HEADER 
            html += `
            <div class="rpt-header">
                <div class="rpt-header-top">
                    <div>
                        <div class="rpt-brand ${brandClass}">${esc(data.brand || 'FixAIR')}</div>
                        <h1 class="rpt-title">Rapport d'intervention</h1>
                    </div>
                    <div class="rpt-status ${statusClass}">
                        <span class="rpt-status-dot"></span>
                        <span class="rpt-status-text">${esc(statusText)}</span>
                    </div>
                </div>
                <div class="rpt-meta">
                    ${data.reference ? `<span>Rf <span class="val">${esc(data.reference)}</span></span>` : ''}
                    ${data.type_intervention ? `<span>Type <span class="val">${esc(data.type_intervention)}</span></span>` : ''}
                    ${data.date ? `<span>Date <span class="val">${esc(data.date)}</span></span>` : ''}
                    ${data.bon_livraison ? `<span>BL <span class="val">${esc(data.bon_livraison)}</span></span>` : ''}
                </div>
            </div>`;
            
            //  MAIN CARD 
            html += `<div class="rpt-card">`;
            
            // 1. RSUM
            if (has(data.resume)) {
                const resumeText = data.resume.replace(/NON CONFORME/gi, '<strong>NON CONFORME</strong>')
                                              .replace(/CONFORME/gi, '<strong>CONFORME</strong>');
                html += `
                <div class="rpt-section">
                    <div class="rpt-label">Rsum</div>
                    <p class="rpt-text">${resumeText}</p>
                </div>`;
            }
            
            // 2. CLIENT + SITE (2 cols)
            if (has(data.client) || has(data.site)) {
                html += `<div class="rpt-section"><div class="rpt-grid">`;
                
                if (has(data.client)) {
                    html += `<div class="rpt-group"><div class="rpt-label">Client</div>`;
                    if (data.client.societe) html += `<div class="rpt-row"><span class="rpt-row-label">Socit</span><span class="rpt-row-value">${esc(data.client.societe)}</span></div>`;
                    if (data.client.contact) html += `<div class="rpt-row"><span class="rpt-row-label">Contact</span><span class="rpt-row-value">${esc(data.client.contact)}</span></div>`;
                    if (data.client.telephone) html += `<div class="rpt-row"><span class="rpt-row-label">Tlphone</span><span class="rpt-row-value">${esc(data.client.telephone)}</span></div>`;
                    if (data.client.dossier) html += `<div class="rpt-row"><span class="rpt-row-label">N Dossier</span><span class="rpt-row-value mono">${esc(data.client.dossier)}</span></div>`;
                    html += `</div>`;
                }
                
                if (has(data.site)) {
                    html += `<div class="rpt-group"><div class="rpt-label">Site d'intervention</div>`;
                    if (data.site.adresse) html += `<div class="rpt-row"><span class="rpt-row-label">Adresse</span><span class="rpt-row-value">${esc(data.site.adresse)}</span></div>`;
                    if (data.site.ville) html += `<div class="rpt-row"><span class="rpt-row-label">Ville</span><span class="rpt-row-value">${esc(data.site.ville)}</span></div>`;
                    if (data.site.batiment) html += `<div class="rpt-row"><span class="rpt-row-label">Btiment</span><span class="rpt-row-value">${esc(data.site.batiment)}</span></div>`;
                    if (data.site.acces) html += `<div class="rpt-row"><span class="rpt-row-label">Accs</span><span class="rpt-row-value">${esc(data.site.acces)}</span></div>`;
                    html += `</div>`;
                }
                
                html += `</div></div>`;
            }
            
            // 3. SYSTME + INTERVENTION (2 cols)
            if (has(data.systeme) || has(data.intervention)) {
                html += `<div class="rpt-section"><div class="rpt-grid">`;
                
                if (has(data.systeme)) {
                    html += `<div class="rpt-group"><div class="rpt-label">Systme</div>`;
                    if (data.systeme.type) html += `<div class="rpt-row"><span class="rpt-row-label">Type</span><span class="rpt-row-value">${esc(data.systeme.type)}</span></div>`;
                    if (data.systeme.modele) html += `<div class="rpt-row"><span class="rpt-row-label">Modle UE</span><span class="rpt-row-value mono">${esc(data.systeme.modele)}</span></div>`;
                    if (data.systeme.serie) html += `<div class="rpt-row"><span class="rpt-row-label">N Srie</span><span class="rpt-row-value mono">${esc(data.systeme.serie)}</span></div>`;
                    if (data.systeme.fluide) html += `<div class="rpt-row"><span class="rpt-row-label">Fluide</span><span class="rpt-row-value">${esc(data.systeme.fluide)}</span></div>`;
                    html += `</div>`;
                }
                
                if (has(data.intervention)) {
                    html += `<div class="rpt-group"><div class="rpt-label">Intervention</div>`;
                    if (data.intervention.type) html += `<div class="rpt-row"><span class="rpt-row-label">Type</span><span class="rpt-row-value">${esc(data.intervention.type)}</span></div>`;
                    if (data.intervention.statut) {
                        const statClass = data.intervention.statut.toLowerCase().includes('refus') ? 'error' : '';
                        html += `<div class="rpt-row"><span class="rpt-row-label">Statut</span><span class="rpt-row-value ${statClass}">${esc(data.intervention.statut)}</span></div>`;
                    }
                    if (data.intervention.diagnostic) html += `<div class="rpt-row"><span class="rpt-row-label">Diagnostic</span><span class="rpt-row-value">${esc(data.intervention.diagnostic)}</span></div>`;
                    if (data.intervention.probleme) html += `<div class="rpt-row"><span class="rpt-row-label">Problme</span><span class="rpt-row-value">${esc(data.intervention.probleme)}</span></div>`;
                    html += `</div>`;
                }
                
                html += `</div></div>`;
            }
            
            // 4. ADRESSAGE - Units Intrieures (full width table)
            if (has(data.unites_interieures)) {
                html += `
                <div class="rpt-section">
                    <div class="rpt-label">Adressage - Units Intrieures</div>
                    <div class="rpt-table">
                        <div class="rpt-th rpt-cols-5">
                            <span>Adr</span><span>Modle</span><span>Zone</span><span>kW</span><span>tat</span>
                        </div>`;
                data.unites_interieures.forEach(ui => {
                    const statusCls = ui.etat === 'OK' ? 'ok' : (ui.etat && ui.etat !== 'N/A' ? 'err' : 'warn');
                    html += `
                        <div class="rpt-tr rpt-cols-5">
                            <span class="mono">${esc(ui.adresse || '')}</span>
                            <span>${esc(ui.modele || '')}</span>
                            <span>${esc(ui.zone || '')}</span>
                            <span>${esc(ui.puissance || '')}</span>
                            <span class="${statusCls}">${esc(ui.etat || '')}</span>
                        </div>`;
                });
                html += `</div></div>`;
            }
            
            // 4b. CODES DFAUT (separate table)
            if (has(data.codes_defaut)) {
                html += `
                <div class="rpt-section">
                    <div class="rpt-label">Codes Dfaut</div>
                    <div class="rpt-table">
                        <div class="rpt-th rpt-cols-3">
                            <span>Code</span><span>Description</span><span>UI</span>
                        </div>`;
                data.codes_defaut.forEach(cd => {
                    html += `
                        <div class="rpt-tr rpt-cols-3">
                            <span class="mono">${esc(cd.code || '')}</span>
                            <span>${esc(cd.description || '')}</span>
                            <span>${esc(cd.ui || '')}</span>
                        </div>`;
                });
                html += `</div></div>`;
            }
            
            // 5. TRAVAUX EFFECTUS
            if (has(data.travaux_effectues)) {
                html += `
                <div class="rpt-section">
                    <div class="rpt-label">Travaux effectus</div>
                    <div class="rpt-list">`;
                data.travaux_effectues.forEach(t => {
                    const iconClass = t.status === 'done' ? 'done' : (t.status === 'error' ? 'error' : 'pending');
                    const iconChar = t.status === 'done' ? '' : (t.status === 'error' ? '' : '');
                    html += `
                        <div class="rpt-item">
                            <span class="rpt-icon ${iconClass}">${iconChar}</span>
                            <span class="rpt-item-text">${esc(t.texte || t.text || t)}</span>
                        </div>`;
                });
                html += `</div></div>`;
            }
            
            // 6. MESURES (only if we have data)
            if (has(data.mesures)) {
                html += `
                <div class="rpt-section">
                    <div class="rpt-label">Mesures</div>
                    <div class="rpt-measures">`;
                data.mesures.forEach(m => {
                    const valClass = m.status === 'ok' ? 'ok' : (m.status === 'error' ? 'error' : 'neutral');
                    const noteClass = m.status === 'ok' ? 'ok' : (m.status === 'error' ? 'error' : '');
                    html += `
                        <div class="rpt-measure">
                            <div class="rpt-measure-info">
                                <div class="rpt-measure-name">${esc(m.label || m.nom)}</div>
                                ${m.note ? `<div class="rpt-measure-note ${noteClass}">${esc(m.note)}</div>` : ''}
                            </div>
                            <div class="rpt-measure-val ${valClass}">${esc(m.valeur || m.value)}</div>
                        </div>`;
                });
                html += `</div></div>`;
            }
            
            // 7. PHOTOS (only if we have them - merge AI photos + manually added)
            const aiPhotos = data.photos || [];
            const manualPhotos = window.reportPhotos || [];
            const allPhotos = [...aiPhotos, ...manualPhotos];
            
            if (allPhotos.length > 0) {
                html += `
                <div class="rpt-section">
                    <div class="rpt-label">Photos & Documents</div>
                    <div class="rpt-photos">`;
                allPhotos.forEach((p, i) => {
                    const fullClass = p.full ? 'full' : '';
                    const photoUrl = p.url || p.data; // Support both url and base64 data
                    if (photoUrl) {
                        html += `
                            <div class="rpt-photo ${fullClass}">
                                <img src="${esc(photoUrl)}" alt="${esc(p.caption || '')}">
                                ${p.caption ? `<div class="rpt-photo-cap">${esc(p.caption)}</div>` : ''}
                            </div>`;
                    } else {
                        html += `
                            <div class="rpt-photo ${fullClass}" style="display:flex;align-items:center;justify-content:center;color:var(--text-dim);font-size:11px;">
                                Photo ${i + 1}${p.caption ? ': ' + esc(p.caption) : ''}
                            </div>`;
                    }
                });
                html += `</div></div>`;
            }
            
            // 8. RSULTAT + RSERVES
            if (has(data.resultat)) {
                const r = data.resultat;
                const resClass = r.status === 'resolu' ? 'ok' : 'err';
                const resText = r.status === 'resolu' ? 'Rsolu' : 'Non rsolu';
                
                html += `
                <div class="rpt-section">
                    <div class="rpt-label">Rsultat</div>
                    <div class="rpt-result">
                        <div class="rpt-result-status">
                            <span class="${resClass}">${resText}</span>
                            ${r.label ? `<span class="lbl">  ${esc(r.label)}</span>` : ''}
                        </div>
                        ${r.description ? `<div class="rpt-result-desc">${esc(r.description)}</div>` : ''}
                    </div>`;
                
                // Alerts/Rserves
                if (has(data.reserves) || has(data.alerts)) {
                    const alerts = data.reserves || data.alerts;
                    html += `<div class="rpt-alerts">`;
                    alerts.forEach(a => {
                        const alertClass = a.type === 'warning' ? 'warning' : (a.type === 'info' ? 'info' : (a.type === 'success' ? 'success' : ''));
                        html += `
                            <div class="rpt-alert ${alertClass}">
                                <div class="rpt-alert-title">${esc(a.titre || a.title)}</div>
                                <div class="rpt-alert-text">${esc(a.texte || a.text)}</div>
                            </div>`;
                    });
                    html += `</div>`;
                }
                
                html += `</div>`;
            }
            
            // 9. TRAVAUX  PRVOIR
            if (has(data.travaux_prevoir)) {
                html += `
                <div class="rpt-section">
                    <div class="rpt-label">Travaux  prvoir</div>
                    <div class="rpt-list">`;
                data.travaux_prevoir.forEach((t, i) => {
                    html += `
                        <div class="rpt-item">
                            <span class="rpt-icon num">${i + 1}</span>
                            <span class="rpt-item-text">${esc(t.texte || t.text || t)}</span>
                        </div>`;
                });
                html += `</div></div>`;
            }
            
            // 10. SIGNATURES
            if (has(data.signatures) || has(data.technicien)) {
                html += `
                <div class="rpt-section">
                    <div class="rpt-label">Signatures</div>
                    <div class="rpt-sigs">
                        <div class="rpt-sig">
                            <div class="rpt-sig-label">Technicien</div>
                            <div class="rpt-sig-line"></div>
                            <div class="rpt-sig-name">${esc(data.technicien?.nom || '')}</div>
                            <div class="rpt-sig-date">${esc(data.date || '')} ${data.technicien?.heure_depart ? ' ' + data.technicien.heure_depart : ''}</div>
                        </div>
                        <div class="rpt-sig">
                            <div class="rpt-sig-label">Client</div>
                            <div class="rpt-sig-line"></div>
                            <div class="rpt-sig-name">${esc(data.client?.contact || '')}</div>
                            <div class="rpt-sig-date">${esc(data.date || '')}</div>
                        </div>
                    </div>
                </div>`;
            }
            
            // 11. FOOTER
            if (has(data.technicien)) {
                const tech = data.technicien;
                html += `
                <div class="rpt-footer">
                    <div class="rpt-tech">
                        <div class="rpt-avatar">${getInitials(tech.nom)}</div>
                        <div>
                            <div class="rpt-tech-name">${esc(tech.nom)}</div>
                            <div class="rpt-tech-time">${tech.heure_arrivee ? 'Arrive ' + tech.heure_arrivee : ''} ${tech.heure_depart ? ' Dpart ' + tech.heure_depart : ''}</div>
                        </div>
                    </div>
                    <div class="rpt-actions">
                        <button class="rpt-btn secondary" onclick="shareReport()">Partager</button>
                        <button class="rpt-btn primary" onclick="exportReportPDF()"> Exporter</button>
                    </div>
                </div>`;
            }
            
            html += `</div></div>`; // Close rpt-card and rpt
            
            return html;
        }
        
        // 
        // PDF EXPORT - Professional Report Generation
        // 
        
        // Store last report data for PDF export
        let lastReportData = null;
        let extractedDataSaveTimeout = null;  // Debounce for extracted_data auto-save

        // Brand colors for PDF
        const brandColorsPDF = {
            mitsubishi: { primary: '#E60012', secondary: '#1a1a2e' },
            daikin: { primary: '#10B981', secondary: '#1a1a2e' },
            carrier: { primary: '#3B82F6', secondary: '#1a1a2e' },
            lg: { primary: '#A50034', secondary: '#1a1a2e' },
            samsung: { primary: '#1428A0', secondary: '#1a1a2e' },
            panasonic: { primary: '#0F4C81', secondary: '#1a1a2e' },
            toshiba: { primary: '#FF0000', secondary: '#1a1a2e' },
            fujitsu: { primary: '#E4002B', secondary: '#1a1a2e' },
            hitachi: { primary: '#E60012', secondary: '#1a1a2e' },
            general: { primary: '#EA580C', secondary: '#1a1a2e' }
        };
        
        // Share report function - DISABLED (Premium feature)
        function shareReport() {
            toast('Partage disponible dans la version Pro');
        }
        
        // Generate plain text version of report
        function generateReportText(data) {
            let text = `RAPPORT D'INTERVENTION ${data.brand || 'FixAIR'}\n`;
            text += `\n\n`;
            
            if (data.reference) text += `Rf: ${data.reference}\n`;
            if (data.date) text += `Date: ${data.date}\n`;
            if (data.type_intervention) text += `Type: ${data.type_intervention}\n`;
            text += `\n`;
            
            if (data.resume) text += `RSUM:\n${data.resume}\n\n`;
            
            if (data.client) {
                text += `CLIENT:\n`;
                if (data.client.societe) text += `  Socit: ${data.client.societe}\n`;
                if (data.client.contact) text += `  Contact: ${data.client.contact}\n`;
                if (data.client.telephone) text += `  Tl: ${data.client.telephone}\n`;
                text += `\n`;
            }
            
            if (data.site) {
                text += `SITE:\n`;
                if (data.site.adresse) text += `  ${data.site.adresse}\n`;
                if (data.site.ville) text += `  ${data.site.ville}\n`;
                text += `\n`;
            }
            
            if (data.systeme) {
                text += `SYSTME:\n`;
                if (data.systeme.type) text += `  Type: ${data.systeme.type}\n`;
                if (data.systeme.modele) text += `  Modle: ${data.systeme.modele}\n`;
                if (data.systeme.serie) text += `  N Srie: ${data.systeme.serie}\n`;
                if (data.systeme.fluide) text += `  Fluide: ${data.systeme.fluide}\n`;
                text += `\n`;
            }
            
            if (data.travaux_effectues && data.travaux_effectues.length > 0) {
                text += `TRAVAUX EFFECTUS:\n`;
                data.travaux_effectues.forEach(t => {
                    const icon = t.status === 'done' ? '' : (t.status === 'error' ? '' : '');
                    text += `  ${icon} ${t.texte}\n`;
                });
                text += `\n`;
            }
            
            if (data.resultat) {
                text += `RSULTAT: ${data.resultat.label || (data.resultat.status === 'resolu' ? 'Rsolu' : 'Non rsolu')}\n`;
            }
            
            text += `\n\n`;
            text += `Gnr par FixAIR - ${new Date().toLocaleDateString('fr-FR')}\n`;
            
            return text;
        }
        
        // 
        // EXPORT FUNCTIONS - Word (.docx) + PDF
        // 
        
        // Main export function - shows export menu
        function exportReportPDF() {
            exportReport('word');
        }
        
        // Show export format selection menu
        function showExportMenu() {
            // Create modal for export options
            const modal = document.createElement('div');
            modal.className = 'export-modal';
            modal.innerHTML = `
                <div class="export-modal-content">
                    <div class="export-modal-header">
                        <h3>Exporter le rapport</h3>
                        <button class="export-modal-close" onclick="this.closest('.export-modal').remove()"></button>
                    </div>
                    <div class="export-options">
                        <button class="export-option primary" onclick="exportReport('word'); this.closest('.export-modal').remove();">
                            <span class="export-icon"></span>
                            <span class="export-label">
                                <strong>Word (.docx)</strong>
                                <small>Rapport professionnel</small>
                            </span>
                        </button>
                        <button class="export-option secondary" onclick="exportReport('pdf'); this.closest('.export-modal').remove();">
                            <span class="export-icon"></span>
                            <span class="export-label">
                                <strong>PDF</strong>
                                <small>Format fixe</small>
                            </span>
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);

            // Close on backdrop click
            modal.addEventListener('click', (e) => {
                if (e.target === modal) modal.remove();
            });
        }
        
        // Export report in specified format
        async function exportReport(format) {
            const data = collectReportData();
            if (!data) {
                toast('Aucun rapport  exporter');
                return;
            }

            if (format === 'word') {
                await generateWord(data);
            } else {
                await generatePDF(data);
            }
        }
        
        // Collect all report data from lastReportData + photos + signatures
        function collectReportData() {
            if (!lastReportData) return null;

            const data = normalizeReportData({ ...lastReportData });  // FIX-1: Normalize before export
            
            // Add photos from global
            if (window.reportPhotos && window.reportPhotos.length > 0) {
                data.photos = window.reportPhotos;
            }
            
            // Collect signatures from drawer if present (support both old and v12.5 selectors)
            const clientSig = document.querySelector('.signature-area[data-type="client"] img') || 
                             document.querySelector('#sigAreaClient img');
            const techSig = document.querySelector('.signature-area[data-type="technicien"] img') ||
                           document.querySelector('#sigAreaTech img');
            
            // Also get signature names from v12.5 inputs
            const clientSigName = document.getElementById('sigNameClient')?.value;
            const techSigName = document.getElementById('sigNameTech')?.value;
            
            if (clientSig || techSig || clientSigName || techSigName) {
                data.signatures = data.signatures || {};
                if (clientSig) data.signatures.client = clientSig.src;
                if (techSig) data.signatures.technicien = techSig.src;
                if (clientSigName) data.signatures.nom_client = clientSigName;
                if (techSigName) data.signatures.nom_technicien = techSigName;
            }

            // R3-Fix2: Clean duplicate prefixes in resultat before export
            if (data && data.resultat) {
                ['status', 'label', 'description', 'conclusion'].forEach(k => {
                    if (data.resultat[k] && typeof data.resultat[k] === 'string') {
                        data.resultat[k] = data.resultat[k].replace(/^(Statut|Status|Conclusion|Description)\s*:\s*/i, '').trim();
                    }
                });
            }

            return data;
        }
        
        // 
        // WORD EXPORT - Professional .docx Generation v2.0
        // 
        
        // FixAIR Logo as base64 PNG (logo-email.png)
        const FIXAIR_LOGO_BASE64 = 'iVBORw0KGgoAAAANSUhEUgAAAMIAAAAoCAYAAACsPiXVAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAdbSURBVHgB7Z1dbttGEMdnKKoN2gLVDcqcICrgGHkLdYLYJ4j8VjgGLJ/A8gliA0rQt8gnsHMCKy9FECeIfILqCHqIi0AUtZ1ZUrY+dklKMimR2R8M2ebyQyL3vzszuztCSIBouBXwvtVBWM8BRZU2ObAK5dJjPP3Ym7rG/vYxnbsenrsHAk7w7XUbDIYMsKMKxcEzF4R/DN6tC4D0IyANxKunr1luE5scutw7Escf+PbTCRgMKYOqjeKvZw6U/Hf0pwtpMNEjiIMtEhteaffFUg1bHzvwgyAadO8HVgXAq0LaWNjH1qdLiHw/1QoMyjtzBT95l3ja7Uceu/+0DuuAPhe99MF+1MXTTj/JIXM9QtALDC+oBlYgEyyXrqovRt+BAiPNzsHtDiCZneDvgOdX6DNDJgjRo9dIIcD3R5WwUZzhUYdeoisZ9eqwDgTXJ7qH3i1bGx2qXudxZvaUEMSr7ZdkCrU1HUU6iFE/8nojKyNBZksggP8OyfdqAHKjM4JM7/uPg0u31SVBHEf5nXdCoG6MumLRjjwlQodeb+iZdcGSrclSTDnKSOeKcj3KGN1i5RC61yyAZiAAU/kzYux3voCfrKPZYI0UgvQJ0L/QnkIKQJxg63MHHhg+J/kJJ+QnHM8X4snsG84zQfTtlgIDUDcCWBMo2Pyski9Wm6xblnwt+YegC4kinGHrupaGCO4u0frcpF5hT/YObHcGwjsiR64JBUE2Nt4tBwXqYFg39Cz8CxkICLHlAwK/odydW+SMKmNou7WhgIQ9AYvAidiNG4Bz8hU6YJe7D90TygjOupzXSTKKAkpTH4VLbT018sJR7FIFr8xWyBH/Y4Plu+pTYa9ILfJa8W7Z7HQ0pSQAcQb2b6dJQ32GeKhhZeuiSw39JdhegwaDDxW7NShK+p6FSULAF0G4afZM1h5sGHLMYYSOdocEse3lrru9AyOhjl5ZpV5UCyf2t7jVcZWFbALapb0i+UGbBv4t7y1V+K2+0g/lAWMAEoK62+hu5CCWPexSd8bOpnqwySsfkt1Xe0gxyIosRFPt22KP+tSa9tggCNFUFmZodhoCP5RCqDRWM9couewrWOSkzlcqhA+wgcgKXvZqpGxdSJXtvqtJJ2gVpAgQm+pSEkHZqkW25sqBKAgDEEYEmYNCPV3H+7munmsURG8kpCL99Ie0Kc+bDWFrv0vvq02/XyqOCsXwbHcVk2NVEQRTR1QmkfS9GmDInCBU/7SraPyfqIUgSr2J/1zYQPDNdZ3EwH9qxOBfzcaKk7JyTyBPgi+V2+lYMKwPgTf0Mi0EHDkW5BgWA/061xQ7oRgcWICHEEFomtUVRW3jGK8ZhN7cNgH5FgIjxYCjM03xQmKIEUE3UU/ADEuu+gLlMzBsHiSO3AuBwdaXhtYRSiiGeBH8soCZZbmKc/Tw7T9dMKybJ6qNNsRBYT5IHYrRCziEFZDhsYMtUMaK78WgrMzJRLDAYJdQ3GwBN2BYP0KoQu83sULIIswXLgRaSQjMMmIIFwY1NWdcXATyMKjMzai1wPQGayZcKOTMl2CnEKbRJHIC3wJmkpxMqNx/SREwAubHMXD5aeuG1ZHzvRBUDWQf7EHxhMAsIQbaf7QL9yuuzpcWgWEzGXzjwU1HUSKn5RRSCEwCMXwNFiON9/9ySS15jSNQHIkyIigGbHbTeNNX8gF3FMV9GrSVdSTeWc4xMT4Dd5VXJIZaOFNxPGMx9VHfRcc2HoSh/zukk4RkaVK9D8MRT8N+DqNhXbv+HvFs7C8WWgjMomLIBM//Fwx8H9LLlMJI4WtWAs7M9yqsaTTF0G6DPuPCWAxVMPwonGPreqrnL7wQwtAsTxyMmpHKYvgqs3gYig33BMHUnCkKLYQJETgJj2gbMRQUXgSFojbbE4wprI+wuAjujmQxAL75dA6GvNMjAbynZ3oZl3yikEKIFQFnzLBGfRAWO2sKkyllMZRLjyFrvCGFD/E1bBLlX2ns5vvyi6gGnBUQLzSrLOn5wi6ZQYmCIIUTQpC9wNcvlicRjLOd0b7cYmj8BxLD/raTRhLidUzFps/a37RUSuFYzUrjNdTo1aA0ulKIIQiCHGzvxeV3ZQrlI4QpPHQ9QV/aiBMp/2TIVMg1x+qHgaIp09UbNha5ON/nxU7YUxRXQIiLJH5fYYRwLwLl4Al3k8okZUYM+SdGDJAkCFIIISQSQcSAmSzzS39qb6QRw8azqhhyLwT54VYQwZjYG2nEsPHIZ1geUIOmm/Iu/T7lM8y1EAKFcwbv1UQwxogh/9yl/NGJQfMMcyuEexEoWVgEY4wY8k9s/ivFM8ylEOT3C6QggjFGDPmHxUChb15joh4LmnmGuRNCsL4YTjXFK4tgTCIxyC9BNGwykSl/JsRgh9+CM83Iz35Riup9wPep9yGT8QKn+lbtC/ztS0cPOZ2axSAHbGxN6kaAKq+Dnfs6IkR6DzNLM6eTpmUPj6SD1ZnaJqxeomMTPJvEx62hbslkcAdbPfrr+XyhcKnsw/+RtMYcIVWA+AAAAABJRU5ErkJggg==';

        async function generateWord(data) {
            try {
                toast('Gnration du document Word...');

                const { Document, Packer, Paragraph, TextRun, Table, TableRow, TableCell,
                        WidthType, AlignmentType, BorderStyle, HeadingLevel, Header, Footer,
                        ImageRun, PageBreak, ShadingType, TableLayoutType,
                        VerticalAlign, convertInchesToTwip, PageNumber } = window.docx;

                //  DESIGN CONSTANTS 
                const CORAL = 'E85D4A';
                const DARK = '2D3436';
                const TEAL = '2D5F5D';
                const GRAY = '888888';
                const BODY = '333333';
                const TBL_BORDER_COLOR = 'CCCCCC';
                const TBL_ALT = 'F5F5F5';

                // Helper: Convert base64 to Uint8Array
                const b64toU8 = (base64) => {
                    const raw = atob(base64.replace(/^data:image\/\w+;base64,/, ''));
                    const arr = new Uint8Array(raw.length);
                    for (let i = 0; i < raw.length; i++) arr[i] = raw.charCodeAt(i);
                    return arr;
                };

                const logoBytes = b64toU8(FIXAIR_LOGO_BASE64);
                const noBorder = { style: BorderStyle.NONE };
                const noBorders = { top: noBorder, bottom: noBorder, left: noBorder, right: noBorder };
                const tblBorder = { style: BorderStyle.SINGLE, size: 1, color: TBL_BORDER_COLOR };

                //  DATA MAPPING 
                const subtitle = (data.type_intervention || 'DIAGNOSTIC').toUpperCase();
                const brand = (data.marque || data.equipement?.marque || data.brand || '').toUpperCase();
                const customerName = data.client?.nom || data.nom_client || data.client?.societe || '';
                const customerAddress = data.client?.adresse || data.adresse || [data.site?.adresse, data.site?.ville].filter(Boolean).join(', ') || '';
                const reference = data.reference || data.numero_rapport || '';
                const dateStr = data.date || new Date().toLocaleDateString('fr-FR');
                const rawTechName = data.technicien?.nom || data.nom_technicien || data.technician_name || '';
                const techName = (rawTechName === 'FixAIR Assistant') ? '' : rawTechName;
                const companyName = data.technicien?.entreprise || data.entreprise || data.company_name || '';
                const companyAddr = data.technicien?.adresse || data.adresse || '';

                //  HELPERS 
                let sectionCounter = 0;

                // Section heading: numbered, bold 14pt, teal, no border
                const sectionHeading = (text) => {
                    sectionCounter++;
                    return new Paragraph({
                        children: [new TextRun({ text: `${sectionCounter}. ${text.toUpperCase()}`, bold: true, size: 28, font: 'Calibri', color: TEAL })],
                        spacing: { before: 600, after: 200 }
                    });
                };

                // Subsection heading: bold 12pt, teal, underlined
                const subsectionHeading = (prefix, text) => new Paragraph({
                    children: [new TextRun({ text: `${prefix} ${text}`, bold: true, size: 24, font: 'Calibri', color: TEAL, underline: {} })],
                    spacing: { before: 280, after: 120 }
                });

                // Sub-subsection heading: bold 11pt, teal, no underline
                const subsubHeading = (text) => new Paragraph({
                    children: [new TextRun({ text: text, bold: true, size: 22, font: 'Calibri', color: TEAL })],
                    spacing: { before: 240, after: 80 }
                });

                // Body text: 10.5pt, #333333, 1.3 line spacing
                const bodyText = (text) => {
                    if (!text) return null;
                    return new Paragraph({
                        children: [new TextRun({ text: String(text), size: 21, font: 'Calibri', color: BODY })],
                        spacing: { after: 120, line: 312 }
                    });
                };

                // Bullet with bold keyword + colon + regular text
                const bulletItem = (keyword, description) => new Paragraph({
                    children: [
                        new TextRun({ text: keyword + ' : ', bold: true, size: 21, font: 'Calibri', color: BODY }),
                        new TextRun({ text: String(description || ''), size: 21, font: 'Calibri', color: BODY })
                    ],
                    spacing: { after: 120, line: 312 },
                    bullet: { level: 0 }
                });

                // Key-value as bullet
                const kvRow = (label, value) => {
                    if (!value) return null;
                    return bulletItem(label, String(value));
                };

                // Professional table with teal headers
                const createTable = (headers, rows) => {
                    const headerRow = new TableRow({
                        children: headers.map(h => new TableCell({
                            children: [new Paragraph({
                                children: [new TextRun({ text: h, bold: true, size: 20, font: 'Calibri', color: 'FFFFFF' })],
                                alignment: AlignmentType.LEFT
                            })],
                            shading: { fill: TEAL, type: ShadingType.CLEAR },
                            borders: { top: tblBorder, bottom: tblBorder, left: tblBorder, right: tblBorder },
                            margins: { top: 80, bottom: 80, left: 120, right: 120 }
                        })),
                        tableHeader: true
                    });

                    const dataRows = rows.map((row, idx) => new TableRow({
                        children: row.map(cell => new TableCell({
                            children: [new Paragraph({
                                children: [new TextRun({ text: String(cell || ''), size: 21, font: 'Calibri', color: BODY })]
                            })],
                            borders: { top: tblBorder, bottom: tblBorder, left: tblBorder, right: tblBorder },
                            margins: { top: 60, bottom: 60, left: 120, right: 120 },
                            shading: idx % 2 === 1 ? { fill: TBL_ALT, type: ShadingType.CLEAR } : undefined
                        }))
                    }));

                    return new Table({
                        rows: [headerRow, ...dataRows],
                        width: { size: 100, type: WidthType.PERCENTAGE },
                        layout: TableLayoutType.FIXED
                    });
                };

                // Two-column info box
                const infoBox = (leftItems, rightItems) => {
                    const formatItems = (items) => items.filter(Boolean).map(item =>
                        new Paragraph({
                            children: [
                                new TextRun({ text: item.label + ' : ', bold: true, size: 21, font: 'Calibri', color: TEAL }),
                                new TextRun({ text: String(item.value || ''), size: 21, font: 'Calibri', color: BODY })
                            ],
                            spacing: { after: 80, line: 312 }
                        })
                    );

                    const left = formatItems(leftItems);
                    const right = formatItems(rightItems);

                    return new Table({
                        rows: [new TableRow({
                            children: [
                                new TableCell({
                                    children: left.length ? left : [new Paragraph({})],
                                    borders: { top: tblBorder, bottom: tblBorder, left: tblBorder, right: tblBorder },
                                    margins: { top: 120, bottom: 120, left: 160, right: 160 },
                                    width: { size: 50, type: WidthType.PERCENTAGE }
                                }),
                                new TableCell({
                                    children: right.length ? right : [new Paragraph({})],
                                    borders: { top: tblBorder, bottom: tblBorder, left: tblBorder, right: tblBorder },
                                    margins: { top: 120, bottom: 120, left: 160, right: 160 },
                                    width: { size: 50, type: WidthType.PERCENTAGE }
                                })
                            ]
                        })],
                        width: { size: 100, type: WidthType.PERCENTAGE }
                    });
                };

                // 
                //  SECTION 1: COVER PAGE 
                // 
                const coverChildren = [];

                // Top spacer
                coverChildren.push(new Paragraph({ spacing: { before: 2400 } }));

                // Title: RAPPORT D'INTERVENTION  28pt bold charcoal centered
                coverChildren.push(new Paragraph({
                    children: [new TextRun({ text: "RAPPORT D'INTERVENTION", bold: true, size: 56, font: 'Calibri', color: DARK })],
                    alignment: AlignmentType.CENTER,
                    spacing: { after: 200 }
                }));

                // Subtitle: Type d'intervention  22pt bold coral centered
                coverChildren.push(new Paragraph({
                    children: [new TextRun({ text: subtitle, bold: true, size: 44, font: 'Calibri', color: CORAL })],
                    alignment: AlignmentType.CENTER,
                    spacing: { after: 150 }
                }));

                // Brand  14pt bold charcoal centered
                if (brand) {
                    coverChildren.push(new Paragraph({
                        children: [new TextRun({ text: brand, bold: true, size: 28, font: 'Calibri', color: DARK })],
                        alignment: AlignmentType.CENTER,
                        spacing: { after: 300 }
                    }));
                }

                // Customer box  bordered rectangle, centered
                const boxBorder = { style: BorderStyle.SINGLE, size: 2, color: DARK };
                const customerBoxContent = [];

                if (customerName) {
                    customerBoxContent.push(new Paragraph({
                        children: [new TextRun({ text: customerName, bold: true, size: 36, font: 'Calibri', color: DARK })],
                        alignment: AlignmentType.CENTER,
                        spacing: { after: 80 }
                    }));
                }
                if (customerAddress) {
                    customerBoxContent.push(new Paragraph({
                        children: [new TextRun({ text: customerAddress, size: 24, font: 'Calibri', color: BODY })],
                        alignment: AlignmentType.CENTER,
                        spacing: { after: 120 }
                    }));
                }
                if (reference || dateStr) {
                    customerBoxContent.push(new Paragraph({
                        children: [new TextRun({ text: `Rf: ${reference} | ${dateStr}`, italics: true, size: 22, font: 'Calibri', color: GRAY })],
                        alignment: AlignmentType.CENTER
                    }));
                }

                if (customerBoxContent.length > 0) {
                    coverChildren.push(new Table({
                        rows: [new TableRow({
                            children: [new TableCell({
                                children: customerBoxContent,
                                borders: { top: boxBorder, bottom: boxBorder, left: boxBorder, right: boxBorder },
                                margins: { top: 200, bottom: 200, left: 300, right: 300 }
                            })]
                        })],
                        width: { size: 70, type: WidthType.PERCENTAGE },
                        alignment: AlignmentType.CENTER
                    }));
                }

                // Spacer before technician  push "Prpar par:" toward bottom
                coverChildren.push(new Paragraph({ spacing: { before: 3600 } }));

                // Technician: "Prpar par:" italic + name bold, left-aligned
                coverChildren.push(new Paragraph({
                    children: [
                        new TextRun({ text: 'Prpar par: ', italics: true, size: 22, font: 'Calibri', color: BODY }),
                        new TextRun({ text: techName, bold: true, size: 22, font: 'Calibri', color: BODY })
                    ],
                    alignment: AlignmentType.LEFT
                }));

                // Cover header: logo left, brand|ref|date right
                const noTableBorders = { top: noBorder, bottom: noBorder, left: noBorder, right: noBorder, insideHorizontal: noBorder, insideVertical: noBorder };
                const coverHeader = new Header({
                    children: [new Table({
                        rows: [new TableRow({
                            children: [
                                new TableCell({
                                    children: [new Paragraph({
                                        children: [new ImageRun({
                                            data: logoBytes,
                                            transformation: { width: 110, height: 22 }
                                        })]
                                    })],
                                    borders: noBorders,
                                    width: { size: 40, type: WidthType.PERCENTAGE }
                                }),
                                new TableCell({
                                    children: [new Paragraph({
                                        children: [new TextRun({ text: [brand, `Rf: ${reference}`, dateStr].filter(Boolean).join(' | '), size: 18, font: 'Calibri', color: GRAY })],
                                        alignment: AlignmentType.RIGHT
                                    })],
                                    borders: noBorders,
                                    width: { size: 60, type: WidthType.PERCENTAGE },
                                    verticalAlign: VerticalAlign.CENTER
                                })
                            ]
                        })],
                        borders: noTableBorders,
                        width: { size: 100, type: WidthType.PERCENTAGE }
                    })]
                });

                // Cover footer: company name + address
                const coverFooterText = [companyName, companyAddr].filter(Boolean).join(', ');
                const coverFooter = new Footer({
                    children: [
                        new Paragraph({
                            children: [new TextRun({ text: coverFooterText, size: 20, font: 'Calibri', color: GRAY })],
                            alignment: AlignmentType.LEFT,
                            border: { top: { style: BorderStyle.SINGLE, size: 1, color: 'CCCCCC', space: 4 } }
                        })
                    ]
                });

                // 
                //  SECTION 2: CONTENT PAGES 
                // 
                const contentChildren = [];

                // Content header: small logo left, brand|ref|date right
                const contentHeader = new Header({
                    children: [new Table({
                        rows: [new TableRow({
                            children: [
                                new TableCell({
                                    children: [new Paragraph({
                                        children: [new ImageRun({
                                            data: logoBytes,
                                            transformation: { width: 85, height: 17 }
                                        })]
                                    })],
                                    borders: noBorders,
                                    width: { size: 35, type: WidthType.PERCENTAGE }
                                }),
                                new TableCell({
                                    children: [new Paragraph({
                                        children: [new TextRun({ text: [brand, `Rf: ${reference}`, dateStr].filter(Boolean).join(' | '), size: 18, font: 'Calibri', color: GRAY })],
                                        alignment: AlignmentType.RIGHT
                                    })],
                                    borders: noBorders,
                                    width: { size: 65, type: WidthType.PERCENTAGE },
                                    verticalAlign: VerticalAlign.CENTER
                                })
                            ]
                        })],
                        borders: noTableBorders,
                        width: { size: 100, type: WidthType.PERCENTAGE }
                    })]
                });

                // Content footer: 3 columns (tech name | company + address | page)
                const contentFooterCompany = [companyName, companyAddr].filter(Boolean).join(', ');
                const contentFooter = new Footer({
                    children: [
                        new Table({
                            rows: [new TableRow({
                                children: [
                                    new TableCell({
                                        children: [new Paragraph({
                                            children: [new TextRun({ text: techName, bold: true, size: 18, font: 'Calibri', color: BODY })],
                                            alignment: AlignmentType.LEFT
                                        })],
                                        borders: noBorders,
                                        width: { size: 33, type: WidthType.PERCENTAGE }
                                    }),
                                    new TableCell({
                                        children: [new Paragraph({
                                            children: [new TextRun({ text: contentFooterCompany, size: 18, font: 'Calibri', color: BODY })],
                                            alignment: AlignmentType.CENTER
                                        })],
                                        borders: noBorders,
                                        width: { size: 34, type: WidthType.PERCENTAGE }
                                    }),
                                    new TableCell({
                                        children: [new Paragraph({
                                            children: [
                                                new TextRun({ text: 'Page ', size: 18, font: 'Calibri', color: BODY }),
                                                new TextRun({ children: [PageNumber.CURRENT], size: 18, font: 'Calibri', color: BODY })
                                            ],
                                            alignment: AlignmentType.RIGHT
                                        })],
                                        borders: noBorders,
                                        width: { size: 33, type: WidthType.PERCENTAGE }
                                    })
                                ]
                            })],
                            borders: noTableBorders,
                            width: { size: 100, type: WidthType.PERCENTAGE }
                        })
                    ]
                });

                //  RSUM 
                if (data.resume) {
                    contentChildren.push(sectionHeading('Rsum'));
                    contentChildren.push(bodyText(data.resume));
                }

                //  SITE & CLIENT 
                contentChildren.push(sectionHeading('Site & Client'));
                contentChildren.push(infoBox(
                    [
                        data.site?.numero_affaire && { label: 'N Affaire', value: data.site.numero_affaire },
                        data.site?.adresse && { label: 'Adresse', value: data.site.adresse },
                        data.site?.ville && { label: 'Ville', value: data.site.ville }
                    ],
                    [
                        data.client?.societe && { label: 'Socit', value: data.client.societe },
                        data.client?.contact && { label: 'Contact', value: data.client.contact },
                        data.client?.telephone && { label: 'Tlphone', value: data.client.telephone },
                        data.client?.reference && { label: 'Rf. Client', value: data.client.reference }
                    ]
                ));

                //  DATES 
                if (data.dates && (data.dates.debut_date || data.dates.fin_date)) {
                    contentChildren.push(sectionHeading('Dates Intervention'));
                    contentChildren.push(infoBox(
                        [
                            data.dates.debut_date && { label: 'Dbut', value: `${data.dates.debut_date}${data.dates.debut_heure ? '  ' + data.dates.debut_heure : ''}` }
                        ],
                        [
                            data.dates.fin_date && { label: 'Fin', value: `${data.dates.fin_date}${data.dates.fin_heure ? '  ' + data.dates.fin_heure : ''}` }
                        ]
                    ));
                }

                //  QUIPEMENT 
                if ((data.systeme && Object.values(data.systeme).some(v => v)) || (data.fluide && Object.values(data.fluide).some(v => v))) {
                    contentChildren.push(sectionHeading('quipement'));
                    contentChildren.push(infoBox(
                        [
                            data.systeme?.type && { label: 'Type', value: data.systeme.type },
                            data.systeme?.modele && { label: 'Modle', value: data.systeme.modele },
                            data.systeme?.serie && { label: 'N Srie', value: data.systeme.serie },
                            data.systeme?.puissance && { label: 'Puissance', value: data.systeme.puissance + ' kW' },
                            data.systeme?.garantie && { label: 'Garantie', value: data.systeme.garantie }
                        ],
                        [
                            data.fluide?.type && { label: 'Fluide', value: data.fluide.type },
                            data.fluide?.charge_initiale && { label: 'Charge initiale', value: data.fluide.charge_initiale + ' kg' },
                            data.fluide?.charge_totale && { label: 'Charge totale', value: data.fluide.charge_totale + ' kg' },
                            data.fluide?.type_huile && { label: 'Huile', value: data.fluide.type_huile }
                        ]
                    ));
                }

                //  ADRESSAGE UNITS 
                if (data.adressage && data.adressage.length > 0) {
                    // Filter out malformed entries (raw text dumps, entries with very long field values)
                    const validAdressage = data.adressage.filter(a => {
                        const adr = a.adresse || a.equipement_id || a.ref_usine || '';
                        // Skip if any field is too long (likely a raw text dump)
                        if (adr.length > 20) return false;
                        // Skip if contains keywords that indicate raw text
                        if (/adressage|SW1|Soft:|Code \d{3}|verif electrique|VAC|disjoncteur/i.test(adr)) return false;
                        return true;
                    });
                    
                    if (validAdressage.length > 0) {
                        contentChildren.push(sectionHeading('Adressage Units'));
                        contentChildren.push(new Paragraph({ spacing: { before: 400 } }));
                        contentChildren.push(createTable(
                            ['Adr', 'Modle', 'Zone', 'N Srie'],
                            validAdressage.map(a => [
                                a.adresse || a.equipement_id || a.ref_usine || '',
                                a.modele || a.model || '',
                                a.zone || a.designation || '',
                                a.numero_serie || a.serie || ''
                            ])
                        ));
                    }
                }

                //  CODES DFAUT 
                const validCodes = (data.codes_defaut || []).filter(c => c.code && c.code !== 'A2' && c.code.trim());
                if (validCodes.length > 0) {
                    contentChildren.push(sectionHeading('Codes Dfaut'));
                    contentChildren.push(createTable(
                        ['Code', 'Description', 'Rsolution'],
                        validCodes.map(c => [c.code || '', c.description || '', c.resolution || ''])
                    ));
                }

                //  SCURIT 
                if (data.securite && (data.securite.etat || data.securite.risques)) {
                    contentChildren.push(sectionHeading('Scurit'));
                    if (data.securite.etat) {
                        const etatColors = { 'OK': '22C55E', ' surveiller': 'F59E0B', 'Critique': 'EF4444' };
                        contentChildren.push(new Paragraph({
                            children: [
                                new TextRun({ text: 'tat : ', bold: true, size: 21, font: 'Calibri', color: BODY }),
                                new TextRun({ text: data.securite.etat, bold: true, size: 21, font: 'Calibri', color: etatColors[data.securite.etat] || BODY })
                            ],
                            spacing: { after: 120, line: 312 }
                        }));
                    }
                    if (data.securite.risques) {
                        contentChildren.push(subsubHeading('Risques identifis'));
                        contentChildren.push(bodyText(data.securite.risques));
                    }
                }

                //  MESURES 
                if (data.mesures && data.mesures.length > 0) {
                    contentChildren.push(sectionHeading('Mesures'));
                    contentChildren.push(new Paragraph({ spacing: { before: 400 } }));
                    contentChildren.push(createTable(
                        ['Paramtre', 'Valeur', 'Observation'],
                        data.mesures.map(m => [m.label, `${m.valeur}${m.unite ? ' ' + m.unite : ''}`, m.note || ''])
                    ));
                }

                //  FONCTIONNEMENT 
                if (data.fonctionnement && (data.fonctionnement.heures_compresseur || data.fonctionnement.nb_demarrages)) {
                    contentChildren.push(sectionHeading('Fonctionnement'));
                    contentChildren.push(infoBox(
                        [data.fonctionnement.heures_compresseur && { label: 'Heures compresseur', value: data.fonctionnement.heures_compresseur + ' h' }],
                        [data.fonctionnement.nb_demarrages && { label: 'Nb dmarrages', value: data.fonctionnement.nb_demarrages }]
                    ));
                }

                //  TRAVAUX EFFECTUS 
                const validTravaux = (data.travaux_effectues || []).filter(t => t.texte && t.texte.trim());
                if (validTravaux.length > 0) {
                    contentChildren.push(sectionHeading('Travaux Effectus'));
                    validTravaux.forEach(t => {
                        const statusIcon = t.status === 'done' ? '' : (t.status === 'error' ? '' : '');
                        const statusColor = t.status === 'done' ? '22C55E' : (t.status === 'error' ? 'EF4444' : GRAY);
                        contentChildren.push(new Paragraph({
                            children: [
                                new TextRun({ text: statusIcon + '  ', color: statusColor, size: 21, font: 'Calibri' }),
                                new TextRun({ text: t.texte, size: 21, font: 'Calibri', color: BODY })
                            ],
                            spacing: { after: 120, line: 312 },
                            indent: { left: 200 }
                        }));
                    });
                }

                //  TRAVAUX  PRVOIR 
                const validTravauxPrevoir = (data.travaux_prevoir || []).filter(t => t.texte && t.texte.trim());
                if (validTravauxPrevoir.length > 0) {
                    contentChildren.push(sectionHeading('Travaux  Prvoir'));
                    validTravauxPrevoir.forEach(t => {
                        const prioColors = { urgent: 'EF4444', normal: 'F59E0B', optionnel: GRAY };
                        const prioLabels = { urgent: 'URGENT', normal: 'Normal', optionnel: 'Optionnel' };
                        contentChildren.push(new Paragraph({
                            children: [
                                new TextRun({ text: '  ', color: GRAY, size: 21, font: 'Calibri' }),
                                new TextRun({ text: t.texte, size: 21, font: 'Calibri', color: BODY }),
                                t.priorite ? new TextRun({ text: `  [${prioLabels[t.priorite] || t.priorite}]`, size: 18, font: 'Calibri', color: prioColors[t.priorite] || GRAY, bold: t.priorite === 'urgent' }) : null
                            ].filter(Boolean),
                            spacing: { after: 120, line: 312 },
                            indent: { left: 200 }
                        }));
                    });
                }

                //  PICES 
                if (data.pieces && data.pieces.length > 0) {
                    contentChildren.push(sectionHeading('Pices Utilises'));
                    contentChildren.push(createTable(
                        ['Rfrence', 'Dsignation', 'Qt'],
                        data.pieces.map(p => [p.reference, p.designation, p.quantite])
                    ));
                }

                //  RAPPORT TECHNICIEN 
                if (data.rapport_technicien) {
                    contentChildren.push(sectionHeading('Rapport Technicien'));
                    contentChildren.push(bodyText(data.rapport_technicien));
                }

                //  REMARQUES 
                if (data.remarques) {
                    contentChildren.push(sectionHeading('Remarques'));
                    contentChildren.push(bodyText(data.remarques));
                }

                //  TESTS MISE EN SERVICE 
                if (data.tests && (data.tests.pression_test_bar || data.tests.duree_test_heures || data.tests.valeur_vacuometre_mbar)) {
                    contentChildren.push(sectionHeading('Tests Mise en Service'));
                    contentChildren.push(infoBox(
                        [
                            data.tests.pression_test_bar && { label: 'Pression test', value: data.tests.pression_test_bar + ' bar' },
                            data.tests.duree_test_heures && { label: 'Dure test', value: data.tests.duree_test_heures + ' h' }
                        ],
                        [
                            data.tests.valeur_vacuometre_mbar && { label: 'Vacuomtre', value: data.tests.valeur_vacuometre_mbar + ' mbar' }
                        ]
                    ));
                }

                //  TUYAUTERIES 
                if (data.tuyauteries && (data.tuyauteries.longueur_totale_m || data.tuyauteries.denivele_oc_ui_m || data.tuyauteries.appoint_calcule_kg)) {
                    contentChildren.push(sectionHeading('Tuyauteries'));
                    contentChildren.push(infoBox(
                        [
                            data.tuyauteries.longueur_totale_m && { label: 'Longueur totale', value: data.tuyauteries.longueur_totale_m + ' m' },
                            data.tuyauteries.denivele_oc_ui_m && { label: 'Dnivel UE-UI', value: data.tuyauteries.denivele_oc_ui_m + ' m' }
                        ],
                        [
                            data.tuyauteries.appoint_calcule_kg && { label: 'Appoint calcul', value: data.tuyauteries.appoint_calcule_kg + ' kg' }
                        ]
                    ));
                }

                //  LECTRIQUE 
                if (data.electrique && (data.electrique.calibre_disjoncteur || data.electrique.section_cable)) {
                    contentChildren.push(sectionHeading('lectrique'));
                    contentChildren.push(infoBox(
                        [data.electrique.calibre_disjoncteur && { label: 'Calibre disjoncteur', value: data.electrique.calibre_disjoncteur }],
                        [data.electrique.section_cable && { label: 'Section cble', value: data.electrique.section_cable }]
                    ));
                }

                //  RELEVS UNIT EXTRIEURE 
                if (data.releves_ue && (data.releves_ue.pd1_bar || data.releves_ue.ps_bar || data.releves_ue.ta_celsius || data.releves_ue.freq_inv1_hz)) {
                    contentChildren.push(sectionHeading('Relevs Unit Extrieure'));
                    contentChildren.push(infoBox(
                        [
                            data.releves_ue.pd1_bar && { label: 'HP (Pd1)', value: data.releves_ue.pd1_bar + ' bar' },
                            data.releves_ue.ps_bar && { label: 'BP (Ps)', value: data.releves_ue.ps_bar + ' bar' }
                        ],
                        [
                            data.releves_ue.ta_celsius && { label: 'T ext (TA)', value: data.releves_ue.ta_celsius + ' C' },
                            data.releves_ue.freq_inv1_hz && { label: 'Frq compresseur', value: data.releves_ue.freq_inv1_hz + ' Hz' }
                        ]
                    ));
                }

                //  RELEVS UNITS INTRIEURES 
                if (data.releves_ui && data.releves_ui.length > 0) {
                    contentChildren.push(sectionHeading('Relevs Units Intrieures'));
                    contentChildren.push(createTable(
                        ['Unit', 'T Soufflage', 'T Reprise', 'Delta'],
                        data.releves_ui.map(ui => [ui.nom || '', ui.temp_soufflage || '', ui.temp_reprise || '', ui.delta || ''])
                    ));
                }

                //  CERFA FLUIDES FRIGORIGNES 
                if (data.cerfa && (data.cerfa.fluide_total_charge_kg || data.cerfa.fluide_total_recupere_kg || data.cerfa.attestation_capacite)) {
                    contentChildren.push(sectionHeading('CERFA Fluides Frigorignes'));
                    contentChildren.push(infoBox(
                        [
                            data.cerfa.fluide_total_charge_kg && { label: 'Fluide charg', value: data.cerfa.fluide_total_charge_kg + ' kg' },
                            data.cerfa.fluide_total_recupere_kg && { label: 'Fluide rcupr', value: data.cerfa.fluide_total_recupere_kg + ' kg' }
                        ],
                        [
                            data.cerfa.attestation_capacite && { label: 'N Attestation capacit', value: data.cerfa.attestation_capacite }
                        ]
                    ));
                }

                //  RSERVES 
                if (data.reserves && data.reserves.length > 0) {
                    contentChildren.push(sectionHeading('Rserves / Alertes'));
                    data.reserves.forEach(r => {
                        const isWarning = r.type === 'danger';
                        contentChildren.push(new Paragraph({
                            children: [
                                new TextRun({ text: isWarning ? ' ' : '! ', size: 21, color: isWarning ? 'EF4444' : 'F59E0B', font: 'Calibri' }),
                                new TextRun({ text: (r.titre || 'Attention') + ' : ', bold: true, size: 21, font: 'Calibri', color: isWarning ? 'EF4444' : 'F59E0B' }),
                                new TextRun({ text: r.texte, size: 21, font: 'Calibri', color: BODY })
                            ],
                            spacing: { after: 120, line: 312 }
                        }));
                    });
                }

                //  RSULTAT 
                if (data.resultat && (data.resultat.status || data.resultat.label || data.resultat.description)) {
                    contentChildren.push(sectionHeading('Rsultat'));
                    const resConfig = {
                        resolu: { color: '22C55E', bg: 'DCFCE7', label: ' PROBLME RSOLU' },
                        en_attente: { color: 'F59E0B', bg: 'FEF9C3', label: ' EN ATTENTE' },
                        non_resolu: { color: 'EF4444', bg: 'FEE2E2', label: ' NON RSOLU' },
                        intervention_requise: { color: 'EF4444', bg: 'FEE2E2', label: ' NOUVELLE INTERVENTION' }
                    };
                    
                    // Get status label - use data.resultat.label if available, or map from status
                    let statusLabel = data.resultat.label || (resConfig[data.resultat.status]?.label) || ' EN ATTENTE';
                    const rc = resConfig[data.resultat.status] || resConfig.en_attente;

                    contentChildren.push(new Paragraph({
                        children: [new TextRun({ text: statusLabel, bold: true, size: 26, font: 'Calibri', color: rc.color })],
                        spacing: { after: 120 },
                        shading: { fill: rc.bg, type: ShadingType.CLEAR }
                    }));

                    // Clean up description - remove any "Conclusion :" prefix to avoid duplication
                    let description = data.resultat.description || data.resultat.conclusion || '';
                    description = description.replace(/^Conclusion\s*:\s*/i, '').trim();
                    
                    if (description && description !== 'Description du rsultat...') {
                        contentChildren.push(new Paragraph({
                            children: [
                                new TextRun({ text: 'Conclusion : ', bold: true, size: 21, font: 'Calibri', color: BODY }),
                                new TextRun({ text: description, size: 21, font: 'Calibri', color: BODY })
                            ],
                            spacing: { after: 120, line: 312 }
                        }));
                    }
                }

                //  TECHNICIEN 
                if (data.technicien && (data.technicien.nom || data.technicien.entreprise)) {
                    contentChildren.push(sectionHeading('Technicien'));
                    contentChildren.push(infoBox(
                        [
                            data.technicien.nom && data.technicien.nom !== 'FixAIR Assistant' && { label: 'Nom', value: data.technicien.nom },
                            data.technicien.entreprise && { label: 'Entreprise', value: data.technicien.entreprise }
                        ],
                        [
                            (data.technicien.heure_arrivee || data.technicien.heure_depart) && { label: 'Prsence', value: `${data.technicien.heure_arrivee || '?'}  ${data.technicien.heure_depart || '?'}` },
                            data.technicien.autres && { label: 'quipe', value: data.technicien.autres }
                        ]
                    ));
                }

                //  OBSERVATION CLIENT 
                if (data.observation_client && data.observation_client !== 'Observations du client...') {
                    contentChildren.push(sectionHeading('Observation Client'));
                    contentChildren.push(new Paragraph({
                        children: [new TextRun({ text: data.observation_client, size: 21, font: 'Calibri', italics: true, color: BODY })],
                        spacing: { after: 200, line: 312 },
                        shading: { fill: 'F0F9FF', type: ShadingType.CLEAR }
                    }));
                }

                //  PHOTOS (BEFORE SIGNATURES) 
                const photos = data.photos || window.reportPhotos || [];
                const validPhotos = photos.filter(p => p.data && p.data.startsWith('data:image'));

                if (validPhotos.length > 0) {
                    contentChildren.push(sectionHeading('Photos de l\'intervention'));
                    contentChildren.push(new Paragraph({
                        children: [new TextRun({ text: `${validPhotos.length} photo${validPhotos.length > 1 ? 's' : ''} jointe${validPhotos.length > 1 ? 's' : ''}`, size: 21, font: 'Calibri', color: GRAY })],
                        spacing: { after: 200 }
                    }));

                    // Process photos in pairs for 2-column grid
                    for (let i = 0; i < validPhotos.length; i += 2) {
                        const photo1 = validPhotos[i];
                        const photo2 = validPhotos[i + 1];

                        const cell1Content = [];
                        try {
                            cell1Content.push(new Paragraph({
                                children: [new ImageRun({
                                    data: b64toU8(photo1.data),
                                    transformation: { width: 200, height: 150 }
                                })],
                                alignment: AlignmentType.CENTER,
                                spacing: { after: 60 }
                            }));
                            if (photo1.caption) {
                                cell1Content.push(new Paragraph({
                                    children: [new TextRun({ text: photo1.caption, size: 18, font: 'Calibri', italics: true, color: GRAY })],
                                    alignment: AlignmentType.CENTER
                                }));
                            }
                        } catch (e) { console.error('Photo error:', e); }

                        const cell2Content = [];
                        if (photo2) {
                            try {
                                cell2Content.push(new Paragraph({
                                    children: [new ImageRun({
                                        data: b64toU8(photo2.data),
                                        transformation: { width: 200, height: 150 }
                                    })],
                                    alignment: AlignmentType.CENTER,
                                    spacing: { after: 60 }
                                }));
                                if (photo2.caption) {
                                    cell2Content.push(new Paragraph({
                                        children: [new TextRun({ text: photo2.caption, size: 18, font: 'Calibri', italics: true, color: GRAY })],
                                        alignment: AlignmentType.CENTER
                                    }));
                                }
                            } catch (e) { console.error('Photo error:', e); }
                        } else {
                            cell2Content.push(new Paragraph({}));
                        }

                        contentChildren.push(new Table({
                            rows: [new TableRow({
                                children: [
                                    new TableCell({
                                        children: cell1Content.length ? cell1Content : [new Paragraph({})],
                                        borders: noBorders,
                                        margins: { top: 80, bottom: 80, left: 40, right: 40 },
                                        width: { size: 50, type: WidthType.PERCENTAGE },
                                        verticalAlign: VerticalAlign.TOP
                                    }),
                                    new TableCell({
                                        children: cell2Content.length ? cell2Content : [new Paragraph({})],
                                        borders: noBorders,
                                        margins: { top: 80, bottom: 80, left: 40, right: 40 },
                                        width: { size: 50, type: WidthType.PERCENTAGE },
                                        verticalAlign: VerticalAlign.TOP
                                    })
                                ]
                            })],
                            borders: noTableBorders,
                            width: { size: 100, type: WidthType.PERCENTAGE }
                        }));
                    }
                }

                //  SIGNATURES 
                if (data.signatures && (data.signatures.client || data.signatures.technicien || data.signatures.nom_client || data.signatures.nom_technicien)) {
                    contentChildren.push(sectionHeading('Signatures'));

                    const sigCells = [];

                    // Client signature
                    const clientSigContent = [];
                    clientSigContent.push(new Paragraph({
                        children: [new TextRun({ text: 'Client', bold: true, size: 21, font: 'Calibri', color: TEAL })],
                        alignment: AlignmentType.CENTER
                    }));

                    // Handle both formats: string (old) or object {image: "...", nom: "..."} (new)
                    const clientSigImage = typeof data.signatures.client === 'string' 
                        ? data.signatures.client 
                        : data.signatures.client?.image;
                    
                    if (clientSigImage && clientSigImage.startsWith('data:image')) {
                        try {
                            clientSigContent.push(new Paragraph({
                                children: [new ImageRun({
                                    data: b64toU8(clientSigImage),
                                    transformation: { width: 150, height: 60 }
                                })],
                                alignment: AlignmentType.CENTER
                            }));
                        } catch (e) { console.error('Signature client error:', e); }
                    }

                    // Get client name from multiple possible sources
                    const clientSigName = data.signatures.nom_client || 
                                         data.signatures.client?.nom || 
                                         data.client?.contact || 
                                         '________________';
                    
                    clientSigContent.push(new Paragraph({
                        children: [new TextRun({ text: clientSigName, size: 21, font: 'Calibri', color: BODY })],
                        alignment: AlignmentType.CENTER,
                        spacing: { before: 100 }
                    }));

                    sigCells.push(new TableCell({
                        children: clientSigContent,
                        borders: { top: tblBorder, bottom: tblBorder, left: tblBorder, right: tblBorder },
                        margins: { top: 120, bottom: 120, left: 120, right: 120 },
                        width: { size: 50, type: WidthType.PERCENTAGE }
                    }));

                    // Technician signature
                    const techSigContent = [];
                    techSigContent.push(new Paragraph({
                        children: [new TextRun({ text: 'Technicien', bold: true, size: 21, font: 'Calibri', color: TEAL })],
                        alignment: AlignmentType.CENTER
                    }));

                    // Handle both formats: string (old) or object {image: "...", nom: "..."} (new)
                    const techSigImage = typeof data.signatures.technicien === 'string' 
                        ? data.signatures.technicien 
                        : data.signatures.technicien?.image;
                    
                    if (techSigImage && techSigImage.startsWith('data:image')) {
                        try {
                            techSigContent.push(new Paragraph({
                                children: [new ImageRun({
                                    data: b64toU8(techSigImage),
                                    transformation: { width: 150, height: 60 }
                                })],
                                alignment: AlignmentType.CENTER
                            }));
                        } catch (e) { console.error('Signature tech error:', e); }
                    }

                    // Get tech name from multiple possible sources
                    const techSigName = data.signatures.nom_technicien || 
                                       data.signatures.technicien?.nom || 
                                       data.technicien?.nom || 
                                       '________________';
                    
                    techSigContent.push(new Paragraph({
                        children: [new TextRun({ text: techSigName, size: 21, font: 'Calibri', color: BODY })],
                        alignment: AlignmentType.CENTER,
                        spacing: { before: 100 }
                    }));

                    sigCells.push(new TableCell({
                        children: techSigContent,
                        borders: { top: tblBorder, bottom: tblBorder, left: tblBorder, right: tblBorder },
                        margins: { top: 120, bottom: 120, left: 120, right: 120 },
                        width: { size: 50, type: WidthType.PERCENTAGE }
                    }));

                    contentChildren.push(new Table({
                        rows: [new TableRow({ children: sigCells })],
                        width: { size: 100, type: WidthType.PERCENTAGE }
                    }));
                }

                //  GENERATED BY MENTION 
                contentChildren.push(new Paragraph({
                    children: [new TextRun({ text: 'Ce rapport a t gnr par FixAIR Assistant | fixair.ai', size: 16, font: 'Calibri', color: 'AAAAAA' })],
                    alignment: AlignmentType.CENTER,
                    spacing: { before: 400 }
                }));

                //  BUILD TWO-SECTION DOCUMENT 
                const filteredContent = contentChildren.filter(c => c !== null);

                const doc = new Document({
                    sections: [
                        {
                            // Cover page
                            properties: {
                                page: {
                                    margin: { top: 900, right: 720, bottom: 1100, left: 720 }
                                }
                            },
                            headers: { default: coverHeader },
                            footers: { default: coverFooter },
                            children: coverChildren
                        },
                        {
                            // Content pages
                            properties: {
                                page: {
                                    margin: { top: 1200, right: 720, bottom: 1100, left: 720 }
                                }
                            },
                            headers: { default: contentHeader },
                            footers: { default: contentFooter },
                            children: filteredContent
                        }
                    ]
                });

                // Generate and download
                const blob = await Packer.toBlob(doc);
                const fileCompany = companyName || 'Rapport';
                const filename = `Rapport_${fileCompany}_${brand}_${reference || new Date().toISOString().split('T')[0]}.docx`.replace(/__/g, '_').replace(/_+/g, '_');
                saveAs(blob, filename);

                toast('Document Word tlcharg !');
                trackAction('report');

            } catch (error) {
                console.error('Error generating Word document:', error);
                toast('Erreur gnration Word: ' + error.message);
            }
        }

        // Generate professional PDF
        async function generatePDF(data) {
            try {
                toast('Gnration du PDF...');
                
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF('p', 'mm', 'a4');
                const pageWidth = 210;
                const pageHeight = 297;
                const margin = 15;
                const contentWidth = pageWidth - (margin * 2);
                
                // Get brand colors
                const brandKey = data.brand_key || 'general';
                const colors = brandColorsPDF[brandKey] || brandColorsPDF.general;
                
                // Helper to convert hex to RGB
                const hexToRgb = (hex) => {
                    const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
                    return result ? {
                        r: parseInt(result[1], 16),
                        g: parseInt(result[2], 16),
                        b: parseInt(result[3], 16)
                    } : { r: 0, g: 0, b: 0 };
                };
                
                const primaryRgb = hexToRgb(colors.primary);
                let y = margin;
                
                //  HEADER 
                // Brand color bar
                doc.setFillColor(primaryRgb.r, primaryRgb.g, primaryRgb.b);
                doc.rect(0, 0, pageWidth, 25, 'F');
                
                // FixAIR Logo text (white)
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(18);
                doc.setFont('helvetica', 'bold');
                doc.text('FixAIR', margin, 12);
                
                // Brand name
                doc.setFontSize(12);
                doc.setFont('helvetica', 'normal');
                doc.text(data.brand || 'Multi-marques', margin, 20);
                
                // Report title (right side)
                doc.setFontSize(10);
                doc.text("RAPPORT D'INTERVENTION", pageWidth - margin, 12, { align: 'right' });
                
                // Reference
                if (data.reference) {
                    doc.setFontSize(9);
                    doc.text(data.reference, pageWidth - margin, 18, { align: 'right' });
                }
                
                // Date
                if (data.date) {
                    doc.text(data.date, pageWidth - margin, 23, { align: 'right' });
                }
                
                y = 35;
                
                //  STATUS BADGE 
                if (data.status) {
                    const statusColors = {
                        'conforme': { r: 34, g: 197, b: 94 },
                        'non_conforme': { r: 239, g: 68, b: 68 },
                        'en_cours': { r: 234, g: 179, b: 8 }
                    };
                    const statusLabels = {
                        'conforme': 'CONFORME',
                        'non_conforme': 'NON CONFORME',
                        'en_cours': 'EN COURS'
                    };
                    const sc = statusColors[data.status] || statusColors.en_cours;
                    const sl = statusLabels[data.status] || data.status.toUpperCase();
                    
                    doc.setFillColor(sc.r, sc.g, sc.b);
                    doc.roundedRect(margin, y, 35, 7, 2, 2, 'F');
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(8);
                    doc.setFont('helvetica', 'bold');
                    doc.text(sl, margin + 17.5, y + 5, { align: 'center' });
                    
                    y += 12;
                }
                
                //  RSUM 
                if (data.resume) {
                    doc.setTextColor(30, 30, 30);
                    doc.setFontSize(11);
                    doc.setFont('helvetica', 'bold');
                    doc.text('Rsum', margin, y);
                    y += 6;
                    
                    doc.setFont('helvetica', 'normal');
                    doc.setFontSize(10);
                    doc.setTextColor(60, 60, 60);
                    const resumeLines = doc.splitTextToSize(data.resume, contentWidth);
                    doc.text(resumeLines, margin, y);
                    y += resumeLines.length * 5 + 8;
                }
                
                //  SECTION HELPER 
                const addSection = (title, items, startY) => {
                    if (!items || items.length === 0) return startY;
                    
                    doc.setTextColor(primaryRgb.r, primaryRgb.g, primaryRgb.b);
                    doc.setFontSize(10);
                    doc.setFont('helvetica', 'bold');
                    doc.text(title, margin, startY);
                    startY += 5;
                    
                    // Section line
                    doc.setDrawColor(primaryRgb.r, primaryRgb.g, primaryRgb.b);
                    doc.setLineWidth(0.5);
                    doc.line(margin, startY, margin + 40, startY);
                    startY += 4;
                    
                    doc.setTextColor(30, 30, 30);
                    doc.setFont('helvetica', 'normal');
                    doc.setFontSize(9);
                    
                    items.forEach(item => {
                        if (item.label && item.value) {
                            doc.setFont('helvetica', 'bold');
                            doc.text(item.label + ':', margin, startY);
                            doc.setFont('helvetica', 'normal');
                            const valueLines = doc.splitTextToSize(String(item.value), contentWidth - 35);
                            doc.text(valueLines, margin + 35, startY);
                            startY += valueLines.length * 4 + 2;
                        }
                    });
                    
                    return startY + 5;
                };
                
                //  CLIENT & SITE (2 columns) 
                const col1X = margin;
                const col2X = margin + contentWidth / 2 + 5;
                const colWidth = contentWidth / 2 - 5;
                let col1Y = y;
                let col2Y = y;
                
                // Client info
                if (data.client) {
                    const clientItems = [];
                    if (data.client.societe) clientItems.push({ label: 'Socit', value: data.client.societe });
                    if (data.client.contact) clientItems.push({ label: 'Contact', value: data.client.contact });
                    if (data.client.telephone) clientItems.push({ label: 'Tlphone', value: data.client.telephone });
                    if (data.client.dossier) clientItems.push({ label: 'N Dossier', value: data.client.dossier });
                    
                    if (clientItems.length > 0) {
                        doc.setTextColor(primaryRgb.r, primaryRgb.g, primaryRgb.b);
                        doc.setFontSize(10);
                        doc.setFont('helvetica', 'bold');
                        doc.text('Client', col1X, col1Y);
                        col1Y += 5;
                        doc.setDrawColor(primaryRgb.r, primaryRgb.g, primaryRgb.b);
                        doc.line(col1X, col1Y, col1X + 30, col1Y);
                        col1Y += 4;
                        
                        doc.setTextColor(30, 30, 30);
                        doc.setFontSize(9);
                        clientItems.forEach(item => {
                            doc.setFont('helvetica', 'bold');
                            doc.text(item.label + ':', col1X, col1Y);
                            doc.setFont('helvetica', 'normal');
                            doc.text(String(item.value), col1X + 25, col1Y);
                            col1Y += 5;
                        });
                        col1Y += 3;
                    }
                }
                
                // Site info
                if (data.site) {
                    const siteItems = [];
                    if (data.site.adresse) siteItems.push({ label: 'Adresse', value: data.site.adresse });
                    if (data.site.ville) siteItems.push({ label: 'Ville', value: data.site.ville });
                    if (data.site.batiment) siteItems.push({ label: 'Btiment', value: data.site.batiment });
                    if (data.site.acces) siteItems.push({ label: 'Accs', value: data.site.acces });
                    
                    if (siteItems.length > 0) {
                        doc.setTextColor(primaryRgb.r, primaryRgb.g, primaryRgb.b);
                        doc.setFontSize(10);
                        doc.setFont('helvetica', 'bold');
                        doc.text('Site', col2X, col2Y);
                        col2Y += 5;
                        doc.line(col2X, col2Y, col2X + 30, col2Y);
                        col2Y += 4;
                        
                        doc.setTextColor(30, 30, 30);
                        doc.setFontSize(9);
                        siteItems.forEach(item => {
                            doc.setFont('helvetica', 'bold');
                            doc.text(item.label + ':', col2X, col2Y);
                            doc.setFont('helvetica', 'normal');
                            const lines = doc.splitTextToSize(String(item.value), colWidth - 25);
                            doc.text(lines, col2X + 25, col2Y);
                            col2Y += lines.length * 4 + 1;
                        });
                        col2Y += 3;
                    }
                }
                
                y = Math.max(col1Y, col2Y) + 5;
                
                //  SYSTME & INTERVENTION (2 columns) 
                col1Y = y;
                col2Y = y;
                
                // Systme
                if (data.systeme) {
                    const sysItems = [];
                    if (data.systeme.type) sysItems.push({ label: 'Type', value: data.systeme.type });
                    if (data.systeme.modele) sysItems.push({ label: 'Modle', value: data.systeme.modele });
                    if (data.systeme.serie) sysItems.push({ label: 'N Srie', value: data.systeme.serie });
                    if (data.systeme.fluide) sysItems.push({ label: 'Fluide', value: data.systeme.fluide });
                    
                    if (sysItems.length > 0) {
                        doc.setTextColor(primaryRgb.r, primaryRgb.g, primaryRgb.b);
                        doc.setFontSize(10);
                        doc.setFont('helvetica', 'bold');
                        doc.text('Systme', col1X, col1Y);
                        col1Y += 5;
                        doc.line(col1X, col1Y, col1X + 30, col1Y);
                        col1Y += 4;
                        
                        doc.setTextColor(30, 30, 30);
                        doc.setFontSize(9);
                        sysItems.forEach(item => {
                            doc.setFont('helvetica', 'bold');
                            doc.text(item.label + ':', col1X, col1Y);
                            doc.setFont('helvetica', 'normal');
                            doc.text(String(item.value), col1X + 25, col1Y);
                            col1Y += 5;
                        });
                        col1Y += 3;
                    }
                }
                
                // Intervention
                if (data.intervention) {
                    const intItems = [];
                    if (data.intervention.type) intItems.push({ label: 'Type', value: data.intervention.type });
                    if (data.intervention.statut) intItems.push({ label: 'Statut', value: data.intervention.statut });
                    if (data.intervention.probleme) intItems.push({ label: 'Problme', value: data.intervention.probleme });
                    if (data.intervention.diagnostic) intItems.push({ label: 'Diagnostic', value: data.intervention.diagnostic });
                    
                    if (intItems.length > 0) {
                        doc.setTextColor(primaryRgb.r, primaryRgb.g, primaryRgb.b);
                        doc.setFontSize(10);
                        doc.setFont('helvetica', 'bold');
                        doc.text('Intervention', col2X, col2Y);
                        col2Y += 5;
                        doc.line(col2X, col2Y, col2X + 30, col2Y);
                        col2Y += 4;
                        
                        doc.setTextColor(30, 30, 30);
                        doc.setFontSize(9);
                        intItems.forEach(item => {
                            doc.setFont('helvetica', 'bold');
                            doc.text(item.label + ':', col2X, col2Y);
                            doc.setFont('helvetica', 'normal');
                            const lines = doc.splitTextToSize(String(item.value), colWidth - 25);
                            doc.text(lines, col2X + 25, col2Y);
                            col2Y += lines.length * 4 + 1;
                        });
                        col2Y += 3;
                    }
                }
                
                y = Math.max(col1Y, col2Y) + 5;
                
                // Check for page break
                if (y > pageHeight - 60) {
                    doc.addPage();
                    y = margin;
                }
                
                //  TRAVAUX EFFECTUS 
                if (data.travaux_effectues && data.travaux_effectues.length > 0) {
                    doc.setTextColor(primaryRgb.r, primaryRgb.g, primaryRgb.b);
                    doc.setFontSize(10);
                    doc.setFont('helvetica', 'bold');
                    doc.text('Travaux effectus', margin, y);
                    y += 5;
                    doc.line(margin, y, margin + 40, y);
                    y += 5;
                    
                    doc.setFontSize(9);
                    data.travaux_effectues.forEach(t => {
                        // Status icon
                        if (t.status === 'done') {
                            doc.setTextColor(34, 197, 94);
                            doc.text('', margin, y);
                        } else if (t.status === 'error') {
                            doc.setTextColor(239, 68, 68);
                            doc.text('', margin, y);
                        } else {
                            doc.setTextColor(234, 179, 8);
                            doc.text('', margin, y);
                        }
                        
                        doc.setTextColor(30, 30, 30);
                        doc.setFont('helvetica', 'normal');
                        const lines = doc.splitTextToSize(t.texte, contentWidth - 10);
                        doc.text(lines, margin + 6, y);
                        y += lines.length * 4 + 2;
                    });
                    y += 5;
                }
                
                //  MESURES 
                if (data.mesures && data.mesures.length > 0) {
                    if (y > pageHeight - 40) {
                        doc.addPage();
                        y = margin;
                    }
                    
                    doc.setTextColor(primaryRgb.r, primaryRgb.g, primaryRgb.b);
                    doc.setFontSize(10);
                    doc.setFont('helvetica', 'bold');
                    doc.text('Mesures', margin, y);
                    y += 5;
                    doc.line(margin, y, margin + 30, y);
                    y += 5;
                    
                    doc.setFontSize(9);
                    data.mesures.forEach(m => {
                        doc.setFont('helvetica', 'bold');
                        doc.setTextColor(30, 30, 30);
                        doc.text(m.label + ':', margin, y);
                        
                        // Value with status color
                        if (m.status === 'ok') {
                            doc.setTextColor(34, 197, 94);
                        } else if (m.status === 'error') {
                            doc.setTextColor(239, 68, 68);
                        } else {
                            doc.setTextColor(60, 60, 60);
                        }
                        doc.setFont('helvetica', 'normal');
                        doc.text(String(m.valeur), margin + 40, y);
                        
                        if (m.note) {
                            doc.setTextColor(120, 120, 120);
                            doc.text(`(${m.note})`, margin + 70, y);
                        }
                        y += 5;
                    });
                    y += 5;
                }
                
                //  RSULTAT 
                if (data.resultat) {
                    if (y > pageHeight - 30) {
                        doc.addPage();
                        y = margin;
                    }
                    
                    const resColor = data.resultat.status === 'resolu' 
                        ? { r: 34, g: 197, b: 94 } 
                        : { r: 239, g: 68, b: 68 };
                    
                    doc.setFillColor(resColor.r, resColor.g, resColor.b, 0.1);
                    doc.roundedRect(margin, y, contentWidth, 15, 3, 3, 'F');
                    
                    doc.setTextColor(resColor.r, resColor.g, resColor.b);
                    doc.setFontSize(11);
                    doc.setFont('helvetica', 'bold');
                    const resLabel = data.resultat.label || (data.resultat.status === 'resolu' ? 'Problme rsolu' : 'Non rsolu');
                    doc.text(resLabel, margin + 5, y + 6);
                    
                    if (data.resultat.description) {
                        doc.setFontSize(9);
                        doc.setFont('helvetica', 'normal');
                        doc.text(data.resultat.description, margin + 5, y + 11);
                    }
                    y += 20;
                }
                
                //  RSERVES 
                if (data.reserves && data.reserves.length > 0) {
                    if (y > pageHeight - 30) {
                        doc.addPage();
                        y = margin;
                    }
                    
                    doc.setTextColor(primaryRgb.r, primaryRgb.g, primaryRgb.b);
                    doc.setFontSize(10);
                    doc.setFont('helvetica', 'bold');
                    doc.text('Rserves / Alertes', margin, y);
                    y += 6;
                    
                    data.reserves.forEach(r => {
                        const rColor = r.type === 'danger' 
                            ? { r: 239, g: 68, b: 68 }
                            : { r: 234, g: 179, b: 8 };
                        
                        doc.setFillColor(rColor.r, rColor.g, rColor.b, 0.1);
                        doc.roundedRect(margin, y, contentWidth, 12, 2, 2, 'F');
                        
                        doc.setTextColor(rColor.r, rColor.g, rColor.b);
                        doc.setFontSize(9);
                        doc.setFont('helvetica', 'bold');
                        doc.text(r.type === 'danger' ? '' : '!', margin + 3, y + 5);
                        doc.text(r.titre || 'Attention', margin + 8, y + 5);
                        
                        doc.setFont('helvetica', 'normal');
                        doc.setTextColor(60, 60, 60);
                        const rLines = doc.splitTextToSize(r.texte, contentWidth - 15);
                        doc.text(rLines[0], margin + 8, y + 9);
                        y += 14;
                    });
                    y += 3;
                }
                
                //  PHOTOS 
                const photos = window.reportPhotos || [];
                if (photos.length > 0) {
                    doc.addPage();
                    y = margin;
                    
                    doc.setTextColor(primaryRgb.r, primaryRgb.g, primaryRgb.b);
                    doc.setFontSize(12);
                    doc.setFont('helvetica', 'bold');
                    doc.text('Photos de l\'intervention', margin, y);
                    y += 10;
                    
                    const photoWidth = 85;
                    const photoHeight = 60;
                    let photoX = margin;
                    
                    for (let i = 0; i < photos.length; i++) {
                        const photo = photos[i];
                        
                        try {
                            const imgData = photo.data || photo.url;
                            if (imgData && imgData.startsWith('data:image')) {
                                doc.addImage(imgData, 'JPEG', photoX, y, photoWidth, photoHeight);
                                
                                // Caption
                                if (photo.caption) {
                                    doc.setTextColor(60, 60, 60);
                                    doc.setFontSize(8);
                                    doc.setFont('helvetica', 'italic');
                                    doc.text(photo.caption, photoX, y + photoHeight + 4);
                                }
                                
                                // Move to next position
                                if (i % 2 === 0) {
                                    photoX = margin + photoWidth + 10;
                                } else {
                                    photoX = margin;
                                    y += photoHeight + 15;
                                    
                                    // Check page break
                                    if (y > pageHeight - photoHeight - 20) {
                                        doc.addPage();
                                        y = margin;
                                    }
                                }
                            }
                        } catch (e) {
                            console.error('Error adding photo to PDF:', e);
                        }
                    }
                }
                
                //  FOOTER 
                const totalPages = doc.internal.getNumberOfPages();
                for (let i = 1; i <= totalPages; i++) {
                    doc.setPage(i);
                    
                    // Footer line
                    doc.setDrawColor(200, 200, 200);
                    doc.setLineWidth(0.3);
                    doc.line(margin, pageHeight - 15, pageWidth - margin, pageHeight - 15);
                    
                    // Footer text
                    doc.setTextColor(120, 120, 120);
                    doc.setFontSize(8);
                    doc.setFont('helvetica', 'normal');
                    doc.text(`Gnr par FixAIR - ${new Date().toLocaleDateString('fr-FR')}`, margin, pageHeight - 10);
                    doc.text(`Page ${i}/${totalPages}`, pageWidth - margin, pageHeight - 10, { align: 'right' });
                    
                    // Technicien
                    if (data.technicien && data.technicien.nom) {
                        doc.text(`Technicien: ${data.technicien.nom}`, pageWidth / 2, pageHeight - 10, { align: 'center' });
                    }
                }
                
                //  SAVE PDF 
                const filename = `Rapport_${data.brand || 'FixAIR'}_${data.reference || new Date().toISOString().split('T')[0]}.pdf`;
                doc.save(filename);
                
                // Mark report as completed (for manager visibility)
                if (lastReportData) {
                    lastReportData.status = 'complet';
                    lastReportData.exported_at = new Date().toISOString();
                    updateDrawerPreview(lastReportData);
                    // Report exported and marked as complete
                }
                
                // Track gamification
                trackAction('report');
                
                toast('PDF tlcharg !');
                
            } catch (error) {
                console.error('Error generating PDF:', error);
                toast('Erreur gnration PDF');
            }
        }
        
        // 
        // DRAWER PREVIEW - Live Report Updates
        // 
        
        // Update the drawer preview with report data
        function updateDrawerPreview(data) {
            const emptyState = document.getElementById('reportPreviewEmpty');
            const previewContent = document.getElementById('reportPreviewContent');
            const headerProgress = document.getElementById('reportHeaderProgress');
            const progressFill = document.getElementById('reportProgressFill');
            const progressText = document.getElementById('reportProgressText');
            
            if (!previewContent) return;
            
            // Clear undo/redo stacks when loading new content
            drawerUndoStack = [];
            drawerRedoStack = [];
            
            // Always hide empty state - we show editable template instead
            if (emptyState) emptyState.style.display = 'none';
            previewContent.style.display = 'block';
            
            // Use provided data or empty object
            const reportData = data || {};
            
            // Calculate completion percentage
            const completionStatus = calculateReportCompletion(reportData);
            
            // Update header progress bar
            if (headerProgress && progressFill && progressText) {
                if (completionStatus.percentage > 0) {
                    headerProgress.style.display = 'flex';
                    progressFill.style.width = completionStatus.percentage + '%';
                    progressText.textContent = completionStatus.percentage + '%';
                } else {
                    headerProgress.style.display = 'flex';
                    progressFill.style.width = '0%';
                    progressText.textContent = '0%';
                }
            }
            
            // R3-Fix2: Clean duplicate prefixes in resultat before rendering
            if (reportData && reportData.resultat) {
                ['status', 'label', 'description', 'conclusion'].forEach(k => {
                    if (reportData.resultat[k] && typeof reportData.resultat[k] === 'string') {
                        reportData.resultat[k] = reportData.resultat[k].replace(/^(Statut|Status|Conclusion|Description)\s*:\s*/i, '').trim();
                    }
                });
            }

            // Generate editable template HTML - v12.5
            const previewHtml = renderReportPreviewV12(reportData, completionStatus);
            previewContent.innerHTML = previewHtml;
            
            // Initialize v12.5 features (drag-drop, auto-save, etc.)
            initDrawerV12Features();
            
            // Save initial state for undo (so user can always undo to starting point)
            setTimeout(() => drawerSaveState(), 100);
            
            // Update footer buttons based on completion status
            const isCompleted = reportData.status === 'completed' || completionStatus?.percentage >= 100;
            updateReportFooterButtonsV12(isCompleted);
            
            // Drawer preview updated
        }
        
        // Calculate report completion for manager visibility
        function calculateReportCompletion(data) {
            if (!data) data = {};
            
            // Helper to check if a string field is filled
            const isFilled = (val) => val && typeof val === 'string' && val.trim() !== '';
            
            // Helper to check if an array has real content
            const hasItems = (arr) => {
                if (!Array.isArray(arr) || arr.length === 0) return false;
                // Check if at least one item has actual content
                return arr.some(item => {
                    if (typeof item === 'string') return item.trim() !== '';
                    if (typeof item === 'object') {
                        return Object.values(item).some(v => v && typeof v === 'string' && v.trim() !== '');
                    }
                    return false;
                });
            };
            
            // All trackable fields with weights (more important = higher weight)
            const fieldChecks = {
                // Essential fields (weight: 3) - Required for a valid report
                type_intervention: { filled: isFilled(data.type_intervention), weight: 3 },
                client_societe: { filled: isFilled(data.client?.societe), weight: 3 },
                site_adresse: { filled: isFilled(data.site?.adresse), weight: 3 },
                resultat_status: { filled: isFilled(data.resultat?.status), weight: 3 },
                
                // Very important fields (weight: 2)
                systeme_modele: { filled: isFilled(data.systeme?.modele), weight: 2 },
                systeme_type: { filled: isFilled(data.systeme?.type), weight: 2 },
                site_ville: { filled: isFilled(data.site?.ville), weight: 2 },
                travaux_effectues: { filled: hasItems(data.travaux_effectues), weight: 2 },
                dates_debut: { filled: isFilled(data.dates?.debut_date), weight: 2 },
                
                // Important fields (weight: 1.5)
                reference: { filled: isFilled(data.reference), weight: 1.5 },
                resume: { filled: isFilled(data.resume), weight: 1.5 },
                client_contact: { filled: isFilled(data.client?.contact), weight: 1.5 },
                technicien_nom: { filled: isFilled(data.technicien?.nom), weight: 1.5 },
                resultat_description: { filled: isFilled(data.resultat?.description), weight: 1.5 },
                
                // Valuable fields (weight: 1)
                client_telephone: { filled: isFilled(data.client?.telephone), weight: 1 },
                systeme_serie: { filled: isFilled(data.systeme?.serie), weight: 1 },
                fluide_type: { filled: isFilled(data.fluide?.type), weight: 1 },
                codes_defaut: { filled: hasItems(data.codes_defaut), weight: 1 },
                mesures: { filled: hasItems(data.mesures), weight: 1 },
                rapport_technicien: { filled: isFilled(data.rapport_technicien), weight: 1 },
                technicien_arrivee: { filled: isFilled(data.technicien?.heure_arrivee), weight: 1 },
                technicien_depart: { filled: isFilled(data.technicien?.heure_depart), weight: 1 },
                
                // Bonus fields (weight: 0.5)
                site_numero_affaire: { filled: isFilled(data.site?.numero_affaire), weight: 0.5 },
                systeme_puissance: { filled: isFilled(data.systeme?.puissance), weight: 0.5 },
                fluide_charge: { filled: isFilled(data.fluide?.charge_totale), weight: 0.5 },
                adressage: { filled: hasItems(data.adressage), weight: 0.5 },
                pieces: { filled: hasItems(data.pieces), weight: 0.5 },
                travaux_prevoir: { filled: hasItems(data.travaux_prevoir), weight: 0.5 },
                reserves: { filled: hasItems(data.reserves), weight: 0.5 },
                remarques: { filled: isFilled(data.remarques), weight: 0.5 },
                photos: { filled: !!(window.reportPhotos && window.reportPhotos.length > 0), weight: 0.5 }
            };
            
            // Calculate weighted percentage
            let totalWeight = 0;
            let filledWeight = 0;
            const filledFields = [];
            const missingFields = [];
            
            for (const [key, check] of Object.entries(fieldChecks)) {
                totalWeight += check.weight;
                if (check.filled) {
                    filledWeight += check.weight;
                    filledFields.push(key);
                } else {
                    missingFields.push(key);
                }
            }
            
            const percentage = Math.round((filledWeight / totalWeight) * 100);
            
            return {
                fields: fieldChecks,
                filledFields,
                missingFields,
                filled: filledFields.length,
                total: Object.keys(fieldChecks).length,
                percentage: percentage,
                isComplete: percentage >= 85,
                status: percentage >= 85 ? 'complet' : (percentage >= 50 ? 'en_cours' : 'debut')
            };
        }
        
        // Build partial report from conversation
        // Called when we detect report-relevant info in the chat
        function buildPartialReport() {
            // Get info from chatHistory  scan BOTH panels for report data
            const history = [...(chatHistory.assistant || []), ...(chatHistory.copilot || [])];
            const userMessages = history.filter(m => m.role === 'user').map(m => m.content);
            const aiMessages = history.filter(m => m.role === 'assistant').map(m => m.content);
            const allText = userMessages.join(' ').toLowerCase();
            const allTextOriginal = userMessages.join(' ');
            
            // If no messages yet, don't show anything
            if (userMessages.length === 0) {
                return;
            }
            
            // Get brand display name
            const brandNames = {
                'mitsubishi': 'Mitsubishi Electric',
                'daikin': 'Daikin',
                'carrier': 'Carrier',
                'lg': 'LG',
                'samsung': 'Samsung',
                'panasonic': 'Panasonic',
                'toshiba': 'Toshiba',
                'fujitsu': 'Fujitsu',
                'hitachi': 'Hitachi',
                'general': 'Multi-marques'
            };
            
            // Start with base data (R5: deep copy to prevent mutation of lastReportData)
            let partialData = lastReportData ? JSON.parse(JSON.stringify(lastReportData)) : {
                brand: brandNames[brand] || brand,
                brand_key: brand,
                status: 'en_cours',
                date: new Date().toLocaleDateString('fr-FR')
            };
            
            // 
            // PARSE AI RESPONSES FOR STRUCTURED DATA
            // The AI should return JSON blocks with report data
            // 
            
            for (const aiMsg of aiMessages) {
                // Look for JSON in AI responses (between ```json and ``` or raw JSON)
                const jsonMatches = aiMsg.match(/```json\s*([\s\S]*?)\s*```/g) || [];
                for (const jsonBlock of jsonMatches) {
                    try {
                        const jsonContent = jsonBlock.replace(/```json\s*/, '').replace(/\s*```/, '');
                        const parsed = JSON.parse(jsonContent);
                        if (parsed.report_data || parsed.extraction) {
                            const data = parsed.report_data || parsed.extraction;
                            mergeReportData(partialData, data);
                        }
                    } catch (e) {
                        // Not valid JSON, continue
                    }
                }
                
                // Also check for inline JSON objects
                const inlineJsonMatch = aiMsg.match(/\[REPORT_DATA\]([\s\S]*?)\[\/REPORT_DATA\]/);
                if (inlineJsonMatch) {
                    try {
                        const data = JSON.parse(inlineJsonMatch[1]);
                        mergeReportData(partialData, data);
                    } catch (e) {
                        // Not valid JSON
                    }
                }
            }
            
            // 
            // INTELLIGENT TEXT EXTRACTION (Fallback)
            // 
            
            // Detect type intervention (R5: correction-priority, compound types first)
            {
                let detected = null;
                const corrMatch = allText.match(/(?:en fait|correction|plutt|non c'?est)[^.]{0,50}?(maintenance prventive avec dpannage|maintenance prventive|dpannage|mise en service|installation|diagnostic)/i);
                if (corrMatch) {
                    detected = corrMatch[1].charAt(0).toUpperCase() + corrMatch[1].slice(1);
                } else if (allText.includes('maintenance prventive') && (allText.includes('dpannage') || allText.includes('panne'))) {
                    detected = 'Maintenance prventive avec dpannage';
                } else if (allText.includes('maintenance prventive')) {
                    detected = 'Maintenance prventive';
                } else if (allText.includes('mise en service') || allText.match(/\bmes\b/)) {
                    detected = 'Mise en service';
                } else if (allText.includes('maintenance') || allText.includes('entretien')) {
                    detected = 'Maintenance';
                } else if (allText.includes('dpannage') || allText.includes('sav') || allText.includes('panne')) {
                    detected = 'SAV / Dpannage';
                } else if (allText.includes('installation')) {
                    detected = 'Installation';
                }
                if (detected) partialData.type_intervention = detected;
            }
            
            // Detect client
            if (!partialData.client?.societe) {
                const clientPatterns = [
                    /(?:chez|client|socit|pour)\s+([A-Z-][a-z-A-Z-\s]{2,40})/i,
                    /(?:client|socit)\s*:\s*([^\n,]+)/i
                ];
                for (const pattern of clientPatterns) {
                    const match = allTextOriginal.match(pattern);
                    if (match) {
                        partialData.client = partialData.client || {};
                        partialData.client.societe = match[1].trim();
                        break;
                    }
                }
            }
            
            // Detect address
            if (!partialData.site?.adresse) {
                const addressMatch = allTextOriginal.match(/(\d{1,4}[\s,]+(?:rue|avenue|boulevard|bd|av|alle|place|chemin)[\s\w\-'']+)/i);
                if (addressMatch) {
                    partialData.site = partialData.site || {};
                    partialData.site.adresse = addressMatch[1].trim();
                }
            }
            
            // Detect city
            if (!partialData.site?.ville) {
                const cityMatch = allTextOriginal.match(/(\d{5})\s*([A-Z-a-z-\s\-]+)/);
                if (cityMatch) {
                    partialData.site = partialData.site || {};
                    partialData.site.ville = cityMatch[1] + ' ' + cityMatch[2].trim();
                }
            }
            
            //  IMPROVED ERROR CODE DETECTION (R5: incremental  always scan for new codes) 
            {
                const existingCodes = new Set((partialData.codes_defaut || []).map(c => c.code));
                const codePatterns = [
                    // Explicit mentions
                    /(?:code|erreur|dfaut|fault|error)\s*(?:code)?\s*:?\s*([A-Z]?\d{2,5}[A-Z]?)/gi,
                    // Mitsubishi patterns
                    /\b([7][0-9]{3})\b/g, // 7xxx codes
                    /\b([EAUFPH]\d{1,3})\b/gi,
                    /\b(U\d{1,2})\b/gi,
                    // Carrier/Daikin patterns
                    /\b([AUELJ][0-9]{1,3})\b/gi,
                    // Generic patterns
                    /(?:affiche|indique|montre)\s+(?:le\s+)?(?:code\s+)?([A-Z0-9]{2,6})/gi
                ];
                
                const foundCodes = new Set();
                for (const pattern of codePatterns) {
                    let match;
                    while ((match = pattern.exec(allTextOriginal)) !== null) {
                        const code = match[1].toUpperCase();
                        // Avoid false positives (dates, common numbers)
                        if (!/^(2024|2025|0[1-9]|1[0-2])$/.test(code)) {
                            foundCodes.add(code);
                        }
                    }
                }
                
                if (foundCodes.size > 0) {
                    if (!partialData.codes_defaut) partialData.codes_defaut = [];
                    for (const code of foundCodes) {
                        if (!existingCodes.has(code)) {
                            partialData.codes_defaut.push({ code, description: '' });
                        }
                    }
                }
            }
            
            //  IMPROVED MODEL DETECTION 
            if (!partialData.systeme?.modele) {
                const modelPatterns = [
                    // Mitsubishi
                    /(PUHY|PURY|PUMY|PEFY|PLFY|PKFY|MSZ|MUZ|FDC|FDCA)[\s\-]?([A-Z0-9\-]{3,20})/gi,
                    // Daikin
                    /(FXMQ|FXAQ|FXZQ|FDXM|RXM|RXYQ|RXYSQ)[\s\-]?([A-Z0-9]{2,15})/gi,
                    // Carrier
                    /(38VT|30RB|30XA|42N)[\s\-]?([A-Z0-9]{3,15})/gi,
                    // VRF/VRV generic
                    /(VRV|VRF|DVM|MULTI[\s\-]?V)[\s\-]?([A-Z0-9\-]{0,15})/gi
                ];
                
                for (const pattern of modelPatterns) {
                    const match = pattern.exec(allTextOriginal);
                    if (match) {
                        partialData.systeme = partialData.systeme || {};
                        partialData.systeme.modele = match[0].toUpperCase().trim();
                        // Determine type based on prefix
                        const prefix = match[1].toUpperCase();
                        if (['PUHY', 'PURY', 'PUMY', 'RXYQ', 'VRV', 'VRF', 'DVM', '38VT'].includes(prefix)) {
                            partialData.systeme.type = 'VRF';
                        } else if (['PEFY', 'PLFY', 'FXMQ', 'FXAQ'].includes(prefix)) {
                            partialData.systeme.type = 'Unit intrieure';
                        } else {
                            partialData.systeme.type = 'Split';
                        }
                        break;
                    }
                }
            }
            
            //  ADRESSAGE TABLE DETECTION 
            // Look for structured data like "UI01: PEFY-P25VMS1-E / Srie: xxx / Adr: 01"
            if (!partialData.adressage || partialData.adressage.length === 0) {
                // Pattern for structured unit listings
                const adressagePatterns = [
                    // "UI01: PEFY-P25 - Srie 12345 - Adresse 01 - Salle runion"
                    /(?:UI|UE|BC|SC)\s*(\d{1,2})\s*:?\s*([A-Z0-9\-]+)\s*[-]\s*(?:srie|serial|s\/n)\s*:?\s*([A-Z0-9]+)\s*[-]\s*(?:adr(?:esse)?|@)\s*:?\s*(\d{1,3})\s*(?:[-]\s*(.+?))?(?:\n|$)/gi,
                    // Simpler: "PEFY-P25 / 12345 / 01 / Salle"
                    /([A-Z]{2,5}[\-]?[A-Z]?\d{1,3}[A-Z0-9\-]*)\s*[\/|]\s*([A-Z0-9]{5,15})\s*[\/|]\s*(\d{1,3})\s*(?:[\/|]\s*(.+?))?(?:\n|$)/gi
                ];
                
                const units = [];
                for (const pattern of adressagePatterns) {
                    let match;
                    while ((match = pattern.exec(allTextOriginal)) !== null) {
                        units.push({
                            ref_usine: match[1] || match[2] || '',
                            serie: match[2] || match[3] || '',
                            adresse: match[3] || match[4] || '',
                            designation: match[4] || match[5] || '',
                            commentaire: match[5] || ''
                        });
                    }
                }
                
                // Also look for table-like data (lines with consistent separators)
                const lines = allTextOriginal.split('\n');
                for (const line of lines) {
                    // Check if line has multiple parts separated by / or |
                    const parts = line.split(/[\/\|]/).map(p => p.trim()).filter(p => p.length > 0);
                    if (parts.length >= 3 && parts.some(p => /[A-Z]{2,}[\-]?\d/.test(p))) {
                        units.push({
                            ref_usine: parts[0] || '',
                            serie: parts[1] || '',
                            adresse: parts[2] || '',
                            designation: parts[3] || '',
                            commentaire: parts[4] || ''
                        });
                    }
                }
                
                if (units.length > 0) {
                    partialData.adressage = units;
                }
            }
            
            //  FIX MALFORMED ADRESSAGE FROM BACKEND 
            // If adressage exists but has malformed entries (raw text dumps), try to extract UI data
            if (partialData.adressage && partialData.adressage.length > 0) {
                const firstEntry = partialData.adressage[0];
                const equipId = firstEntry.equipement_id || firstEntry.ref_usine || '';
                
                // Detect if this is a raw text dump (contains keywords like "adressage", "SW1", long strings)
                if (equipId.length > 50 || /adressage|SW1|Soft:|Code \d{3}|verif electrique/i.test(equipId)) {
                    console.log('[Drawer] Detected malformed adressage, attempting to parse from conversation...');
                    
                    // Try to parse UI data from conversation text
                    // Pattern: "UI01 PLFY-P15VFM-E1 serie 42M01760 - bureau 1"
                    const uiPattern = /UI(\d{1,2})\s+([A-Z]{2,4}Y?-[A-Z0-9\-]+)\s+(?:serie|srie|n|s\/n)?\s*([A-Z0-9]+)\s*[-]?\s*(.+?)(?=UI\d|$)/gi;
                    
                    const extractedUnits = [];
                    let match;
                    while ((match = uiPattern.exec(allTextOriginal)) !== null) {
                        extractedUnits.push({
                            adresse: match[1].padStart(2, '0'),
                            modele: match[2],
                            numero_serie: match[3],
                            designation: (match[4] || '').trim(),
                            zone: (match[4] || '').trim()
                        });
                    }
                    
                    // Also try simpler pattern: "01 PLFY-P15VFM-E1 bureau 1"
                    if (extractedUnits.length === 0) {
                        const simplePattern = /(\d{1,2})\s+([A-Z]{2,4}Y?-[A-Z0-9\-]+)\s+(.+?)(?=\d{1,2}\s+[A-Z]|$)/gi;
                        while ((match = simplePattern.exec(allTextOriginal)) !== null) {
                            extractedUnits.push({
                                adresse: match[1].padStart(2, '0'),
                                modele: match[2],
                                designation: (match[3] || '').trim(),
                                zone: (match[3] || '').trim()
                            });
                        }
                    }
                    
                    if (extractedUnits.length > 0) {
                        console.log(`[Drawer] Extracted ${extractedUnits.length} units from conversation`);
                        partialData.adressage = extractedUnits;
                    } else {
                        // Clear malformed data to avoid showing garbage
                        console.log('[Drawer] Could not parse units, clearing malformed adressage');
                        partialData.adressage = [];
                    }
                }
            }
            
            // Detect fluide
            if (!partialData.fluide?.type) {
                const fluideMatch = allText.match(/(r410a|r32|r134a|r407c|r290|r744)/i);
                if (fluideMatch) {
                    partialData.fluide = partialData.fluide || {};
                    partialData.fluide.type = fluideMatch[1].toUpperCase();
                }
            }

            // R5: Charge totale  LAST occurrence = correction du technicien
            {
                let lastCharge = null;
                const reCharge = /charge\s+totale\s*(?:de\s+|:\s*|(?:c'?est|cest)\s+)?(\d+[\.,]?\d*)\s*kg/gi;
                let cm; while ((cm = reCharge.exec(allText)) !== null) lastCharge = cm[1].replace(',', '.');
                if (lastCharge) { partialData.fluide = partialData.fluide || {}; partialData.fluide.charge_totale = lastCharge; }
            }
            // R5: Charge usine (fill-gaps only)
            {
                const cu = allText.match(/charge\s+(?:usine|initiale)\s*(?:de\s+|:\s*)?(\d+[\.,]?\d*)\s*kg/i);
                if (cu) { partialData.fluide = partialData.fluide || {}; if (!partialData.fluide.charge_initiale) partialData.fluide.charge_initiale = cu[1].replace(',', '.'); }
            }
            // R5: Heures d'intervention
            {
                const rh = allText.match(/(?:intervention|arriv[e]e?|de)\s+(?:[a]\s+)?(\d{1,2})\s*[h:]\s*(\d{0,2})\s*(?:[a]|-)\s*(\d{1,2})\s*[h:]\s*(\d{0,2})/i);
                if (rh) {
                    partialData.technicien = partialData.technicien || {};
                    partialData.technicien.heure_arrivee = rh[1].padStart(2,'0') + ':' + (rh[2]||'00').padStart(2,'0');
                    partialData.technicien.heure_depart = rh[3].padStart(2,'0') + ':' + (rh[4]||'00').padStart(2,'0');
                } else {
                    const rd = allText.match(/(?:fini|termin[e]|parti|d[e]part)\s+(?:[a]\s+)?(\d{1,2})\s*[h:]\s*(\d{0,2})/i);
                    if (rd) { partialData.technicien = partialData.technicien || {}; partialData.technicien.heure_depart = rd[1].padStart(2,'0') + ':' + (rd[2]||'00').padStart(2,'0'); }
                }
            }
            // R5: Rsultat d'intervention
            {
                const rr = allText.match(/r[e]sultat\s*:\s*(.+?)(?:\.\s|$)/im);
                if (rr) {
                    partialData.resultat = partialData.resultat || {};
                    const rt = rr[1].trim();
                    partialData.resultat.description = rt;
                    if (/r[e]solu|corrig[e]/i.test(rt) && !/non|persiste/i.test(rt)) partialData.resultat.status = 'resolu';
                    else if (/persiste|partiel|attente|reprise/i.test(rt)) partialData.resultat.status = 'en_attente_pieces';
                    else if (/non.*r[e]solu|impossible/i.test(rt)) partialData.resultat.status = 'non_resolu';
                }
            }

            // Update the stored data and refresh preview  (FIX-3: Don't overwrite extraction data)
            if (!lastReportData || Object.keys(lastReportData).length <= 4) {
                // Only use partial data if lastReportData is empty/minimal (brand, brand_key, status, date)
                lastReportData = partialData;
            } else {
                // Merge partial data INTO existing data (don't replace)
                lastReportData = unifiedMerge(lastReportData, partialData);
            }
            updateDrawerPreview(lastReportData);
        }
        
        // 
        // R4-FIX3: normalizeMesureLabel  Alias map for mesure dedup
        // 
        const MESURE_ALIAS_MAP = {
            'temprature': 'temperature', 'temperature': 'temperature', 'temp': 'temperature', 'temp.': 'temperature',
            'pression hp': 'pression_hp', 'hp': 'pression_hp', 'haute pression': 'pression_hp', 'high pressure': 'pression_hp', 'pression haute': 'pression_hp',
            'pression bp': 'pression_bp', 'bp': 'pression_bp', 'basse pression': 'pression_bp', 'low pressure': 'pression_bp', 'pression basse': 'pression_bp',
            'surchauffe': 'surchauffe', 'sh': 'surchauffe', 'superheat': 'surchauffe', 'surchauffe compresseur': 'surchauffe',
            'sous-refroidissement': 'sous_refroidissement', 'sous refroidissement': 'sous_refroidissement', 'sr': 'sous_refroidissement', 'subcooling': 'sous_refroidissement',
            'intensit': 'intensite', 'intensite': 'intensite', 'amprage': 'intensite', 'amperage': 'intensite', 'courant': 'intensite',
            'tension': 'tension', 'voltage': 'tension',
            'delta t': 'delta_t', 't': 'delta_t', 'deltat': 'delta_t', 'ecart': 'delta_t', 'cart': 'delta_t',
            'dbit': 'debit', 'debit': 'debit', 'flow': 'debit',
            'hygromtrie': 'hygrometrie', 'hygrometrie': 'hygrometrie', 'humidit': 'hygrometrie', 'humidite': 'hygrometrie', 'humidity': 'hygrometrie',
            'temprature soufflage': 'temp_soufflage', 'temp soufflage': 'temp_soufflage', 'temperature soufflage': 'temp_soufflage', 'soufflage': 'temp_soufflage',
            'temprature reprise': 'temp_reprise', 'temp reprise': 'temp_reprise', 'temperature reprise': 'temp_reprise', 'reprise': 'temp_reprise',
            'temprature extrieure': 'temp_ext', 'temp ext': 'temp_ext', 'temp extrieure': 'temp_ext', 'temp. ext.': 'temp_ext', 'temperature exterieure': 'temp_ext',
            'temprature ambiante': 'temp_ambiante', 'temp ambiante': 'temp_ambiante', 'temperature ambiante': 'temp_ambiante', 'ambiance': 'temp_ambiante', 'frequence compresseur': 'frequence_compresseur', 'frequency compresseur': 'frequence_compresseur', 'freq compresseur': 'frequence_compresseur'
        };

        function normalizeMesureLabel(label) {
            if (!label) return '';
            const lower = label.toLowerCase().trim()
                .replace(/[]/g, 'e').replace(/[]/g, 'a').replace(/[]/g, 'u').replace(/[]/g, 'o').replace(/[]/g, 'i').replace(/[]/g, 'c')
                .replace(/[_]/g, ' ')
                .replace(/\s+/g, ' ');
            return MESURE_ALIAS_MAP[lower] || lower;
        }

        // 
        // FIX-1: normalizeReportData  Ensures BOTH chat AND extraction field names exist
        // 
        function normalizeReportData(data) {
            if (!data || typeof data !== 'object') return data;

            // 1. FLUIDE  FLUIDE_GLOBAL  ROOT (3-way sync)
            // R4-FIX1: Also sync charge_totale/usine/appoint at root level
            const isValidFluide = v => v != null && v !== '' && v !== 'non_precise' && v !== 'Non prcis' && v !== 'non prcis';
            const cleanKg = v => String(v).replace(/\s*kg\s*kg/gi, ' kg').replace(/\s*kg$/i, '').trim();
            const parseKg = v => { const n = parseFloat(String(v).replace(/[^\d.]/g, '')); return isNaN(n) ? null : n; };

            // Ensure containers exist
            if (!data.fluide) data.fluide = {};
            if (!data.fluide_global) data.fluide_global = {};

            // R4-FIX1: Collect from root-level fields into fluide (some extractions put charge at root)
            if (isValidFluide(data.charge_totale) && !data.fluide.charge_totale)
                data.fluide.charge_totale = String(data.charge_totale);
            if (isValidFluide(data.charge_usine) && !data.fluide.charge_initiale)
                data.fluide.charge_initiale = String(data.charge_usine);
            if (isValidFluide(data.charge_appoint) && !data.fluide.charge_appoint)
                data.fluide.charge_appoint = String(data.charge_appoint);

            // R3-Fix3: Sync fluide  fluide_global FIRST (chat corrections win)
            if (isValidFluide(data.fluide.type)) {
                data.fluide_global.type = data.fluide.type;
            }
            if (data.fluide.charge_totale) {
                const num = parseKg(data.fluide.charge_totale);
                if (num !== null) data.fluide_global.charge_totale_site_kg = num;
            }
            if (data.fluide.charge_initiale) {
                const num = parseKg(data.fluide.charge_initiale);
                if (num !== null) data.fluide_global.charge_usine_kg = num;
            }
            if (data.fluide.charge_appoint) {
                const num = parseKg(data.fluide.charge_appoint);
                if (num !== null) data.fluide_global.charge_appoint_kg = num;
            }

            // fluide_global  fluide (fill gaps only)
            if (isValidFluide(data.fluide_global.type) && !isValidFluide(data.fluide.type))
                data.fluide.type = data.fluide_global.type;
            if (isValidFluide(data.fluide_global.charge_usine_kg) && !data.fluide.charge_initiale)
                data.fluide.charge_initiale = String(data.fluide_global.charge_usine_kg);
            if (isValidFluide(data.fluide_global.charge_totale_site_kg) && !data.fluide.charge_totale)
                data.fluide.charge_totale = String(data.fluide_global.charge_totale_site_kg);
            if (isValidFluide(data.fluide_global.charge_appoint_kg) && !data.fluide.charge_appoint)
                data.fluide.charge_appoint = String(data.fluide_global.charge_appoint_kg);

            // Clean double "kg" in fluide values
            if (data.fluide.charge_totale) data.fluide.charge_totale = cleanKg(data.fluide.charge_totale);
            if (data.fluide.charge_initiale) data.fluide.charge_initiale = cleanKg(data.fluide.charge_initiale);
            if (data.fluide.charge_appoint) data.fluide.charge_appoint = cleanKg(data.fluide.charge_appoint);

            // Final sync: fluide  fluide_global (ensure numeric copies are consistent after clean)
            if (isValidFluide(data.fluide.charge_totale) && !data.fluide_global.charge_totale_site_kg) {
                const num = parseKg(data.fluide.charge_totale);
                if (num !== null) data.fluide_global.charge_totale_site_kg = num;
            }
            if (isValidFluide(data.fluide.charge_initiale) && !data.fluide_global.charge_usine_kg) {
                const num = parseKg(data.fluide.charge_initiale);
                if (num !== null) data.fluide_global.charge_usine_kg = num;
            }
            if (isValidFluide(data.fluide.charge_appoint) && !data.fluide_global.charge_appoint_kg) {
                const num = parseKg(data.fluide.charge_appoint);
                if (num !== null) data.fluide_global.charge_appoint_kg = num;
            }

            // R4-FIX1: Sync back to root level for backward compat
            if (isValidFluide(data.fluide.charge_totale)) data.charge_totale = data.fluide.charge_totale;
            if (isValidFluide(data.fluide.charge_initiale)) data.charge_usine = data.fluide.charge_initiale;
            if (isValidFluide(data.fluide.charge_appoint)) data.charge_appoint = data.fluide.charge_appoint;

            // 2. SYSTEME  EQUIPEMENTS (bidirectional)
            if (data.equipements && Array.isArray(data.equipements) && data.equipements.length > 0) {
                if (!data.systeme || !data.systeme.modele) {
                    const mainEquip = data.equipements.find(e =>
                        e.role === 'ue' || e.role === 'outdoor' || e.role === 'unite_exterieure'
                    ) || data.equipements[0];
                    data.systeme = data.systeme || {};
                    if (!data.systeme.modele) data.systeme.modele = mainEquip.modele;
                    if (!data.systeme.type) data.systeme.type = mainEquip.type_ui || mainEquip.role;
                    if (!data.systeme.serie) data.systeme.serie = mainEquip.numero_serie;
                }
            }
            if (data.systeme && data.systeme.modele && (!data.equipements || data.equipements.length === 0)) {
                data.equipements = [{
                    id: 'sys-1',
                    modele: data.systeme.modele,
                    marque: data.brand || data.brand_key || '',
                    role: 'ue',
                    type_ui: data.systeme.type || '',
                    numero_serie: data.systeme.serie || ''
                }];
            }

            // 3. TRAVAUX_EFFECTUES : contenu  texte
            if (data.travaux_effectues && Array.isArray(data.travaux_effectues)) {
                data.travaux_effectues.forEach(t => {
                    if (t.contenu && !t.texte) t.texte = t.contenu;
                    if (t.texte && !t.contenu) t.contenu = t.texte;
                });
            }

            // 4. RESERVES : description  texte
            if (data.reserves && Array.isArray(data.reserves)) {
                data.reserves.forEach(r => {
                    if (typeof r === 'string') return;
                    if (r.description && !r.texte) r.texte = r.description;
                    if (r.texte && !r.description) r.description = r.texte;
                });
                data.reserves = data.reserves.map(r => {
                    if (typeof r === 'string') {
                        return { titre: r.substring(0, 60), texte: r, description: r, type: 'reserve' };
                    }
                    return r;
                });
            }

            // 5. R4-FIX2: Sync type_intervention complete  last non-empty wins across all variants
            // Sources: data.type_intervention, data.intervention.type, .type_label, .type_detail, data.type_operation, data.nature_intervention
            if (!data.intervention) data.intervention = {};

            // Collect all candidate type values (priority order: most specific first)
            const typeCandidates = [
                data.type_intervention,
                data.intervention.type_label,
                data.intervention.type_detail,
                data.intervention.type,
                data.type_operation,
                data.nature_intervention
            ].filter(v => v && typeof v === 'string' && v.trim() !== '');

            // Pick the longest non-empty value (most descriptive = most specific)
            const bestType = typeCandidates.length > 0
                ? typeCandidates.reduce((a, b) => a.length >= b.length ? a : b)
                : '';

            if (bestType) {
                data.type_intervention = bestType;
                data.intervention.type = bestType;
                data.intervention.type_label = bestType;
                // Sync back to alternate root fields
                if (data.type_operation) data.type_operation = bestType;
                if (data.nature_intervention) data.nature_intervention = bestType;
            }

            // 6. MESURES : type  label + normalize labels via alias map
            if (data.mesures && Array.isArray(data.mesures)) {
                data.mesures.forEach(m => {
                    if (m.type && !m.label) m.label = m.sous_type ? `${m.type} - ${m.sous_type}` : m.type;
                    if (m.label && !m.type) m.type = m.label;
                    // Normalize label for consistent dedup
                    if (m.label) m._normalizedLabel = normalizeMesureLabel(m.label);
                    if (m.type) m._normalizedType = normalizeMesureLabel(m.type);
                });
            }

            // 7. ADRESSAGE : normalize all field aliases (FIX-A: + zone/designation, adresse)
            if (data.adressage && Array.isArray(data.adressage)) {
                data.adressage.forEach(a => {
                    // equipement_id  ref_usine  adresse
                    if (a.equipement_id && !a.ref_usine) a.ref_usine = a.equipement_id;
                    if (a.ref_usine && !a.equipement_id) a.equipement_id = a.ref_usine;
                    if (!a.adresse && (a.equipement_id || a.ref_usine)) a.adresse = a.equipement_id || a.ref_usine;
                    // numero_serie  serie
                    if (a.numero_serie && !a.serie) a.serie = a.numero_serie;
                    if (a.serie && !a.numero_serie) a.numero_serie = a.serie;
                    // zone  designation
                    if (a.designation && !a.zone) a.zone = a.designation;
                    if (a.zone && !a.designation) a.designation = a.zone;
                    // model  modele
                    if (a.model && !a.modele) a.modele = a.model;
                    if (a.modele && !a.model) a.model = a.modele;
                });
            }

            // 8. RECOMMANDATIONS : normalize strings to objects
            if (data.recommandations && Array.isArray(data.recommandations)) {
                data.recommandations = data.recommandations.map(r => {
                    if (typeof r === 'string') {
                        return { titre: r.substring(0, 60), description: r, texte: r };
                    }
                    if (r && !r.texte && r.description) r.texte = r.description;
                    if (r && !r.description && r.texte) r.description = r.texte;
                    return r;
                });
            }

            // 9. R4-FIX5: Sync resultat between all variants + fallback conclusion
            // Some extractions use data.conclusion (string), data.status_intervention, data.resultat_intervention
            if (!data.resultat) data.resultat = {};

            // Pull from alternate root-level fields
            if (data.conclusion && typeof data.conclusion === 'string' && !data.resultat.conclusion) {
                data.resultat.conclusion = data.conclusion;
                data.resultat.description = data.resultat.description || data.conclusion;
            }
            if (data.status_intervention && !data.resultat.status) {
                const statusMap = {
                    'rsolu': 'resolu', 'resolu': 'resolu', 'resolved': 'resolu',
                    'non rsolu': 'non_resolu', 'non_resolu': 'non_resolu', 'unresolved': 'non_resolu',
                    'en cours': 'en_cours', 'en_cours': 'en_cours', 'in_progress': 'en_cours',
                    'en attente': 'en_attente_pieces', 'en_attente_pieces': 'en_attente_pieces'
                };
                const mapped = statusMap[(data.status_intervention || '').toLowerCase().trim()];
                if (mapped) data.resultat.status = mapped;
                else data.resultat.status = data.status_intervention;
            }
            if (data.resultat_intervention && typeof data.resultat_intervention === 'string') {
                if (!data.resultat.description) data.resultat.description = data.resultat_intervention;
                if (!data.resultat.conclusion) data.resultat.conclusion = data.resultat_intervention;
            }

            // Fallback: conclusion  description (keep both in sync)
            if (data.resultat.description && !data.resultat.conclusion) {
                data.resultat.conclusion = data.resultat.description;
            }
            if (data.resultat.conclusion && !data.resultat.description) {
                data.resultat.description = data.resultat.conclusion;
            }

            // Clean duplicate prefixes
            if (data.resultat.description) {
                data.resultat.description = data.resultat.description
                    .replace(/^(Conclusion\s*:\s*)+/i, '')
                    .replace(/^(Statut\s*:\s*)+/i, '')
                    .replace(/^(Description\s*:\s*)+/i, '')
                    .trim();
            }
            if (data.resultat.conclusion) {
                data.resultat.conclusion = data.resultat.conclusion
                    .replace(/^(Conclusion\s*:\s*)+/i, '')
                    .trim();
            }
            if (data.resultat.status) {
                if (typeof data.resultat.status === 'string') {
                    data.resultat.status = data.resultat.status.replace(/^(Statut\s*:\s*)+/i, '').trim();
                }
            }

            // Sync back to root for backward compat
            if (data.resultat.conclusion) data.conclusion = data.resultat.conclusion;
            if (data.resultat.status) data.status_intervention = data.resultat.status;

            // 10. R3-Fix6: TECHNICIEN  clean HH:MM placeholders
            if (data.technicien) {
                ['heure_arrivee', 'heure_depart'].forEach(k => {
                    if (data.technicien[k] === 'HH:MM' || data.technicien[k] === 'hh:mm' || data.technicien[k] === '') {
                        delete data.technicien[k];
                    }
                });
            }

            return data;
        }

        // 
        // FIX-2: unifiedMerge  Single merge strategy for all data sources
        // 
        // FIX-B: Arrays that should be REPLACED (not accumulated) when source is non-empty
        // R4-FIX4: Removed 'reserves'  now uses smart dedup instead of replace
        const REPLACE_ARRAYS = new Set(['travaux_effectues', 'travaux_prevoir', 'recommandations']);

        function unifiedMerge(target, source) {
            if (!source || typeof source !== 'object') return target;
            if (!target || typeof target !== 'object') return { ...source };

            const result = { ...target };

            for (const key of Object.keys(source)) {
                const sourceVal = source[key];
                const targetVal = result[key];

                if (sourceVal == null) continue;
                if (key === '_metadata') continue;

                if (Array.isArray(sourceVal)) {
                    if (sourceVal.length === 0) continue;  // Don't overwrite with empty
                    if (REPLACE_ARRAYS.has(key) && sourceVal.some(item => item != null)) {
                        // FIX-B: Replace entirely  extraction sends the full authoritative list
                        result[key] = [...sourceVal];
                    } else if (!Array.isArray(targetVal) || targetVal.length === 0) {
                        result[key] = [...sourceVal];
                    } else {
                        result[key] = deduplicateArray(key, targetVal, sourceVal);
                    }
                } else if (typeof sourceVal === 'object' && typeof targetVal === 'object') {
                    result[key] = unifiedMerge(targetVal, sourceVal);
                } else if (sourceVal !== '' && sourceVal !== null && sourceVal !== undefined) {
                    result[key] = sourceVal;  // LAST-WRITE-WINS for primitives
                }
            }

            return result;
        }

        function deduplicateArray(fieldName, existing, incoming) {
            const combined = [...existing, ...incoming];
            let keyFn;
            switch (fieldName) {
                case 'equipements':
                    keyFn = item => {
                        if (typeof item === 'string') return item;
                        const model = (item.modele || '').toUpperCase().replace(/-[A-Z]\d*$/, '');
                        return `${model}|${item.role || ''}`;
                    };
                    break;
                case 'adressage':
                    // FIX-A: Robust dedup  normalize UI01UI1, match on adresse OR equipement_id
                    keyFn = item => {
                        if (typeof item === 'string') return item;
                        const raw = (item.equipement_id || item.ref_usine || item.adresse || '').toUpperCase().trim();
                        // Normalize: UI01  UI1, UE01  UE1, etc.
                        const normalized = raw.replace(/([A-Z]+)0*(\d+)/g, '$1$2');
                        // Also include modele to differentiate different equipment at same address
                        return normalized || (item.modele || '').toUpperCase();
                    };
                    break;
                case 'mesures':
                    // R4-FIX3: Use normalizeMesureLabel for robust dedup across label variants
                    keyFn = item => {
                        if (typeof item === 'string') return normalizeMesureLabel(item);
                        const normalized = item._normalizedLabel || item._normalizedType || normalizeMesureLabel(item.label || item.type || '');
                        const equipId = (item.equipement_id || '').toUpperCase().replace(/([A-Z]+)0*(\d+)/g, '$1$2');
                        return `${normalized}|${equipId}`;
                    };
                    break;
                case 'codes_defaut':
                    keyFn = item => {
                        if (typeof item === 'string') return item;
                        return (item.code || '').toUpperCase();
                    };
                    break;
                case 'travaux_effectues':
                case 'travaux_prevoir':
                    keyFn = item => {
                        if (typeof item === 'string') return item;
                        const text = (item.texte || item.contenu || item.titre || '').substring(0, 50).toLowerCase();
                        return text;
                    };
                    break;
                case 'reserves':
                    // R5: Smart dedup  strip accents + French articles for fuzzy match
                    keyFn = item => {
                        const raw = typeof item === 'string' ? item : (item.texte || item.description || item.titre || '');
                        return raw.toLowerCase()
                            .replace(/[]/g,'e').replace(/[]/g,'a').replace(/[]/g,'u').replace(/[]/g,'o').replace(/[]/g,'i').replace(/[]/g,'c')
                            .replace(/\b(de|du|des|la|le|les|l'|d'|un|une|et|ou|sur|en|dans|pour|par|avec)\b/g,'')
                            .replace(/[^a-z0-9]/g,'')
                            .substring(0, 60);
                    };
                    break;
                case 'recommandations':
                    keyFn = item => {
                        if (typeof item === 'string') return item.substring(0, 50).toLowerCase();
                        const text = (item.titre || item.texte || item.description || '').substring(0, 50).toLowerCase();
                        return text;
                    };
                    break;
                default:
                    keyFn = item => JSON.stringify(item);
            }

            const map = new Map();
            for (const item of combined) {
                const key = keyFn(item);
                if (key) map.set(key, item);
            }
            return Array.from(map.values());
        }

        // 
        // FIX-4: debouncedSaveExtractedData  Centralized debounced Supabase write
        // 
        let _saveTimeout = null;
        let _pendingSaveData = null;

        function debouncedSaveExtractedData(data, progressOverride) {
            _pendingSaveData = { data, progressOverride };

            if (_saveTimeout) clearTimeout(_saveTimeout);

            _saveTimeout = setTimeout(async () => {
                const { data: saveData, progressOverride: prog } = _pendingSaveData;
                _pendingSaveData = null;

                if (!currentProjectId || !saveData) return;

                try {
                    const updatePayload = {
                        extracted_data: saveData,
                        updated_at: new Date().toISOString()
                    };

                    if (prog != null) {
                        updatePayload.progress = Math.round(prog);
                        if (prog >= 90) {
                            updatePayload.completion_status = 'completed';
                            updatePayload.completed_at = new Date().toISOString();
                        }
                    }

                    const { error } = await db.from('projects')
                        .update(updatePayload)
                        .eq('id', currentProjectId);

                    if (error) console.error('[debouncedSave] Error:', error);
                    else console.log('[debouncedSave]  Saved to Supabase');
                } catch (err) {
                    console.error('[debouncedSave] Exception:', err);
                }
            }, 800);
        }

        // Merge incoming data into existing report data (R5: last-write-wins + dedup arrays)
        function mergeReportData(target, source) {
            if (!source) return;
            for (const [key, value] of Object.entries(source)) {
                if (value === null || value === undefined || value === '') continue;
                if (Array.isArray(value)) {
                    if (!target[key]) target[key] = [];
                    if (Array.isArray(target[key])) {
                        if (REPLACE_ARRAYS.has(key)) {
                            if (value.length > 0) target[key] = [...value];
                        } else {
                            target[key] = deduplicateArray(key, target[key], value);
                        }
                    }
                } else if (typeof value === 'object') {
                    if (!target[key]) target[key] = {};
                    if (typeof target[key] === 'object' && !Array.isArray(target[key])) {
                        mergeReportData(target[key], value);
                    }
                } else {
                    target[key] = value;  // R5: LAST-WRITE-WINS  corrections crasent les anciennes valeurs
                }
            }
        }
        
        // Render EDITABLE report template for drawer
        // Comprehensive structure based on Mitsubishi MES/VC reports
        function renderReportPreview(data, completionStatus) {
            const reportData = data || {};
            
            const brandNames = {
                'mitsubishi': 'Mitsubishi Electric',
                'daikin': 'Daikin',
                'carrier': 'Carrier',
                'lg': 'LG',
                'samsung': 'Samsung',
                'panasonic': 'Panasonic',
                'toshiba': 'Toshiba',
                'fujitsu': 'Fujitsu',
                'hitachi': 'Hitachi',
                'general': 'Multi-marques'
            };
            
            const brandClass = reportData.brand_key || brand || 'general';
            const brandName = brandNames[brandClass] || reportData.brand || brandNames[brand] || 'FixAIR';
            const today = new Date().toLocaleDateString('fr-FR');
            const now = new Date().toLocaleTimeString('fr-FR', {hour: '2-digit', minute: '2-digit'});
            
            // Helper to create editable field
            const editableField = (key, value, placeholder, isTextarea = false) => {
                const hasValue = value && value.trim && value.trim() !== '';
                const displayValue = hasValue ? value : '';
                const placeholderAttr = placeholder ? `data-placeholder="${placeholder}"` : '';
                const emptyClass = hasValue ? '' : 'empty';
                const tag = isTextarea ? 'div' : 'span';
                return `<${tag} class="editable-field ${emptyClass}" contenteditable="true" data-field="${key}" ${placeholderAttr}>${displayValue}</${tag}>`;
            };
            
            // Helper for nested fields
            const editableNested = (parent, key, value, placeholder) => {
                const hasValue = value && value.trim && value.trim() !== '';
                const displayValue = hasValue ? value : '';
                const emptyClass = hasValue ? '' : 'empty';
                return `<span class="editable-field ${emptyClass}" contenteditable="true" data-field="${parent}.${key}" data-placeholder="${placeholder}">${displayValue}</span>`;
            };
            
            // Helper for styled dropdown that looks like text
            const styledSelect = (key, value, options, defaultText) => {
                const hasValue = value && value !== '';
                
                // Display label mapping (internal value -> display text)
                const displayLabels = {
                    'en_cours': 'En cours',
                    'conforme': 'Conforme', 
                    'non_conforme': 'Non conforme',
                    'resolu': ' Rsolu',
                    'en_attente': ' En attente',
                    'non_resolu': ' Non rsolu',
                    'SAV / Dpannage': 'SAV / Dpannage',
                    'Mise en service': 'Mise en service',
                    'Maintenance': 'Maintenance',
                    'Installation': 'Installation',
                    'Visite constructeur': 'Visite constructeur',
                    'Sous garantie': 'Sous garantie',
                    'Hors garantie': 'Hors garantie',
                    'R410A': 'R410A',
                    'R32': 'R32',
                    'R134a': 'R134a',
                    'R407C': 'R407C',
                    'R290': 'R290',
                    'R744': 'R744',
                    'OK': 'OK',
                    ' surveiller': ' surveiller',
                    'Critique': 'Critique'
                };
                
                const displayValue = hasValue ? (displayLabels[value] || value) : defaultText;
                const emptyClass = hasValue ? '' : 'empty';
                const optionsHtml = options.map(opt => {
                    const optLabel = displayLabels[opt] || opt;
                    return `<option value="${opt}" ${value === opt ? 'selected' : ''}>${optLabel}</option>`;
                }).join('');
                return `<div class="styled-select-wrapper ${emptyClass}" data-value="${value || ''}">
                    <span class="styled-select-display">${displayValue}</span>
                    <select class="styled-select-hidden" data-field="${key}" onchange="updateReportField('${key}', this.value); this.previousElementSibling.textContent = this.options[this.selectedIndex].text || '${defaultText}'; this.parentElement.classList.toggle('empty', !this.value); this.parentElement.setAttribute('data-value', this.value);">
                        <option value="">${defaultText}</option>
                        ${optionsHtml}
                    </select>
                </div>`;
            };
            
            // Status display helper
            const getStatusDisplay = (status) => {
                const statusMap = {
                    'en_cours': { text: 'En cours', class: 'en-cours' },
                    'conforme': { text: 'Conforme', class: 'conforme' },
                    'non_conforme': { text: 'Non conforme', class: 'non-conforme' }
                };
                return statusMap[status] || statusMap['en_cours'];
            };
            
            const statusInfo = getStatusDisplay(reportData.status);
            
            let html = `<div class="rpt editable-report" style="margin:0;">`;
            
            // 
            // SECTION 1: HEADER - Identification & Status
            // 
            html += `
            <div class="rpt-header">
                <div class="rpt-header-top">
                    <div>
                        <div class="rpt-brand ${brandClass}">${brandName}</div>
                        <h1 class="rpt-title">Rapport d'intervention</h1>
                    </div>
                    <div class="rpt-status-wrapper">
                        ${styledSelect('status', reportData.status, ['en_cours', 'conforme', 'non_conforme'], 'Statut')}
                    </div>
                </div>
                <div class="rpt-meta-editable">
                    <div class="meta-item">
                        <span class="meta-label">Rf</span>
                        ${editableField('reference', reportData.reference || '', 'FX-2025-XXXX')}
                    </div>
                    <div class="meta-item">
                        <span class="meta-label">Type</span>
                        ${styledSelect('type_intervention', reportData.type_intervention, ['SAV / Dpannage', 'Mise en service', 'Maintenance', 'Installation', 'Visite constructeur'], 'Type d\'intervention')}
                    </div>
                    <div class="meta-item">
                        <span class="meta-label">Date</span>
                        ${editableField('date', reportData.date || today, 'JJ/MM/AAAA')}
                    </div>
                </div>
            </div>`;
            
            html += `<div class="rpt-card">`;
            
            // 
            // SECTION 2: INFORMATIONS GNRALES
            // 
            
            // Rsum
            html += `
            <div class="rpt-section">
                <div class="rpt-label">Rsum de l'intervention</div>
                ${editableField('resume', reportData.resume || '', 'Description synthtique de l\'intervention ralise...', true)}
            </div>`;
            
            // Client & Site en grid
            html += `<div class="rpt-section"><div class="rpt-grid">`;
            
            // Informations Site
            html += `<div class="rpt-group"><div class="rpt-label">Informations Site</div>`;
            html += `<div class="rpt-row"><span class="rpt-row-label">N Affaire</span><span class="rpt-row-value">${editableNested('site', 'numero_affaire', reportData.site?.numero_affaire || '', 'Numro d\'affaire')}</span></div>`;
            html += `<div class="rpt-row"><span class="rpt-row-label">Lieu</span><span class="rpt-row-value">${editableNested('site', 'adresse', reportData.site?.adresse || '', 'Adresse du site')}</span></div>`;
            html += `<div class="rpt-row"><span class="rpt-row-label">Ville</span><span class="rpt-row-value">${editableNested('site', 'ville', reportData.site?.ville || '', 'Code postal + Ville')}</span></div>`;
            html += `</div>`;
            
            // Informations Client
            html += `<div class="rpt-group"><div class="rpt-label">Informations Client</div>`;
            html += `<div class="rpt-row"><span class="rpt-row-label">Socit</span><span class="rpt-row-value">${editableNested('client', 'societe', reportData.client?.societe || '', 'Nom de l\'entreprise')}</span></div>`;
            html += `<div class="rpt-row"><span class="rpt-row-label">Contact</span><span class="rpt-row-value">${editableNested('client', 'contact', reportData.client?.contact || '', 'Nom du contact')}</span></div>`;
            html += `<div class="rpt-row"><span class="rpt-row-label">Tlphone</span><span class="rpt-row-value">${editableNested('client', 'telephone', reportData.client?.telephone || '', '06 XX XX XX XX')}</span></div>`;
            html += `<div class="rpt-row"><span class="rpt-row-label">Rf. Client</span><span class="rpt-row-value">${editableNested('client', 'reference', reportData.client?.reference || '', 'Rfrence client')}</span></div>`;
            html += `</div>`;
            html += `</div></div>`;
            
            // Dates d'intervention
            html += `<div class="rpt-section"><div class="rpt-label">Dates d'intervention</div>`;
            html += `<div class="rpt-grid">`;
            html += `<div class="rpt-group">`;
            html += `<div class="rpt-row"><span class="rpt-row-label">Date dbut</span><span class="rpt-row-value">${editableNested('dates', 'debut_date', reportData.dates?.debut_date || today, 'JJ/MM/AAAA')}</span></div>`;
            html += `<div class="rpt-row"><span class="rpt-row-label">Heure dbut</span><span class="rpt-row-value">${editableNested('dates', 'debut_heure', reportData.dates?.debut_heure || '', 'HH:MM')}</span></div>`;
            html += `</div>`;
            html += `<div class="rpt-group">`;
            html += `<div class="rpt-row"><span class="rpt-row-label">Date fin</span><span class="rpt-row-value">${editableNested('dates', 'fin_date', reportData.dates?.fin_date || '', 'JJ/MM/AAAA')}</span></div>`;
            html += `<div class="rpt-row"><span class="rpt-row-label">Heure fin</span><span class="rpt-row-value">${editableNested('dates', 'fin_heure', reportData.dates?.fin_heure || '', 'HH:MM')}</span></div>`;
            html += `</div>`;
            html += `</div></div>`;
            
            // 
            // SECTION 3: SYSTME & QUIPEMENT
            // 
            
            html += `<div class="rpt-section-divider"></div>`;
            html += `<div class="rpt-section"><div class="rpt-label section-header">Systme & quipement</div>`;
            html += `<div class="rpt-grid">`;
            html += `<div class="rpt-group">`;
            html += `<div class="rpt-row"><span class="rpt-row-label">Type systme</span><span class="rpt-row-value">${editableNested('systeme', 'type', reportData.systeme?.type || '', 'VRF, Split, Rooftop, PAC...')}</span></div>`;
            html += `<div class="rpt-row"><span class="rpt-row-label">Modle</span><span class="rpt-row-value mono">${editableNested('systeme', 'modele', reportData.systeme?.modele || '', 'Rfrence du modle')}</span></div>`;
            html += `<div class="rpt-row"><span class="rpt-row-label">N Srie</span><span class="rpt-row-value mono">${editableNested('systeme', 'serie', reportData.systeme?.serie || '', 'Numro de srie')}</span></div>`;
            html += `</div>`;
            html += `<div class="rpt-group">`;
            html += `<div class="rpt-row"><span class="rpt-row-label">Puissance</span><span class="rpt-row-value">${editableNested('systeme', 'puissance', reportData.systeme?.puissance || '', 'kW')}</span></div>`;
            html += `<div class="rpt-row"><span class="rpt-row-label">Anne install.</span><span class="rpt-row-value">${editableNested('systeme', 'annee_installation', reportData.systeme?.annee_installation || '', 'AAAA')}</span></div>`;
            html += `<div class="rpt-row"><span class="rpt-row-label">Garantie</span><span class="rpt-row-value">${styledSelect('systeme.garantie', reportData.systeme?.garantie, ['Sous garantie', 'Hors garantie'], 'Statut garantie')}</span></div>`;
            html += `</div>`;
            html += `</div></div>`;
            
            // Fluide frigorigne
            html += `<div class="rpt-section"><div class="rpt-label">Fluide frigorigne</div>`;
            html += `<div class="rpt-grid">`;
            html += `<div class="rpt-group">`;
            html += `<div class="rpt-row"><span class="rpt-row-label">Type fluide</span><span class="rpt-row-value">${styledSelect('fluide.type', reportData.fluide?.type, ['R410A', 'R32', 'R134a', 'R407C', 'R290', 'R744'], 'Type de fluide')}</span></div>`;
            html += `<div class="rpt-row"><span class="rpt-row-label">Charge initiale</span><span class="rpt-row-value">${editableNested('fluide', 'charge_initiale', reportData.fluide?.charge_initiale || '', 'kg')}</span></div>`;
            html += `</div>`;
            html += `<div class="rpt-group">`;
            html += `<div class="rpt-row"><span class="rpt-row-label">Type huile</span><span class="rpt-row-value">${editableNested('fluide', 'type_huile', reportData.fluide?.type_huile || '', 'POE, PVE...')}</span></div>`;
            html += `<div class="rpt-row"><span class="rpt-row-label">Charge totale</span><span class="rpt-row-value">${editableNested('fluide', 'charge_totale', reportData.fluide?.charge_totale || '', 'kg')}</span></div>`;
            html += `</div>`;
            html += `</div></div>`;
            
            // Adressage systme (table)
            html += `<div class="rpt-section">
                <div class="rpt-label">Adressage du systme <button class="add-item-btn" onclick="addReportListItem('adressage')">+</button></div>
                <div class="rpt-table-wrapper">
                    <table class="rpt-table">
                        <thead>
                            <tr>
                                <th>Rf. Usine</th>
                                <th>N Srie</th>
                                <th>Adresse</th>
                                <th>Dsignation</th>
                                <th>Commentaire</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody id="adressage-tbody">`;
            if (reportData.adressage && reportData.adressage.length > 0) {
                reportData.adressage.forEach((a, i) => {
                    html += `<tr class="list-item" data-index="${i}">
                        <td><span class="editable-field" contenteditable="true" data-field="adressage.${i}.ref_usine" data-placeholder="Rf">${a.ref_usine || ''}</span></td>
                        <td><span class="editable-field mono" contenteditable="true" data-field="adressage.${i}.serie" data-placeholder="Srie">${a.serie || ''}</span></td>
                        <td><span class="editable-field" contenteditable="true" data-field="adressage.${i}.adresse" data-placeholder="Adr">${a.adresse || ''}</span></td>
                        <td><span class="editable-field" contenteditable="true" data-field="adressage.${i}.designation" data-placeholder="Dsignation">${a.designation || ''}</span></td>
                        <td><span class="editable-field" contenteditable="true" data-field="adressage.${i}.commentaire" data-placeholder="">${a.commentaire || ''}</span></td>
                        <td><button class="remove-item-btn" onclick="removeReportListItem('adressage', ${i})"></button></td>
                    </tr>`;
                });
            }
            html += `</tbody></table>
                </div>
                <div class="add-item-placeholder" onclick="addReportListItem('adressage')">
                    <span class="placeholder-text">+ Ajouter une unit</span>
                </div>
            </div>`;
            
            // 
            // SECTION 4: DIAGNOSTIC & CODES DFAUT
            // 
            
            html += `<div class="rpt-section-divider"></div>`;
            
            // Codes dfaut
            html += `<div class="rpt-section">
                <div class="rpt-label section-header">Codes dfaut <button class="add-item-btn" onclick="addReportListItem('codes_defaut')">+</button></div>
                <div class="rpt-list" id="codes-defaut-list">`;
            if (reportData.codes_defaut && reportData.codes_defaut.length > 0) {
                reportData.codes_defaut.forEach((c, i) => {
                    html += `<div class="rpt-code-item list-item" data-index="${i}">
                        <span class="code-badge editable-field" contenteditable="true" data-field="codes_defaut.${i}.code" data-placeholder="Code">${c.code || ''}</span>
                        <span class="code-desc editable-field" contenteditable="true" data-field="codes_defaut.${i}.description" data-placeholder="Description du code erreur">${c.description || ''}</span>
                        <button class="remove-item-btn" onclick="removeReportListItem('codes_defaut', ${i})"></button>
                    </div>`;
                });
            }
            html += `<div class="add-item-placeholder" onclick="addReportListItem('codes_defaut')">
                <span class="placeholder-text">+ Ajouter un code dfaut</span>
            </div>`;
            html += `</div></div>`;
            
            // Scurit systme
            html += `<div class="rpt-section"><div class="rpt-label">Scurit du systme</div>`;
            html += `<div class="rpt-row"><span class="rpt-row-label">tat scurit</span><span class="rpt-row-value">${styledSelect('securite.etat', reportData.securite?.etat, ['OK', ' surveiller', 'Critique'], 'tat')}</span></div>`;
            html += `<div class="rpt-row" style="flex-direction:column;align-items:stretch;"><span class="rpt-row-label" style="margin-bottom:4px;">Risques identifis</span>${editableField('securite.risques', reportData.securite?.risques || '', 'Description des risques identifis...', true)}</div>`;
            html += `</div>`;
            
            // 
            // SECTION 5: MESURES & RELEVS
            // 
            
            html += `<div class="rpt-section-divider"></div>`;
            html += `<div class="rpt-section">
                <div class="rpt-label section-header">Relevs & Mesures <button class="add-item-btn" onclick="addReportListItem('mesures')">+</button></div>
                <div class="rpt-measures-grid" id="mesures-list">`;
            if (reportData.mesures && reportData.mesures.length > 0) {
                reportData.mesures.forEach((m, i) => {
                    html += `<div class="rpt-measure-card list-item" data-index="${i}">
                        <span class="measure-label editable-field" contenteditable="true" data-field="mesures.${i}.label" data-placeholder="Paramtre">${m.label || ''}</span>
                        <span class="measure-value editable-field" contenteditable="true" data-field="mesures.${i}.valeur" data-placeholder="Valeur">${m.valeur || ''}</span>
                        <span class="measure-unit editable-field" contenteditable="true" data-field="mesures.${i}.unite" data-placeholder="Unit">${m.unite || ''}</span>
                        <button class="remove-item-btn" onclick="removeReportListItem('mesures', ${i})"></button>
                    </div>`;
                });
            }
            html += `</div>
            <div class="add-item-placeholder" onclick="addReportListItem('mesures')">
                <span class="placeholder-text">+ Ajouter une mesure</span>
            </div></div>`;
            
            // Heures de fonctionnement
            html += `<div class="rpt-section"><div class="rpt-label">Heures de fonctionnement</div>`;
            html += `<div class="rpt-grid">`;
            html += `<div class="rpt-row"><span class="rpt-row-label">Heures compresseur</span><span class="rpt-row-value">${editableNested('fonctionnement', 'heures_compresseur', reportData.fonctionnement?.heures_compresseur || '', 'heures')}</span></div>`;
            html += `<div class="rpt-row"><span class="rpt-row-label">Nb dmarrages</span><span class="rpt-row-value">${editableNested('fonctionnement', 'nb_demarrages', reportData.fonctionnement?.nb_demarrages || '', 'cycles')}</span></div>`;
            html += `</div></div>`;
            
            // 
            // SECTION 6: TRAVAUX EFFECTUS &  PRVOIR
            // 
            
            html += `<div class="rpt-section-divider"></div>`;
            
            // Travaux effectus
            html += `<div class="rpt-section">
                <div class="rpt-label section-header">Travaux effectus <button class="add-item-btn" onclick="addReportListItem('travaux_effectues')">+</button></div>
                <ul class="rpt-checklist editable-list" id="travaux-list">`;
            if (reportData.travaux_effectues && reportData.travaux_effectues.length > 0) {
                reportData.travaux_effectues.forEach((t, i) => {
                    html += `<li class="done list-item" data-index="${i}">
                        <span class="check-icon"></span>
                        <span class="editable-field" contenteditable="true" data-field="travaux_effectues.${i}.texte" data-placeholder="Description du travail effectu">${t.texte || ''}</span>
                        <button class="remove-item-btn" onclick="removeReportListItem('travaux_effectues', ${i})"></button>
                    </li>`;
                });
            }
            html += `</ul>
            <div class="add-item-placeholder" onclick="addReportListItem('travaux_effectues')">
                <span class="placeholder-text">+ Ajouter un travail effectu</span>
            </div></div>`;
            
            // Travaux  prvoir
            html += `<div class="rpt-section">
                <div class="rpt-label">Travaux  prvoir <button class="add-item-btn" onclick="addReportListItem('travaux_prevoir')">+</button></div>
                <ul class="rpt-checklist editable-list pending-list" id="travaux-prevoir-list">`;
            if (reportData.travaux_prevoir && reportData.travaux_prevoir.length > 0) {
                reportData.travaux_prevoir.forEach((t, i) => {
                    html += `<li class="pending list-item" data-index="${i}">
                        <span class="check-icon"></span>
                        <span class="editable-field" contenteditable="true" data-field="travaux_prevoir.${i}.texte" data-placeholder="Description du travail  prvoir">${t.texte || ''}</span>
                        <button class="remove-item-btn" onclick="removeReportListItem('travaux_prevoir', ${i})"></button>
                    </li>`;
                });
            }
            html += `</ul>
            <div class="add-item-placeholder" onclick="addReportListItem('travaux_prevoir')">
                <span class="placeholder-text">+ Ajouter un travail  prvoir</span>
            </div></div>`;
            
            // Pices utilises
            html += `<div class="rpt-section">
                <div class="rpt-label">Pices & Consommables <button class="add-item-btn" onclick="addReportListItem('pieces')">+</button></div>
                <div class="rpt-list" id="pieces-list">`;
            if (reportData.pieces && reportData.pieces.length > 0) {
                reportData.pieces.forEach((p, i) => {
                    html += `<div class="rpt-row list-item" data-index="${i}">
                        <span class="rpt-row-label editable-field" contenteditable="true" data-field="pieces.${i}.reference" data-placeholder="Rfrence">${p.reference || ''}</span>
                        <span class="rpt-row-value editable-field" contenteditable="true" data-field="pieces.${i}.designation" data-placeholder="Dsignation">${p.designation || ''}</span>
                        <span class="piece-qty editable-field" contenteditable="true" data-field="pieces.${i}.quantite" data-placeholder="Qt">${p.quantite || ''}</span>
                        <button class="remove-item-btn" onclick="removeReportListItem('pieces', ${i})"></button>
                    </div>`;
                });
            }
            html += `<div class="add-item-placeholder" onclick="addReportListItem('pieces')">
                <span class="placeholder-text">+ Ajouter une pice</span>
            </div>`;
            html += `</div></div>`;
            
            // 
            // SECTION 7: RAPPORT TECHNICIEN
            // 
            
            html += `<div class="rpt-section-divider"></div>`;
            html += `<div class="rpt-section"><div class="rpt-label section-header">Rapport du technicien</div>`;
            html += editableField('rapport_technicien', reportData.rapport_technicien || '', 'Observations dtailles, analyses, conclusions du technicien...', true);
            html += `</div>`;
            
            // Remarques
            html += `<div class="rpt-section"><div class="rpt-label">Remarques</div>`;
            html += editableField('remarques', reportData.remarques || '', 'Remarques complmentaires...', true);
            html += `</div>`;
            
            // Rserves
            html += `<div class="rpt-section">
                <div class="rpt-label">Rserves <button class="add-item-btn" onclick="addReportListItem('reserves')">+</button></div>
                <div class="rpt-alerts editable-list" id="reserves-list">`;
            if (reportData.reserves && reportData.reserves.length > 0) {
                reportData.reserves.forEach((r, i) => {
                    html += `<div class="rpt-alert warning list-item" data-index="${i}">
                        <strong class="editable-field" contenteditable="true" data-field="reserves.${i}.titre" data-placeholder="Titre de la rserve">${r.titre || ''}</strong>
                        <p class="editable-field" contenteditable="true" data-field="reserves.${i}.texte" data-placeholder="Description de la rserve">${r.texte || ''}</p>
                        <button class="remove-item-btn" onclick="removeReportListItem('reserves', ${i})"></button>
                    </div>`;
                });
            }
            html += `</div>
            <div class="add-item-placeholder" onclick="addReportListItem('reserves')">
                <span class="placeholder-text">+ Ajouter une rserve</span>
            </div></div>`;
            
            // 
            // SECTION 8: RSULTAT & CONCLUSION
            // 
            
            html += `<div class="rpt-section-divider"></div>`;
            html += `<div class="rpt-section"><div class="rpt-label section-header">Rsultat de l'intervention</div>`;
            html += `<div class="rpt-result-box">`;
            html += `<div class="result-status-row">
                <span class="result-label">Statut</span>
                ${styledSelect('resultat.status', reportData.resultat?.status, ['resolu', 'en_attente', 'non_resolu'], 'Slectionner...')}
            </div>`;
            html += `<div class="result-desc-row">
                <span class="result-label">Conclusion</span>
                ${editableField('resultat.description', reportData.resultat?.description || '', 'Description du rsultat et conclusion...', true)}
            </div>`;
            html += `</div></div>`;
            
            // 
            // SECTION 9: PHOTOS
            // 
            
            html += `<div class="rpt-section-divider"></div>`;
            const photos = window.reportPhotos || [];
            html += `<div class="rpt-section">
                <div class="rpt-label section-header">Photos (${photos.length}) <button class="add-item-btn" onclick="triggerPhotoUpload()">+</button></div>`;
            
            // Upload area
            html += `<input type="file" id="photoUploadInput" accept="image/*" multiple style="display:none" onchange="handlePhotoUpload(event)">`;
            
            if (photos.length > 0) {
                html += `<div class="photos-grid sortable-photos" id="sortablePhotos">`;
                photos.forEach((p, i) => {
                    const imgSrc = p.url || p.data || p.originalData || '';
                    const caption = p.caption || p.name || '';
                    html += `<div class="photo-item draggable-photo" draggable="true" data-index="${i}">
                        <div class="photo-drag-handle"></div>
                        <img src="${imgSrc}" alt="Photo ${i+1}" onerror="this.style.display='none'" onclick="viewPhotoFull('${imgSrc}')">
                        <span class="photo-caption editable-field" contenteditable="true" data-field="photos.${i}.caption" data-placeholder="Titre photo">${caption}</span>
                        <button class="photo-remove-btn" onclick="removePhoto(${i})"></button>
                    </div>`;
                });
                html += `</div>`;
            }
            
            // Drop zone for adding photos
            html += `<div class="photo-drop-zone" onclick="triggerPhotoUpload()" ondragover="handlePhotoDragOver(event)" ondrop="handlePhotoDrop(event)">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                    <circle cx="8.5" cy="8.5" r="1.5"></circle>
                    <polyline points="21 15 16 10 5 21"></polyline>
                </svg>
                <span>Glisser des photos ou cliquer pour ajouter</span>
            </div>`;
            
            html += `</div>`;
            
            // 
            // SECTION 10: TECHNICIEN & SIGNATURES
            // 
            
            html += `<div class="rpt-section-divider"></div>`;
            html += `<div class="rpt-section"><div class="rpt-label section-header">Technicien(s)</div>`;
            html += `<div class="rpt-grid">`;
            html += `<div class="rpt-group">`;
            html += `<div class="rpt-row"><span class="rpt-row-label">Nom</span><span class="rpt-row-value">${editableNested('technicien', 'nom', reportData.technicien?.nom || '', 'Nom du technicien')}</span></div>`;
            html += `<div class="rpt-row"><span class="rpt-row-label">Entreprise</span><span class="rpt-row-value">${editableNested('technicien', 'entreprise', reportData.technicien?.entreprise || '', 'Nom STA')}</span></div>`;
            html += `</div>`;
            html += `<div class="rpt-group">`;
            html += `<div class="rpt-row"><span class="rpt-row-label">Arrive</span><span class="rpt-row-value">${editableNested('technicien', 'heure_arrivee', reportData.technicien?.heure_arrivee || '', 'HH:MM')}</span></div>`;
            html += `<div class="rpt-row"><span class="rpt-row-label">Dpart</span><span class="rpt-row-value">${editableNested('technicien', 'heure_depart', reportData.technicien?.heure_depart || '', 'HH:MM')}</span></div>`;
            html += `</div>`;
            html += `</div>`;
            
            // Autres techniciens
            html += `<div class="rpt-row" style="margin-top:8px;"><span class="rpt-row-label">Autre(s) technicien(s)</span><span class="rpt-row-value">${editableNested('technicien', 'autres', reportData.technicien?.autres || '', 'Noms des autres techniciens prsents')}</span></div>`;
            html += `</div>`;
            
            // Observation client
            html += `<div class="rpt-section"><div class="rpt-label">Observation(s) Client</div>`;
            html += editableField('observation_client', reportData.observation_client || '', 'Observations du client...', true);
            html += `</div>`;
            
            // 
            // SECTIONS TECHNIQUES ADDITIONNELLES (conditionnelles)
            // 
            
            try {
                // Tests & Validation
                if (reportData.tests && typeof reportData.tests === 'object') {
                    const hasTestData = Object.keys(reportData.tests).some(k => reportData.tests[k] != null && reportData.tests[k] !== '');
                    if (hasTestData) {
                        html += `<div class="rpt-section"><div class="rpt-label">Tests & Validation</div>`;
                        html += `<div class="rpt-grid">`;
                        html += `<div class="rpt-group">`;
                        html += `<div class="rpt-row"><span class="rpt-row-label">Pression test</span><span class="rpt-row-value">${editableNested('tests', 'pression_test_bar', reportData.tests.pression_test_bar || '', 'bar')}</span></div>`;
                        html += `<div class="rpt-row"><span class="rpt-row-label">Dure test</span><span class="rpt-row-value">${editableNested('tests', 'duree_test_heures', reportData.tests.duree_test_heures || '', 'h')}</span></div>`;
                        html += `</div>`;
                        html += `<div class="rpt-group">`;
                        html += `<div class="rpt-row"><span class="rpt-row-label">Vacuomtre</span><span class="rpt-row-value">${editableNested('tests', 'valeur_vacuometre_mbar', reportData.tests.valeur_vacuometre_mbar || '', 'mbar')}</span></div>`;
                        html += `</div>`;
                        html += `</div></div>`;
                    }
                }
                
                // Tuyauteries
                if (reportData.tuyauteries && typeof reportData.tuyauteries === 'object') {
                    const hasTuyData = Object.keys(reportData.tuyauteries).some(k => reportData.tuyauteries[k] != null && reportData.tuyauteries[k] !== '');
                    if (hasTuyData) {
                        html += `<div class="rpt-section"><div class="rpt-label">Longueurs tuyauteries</div>`;
                        html += `<div class="rpt-grid">`;
                        html += `<div class="rpt-group">`;
                        html += `<div class="rpt-row"><span class="rpt-row-label">Longueur totale</span><span class="rpt-row-value">${editableNested('tuyauteries', 'longueur_totale_m', reportData.tuyauteries.longueur_totale_m || '', 'm')}</span></div>`;
                        html += `<div class="rpt-row"><span class="rpt-row-label">Dnivel UE-UI</span><span class="rpt-row-value">${editableNested('tuyauteries', 'denivele_oc_ui_m', reportData.tuyauteries.denivele_oc_ui_m || '', 'm')}</span></div>`;
                        html += `</div>`;
                        html += `<div class="rpt-group">`;
                        html += `<div class="rpt-row"><span class="rpt-row-label">Appoint calcul</span><span class="rpt-row-value">${editableNested('tuyauteries', 'appoint_calcule_kg', reportData.tuyauteries.appoint_calcule_kg || '', 'kg')}</span></div>`;
                        html += `</div>`;
                        html += `</div></div>`;
                    }
                }
                
                // Mesures lectriques
                if (reportData.electrique && typeof reportData.electrique === 'object') {
                    const hasElecData = Object.keys(reportData.electrique).some(k => reportData.electrique[k] != null && reportData.electrique[k] !== '');
                    if (hasElecData) {
                        html += `<div class="rpt-section"><div class="rpt-label">Mesures lectriques</div>`;
                        html += `<div class="rpt-grid">`;
                        html += `<div class="rpt-group">`;
                        html += `<div class="rpt-row"><span class="rpt-row-label">Disjoncteur</span><span class="rpt-row-value">${editableNested('electrique', 'calibre_disjoncteur', reportData.electrique.calibre_disjoncteur || '', '')}</span></div>`;
                        html += `<div class="rpt-row"><span class="rpt-row-label">Section cble</span><span class="rpt-row-value">${editableNested('electrique', 'section_cable', reportData.electrique.section_cable || '', '')}</span></div>`;
                        html += `</div>`;
                        html += `</div></div>`;
                    }
                }
                
                // Relevs UE
                if (reportData.releves_ue && typeof reportData.releves_ue === 'object') {
                    const hasUEData = Object.keys(reportData.releves_ue).some(k => reportData.releves_ue[k] != null && reportData.releves_ue[k] !== '');
                    if (hasUEData) {
                        html += `<div class="rpt-section"><div class="rpt-label">Relevs Unit Extrieure</div>`;
                        html += `<div class="rpt-grid">`;
                        html += `<div class="rpt-group">`;
                        html += `<div class="rpt-row"><span class="rpt-row-label">HP (Pd1)</span><span class="rpt-row-value">${editableNested('releves_ue', 'pd1_bar', reportData.releves_ue.pd1_bar || '', 'bar')}</span></div>`;
                        html += `<div class="rpt-row"><span class="rpt-row-label">BP (Ps)</span><span class="rpt-row-value">${editableNested('releves_ue', 'ps_bar', reportData.releves_ue.ps_bar || '', 'bar')}</span></div>`;
                        html += `</div>`;
                        html += `<div class="rpt-group">`;
                        html += `<div class="rpt-row"><span class="rpt-row-label">T ext (TA)</span><span class="rpt-row-value">${editableNested('releves_ue', 'ta_celsius', reportData.releves_ue.ta_celsius || '', 'C')}</span></div>`;
                        html += `<div class="rpt-row"><span class="rpt-row-label">Frq compresseur</span><span class="rpt-row-value">${editableNested('releves_ue', 'freq_inv1_hz', reportData.releves_ue.freq_inv1_hz || '', 'Hz')}</span></div>`;
                        html += `</div>`;
                        html += `</div></div>`;
                    }
                }
                
                // Relevs UI (tableau)
                if (reportData.releves_ui && Array.isArray(reportData.releves_ui) && reportData.releves_ui.length > 0) {
                    html += `<div class="rpt-section">
                        <div class="rpt-label">Relevs Units Intrieures</div>
                        <div class="rpt-table-wrapper">
                            <table class="rpt-table">
                                <thead><tr><th>Emplacement</th><th>Adr</th><th>TA</th><th>TC1</th><th>PMV</th></tr></thead>
                                <tbody>`;
                    reportData.releves_ui.forEach((ui, i) => {
                        html += `<tr>
                            <td>${ui.emplacement || ''}</td>
                            <td>${ui.adresse || ''}</td>
                            <td>${ui.ta_celsius || ''}</td>
                            <td>${ui.tc1_celsius || ''}</td>
                            <td>${ui.pmv || ''}</td>
                        </tr>`;
                    });
                    html += `</tbody></table></div></div>`;
                }
                
                // CERFA - Manipulation fluides
                if (reportData.cerfa && typeof reportData.cerfa === 'object') {
                    const hasCerfaData = Object.keys(reportData.cerfa).some(k => reportData.cerfa[k] != null && reportData.cerfa[k] !== '');
                    if (hasCerfaData) {
                        html += `<div class="rpt-section"><div class="rpt-label section-header">Fiche CERFA - Fluides frigorignes</div>`;
                        html += `<div class="rpt-grid">`;
                        html += `<div class="rpt-group">`;
                        html += `<div class="rpt-row"><span class="rpt-row-label">Fluide charg</span><span class="rpt-row-value">${editableNested('cerfa', 'fluide_total_charge_kg', reportData.cerfa.fluide_total_charge_kg || '', 'kg')}</span></div>`;
                        html += `<div class="rpt-row"><span class="rpt-row-label">Fluide rcupr</span><span class="rpt-row-value">${editableNested('cerfa', 'fluide_total_recupere_kg', reportData.cerfa.fluide_total_recupere_kg || '', 'kg')}</span></div>`;
                        html += `</div>`;
                        html += `<div class="rpt-group">`;
                        html += `<div class="rpt-row"><span class="rpt-row-label">N attestation</span><span class="rpt-row-value">${editableNested('cerfa', 'attestation_capacite', reportData.cerfa.attestation_capacite || '', '')}</span></div>`;
                        html += `</div>`;
                        html += `</div></div>`;
                    }
                }
                
                // Garantie
                if (reportData.garantie && typeof reportData.garantie === 'object') {
                    const hasGarantieData = Object.keys(reportData.garantie).some(k => reportData.garantie[k] != null && reportData.garantie[k] !== '');
                    if (hasGarantieData) {
                        html += `<div class="rpt-section"><div class="rpt-label">Garanties</div>`;
                        html += `<div class="rpt-grid">`;
                        html += `<div class="rpt-row"><span class="rpt-row-label">Fin garantie pices</span><span class="rpt-row-value">${editableNested('garantie', 'fin_garantie_pieces', reportData.garantie.fin_garantie_pieces || '', '')}</span></div>`;
                        html += `<div class="rpt-row"><span class="rpt-row-label">Fin garantie compresseur</span><span class="rpt-row-value">${editableNested('garantie', 'fin_garantie_compresseur', reportData.garantie.fin_garantie_compresseur || '', '')}</span></div>`;
                        html += `</div></div>`;
                    }
                }
                
                // Hydraulique
                if (reportData.hydraulique && typeof reportData.hydraulique === 'object') {
                    const hasHydroData = Object.keys(reportData.hydraulique).some(k => reportData.hydraulique[k] != null && reportData.hydraulique[k] !== '');
                    if (hasHydroData) {
                        html += `<div class="rpt-section"><div class="rpt-label">Hydraulique</div>`;
                        html += `<div class="rpt-grid">`;
                        html += `<div class="rpt-group">`;
                        html += `<div class="rpt-row"><span class="rpt-row-label">Volume eau</span><span class="rpt-row-value">${editableNested('hydraulique', 'volume_eau_litres', reportData.hydraulique.volume_eau_litres || '', 'L')}</span></div>`;
                        html += `<div class="rpt-row"><span class="rpt-row-label">Dbit</span><span class="rpt-row-value">${editableNested('hydraulique', 'debit_m3h', reportData.hydraulique.debit_m3h || '', 'm/h')}</span></div>`;
                        html += `</div>`;
                        html += `<div class="rpt-group">`;
                        html += `<div class="rpt-row"><span class="rpt-row-label">Type antigel</span><span class="rpt-row-value">${editableNested('hydraulique', 'type_antigel', reportData.hydraulique.type_antigel || '', '')}</span></div>`;
                        html += `</div>`;
                        html += `</div></div>`;
                    }
                }
                
                // Check-list Pr-MES
                if (reportData.checklist && typeof reportData.checklist === 'object') {
                    const hasChecklistData = Object.keys(reportData.checklist).some(k => reportData.checklist[k] === true || reportData.checklist[k] === false);
                    if (hasChecklistData) {
                        html += `<div class="rpt-section"><div class="rpt-label">Check-list Pr-mise en service</div>`;
                        html += `<div class="rpt-checklist-grid">`;
                        const checklistItems = [
                            { key: 'synoptique_conforme', label: 'Synoptique conforme' },
                            { key: 'supports_fixes', label: 'Supports fixs' },
                            { key: 'liaisons_calorifugees', label: 'Liaisons calorifuges' },
                            { key: 'brasures_azote', label: 'Brasures sous azote' },
                            { key: 'test_pression_40bar_24h', label: 'Test pression 40 bar 24h' },
                            { key: 'bus_blinde_terre', label: 'Bus blind  la terre' },
                            { key: 'disjoncteur_ue', label: 'Disjoncteur par UE' },
                            { key: 'ui_niveau', label: 'UI de niveau' },
                            { key: 'ue_anti_vibratiles', label: 'UE sur anti-vibratiles' },
                            { key: 'espaces_ue', label: 'Espaces UE respects' }
                        ];
                        checklistItems.forEach(item => {
                            const val = reportData.checklist[item.key];
                            if (val === true || val === false) {
                                const statusClass = val === true ? 'check-ok' : 'check-nok';
                                const statusIcon = val === true ? '' : '';
                                html += `<div class="checklist-item ${statusClass}"><span class="check-icon">${statusIcon}</span><span>${item.label}</span></div>`;
                            }
                        });
                        html += `</div></div>`;
                    }
                }
                
                // Prconisations constructeur
                if (reportData.preconisations && typeof reportData.preconisations === 'object') {
                    const hasPrecoData = Object.keys(reportData.preconisations).some(k => reportData.preconisations[k] === true || reportData.preconisations[k] === false);
                    if (hasPrecoData) {
                        html += `<div class="rpt-section"><div class="rpt-label">Prconisations constructeur</div>`;
                        html += `<div class="rpt-checklist-grid">`;
                        const precoItems = [
                            { key: 'presence_installateur', label: 'Prsence installateur' },
                            { key: 'acces_site_securite', label: 'Accs site / scurit' },
                            { key: 'tension_presente', label: 'Tension prsente' },
                            { key: 'installation_au_vide', label: 'Installation au vide' },
                            { key: 'longueurs_deniveles_ok', label: 'Longueurs/dnivels OK' },
                            { key: 'tests_etancheite', label: 'Tests tanchit' },
                            { key: 'brasures_azote', label: 'Brasures sous azote' },
                            { key: 'cable_disjoncteur', label: 'Cble/disjoncteur' },
                            { key: 'cable_bus_com', label: 'Cble bus communication' }
                        ];
                        precoItems.forEach(item => {
                            const val = reportData.preconisations[item.key];
                            if (val === true || val === false) {
                                const statusClass = val === true ? 'check-ok' : 'check-nok';
                                const statusIcon = val === true ? '' : '';
                                html += `<div class="checklist-item ${statusClass}"><span class="check-icon">${statusIcon}</span><span>${item.label}</span></div>`;
                            }
                        });
                        html += `</div></div>`;
                    }
                }
                
                // EH&S - Scurit intervention
                if (reportData.ehs && typeof reportData.ehs === 'object') {
                    const hasEhsData = Object.keys(reportData.ehs).some(k => reportData.ehs[k] != null && reportData.ehs[k] !== '');
                    if (hasEhsData) {
                        html += `<div class="rpt-section"><div class="rpt-label">EH&S - Scurit intervention</div>`;
                        html += `<div class="rpt-grid">`;
                        html += `<div class="rpt-group">`;
                        if (reportData.ehs.acces_securise !== undefined) {
                            const accesIcon = reportData.ehs.acces_securise ? '' : '';
                            const accesClass = reportData.ehs.acces_securise ? 'check-ok' : 'check-nok';
                            html += `<div class="rpt-row"><span class="rpt-row-label">Accs scuris</span><span class="rpt-row-value ${accesClass}">${accesIcon}</span></div>`;
                        }
                        if (reportData.ehs.numero_urgence) {
                            html += `<div class="rpt-row"><span class="rpt-row-label">N urgence</span><span class="rpt-row-value">${editableNested('ehs', 'numero_urgence', reportData.ehs.numero_urgence || '', '')}</span></div>`;
                        }
                        html += `</div>`;
                        html += `</div>`;
                        if (reportData.ehs.risques_specifiques && Array.isArray(reportData.ehs.risques_specifiques) && reportData.ehs.risques_specifiques.length > 0) {
                            html += `<div class="rpt-row" style="margin-top:8px;"><span class="rpt-row-label">Risques spcifiques</span><span class="rpt-row-value">${reportData.ehs.risques_specifiques.join(', ')}</span></div>`;
                        }
                        html += `</div>`;
                    }
                }
            } catch (e) {
                console.warn('Erreur sections additionnelles:', e);
            }
            
            // Signatures (interactive - click to add)
            const hasClientSig = reportData.signature_client;
            const hasTechSig = reportData.signature_technicien;
            html += `<div class="rpt-section signatures-section">
                <div class="rpt-label">Signatures</div>
                <div class="rpt-grid signatures-grid">
                    <div class="signature-box">
                        <div class="signature-label">Signature Client</div>
                        <div class="signature-area ${hasClientSig ? 'signed' : ''}" onclick="openSignatureModal('client')" title="Cliquez pour signer">
                            ${hasClientSig ? `<img src="${reportData.signature_client}" alt="Signature client">` : '<span class="signature-placeholder">Touchez pour signer</span>'}
                        </div>
                        <div class="signature-name">${editableNested('signatures', 'nom_client', reportData.signatures?.nom_client || '', 'Nom du signataire')}</div>
                    </div>
                    <div class="signature-box">
                        <div class="signature-label">Signature Technicien</div>
                        <div class="signature-area ${hasTechSig ? 'signed' : ''}" onclick="openSignatureModal('technicien')" title="Cliquez pour signer">
                            ${hasTechSig ? `<img src="${reportData.signature_technicien}" alt="Signature technicien">` : '<span class="signature-placeholder">Touchez pour signer</span>'}
                        </div>
                        <div class="signature-name">${editableNested('signatures', 'nom_technicien', reportData.signatures?.nom_technicien || '', 'Nom du signataire')}</div>
                    </div>
                </div>
            </div>`;
            
            html += `</div></div>`;
            
            return html;
        }
        
        // 
        // DRAWER v12.5 - NEW EDITABLE REPORT SYSTEM
        // 
        
        let drawerDraggedElement = null;
        let drawerActiveEditable = null;
        let drawerNumCounter = 0;
        let drawerAutoSaveTimeout = null;
        let reportIsCompleted = false;
        
        // Undo/Redo system
        let drawerUndoStack = [];
        let drawerRedoStack = [];
        const DRAWER_MAX_UNDO = 50;
        
        // Save current state to undo stack
        function drawerSaveState() {
            const doc = document.getElementById('rptDoc');
            if (!doc) return;
            
            const state = doc.innerHTML;
            
            // Don't save if identical to last state
            if (drawerUndoStack.length > 0 && drawerUndoStack[drawerUndoStack.length - 1] === state) {
                return;
            }
            
            drawerUndoStack.push(state);
            if (drawerUndoStack.length > DRAWER_MAX_UNDO) {
                drawerUndoStack.shift();
            }
            
            // Clear redo stack when new action is taken
            drawerRedoStack = [];
            
            console.log('[Undo] State saved, stack size:', drawerUndoStack.length);
        }
        
        // Undo last action
        function drawerUndo() {
            if (drawerUndoStack.length === 0) {
                console.log('[Undo] Nothing to undo');
                return;
            }
            
            const doc = document.getElementById('rptDoc');
            if (!doc) return;
            
            // Save current state to redo stack
            drawerRedoStack.push(doc.innerHTML);
            
            // Restore previous state
            const prevState = drawerUndoStack.pop();
            doc.innerHTML = prevState;
            
            // Reinitialize event listeners
            initDrawerV12Features();
            
            // Save to database
            drawerAutoSave();
            
            console.log('[Undo] Restored state, remaining:', drawerUndoStack.length);
            toast('Action annule');
        }
        
        // Redo last undone action
        function drawerRedo() {
            if (drawerRedoStack.length === 0) {
                console.log('[Redo] Nothing to redo');
                return;
            }
            
            const doc = document.getElementById('rptDoc');
            if (!doc) return;
            
            // Save current state to undo stack
            drawerUndoStack.push(doc.innerHTML);
            
            // Restore redo state
            const nextState = drawerRedoStack.pop();
            doc.innerHTML = nextState;
            
            // Reinitialize event listeners
            initDrawerV12Features();
            
            // Save to database
            drawerAutoSave();
            
            console.log('[Redo] Restored state, remaining redo:', drawerRedoStack.length);
            toast('Action rtablie');
        }
        
        // Initialize keyboard shortcuts for drawer
        function initDrawerKeyboardShortcuts() {
            document.addEventListener('keydown', (e) => {
                // Only work when drawer is open
                const drawer = document.getElementById('reportDrawer');
                if (!drawer || !drawer.classList.contains('open')) return;
                
                // Ctrl+Z or Cmd+Z = Undo
                if ((e.ctrlKey || e.metaKey) && e.key === 'z' && !e.shiftKey) {
                    e.preventDefault();
                    drawerUndo();
                }
                
                // Ctrl+Y or Cmd+Shift+Z = Redo
                if ((e.ctrlKey || e.metaKey) && (e.key === 'y' || (e.key === 'z' && e.shiftKey))) {
                    e.preventDefault();
                    drawerRedo();
                }
            });
            
            console.log('[Drawer] Keyboard shortcuts initialized (Ctrl+Z, Ctrl+Y)');
        }
        
        // Call this on page load
        document.addEventListener('DOMContentLoaded', initDrawerKeyboardShortcuts);
        
        function renderReportPreviewV12(data, completionStatus) {
            if (!data || Object.keys(data).length === 0) {
                return '';
            }
            
            drawerNumCounter = 0;
            const blocks = [];
            
            // Helper function to create a block
            const createBlockHTML = (type, content, fieldId = '', dataAttrs = '') => {
                const dragHandle = '<div class="drag-handle"><span></span><span></span><span></span><span></span><span></span><span></span></div>';
                const dataField = fieldId ? ` data-field="${fieldId}"` : '';
                const numAttr = type === 'num' ? ` data-num="${++drawerNumCounter}"` : '';
                return `<div class="b b-${type}"${dataField}${numAttr} ${dataAttrs}>${dragHandle}<div class="b-content" contenteditable="true">${content}</div></div>`;
            };
            
            // 1. TITLE
            const typeLabels = {
                'mise_en_service': 'Mise en service',
                'sav': 'SAV / Dpannage',
                'maintenance': 'Maintenance',
                'maintenance_preventive': 'Maintenance prventive',
                'audit': 'Audit'
            };
            const typeLabel = data.intervention?.type_label || typeLabels[data.intervention?.type] || data.intervention?.type || 'Intervention';
            blocks.push(createBlockHTML('h1', `Rapport d'intervention - ${typeLabel}`, 'title'));
            
            // 2. RSUM
            if (data.resume) {
                blocks.push(createBlockHTML('h2', 'Rsum', 'section_resume'));
                blocks.push(createBlockHTML('p', data.resume, 'resume_content'));
            }
            
            // 3. CLIENT
            if (data.client && (data.client.societe || data.client.contact)) {
                blocks.push(createBlockHTML('h2', 'Client', 'section_client'));
                if (data.client.societe) blocks.push(createBlockHTML('p', `<span class="lbl">Client :</span> <span class="val">${data.client.societe}</span>`, 'client_societe'));
                if (data.client.contact) blocks.push(createBlockHTML('p', `<span class="lbl">Contact :</span> <span class="val">${data.client.contact}</span>`, 'client_contact'));
                if (data.client.telephone) blocks.push(createBlockHTML('p', `<span class="lbl">Tlphone :</span> <span class="val">${data.client.telephone}</span>`, 'client_tel'));
            }
            
            // 4. SITE
            if (data.site && (data.site.adresse || data.site.ville)) {
                blocks.push(createBlockHTML('h2', 'Site', 'section_site'));
                if (data.site.adresse) blocks.push(createBlockHTML('p', `<span class="lbl">Adresse :</span> <span class="val">${data.site.adresse}</span>`, 'site_adresse'));
                if (data.site.ville) blocks.push(createBlockHTML('p', `<span class="lbl">Ville :</span> <span class="val">${data.site.ville}</span>`, 'site_ville'));
                if (data.site.numero_affaire) blocks.push(createBlockHTML('p', `<span class="lbl">N Affaire :</span> <span class="val">${data.site.numero_affaire}</span>`, 'site_affaire'));
            }
            
            // 5. INTERVENANT
            if (data.technicien && (data.technicien.entreprise || data.technicien.nom)) {
                blocks.push(createBlockHTML('h2', 'Intervenant', 'section_intervenant'));
                if (data.technicien.entreprise) blocks.push(createBlockHTML('p', `<span class="lbl">Entreprise :</span> <span class="val">${data.technicien.entreprise}</span>`, 'tech_entreprise'));
                if (data.technicien.nom) blocks.push(createBlockHTML('p', `<span class="lbl">Technicien :</span> <span class="val">${data.technicien.nom}</span>`, 'tech_nom'));
            }
            
            // 6. QUIPEMENTS - with deduplication
            if (data.equipements && data.equipements.length > 0) {
                blocks.push(createBlockHTML('h2', 'quipements', 'section_equipements'));
                
                // Deduplicate equipment by modele
                const seen = new Set();
                const uniqueEquipements = data.equipements.filter(eq => {
                    const key = (eq.modele || '').toLowerCase().trim();
                    if (seen.has(key) || !key) return false;
                    seen.add(key);
                    return true;
                });
                
                uniqueEquipements.forEach((eq, i) => {
                    let text = '';
                    if (eq.marque) text += eq.marque + ' ';
                    text += eq.modele || 'quipement';
                    if (eq.type_ui) text += ` (${eq.type_ui})`;
                    if (eq.role) text += ` [${eq.role.replace('_', ' ')}]`;
                    blocks.push(createBlockHTML('bullet', text, `eq_${i}`));
                });
            }
            
            // 7. ADRESSAGE TABLE
            if (data.adressage && data.adressage.length > 0) {
                blocks.push(createBlockHTML('h2', 'Adressage rseau', 'section_adressage'));
                let tableHTML = `<div class="b b-table" data-field="table_adressage">
                    <table class="rpt-tbl">
                        <thead><tr>
                            <th contenteditable="true">ADR</th>
                            <th contenteditable="true">MODLE</th>
                            <th contenteditable="true">ZONE</th>
                            <th contenteditable="true">N SRIE</th>
                        </tr></thead>
                        <tbody>`;
                
                data.adressage.forEach(entry => {
                    // Handle multiple field name formats from backend
                    const adr = entry.adresse || entry.equipement_id || entry.ref_usine || '';
                    const modele = entry.modele || entry.model || '';
                    const zone = entry.zone || entry.designation || '';
                    const serie = entry.numero_serie || entry.serie || '';
                    
                    tableHTML += `<tr>
                        <td contenteditable="true">${adr}</td>
                        <td contenteditable="true">${modele || ' complter'}</td>
                        <td contenteditable="true">${zone || ' complter'}</td>
                        <td contenteditable="true">${serie || 'En attente'}</td>
                    </tr>`;
                });
                
                tableHTML += `</tbody></table>
                    <div class="tbl-actions">
                        <button class="tbl-btn" onclick="drawerAddTableRow(this)">+ Ligne</button>
                        <button class="tbl-btn" onclick="drawerAddTableCol(this)">+ Colonne</button>
                        <button class="tbl-btn tbl-btn-danger" onclick="drawerRemoveTableRow(this)">- Ligne</button>
                        <button class="tbl-btn tbl-btn-danger" onclick="drawerRemoveTableCol(this)">- Colonne</button>
                    </div>
                </div>`;
                blocks.push(tableHTML);
            }
            
            // 8. FLUIDE
            if (data.fluide_global && (data.fluide_global.type || data.fluide_global.charge_totale_site_kg)) {
                blocks.push(createBlockHTML('h2', 'Fluide frigorigne', 'section_fluide'));
                if (data.fluide_global.type) blocks.push(createBlockHTML('p', `<span class="lbl">Type :</span> <span class="val">${data.fluide_global.type}</span>`, 'fluide_type'));
                if (data.fluide_global.charge_usine_kg) blocks.push(createBlockHTML('p', `<span class="lbl">Charge usine :</span> <span class="val">${data.fluide_global.charge_usine_kg} kg</span>`, 'fluide_charge'));
                if (data.fluide_global.charge_totale_site_kg) blocks.push(createBlockHTML('p', `<span class="lbl">Charge totale :</span> <span class="val">${data.fluide_global.charge_totale_site_kg} kg</span>`, 'fluide_total'));
            }
            
            // 9. MESURES TABLE
            if (data.mesures && data.mesures.length > 0) {
                blocks.push(createBlockHTML('h2', 'Mesures', 'section_mesures'));
                let tableHTML = `<div class="b b-table" data-field="table_mesures">
                    <table class="rpt-tbl">
                        <thead><tr>
                            <th contenteditable="true">PARAMTRE</th>
                            <th contenteditable="true">VALEUR</th>
                            <th contenteditable="true">UNIT</th>
                            <th contenteditable="true">STATUS</th>
                        </tr></thead>
                        <tbody>`;
                
                data.mesures.forEach(m => {
                    tableHTML += `<tr>
                        <td contenteditable="true">${m.label || m.type || ''}</td>
                        <td contenteditable="true">${m.valeur || m.valeur_texte || ''}</td>
                        <td contenteditable="true">${m.unite || ''}</td>
                        <td contenteditable="true">${m.status === 'conforme' ? 'Conforme' : (m.status || '')}</td>
                    </tr>`;
                });
                
                tableHTML += `</tbody></table>
                    <div class="tbl-actions">
                        <button class="tbl-btn" onclick="drawerAddTableRow(this)">+ Ligne</button>
                        <button class="tbl-btn" onclick="drawerAddTableCol(this)">+ Colonne</button>
                        <button class="tbl-btn tbl-btn-danger" onclick="drawerRemoveTableRow(this)">- Ligne</button>
                        <button class="tbl-btn tbl-btn-danger" onclick="drawerRemoveTableCol(this)">- Colonne</button>
                    </div>
                </div>`;
                blocks.push(tableHTML);
            }
            
            // 10. TRAVAUX EFFECTUS
            if (data.travaux_effectues && data.travaux_effectues.length > 0) {
                blocks.push(createBlockHTML('h2', 'Travaux effectus', 'section_travaux'));
                data.travaux_effectues.forEach((t, i) => {
                    const content = t.contenu || t.texte || t.titre || '';
                    blocks.push(createBlockHTML('arrow', content, `travaux_${i}`));
                });
            }
            
            // 11. RESERVES
            if (data.reserves && data.reserves.length > 0) {
                blocks.push(createBlockHTML('h2', 'Rserves', 'section_reserves'));
                data.reserves.forEach((r, i) => {
                    const content = r.titre || r.description || '';
                    blocks.push(createBlockHTML('bullet', content, `reserve_${i}`));
                });
            }
            
            // 12. RECOMMANDATIONS
            if (data.recommandations && data.recommandations.length > 0) {
                blocks.push(createBlockHTML('h2', 'Recommandations', 'section_recommandations'));
                data.recommandations.forEach((r, i) => {
                    const content = r.titre || r.description || r.texte || '';
                    blocks.push(createBlockHTML('arrow', content, `reco_${i}`));
                });
            }
            
            // 13. RSULTAT DE L'INTERVENTION - Simple style like other sections
            blocks.push(createBlockHTML('h2', 'Rsultat de l\'intervention', 'section_resultat'));
            
            // Status as simple label:value
            const statusLabels = {
                'resolu': ' Rsolu',
                'en_cours': ' En cours',
                'non_resolu': ' Non rsolu',
                'en_attente_pieces': ' En attente pices',
                'intervention_requise': ' Nouvelle intervention requise'
            };
            const statusText = statusLabels[data.resultat?.status] || data.resultat?.label || ' dfinir';
            blocks.push(createBlockHTML('p', `<span class="lbl">Statut :</span> <span class="val" contenteditable="true" data-field="resultat_status">${statusText}</span>`, 'resultat_status'));
            
            // Conclusion as editable paragraph
            const conclusionText = data.resultat?.description || data.resultat?.conclusion || '';
            blocks.push(createBlockHTML('p', `<span class="lbl">Conclusion :</span> <span class="val" contenteditable="true" data-field="resultat_conclusion">${conclusionText || 'Description du rsultat...'}</span>`, 'resultat_conclusion'));
            
            // 14. PHOTOS - Simple style, no + button (drop zone is enough)
            const photos = window.reportPhotos || [];
            blocks.push(createBlockHTML('h2', `Photos (${photos.length})`, 'section_photos'));
            
            // Hidden file input
            blocks.push(`<input type="file" id="photoUploadInputV12" accept="image/*" multiple style="display:none" onchange="handlePhotoUpload(event)">`);
            
            // Photos grid if we have photos
            if (photos.length > 0) {
                let photosHTML = `<div class="photos-grid-v12" id="sortablePhotosV12">`;
                photos.forEach((p, i) => {
                    const imgSrc = p.url || p.data || p.originalData || '';
                    const caption = p.caption || p.name || 'Photo ' + (i+1);
                    photosHTML += `<div class="photo-item-v12" data-index="${i}" draggable="true">
                        <img src="${imgSrc}" alt="${caption}" onclick="viewPhotoFull('${imgSrc}')" onerror="this.style.display='none'">
                        <input type="text" class="photo-caption-input" value="${caption}" onblur="updatePhotoCaption(${i}, this.value)" placeholder="Titre de la photo">
                        <button class="photo-remove-btn-v12" onclick="removePhoto(${i})"></button>
                    </div>`;
                });
                photosHTML += `</div>`;
                blocks.push(photosHTML);
            }
            
            // Drop zone
            blocks.push(`<div class="photo-drop-zone-v12" onclick="triggerPhotoUpload()" ondragover="handlePhotoDragOver(event)" ondrop="handlePhotoDrop(event)">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                    <circle cx="8.5" cy="8.5" r="1.5"></circle>
                    <polyline points="21 15 16 10 5 21"></polyline>
                </svg>
                <span>Glisser des photos ou cliquer pour ajouter</span>
            </div>`);
            
            // 15. TECHNICIEN - Horaires et autres (Nom/Entreprise dj dans Intervenant)
            blocks.push(createBlockHTML('h2', 'Technicien(s)', 'section_technicien'));
            blocks.push(createBlockHTML('p', `<span class="lbl">Nom :</span> <span class="val" contenteditable="true" data-field="technicien_nom">${data.technicien?.nom || 'Nom du technicien'}</span>`, 'tech_nom2'));
            blocks.push(createBlockHTML('p', `<span class="lbl">Entreprise :</span> <span class="val" contenteditable="true" data-field="technicien_entreprise">${data.technicien?.entreprise || 'Nom STA'}</span>`, 'tech_ent2'));
            blocks.push(createBlockHTML('p', `<span class="lbl">Arrive :</span> <span class="val" contenteditable="true" data-field="technicien_arrivee">${data.technicien?.heure_arrivee || 'HH:MM'}</span>  <span class="lbl" style="margin-left:24px;">Dpart :</span> <span class="val" contenteditable="true" data-field="technicien_depart">${data.technicien?.heure_depart || 'HH:MM'}</span>`, 'tech_horaires'));
            blocks.push(createBlockHTML('p', `<span class="lbl">Autre(s) technicien(s) :</span> <span class="val" contenteditable="true" data-field="technicien_autres">${data.technicien?.autres || 'Noms des autres techniciens prsents'}</span>`, 'tech_autres'));
            
            // 16. OBSERVATION CLIENT - Simple title + text
            blocks.push(createBlockHTML('h2', 'Observation(s) Client', 'section_observation'));
            blocks.push(createBlockHTML('p', `<span class="val" contenteditable="true" data-field="observation_client">${data.observation_client || 'Observations du client...'}</span>`, 'observation_text'));
            
            // 17. SIGNATURES
            const clientName = data.client?.contact || data.client?.societe || '';
            const techName = data.technicien?.nom || '';
            const clientSig = data.signatures?.client?.image || data.signatures?.client || data.signature_client || '';
            const techSig = data.signatures?.technicien?.image || data.signatures?.technicien || data.signature_technicien || '';
            const clientSigStr = typeof clientSig === 'string' ? clientSig : '';
            const techSigStr = typeof techSig === 'string' ? techSig : '';
            
            blocks.push(`
                <div class="rpt-signature-section">
                    <div class="rpt-signature-title">Signatures</div>
                    <div class="rpt-signature-grid">
                        <div class="rpt-signature-box">
                            <div class="rpt-signature-box-title">SIGNATURE CLIENT</div>
                            <div class="rpt-signature-area" id="sigAreaClient" onclick="openSignaturePad('client')">
                                ${clientSigStr ? `<img src="${clientSigStr}" alt="Signature client">` : '<span class="rpt-signature-placeholder">Touchez pour signer</span>'}
                            </div>
                            <input type="text" class="rpt-signature-name-input" id="sigNameClient" placeholder="Nom du signataire" value="${clientName}" onblur="drawerAutoSave()">
                        </div>
                        <div class="rpt-signature-box">
                            <div class="rpt-signature-box-title">SIGNATURE TECHNICIEN</div>
                            <div class="rpt-signature-area" id="sigAreaTech" onclick="openSignaturePad('technicien')">
                                ${techSigStr ? `<img src="${techSigStr}" alt="Signature technicien">` : '<span class="rpt-signature-placeholder">Touchez pour signer</span>'}
                            </div>
                            <input type="text" class="rpt-signature-name-input" id="sigNameTech" placeholder="Nom du signataire" value="${techName}" onblur="drawerAutoSave()">
                        </div>
                    </div>
                </div>
            `);
            
            return `<div class="rpt-doc" id="rptDoc">${blocks.join('')}</div>`;
        }
        
        // Initialize v12.5 features after rendering
        function initDrawerV12Features() {
            const doc = document.getElementById('rptDoc');
            if (!doc) return;
            
            // Init drag & drop on all drag handles
            doc.querySelectorAll('.drag-handle').forEach(handle => {
                handle.addEventListener('mousedown', (e) => {
                    drawerSaveState(); // Save state before drag
                    drawerStartDrag(e);
                });
                handle.addEventListener('touchstart', (e) => {
                    drawerSaveState();
                    drawerStartDrag(e);
                }, { passive: false });
            });
            
            // Init auto-save on all editable elements
            doc.querySelectorAll('[contenteditable="true"]').forEach(el => {
                // Save state when user starts editing
                el.addEventListener('focus', () => {
                    drawerSaveState();
                });
                
                // Handle blur - auto-save and check for empty lines
                el.addEventListener('blur', (e) => {
                    const block = e.target.closest('.b');
                    const content = e.target.textContent.trim();
                    
                    // Check if this is a deletable block (not h1, h2, or table)
                    const blockType = block?.className || '';
                    const isDeletable = block && 
                        !blockType.includes('b-h1') && 
                        !blockType.includes('b-h2') && 
                        !blockType.includes('b-table') &&
                        !block.querySelector('.rpt-signature-section');
                    
                    // Remove empty blocks (except headers, tables, signatures)
                    if (isDeletable && !content) {
                        // Check if this is a placeholder field that should remain
                        const dataField = e.target.dataset.field || block.dataset.field || '';
                        const isPlaceholder = dataField.includes('technicien') || 
                                             dataField.includes('observation') ||
                                             dataField.includes('resultat');
                        
                        if (!isPlaceholder) {
                            console.log('[Drawer] Removing empty block:', dataField);
                            block.remove();
                        }
                    }
                    
                    drawerAutoSave();
                });
                
                el.addEventListener('keydown', drawerHandleBlockKey);
            });
            
            // Init floating toolbar
            initDrawerFloatingToolbar();
            
            console.log('[Drawer v12.5] Features initialized');
        }
        
        // Floating toolbar initialization
        function initDrawerFloatingToolbar() {
            const fontToolbar = document.getElementById('fontToolbar');
            if (!fontToolbar) return;
            
            document.addEventListener('focusin', (e) => {
                if (e.target.matches('#rptDoc .b-content[contenteditable="true"]')) {
                    drawerActiveEditable = e.target;
                    showDrawerFontToolbar(e.target);
                }
            });
            
            document.addEventListener('click', (e) => {
                if (!fontToolbar.contains(e.target) && !e.target.closest('#rptDoc .b-content[contenteditable]')) {
                    hideDrawerFontToolbar();
                }
            });
            
            document.getElementById('ftBold')?.addEventListener('click', () => document.execCommand('bold'));
            document.getElementById('ftItalic')?.addEventListener('click', () => document.execCommand('italic'));
            document.getElementById('ftUnderline')?.addEventListener('click', () => document.execCommand('underline'));
            document.getElementById('ftAlignLeft')?.addEventListener('click', () => document.execCommand('justifyLeft'));
            document.getElementById('ftAlignCenter')?.addEventListener('click', () => document.execCommand('justifyCenter'));
            document.getElementById('ftJustify')?.addEventListener('click', () => document.execCommand('justifyFull'));
            
            document.querySelectorAll('.ft-dropdown-item').forEach(item => {
                item.addEventListener('click', () => {
                    const type = item.dataset.type;
                    if (drawerActiveEditable) {
                        const block = drawerActiveEditable.closest('.b');
                        if (block) {
                            block.className = 'b b-' + type;
                            document.getElementById('ftBlockType').textContent = item.textContent;
                            drawerAutoSave();
                        }
                    }
                });
            });
        }
        
        function showDrawerFontToolbar(element) {
            const fontToolbar = document.getElementById('fontToolbar');
            if (!fontToolbar) return;
            const rect = element.getBoundingClientRect();
            fontToolbar.style.left = Math.min(rect.left, window.innerWidth - 280) + 'px';
            fontToolbar.style.top = Math.max(10, rect.top - 40) + 'px';
            fontToolbar.classList.add('visible');
        }
        
        function hideDrawerFontToolbar() {
            document.getElementById('fontToolbar')?.classList.remove('visible');
            drawerActiveEditable = null;
        }
        
        // Drag & Drop functions
        function drawerStartDrag(e) {
            const block = e.target.closest('.b');
            if (!block) return;
            e.preventDefault();
            
            drawerDraggedElement = block;
            block.classList.add('dragging');
            
            document.addEventListener('mousemove', drawerOnDrag);
            document.addEventListener('mouseup', drawerEndDrag);
            document.addEventListener('touchmove', drawerOnDrag, { passive: false });
            document.addEventListener('touchend', drawerEndDrag);
        }
        
        function drawerOnDrag(e) {
            if (!drawerDraggedElement) return;
            e.preventDefault();
            
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            
            document.querySelectorAll('#rptDoc .b:not(.dragging)').forEach(block => {
                const rect = block.getBoundingClientRect();
                block.classList.toggle('drag-over', clientY < rect.top + rect.height / 2 && clientY > rect.top - 20);
            });
        }
        
        function drawerEndDrag() {
            if (!drawerDraggedElement) return;
            
            const dropTarget = document.querySelector('#rptDoc .b.drag-over');
            if (dropTarget && dropTarget !== drawerDraggedElement) {
                dropTarget.parentNode.insertBefore(drawerDraggedElement, dropTarget);
                drawerAutoSave();
            }
            
            drawerDraggedElement.classList.remove('dragging');
            document.querySelectorAll('#rptDoc .b.drag-over').forEach(b => b.classList.remove('drag-over'));
            drawerDraggedElement = null;
            
            document.removeEventListener('mousemove', drawerOnDrag);
            document.removeEventListener('mouseup', drawerEndDrag);
            document.removeEventListener('touchmove', drawerOnDrag);
            document.removeEventListener('touchend', drawerEndDrag);
        }
        
        // Block keyboard handling
        function drawerHandleBlockKey(e) {
            const block = e.target.closest('.b');
            if (!block) return;
            
            const content = block.querySelector('.b-content');
            const text = content?.textContent || '';
            
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                drawerSaveState(); // Save state before adding new block
                const newType = ['bullet', 'num', 'arrow'].includes(block.dataset.type) ? block.dataset.type : 'p';
                const newBlock = drawerCreateBlock(newType);
                block.parentNode.insertBefore(newBlock, block.nextSibling);
                newBlock.querySelector('.b-content')?.focus();
                drawerAutoSave();
            }
            
            if (e.key === 'Backspace' && text === '') {
                e.preventDefault();
                drawerSaveState(); // Save state before deleting block
                const prev = block.previousElementSibling;
                block.remove();
                if (prev?.querySelector('.b-content')) prev.querySelector('.b-content').focus();
                drawerAutoSave();
            }
        }
        
        function drawerCreateBlock(type, content = '') {
            const div = document.createElement('div');
            div.className = `b b-${type}`;
            div.dataset.type = type;
            
            if (type === 'num') {
                drawerNumCounter++;
                div.dataset.num = drawerNumCounter;
            }
            
            const dragHandle = document.createElement('div');
            dragHandle.className = 'drag-handle';
            for (let i = 0; i < 6; i++) dragHandle.appendChild(document.createElement('span'));
            dragHandle.addEventListener('mousedown', drawerStartDrag);
            div.appendChild(dragHandle);
            
            const contentEl = document.createElement('div');
            contentEl.className = 'b-content';
            contentEl.contentEditable = true;
            contentEl.innerHTML = content;
            contentEl.addEventListener('blur', drawerAutoSave);
            contentEl.addEventListener('keydown', drawerHandleBlockKey);
            div.appendChild(contentEl);
            
            return div;
        }
        
        // Table functions
        function drawerAddTableRow(btn) {
            drawerSaveState(); // Save state before change
            const wrapper = btn.closest('.b-table');
            const tbody = wrapper?.querySelector('tbody');
            const cols = wrapper?.querySelectorAll('thead th').length || 3;
            
            if (tbody) {
                const tr = document.createElement('tr');
                for (let i = 0; i < cols; i++) {
                    const td = document.createElement('td');
                    td.contentEditable = true;
                    td.addEventListener('focus', drawerSaveState);
                    td.addEventListener('blur', drawerAutoSave);
                    tr.appendChild(td);
                }
                tbody.appendChild(tr);
                drawerAutoSave();
            }
        }
        
        function drawerAddTableCol(btn) {
            drawerSaveState(); // Save state before change
            const wrapper = btn.closest('.b-table');
            const table = wrapper?.querySelector('table');
            if (!table) return;
            
            const th = document.createElement('th');
            th.contentEditable = true;
            th.textContent = 'Nouvelle';
            th.addEventListener('focus', drawerSaveState);
            th.addEventListener('blur', drawerAutoSave);
            table.querySelector('thead tr')?.appendChild(th);
            
            table.querySelectorAll('tbody tr').forEach(tr => {
                const td = document.createElement('td');
                td.contentEditable = true;
                td.addEventListener('blur', drawerAutoSave);
                tr.appendChild(td);
            });
            
            drawerAutoSave();
        }
        
        function drawerRemoveTableRow(btn) {
            drawerSaveState(); // Save state before change
            const wrapper = btn.closest('.b-table');
            const tbody = wrapper?.querySelector('tbody');
            const rows = tbody?.querySelectorAll('tr');
            if (rows && rows.length > 0) {
                rows[rows.length - 1].remove();
                drawerAutoSave();
            }
        }
        
        function drawerRemoveTableCol(btn) {
            drawerSaveState(); // Save state before change
            const wrapper = btn.closest('.b-table');
            const table = wrapper?.querySelector('table');
            if (!table) return;
            
            const headerCells = table.querySelectorAll('thead th');
            if (headerCells.length > 1) {
                headerCells[headerCells.length - 1].remove();
                table.querySelectorAll('tbody tr').forEach(tr => {
                    const cells = tr.querySelectorAll('td');
                    if (cells.length > 0) cells[cells.length - 1].remove();
                });
                drawerAutoSave();
            }
        }
        
        // Auto-save function
        function drawerAutoSave() {
            if (drawerAutoSaveTimeout) clearTimeout(drawerAutoSaveTimeout);
            
            drawerAutoSaveTimeout = setTimeout(async () => {
                if (!currentProjectId || !lastReportData) return;
                
                const doc = document.getElementById('rptDoc');
                if (!doc) return;
                
                drawerExtractDataFromDOM(doc, lastReportData);
                
                const indicator = document.getElementById('autosaveIndicator');
                if (indicator) {
                    indicator.textContent = 'Enregistrement...';
                    indicator.classList.remove('success');
                    indicator.classList.add('show');
                }
                
                try {
                    const completion = calculateReportCompletion(lastReportData);
                    const progressValue = Math.round(completion.percentage);

                    // FIX-4: Use centralized debounced save
                    debouncedSaveExtractedData(lastReportData, progressValue);

                    // Update progress bar
                    const progressFill = document.getElementById('reportProgressFill');
                    const progressText = document.getElementById('reportProgressText');
                    if (progressFill) progressFill.style.width = progressValue + '%';
                    if (progressText) progressText.textContent = progressValue + '%';

                    if (indicator) {
                        indicator.textContent = 'Enregistr ';
                        indicator.classList.add('success');
                        setTimeout(() => indicator.classList.remove('show'), 1500);
                    }

                    console.log('[AutoSave]  Saved - Progress:', progressValue + '%');
                } catch (err) {
                    console.error('[AutoSave]  Error:', err);
                    if (indicator) {
                        indicator.textContent = 'Erreur sauvegarde';
                        setTimeout(() => indicator.classList.remove('show'), 2000);
                    }
                }
            }, 800);
        }
        
        function drawerExtractDataFromDOM(doc, data) {
            const getFieldText = (selector) => {
                const el = doc.querySelector(selector);
                return el?.textContent?.trim() || '';
            };
            
            // Extract resume
            const resumeEl = doc.querySelector('[data-field="resume_content"] .b-content');
            if (resumeEl) data.resume = resumeEl.textContent.trim();
            
            // Extract signatures names
            if (!data.signatures) data.signatures = {};
            const clientSigName = document.getElementById('sigNameClient')?.value;
            const techSigName = document.getElementById('sigNameTech')?.value;
            if (clientSigName) {
                if (!data.signatures.client) data.signatures.client = {};
                data.signatures.client.nom = clientSigName;
            }
            if (techSigName) {
                if (!data.signatures.technicien) data.signatures.technicien = {};
                data.signatures.technicien.nom = techSigName;
            }
            
            // Extract adressage table (4 columns: ADR, MODLE, ZONE, N SRIE)
            const adressageTable = doc.querySelector('[data-field="table_adressage"] tbody');
            if (adressageTable) {
                data.adressage = [];
                adressageTable.querySelectorAll('tr').forEach(tr => {
                    const cells = tr.querySelectorAll('td');
                    if (cells.length >= 4) {
                        const adr = cells[0].textContent.trim();
                        const modele = cells[1].textContent.trim();
                        const zone = cells[2].textContent.trim();
                        const serie = cells[3].textContent.trim();
                        
                        // Only add if not placeholder text
                        if (adr || (modele && modele !== ' complter')) {
                            data.adressage.push({
                                adresse: adr,
                                modele: modele !== ' complter' ? modele : '',
                                zone: zone !== ' complter' ? zone : '',
                                designation: zone !== ' complter' ? zone : '',
                                numero_serie: serie !== 'En attente' ? serie : ''
                            });
                        }
                    }
                });
            }
            
            // Extract mesures table
            const mesuresTable = doc.querySelector('[data-field="table_mesures"] tbody');
            if (mesuresTable) {
                data.mesures = [];
                mesuresTable.querySelectorAll('tr').forEach(tr => {
                    const cells = tr.querySelectorAll('td');
                    if (cells.length >= 4) {
                        data.mesures.push({
                            label: cells[0].textContent.trim(),
                            valeur: cells[1].textContent.trim(),
                            unite: cells[2].textContent.trim(),
                            status: cells[3].textContent.trim().toLowerCase()
                        });
                    }
                });
            }
            
            // Extract technicien fields from contenteditable spans
            const techNomEl = doc.querySelector('[data-field="technicien_nom"]');
            const techEntrepriseEl = doc.querySelector('[data-field="technicien_entreprise"]');
            const techArriveeEl = doc.querySelector('[data-field="technicien_arrivee"]');
            const techDepartEl = doc.querySelector('[data-field="technicien_depart"]');
            const techAutresEl = doc.querySelector('[data-field="technicien_autres"]');
            
            if (!data.technicien) data.technicien = {};
            if (techNomEl) {
                const nom = techNomEl.textContent.trim();
                if (nom && nom !== 'Nom du technicien') data.technicien.nom = nom;
            }
            if (techEntrepriseEl) {
                const ent = techEntrepriseEl.textContent.trim();
                if (ent && ent !== 'Nom STA') data.technicien.entreprise = ent;
            }
            if (techArriveeEl) {
                const arr = techArriveeEl.textContent.trim();
                if (arr && arr !== 'HH:MM') data.technicien.heure_arrivee = arr;
            }
            if (techDepartEl) {
                const dep = techDepartEl.textContent.trim();
                if (dep && dep !== 'HH:MM') data.technicien.heure_depart = dep;
            }
            if (techAutresEl) {
                const autres = techAutresEl.textContent.trim();
                if (autres) data.technicien.autres = autres;
            }
            
            // Extract observation client from contenteditable
            const observationEl = doc.querySelector('[data-field="observation_client"]');
            if (observationEl) {
                const obs = observationEl.textContent.trim();
                if (obs && obs !== 'Observations du client...') data.observation_client = obs;
            }
            
            // Extract resultat from contenteditable
            const resultatStatusEl = doc.querySelector('[data-field="resultat_status"]');
            const resultatConclusionEl = doc.querySelector('[data-field="resultat_conclusion"]');
            if (!data.resultat) data.resultat = {};
            if (resultatStatusEl) {
                const status = resultatStatusEl.textContent.trim();
                if (status && status !== ' dfinir') {
                    data.resultat.label = status;
                    // Try to map back to status code
                    const statusMap = {
                        ' Rsolu': 'resolu',
                        ' En cours': 'en_cours',
                        ' Non rsolu': 'non_resolu',
                        ' En attente pices': 'en_attente_pieces',
                        ' Nouvelle intervention requise': 'intervention_requise'
                    };
                    data.resultat.status = statusMap[status] || status;
                }
            }
            if (resultatConclusionEl) {
                const conclusion = resultatConclusionEl.textContent.trim();
                if (conclusion && conclusion !== 'Description du rsultat...') {
                    data.resultat.description = conclusion;
                    data.resultat.conclusion = conclusion;
                }
            }
        }
        
        //  HELPER FUNCTIONS FOR V12.5 SECTIONS 
        // (These are kept for backwards compatibility but contenteditable is now used)
        
        function updateTechField(field, value) {
            if (!lastReportData) lastReportData = {};
            if (!lastReportData.technicien) lastReportData.technicien = {};
            lastReportData.technicien[field] = value;
            drawerAutoSave();
        }
        
        function updateObservationClient(value) {
            if (!lastReportData) lastReportData = {};
            lastReportData.observation_client = value;
            drawerAutoSave();
        }
        
        function updateResultatStatus(value) {
            if (!lastReportData) lastReportData = {};
            if (!lastReportData.resultat) lastReportData.resultat = {};
            lastReportData.resultat.status = value;
            // Set label based on status
            const labels = {
                'resolu': 'Rsolu',
                'en_cours': 'En cours',
                'non_resolu': 'Non rsolu',
                'en_attente_pieces': 'En attente pices',
                'intervention_requise': 'Nouvelle intervention requise'
            };
            lastReportData.resultat.label = labels[value] || '';
            drawerAutoSave();
        }
        
        function updateResultatConclusion(value) {
            if (!lastReportData) lastReportData = {};
            if (!lastReportData.resultat) lastReportData.resultat = {};
            lastReportData.resultat.description = value;
            lastReportData.resultat.conclusion = value;
            drawerAutoSave();
        }
        
        function updatePhotoCaption(index, caption) {
            if (window.reportPhotos && window.reportPhotos[index]) {
                window.reportPhotos[index].caption = caption;
                window.reportPhotos[index].name = caption;
                drawerAutoSave();
            }
        }
        
        // Override triggerPhotoUpload to work with v12.5 input
        function triggerPhotoUpload() {
            const input = document.getElementById('photoUploadInputV12') || document.getElementById('photoUploadInput');
            if (input) input.click();
        }
        
        // Complete report function
        // FIX-F: showNotification  displays a toast notification
        function showNotification(message, type = 'info') {
            const t = document.getElementById('toast');
            if (!t) {
                console.log('[Notification]', type, message);
                return;
            }
            t.textContent = message;
            t.className = 'show';
            if (type === 'error') t.style.background = 'linear-gradient(135deg, #ef4444, #dc2626)';
            else if (type === 'success') t.style.background = 'linear-gradient(135deg, #22c55e, #16a34a)';
            else t.style.background = '';
            if (window._notifTimeout) clearTimeout(window._notifTimeout);
            window._notifTimeout = setTimeout(() => {
                t.classList.remove('show');
                t.style.background = '';
            }, 3000);
        }

        async function completeReportV12() {
            if (!currentProjectId || !lastReportData) return;
            
            const doc = document.getElementById('rptDoc');
            if (doc) drawerExtractDataFromDOM(doc, lastReportData);
            
            lastReportData.status = 'completed';
            lastReportData.completed_at = new Date().toISOString();
            reportIsCompleted = true;
            
            const progressFill = document.getElementById('reportProgressFill');
            const progressText = document.getElementById('reportProgressText');
            if (progressFill) progressFill.style.width = '100%';
            if (progressText) progressText.textContent = '100%';
            
            try {
                // FIX-4: Direct write for completion (needs status: 'completed' immediately)
                const { error } = await db.from('projects')
                    .update({
                        extracted_data: lastReportData,
                        progress: 100,
                        status: 'completed',
                        completion_status: 'completed',
                        completed_at: new Date().toISOString(),
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', currentProjectId);

                if (error) throw error;

                updateReportFooterButtonsV12(true);
                showNotification('Rapport complt !', 'success');
            } catch (err) {
                console.error('[Complete] Error:', err);
                showNotification('Erreur lors de la compltion', 'error');
            }
        }
        
        function updateReportFooterButtonsV12(isCompleted) {
            const footer = document.getElementById('reportFooter');
            if (!footer) return;
            
            if (isCompleted) {
                footer.innerHTML = `
                    <button class="r-btn secondary" onclick="exportReportWordV12()" style="flex: 1;">
                        <span style="margin-right:6px;"></span> Exporter Word
                    </button>
                `;
            } else {
                footer.innerHTML = `
                    <button class="r-btn primary" onclick="completeReportV12()" style="flex: 1;">
                         Complter le rapport
                    </button>
                `;
            }
        }
        
        async function exportReportWordV12() {
            console.log('[Export v12.5] Starting export...');
            
            // Extract latest data from DOM before export
            const doc = document.getElementById('rptDoc');
            if (doc && lastReportData) {
                drawerExtractDataFromDOM(doc, lastReportData);
                console.log('[Export v12.5] Extracted data from DOM');
            }
            
            console.log('[Export v12.5] lastReportData:', lastReportData);
            
            // Use the existing export function
            if (typeof exportReport === 'function') {
                console.log('[Export v12.5] Calling exportReport("word")');
                exportReport('word');
            } else if (typeof exportReportPDF === 'function') {
                console.log('[Export v12.5] Calling exportReportPDF()');
                exportReportPDF();
            } else {
                console.error('[Export v12.5] No export function found!');
                showNotification('Erreur: fonction export non disponible', 'error');
            }
        }
        
        // 
        // EDITABLE REPORT FUNCTIONS
        // 
        
        // Update a single field in the report data
        function updateReportField(fieldPath, value) {
            if (!lastReportData) lastReportData = {};
            
            const parts = fieldPath.split('.');
            let obj = lastReportData;
            
            for (let i = 0; i < parts.length - 1; i++) {
                const part = parts[i];
                const nextPart = parts[i + 1];
                
                // Check if next part is an array index
                if (!isNaN(parseInt(nextPart))) {
                    if (!Array.isArray(obj[part])) obj[part] = [];
                } else {
                    if (!obj[part] || typeof obj[part] !== 'object') obj[part] = {};
                }
                obj = obj[part];
            }
            
            const lastPart = parts[parts.length - 1];
            obj[lastPart] = value;
            
            // Update progress bar
            updateReportProgress();

            // Auto-save indicator
            showAutoSaveIndicator();

            //  AUTO-SAVE extracted_data AND progress with debounce   (FIX-4)
            if (currentProjectId && lastReportData) {
                const completion = calculateReportCompletion(lastReportData);
                debouncedSaveExtractedData(lastReportData, completion.percentage);
                // Also save to reports table (debounced separately)
                clearTimeout(extractedDataSaveTimeout);
                extractedDataSaveTimeout = setTimeout(async () => {
                    await saveReportData(currentProjectId, lastReportData);
                }, 1500);
            }
        }

        // Add a new item to a list field
        function addReportListItem(listName) {
            if (!lastReportData) lastReportData = {};
            if (!lastReportData[listName]) lastReportData[listName] = [];
            
            let newItem = {};
            switch(listName) {
                case 'codes_defaut':
                    newItem = { code: '', description: '' };
                    break;
                case 'travaux_effectues':
                    newItem = { texte: '', status: 'done' };
                    break;
                case 'travaux_prevoir':
                    newItem = { texte: '', status: 'pending' };
                    break;
                case 'mesures':
                    newItem = { label: '', valeur: '', unite: '' };
                    break;
                case 'reserves':
                    newItem = { titre: '', texte: '' };
                    break;
                case 'adressage':
                    newItem = { ref_usine: '', serie: '', adresse: '', designation: '', commentaire: '' };
                    break;
                case 'pieces':
                    newItem = { reference: '', designation: '', quantite: '' };
                    break;
                default:
                    newItem = {};
            }
            
            lastReportData[listName].push(newItem);
            
            // Re-render and update progress
            refreshReportPreview();
            updateReportProgress();
            showAutoSaveIndicator();
            
            // Item added to list
        }
        
        // Remove an item from a list field
        function removeReportListItem(listName, index) {
            if (!lastReportData || !lastReportData[listName]) return;
            
            lastReportData[listName].splice(index, 1);
            
            // Re-render and update progress
            refreshReportPreview();
            updateReportProgress();
            showAutoSaveIndicator();
            
            // Item removed from list
        }
        
        // Refresh the report preview with current data - v12.5
        function refreshReportPreview() {
            const previewContent = document.getElementById('reportPreviewContent');
            if (!previewContent) return;
            
            const completionStatus = calculateReportCompletion(lastReportData || {});
            const html = renderReportPreviewV12(lastReportData, completionStatus);
            previewContent.innerHTML = html;
            
            // Initialize v12.5 features
            initDrawerV12Features();
            
            // Update footer buttons
            const isCompleted = lastReportData?.status === 'completed' || completionStatus?.percentage >= 100;
            updateReportFooterButtonsV12(isCompleted);
            
            // Initialize photo drag-drop
            initPhotoDragDrop();
        }
        
        // Attach event listeners to editable fields
        function attachEditableListeners() {
            const editableFields = document.querySelectorAll('.editable-report .editable-field');
            
            editableFields.forEach(field => {
                // Handle blur (when user clicks away)
                field.addEventListener('blur', function() {
                    const fieldPath = this.dataset.field;
                    const value = this.textContent.trim();
                    
                    // Update empty class
                    if (value === '') {
                        this.classList.add('empty');
                    } else {
                        this.classList.remove('empty');
                    }
                    
                    updateReportField(fieldPath, value);
                });
                
                // Handle focus (remove placeholder look)
                field.addEventListener('focus', function() {
                    if (this.classList.contains('empty')) {
                        this.textContent = '';
                    }
                });
                
                // Handle Enter key in single-line fields
                field.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter' && this.tagName === 'SPAN') {
                        e.preventDefault();
                        this.blur();
                    }
                });
            });
        }
        
        // Update progress bar in drawer header
        function updateReportProgress() {
            const progressFill = document.getElementById('reportProgressFill');
            const progressText = document.getElementById('reportProgressText');
            const headerProgress = document.getElementById('reportHeaderProgress');
            
            if (!progressFill || !progressText) return;
            
            const completion = calculateReportCompletion(lastReportData || {});
            
            // Show/hide progress bar
            if (headerProgress) {
                headerProgress.style.display = completion.percentage > 0 ? 'flex' : 'none';
            }
            
            progressFill.style.width = completion.percentage + '%';
            progressText.textContent = completion.percentage + '%';
        }
        
        // Show auto-save indicator
        function showAutoSaveIndicator() {
            // Could show a small toast or indicator
            // For now, just log
        }
        
        // Initialize editable report when drawer opens
        function initEditableReport() {
            setTimeout(() => {
                attachEditableListeners();
            }, 100);
        }
        
        // Simple markdown parser
        function parseMarkdown(text) {
            if (!text) return '';
            
//  Strip [REPORT_DATA] blocks - report displays in drawer only 
// Tables, lists, and other markdown formatting are preserved
text = text.replace(/\[REPORT_DATA\][\s\S]*?\[\/REPORT_DATA\]/g, '').trim();

// Also strip any embedded JSON with type:report (legacy format)
text = text.replace(/\s*\{"type"\s*:\s*"report"[\s\S]*\}\s*$/, '').trim();
            
            // Strip any unparseable REPORT_DATA blocks
            text = text.replace(/\[REPORT_DATA\][\s\S]*?\[\/REPORT_DATA\]/g, '').trim();

            //  EXTRACT MERMAID DIAGRAMS 
            // Use %%MERMAID_X%% format to avoid conflict with markdown __ bold syntax
            const mermaidBlocks = [];
            text = text.replace(/```mermaid\n([\s\S]*?)```/g, (match, code) => {
                const placeholder = `%%MERMAID_${mermaidBlocks.length}%%`;
                mermaidBlocks.push(code.trim());
                return placeholder;
            });

            //  HELPER: Restore mermaid placeholders - MUST be called on ALL return paths 
            function restoreMermaid(html) {
                if (mermaidBlocks.length === 0) return html;
                mermaidBlocks.forEach((code, i) => {
                    const escapedCode = code
                        .replace(/&/g, '&amp;')
                        .replace(/"/g, '&quot;')
                        .replace(/</g, '&lt;')
                        .replace(/>/g, '&gt;');
                    html = html.replace(
                        `%%MERMAID_${i}%%`,
                        `<div class="mermaid-placeholder" data-mermaid-code="${escapedCode}"><div class="mermaid-loading">Chargement du diagramme...</div></div>`
                    );
                });
                return html;
            }

            //  CHECK FOR JSON REPORT 
            // If the AI returns structured JSON, use the beautiful template
            let trimmed = text.trim();
            
            // Check if JSON is wrapped in markdown code block
            // Pattern handles: ```json, ``` json, ```\njson, ``` \n json, etc.
            const codeBlockMatch = trimmed.match(/```\s*(?:json)?\s*([\s\S]*?)\s*```/);
            if (codeBlockMatch) {
                const jsonContent = codeBlockMatch[1].trim();
                if (jsonContent.startsWith('{')) {
                    try {
                        const jsonData = JSON.parse(jsonContent);
                        if (jsonData.type === 'report' || jsonData.resume || jsonData.travaux_effectues || jsonData.resultat) {
                            // Extract intro text before the code block
                            const introMatch = trimmed.match(/^([\s\S]*?)```/);
                            const introText = introMatch ? introMatch[1].trim() : '';
                            const reportHtml = renderReport(jsonData.data || jsonData);
                            return restoreMermaid(introText ? `<p>${introText.replace(/\n/g, '<br>')}</p>${reportHtml}` : reportHtml);
                        }
                    } catch (e) {
                        // Code block is not valid JSON report
                    }
                }
            }

            // Check for raw JSON (starts with { and ends with })
            if (trimmed.startsWith('{') && trimmed.endsWith('}')) {
                try {
                    const jsonData = JSON.parse(trimmed);
                    if (jsonData.type === 'report' || jsonData.resume || jsonData.travaux_effectues || jsonData.resultat) {
                        return restoreMermaid(renderReport(jsonData.data || jsonData));
                    }
                } catch (e) {
                    // Not valid JSON, parsing as markdown
                }
            }

            // Check for JSON embedded in text (intro text + JSON)
            // Match JSON with any report-related fields (client, resultat, resume, travaux, or type:report)
            const embeddedJsonMatch = trimmed.match(/^([\s\S]*?)\s*(\{[\s\S]*(?:"client"|"resultat"|"resume"|"travaux_effectues"|"type"\s*:\s*"report")[\s\S]*\})\s*$/);
            if (embeddedJsonMatch) {
                try {
                    const jsonData = JSON.parse(embeddedJsonMatch[2]);
                    const introText = embeddedJsonMatch[1].trim();
                    const reportHtml = renderReport(jsonData.data || jsonData);
                    return restoreMermaid(introText ? `<p>${introText.replace(/\n/g, '<br>')}</p>${reportHtml}` : reportHtml);
                } catch (e) {
                    // Embedded JSON parse failed
                }
            }
            
            // Strip ALL HTML tags the AI might output (inline styles, divs, etc.)
            // This is necessary because sometimes AI generates HTML instead of markdown
            text = text.replace(/<[^>]*style="[^"]*"[^>]*>/gi, ''); // Remove tags with style attributes
            text = text.replace(/<div[^>]*>/gi, '');
            text = text.replace(/<\/div>/gi, '');
            text = text.replace(/<span[^>]*>/gi, '');
            text = text.replace(/<\/span>/gi, '');
            text = text.replace(/<table[^>]*>/gi, '');
            text = text.replace(/<\/table>/gi, '');
            text = text.replace(/<tr[^>]*>/gi, '');
            text = text.replace(/<\/tr>/gi, '');
            text = text.replace(/<td[^>]*>/gi, ' ');
            text = text.replace(/<\/td>/gi, '');
            text = text.replace(/<th[^>]*>/gi, ' ');
            text = text.replace(/<\/th>/gi, '');
            text = text.replace(/<thead[^>]*>/gi, '');
            text = text.replace(/<\/thead>/gi, '');
            text = text.replace(/<tbody[^>]*>/gi, '');
            text = text.replace(/<\/tbody>/gi, '');
            text = text.replace(/<h[1-6][^>]*>/gi, '\n');
            text = text.replace(/<\/h[1-6]>/gi, '\n');
            text = text.replace(/<p[^>]*>/gi, '\n');
            text = text.replace(/<\/p>/gi, '\n');
            text = text.replace(/<br\s*\/?>/gi, '\n');
            text = text.replace(/<ul[^>]*>/gi, '');
            text = text.replace(/<\/ul>/gi, '');
            text = text.replace(/<li[^>]*>/gi, ' ');
            text = text.replace(/<\/li>/gi, '\n');
            text = text.replace(/<strong[^>]*>/gi, '**');
            text = text.replace(/<\/strong>/gi, '**');
            text = text.replace(/<em[^>]*>/gi, '*');
            text = text.replace(/<\/em>/gi, '*');
            text = text.replace(/<b[^>]*>/gi, '**');
            text = text.replace(/<\/b>/gi, '**');
            text = text.replace(/<i[^>]*>/gi, '*');
            text = text.replace(/<\/i>/gi, '*');
            // Remove any remaining HTML tags
            text = text.replace(/<[^>]+>/g, '');
            // Clean up multiple newlines
            text = text.replace(/\n{3,}/g, '\n\n');
            // Remove leading/trailing whitespace from lines
            text = text.split('\n').map(line => line.trim()).join('\n');
            
            // Check if this contains a report
            const reportMarker = 'RAPPORT D\'INTERVENTION';
            const hasReport = text.includes(reportMarker);
            let introText = '';
            let reportContent = '';
            
            if (hasReport) {
                const reportIndex = text.indexOf(reportMarker);
                introText = text.substring(0, reportIndex).trim();
                reportContent = text.substring(reportIndex).trim();
            }
            
            function parseTable(tableText) {
                const lines = tableText.trim().split('\n');
                if (lines.length < 2) return tableText;
                
                let html = '<table><thead><tr>';
                // Header row
                const headers = lines[0].split('|').map(h => h.trim()).filter(h => h);
                headers.forEach(h => {
                    html += `<th>${h}</th>`;
                });
                html += '</tr></thead><tbody>';
                
                // Skip separator line (index 1), process data rows
                for (let i = 2; i < lines.length; i++) {
                    const cells = lines[i].split('|').map(c => c.trim()).filter(c => c);
                    if (cells.length > 0 && !cells.every(c => c === '...' || c === '')) {
                        html += '<tr>';
                        cells.forEach(c => {
                            html += `<td>${c}</td>`;
                        });
                        html += '</tr>';
                    }
                }
                html += '</tbody></table>';
                return html;
            }
            
            function processMarkdown(txt) {
                // First, extract and process tables
                const tableRegex = /\|[^\n]+\|\n\|[-:\s|]+\|\n(\|[^\n]+\|\n?)*/g;
                let tables = [];
                txt = txt.replace(tableRegex, (match) => {
                    const placeholder = `__TABLE_${tables.length}__`;
                    tables.push(parseTable(match));
                    return placeholder;
                });
                
                // Escape HTML
                let html = txt
                    .replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;');
                
                // Restore tables
                tables.forEach((table, i) => {
                    html = html.replace(`__TABLE_${i}__`, table);
                });
                
                // Headers
                html = html.replace(/^### (.*$)/gm, '<h3>$1</h3>');
                html = html.replace(/^## (.*$)/gm, '<h2>$1</h2>');
                html = html.replace(/^# (.*$)/gm, '<h1>$1</h1>');
                
                // Bold and italic
                html = html.replace(/\*\*\*(.*?)\*\*\*/g, '<strong><em>$1</em></strong>');
                html = html.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                html = html.replace(/\*(.*?)\*/g, '<em>$1</em>');
                html = html.replace(/__(.*?)__/g, '<strong>$1</strong>');
                html = html.replace(/_(.*?)_/g, '<em>$1</em>');
                
                // Code blocks
                html = html.replace(/```([\s\S]*?)```/g, '<pre><code>$1</code></pre>');
                html = html.replace(/`(.*?)`/g, '<code>$1</code>');
                
                // Blockquotes
                html = html.replace(/^> (.*$)/gm, '<blockquote>$1</blockquote>');
                
                // Horizontal rule
                html = html.replace(/^---$/gm, '<hr>');
                
                // Unordered lists
                html = html.replace(/^\s*[-*]\s+(.*$)/gm, '<li>$1</li>');
                html = html.replace(/(<li>.*<\/li>\n?)+/g, '<ul>$&</ul>');
                
                // Ordered lists
                html = html.replace(/^\s*\d+\.\s+(.*$)/gm, '<li>$1</li>');
                
                // Paragraphs (double newlines)
                html = html.replace(/\n\n+/g, '</p><p>');
                
                // Single newlines to <br>
                html = html.replace(/\n/g, '<br>');
                
                // Wrap in paragraph if not already wrapped
                if (!html.startsWith('<h') && !html.startsWith('<ul') && !html.startsWith('<ol') && !html.startsWith('<pre') && !html.startsWith('<blockquote') && !html.startsWith('<table')) {
                    html = '<p>' + html + '</p>';
                }
                
                // Clean up empty paragraphs
                html = html.replace(/<p><\/p>/g, '');
                html = html.replace(/<p><br><\/p>/g, '');

                return html;
            }

            if (hasReport) {
                // Process intro text normally
                let result = introText ? processMarkdown(introText) : '';
                
                // Process report content and wrap in card
                let reportHtml = processMarkdown(reportContent);
                
                // Style the report title
                reportHtml = reportHtml.replace(
                    /RAPPORT D(&amp;#39;|&#39;|')INTERVENTION/g, 
                    '<span class="report-title">RAPPORT D\'INTERVENTION</span>'
                );
                
                // Add menu to report card
                const menuHtml = `<div class="report-menu">
                    <button class="report-menu-btn" onclick="toggleReportMenu(event, this)">
                        <span class="icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="1"/><circle cx="12" cy="5" r="1"/><circle cx="12" cy="19" r="1"/></svg></span>
                    </button>
                    <div class="report-menu-dropdown">
                        <div class="report-menu-item" onclick="copyReportContent(event, this)">
                            <span class="icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg></span>
                            <span>Copier</span>
                        </div>
                        <div class="report-menu-item" onclick="shareReportMenu(event, this)">
                            <span class="icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/></svg></span>
                            <span>Partager</span>
                        </div>
                        <div class="report-menu-item" onclick="exportReportPDFMenu(event, this)">
                            <span class="icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="12" y1="18" x2="12" y2="12"/><line x1="9" y1="15" x2="15" y2="15"/></svg></span>
                            <span>Exporter</span>
                        </div>
                    </div>
                </div>`;
                
                result += '<div class="report-card">' + menuHtml + reportHtml + '</div>';
                return restoreMermaid(result);
            }

            return restoreMermaid(processMarkdown(text));
        }
        
        // Add loading message
        //  HELPER: Clear chat body while preserving TP container 
        function clearChatBody(panel) {
            const body = document.getElementById(panel + 'Body');
            if (!body) return;
            // Remove only message elements, keep TP container
            body.querySelectorAll('.msg').forEach(el => el.remove());
            body.querySelectorAll('[id^="tpCard"], [id^="tpPersisted"]').forEach(el => el.remove());
            // Reset TP container to hidden state
            const tpId = 'tp' + panel.charAt(0).toUpperCase() + panel.slice(1);
            const tpCard = document.getElementById(tpId);
            if (tpCard) {
                tpCard.classList.add('tp-hidden');
                tpCard.classList.remove('tp-expanded');
            }
        }
        
        function addLoadingMsg(panel) {
            const body = document.getElementById(panel + 'Body');
            const msg = document.createElement('div');
            msg.className = 'msg ai';
            msg.id = 'loading-' + panel;
            const modeName = panel === 'copilot' ? 'Copilot' : 'Assistant';
            const modeIcon = panel === 'copilot' ? '#icon-star' : '#icon-clipboard';
            msg.innerHTML = `<div class="msg-bubble"><div class="msg-head"><div class="msg-avatar"><span class="icon"><svg><use href="${modeIcon}"/></svg></span></div><span class="msg-name">FixAIR ${modeName}</span></div><div class="msg-loading"><span></span><span></span><span></span></div></div>`;
            body.appendChild(msg);
            body.scrollTop = body.scrollHeight;
            return msg;
        }
        
        // Remove loading message
        function removeLoadingMsg(panel) {
            const loading = document.getElementById('loading-' + panel);
            if (loading) loading.remove();
        }
        
        // Conversation history per panel
        const chatHistory = {
            copilot: [],
            assistant: []
        };
        window.chatHistory = chatHistory;

        // ==================== THOUGHT PROCESS SYSTEM ====================
        const thoughtIcons = {
            globe: `<svg viewBox="0 0 256 256" fill="currentColor"><path d="M128,24A104,104,0,1,0,232,128,104.12,104.12,0,0,0,128,24Zm88,104a87.61,87.61,0,0,1-3.33,24H174.16a157.44,157.44,0,0,0,0-48h38.51A87.61,87.61,0,0,1,216,128ZM102,168H154a115.11,115.11,0,0,1-26,45A115.27,115.27,0,0,1,102,168Zm-3.9-16a140.84,140.84,0,0,1,0-48h59.88a140.84,140.84,0,0,1,0,48ZM40,128a87.61,87.61,0,0,1,3.33-24H81.84a157.44,157.44,0,0,0,0,48H43.33A87.61,87.61,0,0,1,40,128ZM154,88H102a115.11,115.11,0,0,1,26-45A115.27,115.27,0,0,1,154,88Z"/></svg>`,
            doc: `<svg viewBox="0 0 256 256" fill="currentColor"><path d="M213.66,82.34l-56-56A8,8,0,0,0,152,24H56A16,16,0,0,0,40,40V216a16,16,0,0,0,16,16H200a16,16,0,0,0,16-16V88A8,8,0,0,0,213.66,82.34ZM160,51.31,188.69,80H160ZM200,216H56V40h88V88a8,8,0,0,0,8,8h48V216Z"/></svg>`,
            chat: `<svg viewBox="0 0 256 256" fill="currentColor"><path d="M128,24A104,104,0,0,0,36.18,176.88L24.83,210.93a16,16,0,0,0,20.24,20.24l34.05-11.35A104,104,0,1,0,128,24Zm0,192a87.87,87.87,0,0,1-44.06-11.81,8,8,0,0,0-6.54-.67L40,216,52.47,178.6a8,8,0,0,0-.66-6.54A88,88,0,1,1,128,216Z"/></svg>`,
            chevronUp: `<svg width="16" height="16" viewBox="0 0 20 20" fill="currentColor"><path d="M9.99997 7C10.1062 7 10.2093 7.03341 10.2939 7.09473L10.372 7.16504L14.8721 12.1651C15.0568 12.3703 15.0402 12.6874 14.835 12.8721C14.6297 13.0567 14.3126 13.0402 14.1279 12.835L9.99997 8.24806L5.872 12.835L5.7968 12.9024C5.60972 13.0406 5.34458 13.0338 5.16496 12.8721C4.98555 12.7105 4.9506 12.4476 5.06828 12.2471L5.12785 12.1651L9.62789 7.16504C9.72265 7.05978 9.85834 7.00007 9.99997 7Z"/></svg>`,
            chevronDown: `<svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor"><path d="M14.128 7.16482C14.3126 6.95983 14.6298 6.94336 14.835 7.12771C15.0402 7.31242 15.0567 7.62952 14.8721 7.83477L10.372 12.835L10.2939 12.9053C10.2093 12.9667 10.1063 13 9.99995 13C9.85833 12.9999 9.72264 12.9402 9.62788 12.835L5.12778 7.83477L5.0682 7.75273C4.95072 7.55225 4.98544 7.28926 5.16489 7.12771C5.34445 6.96617 5.60969 6.95939 5.79674 7.09744L5.87193 7.16482L9.99995 11.7519L14.128 7.16482Z"/></svg>`
        };

        class ThoughtProcessManager {
            analyzeQuery(query, context) {
                const steps = [];
                const q = query.toLowerCase();
                const brand = context.brandName || 'quipement';

                if (q.includes('code') || q.includes('erreur') || q.includes('error') || q.includes('panne')) {
                    steps.push({ icon: 'doc', text: `Recherche codes erreur ${brand}` });
                    steps.push({ icon: 'doc', text: 'Analyse documentation technique' });
                }
                if (q.includes('schma') || q.includes('diagram') || q.includes('circuit')) {
                    steps.push({ icon: 'doc', text: 'Gnration schma technique' });
                }
                if (q.includes('rpar') || q.includes('fix') || q.includes('solution')) {
                    steps.push({ icon: 'chat', text: 'laboration procdure rparation' });
                }
                if (steps.length === 0) {
                    steps.push({ icon: 'globe', text: `Analyse demande ${brand}` });
                    steps.push({ icon: 'doc', text: 'Consultation base de connaissances' });
                }
                steps.push({ icon: 'chat', text: 'Formulation rponse' });
                return steps;
            }
        }

        const thoughtManager = new ThoughtProcessManager();

        class ThoughtProcessUI {
            constructor(panelId) {
                this.panelId = panelId;
                this.container = null;
                this.isExpanded = true;
                this.steps = [];
            }

            create(steps) {
                this.steps = steps;
                const msgContainer = document.getElementById(this.panelId + 'Body');

                this.container = document.createElement('div');
                this.container.className = 'thought-card expanded';
                this.container.innerHTML = `
                    <div class="thought-collapsed" style="display:none;">
                        <span class="thought-icon">${thoughtIcons.globe}</span>
                        <span class="thought-label">Rflexion termine</span>
                        <span class="thought-chevron">${thoughtIcons.chevronDown}</span>
                    </div>
                    <div class="thought-expanded">
                        <div class="thought-header-row">
                            <span class="thought-title">Rflexion en cours...</span>
                            <span class="thought-chevron">${thoughtIcons.chevronUp}</span>
                        </div>
                        <div class="thought-steps-container">
                            ${steps.map(s => `
                                <div class="thought-step-row">
                                    <div class="thought-bullet"></div>
                                    <div class="thought-step-content">
                                        <div class="thought-step-text">${s.text}</div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;

                msgContainer.appendChild(this.container);
                msgContainer.scrollTop = msgContainer.scrollHeight;

                // Toggle functionality
                const headerRow = this.container.querySelector('.thought-header-row');
                const collapsedRow = this.container.querySelector('.thought-collapsed');
                headerRow.onclick = () => this.toggle();
                collapsedRow.onclick = () => this.toggle();

                this.animateSteps();
            }

            animateSteps() {
                const bullets = this.container.querySelectorAll('.thought-bullet');
                const texts = this.container.querySelectorAll('.thought-step-text');
                bullets.forEach((b, i) => {
                    setTimeout(() => {
                        b.classList.add('visible');
                        texts[i].classList.add('visible');
                    }, i * 400);
                });
            }

            toggle() {
                this.isExpanded = !this.isExpanded;
                if (this.isExpanded) {
                    this.container.classList.add('expanded');
                    this.container.querySelector('.thought-collapsed').style.display = 'none';
                    this.container.querySelector('.thought-expanded').style.display = 'flex';
                } else {
                    this.container.classList.remove('expanded');
                    this.container.querySelector('.thought-collapsed').style.display = 'flex';
                    this.container.querySelector('.thought-expanded').style.display = 'none';
                }
            }

            collapse(summary) {
                this.isExpanded = false;
                this.container.classList.remove('expanded');
                this.container.querySelector('.thought-collapsed').style.display = 'flex';
                this.container.querySelector('.thought-expanded').style.display = 'none';
                this.container.querySelector('.thought-label').textContent = summary || 'Rflexion termine';
                this.container.querySelector('.thought-header-row .thought-title').textContent = summary || 'Rflexion termine';
            }

            remove() {
                if (this.container && this.container.parentNode) {
                    this.container.parentNode.removeChild(this.container);
                }
            }

            generateSummary(steps) {
                if (!steps || steps.length === 0) return 'Analyse termine';
                const count = steps.length;
                return `${count} tape${count > 1 ? 's' : ''} d'analyse`;
            }
        }

        // ==================== EXPOSE TO GLOBAL SCOPE ====================
        window.thoughtIcons = thoughtIcons;
        window.ThoughtProcessManager = ThoughtProcessManager;
        window.ThoughtProcessUI = ThoughtProcessUI;
        window.thoughtManager = thoughtManager;

        // 
        // PARALLEL EXTRACTION  Calls new workflow after each message
        // 
        async function triggerExtraction(chatPayload) {
            try {
                const allMessages = chatHistory.assistant || [];
                const fullConversation = allMessages
                    .filter(m => m.role === 'user' || m.role === 'assistant')
                    .map(m => {
                        const role = m.role === 'user' ? 'TECHNICIEN' : 'ASSISTANT';
                        let content = m.content || '';
                        content = content.replace(/\[REPORT_DATA\][\s\S]*?\[\/REPORT_DATA\]/g, '').trim();
                        return `${role}: ${content}`;
                    })
                    .join('\n\n');

                const extractionPayload = {
                    project_id: chatPayload.project_id,
                    user_id: currentUserId,
                    chat_id: chatPayload.chat_id,
                    session_id: chatPayload.session_id,
                    brand: chatPayload.brand,
                    brand_name: chatPayload.brand_name,
                    message: chatPayload.message,
                    message_count: allMessages.length,
                    panel: 'assistant',
                    full_conversation: fullConversation,
                    current_report_data: lastReportData || {},
                    timestamp: new Date().toISOString()
                };

                console.log('[Extraction]  Triggering parallel extraction...');

                const response = await fetch(EXTRACTION_WEBHOOK, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(extractionPayload)
                });

                if (response.ok) {
                    const result = await response.json();
                    console.log('[Extraction]  Got extraction result');
                    if (result.extracted_data) {
                        handleExtractionResult(result.extracted_data, result.completion_percentage);
                    }
                } else {
                    console.warn('[Extraction]  Extraction failed:', response.status);
                }
            } catch (e) {
                console.warn('[Extraction]  Extraction error (non-blocking):', e.message);
            }
        }

        function handleExtractionResult(extractedData, completionPercentage) {
            if (!extractedData) return;
            console.log('[Extraction]  Updating drawer with extraction data');

            extractedData = normalizeReportData(extractedData);  // FIX-1: Normalize extraction data

            if (!lastReportData) {
                lastReportData = {
                    brand: extractedData.brand || (typeof brand !== 'undefined' ? brand : 'general'),
                    brand_key: extractedData.brand_key || brand || 'general',
                    status: 'en_cours',
                    date: new Date().toLocaleDateString('fr-FR')
                };
            }

            lastReportData = unifiedMerge(lastReportData, extractedData);  // FIX-2: Unified merge
            updateDrawerPreview(lastReportData);

            if (completionPercentage !== undefined) {
                const progressFill = document.getElementById('reportProgressFill');
                const progressText = document.getElementById('reportProgressText');
                const headerProgress = document.getElementById('reportHeaderProgress');
                if (progressFill && progressText && headerProgress) {
                    headerProgress.style.display = 'flex';
                    progressFill.style.width = completionPercentage + '%';
                    progressText.textContent = completionPercentage + '%';
                }
            }

            if (currentProjectId && lastReportData) {
                debouncedSaveExtractedData(lastReportData, completionPercentage);  // FIX-4: Debounced save
            }
        }

        function smartMergeExtraction(target, source) {
            if (!source || typeof source !== 'object') return;
            for (const key of Object.keys(source)) {
                const sourceVal = source[key];
                const targetVal = target[key];
                if (sourceVal === null || sourceVal === undefined) continue;

                if (Array.isArray(sourceVal)) {
                    switch (key) {
                        case 'equipements':
                            target[key] = deduplicateBy([...(targetVal || []), ...sourceVal], item => (item.id || item.modele || '').toLowerCase());
                            break;
                        case 'adressage':
                            target[key] = deduplicateBy([...(targetVal || []), ...sourceVal], item => item.equipement_id || item.adresse || '');
                            break;
                        case 'mesures':
                            target[key] = deduplicateBy([...(targetVal || []), ...sourceVal], item => `${item.type || ''}|${item.sous_type || ''}|${item.equipement_id || ''}`);
                            break;
                        case 'travaux_effectues':
                        case 'tableaux':
                        case 'reserves':
                        case 'recommandations':
                        case 'travaux_prevoir':
                        case 'listes':
                            target[key] = sourceVal;
                            break;
                        default:
                            target[key] = sourceVal;
                    }
                } else if (typeof sourceVal === 'object' && !Array.isArray(sourceVal)) {
                    if (!target[key] || typeof target[key] !== 'object') target[key] = {};
                    smartMergeExtraction(target[key], sourceVal);
                } else {
                    target[key] = sourceVal;
                }
            }
        }

        function deduplicateBy(array, keyFn) {
            const seen = new Map();
            for (const item of array) {
                const key = keyFn(item);
                if (!key) seen.set(Math.random().toString(), item);
                else if (!seen.has(key) || JSON.stringify(item).length > JSON.stringify(seen.get(key)).length) seen.set(key, item);
            }
            return Array.from(seen.values());
        }

        // Send message to n8n
        async function sendMsg(panel) {
            const input = document.getElementById(panel + 'Input');
            const btn = document.getElementById(panel + 'ActionBtn');
            const text = input.value.trim();
            if(!text) return;
            
            //  FREEMIUM CHECK: Track usage and show upgrade if needed 
            if (typeof trackChatUsage === 'function') {
                const usageResult = trackChatUsage(panel);

                if (usageResult.showUpgrade && !usageResult.allowed) {
                    showUpgradeModal('limit');
                    return;
                }

                if (usageResult.showWarning) {
                    showUpgradeBanner(panel, usageResult.remaining);
                }
            }
            //  END FREEMIUM CHECK 
            
            // Add user message to UI
            addMsg(panel, 'user', text);
            showThoughtProcess(panel, text);
            input.value = '';
            btn.classList.remove('has-text');
            resetTextarea(panel); // Reset textarea height
            
            // Add to history
            chatHistory[panel].push({ role: 'user', content: text });
            
            //  UPDATE DRAWER PREVIEW (Assistant mode) 
            if (panel === 'assistant') {
                buildPartialReport();
            }
            
            // NOTE: Messages are NOT tracked for gamification
            // Only real-value actions count: reports, OCR, photos, voice notes
            
            //  SUPABASE: Ensure project exists and save user message 
            try {
                const projectData = await ensureProject(panel);
                if (projectData && projectData.chatId) {
                    await saveMessage(projectData.chatId, 'user', text);
                }
            } catch (e) {
                console.warn('Supabase save failed (continuing anyway):', e);
            }
            //  END SUPABASE 
            
            // NOTE: Old loading dots removed - now using ThoughtProcess UI
            // addLoadingMsg(panel); // REPLACED BY showThoughtProcess above
            
            try {
                // Get brand name for display
                const brandNames = {
                    'mitsubishi': 'Mitsubishi Electric',
                    'daikin': 'Daikin',
                    'carrier': 'Carrier',
                    'lg': 'LG',
                    'samsung': 'Samsung',
                    'panasonic': 'Panasonic',
                    'toshiba': 'Toshiba',
                    'fujitsu': 'Fujitsu',
                    'hitachi': 'Hitachi',
                    'general': 'Multi-marques'
                };
                
                // Build payload with comprehensive context
                const currentSessionId = sessionIds[panel] || (panel + '-' + (currentProjectId || Date.now()));
                const currentBrandName = brandNames[brand] || brand || 'general';
                
                // IMPORTANT: Include system message + last 20 messages
                // Make sure system message is always first
                const systemMsg = chatHistory[panel].find(m => m.role === 'system');
                const nonSystemMessages = chatHistory[panel].filter(m => m.role !== 'system').slice(-19);
                const recentHistory = systemMsg 
                    ? [systemMsg, ...nonSystemMessages]
                    : nonSystemMessages.slice(-20);
                
                // Count previous interactions
                const previousUserMessages = chatHistory[panel].filter(m => m.role === 'user').length;
                const previousAiMessages = chatHistory[panel].filter(m => m.role === 'assistant').length;
                const isExistingConversation = previousUserMessages > 1;
                
                //  BUILD DETAILED CONVERSATION SUMMARY for n8n 
                let conversationSummary = '';
                if (isExistingConversation) {
                    // Build COMPLETE summary including AI responses
                    const userMsgs = chatHistory[panel].filter(m => m.role === 'user');
                    const aiMsgs = chatHistory[panel].filter(m => m.role === 'assistant');
                    
                    conversationSummary = `
 CONVERSATION EXISTANTE - TU DOIS UTILISER CE CONTEXTE 

Tu reprends une conversation avec ${previousUserMessages} messages du technicien et ${previousAiMessages} de tes rponses.

 HISTORIQUE COMPLET (lis attentivement) 
`;
                    
                    // Add ALL exchanges (interleaved user/AI) - up to last 20 messages
                    const allMsgs = chatHistory[panel].filter(m => m.role === 'user' || m.role === 'assistant');
                    const recentMsgs = allMsgs.slice(-20);
                    
                    recentMsgs.forEach((msg, i) => {
                        const role = msg.role === 'user' ? ' TECHNICIEN' : ' TOI';
                        let content = msg.content;
                        // Clean up JSON reports
                        if (content.includes('"type":"report"') || content.includes('"type": "report"')) {
                            content = '[RAPPORT JSON GNR]';
                        } else if (content.length > 250) {
                            content = content.substring(0, 250) + '...';
                        }
                        conversationSummary += `${role}: ${content}\n\n`;
                    });
                    
                    // Analyze what info was collected
                    const allUserText = userMsgs.map(m => m.content).join(' ').toLowerCase();
                    const collectedInfo = [];
                    
                    if (allUserText.includes('dpannage') || allUserText.includes('sav')) collectedInfo.push(' Type: Dpannage/SAV');
                    if (allUserText.includes('mise en service') || allUserText.includes('mes ')) collectedInfo.push(' Type: Mise en service');
                    if (allUserText.includes('maintenance')) collectedInfo.push(' Type: Maintenance');
                    if (allUserText.match(/chez\s+\w+/i)) collectedInfo.push(' Client mentionn');
                    if (allUserText.match(/code\s*[a-z]?\d+/i) || allUserText.match(/erreur\s*[a-z]?\d+/i)) collectedInfo.push(' Code erreur donn');
                    if (allUserText.match(/puhy|pury|pumy|vrv|vrf|split/i)) collectedInfo.push(' Type systme mentionn');
                    
                    const hasReport = aiMsgs.some(m => m.content && (m.content.includes('RAPPORT') || m.content.includes('"type":"report"')));
                    if (hasReport) collectedInfo.push(' RAPPORT DJ GNR');
                    
                    if (collectedInfo.length > 0) {
                        conversationSummary += ` CE QUI A T COLLECT \n${collectedInfo.join('\n')}\n\n`;
                    }
                    
                    conversationSummary += ` COMPORTEMENT OBLIGATOIRE 
- MARQUE: ${currentBrandName} (JAMAIS redemander)
- Tu as lu l'historique ci-dessus = tu CONNAIS la conversation
- Si "hey/salut"  rsume ce qui a t fait et demande comment continuer
- NE REDEMANDE JAMAIS une info dj donne dans l'historique
- Continue NATURELLEMENT comme si tu te souvenais de tout
`;
                }
                
                const payload = {
                    brand: brand || 'general',
                    brand_name: currentBrandName,
                    panel: panel,
                    message: text,
                    history: recentHistory,
                    chat_history: recentHistory, // Duplicate for compatibility
                    session_id: currentSessionId,
                    project_id: currentProjectId || null,
                    chat_id: currentChatId[panel] || null,
                    timestamp: new Date().toISOString(),
                    is_first_message: previousUserMessages === 1,
                    is_existing_conversation: isExistingConversation,
                    message_count: previousUserMessages,
                    conversation_summary: conversationSummary,
                    //  CRITICAL: brand_instruction is used in n8n systemMessage 
                    brand_instruction: isExistingConversation 
                        ? `${conversationSummary}`
                        : `MARQUE CONFIRME: ${currentBrandName}. NE DEMANDE JAMAIS LA MARQUE. NOUVELLE CONVERSATION.`,
                    system_context: isExistingConversation 
                        ? `${conversationSummary}`
                        : `NOUVELLE CONVERSATION. MARQUE: ${currentBrandName}. ${panel === 'assistant' ? 'Mode Rapport - pose les questions pour gnrer un rapport d\'intervention.' : 'Mode Diagnostic - aide au dpannage.'}`,
                    
                    //  REPORT EXTRACTION INSTRUCTIONS 
                    // These instructions tell the AI to extract and return structured data
                    report_extraction_mode: panel === 'assistant',
                    extraction_instructions: panel === 'assistant' ? `
EXTRACTION DE DONNES POUR RAPPORT:
Aprs chaque message utilisateur, tu DOIS extraire les informations et les retourner dans un bloc JSON.

FORMAT OBLIGATOIRE - Ajoute  la fin de ta rponse:
[REPORT_DATA]
{
  "client": { "societe": "...", "contact": "...", "telephone": "..." },
  "site": { "adresse": "...", "ville": "...", "numero_affaire": "..." },
  "systeme": { "type": "VRF/Split/PAC...", "modele": "...", "serie": "...", "puissance": "..." },
  "fluide": { "type": "R410A/R32/...", "charge_totale": "..." },
  "codes_defaut": [{ "code": "7100", "description": "Description exacte du code" }],
  "adressage": [{ "ref_usine": "...", "serie": "...", "adresse": "01", "designation": "...", "commentaire": "..." }],
  "travaux_effectues": [{ "texte": "..." }],
  "mesures": [{ "label": "...", "valeur": "...", "unite": "..." }],
  "technicien": { "nom": "...", "heure_arrivee": "...", "heure_depart": "..." },
  "resultat": { "status": "resolu/en_attente/non_resolu", "description": "..." }
}
[/REPORT_DATA]

RGLES:
1. N'inclure QUE les champs qui ont des informations dans le message
2. Pour les codes erreur, TOUJOURS donner la description exacte du code (ex: "7100 = Dfaut communication bus")
3. Pour l'adressage systme, extraire CHAQUE unit mentionne (UI, UE, BC, SC...)
4. Les valeurs doivent tre EXACTES, pas de texte gnrique
5. Ce bloc JSON sera pars pour remplir le rapport en temps rel
` : ''
                };
                
                // Get the right webhook based on panel (copilot vs assistant)
                const webhookUrl = getWebhookUrl(panel);

                //  PARALLEL EXTRACTION: Fire extraction workflow (non-blocking) 
                if (panel === 'assistant') {
                    triggerExtraction(payload);
                }

                // Call n8n webhook
                const response = await fetch(webhookUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error(' n8n Error:', response.status, errorText);
                    throw new Error('Erreur serveur: ' + response.status);
                }
                
                const rawData = await response.json();
                
                // Handle both array and object response formats
                const data = Array.isArray(rawData) ? rawData[0] : rawData;

                // Remove loading
                removeLoadingMsg(panel);
                collapseThoughtProcess(panel);

                // Parse markdown and add AI response
                const aiResponse = data.response || data.message || data.output || 'Dsol, une erreur est survenue.';
                
                //  EXTRACT REPORT_DATA FROM AI RESPONSE 
                if (panel === 'assistant') {
                    const reportDataMatch = aiResponse.match(/\[REPORT_DATA\]([\s\S]*?)\[\/REPORT_DATA\]/);
                    if (reportDataMatch) {
                        try {
                            let extractedData = JSON.parse(reportDataMatch[1].trim());
                            extractedData = normalizeReportData(extractedData);  // FIX-1: Normalize chat data

                            // Merge with existing data
                            if (!lastReportData) {
                                lastReportData = {
                                    brand: currentBrandName,
                                    brand_key: brand,
                                    status: 'en_cours',
                                    date: new Date().toLocaleDateString('fr-FR')
                                };
                            }
                            // Check for new info if report is completed (before merge)
                            if (reportCompletionState.status === REPORT_STATUS.COMPLETED) {
                                const newFields = detectNewFieldsFromExtraction(extractedData, lastReportData);
                                if (newFields.length > 0) {
                                    showNewInfoNotification(newFields);
                                }
                            }

                            lastReportData = unifiedMerge(lastReportData, extractedData);  // FIX-2: Unified merge

                            // Immediately update preview
                            updateDrawerPreview(lastReportData);

                            //  PERSIST extracted_data to Supabase 
                            if (currentProjectId && lastReportData && Object.keys(lastReportData).length > 0) {
                                const completion = calculateReportCompletion(lastReportData);
                                debouncedSaveExtractedData(lastReportData, completion.percentage);  // FIX-4: Debounced save
                            }
                        } catch (e) {
                            // Failed to parse REPORT_DATA
                        }
                    }
                    
                    // Also try to build partial report from text (fallback)
                    buildPartialReport();
                }
                
                // Remove the REPORT_DATA block from displayed message (keep it clean for user)
                const cleanResponse = aiResponse.replace(/\[REPORT_DATA\][\s\S]*?\[\/REPORT_DATA\]/g, '').trim();
                const parsedResponse = parseMarkdown(cleanResponse);
                // Capture thought process before collapsing
                const tpSteps = (typeof TP !== 'undefined' && TP.s && TP.s[panel]) ? JSON.stringify(TP.s[panel]) : null;
                const tpSummary = (typeof TP !== 'undefined' && TP.s && TP.s[panel]) ? (TP.s[panel].length + ' tapes') : null;

                collapseThoughtProcess(panel);
                addMsg(panel, 'ai', parsedResponse);

                // Add to history (keep original with data for future reference)
                chatHistory[panel].push({ role: 'assistant', content: aiResponse });

                //  SUPABASE: Save AI response 
                try {
                    if (currentChatId[panel]) {
                        await saveMessage(currentChatId[panel], 'assistant', aiResponse, 'text', tpSteps, tpSummary);
                        
                        // If this is a report, save it to reports table
                        if (aiResponse.includes('RAPPORT D\'INTERVENTION')) {
                            await saveReport(aiResponse);
                            //  GAMIFICATION: Track report generated 
                            trackAction('report');
                        }
                    }
                } catch (e) {
                    console.warn('Supabase save AI response failed:', e);
                }
                //  END SUPABASE 
                
                // If assistant generated a report, update the report panel
                if (panel === 'assistant' && data.report) {
                    if (data.report.client) document.getElementById('rClient').textContent = data.report.client;
                    if (data.report.problem) document.getElementById('rProblem').textContent = data.report.problem;
                }
                
            } catch (error) {
                console.error(' Error sending message:', error);
                removeLoadingMsg(panel);
                hideThoughtProcess(panel);
                addMsg(panel, 'ai', '<p><strong>Erreur</strong></p><p>' + error.message + '</p><p style="color:var(--text-dim);font-size:12px;">Vrifiez la console pour plus de dtails.</p>');
            }
        }
        
        // Save report to Supabase
        async function saveReport(reportContent) {
            if (!currentProjectId || !currentUserId) return;
            
            try {
                const { data, error } = await db
                    .from('reports')
                    .insert({
                        project_id: currentProjectId,
                        user_id: currentUserId,
                        report_type: reportContent.includes('[SAV') ? 'SAV' : (reportContent.includes('[MES') ? 'MES' : 'MAINT'),
                        title: 'Rapport d\'intervention',
                        status: 'completed',
                        solution_description: reportContent
                    })
                    .select()
                    .single();
                
                if (error) throw error;

                // Update project status
                await db
                    .from('projects')
                    .update({ status: 'completed' })
                    .eq('id', currentProjectId);
                
            } catch (e) {
                // Error saving report
            }
        }

        //  AUTO-SAVE REPORT DATA TO REPORTS TABLE 
        async function saveReportData(projectId, reportData) {
            if (!projectId || !reportData || !currentUserId) return;

            try {
                const completion = calculateReportCompletion(reportData);

                // Check if report exists for this project
                const { data: existingReport } = await db
                    .from('reports')
                    .select('id')
                    .eq('project_id', projectId)
                    .maybeSingle();

                // Build report record from extracted_data
                const reportRecord = {
                    project_id: projectId,
                    user_id: currentUserId,
                    status: completion.percentage >= 80 ? 'completed' : 'draft',
                    title: reportData.reference || `Rapport ${projectId}`,
                    report_type: reportData.type_intervention || 'MAINT',
                    equipment_brand: reportData.brand_key || brand || null,
                    equipment_model: reportData.systeme?.modele || null,
                    equipment_type: reportData.systeme?.type || null,
                    problem_reported: reportData.resume || null,
                    problem_identified: reportData.resultat?.description || null,
                    solution_description: reportData.rapport_technicien || null,
                    error_codes: reportData.codes_defaut || [],
                    actions_performed: reportData.travaux_effectues || [],
                    client_name: reportData.client?.societe || null,
                    client_address: reportData.site?.adresse ? `${reportData.site.adresse}${reportData.site.ville ? ', ' + reportData.site.ville : ''}` : null,
                    updated_at: new Date().toISOString()
                };

                if (existingReport) {
                    // Update existing report
                    const { error } = await db
                        .from('reports')
                        .update(reportRecord)
                        .eq('id', existingReport.id);

                    if (error) console.error('[Reports] Update failed:', error);
                    else console.log('[Reports]  Report updated');
                } else {
                    // Create new report
                    reportRecord.created_at = new Date().toISOString();
                    const { error } = await db
                        .from('reports')
                        .insert(reportRecord);

                    if (error) console.error('[Reports] Insert failed:', error);
                    else console.log('[Reports]  Report created');
                }
            } catch (e) {
                console.error('[Reports] saveReportData error:', e);
            }
        }

        // Get voice intensity from analyser
        function getVoiceIntensity(panel) {
            const analyser = analysers[panel];
            if (!analyser) return 0;
            
            const dataArray = new Uint8Array(analyser.frequencyBinCount);
            analyser.getByteFrequencyData(dataArray);
            
            let sum = 0;
            for (let i = 0; i < dataArray.length; i++) {
                sum += dataArray[i];
            }
            const average = sum / dataArray.length / 255;
            
            if (average < SILENCE_THRESHOLD) return 0;
            return Math.min(1, (average - SILENCE_THRESHOLD) / (1 - SILENCE_THRESHOLD) * 2.0);
        }
        
        // Simulated intensity when no mic
        function getSimulatedIntensity(panel) {
            if (simulatedIntensityCurrent[panel] === undefined) {
                simulatedIntensityCurrent[panel] = 0;
                simulatedIntensityTarget[panel] = 0;
                simulatedSpeaking[panel] = false;
            }
            
            const diff = simulatedIntensityTarget[panel] - simulatedIntensityCurrent[panel];
            simulatedIntensityCurrent[panel] += diff * 0.3;
            
            if (simulatedSpeaking[panel] && simulatedIntensityCurrent[panel] > 0.1) {
                return simulatedIntensityCurrent[panel] + (Math.random() - 0.5) * 0.3;
            }
            return Math.max(0, simulatedIntensityCurrent[panel]);
        }
        
        // Update waveform - add bar and scroll left
        function updateWaveform(panel) {
            const barsContainer = document.getElementById(panel + 'Bars');
            if (!barsContainer) return;
            
            const intensity = recordings[panel]?.simulated 
                ? getSimulatedIntensity(panel) 
                : getVoiceIntensity(panel);
            
            const height = MIN_HEIGHT + (intensity * (MAX_HEIGHT - MIN_HEIGHT));
            
            const bar = document.createElement('div');
            bar.className = 'wave-bar';
            bar.style.height = height + 'px';
            barsContainer.appendChild(bar);
            
            while (barsContainer.children.length > MAX_BARS) {
                barsContainer.removeChild(barsContainer.firstChild);
            }
        }
        
        // Start recording
        async function startRecording(panel) {
            const inputRow = document.getElementById(panel + 'InputRow');
            const btn = document.getElementById(panel + 'ActionBtn');
            const barsContainer = document.getElementById(panel + 'Bars');
            const input = document.getElementById(panel + 'Input');
            
            barsContainer.innerHTML = '';
            simulatedIntensityCurrent[panel] = 0;
            simulatedIntensityTarget[panel] = 0;
            simulatedSpeaking[panel] = false;
            
            // Clear input and show listening state
            input.value = '';
            input.placeholder = ' En coute...';
            
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const source = audioContext.createMediaStreamSource(stream);
                const analyser = audioContext.createAnalyser();
                analyser.fftSize = 256;
                analyser.smoothingTimeConstant = 0.4;
                source.connect(analyser);
                
                audioContexts[panel] = audioContext;
                analysers[panel] = analyser;
                
                //  ELEVENLABS: Setup MediaRecorder for actual audio capture 
                const mediaRecorder = new MediaRecorder(stream, { mimeType: 'audio/webm' });
                const audioChunks = [];
                
                mediaRecorder.ondataavailable = (event) => {
                    if (event.data.size > 0) {
                        audioChunks.push(event.data);
                    }
                };
                
                mediaRecorder.onstop = async () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                    await transcribeWithElevenLabs(panel, audioBlob);
                };
                
                mediaRecorder.start();
                //  END ELEVENLABS SETUP 
                
                recordings[panel] = { stream, startTime: Date.now(), mediaRecorder };
                
            } catch (err) {
                // Mic access denied, using simulation
                recordings[panel] = { startTime: Date.now(), simulated: true };
                
                // Simulate speaking patterns
                const simInterval = setInterval(() => {
                    if (!recordings[panel]) { clearInterval(simInterval); return; }
                    if (Math.random() < 0.15) {
                        simulatedSpeaking[panel] = !simulatedSpeaking[panel];
                    }
                    simulatedIntensityTarget[panel] = simulatedSpeaking[panel] ? 0.4 + Math.random() * 0.6 : 0;
                }, 250);
            }
            
            inputRow.classList.add('recording');
            btn.classList.add('recording');
            btn.classList.remove('has-text');
            
            waveformIntervals[panel] = setInterval(() => updateWaveform(panel), 80);
            
            updateVoiceTimer(panel);
            voiceTimers[panel] = setInterval(() => updateVoiceTimer(panel), 100);
        }
        
        // 
        // ELEVENLABS SPEECH-TO-TEXT (API key fetched from Supabase)
        // 
        
        async function transcribeWithElevenLabs(panel, audioBlob) {
            const input = document.getElementById(panel + 'Input');
            const btn = document.getElementById(panel + 'ActionBtn');
            const sphere = document.getElementById(panel + 'TranscriptionSphere');
            
            // Show glass sphere, hide button
            btn.style.display = 'none';
            sphere.classList.add('active');
            input.placeholder = '';
            
            try {
                //  FETCH API KEY FROM SUPABASE 
                const apiKey = await getApiKey('elevenlabs_api_key');
                if (!apiKey) {
                    throw new Error('API key not available');
                }
                
                const formData = new FormData();
                formData.append('file', audioBlob, 'recording.webm');
                formData.append('model_id', 'scribe_v1');
                formData.append('language_code', 'fra');
                
                const response = await fetch('https://api.elevenlabs.io/v1/speech-to-text', {
                    method: 'POST',
                    headers: {
                        'xi-api-key': apiKey
                    },
                    body: formData
                });
                
                if (!response.ok) {
                    throw new Error(`ElevenLabs API error: ${response.status}`);
                }
                
                const result = await response.json();
                const transcription = result.text || '';
                
                // Hide sphere, show button
                sphere.classList.remove('active');
                btn.style.display = 'flex';
                
                if (transcription.trim()) {
                    input.value = transcription.trim();
                    input.placeholder = panel === 'assistant' ? 'Dcrivez l\'intervention...' : 'Posez votre question...';
                    handleChatInput(panel);
                    toast(' Transcription termine');

                    //  TRACK VOICE NOTE FOR GAMIFICATION 
                    trackAction('voice');
                } else {
                    input.placeholder = panel === 'assistant' ? 'Dcrivez l\'intervention...' : 'Posez votre question...';
                    toast(' Aucune parole dtecte');
                }
                
            } catch (error) {
                // Hide sphere, show button
                sphere.classList.remove('active');
                btn.style.display = 'flex';
                
                input.placeholder = panel === 'assistant' ? 'Dcrivez l\'intervention...' : 'Posez votre question...';
                toast(' Erreur transcription');
                
                // Fallback to simulation for demo
                const transcriptions = [
                    "Erreur E6 sur groupe extrieur",
                    "Le compresseur ne dmarre pas",
                    "Code dfaut F3"
                ];
                input.value = transcriptions[Math.floor(Math.random() * transcriptions.length)];
                handleChatInput(panel);
            }
        }
        
        // Update timer
        function updateVoiceTimer(panel) {
            const timerEl = document.getElementById(panel + 'Timer');
            const recording = recordings[panel];
            if (!recording || !timerEl) return;
            
            const elapsed = (Date.now() - recording.startTime) / 1000;
            const minutes = Math.floor(elapsed / 60);
            const seconds = Math.floor(elapsed % 60);
            timerEl.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
        }
        
        // Stop recording
        function stopRecording(panel) {
            const inputRow = document.getElementById(panel + 'InputRow');
            const btn = document.getElementById(panel + 'ActionBtn');
            const barsContainer = document.getElementById(panel + 'Bars');
            const input = document.getElementById(panel + 'Input');
            const sphere = document.getElementById(panel + 'TranscriptionSphere');
            
            const isSimulated = recordings[panel]?.simulated;
            const hasRealRecording = recordings[panel]?.mediaRecorder;
            
            //  Show sphere immediately when stopping (for real recordings) 
            if (hasRealRecording) {
                btn.style.display = 'none';
                sphere.classList.add('active');
            }
            
            //  ELEVENLABS: Stop MediaRecorder (triggers ondataavailable and onstop) 
            if (recordings[panel]?.mediaRecorder && recordings[panel].mediaRecorder.state === 'recording') {
                recordings[panel].mediaRecorder.stop();
            }
            //  END ELEVENLABS 
            
            if (recordings[panel]?.stream) {
                recordings[panel].stream.getTracks().forEach(track => track.stop());
            }
            if (audioContexts[panel]) {
                audioContexts[panel].close();
            }
            if (waveformIntervals[panel]) {
                clearInterval(waveformIntervals[panel]);
            }
            if (voiceTimers[panel]) {
                clearInterval(voiceTimers[panel]);
            }
            
            if (barsContainer) barsContainer.innerHTML = '';
            
            inputRow.classList.remove('recording');
            btn.classList.remove('recording');
            
            // Handle simulated mode (fallback)
            if (isSimulated) {
                // Show sphere for simulated mode too
                btn.style.display = 'none';
                sphere.classList.add('active');
                
                setTimeout(() => {
                    // Hide sphere, show button
                    sphere.classList.remove('active');
                    btn.style.display = 'flex';
                    
                    const transcriptions = [
                        "Erreur E6 sur groupe extrieur Mitsubishi",
                        "Le compresseur ne dmarre pas correctement",
                        "Code dfaut F3 sur l'unit intrieure"
                    ];
                    input.value = transcriptions[Math.floor(Math.random() * transcriptions.length)];
                    handleChatInput(panel);
                    toast(' Transcription (simulation)');
                }, 1500); // Slightly longer delay to see the sphere
            }
            
            delete recordings[panel];
            delete audioContexts[panel];
            delete analysers[panel];
            
            const timerEl = document.getElementById(panel + 'Timer');
            if (timerEl) timerEl.textContent = '0:00';
        }

        function voiceInput(panel) {
            // Legacy function - now handled by handleAction
            handleAction(panel);
        }

        function copyTxt(el) {
            navigator.clipboard.writeText(el.closest('.msg-bubble').innerText);
            toast('Copi !');
        }
        
        // Report menu functions
        function toggleReportMenu(event, btn) {
            event.stopPropagation();
            const dropdown = btn.nextElementSibling;
            const wasOpen = dropdown.classList.contains('show');
            
            // Close all other report menus
            document.querySelectorAll('.report-menu-dropdown').forEach(d => d.classList.remove('show'));
            
            if (!wasOpen) {
                dropdown.classList.add('show');
            }
        }
        
        function copyReportContent(event, el) {
            event.stopPropagation();
            const card = el.closest('.report-card');
            const content = card.innerText;
            navigator.clipboard.writeText(content);
            toast('Rapport copi !');
            el.closest('.report-menu-dropdown').classList.remove('show');
        }
        
        // Share from report card menu - DISABLED (Premium feature)
        function shareReportCard(event, el) {
            event.stopPropagation();
            el.closest('.report-menu-dropdown').classList.remove('show');
            toast('Partage disponible dans la version Pro');
        }

        // Menu version of export
        function exportReportPDFMenu(event, el) {
            event.stopPropagation();
            el.closest('.report-menu-dropdown').classList.remove('show');
            showExportMenu();
        }

        // Menu version of share - DISABLED (Premium feature)
        function shareReportMenu(event, el) {
            event.stopPropagation();
            el.closest('.report-menu-dropdown').classList.remove('show');
            toast('Partage disponible dans la version Pro');
        }
        
        // Close report menu when clicking outside
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.report-menu')) {
                document.querySelectorAll('.report-menu-dropdown').forEach(d => d.classList.remove('show'));
            }
        });

        function toggleAttach(panel) {
            closeAllAttach();
            const menuId = 'attach' + panel.charAt(0).toUpperCase() + panel.slice(1);
            document.getElementById(menuId).classList.toggle('show');
        }

        function closeAllAttach() {
            document.querySelectorAll('.attach-menu').forEach(m => m.classList.remove('show'));
        }

        // 
        // PHOTO CAPTURE - V48 SIMPLIFIED (1-click flow)
        // 
        
        function attachAction(type, panel) {
            closeAllAttach();
            currentPhotoPanel = panel;

            if (type === 'camera') {
                document.getElementById('cameraInput').click();
            } else if (type === 'file') {
                document.getElementById('fileInput').click();
            }
        }
        
        function handleFileSelect(event, source) {
            const file = event.target.files[0];

            if (!file) {
                return;
            }
            
            // Check if it's an image
            if (file.type.startsWith('image/')) {
                if (file.size > 10 * 1024 * 1024) {
                    toast('Image trop volumineuse (max 10MB)');
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    addPhotoToChat(currentPhotoPanel, e.target.result);
                };
                reader.onerror = function(e) {
                    console.error(' Error reading file:', e);
                    toast('Erreur lecture fichier');
                };
                reader.readAsDataURL(file);
            } else {
                // Non-image file (PDF, etc.)
                toast('Fichier: ' + file.name);
                addFileToChat(currentPhotoPanel, file);
            }
            
            event.target.value = '';
        }
        
        // Add non-image file to chat
        function addFileToChat(panel, file) {
            const container = document.getElementById(panel + 'Body');
            if (!container) return;
            
            const msgDiv = document.createElement('div');
            msgDiv.className = 'msg user';
            
            const ext = file.name.split('.').pop().toUpperCase();
            msgDiv.innerHTML = `
                <div class="msg-text">
                    <div class="file-attachment">
                        <span class="file-icon">${ext}</span>
                        <span class="file-name">${file.name}</span>
                    </div>
                </div>
            `;
            
            container.appendChild(msgDiv);
            scrollToBottom(panel);
        }
        
        // Scroll to bottom of chat
        function scrollToBottom(panel) {
            const container = document.getElementById(panel + 'Body');
            if (container) {
                setTimeout(() => {
                    container.scrollTop = container.scrollHeight;
                    updateScrollButton(panel);
                }, 50);
            }
        }
        
        // Initialize scroll detection for a panel
        function initScrollDetection(panel) {
            const container = document.getElementById(panel + 'Body');
            if (container) {
                container.addEventListener('scroll', () => {
                    updateScrollButton(panel);
                }, { passive: true });
            }
        }
        
        // Update scroll button visibility
        function updateScrollButton(panel) {
            const container = document.getElementById(panel + 'Body');
            const btn = document.getElementById('scrollBtn' + panel.charAt(0).toUpperCase() + panel.slice(1));
            
            if (!container || !btn) return;
            
            // Show button if not at bottom (with 100px threshold)
            const isAtBottom = container.scrollHeight - container.scrollTop - container.clientHeight < 100;
            btn.classList.toggle('visible', !isAtBottom);
        }
        
        // Add photo directly to chat with action buttons
        async function addPhotoToChat(panel, imageData) {
            const container = document.getElementById(panel + 'Body');
            if (!container) {
                toast('Erreur: chat non trouv');
                return;
            }

            const msgId = 'photo-' + Date.now();
            
            const msgDiv = document.createElement('div');
            msgDiv.className = 'msg user';
            msgDiv.id = msgId;
            
            msgDiv.innerHTML = createPhotoMessageHTML(msgId, panel, imageData);
            
            // Store image data for later use
            msgDiv.dataset.imageData = imageData;
            
            container.appendChild(msgDiv);
            scrollToBottom(panel);
            
            projectMessageCount++;
            toast('Photo ajoute');

            //  GAMIFICATION: Track photo upload 
            trackAction('photo');

            //  Save photo to database 
            if (currentProjectId && currentChatId[panel]) {
                try {
                    await saveMessage(currentChatId[panel], 'user', imageData, 'image');
                } catch (e) {
                    // Error saving photo
                }
            }
        }
        
        // Create HTML for photo message (reusable)
        function createPhotoMessageHTML(msgId, panel, imageData, reportState = null) {
            const reportBtnContent = reportState 
                ? '<span class="icon"><svg><use href="#icon-check"/></svg></span> Ajout'
                : '<span class="icon"><svg><use href="#icon-clipboard"/></svg></span> Rapport';
            const reportBtnClass = reportState ? 'photo-action-btn success' : 'photo-action-btn';
            const reportBtnDisabled = reportState ? 'disabled' : '';
            
            return `
                <div class="msg-text">
                    <div class="photo-container">
                        <img src="${imageData}" class="msg-image" onclick="openImageViewer(this.src)">
                        <button class="photo-delete" onclick="deletePhotoMsg('${msgId}')">
                            <span class="icon"><svg><use href="#icon-x"/></svg></span>
                        </button>
                    </div>
                    <div class="photo-actions-inline">
                        <button class="photo-action-btn" onclick="extractFromPhoto('${msgId}', '${panel}')">
                            <span class="icon"><svg><use href="#icon-search"/></svg></span>
                            Extraire
                        </button>
                        <button class="${reportBtnClass}" onclick="addPhotoToReport('${msgId}', '${panel}')" ${reportBtnDisabled}>
                            ${reportBtnContent}
                        </button>
                    </div>
                </div>
            `;
        }
        
        // Delete photo message
        function deletePhotoMsg(msgId) {
            const msg = document.getElementById(msgId);
            if (msg) {
                msg.remove();
                toast('Photo supprime');
            }
        }
        
        // 
        // EXTRACTION OCR - Claude Vision (principal) + Tesseract.js (fallback)
        // 
        const OCR_WEBHOOK_URL = 'https://cherhabil.app.n8n.cloud/webhook/fixair-ocr';
        
        async function extractFromPhoto(msgId, panel) {
            const msg = document.getElementById(msgId);
            if (!msg) return;
            
            const imageData = msg.dataset.imageData;
            if (!imageData) {
                toast('Erreur: image non trouve');
                return;
            }
            
            // Disable button
            const extractBtn = msg.querySelector('.photo-action-btn:first-child');
            if (extractBtn) {
                extractBtn.disabled = true;
                extractBtn.innerHTML = '<span class="icon"><svg><use href="#icon-search"/></svg></span> Analyse...';
            }
            
            toast('Analyse de l\'image...');
            
            // Add linked photo quote in chat
            const quoteId = 'ocr-' + Date.now();
            addOCRQuoteMessage(panel, msgId, imageData, quoteId);
            
            let extractedText = '';
            let ocrMethod = '';
            
            try {
                // 
                // MTHODE 1: CLAUDE VISION (haute qualit)
                // 
                try {
                    const visionResponse = await fetch(OCR_WEBHOOK_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            image: imageData,
                            brand: brand || 'general'
                        })
                    });
                    
                    if (visionResponse.ok) {
                        const visionResult = await visionResponse.json();
                        const visionText = visionResult.output || visionResult.response || visionResult.text || '';
                        
                        // Vrifier que c'est une vraie extraction (pas une erreur)
                        if (visionText &&
                            visionText.length > 30 &&
                            !visionText.includes('Je suis prt') &&
                            !visionText.includes('Envoie-moi')) {
                            extractedText = visionText;
                            ocrMethod = 'vision';
                        }
                    }
                } catch (visionErr) {
                    // Claude Vision non disponible
                }

                // 
                // MTHODE 2: TESSERACT.JS (fallback)
                // 
                if (!extractedText && typeof Tesseract !== 'undefined') {
                    
                    if (extractBtn) {
                        extractBtn.innerHTML = '<span class="icon"><svg><use href="#icon-search"/></svg></span> OCR...';
                    }
                    
                    const worker = await Tesseract.createWorker('fra+eng', 1, {
                        logger: m => {
                            if (m.status === 'recognizing text' && extractBtn) {
                                const progress = Math.round(m.progress * 100);
                                extractBtn.innerHTML = `<span class="icon"><svg><use href="#icon-search"/></svg></span> ${progress}%`;
                            }
                        }
                    });
                    
                    const { data } = await worker.recognize(imageData);
                    await worker.terminate();
                    
                    if (data.text && data.text.trim().length > 5) {
                        extractedText = data.text.trim();
                        ocrMethod = 'tesseract';
                    }
                }
                
                // 
                // SI AUCUN TEXTE EXTRAIT
                // 
                if (!extractedText || extractedText.length < 10) {
                    updateOCRQuoteWithResults(quoteId, `
                        <div class="ocr-no-text">
                            <div style="font-size:24px;margin-bottom:8px;"></div>
                            <div>Aucun texte dtect sur cette image.</div>
                            <small style="color:var(--text-dim);">Essayez avec une photo plus nette.</small>
                        </div>
                    `);
                    
                    if (extractBtn) {
                        extractBtn.disabled = false;
                        extractBtn.innerHTML = '<span class="icon"><svg><use href="#icon-search"/></svg></span> Extraire';
                    }
                    toast('Aucun texte dtect');
                    return;
                }
                
                // 
                // CONSTRUIRE L'AFFICHAGE (Card UI)
                // 
                // Parser le texte pour infos structures (si Tesseract)
                const structuredInfo = parseOCRForStructuredInfo(extractedText);
                const rawTextId = 'raw-' + quoteId;
                
                let finalHtml = `<div class="ocr-card">`;
                
                //  HEADER 
                finalHtml += `
                    <div class="ocr-card-header">
                        <span class="icon"><svg><use href="#icon-camera"/></svg></span>
                        <span class="ocr-card-header-title">Extraction d'image</span>
                        <span class="ocr-card-header-method">${ocrMethod === 'vision' ? ' IA Vision' : ' OCR'}</span>
                    </div>
                `;
                
                //  AI SUMMARY (contenu principal) 
                finalHtml += `<div class="ocr-ai-summary">`;
                if (ocrMethod === 'vision') {
                    // Claude Vision retourne du texte format - afficher directement
                    finalHtml += parseMarkdown(extractedText);
                } else {
                    // Tesseract - afficher rsum simple
                    const wordCount = extractedText.split(/\\s+/).filter(w => w.length > 0).length;
                    finalHtml += `<p><strong>${wordCount} mots</strong> extraits de l'image.</p>`;
                    if (structuredInfo.hasData) {
                        if (structuredInfo.brand) finalHtml += `<p><strong>Marque:</strong> ${structuredInfo.brand}</p>`;
                        if (structuredInfo.model) finalHtml += `<p><strong>Modle:</strong> ${structuredInfo.model}</p>`;
                        if (structuredInfo.errorCodes.length > 0) finalHtml += `<p><strong>Code erreur:</strong> <span style="color:var(--hotline)">${structuredInfo.errorCodes.join(', ')}</span></p>`;
                    }
                }
                finalHtml += `</div>`;
                
                //  RAW TEXT (collapsible, scrollable) 
                if (ocrMethod !== 'vision') {
                    finalHtml += `
                        <div class="ocr-raw-section">
                            <button class="ocr-raw-toggle" onclick="toggleRawText('${rawTextId}', this)">
                                <span> Voir le texte brut</span>
                                <span class="chevron"></span>
                            </button>
                            <div id="${rawTextId}" class="ocr-raw-content">${escapeHtml(extractedText)}</div>
                        </div>
                    `;
                }
                
                //  ACTION BUTTONS 
                finalHtml += `<div class="ocr-card-actions">`;
                
                if (structuredInfo.errorCodes.length > 0) {
                    finalHtml += `
                        <button class="ocr-action-btn error-btn" onclick="explainErrorCode('${structuredInfo.errorCodes[0]}', '${panel}')">
                            <span class="icon"><svg><use href="#icon-zap"/></svg></span>
                            Expliquer ${structuredInfo.errorCodes[0]}
                        </button>
                    `;
                }
                
                if (ocrMethod !== 'vision') {
                    finalHtml += `
                        <button class="ocr-action-btn" onclick="analyzeTextWithAI('${quoteId}', '${panel}')">
                            <span class="icon"><svg><use href="#icon-cpu"/></svg></span>
                            Analyser
                        </button>
                    `;
                }
                
                finalHtml += `
                    <button class="ocr-action-btn" onclick="copyOCRText('${quoteId}')">
                        <span class="icon"><svg><use href="#icon-copy"/></svg></span>
                        Copier
                    </button>
                </div>`;
                
                finalHtml += `</div>`; // Close ocr-card
                
                // Afficher
                updateOCRQuoteWithResults(quoteId, finalHtml);
                
                // 
                // SAUVEGARDER EN BASE DE DONNES
                // 
                
                // Ajouter au contexte IA
                chatHistory[panel].push({ 
                    role: 'assistant', 
                    content: `[EXTRACTION PHOTO]\n${extractedText}`
                });
                
                // Sauvegarder en base avec HTML pour rechargement
                if (currentProjectId && currentChatId[panel]) {
                    await saveMessage(currentChatId[panel], 'assistant', JSON.stringify({
                        type: 'ocr_result',
                        method: ocrMethod,
                        text: extractedText,
                        structuredInfo: structuredInfo,
                        htmlContent: finalHtml,
                        sourcePhotoId: msgId
                    }), 'ocr');
                }
                
                // Succs
                if (extractBtn) {
                    extractBtn.disabled = false;
                    extractBtn.innerHTML = '<span class="icon"><svg><use href="#icon-check"/></svg></span> Extrait';
                    extractBtn.classList.add('success');
                }
                
                //  GAMIFICATION: Track OCR extraction 
                trackAction('ocr');
                
                toast('Extraction termine');
                scrollToBottom(panel);
                
            } catch (error) {
                updateOCRQuoteWithResults(quoteId, `
                    <div style="color:var(--hotline);padding:12px;">
                        Erreur: ${error.message}
                    </div>
                `);
                
                if (extractBtn) {
                    extractBtn.disabled = false;
                    extractBtn.innerHTML = '<span class="icon"><svg><use href="#icon-search"/></svg></span> Extraire';
                }
                
                toast('Erreur extraction');
            }
        }
        
        // Add OCR quote message with linked thumbnail
        function addOCRQuoteMessage(panel, originalMsgId, imageData, quoteId) {
            const container = document.getElementById(panel + 'Body');
            if (!container) return;
            
            const msgDiv = document.createElement('div');
            msgDiv.className = 'msg ai';
            msgDiv.id = quoteId;
            msgDiv.dataset.sourcePhotoId = originalMsgId;
            msgDiv.dataset.contentType = 'ocr';
            
            // Use thumbnail version of image for quote
            const thumbSrc = imageData;
            
            msgDiv.innerHTML = `
                <div class="msg-text">
                    <div class="ocr-quote" onclick="scrollToMessage('${originalMsgId}')">
                        <img src="${thumbSrc}" class="ocr-quote-thumb" alt="Photo analyse">
                        <div class="ocr-quote-label"> Analyse de cette photo</div>
                    </div>
                    <div class="ocr-result">
                        <div class="ocr-loading">
                            <span class="ocr-spinner"></span>
                            Extraction du texte en cours...
                        </div>
                    </div>
                </div>
            `;
            
            container.appendChild(msgDiv);
            scrollToBottom(panel);
        }
        
        // Update OCR quote with results
        function updateOCRQuoteWithResults(quoteId, htmlContent) {
            const quoteMsg = document.getElementById(quoteId);
            if (!quoteMsg) return;
            
            const resultDiv = quoteMsg.querySelector('.ocr-result');
            if (!resultDiv) return;
            
            resultDiv.innerHTML = htmlContent;
        }
        
        // Format OCR response text into HTML (fallback when htmlContent not saved)
        function formatOCRResponse(text) {
            if (!text) return '<span style="color:var(--text-dim);">Aucun texte extrait</span>';
            
            // Parse for structured info
            const structuredInfo = parseOCRForStructuredInfo(text);
            const rawTextId = 'raw-loaded-' + Date.now();
            const wordCount = text.split(/\s+/).filter(w => w.length > 0).length;
            
            let html = `<div class="ocr-card">`;
            
            // Header
            html += `
                <div class="ocr-card-header">
                    <span class="icon"><svg><use href="#icon-camera"/></svg></span>
                    <span class="ocr-card-header-title">Extraction d'image</span>
                    <span class="ocr-card-header-method"> OCR</span>
                </div>
            `;
            
            // Summary
            html += `<div class="ocr-ai-summary">`;
            html += `<p><strong>${wordCount} mots</strong> extraits.</p>`;
            if (structuredInfo.hasData) {
                if (structuredInfo.brand) html += `<p><strong>Marque:</strong> ${structuredInfo.brand}</p>`;
                if (structuredInfo.model) html += `<p><strong>Modle:</strong> ${structuredInfo.model}</p>`;
                if (structuredInfo.errorCodes.length > 0) html += `<p><strong>Code erreur:</strong> <span style="color:var(--hotline)">${structuredInfo.errorCodes.join(', ')}</span></p>`;
            }
            html += `</div>`;
            
            // Collapsible raw text
            html += `
                <div class="ocr-raw-section">
                    <button class="ocr-raw-toggle" onclick="toggleRawText('${rawTextId}', this)">
                        <span> Voir le texte brut</span>
                        <span class="chevron"></span>
                    </button>
                    <div id="${rawTextId}" class="ocr-raw-content">${escapeHtml(text)}</div>
                </div>
            `;
            
            html += `</div>`; // Close card
            
            return html;
        }
        
        // Render saved OCR message from database
        function renderOCRMessage(panel, ocrData, sourceImageData) {
            const container = document.getElementById(panel + 'Body');
            if (!container) return;
            
            const quoteId = 'ocr-saved-' + Date.now() + '-' + Math.random().toString(36).substr(2, 5);
            const msgDiv = document.createElement('div');
            msgDiv.className = 'msg ai';
            msgDiv.id = quoteId;
            msgDiv.dataset.contentType = 'ocr';
            
            // Find the source photo for linking
            const sourcePhotoId = ocrData.sourcePhotoId || '';
            
            msgDiv.innerHTML = `
                <div class="msg-text">
                    ${sourceImageData ? `
                    <div class="ocr-quote" onclick="scrollToMessage('${sourcePhotoId}')">
                        <img src="${sourceImageData}" class="ocr-quote-thumb" alt="Photo analyse">
                        <div class="ocr-quote-label"> Analyse de cette photo</div>
                    </div>
                    ` : ''}
                    <div class="ocr-result">
                        ${ocrData.htmlContent || formatOCRResponse(ocrData.result)}
                    </div>
                </div>
            `;
            
            container.appendChild(msgDiv);
        }
        
        // Analyze OCR text for HVAC-relevant patterns
        // Find source image data from messages array
        function findSourceImage(messages, sourcePhotoId) {
            // Look for the most recent image message that could be the source
            for (let i = messages.length - 1; i >= 0; i--) {
                const msg = messages[i];
                if (msg.content_type === 'image' && msg.content.startsWith('data:image')) {
                    return msg.content;
                }
            }
            return null;
        }
        
        // Parse OCR text for structured information
        // Nettoyer le texte OCR brut
        function cleanOCRText(text) {
            if (!text) return '';
            
            return text
                // Supprimer les caractres de contrle
                .replace(/[\x00-\x08\x0B\x0C\x0E-\x1F]/g, '')
                // Normaliser les espaces
                .replace(/[ \t]+/g, ' ')
                // Supprimer les lignes vides multiples
                .replace(/\n\s*\n\s*\n/g, '\n\n')
                // Supprimer les espaces en dbut/fin de ligne
                .split('\n').map(l => l.trim()).join('\n')
                // Trim global
                .trim();
        }
        
        function parseOCRForStructuredInfo(text) {
            const upperText = text.toUpperCase();
            const result = {
                brand: null,
                model: null,
                serial: null,
                errorCodes: [],
                power: null,
                voltage: null,
                refrigerant: null,
                hasData: false
            };
            
            // Known brands
            const brands = {
                'MITSUBISHI': 'Mitsubishi Electric',
                'DAIKIN': 'Daikin',
                'CARRIER': 'Carrier',
                'TRANE': 'Trane',
                'LENNOX': 'Lennox',
                'YORK': 'York',
                'LG': 'LG',
                'SAMSUNG': 'Samsung',
                'PANASONIC': 'Panasonic',
                'TOSHIBA': 'Toshiba',
                'FUJITSU': 'Fujitsu',
                'HITACHI': 'Hitachi',
                'MIDEA': 'Midea',
                'GREE': 'Gree',
                'ATLANTIC': 'Atlantic',
                'BOSCH': 'Bosch',
                'VIESSMANN': 'Viessmann'
            };
            
            for (const [key, value] of Object.entries(brands)) {
                if (upperText.includes(key)) {
                    result.brand = value;
                    result.hasData = true;
                    break;
                }
            }
            
            // Model patterns
            const modelPatterns = [
                /MOD[E]LE\s*[:#]?\s*([A-Z0-9\-\/]+)/i,
                /MODEL\s*[:#]?\s*([A-Z0-9\-\/]+)/i,
                /TYPE\s*[:#]?\s*([A-Z0-9\-\/]+)/i,
                /(PUHY|PURY|PEFY|PLFY|PKFY|PEAD|FDUM|RXS|FTX|FAA|FBA|FTXM|RXM)[A-Z0-9\-\/]+/i
            ];
            
            for (const pattern of modelPatterns) {
                const match = text.match(pattern);
                if (match && match[1] && match[1].length > 3) {
                    result.model = match[1].toUpperCase();
                    result.hasData = true;
                    break;
                }
            }
            
            // Serial number
            const serialPatterns = [
                /S[E]RIE\s*[:#]?\s*([A-Z0-9]+)/i,
                /SERIAL\s*[:#]?\s*([A-Z0-9]+)/i,
                /S\/?N\s*[:#]?\s*([A-Z0-9]+)/i,
                /N[]?\s*[:#]?\s*([A-Z][0-9]{6,12})/i
            ];
            
            for (const pattern of serialPatterns) {
                const match = text.match(pattern);
                if (match && match[1] && match[1].length >= 6) {
                    result.serial = match[1].toUpperCase();
                    result.hasData = true;
                    break;
                }
            }
            
            // Error codes (very important)
            const errorPatterns = [
                /(?:ERREUR|ERROR|CODE|FAULT|D[E]FAUT|ALARME)\s*[:#]?\s*([A-Z]?[0-9]{1,4})/gi,
                /\b([EUFPLAH][0-9]{1,3})\b/g,
                /\b(E[0-9]{1,2})\b/g,
                /\b(F[0-9]{1,2})\b/g,
                /\b(A[0-9]{1,3})\b/g
            ];
            
            const errorSet = new Set();
            for (const pattern of errorPatterns) {
                let match;
                while ((match = pattern.exec(upperText)) !== null) {
                    if (match[1] && match[1].length >= 2 && match[1].length <= 5) {
                        errorSet.add(match[1]);
                    }
                }
            }
            result.errorCodes = Array.from(errorSet);
            if (result.errorCodes.length > 0) result.hasData = true;
            
            // Power
            const powerMatch = text.match(/(\d+(?:[.,]\d+)?)\s*(?:kW|KW|BTU|CV)/i);
            if (powerMatch) {
                result.power = powerMatch[0];
                result.hasData = true;
            }
            
            // Voltage
            const voltageMatch = text.match(/(\d{2,3})\s*V(?:olts?)?/i);
            if (voltageMatch) {
                result.voltage = voltageMatch[0];
                result.hasData = true;
            }
            
            // Refrigerant
            const refrigerantMatch = text.match(/R[- ]?(410A|32|134a|407C|404A|22)/i);
            if (refrigerantMatch) {
                result.refrigerant = 'R' + refrigerantMatch[1].toUpperCase();
                result.hasData = true;
            }
            
            return result;
        }
        
        // Explain error code - sends to AI
        async function explainErrorCode(code, panel) {
            const message = `Explique-moi le code erreur ${code}. Quelles sont les causes possibles et comment le rsoudre ?`;
            
            // Add to input and send
            const input = document.getElementById(panel + 'Input');
            if (input) {
                input.value = message;
                sendMsg(panel);
            }
        }
        
        // Analyser le texte extrait avec l'IA
        async function analyzeTextWithAI(quoteId, panel) {
            const quoteMsg = document.getElementById(quoteId);
            if (!quoteMsg) return;
            
            // Trouver le texte (essayer plusieurs classes)
            const textDiv = quoteMsg.querySelector('.ocr-raw-content') || 
                            quoteMsg.querySelector('.ocr-raw-text') ||
                            quoteMsg.querySelector('.ocr-ai-summary') ||
                            quoteMsg.querySelector('.ocr-structured-content');
            
            if (!textDiv) {
                toast('Texte non trouv');
                return;
            }
            
            const rawText = textDiv.innerText || textDiv.textContent;
            
            if (!rawText || rawText.length < 10) {
                toast('Pas assez de texte  analyser');
                return;
            }
            
            // Envoyer le texte  l'IA pour analyse
            const message = `Voici du texte que j'ai extrait d'une photo. Peux-tu l'analyser et me donner les informations importantes ?\n\n${rawText}`;
            
            const input = document.getElementById(panel + 'Input');
            if (input) {
                input.value = message;
                sendMsg(panel);
            }
        }
        
        // Toggle raw text visibility in OCR card
        function toggleRawText(rawTextId, button) {
            const rawContent = document.getElementById(rawTextId);
            if (!rawContent) return;
            
            rawContent.classList.toggle('show');
            button.classList.toggle('open');
            
            // Update button text
            const span = button.querySelector('span:first-child');
            if (span) {
                span.textContent = rawContent.classList.contains('show') ? ' Masquer le texte brut' : ' Voir le texte brut';
            }
        }
        
        // Copier le texte OCR dans le presse-papier
        function copyOCRText(quoteId) {
            const quoteMsg = document.getElementById(quoteId);
            if (!quoteMsg) {
                toast('Message non trouv');
                return;
            }
            
            // Trouver le texte (essayer plusieurs classes)
            const rawTextDiv = quoteMsg.querySelector('.ocr-raw-content') || 
                               quoteMsg.querySelector('.ocr-raw-text') ||
                               quoteMsg.querySelector('.ocr-ai-summary');
            if (!rawTextDiv) {
                toast('Texte non trouv');
                return;
            }
            
            const text = rawTextDiv.innerText || rawTextDiv.textContent;
            
            // Copier dans le presse-papier
            navigator.clipboard.writeText(text).then(() => {
                toast('Texte copi !');
            }).catch(err => {
                console.error('Copy error:', err);
                toast('Erreur de copie');
            });
        }
        
        function scrollToMessage(msgId) {
            const msg = document.getElementById(msgId);
            if (msg) {
                msg.scrollIntoView({ behavior: 'smooth', block: 'center' });
                // Highlight briefly
                msg.style.transition = 'background 0.3s';
                msg.style.background = 'rgba(255,107,53,0.15)';
                setTimeout(() => {
                    msg.style.background = '';
                }, 1500);
            }
        }
        
        // Add photo to report - opens naming modal
        let pendingReportPhoto = null;
        
        function addPhotoToReport(msgId, panel) {
            const msg = document.getElementById(msgId);
            if (!msg) return;
            
            const imageData = msg.dataset.imageData;
            
            // Check if this photo was already added to report
            const existingIndex = window.reportPhotos?.findIndex(p => 
                p.url === imageData || p.data === imageData || p.originalData === imageData
            );
            const existingPhoto = existingIndex >= 0 ? window.reportPhotos[existingIndex] : null;
            
            // Store pending data
            pendingReportPhoto = {
                msgId: msgId,
                panel: panel,
                imageData: imageData,
                existingIndex: existingIndex,
                existingPhoto: existingPhoto
            };
            
            // Show naming modal
            const modal = document.getElementById('photoNameModal');
            const previewImg = document.getElementById('photoNamePreviewImg');
            const input = document.getElementById('photoNameInput');
            const confirmBtn = modal.querySelector('.photo-name-confirm');
            
            previewImg.src = imageData;
            
            // If already added, prefill with existing caption
            if (existingPhoto) {
                input.value = existingPhoto.caption || '';
                confirmBtn.textContent = 'Modifier';
            } else {
                input.value = '';
                confirmBtn.textContent = 'Ajouter au rapport';
            }
            
            modal.classList.add('active');
            
            // Focus input after animation
            setTimeout(() => input.focus(), 100);
        }
        
        function closePhotoNameModal() {
            document.getElementById('photoNameModal').classList.remove('active');
            pendingReportPhoto = null;
        }
        
        // 
        // SIGNATURE PAD FUNCTIONALITY
        // 
        
        let signatureContext = null;
        let isDrawing = false;
        let currentSignatureType = null;
        
        function openSignatureModal(type) {
            currentSignatureType = type;
            const modal = document.getElementById('signatureModal');
            const title = document.getElementById('signatureModalTitle');
            const canvas = document.getElementById('signatureCanvas');
            
            title.textContent = type === 'client' ? 'Signature Client' : 'Signature Technicien';
            
            // Initialize canvas
            signatureContext = canvas.getContext('2d');
            signatureContext.strokeStyle = '#000';
            signatureContext.lineWidth = 2;
            signatureContext.lineCap = 'round';
            signatureContext.lineJoin = 'round';
            
            // Clear any previous signature
            signatureContext.fillStyle = '#fff';
            signatureContext.fillRect(0, 0, canvas.width, canvas.height);
            
            // Add event listeners
            canvas.addEventListener('mousedown', startDrawing);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', stopDrawing);
            canvas.addEventListener('mouseout', stopDrawing);
            
            // Touch events
            canvas.addEventListener('touchstart', handleTouchStart, { passive: false });
            canvas.addEventListener('touchmove', handleTouchMove, { passive: false });
            canvas.addEventListener('touchend', stopDrawing);
            
            modal.classList.add('active');
        }
        
        function closeSignatureModal() {
            const modal = document.getElementById('signatureModal');
            const canvas = document.getElementById('signatureCanvas');
            
            // Remove event listeners
            canvas.removeEventListener('mousedown', startDrawing);
            canvas.removeEventListener('mousemove', draw);
            canvas.removeEventListener('mouseup', stopDrawing);
            canvas.removeEventListener('mouseout', stopDrawing);
            canvas.removeEventListener('touchstart', handleTouchStart);
            canvas.removeEventListener('touchmove', handleTouchMove);
            canvas.removeEventListener('touchend', stopDrawing);
            
            modal.classList.remove('active');
            currentSignatureType = null;
        }
        
        function startDrawing(e) {
            isDrawing = true;
            signatureContext.beginPath();
            signatureContext.moveTo(e.offsetX, e.offsetY);
        }
        
        function draw(e) {
            if (!isDrawing) return;
            signatureContext.lineTo(e.offsetX, e.offsetY);
            signatureContext.stroke();
        }
        
        function stopDrawing() {
            isDrawing = false;
        }
        
        function handleTouchStart(e) {
            e.preventDefault();
            const touch = e.touches[0];
            const rect = e.target.getBoundingClientRect();
            isDrawing = true;
            signatureContext.beginPath();
            signatureContext.moveTo(touch.clientX - rect.left, touch.clientY - rect.top);
        }
        
        function handleTouchMove(e) {
            e.preventDefault();
            if (!isDrawing) return;
            const touch = e.touches[0];
            const rect = e.target.getBoundingClientRect();
            signatureContext.lineTo(touch.clientX - rect.left, touch.clientY - rect.top);
            signatureContext.stroke();
        }
        
        function clearSignature() {
            const canvas = document.getElementById('signatureCanvas');
            signatureContext.fillStyle = '#fff';
            signatureContext.fillRect(0, 0, canvas.width, canvas.height);
        }
        
        function saveSignature() {
            drawerSaveState(); // Save state before adding signature
            const canvas = document.getElementById('signatureCanvas');
            const signatureData = canvas.toDataURL('image/png');
            
            // Update lastReportData
            if (!lastReportData) lastReportData = {};
            
            if (currentSignatureType === 'client') {
                lastReportData.signature_client = signatureData;
            } else {
                lastReportData.signature_technicien = signatureData;
            }
            
            // Refresh preview
            refreshReportPreview();
            
            // Close modal
            closeSignatureModal();
            
            toast('Signature enregistre');
        }
        
        // 
        // PHOTO UPLOAD & DRAG-DROP REORDERING
        // 
        
        function triggerPhotoUpload() {
            // Support both old and v12.5 input IDs
            const input = document.getElementById('photoUploadInputV12') || document.getElementById('photoUploadInput');
            if (input) input.click();
        }
        
        function handlePhotoUpload(event) {
            const files = event.target.files;
            if (!files || files.length === 0) return;
            
            for (const file of files) {
                if (!file.type.startsWith('image/')) continue;
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    const photoData = e.target.result;
                    addPhotoToReportDirect(photoData, file.name.replace(/\.[^/.]+$/, ''));
                };
                reader.readAsDataURL(file);
            }
            
            // Reset input
            event.target.value = '';
        }
        
        function handlePhotoDragOver(event) {
            event.preventDefault();
            event.stopPropagation();
            event.currentTarget.classList.add('drag-active');
        }
        
        function handlePhotoDrop(event) {
            event.preventDefault();
            event.stopPropagation();
            event.currentTarget.classList.remove('drag-active');
            
            const files = event.dataTransfer.files;
            if (!files || files.length === 0) return;
            
            for (const file of files) {
                if (!file.type.startsWith('image/')) continue;
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    const photoData = e.target.result;
                    addPhotoToReportDirect(photoData, file.name.replace(/\.[^/.]+$/, ''));
                };
                reader.readAsDataURL(file);
            }
        }
        
        function addPhotoToReportDirect(photoData, caption = 'Photo') {
            drawerSaveState(); // Save state before adding photo
            if (!window.reportPhotos) window.reportPhotos = [];

            window.reportPhotos.push({
                data: photoData,
                caption: caption,
                timestamp: new Date().toISOString()
            });

            refreshReportPreview();
            initPhotoDragDrop();
            toast('Photo ajoute');
        }
        
        function removePhoto(index) {
            drawerSaveState(); // Save state before removing photo
            if (!window.reportPhotos) return;
            window.reportPhotos.splice(index, 1);
            refreshReportPreview();
            toast('Photo supprime');
        }
        
        function viewPhotoFull(src) {
            const viewer = document.getElementById('imageViewer');
            const img = document.getElementById('imageViewerImg');
            img.src = src;
            viewer.classList.add('active');
        }
        
        // Initialize drag-drop for photo reordering
        function initPhotoDragDrop() {
            setTimeout(() => {
                // Support both old and v12.5 container IDs
                const container = document.getElementById('sortablePhotosV12') || document.getElementById('sortablePhotos');
                if (!container) return;
                
                const items = container.querySelectorAll('.photo-item-v12, .draggable-photo');
                let draggedItem = null;
                
                items.forEach(item => {
                    item.draggable = true;
                    
                    item.addEventListener('dragstart', function(e) {
                        draggedItem = this;
                        this.classList.add('dragging');
                        e.dataTransfer.effectAllowed = 'move';
                    });
                    
                    item.addEventListener('dragend', function() {
                        this.classList.remove('dragging');
                        draggedItem = null;
                        
                        // Update array order based on DOM order
                        const newOrder = [];
                        container.querySelectorAll('.photo-item-v12, .draggable-photo').forEach(el => {
                            const idx = parseInt(el.dataset.index);
                            if (window.reportPhotos[idx]) {
                                newOrder.push(window.reportPhotos[idx]);
                            }
                        });
                        window.reportPhotos = newOrder;
                        drawerAutoSave && drawerAutoSave();
                    });
                    
                    item.addEventListener('dragover', function(e) {
                        e.preventDefault();
                        if (draggedItem === this) return;
                        
                        const rect = this.getBoundingClientRect();
                        const midX = rect.left + rect.width / 2;
                        
                        if (e.clientX < midX) {
                            container.insertBefore(draggedItem, this);
                        } else {
                            container.insertBefore(draggedItem, this.nextSibling);
                        }
                    });
                });
            }, 100);
        }
        
        // 
        
        async function confirmAddToReport() {
            if (!pendingReportPhoto) return;
            
            const caption = document.getElementById('photoNameInput').value.trim() || 'Photo';
            const { msgId, panel, imageData, existingIndex, existingPhoto } = pendingReportPhoto;
            const isUpdate = existingIndex >= 0;
            
            closePhotoNameModal();
            toast(isUpdate ? 'Mise  jour...' : 'Sauvegarde en cours...');
            
            try {
                let photoUrl = imageData; // Fallback to base64
                
                // Upload to Supabase Storage if we have a project and not already uploaded
                if (currentProjectId && !existingPhoto?.url?.startsWith('http')) {
                    const uploadResult = await uploadPhotoToStorage(imageData, currentProjectId);
                    if (uploadResult) {
                        photoUrl = uploadResult;
                    }
                } else if (existingPhoto?.url) {
                    photoUrl = existingPhoto.url;
                }
                
                // Update or add to report
                if (!window.reportPhotos) window.reportPhotos = [];
                
                const photoEntry = {
                    url: photoUrl,
                    originalData: imageData, // Keep original for matching
                    caption: caption,
                    timestamp: new Date().toISOString(),
                    panel: panel
                };
                
                if (isUpdate) {
                    window.reportPhotos[existingIndex] = photoEntry;
                } else {
                    window.reportPhotos.push(photoEntry);
                }
                
                // Also save to project in database
                if (currentProjectId) {
                    await savePhotoToProject(currentProjectId, photoUrl, caption);
                }
                
                // Visual feedback - but don't disable button (allow re-editing)
                const msg = document.getElementById(msgId);
                if (msg) {
                    const reportBtn = msg.querySelector('.photo-action-btn:last-child');
                    if (reportBtn) {
                        reportBtn.innerHTML = '<span class="icon"><svg><use href="#icon-check"/></svg></span> Ajout';
                        reportBtn.classList.add('success');
                        // Don't disable - allow clicking again to edit caption
                    }
                }
                
                toast(isUpdate ? 'Photo modifie: "' + caption + '"' : 'Photo "' + caption + '" ajoute au rapport');
                
                // Refresh report preview to show updated photos
                refreshReportPreview();
                
            } catch (error) {
                console.error('Error saving photo:', error);
                toast('Erreur sauvegarde photo');
            }
        }
        
        // Upload photo to Supabase Storage
        async function uploadPhotoToStorage(base64Data, projectId) {
            try {
                // Convert base64 to blob
                const base64Response = await fetch(base64Data);
                const blob = await base64Response.blob();
                
                // Generate unique filename
                const timestamp = Date.now();
                const filename = `${projectId}/${timestamp}.jpg`;
                
                // Upload to Supabase Storage
                const { data, error } = await db.storage
                    .from('project-photos')
                    .upload(filename, blob, {
                        contentType: 'image/jpeg',
                        upsert: false
                    });
                
                if (error) {
                    console.error('Storage upload error:', error);
                    return null;
                }
                
                // Get public URL
                const { data: urlData } = db.storage
                    .from('project-photos')
                    .getPublicUrl(filename);
                
                // Photo uploaded successfully
                return urlData.publicUrl;
                
            } catch (error) {
                console.error('Upload error:', error);
                return null;
            }
        }
        
        // Save photo reference to project
        async function savePhotoToProject(projectId, photoUrl, caption) {
            try {
                // Get current photos from project
                const { data: project } = await db
                    .from('projects')
                    .select('photos')
                    .eq('id', projectId)
                    .single();
                
                const existingPhotos = project?.photos || [];
                
                // Add new photo
                const updatedPhotos = [...existingPhotos, {
                    url: photoUrl,
                    caption: caption,
                    timestamp: new Date().toISOString()
                }];
                
                // Update project
                await db
                    .from('projects')
                    .update({ photos: updatedPhotos })
                    .eq('id', projectId);
                
                // Photo saved to project
                
            } catch (error) {
                console.error('Error saving photo to project:', error);
            }
        }
        
        // Mock OCR function (will be replaced with real OCR)
        // Image viewer
        function openImageViewer(imageSrc) {
            const viewer = document.getElementById('imageViewer');
            const img = document.getElementById('imageViewerImg');
            img.src = imageSrc;
            viewer.classList.add('active');
        }
        
        function closeImageViewer() {
            document.getElementById('imageViewer').classList.remove('active');
        }
        function handlePhotoOption() {}
        // 
        // END PHOTO CAPTURE
        // 

        function openHotline() {
            Router.navigate({ page: 'hotline' });
            resetHotline();
        }

        function closeHotline() {
            document.getElementById('hotlineView').classList.remove('active');
            if(isConnected) disconnectHotline();
            resetHotline();
        }

        function resetHotline() {
            isConnected = false;
            isConnecting = false;
            isDisconnecting = false;
            chatOpen = false;
            document.getElementById('pulseSphere').classList.remove('connected','connecting','disconnecting');
            document.getElementById('hotlineWidget').classList.remove('chat-mode');
            document.getElementById('hotlineChat').classList.remove('visible');
            document.getElementById('toggleChat').classList.remove('visible','open');
            document.getElementById('widgetLabel').textContent = 'Hotline';
            document.getElementById('widgetSublabel').textContent = 'Appuyez pour parler';
            document.getElementById('toggleText').textContent = 'Afficher';
        }

        function toggleHotline() {
            if(isConnecting || isDisconnecting) return;
            if(isConnected) disconnectHotline();
            else connectHotline();
        }
        
        // 
        // ELEVENLABS CONVERSATIONAL AI - AGENT MAPPING
        // 
        
        const ELEVENLABS_AGENT_IDS = {
            'mitsubishi': 'agent_2801k5chk9qgf9hbh0hnjrsyckq7',
            'carrier': 'agent_8901k87w3fpyf6vaj9500df173t8',
            'daikin': 'agent_9301k9f06f14f6t8ctfnp5vgq952',
            // Fallback for other brands - use Mitsubishi as default
            'lg': 'agent_2801k5chk9qgf9hbh0hnjrsyckq7',
            'samsung': 'agent_2801k5chk9qgf9hbh0hnjrsyckq7',
            'panasonic': 'agent_2801k5chk9qgf9hbh0hnjrsyckq7',
            'toshiba': 'agent_2801k5chk9qgf9hbh0hnjrsyckq7',
            'fujitsu': 'agent_2801k5chk9qgf9hbh0hnjrsyckq7',
            'hitachi': 'agent_2801k5chk9qgf9hbh0hnjrsyckq7',
            'general': 'agent_2801k5chk9qgf9hbh0hnjrsyckq7'
        };
        
        let elevenLabsConversation = null;
        let elevenLabsSDKReady = false;
        
        // Listen for SDK ready event
        window.addEventListener('elevenlabs-ready', () => {
            elevenLabsSDKReady = true;
        });

        async function connectHotline() {
            if(isConnecting || isConnected) return;

            // Check if SDK is ready
            if (!elevenLabsSDKReady || !window.ElevenLabsConversation) {
                toast('Chargement en cours...');
                // Wait a bit and try again
                setTimeout(() => {
                    if (elevenLabsSDKReady) {
                        connectHotline();
                    } else {
                        toast('Erreur: SDK non charg');
                    }
                }, 1000);
                return;
            }
            
            isConnecting = true;
            document.getElementById('pulseSphere').classList.add('connecting');
            document.getElementById('widgetSublabel').textContent = 'Connexion...';
            if(navigator.vibrate) navigator.vibrate(200);
            
            // Get the correct agent ID for the selected brand
            const agentId = ELEVENLABS_AGENT_IDS[brand] || ELEVENLABS_AGENT_IDS['general'];
            
            try {
                elevenLabsConversation = await window.ElevenLabsConversation.startSession({
                    agentId: agentId,
                    
                    onMessage: ({ message, source }) => {
                        if (source === 'user') {
                            addHotlineMessage(message, 'user');
                        } else {
                            addHotlineMessage(message, 'ai');
                        }
                    },
                    
                    onModeChange: ({ mode }) => {
                        if (mode === 'speaking') {
                            document.getElementById('pulseSphere').classList.add('ai-speaking');
                            showAISpeakingIndicator();
                        } else {
                            document.getElementById('pulseSphere').classList.remove('ai-speaking');
                            hideAISpeakingIndicator();
                        }
                    },
                    
                    onConnect: ({ conversationId }) => {
                        isConnecting = false;
                        isConnected = true;
                        document.getElementById('pulseSphere').classList.remove('connecting');
                        document.getElementById('pulseSphere').classList.add('connected');
                        document.getElementById('widgetSublabel').textContent = 'Appuyez pour terminer';
                        document.getElementById('toggleChat').classList.add('visible');
                        
                        // Open chat view
                        setTimeout(() => {
                            if(!chatOpen) toggleChatView();
                        }, 800);
                    },
                    
                    onDisconnect: () => {
                        handleHotlineDisconnect();
                    },

                    onError: (error) => {
                        toast('Erreur connexion');
                        handleHotlineDisconnect();
                    }
                });

            } catch (error) {
                isConnecting = false;
                document.getElementById('pulseSphere').classList.remove('connecting');
                document.getElementById('widgetSublabel').textContent = 'Appuyez pour parler';
                
                if (error.name === 'NotAllowedError') {
                    toast('Microphone non autoris');
                    alert('Veuillez autoriser l\'accs au microphone pour utiliser l\'assistant vocal.');
                } else {
                    toast('Erreur: ' + (error.message || 'Connexion choue'));
                }
            }
        }
        
        // Show AI speaking waveform indicator
        function showAISpeakingIndicator() {
            const existing = document.getElementById('messagesWrapper').querySelector('.ai-speaking-indicator');
            if (existing) return;
            
            const indicator = document.createElement('div');
            indicator.className = 'hotline-msg ai ai-speaking-indicator';
            indicator.innerHTML = `
                <span class="msg-label">${names[brand]}</span>
                <div class="msg-bubble" style="display:flex;align-items:center;gap:10px;">
                    <div style="display:flex;align-items:center;gap:3px;height:20px;">
                        <div class="speaking-bar" style="width:3px;height:8px;background:#34a853;border-radius:2px;animation:speakPulse 0.8s ease-in-out infinite;animation-delay:0s;"></div>
                        <div class="speaking-bar" style="width:3px;height:14px;background:#34a853;border-radius:2px;animation:speakPulse 0.8s ease-in-out infinite;animation-delay:0.1s;"></div>
                        <div class="speaking-bar" style="width:3px;height:10px;background:#34a853;border-radius:2px;animation:speakPulse 0.8s ease-in-out infinite;animation-delay:0.2s;"></div>
                        <div class="speaking-bar" style="width:3px;height:16px;background:#34a853;border-radius:2px;animation:speakPulse 0.8s ease-in-out infinite;animation-delay:0.3s;"></div>
                        <div class="speaking-bar" style="width:3px;height:12px;background:#34a853;border-radius:2px;animation:speakPulse 0.8s ease-in-out infinite;animation-delay:0.4s;"></div>
                    </div>
                    <span style="color:#34a853;font-size:12px;">Parle...</span>
                </div>
            `;
            document.getElementById('messagesWrapper').appendChild(indicator);
            document.getElementById('hotlineChatMessages').scrollTop = document.getElementById('hotlineChatMessages').scrollHeight;
        }
        
        function hideAISpeakingIndicator() {
            const indicator = document.getElementById('messagesWrapper').querySelector('.ai-speaking-indicator');
            if (indicator) indicator.remove();
        }
        
        function handleHotlineDisconnect() {
            isConnecting = false;
            isConnected = false;
            isDisconnecting = false;
            elevenLabsConversation = null;
            document.getElementById('pulseSphere').classList.remove('connected', 'connecting', 'disconnecting', 'ai-speaking');
            document.getElementById('widgetSublabel').textContent = 'Appuyez pour parler';
            hideAISpeakingIndicator();
        }

        async function disconnectHotline() {
            if(!isConnected || isDisconnecting) return;
            isDisconnecting = true;
            isConnected = false;
            document.getElementById('pulseSphere').classList.remove('connected');
            document.getElementById('pulseSphere').classList.add('disconnecting');
            document.getElementById('widgetSublabel').textContent = 'Fin...';
            
            // End ElevenLabs conversation
            if (elevenLabsConversation) {
                try {
                    await elevenLabsConversation.endSession();
                } catch (e) {
                    // End session error
                }
                elevenLabsConversation = null;
            }

            setTimeout(() => {
                isDisconnecting = false;
                document.getElementById('pulseSphere').classList.remove('disconnecting');
                document.getElementById('widgetSublabel').textContent = 'Appuyez pour parler';
                if(chatOpen) {
                    document.getElementById('hotlineChat').classList.remove('visible');
                    document.getElementById('toggleChat').classList.remove('open');
                    document.getElementById('toggleText').textContent = 'Afficher';
                    chatOpen = false;
                }
                document.getElementById('hotlineWidget').classList.remove('chat-mode');
                hideAISpeakingIndicator();
            }, 2500);
        }

        function toggleChatView() {
            chatOpen = !chatOpen;
            if(chatOpen) {
                document.getElementById('hotlineChat').classList.add('visible');
                document.getElementById('toggleChat').classList.add('open');
                document.getElementById('toggleText').textContent = 'Masquer';
                document.getElementById('hotlineWidget').classList.add('chat-mode');
            } else {
                document.getElementById('hotlineChat').classList.remove('visible');
                document.getElementById('toggleChat').classList.remove('open');
                document.getElementById('toggleText').textContent = 'Afficher';
                document.getElementById('hotlineWidget').classList.remove('chat-mode');
            }
        }

        function addHotlineMessage(text, sender) {
            const empty = document.getElementById('chatEmpty');
            if(empty) empty.style.display = 'none';
            
            // Hide speaking indicator when we get the actual message
            if (sender === 'ai') {
                hideAISpeakingIndicator();
            }
            
            const wrapper = document.getElementById('messagesWrapper');
            const msg = document.createElement('div');
            msg.className = 'hotline-msg ' + sender;
            const now = new Date();
            const time = now.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
            const label = sender === 'user' ? 'Vous' : names[brand];
            msg.innerHTML = `<span class="msg-label">${label}</span><div class="msg-bubble">${text}</div><span class="msg-time">${time}</span>`;
            wrapper.appendChild(msg);
            document.getElementById('hotlineChatMessages').scrollTop = document.getElementById('hotlineChatMessages').scrollHeight;
        }

        const divider = document.getElementById('divider');
        const pC = document.getElementById('panelCopilot');
        const pA = document.getElementById('panelAssistant');
        let isDrag = false;

        divider.addEventListener('mousedown', startDrag);
        divider.addEventListener('touchstart', startDrag, {passive: false});

        function startDrag(e) {
            if(!isSplit) return;
            isDrag = true;
            divider.classList.add('dragging');
            document.body.style.cursor = window.innerWidth > 767 ? 'col-resize' : 'row-resize';
            document.body.style.userSelect = 'none';
            e.preventDefault();
        }

        document.addEventListener('mousemove', drag);
        document.addEventListener('touchmove', drag, {passive: false});

        function drag(e) {
            if(!isDrag) return;
            e.preventDefault();
            const cv = document.getElementById('chatView');
            const rect = cv.getBoundingClientRect();
            const isHorizontal = window.innerWidth > 767;
            
            let pos, size, offset, pct;
            
            if (isHorizontal) {
                // Desktop: horizontal split
                pos = e.touches ? e.touches[0].clientX : e.clientX;
                size = rect.width;
                offset = pos - rect.left;
            } else {
                // Mobile: vertical split
                pos = e.touches ? e.touches[0].clientY : e.clientY;
                size = rect.height;
                offset = pos - rect.top;
            }
            
            pct = Math.max(25, Math.min(75, (offset / size) * 100));
            pC.style.flexBasis = pct + '%';
            pA.style.flexBasis = (100 - pct) + '%';
        }

        document.addEventListener('mouseup', stopDrag);
        document.addEventListener('touchend', stopDrag);

        function stopDrag() {
            if(!isDrag) return;
            isDrag = false;
            divider.classList.remove('dragging');
            document.body.style.cursor = '';
            document.body.style.userSelect = '';
        }

        let touchX = 0;
        document.addEventListener('touchstart', e => { touchX = e.touches[0].clientX; });
        document.addEventListener('touchend', e => {
            if(!document.getElementById('chatView').classList.contains('active') || isSplit || isDrag) return;
            const diff = e.changedTouches[0].clientX - touchX;
            if(Math.abs(diff) > 80) {
                if(diff > 0 && mode === 'assistant') switchMode('copilot');
                else if(diff < 0 && mode === 'copilot') switchMode('assistant');
            }
        });

        document.addEventListener('click', e => {
            if(!e.target.closest('.plus-btn') && !e.target.closest('.attach-menu')) {
                closeAllAttach();
            }
            if(!e.target.closest('.brand-pill')) {
                closeBrandDropdown();
            }
        });

        // Reset split view on resize to prevent layout issues
        window.addEventListener('resize', () => {
            if (isSplit) {
                document.getElementById('panelCopilot').style.flexBasis = '50%';
                document.getElementById('panelAssistant').style.flexBasis = '50%';
            }
        });

        // Safari keyboard fix - scroll input into view on focus
        function handleInputFocus(e) {
            const input = e.target;
            setTimeout(() => {
                input.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }, 300);
        }
        
        // Apply to all login inputs
        document.querySelectorAll('.login-input').forEach(input => {
            input.addEventListener('focus', handleInputFocus);
        });
        
        // Apply to chat inputs
        document.querySelectorAll('.input-text').forEach(input => {
            input.addEventListener('focus', handleInputFocus);
        });

        // Additional viewport listeners for orientation and visualViewport
        window.addEventListener('orientationchange', () => {
            setTimeout(setViewportHeight, 100);
        });
        if (window.visualViewport) {
            window.visualViewport.addEventListener('resize', setViewportHeight);
        }
        
        // 
        // FREEMIUM PAYWALL SYSTEM
        // 
        // Soft paywall: X free Copilot chats  upgrade prompt
        // Export PDF/Word  subscription required for non-standard
        // UX: Never block abruptly, always give value first
        // 
        
        const FREEMIUM_CONFIG = {
            // Free tier limits
            freeCopilotChats: 20,
            freeReports: 3,
            softLimitWarning: 0.8,

            // Referral
            bufferQueriesOnInvite: 5,
            bufferHoursOnInvite: 24,
            weekFreeDaysOnConvert: 7,
            sprintTarget: 3,
            sprintRewardDays: 60,
            sprintShowAfterDays: 3,

            // Pricing
            monthlyPrice: 49,

            // Storage & URLs
            storageKey: 'fixair_freemium_usage',
            upgradeUrl: 'https://pay.fixair.ai/b/dRm7sKa3MbPAgxdfgR2VG00',

            // Pro features
            proFeatures: ['export_pdf', 'export_word', 'share_report', 'diagrams_advanced']
        };
        
        // Get/Set freemium usage from localStorage
        function getFreemiumUsage() {
            try {
                const stored = localStorage.getItem(FREEMIUM_CONFIG.storageKey);
                if (!stored) return createFreshUsage();
                
                const usage = JSON.parse(stored);
                
                // Check if week has reset (Monday reset)
                const weekStart = getFreemiumWeekStart();
                if (!usage.weekStart || new Date(usage.weekStart) < weekStart) {
                    return createFreshUsage();
                }
                
                return usage;
            } catch (e) {
                console.warn('[Freemium] Error reading usage:', e);
                return createFreshUsage();
            }
        }
        
        function createFreshUsage() {
            const fresh = {
                weekStart: getFreemiumWeekStart().toISOString(),
                copilotChats: 0,
                assistantChats: 0,
                reportsGenerated: 0,
                bufferQueries: 0,
                bufferUntil: null,
                isPro: false,
                lastChecked: new Date().toISOString(),
                invitesSentThisWeek: 0,
                reportProjects: []
            };
            saveFreemiumUsage(fresh);
            return fresh;
        }
        
        function saveFreemiumUsage(usage) {
            try {
                localStorage.setItem(FREEMIUM_CONFIG.storageKey, JSON.stringify(usage));
            } catch (e) {
                console.warn('[Freemium] Error saving usage:', e);
            }
        }
        
        function getFreemiumWeekStart() {
            const now = new Date();
            const dayOfWeek = now.getDay();
            const mondayOffset = dayOfWeek === 0 ? -6 : 1 - dayOfWeek;
            const monday = new Date(now);
            monday.setDate(now.getDate() + mondayOffset);
            monday.setHours(0, 0, 0, 0);
            return monday;
        }
        
        // Check subscription status from Supabase (async)
        async function checkSubscriptionStatus() {
            try {
                const userId = await getCurrentUserId();
                if (!userId || userId.startsWith('demo-')) return false;
                
                //  OWNER BYPASS 
                const OWNER_IDS = ['d5baabf1-147a-4ee5-a07a-8f80212fbc9a'];
                if (OWNER_IDS.includes(userId)) {
                    console.log('[Freemium]  Owner detected - PRO access granted');
                    const usage = getFreemiumUsage();
                    usage.isPro = true;
                    saveFreemiumUsage(usage);
                    return true;
                }
                
                // Check users table for subscription_tier
                const { data, error } = await db
                    .from('users')
                    .select('subscription_tier')
                    .eq('id', userId)
                    .single();
                
                if (error || !data) return false;
                
                // Check if subscription is active
                const isPro = data.subscription_tier === 'pro' || data.subscription_tier === 'enterprise';
                
                // Update local cache
                const usage = getFreemiumUsage();
                usage.isPro = isPro;
                saveFreemiumUsage(usage);
                
                console.log('[Freemium] Subscription check:', isPro ? 'PRO ' : 'FREE');
                return usage.isPro;
            } catch (e) {
                console.warn('[Freemium] Error checking subscription:', e);
                return false;
            }
        }
        
        // Track a chat message (called from sendMsg)
        function trackChatUsage(panel) {
            const usage = getFreemiumUsage();

            if (usage.isPro) return { allowed: true, remaining: 999 };

            if (currentUserId === 'd5baabf1-147a-4ee5-a07a-8f80212fbc9a') {
                return { allowed: true, remaining: 999 };
            }

            // Check temporary buffer (24h access from invite)
            if (usage.bufferUntil && new Date(usage.bufferUntil) > new Date()) {
                usage.copilotChats = (usage.copilotChats || 0) + 1;
                saveFreemiumUsage(usage);
                return { allowed: true, remaining: 999, buffered: true };
            }

            // Check buffer queries (+5 from invite)
            if ((usage.bufferQueries || 0) > 0) {
                usage.bufferQueries -= 1;
                usage.copilotChats = (usage.copilotChats || 0) + 1;
                saveFreemiumUsage(usage);
                return { allowed: true, remaining: usage.bufferQueries, buffered: true };
            }

            if (panel === 'copilot') {
                const limit = FREEMIUM_CONFIG.freeCopilotChats;
                usage.copilotChats = (usage.copilotChats || 0) + 1;
                saveFreemiumUsage(usage);

                const remaining = Math.max(0, limit - usage.copilotChats);
                const percentUsed = usage.copilotChats / limit;

                return {
                    allowed: usage.copilotChats <= limit,
                    remaining: remaining,
                    total: limit,
                    used: usage.copilotChats,
                    percentUsed: percentUsed,
                    showWarning: percentUsed >= FREEMIUM_CONFIG.softLimitWarning && percentUsed < 1,
                    showUpgrade: percentUsed >= 1
                };
            } else {
                // Assistant messages are free  reports are checked separately
                usage.assistantChats = (usage.assistantChats || 0) + 1;
                saveFreemiumUsage(usage);
                return { allowed: true, remaining: 999 };
            }
        }

        // Track report generation (called when report is built/exported)
        function trackReportGeneration() {
            const usage = getFreemiumUsage();

            if (usage.isPro) return { allowed: true, remaining: 999 };
            if (currentUserId === 'd5baabf1-147a-4ee5-a07a-8f80212fbc9a') {
                return { allowed: true, remaining: 999 };
            }

            // Check buffer
            if (usage.bufferUntil && new Date(usage.bufferUntil) > new Date()) {
                return { allowed: true, remaining: 999, buffered: true };
            }

            // Only count ONCE per project (avoid double-counting from buildPartialReport)
            const projectId = currentProjectId;
            if (!usage.reportProjects) usage.reportProjects = [];
            if (usage.reportProjects.includes(projectId)) {
                const limit = FREEMIUM_CONFIG.freeReports;
                const remaining = Math.max(0, limit - (usage.reportsGenerated || 0));
                return {
                    allowed: (usage.reportsGenerated || 0) <= limit,
                    remaining: remaining,
                    showUpgrade: (usage.reportsGenerated || 0) > limit
                };
            }

            // New project  count it
            usage.reportProjects.push(projectId);

            const limit = FREEMIUM_CONFIG.freeReports;
            usage.reportsGenerated = (usage.reportsGenerated || 0) + 1;
            saveFreemiumUsage(usage);

            const remaining = Math.max(0, limit - usage.reportsGenerated);

            return {
                allowed: usage.reportsGenerated <= limit,
                remaining: remaining,
                total: limit,
                used: usage.reportsGenerated,
                showUpgrade: usage.reportsGenerated > limit
            };
        }
        window.trackReportGeneration = trackReportGeneration;

        // Check if user can send a chat (preview check, doesn't increment)
        function canSendChat(panel) {
            const usage = getFreemiumUsage();
            if (usage.isPro) return { allowed: true, remaining: 999 };
            if (currentUserId === 'd5baabf1-147a-4ee5-a07a-8f80212fbc9a') {
                return { allowed: true, remaining: 999 };
            }

            // Check buffer
            if (usage.bufferUntil && new Date(usage.bufferUntil) > new Date()) {
                return { allowed: true, remaining: 999, buffered: true };
            }
            if ((usage.bufferQueries || 0) > 0) {
                return { allowed: true, remaining: usage.bufferQueries, buffered: true };
            }

            if (panel === 'copilot') {
                const limit = FREEMIUM_CONFIG.freeCopilotChats;
                const remaining = Math.max(0, limit - (usage.copilotChats || 0));
                return { allowed: remaining > 0, remaining, total: limit, used: usage.copilotChats || 0 };
            } else {
                return { allowed: true, remaining: 999 };
            }
        }
        
        // Check if user can use a Pro feature
        function canUseProFeature(feature) {
            //  OWNER BYPASS 
            if (currentUserId === 'd5baabf1-147a-4ee5-a07a-8f80212fbc9a') return true;
            const usage = getFreemiumUsage();
            return usage.isPro;
        }
        
        // Show upgrade modal
        function showUpgradeModal(context = 'generic') {
            const overlay = document.getElementById('upgradeOverlay');
            const title = document.getElementById('upgradeTitle');
            const subtitle = document.getElementById('upgradeSubtitle');

            title.textContent = 'Vous tes un power user ! ';
            subtitle.textContent = 'Vous avez atteint votre limite gratuite cette semaine';

            overlay.classList.add('show');
            console.log('[Freemium] Unified modal shown:', context);
        }
        
        function closeUpgradeModal(event) {
            if (event && event.target && event.target.id !== 'upgradeOverlay') return;
            document.getElementById('upgradeOverlay').classList.remove('show');
        }

        function handleUpgradeClick() {
            console.log('[Freemium] Upgrade clicked');
            closeUpgradeModal();

            // Build Stripe URL with user identification
            const stripeBaseUrl = FREEMIUM_CONFIG.upgradeUrl;
            const params = new URLSearchParams();

            if (currentUserId) {
                params.set('client_reference_id', currentUserId);
            }
            if (currentUser && currentUser.email) {
                params.set('prefilled_email', currentUser.email);
            }

            const fullUrl = params.toString() ? `${stripeBaseUrl}?${params.toString()}` : stripeBaseUrl;
            window.open(fullUrl, '_blank');

            // Poll Supabase to detect when payment completes
            startPaymentPolling();
        }
        
        // Show soft upgrade banner in chat (non-blocking)
        function showUpgradeBanner(panel, remaining) {
            const chatBody = document.getElementById(panel + 'Body');
            if (!chatBody) return;
            if (chatBody.querySelector('.upgrade-banner')) return;

            const banner = document.createElement('div');
            banner.className = 'upgrade-banner';
            banner.innerHTML = `
                <div class="upgrade-banner-content">
                    <div class="upgrade-banner-title">Vous approchez de votre limite hebdomadaire</div>
                    <div class="upgrade-banner-text">Passez  Pro pour un accs illimit</div>
                </div>
                <button class="upgrade-banner-btn" onclick="showUpgradeModal('banner_click')">Passer  Pro</button>
            `;

            chatBody.appendChild(banner);
            chatBody.scrollTop = chatBody.scrollHeight;
        }
        
        // Initialize freemium on page load
        async function initFreemium() {
            console.log('[Freemium] Initializing...');

            await checkSubscriptionStatus();
            await checkWeekFreeStatus();

            const usage = getFreemiumUsage();
            console.log('[Freemium] Current usage:', usage);

            // Check if should show pending referral popup
            setTimeout(() => {
                showPendingReferralPopup();
            }, 2000);

            // Check sprint challenge eligibility
            setTimeout(() => {
                checkSprintChallenge();
            }, 3000);

            // Show re-entry prompt on copilot if returning user
            setTimeout(() => {
                showReentryPrompt('copilot');
            }, 1500);
        }
        
        //  INVITE FLOW HANDLER 
        function handleInviteClick() {
            closeUpgradeModal();
            closePendingPopup();
            shareOnWhatsAppWithVariant();
            grantInviteBuffer();
            setTimeout(() => {
                showInviteConfirmPopup();
            }, 500);
        }
        // WhatsApp message with rotation (avoid same text to 5 people)
        function shareOnWhatsAppWithVariant() {
            const link = getReferralLink();
            const variant = Math.floor(Math.random() * 3);

            let message;
            switch(variant) {
                case 0:
                    message = `Salut ! Je viens de trouver un truc pour les dpannages CVC  diagnostic IA + rapports auto en 30 secondes. C'est trop con de garder a pour moi.\nTeste avec mon lien, on gagne tous les deux 1 semaine gratuite : ${link}`;
                    break;
                case 1:
                    message = `Hey ! Je te partage un outil que j'utilise sur le terrain (diagnostic + rapports auto). Je t'offre 1 semaine gratuite pour tester :\n${link}\nTeste-le maintenant sur un vrai dpannage.`;
                    break;
                case 2:
                    message = `Salut ! Tu connais FixAIR ? C'est un assistant IA pour les techs CVC  tu lui donnes un code erreur et il te sort le diagnostic + le rapport. a m'a chang la vie.\nEssaie gratuit : ${link}`;
                    break;
            }

            const url = `https://wa.me/?text=${encodeURIComponent(message)}`;
            window.open(url, '_blank');
            trackReferralShare('whatsapp');
        }
        // Grant immediate buffer after invite sent
        function grantInviteBuffer() {
            const usage = getFreemiumUsage();
            usage.bufferQueries = (usage.bufferQueries || 0) + FREEMIUM_CONFIG.bufferQueriesOnInvite;
            const bufferEnd = new Date();
            bufferEnd.setHours(bufferEnd.getHours() + FREEMIUM_CONFIG.bufferHoursOnInvite);
            usage.bufferUntil = bufferEnd.toISOString();
            usage.invitesSentThisWeek = (usage.invitesSentThisWeek || 0) + 1;
            saveFreemiumUsage(usage);
            console.log('[Referral] Buffer granted: +5 queries + 24h access');
        }
        // Show post-invite confirmation popup
        function showInviteConfirmPopup() {
            const popup = document.getElementById('inviteConfirmPopup');
            if (popup) popup.classList.add('show');
            setTimeout(() => { closeInviteConfirmPopup(); }, 8000);
        }
        function closeInviteConfirmPopup() {
            const popup = document.getElementById('inviteConfirmPopup');
            if (popup) popup.classList.remove('show');
        }
        // Show pending referral popup (on app re-open if no conversions)
        function showPendingReferralPopup() {
            const usage = getFreemiumUsage();
            if ((usage.invitesSentThisWeek || 0) === 0) return;
            if (referralState.totalReferrals > 0) return;

            const variants = [
                'Plus tu partages, plus tu dbloques vite ton accs gratuit.',
                'Un seul collgue qui s\'inscrit = 1 semaine gratuite pour vous deux.',
                'Les meilleurs retours viennent souvent du 2e ou 3e collgue invit.'
            ];
            const microCopy = document.getElementById('pendingMicroCopy');
            if (microCopy) {
                microCopy.textContent = variants[Math.floor(Math.random() * variants.length)];
            }

            const popup = document.getElementById('referralPendingPopup');
            if (popup) popup.classList.add('show');
        }
        function closePendingPopup() {
            const popup = document.getElementById('referralPendingPopup');
            if (popup) popup.classList.remove('show');
        }
        //  SPRINT CHALLENGE (Day 3+) 
        function checkSprintChallenge() {
            if (!currentUser || !currentUser.created_at) return;

            const usage = getFreemiumUsage();
            if (usage.isPro) return;

            const signupDate = new Date(currentUser.created_at);
            const now = new Date();
            const daysSinceSignup = Math.floor((now - signupDate) / (1000 * 60 * 60 * 24));

            if (daysSinceSignup < FREEMIUM_CONFIG.sprintShowAfterDays) return;
            if (referralState.isAmbassador) return;

            const lastDismissed = localStorage.getItem('fixair_sprint_dismissed');
            if (lastDismissed) {
                const dismissed = new Date(lastDismissed);
                const hoursSince = (now - dismissed) / (1000 * 60 * 60);
                if (hoursSince < 24) return;
            }

            injectSprintBanner();
        }
        function injectSprintBanner() {
            const homepage = document.getElementById('homepageContent');
            if (!homepage) return;
            if (homepage.querySelector('.sprint-banner')) return;

            const completed = referralState.totalReferrals || 0;
            const target = FREEMIUM_CONFIG.sprintTarget;

            const banner = document.createElement('div');
            banner.className = 'sprint-banner';
            banner.onclick = function() { showUpgradeModal('sprint'); };
            banner.innerHTML = `
                <div class="sprint-banner-header">
                    <span class="sprint-banner-emoji"></span>
                    <span class="sprint-banner-title">Dfi 10 jours</span>
                </div>
                <div class="sprint-banner-desc">
                    Invite ${target} techniciens CVC qui s'inscrivent  2 mois FixAIR offerts (100 de valeur)<br>
                    <strong>${completed}/${target} complts</strong>
                </div>
                <button class="sprint-banner-cta" onclick="event.stopPropagation(); handleInviteClick();">
                     Inviter maintenant
                </button>
            `;

            homepage.insertBefore(banner, homepage.firstChild);
        }
        //  RE-ENTRY PROMPT (returning users) 
        function showReentryPrompt(panel) {
            const chatBody = document.getElementById(panel + 'Body');
            if (!chatBody) return;
            if (chatBody.querySelector('.reentry-prompt')) return;
            if (chatBody.children.length > 1) return;

            const examples = [
                { code: 'E1', brand: 'Daikin', desc: 'Dfaut capteur temprature extrieure' },
                { code: 'F3', brand: 'Mitsubishi', desc: 'Erreur dbit rfrigrant faible' },
                { code: 'H6', brand: 'Panasonic', desc: 'Dfaut compresseur position locked' },
                { code: 'L5', brand: 'Toshiba', desc: 'Surcharge instantane' }
            ];
            const ex = examples[Math.floor(Math.random() * examples.length)];

            const prompt = document.createElement('div');
            prompt.className = 'reentry-prompt';
            prompt.onclick = function() {
                const input = document.getElementById(panel + 'Input');
                if (input) {
                    input.value = `Code erreur ${ex.code} sur ${ex.brand}  diagnostic ?`;
                    input.dispatchEvent(new Event('input'));
                    prompt.remove();
                }
            };
            prompt.innerHTML = `
                <div style="font-size: 13px; font-weight: 600; color: var(--text); margin-bottom: 4px;">
                     Un diagnostic rapide ?
                </div>
                <div style="font-size: 12px; color: var(--text-dim); line-height: 1.4;">
                    Exemple : <strong>Code ${ex.code} ${ex.brand}</strong>  ${ex.desc}<br>
                    <span style="color: var(--copilot); font-weight: 500;">Cliquez pour tester </span>
                </div>
            `;

            chatBody.appendChild(prompt);
        }
        //  CHECK WEEK FREE STATUS 
        async function checkWeekFreeStatus() {
            try {
                const userId = await getCurrentUserId();
                if (!userId) return false;

                const { data, error } = await db
                    .from('users')
                    .select('week_free_granted_at, completed_referrals, is_ambassador')
                    .eq('id', userId)
                    .single();

                if (error || !data || !data.week_free_granted_at) return false;

                const grantedAt = new Date(data.week_free_granted_at);
                const now = new Date();
                const freeDays = data.is_ambassador ? 60 : 7;
                const expiresAt = new Date(grantedAt);
                expiresAt.setDate(expiresAt.getDate() + freeDays);

                if (now < expiresAt) {
                    const usage = getFreemiumUsage();
                    usage.isPro = true;
                    saveFreemiumUsage(usage);
                    console.log(`[Referral] Free period active  ${freeDays} days from ${grantedAt.toISOString()}`);
                    return true;
                }

                return false;
            } catch (e) {
                console.warn('[Referral] Error checking week free status:', e);
                return false;
            }
        }
        //  PAYMENT POLLING (detect Stripe payment completion) 
        let paymentPollInterval = null;
        function startPaymentPolling() {
            if (paymentPollInterval) clearInterval(paymentPollInterval);

            let attempts = 0;
            const maxAttempts = 60;

            console.log('[Payment] Starting payment polling...');

            paymentPollInterval = setInterval(async () => {
                attempts++;

                if (attempts > maxAttempts) {
                    clearInterval(paymentPollInterval);
                    paymentPollInterval = null;
                    console.log('[Payment] Polling timeout');
                    return;
                }

                try {
                    const userId = await getCurrentUserId();
                    if (!userId) return;

                    const { data } = await db
                        .from('users')
                        .select('subscription_tier')
                        .eq('id', userId)
                        .single();

                    if (data && (data.subscription_tier === 'pro' || data.subscription_tier === 'enterprise')) {
                        clearInterval(paymentPollInterval);
                        paymentPollInterval = null;

                        console.log('[Payment]  Payment confirmed! User is now Pro');

                        const usage = getFreemiumUsage();
                        usage.isPro = true;
                        saveFreemiumUsage(usage);

                        toast(' Bienvenue chez FixAIR Pro ! Accs illimit activ.');

                        document.querySelectorAll('.upgrade-banner').forEach(b => b.remove());
                        document.querySelectorAll('.sprint-banner').forEach(b => b.remove());
                    }
                } catch (e) {
                    console.warn('[Payment] Polling error:', e);
                }
            }, 5000);
        }
        window.addEventListener('beforeunload', () => {
            if (paymentPollInterval) clearInterval(paymentPollInterval);
        });
        document.addEventListener('visibilitychange', async () => {
            if (document.visibilityState === 'visible' && paymentPollInterval) {
                try {
                    const userId = await getCurrentUserId();
                    if (!userId) return;

                    const { data } = await db
                        .from('users')
                        .select('subscription_tier')
                        .eq('id', userId)
                        .single();

                    if (data && (data.subscription_tier === 'pro' || data.subscription_tier === 'enterprise')) {
                        clearInterval(paymentPollInterval);
                        paymentPollInterval = null;

                        const usage = getFreemiumUsage();
                        usage.isPro = true;
                        saveFreemiumUsage(usage);

                        toast(' Bienvenue chez FixAIR Pro ! Accs illimit activ.');

                        document.querySelectorAll('.upgrade-banner').forEach(b => b.remove());
                        document.querySelectorAll('.sprint-banner').forEach(b => b.remove());
                    }
                } catch (e) {}
            }
        });
        // Expose all new functions
        window.handleInviteClick = handleInviteClick;
        window.shareOnWhatsAppWithVariant = shareOnWhatsAppWithVariant;
        window.grantInviteBuffer = grantInviteBuffer;
        window.showInviteConfirmPopup = showInviteConfirmPopup;
        window.closeInviteConfirmPopup = closeInviteConfirmPopup;
        window.showPendingReferralPopup = showPendingReferralPopup;
        window.closePendingPopup = closePendingPopup;
        window.checkSprintChallenge = checkSprintChallenge;
        window.showReentryPrompt = showReentryPrompt;
        window.checkWeekFreeStatus = checkWeekFreeStatus;
        window.startPaymentPolling = startPaymentPolling;

        // Expose to global scope
        window.showUpgradeModal = showUpgradeModal;
        window.closeUpgradeModal = closeUpgradeModal;
        window.handleUpgradeClick = handleUpgradeClick;
        window.canSendChat = canSendChat;
        window.trackChatUsage = trackChatUsage;
        window.canUseProFeature = canUseProFeature;
        
        // 
        // END FREEMIUM PAYWALL SYSTEM
        // 
        
        // 
        // REFERRAL PROGRAM SYSTEM
        // 
        
        // Referral state
        let referralState = {
            code: null,
            totalReferrals: 0,
            bonusQueries: 0,
            isAmbassador: false
        };
        
        // Get referral link
        function getReferralLink() {
            if (!referralState.code) return 'https://go.fixair.ai';
            return `https://go.fixair.ai/r/${referralState.code}`;
        }
        
        // Get WhatsApp share message
        function getWhatsAppMessage() {
            const link = getReferralLink();
            const message = `Salut ! Je viens de trouver un truc pour les dpannages CVC  diagnostic IA + rapports auto en 30 secondes. C'est trop con de garder a pour moi.\nTeste avec mon lien, on gagne tous les deux 1 semaine gratuite : ${link}`;
            return encodeURIComponent(message);
        }
        
        // Share on WhatsApp
        function shareOnWhatsApp() {
            const url = `https://wa.me/?text=${getWhatsAppMessage()}`;
            window.open(url, '_blank');
            
            // Track share event
            trackReferralShare('whatsapp');
        }
        
        // Share on WhatsApp from friction modal
        function shareOnWhatsAppFromModal() {
            shareOnWhatsApp();
            closeReferralModal();
        }
        
        // Copy referral code
        function copyReferralCode() {
            if (!referralState.code) return;
            
            navigator.clipboard.writeText(referralState.code).then(() => {
                toast('Code copi !');
            }).catch(() => {
                // Fallback
                const input = document.createElement('input');
                input.value = referralState.code;
                document.body.appendChild(input);
                input.select();
                document.execCommand('copy');
                document.body.removeChild(input);
                toast('Code copi !');
            });
        }
        
        // Copy referral link
        function copyReferralLink() {
            const link = getReferralLink();
            
            navigator.clipboard.writeText(link).then(() => {
                toast('Lien copi !');
            }).catch(() => {
                // Fallback
                const input = document.createElement('input');
                input.value = link;
                document.body.appendChild(input);
                input.select();
                document.execCommand('copy');
                document.body.removeChild(input);
                toast('Lien copi !');
            });
            
            // Track share event
            trackReferralShare('copy_link');
        }
        
        // Track referral share event (for analytics)
        async function trackReferralShare(source) {
            try {
                // Could send analytics event here
                console.log(`Referral shared via ${source}`);
            } catch (e) {
                console.error('Failed to track referral share:', e);
            }
        }
        
        // Legacy wrapper  redirect to unified modal
        function showReferralModal(context) {
            showUpgradeModal(context || 'limit');
        }

        function closeReferralModal(event) {
            closeUpgradeModal(event);
        }
        
        // Load referral data from user profile
        async function loadReferralData() {
            if (!currentUser || !currentUser.id) return;
            
            try {
                // Get user's referral data
                const { data, error } = await db
                    .from('users')
                    .select('referral_code, total_referrals, bonus_queries, is_ambassador')
                    .eq('id', currentUser.id)
                    .single();
                
                if (error) {
                    console.error('Failed to load referral data:', error);
                    return;
                }
                
                if (data) {
                    referralState.code = data.referral_code;
                    referralState.totalReferrals = data.total_referrals || 0;
                    referralState.bonusQueries = data.bonus_queries || 0;
                    referralState.isAmbassador = data.is_ambassador || false;
                    
                    // Update UI
                    updateReferralUI();
                }
            } catch (e) {
                console.error('Error loading referral data:', e);
            }
        }
        
        // Update referral UI elements
        function updateReferralUI() {
            // Update code display
            const codeEl = document.getElementById('myReferralCode');
            if (codeEl && referralState.code) {
                codeEl.textContent = referralState.code.toUpperCase();
            }
            
            // Update stats
            const countEl = document.getElementById('referralCount');
            if (countEl) {
                countEl.textContent = referralState.totalReferrals;
            }
            
            const bonusEl = document.getElementById('bonusQueries');
            if (bonusEl) {
                bonusEl.textContent = referralState.bonusQueries;
            }
        }
        
        // Generate referral code if user doesn't have one
        async function ensureReferralCode() {
            if (!currentUser || !currentUser.id) return;
            
            try {
                // Check if user already has a code
                const { data, error } = await db
                    .from('users')
                    .select('referral_code')
                    .eq('id', currentUser.id)
                    .single();
                
                if (error) {
                    console.error('Error checking referral code:', error);
                    return;
                }
                
                if (data && data.referral_code) {
                    referralState.code = data.referral_code;
                    return;
                }
                
                // Generate new code
                const firstName = currentUser.first_name || currentUser.email?.split('@')[0] || 'user';
                const baseName = firstName.toLowerCase().replace(/[^a-z]/g, '').slice(0, 10) || 'user';
                const newCode = baseName + Math.floor(1000 + Math.random() * 9000);
                
                // Save to database
                const { error: updateError } = await db
                    .from('users')
                    .update({ referral_code: newCode })
                    .eq('id', currentUser.id);
                
                if (updateError) {
                    console.error('Error saving referral code:', updateError);
                    return;
                }
                
                referralState.code = newCode;
                updateReferralUI();
                
            } catch (e) {
                console.error('Error ensuring referral code:', e);
            }
        }
        
        // Initialize referral system
        async function initReferral() {
            await ensureReferralCode();
            await loadReferralData();
        }
        
        // Hook into profile view opening
        const originalOpenProfile = window.openProfile;
        window.openProfile = function() {
            if (originalOpenProfile) originalOpenProfile();
            // Refresh referral data when profile opens
            loadReferralData();
        };
        
        // Expose functions globally
        window.shareOnWhatsApp = shareOnWhatsApp;
        window.shareOnWhatsAppFromModal = shareOnWhatsAppFromModal;
        window.copyReferralCode = copyReferralCode;
        window.copyReferralLink = copyReferralLink;
        window.showReferralModal = showReferralModal;
        window.closeReferralModal = closeReferralModal;
        window.initReferral = initReferral;
        window.loadReferralData = loadReferralData;
        
        // 
        // END REFERRAL PROGRAM SYSTEM
        // 
        
        // 
        // GAMIFICATION - REALISTIC ECONOMIC MODEL
        // 
        // Base: Technician hourly rate = 100/h (400/half-day  4h)
        // Report traditional cost: 45min direct + 15min corrections + stress = ~120
        // 
        
        const GAMIFICATION_CONFIG = {
            hourlyRate: 100, // /hour base rate
            actions: {
                // Report: Saves ~1h of work (writing + corrections + back-and-forth)
                report: { minutes: 60, euros: 100.00, description: "Rapport professionnel gnr" },
                // OCR: Saves ~10min of manual data entry
                ocr: { minutes: 10, euros: 15.00, description: "Analyse photo/plaque" },
                // Photo: Quick capture vs manual notes
                photo: { minutes: 5, euros: 8.00, description: "Photo documente" },
                // Voice note: Saves typing time
                voice: { minutes: 4, euros: 6.00, description: "Note vocale transcrite" },
                // Copilot active usage (per 10 min session)
                copilot_session: { minutes: 15, euros: 25.00, description: "Session diagnostic Copilot" }
                // NOTE: Messages are NOT tracked - only real value actions
            },
            messages: [
                { threshold: 0, text: "Lance-toi", emoji: "" },
                { threshold: 30, text: "Bien jou, continue", emoji: "" },
                { threshold: 80, text: "Tu progresses bien", emoji: "" },
                { threshold: 150, text: "Efficace", emoji: "", greenEmoji: true },
                { threshold: 250, text: "Impressionnant", emoji: "" },
                { threshold: 400, text: "Machine de guerre", emoji: "" },
                { threshold: 600, text: "Expert FixAIR", emoji: "" }
            ],
            weeklyGoal: 300, //  realistic weekly goal (3 reports + usage)
            tooltips: {
                euros: "Estimation base sur votre tarif horaire (~100/h) et le temps conomis vs mthodes traditionnelles (rdaction manuelle, corrections, stress...)",
                time: "Temps total conomis cette semaine grce  FixAIR vs travail manuel",
                reports: "Rapports professionnels gnrs automatiquement, prts  envoyer"
            }
        };
        
        // Track action to database
        async function trackAction(actionType, projectId = null) {
            // Ensure we have user ID
            const userId = await getCurrentUserId();
            if (!userId || userId.startsWith('demo-')) {
                return;
            }

            const config = GAMIFICATION_CONFIG.actions[actionType];
            if (!config) {
                return;
            }

            // NOTE: Don't update lastKnownStats here - let the homepage comparison work

            try {
                const { error } = await db.from('user_actions').insert({
                    user_id: userId,
                    action_type: actionType,
                    minutes_saved: config.minutes,
                    euros_saved: config.euros,
                    project_id: projectId || currentProjectId
                });

                if (error) {
                    // Si table n'existe pas encore, ignorer silencieusement
                    if (error.code === '42P01') {
                        return;
                    }
                    throw error;
                }

                // Don't refresh stats here - let homepage celebration handle it

            } catch (err) {
                // Erreur tracking action
            }
        }
        
        // Get Monday of current week
        function getWeekStart() {
            const now = new Date();
            const dayOfWeek = now.getDay();
            const mondayOffset = dayOfWeek === 0 ? -6 : 1 - dayOfWeek;
            const monday = new Date(now);
            monday.setDate(now.getDate() + mondayOffset);
            monday.setHours(0, 0, 0, 0);
            return monday;
        }
        
        // Get weekly stats from database
        async function getWeeklyStats() {
            // Ensure we have user ID
            const userId = await getCurrentUserId();
            if (!userId || userId.startsWith('demo-')) {
                return null;
            }

            try {
                const monday = getWeekStart();

                const { data, error } = await db
                    .from('user_actions')
                    .select('action_type, minutes_saved, euros_saved')
                    .eq('user_id', userId)
                    .gte('created_at', monday.toISOString());

                if (error) {
                    if (error.code === '42P01') {
                        return null;
                    }
                    throw error;
                }
                
                const stats = {
                    reports: 0,
                    ocr: 0,
                    photos: 0,
                    messages: 0,
                    totalMinutes: 0,
                    totalEuros: 0
                };
                
                (data || []).forEach(action => {
                    stats.totalMinutes += action.minutes_saved || 0;
                    stats.totalEuros += parseFloat(action.euros_saved) || 0;
                    
                    switch(action.action_type) {
                        case 'report': stats.reports++; break;
                        case 'ocr': stats.ocr++; break;
                        case 'photo': stats.photos++; break;
                        case 'message': stats.messages++; break;
                    }
                });
                
                return stats;
                
            } catch (err) {
                console.error('Erreur rcupration stats:', err);
                return null;
            }
        }
        
        // Format time saved - returns {value, unit, extra} for proper display
        function formatTimeSaved(minutes) {
            if (minutes < 60) {
                return { value: minutes, unit: 'min', extra: null };
            }
            const hours = Math.floor(minutes / 60);
            const mins = minutes % 60;
            if (mins === 0) {
                return { value: hours, unit: 'h', extra: null };
            }
            return { value: hours, unit: 'h', extra: mins };
        }
        
        // Get motivational message
        // Get user's first name for personalization
        function getUserFirstName() {
            const user = JSON.parse(localStorage.getItem('fixair_user') || 'null');
            // Return actual name or null (not a fallback)
            return user?.first_name || null;
        }
        
        // Get motivational message with user's name (if available)
        function getMotivationalMessage(euros) {
            const messages = GAMIFICATION_CONFIG.messages;
            const name = getUserFirstName();
            let selected = messages[0];
            
            for (const msg of messages) {
                if (euros >= msg.threshold) selected = msg;
            }
            
            // Build text: "Lance-toi Sam !" or "Lance-toi !" if no name
            const textWithName = name ? `${selected.text} ${name} !` : `${selected.text} !`;
            
            // Return object with text and emoji info for special styling
            if (selected.greenEmoji) {
                return { 
                    text: textWithName, 
                    emoji: selected.emoji,
                    isGreen: true 
                };
            }
            return { 
                text: textWithName, 
                emoji: selected.emoji,
                isGreen: false 
            };
        }
        
        // Format message for display (handles green emoji)
        function formatMotivationalMessage(msgObj) {
            if (msgObj.isGreen) {
                return `${msgObj.text} <span class="green-emoji">${msgObj.emoji}</span>`;
            }
            return `${msgObj.text} ${msgObj.emoji}`;
        }
        
        // Calculate ring percentage
        function calculateRingPercentage(euros) {
            const percentage = Math.min((euros / GAMIFICATION_CONFIG.weeklyGoal) * 100, 100);
            return Math.round(percentage);
        }
        
        // Update ring SVG
        function updateStatsRing(percentage) {
            const ring = document.getElementById('statsRingProgress');
            if (!ring) return;
            
            const circumference = 2 * Math.PI * 54; // r = 54
            const offset = circumference - (percentage / 100) * circumference;
            
            ring.style.strokeDasharray = circumference;
            ring.style.strokeDashoffset = offset;
            
            const percentText = document.getElementById('statsRingPercent');
            if (percentText) percentText.textContent = `${percentage}%`;
        }
        
        // Get week label
        function getWeekLabel() {
            const monday = getWeekStart();
            const sunday = new Date(monday);
            sunday.setDate(monday.getDate() + 6);
            
            const options = { day: 'numeric', month: 'short' };
            const mondayStr = monday.toLocaleDateString('fr-FR', options);
            const sundayStr = sunday.toLocaleDateString('fr-FR', options);
            
            return `Semaine du ${mondayStr} au ${sundayStr}`;
        }
        
        // Refresh weekly stats display
        async function refreshWeeklyStats() {
            const stats = await getWeeklyStats();
            
            // Si pas de stats (table pas cre ou pas de donnes), afficher valeurs par dfaut
            const displayStats = stats || { totalMinutes: 0, totalEuros: 0, reports: 0 };
            
            const percentage = calculateRingPercentage(displayStats.totalEuros);
            const message = getMotivationalMessage(displayStats.totalEuros);
            const timeData = formatTimeSaved(displayStats.totalMinutes);
            
            // Mettre  jour le Ring
            updateStatsRing(percentage);
            
            // Mettre  jour les textes
            const timeValueEl = document.getElementById('statsTimeValue');
            const timeUnitEl = document.getElementById('statsTimeUnit');
            const eurosEl = document.getElementById('statsEurosSaved');
            const reportsEl = document.getElementById('statsReports');
            const messageEl = document.getElementById('statsMessage');
            const weekLabelEl = document.getElementById('statsWeekLabel');
            
            // Format time with separate value and unit
            if (timeValueEl) {
                if (timeData.extra) {
                    timeValueEl.textContent = timeData.value;
                    timeUnitEl.innerHTML = `${timeData.unit}<span class="stats-item-value" style="margin-left:1px">${timeData.extra}</span><span class="stats-item-unit">min</span>`;
                } else {
                    timeValueEl.textContent = timeData.value;
                    timeUnitEl.textContent = timeData.unit;
                }
            }
            
            if (eurosEl) eurosEl.textContent = `${Math.round(displayStats.totalEuros)}`;
            if (reportsEl) reportsEl.textContent = displayStats.reports;
            if (messageEl) messageEl.innerHTML = formatMotivationalMessage(message);
            if (weekLabelEl) weekLabelEl.textContent = getWeekLabel();
        }
        
        // 
        // CELEBRATION ANIMATION - CONFETTI + COUNT-UP
        // 
        
        // Load last known stats from localStorage (persists across page reloads)
        let lastKnownStats = JSON.parse(localStorage.getItem('fixair_lastStats') || '{"totalMinutes":0,"totalEuros":0,"reports":0}');
        let celebrationInProgress = false;
        
        // Save stats to localStorage
        function saveLastKnownStats(stats) {
            lastKnownStats = { ...stats };
            localStorage.setItem('fixair_lastStats', JSON.stringify(stats));
        }
        
        // Create confetti particles
        function createConfetti() {
            const overlay = document.createElement('div');
            overlay.className = 'celebration-overlay';
            overlay.id = 'celebrationOverlay';
            document.body.appendChild(overlay);
            
            const colors = ['#FFD700', '#FF6B35', '#22C55E', '#3B82F6', '#A78BFA', '#F472B6', '#FCD34D', '#EF4444'];
            
            for (let i = 0; i < 80; i++) {
                const particle = document.createElement('div');
                particle.className = 'confetti-particle';
                
                const size = 8 + Math.random() * 8;
                const x = Math.random() * 100;
                const wobble = (Math.random() - 0.5) * 120;
                const delay = Math.random() * 0.8;
                const duration = 2.5 + Math.random() * 1.5;
                const color = colors[i % colors.length];
                
                particle.style.cssText = `
                    left: ${x}%;
                    width: ${size}px;
                    height: ${size * 0.6}px;
                    background: ${color};
                    --wobble: ${wobble}px;
                    --delay: ${delay}s;
                    --duration: ${duration}s;
                `;
                
                overlay.appendChild(particle);
            }
            
            // Remove after animation completes (max duration 4s + max delay 0.8s + buffer)
            setTimeout(() => {
                overlay.remove();
            }, 5500);
        }
        
        // Show floating +1 (or +X%)
        function showPlusOne(text = '+1') {
            const plusOne = document.createElement('div');
            plusOne.className = 'plus-one-floating';
            plusOne.textContent = text;
            document.body.appendChild(plusOne);
            
            setTimeout(() => {
                plusOne.remove();
            }, 2000);
        }
        
        // Animate stats count-up
        function animateStatsCountUp(fromStats, toStats, duration = 1500) {
            const startTime = Date.now();
            
            const ring = document.getElementById('statsRingProgress');
            if (ring) ring.classList.add('animating');
            
            const animate = () => {
                const elapsed = Date.now() - startTime;
                const progress = Math.min(elapsed / duration, 1);
                const eased = 1 - Math.pow(1 - progress, 3); // ease-out cubic
                
                // Interpolate values
                const currentMinutes = Math.round(fromStats.totalMinutes + (toStats.totalMinutes - fromStats.totalMinutes) * eased);
                const currentEuros = Math.round(fromStats.totalEuros + (toStats.totalEuros - fromStats.totalEuros) * eased);
                const currentReports = Math.round(fromStats.reports + (toStats.reports - fromStats.reports) * eased);
                
                // Update display
                const percentage = calculateRingPercentage(currentEuros);
                updateStatsRing(percentage);
                
                const percentEl = document.getElementById('statsRingPercent');
                if (percentEl) percentEl.textContent = percentage + '%';
                
                const timeData = formatTimeSaved(currentMinutes);
                const timeValueEl = document.getElementById('statsTimeValue');
                const timeUnitEl = document.getElementById('statsTimeUnit');
                if (timeValueEl) {
                    timeValueEl.textContent = timeData.value;
                    if (timeData.extra) {
                        timeUnitEl.innerHTML = `${timeData.unit}<span class="stats-item-value" style="margin-left:1px">${timeData.extra}</span><span class="stats-item-unit">min</span>`;
                    } else {
                        timeUnitEl.textContent = timeData.unit;
                    }
                }
                
                const eurosEl = document.getElementById('statsEurosSaved');
                if (eurosEl) eurosEl.textContent = `${currentEuros}`;
                
                const reportsEl = document.getElementById('statsReports');
                if (reportsEl) reportsEl.textContent = currentReports;
                
                if (progress < 1) {
                    requestAnimationFrame(animate);
                } else {
                    if (ring) ring.classList.remove('animating');
                    
                    // Update message
                    const message = getMotivationalMessage(toStats.totalEuros);
                    const messageEl = document.getElementById('statsMessage');
                    if (messageEl) messageEl.innerHTML = formatMotivationalMessage(message);
                }
            };
            
            requestAnimationFrame(animate);
        }
        
        // Full celebration sequence
        function triggerCelebration(newStats, oldStats) {
            if (celebrationInProgress) return;
            celebrationInProgress = true;

            // Calculate difference for +X display
            const eurosDiff = Math.round(newStats.totalEuros - oldStats.totalEuros);
            const percentDiff = calculateRingPercentage(newStats.totalEuros) - calculateRingPercentage(oldStats.totalEuros);
            
            // Start confetti
            createConfetti();
            
            // Show +X after a small delay
            setTimeout(() => {
                if (percentDiff > 0) {
                    showPlusOne(`+${percentDiff}%`);
                } else if (eurosDiff > 0) {
                    showPlusOne(`+${eurosDiff}`);
                }
            }, 300);
            
            // Animate count-up
            animateStatsCountUp(oldStats, newStats, 1800);
            
            setTimeout(() => {
                celebrationInProgress = false;
            }, 3000);
        }
        
        // Check if celebration should trigger
        function shouldCelebrate(newStats, oldStats) {
            // Celebrate if there's any increase
            return newStats.totalEuros > oldStats.totalEuros || 
                   newStats.reports > oldStats.reports ||
                   newStats.totalMinutes > oldStats.totalMinutes;
        }
        
        // Initialize gamification on login with celebration check
        async function initGamification(forceCheck = false) {
            // Ensure we have the user ID
            const userId = await getCurrentUserId();
            if (!userId || userId.startsWith('demo-')) {
                return;
            }

            const stats = await getWeeklyStats();
            const newStats = stats || { totalMinutes: 0, totalEuros: 0, reports: 0 };

            // First login ever (no previous stats saved) - just display without animation
            if (!forceCheck && lastKnownStats.totalEuros === 0 && lastKnownStats.totalMinutes === 0 && lastKnownStats.reports === 0) {
                // But if DB has stats, it means user was already active - show celebration!
                if (newStats.totalEuros > 0 || newStats.totalMinutes > 0 || newStats.reports > 0) {
                    triggerCelebration(newStats, { totalMinutes: 0, totalEuros: 0, reports: 0 });
                    saveLastKnownStats(newStats);
                    return;
                }
                await refreshWeeklyStats();
                saveLastKnownStats(newStats);
                return;
            }

            // Check if we should celebrate (any increase in stats)
            const hasIncrease =
                newStats.totalEuros > lastKnownStats.totalEuros ||
                newStats.totalMinutes > lastKnownStats.totalMinutes ||
                newStats.reports > lastKnownStats.reports;

            if (hasIncrease || forceCheck) {
                triggerCelebration(newStats, forceCheck ? { totalMinutes: 0, totalEuros: 0, reports: 0 } : lastKnownStats);
            } else {
                await refreshWeeklyStats();
            }

            saveLastKnownStats(newStats);
        }

        // Call celebration when returning to homepage
        function onReturnToHomepage() {
            if (currentUserId) {
                initGamification(false);
            }
        }
        

        // 
        // CALENDAR FUNCTIONS
        // 
        let techCalDate = new Date();
        let techCalView = 'day';
        let calendarEvents = [];
        let editingEventId = null;

        async function initTechCalendar() {
            // Try to load from Supabase first
            const userId = await getCurrentUserId();
            if (db && userId && !userId.startsWith('demo-')) {
                try {
                    const { data, error } = await db
                        .from('calendar_events')
                        .select('*')
                        .eq('user_id', userId)
                        .order('date', { ascending: true });
                    
                    if (!error && data) {
                        calendarEvents = data.map(ev => ({
                            id: ev.id,
                            title: ev.title,
                            type: ev.type,
                            date: ev.date,
                            startTime: ev.start_time,
                            endTime: ev.end_time,
                            allDay: ev.all_day,
                            location: ev.location,
                            client: ev.client,
                            repeat: ev.repeat_type,
                            reminder: ev.reminder,
                            visibility: ev.visibility,
                            notes: ev.notes,
                            projectId: ev.project_id,
                            jobId: ev.job_id
                        }));
                        // Clear old localStorage demo events
                        localStorage.removeItem('fixair_calendar_events');
                        renderTechCalendar();
                        return;
                    } else if (error) {
                        console.error('Supabase calendar error:', error);
                    }
                } catch (err) {
                    console.error('Error loading calendar events:', err);
                }
            }
            
            // Fallback to localStorage (but filter out demo events)
            const stored = localStorage.getItem('fixair_calendar_events');
            if (stored) {
                const parsed = JSON.parse(stored);
                // Filter out old demo events
                calendarEvents = parsed.filter(ev => !ev.id.startsWith('demo'));
            } else {
                // Start with empty calendar - no demo events
                calendarEvents = [];
            }
            renderTechCalendar();
        }

        async function saveCalendarEventsToStorage() {
            // Always save to localStorage as backup
            localStorage.setItem('fixair_calendar_events', JSON.stringify(calendarEvents));
        }

        async function saveEventToSupabase(eventData) {
            const userId = await getCurrentUserId();

            if (!db || !userId || userId.startsWith('demo-')) {
                return null;
            }
            
            try {
                // Only use columns that exist in the table
                const supabaseData = {
                    user_id: userId,
                    title: eventData.title,
                    type: eventData.type,
                    date: eventData.date,
                    start_time: eventData.startTime || null,
                    end_time: eventData.endTime || null,
                    all_day: eventData.allDay || false,
                    location: eventData.location || null,
                    client: eventData.client || null,
                    notes: eventData.notes || null,
                    project_id: eventData.projectId || null
                };

                if (eventData.id && !eventData.id.startsWith('ev-') && !eventData.id.startsWith('demo')) {
                    // Update existing
                    const { data, error } = await db
                        .from('calendar_events')
                        .update(supabaseData)
                        .eq('id', eventData.id)
                        .eq('user_id', userId)
                        .select()
                        .single();
                    
                    if (error) throw error;
                    return data;
                } else {
                    // Insert new
                    delete supabaseData.id;
                    const { data, error } = await db
                        .from('calendar_events')
                        .insert(supabaseData)
                        .select()
                        .single();
                    
                    if (error) throw error;
                    return data;
                }
            } catch (err) {
                toast('Erreur sauvegarde calendrier');
                return null;
            }
        }

        async function deleteEventFromSupabase(eventId) {
            const userId = await getCurrentUserId();
            if (!db || !userId || userId.startsWith('demo-')) return;
            if (eventId.startsWith('ev-') || eventId.startsWith('demo')) return; // Local-only event
            
            try {
                const { error } = await db
                    .from('calendar_events')
                    .delete()
                    .eq('id', eventId)
                    .eq('user_id', userId);
                
                if (error) throw error;
            } catch (err) {
                // Error deleting event
            }
        }

        async function createProjectForEvent(eventData) {
            // Create a project when event type is copilot or assistant
            const userId = await getCurrentUserId();
            if (!db || !userId || userId.startsWith('demo-')) {
                return null;
            }
            if (eventData.type !== 'copilot' && eventData.type !== 'assistant') {
                return null;
            }
            
            try {
                // Create the project
                const { data: project, error: projectError } = await db
                    .from('projects')
                    .insert({
                        user_id: userId,
                        title: eventData.title,
                        brand: brand || 'mitsubishi'
                    })
                    .select()
                    .single();
                
                if (projectError) throw projectError;

                // Create a chat with the correct type (copilot or assistant)
                const { data: chat, error: chatError } = await db
                    .from('chats')
                    .insert({
                        project_id: project.id,
                        user_id: userId,
                        chat_type: eventData.type // 'copilot' or 'assistant'
                    })
                    .select()
                    .single();
                
                // Chat creation error handled silently

                return project.id;
            } catch (err) {
                return null;
            }
        }

        function formatDateKey(date) {
            return date.toISOString().split('T')[0];
        }

        function getEventsForDate(date) {
            const dateKey = formatDateKey(date);
            return calendarEvents.filter(e => e.date === dateKey);
        }

        function setTechCalView(view, btn) {
            techCalView = view;
            document.querySelectorAll('#techCalendar .calendar-tab').forEach(t => t.classList.remove('active'));
            if (btn) btn.classList.add('active');
            renderTechCalendar();
        }

        function navTechCal(dir) {
            if (techCalView === 'day') {
                techCalDate.setDate(techCalDate.getDate() + dir);
            } else if (techCalView === 'week') {
                techCalDate.setDate(techCalDate.getDate() + (dir * 7));
            } else {
                techCalDate.setMonth(techCalDate.getMonth() + dir);
            }
            renderTechCalendar();
        }

        function renderTechCalendar() {
            const container = document.getElementById('techCalContent');
            const title = document.getElementById('techCalTitle');
            if (!container) return;

            const days = ['Dim', 'Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam'];
            const months = ['Janvier', 'Fvrier', 'Mars', 'Avril', 'Mai', 'Juin', 'Juillet', 'Aot', 'Septembre', 'Octobre', 'Novembre', 'Dcembre'];

            if (techCalView === 'day') {
                title.textContent = `${days[techCalDate.getDay()]} ${techCalDate.getDate()} ${months[techCalDate.getMonth()]}`;
                container.innerHTML = buildTechDayView();
            } else if (techCalView === 'week') {
                const weekStart = new Date(techCalDate);
                const dayOfWeek = techCalDate.getDay();
                const diff = dayOfWeek === 0 ? -6 : 1 - dayOfWeek;
                weekStart.setDate(techCalDate.getDate() + diff);
                title.textContent = `Semaine du ${weekStart.getDate()} ${months[weekStart.getMonth()]}`;
                container.innerHTML = buildTechWeekView();
            } else {
                title.textContent = `${months[techCalDate.getMonth()]} ${techCalDate.getFullYear()}`;
                container.innerHTML = buildTechMonthView();
            }
        }

        function buildTechDayView() {
            const hours = ['06:00','07:00','08:00','09:00','10:00','11:00','12:00','13:00','14:00','15:00','16:00','17:00','18:00','19:00'];
            const dayEvents = getEventsForDate(techCalDate);
            
            // Match events by hour (handles "10:00", "10:30", "10:00:00" etc.)
            const eventsByHour = {};
            dayEvents.forEach(ev => {
                if (ev.startTime) {
                    const hourKey = ev.startTime.substring(0, 2) + ':00';
                    eventsByHour[hourKey] = ev;
                }
            });

            return `<div class="calendar-daily">${hours.map(h => {
                const ev = eventsByHour[h];
                const evType = ev ? ev.type : '';
                const longPressAttr = ev ? `ontouchstart="startEventLongPress(event, '${ev.id}')" ontouchend="cancelEventLongPress()" ontouchmove="cancelEventLongPress()"` : '';
                return `<div class="daily-slot">
                    <div class="daily-time">${h}</div>
                    <div class="daily-content ${ev ? 'has-event ' + evType : ''}" onclick="${ev ? `handleEventClick(event, '${ev.id}')` : `createCalendarEvent('${h}')`}" ${ev ? `oncontextmenu="showEventContextMenu(event, '${ev.id}')"` : ''} ${longPressAttr}>
                        ${ev ? `<div class="daily-event-title">${ev.title}</div><div class="daily-event-meta">${ev.client || ev.location || ''}</div>` : ''}
                    </div>
                </div>`;
            }).join('')}</div>`;
        }

        function buildTechWeekView() {
            const dayNames = ['Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam', 'Dim'];
            const today = new Date();
            const todayStr = formatDateKey(today);
            
            const weekStart = new Date(techCalDate);
            const dayOfWeek = techCalDate.getDay();
            const diff = dayOfWeek === 0 ? -6 : 1 - dayOfWeek;
            weekStart.setDate(techCalDate.getDate() + diff);
            
            const weekDays = [];
            for (let i = 0; i < 7; i++) {
                const d = new Date(weekStart);
                d.setDate(weekStart.getDate() + i);
                weekDays.push({
                    date: d,
                    dateKey: formatDateKey(d),
                    day: dayNames[i],
                    num: d.getDate(),
                    isToday: formatDateKey(d) === todayStr
                });
            }

            return `<div class="calendar-week-wrapper"><div class="calendar-week">
                <div></div>
                ${weekDays.map(d => `<div class="week-header-cell ${d.isToday ? 'today' : ''}" onclick="goToTechDayViewDate('${d.dateKey}')"><div class="day-num">${d.num}</div><div>${d.day}</div></div>`).join('')}
                <div class="week-time-label">AM</div>
                ${weekDays.map(d => {
                    const dayEvents = calendarEvents.filter(e => e.date === d.dateKey && parseInt(e.startTime) < 12);
                    return `<div class="week-slot" onclick="createCalendarEventForDate('${d.dateKey}', '09:00')">${dayEvents.map(e => `<div class="week-slot-event ${e.type}" onclick="event.stopPropagation();handleEventClick(event, '${e.id}')" oncontextmenu="event.stopPropagation();showEventContextMenu(event, '${e.id}')" ontouchstart="event.stopPropagation();startEventLongPress(event, '${e.id}')" ontouchend="cancelEventLongPress()" ontouchmove="cancelEventLongPress()">${e.title.substring(0,12)}${e.title.length > 12 ? '...' : ''}</div>`).join('')}</div>`;
                }).join('')}
                <div class="week-time-label">PM</div>
                ${weekDays.map(d => {
                    const dayEvents = calendarEvents.filter(e => e.date === d.dateKey && parseInt(e.startTime) >= 12);
                    return `<div class="week-slot" onclick="createCalendarEventForDate('${d.dateKey}', '14:00')">${dayEvents.map(e => `<div class="week-slot-event ${e.type}" onclick="event.stopPropagation();handleEventClick(event, '${e.id}')" oncontextmenu="event.stopPropagation();showEventContextMenu(event, '${e.id}')" ontouchstart="event.stopPropagation();startEventLongPress(event, '${e.id}')" ontouchend="cancelEventLongPress()" ontouchmove="cancelEventLongPress()">${e.title.substring(0,12)}${e.title.length > 12 ? '...' : ''}</div>`).join('')}</div>`;
                }).join('')}
            </div></div>`;
        }

        function buildTechMonthView() {
            const year = techCalDate.getFullYear();
            const month = techCalDate.getMonth();
            const today = new Date();
            const todayStr = formatDateKey(today);
            
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const daysInMonth = lastDay.getDate();
            
            let startDayOfWeek = firstDay.getDay();
            startDayOfWeek = startDayOfWeek === 0 ? 6 : startDayOfWeek - 1;
            
            const prevMonthLastDay = new Date(year, month, 0).getDate();
            const prevMonthDays = [];
            for (let i = startDayOfWeek - 1; i >= 0; i--) {
                prevMonthDays.push({ num: prevMonthLastDay - i, other: true });
            }
            
            const currentMonthDays = [];
            for (let i = 1; i <= daysInMonth; i++) {
                const dateKey = `${year}-${String(month + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
                const hasEvents = calendarEvents.some(e => e.date === dateKey);
                currentMonthDays.push({ 
                    num: i, 
                    other: false, 
                    isToday: dateKey === todayStr,
                    hasEvents,
                    dateKey
                });
            }
            
            const totalCells = prevMonthDays.length + currentMonthDays.length;
            const nextMonthDays = [];
            const remaining = 7 - (totalCells % 7);
            if (remaining < 7) {
                for (let i = 1; i <= remaining; i++) {
                    nextMonthDays.push({ num: i, other: true });
                }
            }
            
            const allDays = [...prevMonthDays, ...currentMonthDays, ...nextMonthDays];
            
            return `<div class="calendar-grid">
                <div class="calendar-day-header">Lun</div>
                <div class="calendar-day-header">Mar</div>
                <div class="calendar-day-header">Mer</div>
                <div class="calendar-day-header">Jeu</div>
                <div class="calendar-day-header">Ven</div>
                <div class="calendar-day-header">Sam</div>
                <div class="calendar-day-header">Dim</div>
                ${allDays.map(d => `<div class="calendar-day ${d.other ? 'other-month' : ''} ${d.isToday ? 'today' : ''} ${d.hasEvents ? 'has-events' : ''}" ${d.dateKey ? `onclick="goToTechDayViewDate('${d.dateKey}')"` : ''}>${d.num}</div>`).join('')}
            </div>`;
        }

        function goToToday() {
            techCalDate = new Date();
            techCalView = 'day';
            document.querySelectorAll('#techCalendar .calendar-tab').forEach(t => t.classList.remove('active'));
            document.querySelector('#techCalendar .calendar-tab').classList.add('active');
            renderTechCalendar();
        }

        function goToTechDayViewDate(dateKey) {
            techCalDate = new Date(dateKey + 'T12:00:00');
            techCalView = 'day';
            document.querySelectorAll('#techCalendar .calendar-tab').forEach(t => t.classList.remove('active'));
            document.querySelector('#techCalendar .calendar-tab').classList.add('active');
            renderTechCalendar();
        }

        function openCalendarEvent(eventId) {
            const ev = calendarEvents.find(e => e.id === eventId);
            if (!ev) return;
            
            if (ev.type === 'connect') {
                showPage('connect');
                if (ev.jobId) {
                    setTimeout(() => openConnectDrawer('job', ev.jobId), 300);
                } else {
                    setTimeout(() => openConnectDrawer('job', 'job1'), 300);
                }
            } else if (ev.type === 'copilot' || ev.type === 'assistant') {
                if (ev.projectId) {
                    loadProject(ev.projectId);
                    return;
                }
                const projects = window.projectsData || [];
                if (projects.length > 0) {
                    const matchingProject = projects.find(p => {
                        const hasAssistant = p.chats?.some(c => c.chat_type === 'assistant');
                        const hasCopilot = p.chats?.some(c => c.chat_type === 'copilot');
                        if (ev.type === 'assistant') return hasAssistant;
                        if (ev.type === 'copilot') return hasCopilot;
                        return false;
                    });
                    if (matchingProject) {
                        loadProject(matchingProject.id);
                        return;
                    }
                }
                switchMode(ev.type);
            } else {
                // Personal event - show edit drawer
                openEventDrawerForEdit(eventId);
            }
        }

        function createCalendarEvent(time) {
            openEventDrawer(formatDateKey(techCalDate), time);
        }

        function createCalendarEventForDate(dateKey, time) {
            openEventDrawer(dateKey, time);
        }

        //  EVENT DRAWER FUNCTIONS 
        let selectedEventType = 'copilot';

        function openEventDrawer(dateKey, startTime) {
            editingEventId = null;
            document.getElementById('eventDrawerTitle').textContent = 'Nouvel vnement';
            document.getElementById('eventDrawerSubtitle').textContent = 'Planifier une intervention';
            document.getElementById('eventName').value = '';
            document.getElementById('eventDate').value = dateKey;
            document.getElementById('eventStartTime').value = startTime || '09:00';
            
            const [h, m] = (startTime || '09:00').split(':');
            const endHour = (parseInt(h) + 1).toString().padStart(2, '0');
            document.getElementById('eventEndTime').value = `${endHour}:${m}`;
            
            document.getElementById('eventLocation').value = '';
            document.getElementById('eventClient').value = '';
            document.getElementById('eventRepeat').value = 'none';
            document.getElementById('eventReminder').value = '30';
            document.getElementById('eventVisibility').value = 'private';
            document.getElementById('eventNotes').value = '';
            document.getElementById('eventAllDay').classList.remove('active');
            document.getElementById('eventTimeRow').style.display = 'flex';
            
            document.getElementById('eventMoreOptions').classList.remove('show');
            document.getElementById('moreOptionsToggle').classList.remove('expanded');
            
            selectedEventType = 'copilot';
            document.querySelectorAll('.event-type-pill').forEach(p => {
                p.classList.remove('active');
                if (p.dataset.type === 'copilot') p.classList.add('active');
            });
            
            document.getElementById('eventDrawerOverlay').classList.add('show');
            document.getElementById('eventDrawer').classList.add('show');
        }

        function openEventDrawerForEdit(eventId) {
            const ev = calendarEvents.find(e => e.id === eventId);
            if (!ev) return;
            
            editingEventId = eventId;
            document.getElementById('eventDrawerTitle').textContent = 'Modifier vnement';
            document.getElementById('eventDrawerSubtitle').textContent = ev.title;
            document.getElementById('eventName').value = ev.title;
            document.getElementById('eventDate').value = ev.date;
            document.getElementById('eventStartTime').value = ev.startTime;
            document.getElementById('eventEndTime').value = ev.endTime;
            document.getElementById('eventLocation').value = ev.location || '';
            document.getElementById('eventClient').value = ev.client || '';
            document.getElementById('eventRepeat').value = ev.repeat || 'none';
            document.getElementById('eventReminder').value = ev.reminder || '30';
            document.getElementById('eventVisibility').value = ev.visibility || 'private';
            document.getElementById('eventNotes').value = ev.notes || '';
            
            if (ev.allDay) {
                document.getElementById('eventAllDay').classList.add('active');
                document.getElementById('eventTimeRow').style.display = 'none';
            } else {
                document.getElementById('eventAllDay').classList.remove('active');
                document.getElementById('eventTimeRow').style.display = 'flex';
            }
            
            if (ev.client || ev.repeat !== 'none' || ev.visibility !== 'private') {
                document.getElementById('eventMoreOptions').classList.add('show');
                document.getElementById('moreOptionsToggle').classList.add('expanded');
            } else {
                document.getElementById('eventMoreOptions').classList.remove('show');
                document.getElementById('moreOptionsToggle').classList.remove('expanded');
            }
            
            selectedEventType = ev.type;
            document.querySelectorAll('.event-type-pill').forEach(p => {
                p.classList.remove('active');
                if (p.dataset.type === ev.type) p.classList.add('active');
            });
            
            document.getElementById('eventDrawerOverlay').classList.add('show');
            document.getElementById('eventDrawer').classList.add('show');
        }

        function closeEventDrawer() {
            document.getElementById('eventDrawer').classList.remove('show');
            document.getElementById('eventDrawerOverlay').classList.remove('show');
            editingEventId = null;
        }

        function selectEventType(el) {
            document.querySelectorAll('.event-type-pill').forEach(p => p.classList.remove('active'));
            el.classList.add('active');
            selectedEventType = el.dataset.type;
        }

        function toggleEventAllDay() {
            const toggle = document.getElementById('eventAllDay');
            toggle.classList.toggle('active');
            document.getElementById('eventTimeRow').style.display = toggle.classList.contains('active') ? 'none' : 'flex';
        }

        function toggleMoreOptions() {
            const options = document.getElementById('eventMoreOptions');
            const toggle = document.getElementById('moreOptionsToggle');
            options.classList.toggle('show');
            toggle.classList.toggle('expanded');
        }

        async function saveCalendarEvent() {
            const name = document.getElementById('eventName').value.trim();
            if (!name) {
                toast('Veuillez entrer un nom');
                return;
            }
            
            // Get existing event data if editing (to preserve projectId)
            const existingEvent = editingEventId ? calendarEvents.find(e => e.id === editingEventId) : null;
            
            const eventData = {
                id: editingEventId || 'ev-' + Date.now(),
                title: name,
                type: selectedEventType,
                date: document.getElementById('eventDate').value,
                startTime: document.getElementById('eventStartTime').value,
                endTime: document.getElementById('eventEndTime').value,
                allDay: document.getElementById('eventAllDay').classList.contains('active'),
                location: document.getElementById('eventLocation').value,
                client: document.getElementById('eventClient').value,
                repeat: document.getElementById('eventRepeat').value,
                reminder: document.getElementById('eventReminder').value,
                visibility: document.getElementById('eventVisibility').value,
                notes: document.getElementById('eventNotes').value,
                projectId: existingEvent?.projectId || null,
                jobId: existingEvent?.jobId || null
            };

            // Create project for copilot/assistant events (only for new events without projectId)
            if (!eventData.projectId && (selectedEventType === 'copilot' || selectedEventType === 'assistant')) {
                const projectId = await createProjectForEvent(eventData);
                if (projectId) {
                    eventData.projectId = projectId;
                }
            }
            
            // Save to Supabase
            const savedEvent = await saveEventToSupabase(eventData);
            if (savedEvent) {
                eventData.id = savedEvent.id; // Use Supabase ID
                // Also update projectId from saved event in case it was set
                if (savedEvent.project_id) {
                    eventData.projectId = savedEvent.project_id;
                }
            }
            
            if (editingEventId) {
                const idx = calendarEvents.findIndex(e => e.id === editingEventId);
                if (idx >= 0) calendarEvents[idx] = eventData;
            } else {
                calendarEvents.push(eventData);
            }
            
            saveCalendarEventsToStorage();
            closeEventDrawer();
            renderTechCalendar();
            toast(editingEventId ? 'vnement modifi ' : 'vnement cr ');
            
            // Refresh projects list if we created a new project
            if (eventData.projectId && !editingEventId) {
                await loadUserProjects();
            }
        }

        //  EVENT CONTEXT MENU FUNCTIONS 
        let contextEventId = null;
        let eventLongPressTimer = null;
        let eventLongPressTriggered = false;

        function showEventContextMenu(e, eventId) {
            e.preventDefault();
            e.stopPropagation();
            contextEventId = eventId;
            
            const menu = document.getElementById('eventContextMenu');
            menu.classList.add('show');
            
            // Get touch or mouse position
            const x = e.clientX || (e.touches && e.touches[0]?.clientX) || 100;
            const y = e.clientY || (e.touches && e.touches[0]?.clientY) || 100;
            
            const menuWidth = 150;
            const menuHeight = 90;
            const maxX = window.innerWidth - menuWidth;
            const maxY = window.innerHeight - menuHeight;
            
            menu.style.left = Math.min(x, maxX) + 'px';
            menu.style.top = Math.min(y, maxY) + 'px';
            
            // Haptic feedback
            if (navigator.vibrate) navigator.vibrate(30);
            
            setTimeout(() => {
                document.addEventListener('click', hideEventContextMenu);
                document.addEventListener('touchstart', hideEventContextMenu, { once: true });
            }, 10);
        }

        function hideEventContextMenu() {
            document.getElementById('eventContextMenu').classList.remove('show');
            document.removeEventListener('click', hideEventContextMenu);
            contextEventId = null;
        }

        // Long-press handling for calendar events (like project cards)
        function startEventLongPress(event, eventId) {
            eventLongPressTriggered = false;
            eventLongPressTimer = setTimeout(() => {
                eventLongPressTriggered = true;
                event.preventDefault();
                if (navigator.vibrate) navigator.vibrate(30);
                showEventContextMenu(event, eventId);
            }, 500); // 500ms long press
        }

        function cancelEventLongPress() {
            if (eventLongPressTimer) {
                clearTimeout(eventLongPressTimer);
                eventLongPressTimer = null;
            }
        }

        // Handle event click - only open if not long press
        function handleEventClick(event, eventId) {
            if (eventLongPressTriggered) {
                eventLongPressTriggered = false;
                event.preventDefault();
                event.stopPropagation();
                return;
            }
            openCalendarEvent(eventId);
        }

        function modifyContextEvent() {
            if (contextEventId) {
                openEventDrawerForEdit(contextEventId);
            }
            hideEventContextMenu();
        }

        async function deleteContextEvent() {
            if (contextEventId) {
                const ev = calendarEvents.find(e => e.id === contextEventId);
                if (ev && confirm(`Supprimer "${ev.title}" ?`)) {
                    // Delete from Supabase
                    await deleteEventFromSupabase(contextEventId);
                    
                    calendarEvents = calendarEvents.filter(e => e.id !== contextEventId);
                    saveCalendarEventsToStorage();
                    renderTechCalendar();
                    toast('vnement supprim');
                }
            }
            hideEventContextMenu();
        }

        // 
        // CONNECT FUNCTIONS
        // 
        let connectActivated = false;
        let connectOnline = true;

        const connectJobsData = {
            job1: { title: 'AC ne refroidit plus', type: 'Climatisation', status: 'urgent', price: '85-120', distance: '2.3 km', time: 'ASAP', client: 'Pierre Martin', address: '45 Rue du Commerce, 75015 Paris', phone: '+33 6 12 34 56 78', desc: 'Split mural Samsung qui ne produit plus de froid. Le client indique que l\'unit extrieure fait du bruit.' },
            job2: { title: 'Bruit anormal PAC', type: 'Pompe  chaleur', status: 'new', price: '120-180', distance: '4.1 km', time: 'Aujourd\'hui 14h', client: 'Sophie Durand', address: '12 Avenue des Lilas, 75020 Paris', phone: '+33 6 98 76 54 32', desc: 'PAC Daikin Altherma avec bruit de claquement au dmarrage. Installation de 2019.' },
            job3: { title: 'Entretien annuel clim', type: 'Maintenance', status: 'scheduled', price: '65-90', distance: '5.8 km', time: 'Demain 9h', client: 'Marc Leroy', address: '8 Rue de la Paix, 75002 Paris', phone: '+33 6 55 44 33 22', desc: 'Entretien prventif sur 2 splits Mitsubishi. Accs facile, client prsent.' },
            myjob1: { title: 'Rparation compresseur', type: 'Rparation', status: 'progress', price: '180', distance: '0 km', time: 'En cours', client: 'Marie Dupont', address: '15 Rue de Paris, 75001 Paris', phone: '+33 6 11 22 33 44', desc: 'Remplacement compresseur sur groupe froid. Pices commandes et reues.', started: '10:45' },
            myjob2: { title: 'Diagnostic VRV', type: 'Diagnostic', status: 'scheduled', price: '95', distance: '3.2 km', time: 'Demain 10h', client: 'Jean Martin', address: '22 Bd Haussmann, 75009 Paris', phone: '+33 6 77 88 99 00', desc: 'Systme VRV Daikin avec code erreur U4. Prvoir multimtre et manomtres.' }
        };

        function openConnect() {
            // DISABLED - Coming soon
            toast('FixAIR Connect  Disponible prochainement');
        }

        function closeConnect() {
            closeConnectDrawer();
            document.getElementById('connectView').classList.remove('active', 'drawer-open');
            document.getElementById('navConnect').classList.remove('active');
            goToHome();
        }

        function activateConnect() {
            connectActivated = true;
            document.getElementById('connectPromo').style.display = 'none';
            document.getElementById('connectActive').style.display = 'block';
            document.getElementById('connectEarnings').textContent = '0';
            document.getElementById('connectMissions').textContent = '0';
            document.getElementById('connectRating').textContent = '-';
            toast('Connect activ !');
        }

        function openConnectDrawer(type, jobId) {
            const job = connectJobsData[jobId];
            if (!job) return;
            
            document.getElementById('connectView').classList.add('drawer-open');
            document.getElementById('connectDrawerTitle').textContent = job.title;
            document.getElementById('connectDrawerSubtitle').textContent = job.type;
            
            let bodyHTML = `
                <div class="connect-detail-section">
                    <div class="connect-detail-label">Client</div>
                    <div class="connect-detail-card">
                        <div class="connect-detail-row">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
                            <div class="connect-detail-text">${job.client}</div>
                        </div>
                        <div class="connect-detail-row">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg>
                            <div class="connect-detail-text">${job.address}<small>${job.distance}</small></div>
                        </div>
                        <div class="connect-detail-row">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72c.127.96.361 1.903.7 2.81a2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45c.907.339 1.85.573 2.81.7A2 2 0 0 1 22 16.92z"/></svg>
                            <div class="connect-detail-text">${job.phone}</div>
                        </div>
                    </div>
                </div>
                <div class="connect-detail-section">
                    <div class="connect-detail-label">Description</div>
                    <div class="connect-detail-card">
                        <div class="connect-detail-desc">${job.desc}</div>
                    </div>
                </div>
                <div class="connect-detail-section">
                    <div class="connect-detail-label">Rmunration</div>
                    <div class="connect-detail-card" style="text-align:center;">
                        <div class="connect-price-big">${job.price}</div>
                        <div class="connect-price-note">Estimation selon dure</div>
                    </div>
                </div>
            `;
            document.getElementById('connectDrawerBody').innerHTML = bodyHTML;
            
            const footer = document.getElementById('connectDrawerFooter');
            if (type === 'myjob') {
                footer.innerHTML = `
                    <button class="connect-drawer-btn danger" onclick="closeConnectDrawer()">Annuler mission</button>
                    <button class="connect-drawer-btn primary" onclick="closeConnectDrawer();toast('Mission termine!')">Terminer</button>
                `;
            } else {
                footer.innerHTML = `
                    <button class="connect-drawer-btn secondary" onclick="closeConnectDrawer()">Fermer</button>
                    <button class="connect-drawer-btn primary" onclick="acceptConnectJob('${jobId}')">Accepter</button>
                `;
            }
        }

        function closeConnectDrawer() {
            document.getElementById('connectView').classList.remove('drawer-open');
        }

        function acceptConnectJob(jobId) {
            closeConnectDrawer();
            toast('Mission accepte !');
            
            // Update stats
            const missions = parseInt(document.getElementById('connectMissions').textContent) + 1;
            document.getElementById('connectMissions').textContent = missions;
        }

        // Initialize calendar when page loads
        document.addEventListener('DOMContentLoaded', function() {
            // Wait longer to ensure Supabase is ready
            setTimeout(async function() {
                await waitForSupabase();
                initTechCalendar();
            }, 1000);
        });
    </script>
    
    </div><!-- End app-wrapper -->
    
    <!-- Gap cover: This covers any gap that might appear from iframe/embed issues -->
    <div id="gapCover" style="
        position: fixed;
        bottom: -100px;
        left: 0;
        right: 0;
        height: 200px;
        background: var(--bg, #0f1217);
        z-index: -1;
        pointer-events: none;
    "></div>
    
    <!-- RENAME PROJECT MODAL -->
    <div class="rename-modal" id="renameModal">
        <div class="rename-modal-content">
            <div class="rename-modal-title">Renommer le projet</div>
            <input type="text" class="rename-modal-input" id="renameInput" placeholder="Nom du projet">
            <div class="rename-modal-buttons">
                <button class="rename-modal-btn cancel" onclick="closeRenameModal()">Annuler</button>
                <button class="rename-modal-btn save" onclick="saveProjectRename()">Enregistrer</button>
            </div>
        </div>
    </div>

    <!-- 
         CONNECT VIEW
          -->
    <div class="connect-view" id="connectView">
        <div class="connect-content">
            <div class="connect-header">
                <button class="connect-header-back" onclick="closeConnect()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15 18 9 12 15 6"/></svg>
                </button>
                <div class="connect-header-info">
                    <div class="connect-header-title">
                        FixAIR Connect
                        <span class="connect-online-dot" id="connectOnlineDot"></span>
                    </div>
                    <div class="connect-header-sub" id="connectHeaderSub">Missions disponibles</div>
                </div>
            </div>
            <div class="connect-body">
                <div class="connect-content-inner">
                    <!-- Promo (when not activated) -->
                    <div class="connect-promo" id="connectPromo">
                        <div class="connect-promo-icon">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="2"/><path d="M16.24 7.76a6 6 0 0 1 0 8.49m-8.48-.01a6 6 0 0 1 0-8.49m11.31-2.82a10 10 0 0 1 0 14.14m-14.14 0a10 10 0 0 1 0-14.14"/></svg>
                        </div>
                        <div class="connect-promo-title">Gagnez plus avec Connect</div>
                        <div class="connect-promo-desc">Recevez des missions de dpannage dans votre zone et augmentez vos revenus.</div>
                        <div class="connect-promo-features">
                            <div class="connect-promo-feat"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg> Missions urgentes</div>
                            <div class="connect-promo-feat"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg> Paiement garanti</div>
                            <div class="connect-promo-feat"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg> Choisissez vos horaires</div>
                            <div class="connect-promo-feat"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg> Support 24/7</div>
                        </div>
                        <button class="connect-btn-activate" onclick="activateConnect()">
                            Activer Connect
                            <span class="connect-btn-badge">GRATUIT</span>
                        </button>
                        <div class="connect-promo-note">Aucun engagement  Dsactivable  tout moment</div>
                    </div>
                    
                    <!-- Active content (when activated) -->
                    <div id="connectActive" style="display:none;">
                        <div class="connect-stats-bar">
                            <div class="connect-stat-pill highlight">
                                <div class="connect-stat-val" id="connectEarnings">0</div>
                                <div class="connect-stat-lbl">Ce mois</div>
                            </div>
                            <div class="connect-stat-pill">
                                <div class="connect-stat-val" id="connectMissions">0</div>
                                <div class="connect-stat-lbl">Missions</div>
                            </div>
                            <div class="connect-stat-pill">
                                <div class="connect-stat-val" id="connectRating">-</div>
                                <div class="connect-stat-lbl">Note</div>
                            </div>
                        </div>
                        
                        <div class="connect-sec">
                            <div class="connect-sec-head">
                                <span class="connect-sec-title">Missions disponibles</span>
                                <div class="connect-sec-line"></div>
                                <span class="connect-sec-badge" id="connectAvailCount">3</span>
                            </div>
                            <div class="connect-jobs-list" id="connectAvailJobs">
                                <div class="connect-job-card urgent" onclick="openConnectDrawer('job', 'job1')">
                                    <span class="connect-job-tag urgent">URGENT</span>
                                    <div class="connect-job-body">
                                        <div class="connect-job-name">AC ne refroidit plus</div>
                                        <div class="connect-job-detail">Climatisation  2.3 km  ASAP</div>
                                    </div>
                                    <div class="connect-job-price">85-120</div>
                                    <div class="connect-job-arrow"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg></div>
                                </div>
                                <div class="connect-job-card new" onclick="openConnectDrawer('job', 'job2')">
                                    <span class="connect-job-tag new">NOUVEAU</span>
                                    <div class="connect-job-body">
                                        <div class="connect-job-name">Bruit anormal PAC</div>
                                        <div class="connect-job-detail">Pompe  chaleur  4.1 km  Aujourd'hui 14h</div>
                                    </div>
                                    <div class="connect-job-price">120-180</div>
                                    <div class="connect-job-arrow"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg></div>
                                </div>
                                <div class="connect-job-card scheduled" onclick="openConnectDrawer('job', 'job3')">
                                    <span class="connect-job-tag scheduled">PLANIFI</span>
                                    <div class="connect-job-body">
                                        <div class="connect-job-name">Entretien annuel clim</div>
                                        <div class="connect-job-detail">Maintenance  5.8 km  Demain 9h</div>
                                    </div>
                                    <div class="connect-job-price">65-90</div>
                                    <div class="connect-job-arrow"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg></div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="connect-sec">
                            <div class="connect-sec-head">
                                <span class="connect-sec-title">Mes missions</span>
                                <div class="connect-sec-line"></div>
                            </div>
                            <div class="connect-jobs-list" id="connectMyJobs">
                                <div class="connect-job-card progress" onclick="openConnectDrawer('myjob', 'myjob1')">
                                    <span class="connect-job-tag progress">EN COURS</span>
                                    <div class="connect-job-body">
                                        <div class="connect-job-name">Rparation compresseur</div>
                                        <div class="connect-job-detail">Rparation  Dmarr 10:45</div>
                                    </div>
                                    <div class="connect-job-price">180</div>
                                    <div class="connect-job-arrow"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg></div>
                                </div>
                                <div class="connect-job-card scheduled" onclick="openConnectDrawer('myjob', 'myjob2')">
                                    <span class="connect-job-tag scheduled">PLANIFI</span>
                                    <div class="connect-job-body">
                                        <div class="connect-job-name">Diagnostic VRV</div>
                                        <div class="connect-job-detail">Diagnostic  Demain 10h</div>
                                    </div>
                                    <div class="connect-job-price">95</div>
                                    <div class="connect-job-arrow"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Connect Drawer -->
        <div class="connect-drawer" id="connectDrawer">
            <div class="connect-drawer-header">
                <button class="connect-drawer-close" onclick="closeConnectDrawer()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18M6 6l12 12"/></svg>
                </button>
                <div class="connect-drawer-info">
                    <div class="connect-drawer-title" id="connectDrawerTitle">Mission</div>
                    <div class="connect-drawer-subtitle" id="connectDrawerSubtitle">Dtails</div>
                </div>
            </div>
            <div class="connect-drawer-body" id="connectDrawerBody">
                <!-- Dynamic content -->
            </div>
            <div class="connect-drawer-footer" id="connectDrawerFooter">
                <button class="connect-drawer-btn secondary" onclick="closeConnectDrawer()">Fermer</button>
                <button class="connect-drawer-btn primary" id="connectDrawerAction">Accepter</button>
            </div>
        </div>
    </div>

    <!-- EVENT CONTEXT MENU (Right-click on events) -->
    <div class="event-context-menu" id="eventContextMenu">
        <div class="event-context-item" onclick="modifyContextEvent()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
            Modifier
        </div>
        <div class="event-context-item delete" onclick="deleteContextEvent()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
            Supprimer
        </div>
    </div>

    <!-- EVENT CREATION DRAWER -->
    <div class="event-drawer-overlay" id="eventDrawerOverlay" onclick="closeEventDrawer()"></div>
    <div class="event-drawer" id="eventDrawer">
        <div class="event-drawer-header">
            <button class="event-drawer-close" onclick="closeEventDrawer()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18M6 6l12 12"/></svg>
            </button>
            <div class="event-drawer-info">
                <div class="event-drawer-title" id="eventDrawerTitle">Nouvel vnement</div>
                <div class="event-drawer-subtitle" id="eventDrawerSubtitle">Planifier une intervention</div>
            </div>
        </div>
        
        <div class="event-drawer-body">
            <div class="event-section">
                <div class="event-section-title"><span>Informations</span><div class="event-section-line"></div></div>
                <div class="event-field">
                    <div class="event-field-label">Nom de l'vnement</div>
                    <input type="text" class="event-field-input" id="eventName" placeholder="Diagnostic, Maintenance, Runion...">
                </div>
                <div class="event-field">
                    <div class="event-field-label">Type</div>
                    <div class="event-type-pills">
                        <div class="event-type-pill active copilot" data-type="copilot" onclick="selectEventType(this)">
                            <span class="pill-icon"><svg viewBox="0 0 200 200"><use href="#icon-star"/></svg></span>
                            Diagnostic
                        </div>
                        <div class="event-type-pill assistant" data-type="assistant" onclick="selectEventType(this)">
                            <span class="pill-icon"><svg viewBox="0 0 24 24"><use href="#icon-clipboard"/></svg></span>
                            Rapport
                        </div>
                        <div class="event-type-pill connect" data-type="connect" onclick="selectEventType(this)">
                            <span class="pill-icon"><svg viewBox="0 0 24 24"><use href="#icon-connect"/></svg></span>
                            Connect
                        </div>
                        <div class="event-type-pill personal" data-type="personal" onclick="selectEventType(this)">
                            <span class="pill-icon"><svg viewBox="0 0 24 24"><use href="#icon-user"/></svg></span>
                            Personnel
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="event-section">
                <div class="event-section-title"><span>Date & Heure</span><div class="event-section-line"></div></div>
                <div class="event-toggle-row">
                    <span class="event-toggle-label">Journe entire</span>
                    <div class="event-toggle" id="eventAllDay" onclick="toggleEventAllDay()"></div>
                </div>
                <div class="event-field">
                    <div class="event-field-label">Date</div>
                    <input type="date" class="event-field-input" id="eventDate">
                </div>
                <div class="event-field-row" id="eventTimeRow">
                    <div class="event-field">
                        <div class="event-field-label">Dbut</div>
                        <input type="time" class="event-field-input" id="eventStartTime" value="09:00">
                    </div>
                    <div class="event-field">
                        <div class="event-field-label">Fin</div>
                        <input type="time" class="event-field-input" id="eventEndTime" value="10:00">
                    </div>
                </div>
            </div>
            
            <div class="event-section">
                <div class="event-section-title"><span>Dtails</span><div class="event-section-line"></div></div>
                <div class="event-field">
                    <div class="event-field-label">Lieu</div>
                    <input type="text" class="event-field-input" id="eventLocation" placeholder="Adresse ou nom du site">
                </div>
                <div class="event-field">
                    <div class="event-field-label">Notes</div>
                    <textarea class="event-field-textarea" id="eventNotes" placeholder="Dtails, quipements..."></textarea>
                </div>
            </div>

            <div class="event-more-toggle" id="moreOptionsToggle" onclick="toggleMoreOptions()">
                <span>Plus d'options</span>
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>
            </div>

            <div class="event-more-options" id="eventMoreOptions">
                <div class="event-section">
                    <div class="event-section-title"><span>Options avances</span><div class="event-section-line"></div></div>
                    <div class="event-field">
                        <div class="event-field-label">Client / Contact</div>
                        <input type="text" class="event-field-input" id="eventClient" placeholder="Nom du client">
                    </div>
                    <div class="event-field-row">
                        <div class="event-field">
                            <div class="event-field-label">Rptition</div>
                            <select class="event-field-select" id="eventRepeat">
                                <option value="none">Ne pas rpter</option>
                                <option value="daily">Tous les jours</option>
                                <option value="weekly">Toutes les semaines</option>
                                <option value="monthly">Tous les mois</option>
                            </select>
                        </div>
                        <div class="event-field">
                            <div class="event-field-label">Rappel</div>
                            <select class="event-field-select" id="eventReminder">
                                <option value="none">Aucun</option>
                                <option value="15">15 min avant</option>
                                <option value="30" selected>30 min avant</option>
                                <option value="60">1h avant</option>
                                <option value="1440">1 jour avant</option>
                            </select>
                        </div>
                    </div>
                    <div class="event-field">
                        <div class="event-field-label">Visibilit</div>
                        <select class="event-field-select" id="eventVisibility">
                            <option value="private">Priv (moi uniquement)</option>
                            <option value="company">Entreprise (managers)</option>
                                             <option value="connect">FixAIR Connect</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="event-drawer-footer">
            <button class="event-drawer-btn secondary" onclick="closeEventDrawer()">Annuler</button>
            <button class="event-drawer-btn primary" onclick="saveCalendarEvent()">Enregistrer</button>
        </div>
    </div>

<!-- FixAIR Diagram System JS -->
<script src="/assets/js/fixair-diagrams.js"></script>

<script>

/* ===== THOUGHT PROCESS - FIXAIR v5 ===== */
/* Logic from v4 + Original styling restored */

const TP = {
    t: { copilot: null, assistant: null },
    i: { copilot: 0, assistant: 0 },
    s: { copilot: [], assistant: [] },
    expandedState: {},
    cardCounter: 0,
    currentCardId: { copilot: null, assistant: null },
    isSimpleMode: { copilot: false, assistant: false },
    
    // SVG Icons - ORIGINAL globe style
    icons: {
        globe: '<svg viewBox="0 0 256 256" fill="currentColor"><path d="M128,24h0A104,104,0,1,0,232,128,104.12,104.12,0,0,0,128,24Zm88,104a87.61,87.61,0,0,1-3.33,24H174.16a157.44,157.44,0,0,0,0-48h38.51A87.61,87.61,0,0,1,216,128ZM102,168H154a115.11,115.11,0,0,1-26,45A115.27,115.27,0,0,1,102,168Zm-3.9-16a140.84,140.84,0,0,1,0-48h59.88a140.84,140.84,0,0,1,0,48ZM40,128a87.61,87.61,0,0,1,3.33-24H81.84a157.44,157.44,0,0,0,0,48H43.33A87.61,87.61,0,0,1,40,128ZM154,88H102a115.11,115.11,0,0,1,26-45A115.27,115.27,0,0,1,154,88Zm52.33,0H170.71a135.28,135.28,0,0,0-22.3-45.6A88.29,88.29,0,0,1,206.37,88ZM107.59,42.4A135.28,135.28,0,0,0,85.29,88H49.63A88.29,88.29,0,0,1,107.59,42.4ZM49.63,168H85.29a135.28,135.28,0,0,0,22.3,45.6A88.29,88.29,0,0,1,49.63,168Zm98.78,45.6a135.28,135.28,0,0,0,22.3-45.6h35.66A88.29,88.29,0,0,1,148.41,213.6Z"/></svg>',
        doc: '<svg viewBox="0 0 256 256" fill="currentColor"><path d="M213.66,82.34l-56-56A8,8,0,0,0,152,24H56A16,16,0,0,0,40,40V216a16,16,0,0,0,16,16H200a16,16,0,0,0,16-16V88A8,8,0,0,0,213.66,82.34ZM160,51.31,188.69,80H160ZM200,216H56V40h88V88a8,8,0,0,0,8,8h48V216Zm-32-80a8,8,0,0,1-8,8H96a8,8,0,0,1,0-16h64A8,8,0,0,1,168,136Zm0,32a8,8,0,0,1-8,8H96a8,8,0,0,1,0-16h64A8,8,0,0,1,168,168Z"/></svg>',
        search: '<svg viewBox="0 0 256 256" fill="currentColor"><path d="M229.66,218.34l-50.07-50.06a88.11,88.11,0,1,0-11.31,11.31l50.06,50.07a8,8,0,0,0,11.32-11.32ZM40,112a72,72,0,1,1,72,72A72.08,72.08,0,0,1,40,112Z"/></svg>',
        tool: '<svg viewBox="0 0 256 256" fill="currentColor"><path d="M226.76,69a8,8,0,0,0-12.84-2.88l-40.3,37.19-17.23-3.7-3.7-17.23,37.19-40.3A8,8,0,0,0,187,29.24,72,72,0,0,0,88,96a72.34,72.34,0,0,0,2.57,19.41L32.29,166.67a28,28,0,0,0,39.6,39.6l51.26-58.28A72,72,0,0,0,226.76,69ZM160,152a56.14,56.14,0,0,1-27.07-7,8,8,0,0,0-9.92,1.77l-55.28,62.87a12,12,0,0,1-17-17l62.87-55.28a8,8,0,0,0,1.77-9.92,56,56,0,0,1,58.66-82.31l-31.6,34.21a8,8,0,0,0-1.82,6.67l5.32,24.68a8,8,0,0,0,6.27,6.27l24.68,5.32a8,8,0,0,0,6.67-1.82l34.21-31.6A56.06,56.06,0,0,1,160,152Z"/></svg>',
        brain: '<svg viewBox="0 0 256 256" fill="currentColor"><path d="M248,124a56.11,56.11,0,0,0-32-50.61V72a48,48,0,0,0-88-26.49A48,48,0,0,0,40,72v1.39a56,56,0,0,0,0,101.2V176a48,48,0,0,0,88,26.49A48,48,0,0,0,216,176v-1.41A56.09,56.09,0,0,0,248,124ZM88,208a32,32,0,0,1-31.81-28.56A55.87,55.87,0,0,0,64,180h8a8,8,0,0,0,0-16H64A40,40,0,0,1,50.67,86.27,8,8,0,0,0,56,78.73V72a32,32,0,0,1,64,0v68.26A47.8,47.8,0,0,0,88,128a8,8,0,0,0,0,16,32,32,0,0,1,0,64Zm104-44h-8a8,8,0,0,0,0,16h8a55.87,55.87,0,0,0,7.81-.56A32,32,0,1,1,168,144a8,8,0,0,0,0-16,47.8,47.8,0,0,0-32,12.26V72a32,32,0,0,1,64,0v6.73a8,8,0,0,0,5.33,7.54A40,40,0,0,1,192,164Z"/></svg>',
        chart: '<svg viewBox="0 0 256 256" fill="currentColor"><path d="M232,208a8,8,0,0,1-8,8H32a8,8,0,0,1-8-8V48a8,8,0,0,1,16,0v94.37L90.73,98a8,8,0,0,1,10.07-.38l58.81,44.11L218.73,90a8,8,0,1,1,10.54,12l-64,56a8,8,0,0,1-10.07.38L96.39,114.29,40,163.63V200H224A8,8,0,0,1,232,208Z"/></svg>',
        chevronDown: '<svg width="10" height="10" viewBox="0 0 20 20" fill="currentColor"><path d="M14.128 7.16482C14.3126 6.95983 14.6298 6.94336 14.835 7.12771C15.0402 7.31242 15.0567 7.62952 14.8721 7.83477L10.372 12.835L10.2939 12.9053C10.2093 12.9667 10.1063 13 9.99995 13C9.85833 12.9999 9.72264 12.9402 9.62788 12.835L5.12778 7.83477L5.0682 7.75273C4.95072 7.55225 4.98544 7.28926 5.16489 7.12771C5.34445 6.96617 5.60969 6.95939 5.79674 7.09744L5.87193 7.16482L9.99995 11.7519L14.128 7.16482Z"/></svg>',
        chevronUp: '<svg width="10" height="10" viewBox="0 0 20 20" fill="currentColor"><path d="M5.87193 12.835C5.68735 13.0402 5.37018 13.0567 5.16489 12.8721C4.9596 12.6874 4.94313 12.3703 5.12778 12.1651L9.62788 7.16504L9.70606 7.09473C9.79073 7.03341 9.89378 7 9.99995 7C10.1416 7.00007 10.2773 7.05978 10.372 7.16504L14.8721 12.1651L14.9317 12.2471C15.0494 12.4476 15.0145 12.7105 14.835 12.8721C14.6555 13.0338 14.3903 13.0406 14.2032 12.9024L14.128 12.835L9.99995 8.24806L5.87193 12.835Z"/></svg>'
    },
    
    // Mode colors
    modeColors: {
        copilot: '#FF6B35',
        assistant: '#22c55e'
    },

    // CSS colors - TRANSPARENT
    colors: {
        border: 'rgba(255,255,255,0.08)',
        line: 'rgba(255,255,255,0.12)',
        text: 'rgba(255,255,255,0.65)',
        textMuted: 'rgba(255,255,255,0.4)',
        bullet: 'rgba(255,255,255,0.25)'
    },

    // Simple phrases
    simplePhrases: [
        'FixAIR rflchit...',
        'Prparation...',
        'Un instant...',
        'Analyse...'
    ],

    // Check if simple query
    isSimpleQuery(q) {
        const simple = /^(salut|bonjour|bonsoir|hello|hi|hey|coucou|yo|cc|bjr|bsr|merci|thanks|ok|oui|non|yes|no|d'accord|super|parfait|cool|nice|top|gnial|excellent|a va|ca va|comment vas|quoi de neuf|qui es tu|qui es-tu|que fais tu|que peux tu|c'est quoi|qu'est ce que)[\s!?.]*$/i;
        return simple.test(q.trim()) || q.trim().length < 20;
    },

    // Check if technical
    isTechnicalQuery(q) {
        const tech = /error|code|fault|panne|erreur|dfaut|schma|schema|diagram|wiring|cblage|pression|bar|temprature|gaz|r32|r410|frigorigne|install|mise en service|rparer|fix|dpannage|diagnostic|problme|cn\d+|pinout|\b[EPFUepfu]?\d{3,5}\b/i;
        return tech.test(q);
    },

    getSimplePhrase() {
        return this.simplePhrases[Math.floor(Math.random() * this.simplePhrases.length)];
    },

    // Analyze for technical steps - use GLOBE for searches
    analyze(q, m, b) {
        const s = [];
        const ql = q.toLowerCase();
        b = b || 'quipement';
        
        if (m === 'copilot') {
            if (/\b([EPFUepfu]?\d{2,5})\b/i.test(q) || /error|code|fault|panne|erreur|dfaut/i.test(ql)) {
                s.push({ icon: 'globe', text: 'Recherche code erreur ' + b + '...' });
                s.push({ icon: 'doc', text: 'Consultation documentation' });
            }
            if (/wiring|diagram|schema|schma|pinout|cblage|connecteur|cn\d+/i.test(ql)) {
                s.push({ icon: 'doc', text: 'Chargement schmas lectriques' });
            }
            if (/pression|bar|temprature|gaz|r32|r410|frigorigne|charge/i.test(ql)) {
                s.push({ icon: 'tool', text: 'Analyse paramtres frigorifiques' });
            }
            if (/rparer|fix|dpannage|diagnostic|problme|marche pas/i.test(ql)) {
                s.push({ icon: 'brain', text: 'Analyse diagnostic...' });
            }
            if (/graph|diagramme|visuel|courbe/i.test(ql)) {
                s.push({ icon: 'chart', text: 'Prparation visuel...' });
            }
            if (s.length === 0) {
                s.push({ icon: 'globe', text: 'Recherche base ' + b + '...' });
            }
            s.push({ icon: 'bullet', text: 'Formulation rponse...' });
        } else {
            if (/rapport|report|compte.?rendu|cerfa|document/i.test(ql)) {
                s.push({ icon: 'doc', text: 'Extraction donnes' });
                s.push({ icon: 'bullet', text: 'Gnration rapport...' });
            } else if (/image|photo|scan|plaque|ocr/i.test(ql)) {
                s.push({ icon: 'globe', text: 'Analyse image...' });
                s.push({ icon: 'bullet', text: 'Extraction...' });
            } else {
                s.push({ icon: 'brain', text: 'Analyse...' });
                s.push({ icon: 'bullet', text: 'Prparation...' });
            }
        }
        return s;
    },

    // SIMPLE card - small, disappears
    createSimpleCard(cardId, phrase, m) {
        const dotColor = this.modeColors[m];
        return '<div id="' + cardId + '" style="display:flex;align-items:center;margin:8px 0;max-width:70%;">' +
            '<div id="' + cardId + 'Dot" style="width:6px;height:6px;border-radius:50%;background:' + dotColor + ';margin-right:10px;animation:tpPulse 1.2s ease infinite;flex-shrink:0;"></div>' +
            '<span style="font-size:14px;color:' + this.colors.text + ';">' + phrase + '</span>' +
        '</div>';
    },

    // FULL card - ORIGINAL STYLE with vertical lines
    createFullCard(cardId) {
        const c = this.colors;
        
        return '<div id="' + cardId + '" style="border:0.5px solid ' + c.border + ';border-radius:8px;margin:12px 0;max-width:70%;">' +
            // COLLAPSED VIEW
            '<div id="' + cardId + 'Collapsed" style="display:none;">' +
                '<div style="display:flex;min-height:42px;cursor:pointer;" onclick="TP.toggleCard(\'' + cardId + '\')">' +
                    '<div style="display:flex;flex-direction:column;align-items:center;width:32px;padding-left:8px;">' +
                        '<div style="width:1px;height:8px;background:transparent;"></div>' +
                        '<div style="font-size:10px;color:' + c.textMuted + ';">' + this.icons.chevronUp + '</div>' +
                        '<div style="width:1px;flex-grow:1;min-height:6px;background:' + c.line + ';"></div>' +
                    '</div>' +
                    '<div style="display:flex;align-items:center;padding:8px 12px 8px 4px;flex:1;">' +
                        '<span id="' + cardId + 'Summary" style="font-size:14px;color:' + c.text + ';">Analyse termine</span>' +
                    '</div>' +
                '</div>' +
            '</div>' +
            // EXPANDED VIEW
            '<div id="' + cardId + 'Expanded">' +
                '<div style="display:flex;min-height:38px;cursor:pointer;" onclick="TP.toggleCard(\'' + cardId + '\')">' +
                    '<div style="display:flex;flex-direction:column;align-items:center;width:32px;padding-left:8px;">' +
                        '<div style="width:1px;height:8px;background:transparent;"></div>' +
                        '<div style="font-size:10px;color:' + c.textMuted + ';">' + this.icons.chevronDown + '</div>' +
                        '<div style="width:1px;flex-grow:1;min-height:6px;background:' + c.line + ';"></div>' +
                    '</div>' +
                    '<div style="display:flex;align-items:center;padding:8px 12px 8px 4px;flex:1;">' +
                        '<span id="' + cardId + 'Count" style="font-size:14px;color:' + c.textMuted + ';">Analyse...</span>' +
                    '</div>' +
                '</div>' +
                '<div id="' + cardId + 'Steps"></div>' +
            '</div>' +
        '</div>';
    },

    // Step HTML - ORIGINAL STYLE with vertical lines and proper alignment
    stepHtml(st, isLast, isLoading, m, cardId) {
        const c = this.colors;
        const dotColor = isLoading ? this.modeColors[m] : c.bullet;
        const dotId = isLoading ? cardId + 'Dot' : '';
        
        let iconHtml;
        if (st.icon === 'bullet') {
            iconHtml = '<div ' + (dotId ? 'id="' + dotId + '"' : '') + ' style="width:6px;height:6px;border-radius:50%;background:' + dotColor + ';' + (isLoading ? 'animation:tpPulse 1.2s ease infinite;' : '') + '"></div>';
        } else {
            iconHtml = '<div style="width:16px;height:16px;color:' + c.text + ';">' + (this.icons[st.icon] || this.icons.globe) + '</div>';
        }
        
        return '<div style="display:flex;min-height:36px;opacity:0;transform:translateY(4px);transition:all 0.25s ease;">' +
            '<div style="display:flex;flex-direction:column;align-items:center;width:32px;padding-left:8px;">' +
                '<div style="width:1px;height:10px;background:' + c.line + ';"></div>' +
                '<div style="display:flex;align-items:center;justify-content:center;width:18px;height:18px;">' + iconHtml + '</div>' +
                '<div style="width:1px;flex-grow:1;min-height:8px;background:' + (isLast ? 'transparent' : c.line) + ';"></div>' +
            '</div>' +
            '<div style="display:flex;align-items:center;padding:8px 12px 8px 4px;flex:1;">' +
                '<span style="font-size:14px;color:' + c.text + ';">' + st.text + '</span>' +
            '</div>' +
        '</div>';
    },

    // SHOW
    show(m, q) {
        const body = document.getElementById(m + 'Body');
        if (!body) return;
        
        this.cardCounter++;
        const cardId = 'tpCard' + this.cardCounter;
        this.currentCardId[m] = cardId;
        this.expandedState[cardId] = true;
        
        const isSimple = this.isSimpleQuery(q) && !this.isTechnicalQuery(q);
        this.isSimpleMode[m] = isSimple;
        
        if (isSimple) {
            body.insertAdjacentHTML('beforeend', this.createSimpleCard(cardId, this.getSimplePhrase(), m));
            this.s[m] = [];
        } else {
            const b = (document.getElementById('copilotSub') || {}).textContent || 'quipement';
            const st = this.analyze(q, m, b);
            this.s[m] = st;
            this.i[m] = 0;
            
            body.insertAdjacentHTML('beforeend', this.createFullCard(cardId));
            
            const cont = document.getElementById(cardId + 'Steps');
            const cnt = document.getElementById(cardId + 'Count');
            
            clearInterval(this.t[m]);
            const self = this;
            this.t[m] = setInterval(function() {
                const idx = self.i[m];
                if (idx < st.length) {
                    const isLast = idx === st.length - 1;
                    const isLoading = st[idx].icon === 'bullet' && isLast;
                    const h = self.stepHtml(st[idx], isLast, isLoading, m, cardId);
                    cont.insertAdjacentHTML('beforeend', h);
                    const nw = cont.lastElementChild;
                    requestAnimationFrame(function() {
                        nw.style.opacity = '1';
                        nw.style.transform = 'translateY(0)';
                    });
                    self.i[m]++;
                    cnt.textContent = self.i[m] + ' tape' + (self.i[m] > 1 ? 's' : '');
                    body.scrollTop = body.scrollHeight;
                } else {
                    clearInterval(self.t[m]);
                }
            }, 400);
        }
        
        body.scrollTop = body.scrollHeight;
    },

    // TOGGLE
    toggleCard(cardId) {
        const collapsed = document.getElementById(cardId + 'Collapsed');
        const expanded = document.getElementById(cardId + 'Expanded');
        if (!collapsed || !expanded) return;
        
        if (this.expandedState[cardId]) {
            collapsed.style.display = 'block';
            expanded.style.display = 'none';
            this.expandedState[cardId] = false;
        } else {
            collapsed.style.display = 'none';
            expanded.style.display = 'block';
            this.expandedState[cardId] = true;
        }
    },

    // COLLAPSE
    collapse(m, sum) {
        clearInterval(this.t[m]);
        const cardId = this.currentCardId[m];
        if (!cardId) return;
        
        const card = document.getElementById(cardId);
        if (!card) return;
        
        // SIMPLE = REMOVE
        if (this.isSimpleMode[m]) {
            card.remove();
            return;
        }
        
        // TECHNICAL = collapse but keep
        const loadingDot = document.getElementById(cardId + 'Dot');
        if (loadingDot) {
            loadingDot.style.animation = 'none';
            loadingDot.style.background = this.colors.bullet;
        }
        
        const steps = this.s[m] || [];
        const summary = sum || (steps.length + ' tape' + (steps.length > 1 ? 's' : ''));
        
        const summaryEl = document.getElementById(cardId + 'Summary');
        if (summaryEl) summaryEl.textContent = summary;
        
        const collapsed = document.getElementById(cardId + 'Collapsed');
        const expanded = document.getElementById(cardId + 'Expanded');
        
        if (collapsed && expanded) {
            collapsed.style.display = 'block';
            expanded.style.display = 'none';
            this.expandedState[cardId] = false;
        }
    },

    hide(m) {
        clearInterval(this.t[m]);
        const cardId = this.currentCardId[m];
        if (cardId) {
            const card = document.getElementById(cardId);
            if (card) card.remove();
        }
    }
};

// Global
function showThoughtProcess(m, q) { try { TP.show(m, q); } catch(e) { console.warn('TP:', e); } }
function collapseThoughtProcess(m, s) { try { TP.collapse(m, s); } catch(e) { console.warn('TP:', e); } }
function hideThoughtProcess(m) { try { TP.hide(m); } catch(e) { console.warn('TP:', e); } }

// Render persisted thought process (collapsed, from database)
function renderPersistedThoughtProcess(panel, steps, summary) {
    try {
        const body = document.getElementById(panel + 'Body');
        if (!body || !steps || steps.length === 0) return;

        const c = TP.colors;
        const cardId = 'tpPersisted' + (++TP.cardCounter);
        const summaryText = summary || (steps.length + ' tape' + (steps.length > 1 ? 's' : ''));

        // Build steps HTML
        let stepsHtml = '';
        steps.forEach((step, idx) => {
            const isLast = idx === steps.length - 1;
            const iconHtml = step.icon === 'bullet'
                ? '<div style="width:6px;height:6px;border-radius:50%;background:' + c.bullet + ';"></div>'
                : '<div style="width:16px;height:16px;color:' + c.text + ';">' + (TP.icons[step.icon] || TP.icons.globe) + '</div>';

            stepsHtml += '<div style="display:flex;min-height:36px;">' +
                '<div style="display:flex;flex-direction:column;align-items:center;width:32px;padding-left:8px;">' +
                    '<div style="width:1px;height:10px;background:' + c.line + ';"></div>' +
                    '<div style="display:flex;align-items:center;justify-content:center;width:18px;height:18px;">' + iconHtml + '</div>' +
                    '<div style="width:1px;flex-grow:1;min-height:8px;background:' + (isLast ? 'transparent' : c.line) + ';"></div>' +
                '</div>' +
                '<div style="display:flex;align-items:center;padding:8px 12px 8px 4px;flex:1;">' +
                    '<span style="font-size:14px;color:' + c.text + ';">' + step.text + '</span>' +
                '</div>' +
            '</div>';
        });

        // Create FULL card with both collapsed AND expanded views
        const html = '<div id="' + cardId + '" style="border:0.5px solid ' + c.border + ';border-radius:8px;margin:12px 0;max-width:70%;">' +
            // COLLAPSED VIEW (visible by default)
            '<div id="' + cardId + 'Collapsed" style="display:block;">' +
                '<div style="display:flex;min-height:42px;cursor:pointer;" onclick="TP.toggleCard(\'' + cardId + '\')">' +
                    '<div style="display:flex;flex-direction:column;align-items:center;width:32px;padding-left:8px;">' +
                        '<div style="width:1px;height:8px;background:transparent;"></div>' +
                        '<div style="font-size:10px;color:' + c.textMuted + ';">' + TP.icons.chevronUp + '</div>' +
                        '<div style="width:1px;flex-grow:1;min-height:6px;background:' + c.line + ';"></div>' +
                    '</div>' +
                    '<div style="display:flex;align-items:center;padding:8px 12px 8px 4px;flex:1;">' +
                        '<span id="' + cardId + 'Summary" style="font-size:14px;color:' + c.text + ';">' + summaryText + '</span>' +
                    '</div>' +
                '</div>' +
            '</div>' +
            // EXPANDED VIEW (hidden by default)
            '<div id="' + cardId + 'Expanded" style="display:none;">' +
                '<div style="display:flex;min-height:38px;cursor:pointer;" onclick="TP.toggleCard(\'' + cardId + '\')">' +
                    '<div style="display:flex;flex-direction:column;align-items:center;width:32px;padding-left:8px;">' +
                        '<div style="width:1px;height:8px;background:transparent;"></div>' +
                        '<div style="font-size:10px;color:' + c.textMuted + ';">' + TP.icons.chevronDown + '</div>' +
                        '<div style="width:1px;flex-grow:1;min-height:6px;background:' + c.line + ';"></div>' +
                    '</div>' +
                    '<div style="display:flex;align-items:center;padding:8px 12px 8px 4px;flex:1;">' +
                        '<span style="font-size:14px;color:' + c.textMuted + ';">' + summaryText + '</span>' +
                    '</div>' +
                '</div>' +
                '<div id="' + cardId + 'Steps">' + stepsHtml + '</div>' +
            '</div>' +
        '</div>';

        body.insertAdjacentHTML('beforeend', html);
        TP.expandedState[cardId] = false;
    } catch (e) { console.warn('renderPersistedTP:', e); }
}

// CSS
(function() {
    if (!document.getElementById('tp-styles')) {
        const s = document.createElement('style');
        s.id = 'tp-styles';
        s.textContent = '@keyframes tpPulse{0%,100%{opacity:1}50%{opacity:0.4}}';
        document.head.appendChild(s);
    }
})();

console.log(' TP FixAIR v5');
</script>
</body>
</html>
